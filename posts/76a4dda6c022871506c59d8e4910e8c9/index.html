<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Neural Network 3 课程笔记翻译 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Neural Network 3 课程笔记翻译" />
<meta property="og:description" content="本章的定位 在前面的章节中我们讨论了神经网络的静态部分：我们怎么设置网络连接、怎么设置数据、怎么设置损失函数。这一章我们研究一下动态部分，也就是参数的学习过程以及寻找最优参数的过程。
一、梯度检查 梯度检查的核心思想就一句话：把梯度的解析解和数值解拿过来进行比较就行了。【候选翻译：理论上，梯度检查非常简单，就比较梯度的解析解和数值解就行了。】但是实际上，这个过程非常的复杂和易错。以下是一些技巧、提示以及可能出现的问题：
1.1 用对称形式的求导公式 当计算梯度的数值解时，你可能见过这样一种有限差分的近似形式：
d f ( x ) d x = f ( x &#43; h ) − f ( x ) h (不好，别用这个) \frac{df(x)}{dx} = \frac{f(x &#43; h) - f(x)}{h} \hspace{0.1in} \text{(不好，别用这个)} dxdf(x)​=hf(x&#43;h)−f(x)​(不好，别用这个)
其中h是非常小的数，实际应用中这个值大概是10的负5次方左右。
但是实践中，用对称形式差分公式更好：
d f ( x ) d x = f ( x &#43; h ) − f ( x − h ) 2 h (这个好，用这个) \frac{df(x)}{dx} = \frac{f(x &#43; h) - f(x - h)}{2h} \hspace{0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/76a4dda6c022871506c59d8e4910e8c9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-02T20:16:12+08:00" />
<meta property="article:modified_time" content="2022-04-02T20:16:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Neural Network 3 课程笔记翻译</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>本章的定位</h2> 
<p>在前面的章节中我们讨论了神经网络的静态部分：我们怎么设置网络连接、怎么设置数据、怎么设置损失函数。这一章我们研究一下动态部分，也就是参数的学习过程以及寻找最优参数的过程。</p> 
<h2><a id="_3"></a>一、梯度检查</h2> 
<p>梯度检查的核心思想就一句话：把梯度的解析解和数值解拿过来进行比较就行了。【候选翻译：理论上，梯度检查非常简单，就比较梯度的解析解和数值解就行了。】但是实际上，这个过程非常的复杂和易错。以下是一些技巧、提示以及可能出现的问题：</p> 
<h3><a id="11__6"></a>1.1 用对称形式的求导公式</h3> 
<p>当计算梯度的数值解时，你可能见过这样一种有限差分的近似形式：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            d 
           
          
            f 
           
          
            ( 
           
          
            x 
           
          
            ) 
           
          
          
          
            d 
           
          
            x 
           
          
         
        
          = 
         
         
          
          
            f 
           
          
            ( 
           
          
            x 
           
          
            + 
           
          
            h 
           
          
            ) 
           
          
            − 
           
          
            f 
           
          
            ( 
           
          
            x 
           
          
            ) 
           
          
         
           h 
          
         
         
        
          (不好，别用这个) 
         
        
       
         \frac{df(x)}{dx} = \frac{f(x + h) - f(x)}{h} \hspace{0.1in} \text{(不好，别用这个)} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.113em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.113em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">h</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.7227em;"></span><span class="mord text"><span class="mord">(</span><span class="mord cjk_fallback">不好，别用这个</span><span class="mord">)</span></span></span></span></span></span></span><br> 其中h是非常小的数，实际应用中这个值大概是10的负5次方左右。<br> 但是实践中，用对称形式差分公式更好：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            d 
           
          
            f 
           
          
            ( 
           
          
            x 
           
          
            ) 
           
          
          
          
            d 
           
          
            x 
           
          
         
        
          = 
         
         
          
          
            f 
           
          
            ( 
           
          
            x 
           
          
            + 
           
          
            h 
           
          
            ) 
           
          
            − 
           
          
            f 
           
          
            ( 
           
          
            x 
           
          
            − 
           
          
            h 
           
          
            ) 
           
          
          
          
            2 
           
          
            h 
           
          
         
         
        
          (这个好，用这个) 
         
        
       
         \frac{df(x)}{dx} = \frac{f(x + h) - f(x - h)}{2h} \hspace{0.1in} \text{(这个好，用这个)} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.113em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.113em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault">h</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.7227em;"></span><span class="mord text"><span class="mord">(</span><span class="mord cjk_fallback">这个好，用这个</span><span class="mord">)</span></span></span></span></span></span></span><br> 这个公式开销是单边形式的差分公式的两倍，因为你要对梯度的每一个纬度都计算两遍，但是它的精确度更高。为了证明这一点，你可以对f(x+h)和f(x-h)进行泰勒公式展开，之后你会发现f(x+h)的误差在O(h)这样一个阶数，而f(x-h)的误差在<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
        
        
          h 
         
        
          2 
         
        
       
         ) 
        
       
      
        O(h^2) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.06411em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>这样一个阶数。</p> 
<h3><a id="12__14"></a>1.2 利用相对误差进行比较</h3> 
<p>对于梯度的数值解<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          n 
         
        
          ′ 
         
        
       
      
        f'_n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.998892em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -2.453em; margin-left: -0.10764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span>以及梯度的解析解<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          a 
         
        
          ′ 
         
        
       
      
        f'_a 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.998892em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -2.453em; margin-left: -0.10764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span>这两个量说来，怎么比较？也就是我们到底以什么来衡量这两个量差不多一样还是相差很大。聪明如你可能马上就能想到这样一种方法，度量一下<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          a 
         
        
          ′ 
         
        
       
      
        f'_a 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.998892em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -2.453em; margin-left: -0.10764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span>与<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          f 
         
        
          n 
         
        
          ′ 
         
        
       
      
        f'_n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.998892em; vertical-align: -0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -2.453em; margin-left: -0.10764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span></span></span></span></span>之间的距离，利用这两个量差的绝对值或者平方，当这个值大于某一个阈值的时候就说明两者之间不匹配（这叫梯度检查失败）。但是这种方法有问题啊。假设这两个量的差是10的负4次方。这个值看起来不错吧。当两个量都是在1.0这个量级上的时候确实不错。但是当两种梯度的量级在10的负5次方的时候呢？10的负4次方这样一个差距可是比他们本身都要大100倍啊，这是妥妥的失败啊。所以更合理的方式是在比较前把量级先归一化，用下面的公式：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            ∣ 
           
           
           
             f 
            
           
             a 
            
           
             ′ 
            
           
          
            − 
           
           
           
             f 
            
           
             n 
            
           
             ′ 
            
           
          
            ∣ 
           
          
          
          
            max 
           
          
            ⁡ 
           
          
            ( 
           
          
            ∣ 
           
           
           
             f 
            
           
             a 
            
           
             ′ 
            
           
          
            ∣ 
           
          
            , 
           
          
            ∣ 
           
           
           
             f 
            
           
             n 
            
           
             ′ 
            
           
          
            ∣ 
           
          
            ) 
           
          
         
        
       
         \frac{\mid f'_a - f'_n \mid}{\max(\mid f'_a \mid, \mid f'_n \mid)} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 2.36489em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.42889em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mop">max</span><span class="mopen">(</span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.677892em;"><span class="" style="top: -2.453em; margin-left: -0.10764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">∣</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.677892em;"><span class="" style="top: -2.453em; margin-left: -0.10764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">∣</span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -2.453em; margin-left: -0.10764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.751892em;"><span class="" style="top: -2.453em; margin-left: -0.10764em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span><br> 其实一般相对误差公式分母部分其实只要任意一项就行了。但是这里我倾向于用max()（或者add()），一方面显得对称，另一方面可以避免0作为除数的情况（在激活函数利用ReLUs时，这种特别容易出现）。尽管如此，还有一种极端情况必须留意，那就是两个量都是0的情况下通过了梯度测试。</p> 
<ul><li>相对误差 &gt; <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          1 
         
         
         
           0 
          
          
          
            − 
           
          
            2 
           
          
         
        
       
         10^{-2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span> 一般都是有问题的</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          1 
         
         
         
           0 
          
          
          
            − 
           
          
            2 
           
          
         
        
       
         10^{-2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span> &gt; 相对误差 &gt; <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          1 
         
         
         
           0 
          
          
          
            − 
           
          
            4 
           
          
         
        
       
         10^{-4} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span></span> 这个结果会令你感到不安</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          1 
         
         
         
           0 
          
          
          
            − 
           
          
            4 
           
          
         
        
       
         10^{-4} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span></span> &gt; 相对误差 如果目标函数有奇异点这个结果还行，但是如果目标函数没有奇异点 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          1 
         
         
         
           0 
          
          
          
            − 
           
          
            4 
           
          
         
        
       
         10^{-4} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span></span>可是有点太高了</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          1 
         
         
         
           0 
          
          
          
            − 
           
          
            7 
           
          
         
        
       
         10^{-7} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span></span></span> &gt;= 相对误差 完美，可以高兴一把</li></ul> 
<p>要记住神经网络越深，相对误差越高。如果你正打算训练一个10层的神经网络，对于输入的梯度检查来说，相对误差大概在 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           2 
          
         
        
       
      
        10^{-2} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span>也许就可以了。因为误差随着深度的累计还会继续增大。但是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           2 
          
         
        
       
      
        10^{-2} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span>对于一个单层的差分函数来说还是有点太大了。</p> 
<h3><a id="13__26"></a>1.3 利用双精度</h3> 
<p>利用单精度浮点运算来计算梯度是一个常见的坑。如果你是利用单精度而不是双精度来计算梯度，即使你的梯度实现是没有问题的，相对误差也会非常高（高到 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           2 
          
         
        
       
      
        10^{-2} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span>）。我自己就经历过，当我把单精度换成双精度之后，相对误差一下子就从 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           2 
          
         
        
       
      
        10^{-2} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span>降到 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           8 
          
         
        
       
      
        10^{-8} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span></span></span>。</p> 
<h3><a id="14__29"></a>1.4 尽可能在浮点数的有效范围内计算</h3> 
<p><a href="http://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html" rel="nofollow">What Every Computer Scientist Should Know About Floating-Point Arithmetic</a>这篇文章非常值得你好好读读，它深入浅出的阐述了各种可能的错误，避免了这些错误，你的代码会更优质。举个例子，在神经网络里，在每个数据批次都对梯度进行正则化是非常常见的。【注：这句话原文有误，请参考Stick around active range of floating point 出现的一个是错误.md】也就是正则化项是要除以这个批量的数据点个数的。如果每个数据点的梯度都很小，那么当梯度除以这个批量所包含的数据个数时，结果也会变得很小。这就会导致很多数值上的问题啊。<br> 所以，我个人经常把原始的数值梯度值和解析梯度值都打印出来看看。看看用于比较的这些数是不是太小了（<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           10 
          
         
        
       
      
        10^{-10} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span></span>左右或者更小的数就非常令人担忧了）<br> 数太小了可能出现溢出的情况。如果你想用一个常数暂时性的把它们（指前面的说道的数值太小的“解析解梯度”以及“数值解梯度”）把他们提到一个更好的浮点数范围内，在这个范围内，浮点数显得比较“稠密”。那么理想的范围是，这个提高后的这个数值在1.0的范围内，也就是10的0次方。【注：这里参考注释，怎么理解“稠密”注释：Stick around active range of floating point 怎么理解让浮点数更密集.md】</p> 
<h3><a id="15__34"></a>1.5 目标函数上的不可导点</h3> 
<p>需要注意一种引起误差的因素，也就是在“不可导点”上可能出现的问题。【关于kink参考注释：注释：kinks in the objective.md】<br> “kink”就是目标函数上的不可微分的部分，比如RuLU函数，SVM中的折页损失函数，Maxout激活函数。<br> 其实这一小节阐述的问题其实是由““数值解”终究只是“解析解”的近似替代，总是会有误差”这样一个根本矛盾造成的。这个问题在《精英日课》中《宇宙是数字的吗》有着非常好的阐述。<br> 咱们就以ReLU这个函数为例，我们讨论 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         X 
        
       
         = 
        
       
         − 
        
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           6 
          
         
        
       
      
        X = -10^{-6} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.07847em;">X</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.897438em; vertical-align: -0.08333em;"></span><span class="mord">−</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span></span>这点。首先这点并不是0，虽然它离0很近，因此从理论上来说这点是可导的，存在解析解是吧。我们再看数值解的求解过程，能求得什么的结果取决你的h取多大，如果<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         h 
        
       
         &gt; 
        
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           6 
          
         
        
       
      
        h &gt; 10^{-6} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.73354em; vertical-align: -0.0391em;"></span><span class="mord mathdefault">h</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span></span> 那么f(x+h)这一项就越过了0点，它可就不是0啦，这个结果就不对啦。这就是这个问题的机制。<br> 而且这个问题非常普遍，比如在CIFAR-10上利用SVM这个模型，将会包括450000个 max(0,x)项。这是由于CIFAR-10上包含50000个样本，而每个样本都会生成9个这样的项。这还不算什么，由于ReLU的存在，一个包含SVM的神经网络可能会用更多的kinks。</p> 
<p>那么解决方法是什么呢？利用max(a,b)这个随时跟踪f(x+h)以及f(x-h)之间的相对大小关系，如果是在一个可导函数上，虽然单调性会发生变化，但是在单调性改变之前，单调性是稳定的，那么你会发现 f(x+h) 在某个阶段始终是大于（或者小于）f(x-h)的。然后你突然发现他们的大小关系发生变化了。那就说明要不然是单调性发生变化了，要不然是越过不可导点了。</p> 
<h3><a id="16__46"></a>1.6 利用少量数据点检测足矣</h3> 
<p>还有一种解决“由于不可导点存在造成的问题”的方法。目标函数中包含的数据点越少那么不可少点也越少。【这点可以参考注释：use only few datapoints.md】如果梯度验证在一个批次上的2到3个点上都通过了，那么这个批次也基本上没有问题。这样确实会节省很多开销，但是问题来了，那么要挑那些样本点进行检查呢？</p> 
<h3><a id="17_h_51"></a>1.7 数值解计算公式中的h</h3> 
<p>这个标题的原文是“be careful with the step size h”，可是h不是步进长度啊，小球移动到哪个点，主要看梯度更新到哪里啊。这个h就在计算数值解中才存在，就是一个临域的意思，没有别的什么意思。<br> h大多比较合适，上面在讲不可导点时候已经出现过一次，那个时候用的是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         h 
        
       
         = 
        
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           6 
          
         
        
       
      
        h=10^{-6} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">h</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span></span>。h其实体现了“在多大程度上数值解能够逼近解析解”，它更像一个精度。那么精度是越精确越好吗（h越小越好吗）？不是的，h太小可能会受制于计算机本身精度的问题引起下溢。一个实践经验是，h在<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           6 
          
         
        
       
      
        10^{-6} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span></span>到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
        
        
          0 
         
         
         
           − 
          
         
           4 
          
         
        
       
      
        10^{-4} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span></span>比较好。维基上有篇文章描述了h的大小和梯度检查准确率之间的关系<a href="https://en.wikipedia.org/wiki/Numerical_differentiation" rel="nofollow">Numerical differentiation</a></p> 
<h3><a id="18__56"></a>1.8 在“典型”模式下进行梯度检查</h3> 
<p>梯度检查是作用于参数空间中的某些点上的（具体哪些点可能是随机的）。所以即使梯度检查在一些点上成功了，也不意味着梯度在全局上都成功。我们知道参数最早的取值是随机初始化的，但是这样的值在整个参数空间里不一定具备“典型性”。什么叫“典型性”，这个可是很重要的概念，这里就被作者一笔带过，我理解的是，参数空间内在还是有一些模式的，什么叫做模式，就是它的空间呈现某些规律性的特点，比如正弦函数，就是一种规律的曲线，但是损失函数是高维函数，他的图形是没法想象的，但是肯定很复杂，我们用二维的情况来做一个假设，有这么样一个曲线<br> <img src="https://images2.imgbox.com/2d/91/mq7kuxRt_o.png" alt="在这里插入图片描述"></p> 
<p>这个曲线刚开始的时候是平的，到了中间才波浪起伏，而到了最后又平了。那么这个曲线的主要特征肯定句那段波浪起伏，如果随机初始化的点在A和在B都不是在非常典型的位置。而运行了一段的C位置可能是比较典型的位置。这就是我理解的“参数空间的典型性”。在不典型的参数空间上通过的梯度检测很可能在其它地方就通不过。<br> 以SVM为例，当SVM的权重以一个非常小的值被初始化后，所有的数据点得到的分数几乎都为0。因此梯度会显示出一种特殊的模式。一个错误的梯度实现也能产生某种模式。但是随着参数进入一个有“典型性”的空间之后，在这个地方有些分值就比其它的分值大。这个模式是不具备在这个空间的泛化特性的。<br> 基于上述原因，一个比较稳妥的做法是：预热一小段时间。也就是让学习进程跑一会儿。当loss开始下降的时候再进行梯度检查。<br> 在开始的几次迭代中这样做存在危险，它可能会引入病态的边缘情况并且掩盖了梯度的错误实现。【在第一次迭代就进行梯度检查的危险就在于，此时可能正处在不正常的边界情况，从而掩盖了梯度没有正确实现的事实。 这一句知乎翻译的好】</p> 
<h3><a id="19__66"></a>1.9 不要让正则化覆盖了数据</h3> 
<p>因为一般损失函数都带着正则化项的。所以有一种情况要注意，就是正则化项盖过了数据损失项，以至于梯度基本上来自于正则化项<br> （正则化项的梯度表达式会更简单一些）。所以这样会掩盖数据损失项的梯度的错误实现。<br> 解决的方案是：首先关掉正则化项单独的检测数据项，之后在单独的检查正则化项。检查正则化项的时候直接进入到代码中把数据损失项删掉。<br> 还有一个方案是在梯度检查中增加正则化的强度到无法忽略的程度，然后不正确的实现就能被发现了。</p> 
<h3><a id="110__72"></a>1.10 记得关掉随机失活/数据扩张</h3> 
<p>在进行梯度检查的时候，记得关掉所有非决定因素比如随机失活、数据扩张等等。否则这些因素会形成干扰。关掉这些特性的缺点是，没法对他们进行梯度检查（比如说随机失活没法正确的反向传播）。因此更好的解决方案就是在计算f(x+h)和f(x-h)之前强制一个随机种子，计算解析梯度前也是这样</p> 
<h3><a id="111__75"></a>1.11 检查少数维度</h3> 
<p>在实践中，梯度有上百万的参数的规模。因此，一个可行的做法是检查梯度的一部分。其他没有检查的部分我们认为它是正确的。注意：要在每个不同的参数上的一些维度上进行梯度检查。在一些应用场景中，为了方便，人们会把参数放到一起抻成一个常常的向量。在这种情况下，偏置只占了整个向量中非常小的一部分，所以一定不要随机采样，而是把偏置的这种情况考虑进来并且检查全部的参数都收到正确的梯度。</p> 
<h2><a id="_82"></a>二、合理性检查</h2> 
<p>在你一头扎进费时费力的优化过程之前，还是有些事值得你去认真对待的，比如说合理性检查。</p> 
<h3><a id="21__84"></a>2.1 观察特定执行状态的损失值是否正确</h3> 
<p>当你利用小参数初始化的时候，确保你获得期望的损失值。最好先单独的测试损失（也就是让正则化强度为0）。我们以softmax分类器在CIFAR-10上的表现为例，假设有十个分类，那么每个分类的扩散先验概率是0.1（跟均匀分布一样）。由于softmax 损失是概率的负对数，-ln(0.1) = 2.302，因此softmax分类器在一开始的损失值应该是2.302。对于 Weston Watkins SVM，我们假设一开始分类器对所有的分类都错，也就是所有的点都没有在边界外面呆着，也就是从图形上看，所有的样本点要不然是在边界内部，要不然是跑到分类器那头了，这叫“违反边界”（violate margin），这种情况下所有的计分总和为0，因此损失为9（因为对于每一个错误的分类来说边界为1）。如果你在初始化的时候没有看到这些值，那么可能在什么地方就有问题了。</p> 
<h3><a id="22__87"></a>2.2 增加正则化强度</h3> 
<p>作为合理性验证的第二步，增加正则化强度也会增加损失值。<br> 为啥会增加呢？因为我们的L2正则化，L2正则化项一定是个正数，所以打开了正则化的损失肯定要大一点，因为你加了一个正数嘛。<br> 加上正则化的目的就是无缘无故的给你惩罚而已。</p> 
<h3><a id="23__93"></a>2.3 在整个数据集上找一个小子集，在这个子集上实现过拟合</h3> 
<p>最后也是最重要的一点，在我们在完整的数据集上进行训练的之前，在一个小子集（比如说20个样本）进行训练，并且要达到损失值为0.<br> 在这个过程中正则化强度最好也设置为0，否则你无法得到0损失。记住，一定要到你完成了这个测试之后再在在全量数据上进行训练，否则就没有意义。<br> 注意，有可能即使你通过了这一步测试，你的实现也可能有问题。因为你的数据集上的数据特征分布是随机的，那么导致你在小样本上得到的学习效果无法泛化到整个数据集中。</p> 
<h2><a id="baby_100"></a>三、像照顾baby一样仔细关注学习过程中的每一个细节</h2> 
<p>在训练过程中，我们需要监控某些量的变化情况。这些图表像一扇窗户一样能够让我们深入到训练的内部一探究竟，借助它我们能够对不同的参数所起的作用有一个直观的认识。<br> 图表的横坐标代表时间一般用epoch作为单位。epoch代表这样一个时间——在训练的过程中对所有样本完成一次遍历所需要的时间。而在深度学习中，iteration代表的是一个batch的样本被完全遍历一遍的时间，而batch的大小的设置虽然有讲究但是理论上也是可以任意设置的。</p> 
<h3><a id="31__103"></a>3.1 损失函数</h3> 
<p>第一个要监控的值就是损失函数的函数值，这个值在前向传播的时候就已经在计算了，而且是在每个batch上都计算，这就意味着可能对其它参数来说是每个epoch计算一次，而这个参数是每个epoch会有很多个值，更准确点不好吗？<br> <img src="https://images2.imgbox.com/6e/3c/xx0ESgsi_o.jpg" alt="在这里插入图片描述"></p> 
<p>震荡的幅度与batch的大小有关。当batch size =1 震荡非常大。而当batch size = 整个数据集的时候，震荡幅度是最小的，因为每一次梯度更新导致loss的变化都是单调的。<br> 也有的人喜欢在对数坐标下画loss function的图，因为这个曲线类似于一个对数曲线所以在对数坐标下画出来的图像应该是一条直线。这个看起来会比看起来像曲棍球一样的对数曲线看起来舒服一点。</p> 
<p>当多个交叉验证模型的损失函数图线画在同一个图上时，他们之间的差异可以看得非常清晰。</p> 
<p>什么样的曲线代表什么样的意思可以参考这个网站 <a href="http://lossfunctions.tumblr.com/" rel="nofollow">lossfunctions.tumblr.com</a></p> 
<h3><a id="32__115"></a>3.2 训练精度/验证精度</h3> 
<p>第二个要监控的值是 训练精度/验证精度。这个图像能够对模型的过拟合程度有一个量化的描述。<br> <img src="https://images2.imgbox.com/74/ba/x4rqaRm7_o.jpg" alt="在这里插入图片描述"></p> 
<p>训练精度和验证精度之间的落差体现了过拟合的程度。<br> 一种情况是：蓝色的曲线精度很低，显示过拟合程度很大。当你看到这种情况出现的时候，你需要增加正则化的强度（增大L2权重惩罚，更多的随机失活）或者收集更多的数据。<br> 另一种情况是：验证精度曲线和测试曲线紧贴着。这说明模型的能力不够强，需要再增加一些参数来增加模型的能力。</p> 
<h3><a id="33__123"></a>3.3 参数更新比</h3> 
<p>我们构造这样一个监控量——参数的变化与参数整体（变化之前）的比值。我称之为参数更新比。<br> 那么什么是参数的变化，以vanilla SGD为例，参数的变化或者叫参数的更新（update）是参数在那点的梯度与学习率的乘积。<br> 参数更新比的大小大概在10的负3次方。如果小于10的负3次方，学习率可能有点低。反之，学习率可能有点大。<br> 我们还是以vanilla SGD为例，来说明具体的落地方法。在真实的代码中。</p> 
<ul><li>首先我们把权重矩阵铺平展开成一个一维的向量。</li><li>然后求这个向量的2范式或者2阶模。</li><li>求这个权重的更新，也就是损失函数在参数这点的梯度再乘以学习率</li><li>对这个权重的更新进行取模</li><li>最后是权重更新的模与更新之前的权重进行比，这是两个标量的比</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># assume parameter vector W and its gradient vector dW</span>
param_scale <span class="token operator">=</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>W<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
update <span class="token operator">=</span> <span class="token operator">-</span>learning_rate<span class="token operator">*</span>dW <span class="token comment"># simple SGD update</span>
update_scale <span class="token operator">=</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>update<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
W <span class="token operator">+=</span> update <span class="token comment"># the actual update</span>
<span class="token keyword">print</span> update_scale <span class="token operator">/</span> param_scale <span class="token comment"># want ~1e-3</span>
</code></pre> 
<h3><a id="34__146"></a>3.4 每一层的激活梯度比分布情况</h3> 
<p>不好的初始化可以会降低学习的速度，甚至让学习停止。但是这个问题却有非常容易的诊断方法。为此我们再构造一个统计量。每一层神经元的激活值与“这层神经元梯度值”的比值。“这层神经元的梯度值”是一个简化的说法，更准确的说法是——损失函数在这层神经元与前一层神经元之间的连接上的权重所表示的这点的梯度。有了这个统计量之后，我们观察这个统计量在每一层神经元上的分布情况（用直方图）。<br> <a href="https://zhuanlan.zhihu.com/p/25110150" rel="nofollow">聊一聊深度学习的weight initialization</a>这个就是一个例子</p> 
<h3><a id="35__151"></a>3.5 第一层可视化</h3> 
<p><img src="https://images2.imgbox.com/b3/0c/CCo7V0jn_o.jpg" alt="在这里插入图片描述"></p> 
<p>左边的图明显有很多的噪点是吧，这说明这个是由问题（症状）的：网络没有收敛，学习率设置的不合理，正则化强度不够。<br> 右边的图非常好，干净、平滑说明这个训练过程良好</p> 
<h2><a id="_161"></a>四、参数更新</h2> 
<p>一旦利用反向传播计算出梯度的解析形式，我们就可以利用梯度来更新参数了。以下是一些参数更新的方法。</p> 
<h3><a id="41_SGD_164"></a>4.1 SGD与各种改进</h3> 
<h4><a id="411__166"></a>4.1.1 串行更新</h4> 
<p><strong>串行更新</strong> 这是一种最简单的更新方式，直接沿着负梯度方向更新参数（因为梯度指向的是增加的方向，但是这里我们是为了最小化损失函数，所以利用负梯度）。假设有有一个向量x，以及对应的梯度dx，最简单的更新方式如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># Vanilla update</span>
x <span class="token operator">+=</span> <span class="token operator">-</span> learning<span class="token operator">-</span>rate <span class="token operator">*</span> dx
</code></pre> 
<p>其中 learning-rate 是一个固定值的超参数。当我们在整个数据集上进行计算，并且学习率足够小的时候，这个参数能够保证更新能够沿着损失函数的负梯度方向前进。</p> 
<h4><a id="412__175"></a>4.1.2 动量更新</h4> 
<p><strong>动量更新</strong> 是另一种在深度学习过程中经常能获得不错收敛率的学习方法。这个方法的灵感来自物理学【我就意译了】，想象优化空间如同一个延绵起伏不断延伸的丘陵地带，优化过程类似于把一个小球轻轻地放在这个地带任何一个位置，让它自然运动直到停止，一般来说，当它停下来的时候这个小球肯定是在某一个最低点，不一定是全局最低点，但是一定是局部的最低点。<br> 从物理的角度来理解：<br> 位移：用符号x来表示<br> 势能：U=Fx(势能的定义应该是mgh，这里我们用x代替h，用F代替mg)<br> 速度：用符号v来表示<br> 摩擦系数：用符号<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         μ 
        
       
      
        \mu 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">μ</span></span></span></span></span>来表示<br> 第一个公式，速度更新公式：<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          v 
         
         
         
           n 
          
         
           e 
          
         
           w 
          
         
        
       
         ← 
        
       
         μ 
        
        
        
          v 
         
         
         
           o 
          
         
           l 
          
         
           d 
          
         
        
       
         − 
        
       
         α 
        
       
         d 
        
       
         x 
        
       
      
        v_{new} \leftarrow \mu v_{old} - \alpha dx 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.77777em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">μ</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span></span></span></span></span><br> 解释：dx 是 dU/dx的简写，因此dU/dx = F。而F = ma，当 m=1时，F=a。而v = at ，当t =1时，v=a。所以v = dx。而这个v的物理意义是在某一时刻速度的变化，也就是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Δ 
        
       
         v 
        
       
      
        \Delta v 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span></span></span></span></span>。<br> 我来描述一下小球的动力学过程，一开始小球在山顶的时候，初始速度为0，而势能是最大的。随着小球往下滚，势能不断的转化为动能，小球的速度越来越快，当到达局部最低点的时候，速度应该变为最快，而最低点的势能为0，这个时候加速度最小变为0。根据牛一定律，如果没有外力存在，小球将不断的重复动能和势能的转化过程。因此这里加了一个摩擦力，以便让小球最终能够停下。最后小球在地步晃荡了几下之后停下。加速度随时间变化的曲线以及速度随时间变化的曲线如下图所示。<br> <img src="https://images2.imgbox.com/97/72/K1WRv8AU_o.png" alt="在这里插入图片描述"></p> 
<p>第二个公式，位移更新公式：<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
         
         
           n 
          
         
           e 
          
         
           w 
          
         
        
       
         ← 
        
        
        
          x 
         
         
         
           o 
          
         
           l 
          
         
           d 
          
         
        
       
         + 
        
        
        
          v 
         
         
         
           n 
          
         
           e 
          
         
           w 
          
         
        
       
         t 
        
       
      
        x_{new} \leftarrow x_{old} + v_{new}t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.73333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.76508em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathdefault">t</span></span></span></span></span><br> 这个就不解释了。t认为是1。所以还可以写成<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
         
         
           n 
          
         
           e 
          
         
           w 
          
         
        
       
         ← 
        
        
        
          x 
         
         
         
           o 
          
         
           l 
          
         
           d 
          
         
        
       
         + 
        
        
        
          v 
         
         
         
           n 
          
         
           e 
          
         
           w 
          
         
        
       
      
        x_{new} \leftarrow x_{old} + v_{new} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.73333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p>如果把这套物理的解释映射到优化过程中去。<br> 物理中的位移x就对应优化空间中的参数w，<br> 势能U对应的是优化空间中的损失函数L,<br> 那么速度更新公式和位移更新公式，就可以改写为<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          v 
         
         
         
           n 
          
         
           e 
          
         
           w 
          
         
        
       
         ← 
        
       
         μ 
        
        
        
          v 
         
         
         
           o 
          
         
           l 
          
         
           d 
          
         
        
       
         − 
        
       
         α 
        
       
         d 
        
       
         w 
        
       
      
        v_{new} \leftarrow \mu v_{old} - \alpha dw 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.77777em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">μ</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
         
         
           n 
          
         
           e 
          
         
           w 
          
         
        
       
         ← 
        
        
        
          x 
         
         
         
           o 
          
         
           l 
          
         
           d 
          
         
        
       
         + 
        
        
        
          v 
         
         
         
           n 
          
         
           e 
          
         
           w 
          
         
        
       
      
        w_{new} \leftarrow x_{old} + v_{new} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.73333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.58056em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.03588em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p>其实这个算是一种启发式的方法吧。【这是第二版对于这部分的一个笔记，我感觉比第一版更清楚一点】</p> 
<p>写成代码如下</p> 
<pre><code class="prism language-python"><span class="token comment"># Momentum update</span>
v <span class="token operator">=</span> mu <span class="token operator">*</span> v <span class="token operator">-</span> learning_rate <span class="token operator">*</span> dx <span class="token comment"># integrate velocity</span>
x <span class="token operator">+=</span> v <span class="token comment"># integrate position</span>
</code></pre> 
<p>当交叉验证的时候，我们经常会从[0.5,0.9,0.95,0.99]这几个数里挑一个作动量参数。<br> 类似于学习率的退火策略，在学习的最后阶段动量（摩擦系数）会增加，这种方法对整个优化过程也会有点帮助。一般用法是这样：一开始的时候动量设置为0.5，当经过了多轮（epoch）训练之后把它变成0.99。</p> 
<blockquote> 
 <p>利用动量更新方法，参数向量就可以沿着和梯度方向积累速度。</p> 
</blockquote> 
<p>【这一部分第一版笔记】<br> <strong>动量更新</strong> 是另一种在深度学习过程中经常能获得不错收敛率的学习方法。这个方法的灵感来自物理学【我就意译了】，想象优化空间如同一个延绵起伏不断延伸的丘陵地带，优化过程类似于把一个小球轻轻地放在这个地带任何一个位置，让它自然运动直到停止，一般来说，当它停下来的时候这个小球肯定是在某一个最低点，不一定是全局最低点，但是一定是局部的最低点。我们把损失函数类比这个小球的重力势能(<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         U 
        
       
         = 
        
       
         m 
        
       
         g 
        
       
         h 
        
       
      
        U=mgh 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.10903em;">U</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mord mathdefault">h</span></span></span></span></span>)；由于力是能量函数相对于位移的梯度【<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         F 
        
       
         = 
        
       
         − 
        
       
         ∇ 
        
       
         U 
        
       
      
        F = - \nabla U 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord">−</span><span class="mord">∇</span><span class="mord mathdefault" style="margin-right: 0.10903em;">U</span></span></span></span></span>这个类似于速度定义S=Vt，S=f(t),v = df/dt。W = F S，W = f(s)，f = dw/ds，可以参考大学物理】，所以损失函数的梯度可以看成作用在小球上的力；又由于加速度和力成正比（F=ma）,当m=1的时候我们认为数值上力和加速度一样，我们就认为梯度就是加速度；接下来，我们利用这个公式$v =at $加速度是均匀的时候，加速度在时间上积累就是速度（其实准确来说加速度速度函数对时间的梯度），在时间是单位时间的情况下，速度又可以等于加速度，而加速度又等于力，力等于梯度，所以速度就以这样一个方式和梯度挂上钩了。之后还有再加上一个条件——牛一定律告诉我们，如果不施以外力，物体会始终保持匀速运动或静止状态——对于这个小球来说如果不施加一个外力，那么高处的势能是无法耗尽的，这个小球会在这个空间中永远运动下去，所以我们给速度增加一个衰减因子，让速度在每次迭代的时候都适当的衰减，那么最后小球就能慢慢的停下来了。这个衰减因子被习惯称之为“momentum”动量，这个就是动量更新的来源，其实从上面的分析来看，这个更应该是现实世界中的摩擦系数，叫“动量”应该算是一个约定俗成的“误传”</p> 
<h4><a id="413_Nesterov__225"></a>4.1.3 Nesterov 动量更新</h4> 
<p><strong>Nesterov Momentmum</strong></p> 
<p>因为有凸优化理论作为基础，它的收敛性更好，而且在实际应用中表现一向也比标准的动量方法要好。</p> 
<p>为了解释Nesterov动量更新的原理，我们从速度更新表达式开始说起。</p> 
<pre><code class="prism language-python">v <span class="token operator">=</span> mu <span class="token operator">*</span> v <span class="token operator">-</span> learning_rate <span class="token operator">*</span> dx 
</code></pre> 
<p>（为了说明下面的推论还是需要一些前提的，为了不影响整体感，把这些放到本小节的后面）<br> 其实这个式子背后提现了这样一个原理：下一时刻的速度应该由 「当前的速度」以及「质点因受力产生的速度变化」两部分共同构成。<br> <img src="https://images2.imgbox.com/02/2d/b4Sri384_o.png" alt="在这里插入图片描述"></p> 
<p>式子的前一部分（ mu * v）代表质点当前的速度状态，它是由上一个时刻的速度乘以摩擦系数得到，后一部分（learning_rate * dx）代表了作用在这个质点因重力产生的加速度进而产生了速度的变化，但是dx中的x是上一时刻的位置，dx确切的含义是上一时刻的位置带入到梯度解析式中得到关于这一时刻的重力对质点的速度影响。</p> 
<p>这样你就看出毛病了把——利用上一时刻质点的位置信息计算这一时刻的加速度是否合适？是不是觉得有点不妥？总觉得这一时刻的影响效果应该由这一时刻的相关信息计算出来，也就是这一时刻的加速度应该用这一时刻的位置信息来计算比较合适。但是这一时刻的位置信息又取决于当前的速度信息，当前的速度信息中的一部分又需要当前的位置信息，有点死循环了。</p> 
<p>解决的方法是引入一个新的概念——“趋势点”。（这是我对lookahead这个词的意译）<br> 利用趋势点来近似的代替“这一时刻的位置”从而计算出当前时刻重力对质点的速度影响（重力加速度），之后在用这个速度和这一时刻的「当前速度」相结合得到下一时刻的速度。</p> 
<p>“趋势点”是这样定义的：如果没有重力（也就是没有后一项），质点下一时刻的位置就是x + mu*v，我们可以称这个位置叫做“趋势位置”（lookahead）。这里也可以借助一下极限的思想，如果时间比较短的时候，x + mu * v 所表示的位置是质点最终到达的位置的一个临域。</p> 
<p>代码表示成下面：</p> 
<pre><code class="prism language-python">x_ahead <span class="token operator">=</span> x <span class="token operator">+</span> mu <span class="token operator">*</span> v  <span class="token comment"># 先计算出趋势点</span>
v <span class="token operator">=</span> mu <span class="token operator">*</span> v <span class="token operator">-</span> learning_rate <span class="token operator">*</span> dx_ahead <span class="token comment"># 将趋势点带入梯度中作为当前的加速度效果</span>
x <span class="token operator">+=</span> v
</code></pre> 
<p>原理就是这样，但是在实践中人们希望用新方法中更新表达式的样子和之前方法中表达式样子接近。换句话说我们是要通过一些数学技巧把当前这个式子形式转换一下。</p> 
<p>核心技巧就是把上面式子中的x_head用x来进行代替，换句话说并不让x_head显式的出现在更新的式子里，而是变通的用其他的量来代替。这里涉及到好几个变量，而且还涉及到这些变量在不同的迭代时刻，为了掰扯清楚这件事情，我们定义下面的变量：</p> 
<p>真实位置： TP(Ture Postion)<br> 趋势位置：LH(lookahead)<br> 速度：V(这没啥可说的)<br> 与时刻相关的下标： last(上一次) now(这一次) next(下一次)<br> 摩擦系数 ：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         μ 
        
       
      
        \mu 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">μ</span></span></span></span></span><br> 学习率：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         α 
        
       
      
        \alpha 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span></span></span></p> 
<p>在一开始我们的关系是这样（允许“趋势位置”显式出现）<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         = 
        
       
         T 
        
        
        
          P 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
         + 
        
       
         μ 
        
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
      
        LH_{now} = TP_{last} + {\mu}V_{last} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         = 
        
       
         μ 
        
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
         − 
        
       
         α 
        
       
         d 
        
       
         ( 
        
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         ) 
        
       
      
        V_{now}={\mu}V_{last} - {\alpha}d(LH_{now}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span><span class="mord mathdefault">d</span><span class="mopen">(</span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         T 
        
        
        
          P 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         = 
        
       
         T 
        
        
        
          P 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
         + 
        
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        TP_{now} =TP_{last} + V_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p>这其实就是把上面的更新代码翻译成数学语言表达的样子，下标是特别有用的东西，这个方法灵感来自于SVM中SMO方法的推导，其实仔细想想，迭代这个概念我们在数学中还真的没有明确的遇到过，我们从来没有在数学中用一个变量表示不同时刻的值，或者说很少用一个明确的表示方法来将同一个自变量的不同时刻区别开来如果他们需要出现在同一个式子里。<br> 在这三个式子里，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         T 
        
        
        
          P 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
      
        TP_{last} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
      
        V_{last} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>是已知量，需要推导出<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        LH_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        V_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> ，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         T 
        
        
        
          P 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        TP_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p>下面我们考虑这样一个问题<br> 已知<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        LH_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>（将来会用x来代替），<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
      
        V_{last} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，需要推导出<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        V_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           e 
          
         
           x 
          
         
           t 
          
         
        
       
      
        LH_{next} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>。<br> 要推导<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
       
         H 
        
       
      
        LH 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         T 
        
       
         P 
        
       
      
        TP 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span></span></span></span></span>是不可缺少中间变量的，但是不能出现在式子中，需要变通的方式代替它。</p> 
<p>根据上面的式子我们知道<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           e 
          
         
           x 
          
         
           t 
          
         
        
       
         = 
        
       
         T 
        
        
        
          P 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         + 
        
       
         μ 
        
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        LH_{next} = TP_{now} + {\mu}V_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span><br> 而<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         T 
        
        
        
          P 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         = 
        
       
         T 
        
        
        
          P 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
         + 
        
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        TP_{now} = TP_{last} + V_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">T</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span><br> 其中$TP_{last} = LH_{now} - {\mu}V_{last} <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         （ 
        
       
         由 
        
       
         上 
        
       
         面 
        
       
         的 
        
       
      
        （由 上面的 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0em; vertical-align: 0em;"></span><span class="mord cjk_fallback">（</span><span class="mord cjk_fallback">由</span><span class="mord cjk_fallback">上</span><span class="mord cjk_fallback">面</span><span class="mord cjk_fallback">的</span></span></span></span></span> LH_{now} =TP_{last} + {\mu}V_{last} $ 推导而来）<br> 带入得到：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           e 
          
         
           x 
          
         
           t 
          
         
        
       
         = 
        
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         − 
        
       
         μ 
        
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
         + 
        
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         + 
        
       
         μ 
        
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        LH_{next} = LH_{now} - {\mu}V_{last} +V_{now} + {\mu}V_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span><br> 其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         = 
        
       
         μ 
        
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
         − 
        
       
         α 
        
       
         d 
        
       
         ( 
        
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         ) 
        
       
      
        V_{now} = {\mu}V_{last}-{\alpha}d(LH_{now}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span><span class="mord mathdefault">d</span><span class="mopen">(</span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span><br> 于是更新的主要式子就是：<br> 1 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         = 
        
       
         μ 
        
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
         − 
        
       
         α 
        
       
         d 
        
       
         ( 
        
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         ) 
        
       
      
        V_{now} = {\mu}V_{last}-{\alpha}d(LH_{now}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span><span class="mord mathdefault">d</span><span class="mopen">(</span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span><br> 2 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           e 
          
         
           x 
          
         
           t 
          
         
        
       
         = 
        
       
         L 
        
        
        
          H 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         − 
        
       
         μ 
        
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
         + 
        
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
         + 
        
       
         μ 
        
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        LH_{next} = LH_{now} - {\mu}V_{last} +V_{now} + {\mu}V_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.280556em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord mathdefault">L</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.08125em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span><br> 你会发现第二个式子既需要<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           n 
          
         
           o 
          
         
           w 
          
         
        
       
      
        V_{now} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right: 0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>也需要<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
      
        V_{last} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span><br> 所以需要一个单独的变量「v_prev」来保存<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          V 
         
         
         
           l 
          
         
           a 
          
         
           s 
          
         
           t 
          
         
        
       
      
        V_{last} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.22222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> ，之后再把这两个式子中的<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         L 
        
       
         H 
        
       
      
        LH 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault">L</span><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span></span></span></span></span>换成「x」，V换成「v」，就得到了更新代码：</p> 
<pre><code class="prism language-python">v_prev <span class="token operator">=</span> v <span class="token comment"># 需要一个单独的变量保存上一次的速度</span>
v <span class="token operator">=</span> mu <span class="token operator">*</span> v <span class="token operator">-</span> learning_rate <span class="token operator">*</span> dx <span class="token comment"># 对应上面的1式</span>
x <span class="token operator">+=</span> <span class="token operator">-</span>mu <span class="token operator">*</span> v_prev <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> mu<span class="token punctuation">)</span> <span class="token operator">*</span> v <span class="token comment"># 对应上面的2式</span>
</code></pre> 
<p><strong>本小结用到推论前提</strong></p> 
<ol><li>由于这里设质点的质量为1，时间也为1，工具力学公式，有些量之间的大小是一样的，在推理的时候以下概念可能会混用。 
  <ul><li>损失函数相当于重力势能</li><li>梯度是能量函数的导数也就是重力，或者说是重力作用力</li><li>F=ma 所以 力作用 = 加速度</li><li>v=at 所以 加速度 = 速度</li><li>s = vt 所以 速度 = 位移</li><li>p = mv 所以 动量 = 速度</li></ul> </li><li>v = mu * v - learning_rate * dx 这个式子到底叫做动量更新表达式还是速度更新表达式呢？在质点质量是1的情况下不区分这两种说法。</li><li>x表示参数，也可以看成是质点某一时刻的位置；dx是求出损失函数的梯度解析式再带入x所代表的坐标得到的值，我们知道某一点的梯度代表的是那一点的切线，也可以称之为趋势。</li></ol> 
<p>我们推荐进一步阅读以搞懂这些问题的本源以及 NAG（Nesterov’s Accelerated Momentum）的数学公式</p> 
<ul><li><a href="http://arxiv.org/pdf/1212.0901v2.pdf" rel="nofollow">Advances in optimizing Recurrent Networks</a> Yoshua Bengio，Section 3.5</li><li><a href="http://www.cs.utoronto.ca/~ilya/pubs/ilya_sutskever_phd_thesis.pdf" rel="nofollow">Ilya Sutskever’s thesis</a> 在section7.2 对这个主题有更长的解释</li></ul> 
<h3><a id="42__311"></a>4.2 学习率退火</h3> 
<p>在训练深度网络的时候，随着训练时间进行，对学习率进行退火是有帮助的。你应该始终记住这点：学习率太高意味着系统包含了太多的动能以至于参数向量蹦来蹦去，而没法逐渐的停留在损失函数的“低谷”地区（deep and narrow，准确的翻译应该是地势低并且狭长的地带）。至于什么时候开始衰减学习率则是一个技术活：衰减太慢不行（太慢的话意味着你浪费了太长时间计算资源，这段时间里参数变化非常剧烈但是收敛非常缓慢），衰减太快也不行（系统太早停下来可能导致质点还没有达到最佳的位置）。下面是三种常用的衰减手段：</p> 
<ul><li><strong>步进衰减：</strong> 每过几轮就把学习率调低一点（依据某些原则）。典型数值设置可以这样——每5轮就把学习率削减一半，或者每20轮削减0.1。这些数值的设置非常依赖于问题的类型或者模型的类型。在实践当中，有一种启发式的方法，就是观察“验证集精度”（validation error）曲线变化。首先先用一个固定的学习率训练，当“验证集精读”无法再变得更好的时候就在原有的学习率上减去某一个常数。</li><li><strong>指数衰减：</strong> 指数衰减是自然界普遍的一种变化规律，比如放射性元素的半衰期，药物在人体内的代谢动力学都符合这个规律，包括推导逻辑回归用到的“几率”也是这种思想的一个体现。衰减率的数学表达是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          α 
         
        
          = 
         
         
         
           α 
          
         
           0 
          
         
         
         
           e 
          
          
          
            − 
           
          
            k 
           
          
            t 
           
          
         
        
       
         \alpha = \alpha_0 e^{-k t} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.999108em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathdefault mtight" style="margin-right: 0.03148em;">k</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></span>，其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          a 
         
        
          l 
         
        
          p 
         
        
          h 
         
         
         
           a 
          
         
           0 
          
         
        
       
         alpha_0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">p</span><span class="mord mathdefault">h</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          K 
         
        
       
         K 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.07153em;">K</span></span></span></span></span>是超参数，t可以用迭代次数或者训练轮数来代入。</li><li><strong>1/t 衰减：</strong> 其数学表达式为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          α 
         
        
          = 
         
         
         
           α 
          
         
           0 
          
         
        
          / 
         
        
          ( 
         
        
          1 
         
        
          + 
         
        
          k 
         
        
          t 
         
        
          ) 
         
        
       
         \alpha = \alpha_0 / (1 + k t ) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.0037em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord">/</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span></span></span>，其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          a 
         
        
          l 
         
        
          p 
         
        
          h 
         
         
         
           a 
          
         
           0 
          
         
        
       
         alpha_0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">p</span><span class="mord mathdefault">h</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          K 
         
        
       
         K 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.07153em;">K</span></span></span></span></span>是超参数，t可以用迭代次数或者训练轮数来代入。</li></ul> 
<p>在实践中，我们发现“步进衰减”可能稍微更合适一点。因为“步进衰减”中包含的超参数（包含两个：一个是每次衰减多少、一个是走几步衰减）可能比K有更好的可解释性。最后，如果你的计算资源充沛，哪怕是慢一点也最好选择较慢的衰减和较长时间的训练。</p> 
<h3><a id="43__319"></a>4.3 二阶方法</h3> 
<p>在深度学习中，还有一类流行的优化方法是基于“<a href="http://en.wikipedia.org/wiki/Newton%27s_method_in_optimization" rel="nofollow">牛顿法</a>”的发展起来的。这类方法属于二阶方法。它的更行迭代方式如下：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          x 
         
        
          ← 
         
        
          x 
         
        
          − 
         
        
          [ 
         
        
          H 
         
        
          f 
         
        
          ( 
         
        
          x 
         
        
          ) 
         
         
         
           ] 
          
          
          
            − 
           
          
            1 
           
          
         
        
          ∇ 
         
        
          f 
         
        
          ( 
         
        
          x 
         
        
          ) 
         
        
       
         x \leftarrow x - [H f(x)]^{-1} \nabla f(x) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.66666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord">∇</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span></span></span><br> 这里，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         H 
        
       
         f 
        
       
         ( 
        
       
         x 
        
       
         ) 
        
       
      
        H f(x) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span></span>是<a href="http://en.wikipedia.org/wiki/Hessian_matrix" rel="nofollow">海塞矩阵</a>，它是由损失函数的二阶偏导构成的矩阵。<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ∇ 
        
       
         f 
        
       
         ( 
        
       
         x 
        
       
         ) 
        
       
      
        \nabla f(x) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">∇</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span></span> 是一个由梯度构成的向量，在“梯度下降”那一节中我们已经遇见过。直观上讲，海塞矩阵描述损失函数的局部曲率，它会帮我们更有效的进行更新。尤其是当乘以海塞矩阵的逆矩阵的时候可以让优化的过程得到改进，质点在比较平缓的曲面上行进的时候会用比较大的步子走，而在比较陡峭的曲面上行进的时候会用较小的步子走。还有一点非常重要，在这个二阶的更新公式中不存在任何超参数，这个特点被这类方法的拥趸们认为是比一阶方法强太多的地方。</p> 
<p>但是，在实践中这种方法在深度学习领域里非常的不实用，主要原因就在于计算海塞矩阵的开销太大（不管是时间上的还是空间上的）。举个例子，一个包含100万个参数的神经网络，其海塞矩阵的规模会达到 100 万 X 100 万这个量级，大约会占用3725GB的运行内存空间。因此，为了近似的求解逆矩阵，人们开发了多种多样的算法，这一类算法基本都是拟牛顿算法。在其中最著名的称之为“<a href="http://en.wikipedia.org/wiki/Limited-memory_BFGS" rel="nofollow">L-BFGS</a>”,它利用随时间变化的梯度信息隐式的构造估计值。</p> 
<p>但是，即便是解决了内存方面的问题，原生的“L-BFGS”有一个巨大的缺陷就是它必须在完整的训练集上进行计算。要知道一个完整的训练集可以有上百万个样本啊。不像 mini-batch SGD，让“L-BFGS”能够在mini-batches运行是件非常具有技术含量的事情而且也是现在研究的热点。</p> 
<p>在实践中，在大规模深度学习网络或者卷积神经网络中使用"L-BFGS”以及类似的二阶方法还比较少见。相应的，基于（Nesterov）动量更新的各种变体更常见因为比较简单而且易于扩展。</p> 
<p>更多参考：</p> 
<ul><li><a href="http://research.google.com/archive/large_deep_networks_nips2012.html" rel="nofollow">Large Scale Distributed Deep Networks</a> 来自于谷歌大脑的文章，在大规模分布式的环境中比较了 L-BFGS 以及 SGD 各种变体的优化情况。</li><li><a href="http://arxiv.org/abs/1311.2115" rel="nofollow">SFO</a> 尝试将SGD和L-BFGS的优点综合起来</li></ul> 
<h3><a id="44__337"></a>4.4 逐个参数自适应学习率方法</h3> 
<p>到目前为止我们之前讨论的所有方法在调整学习率的时候都是全局性的调整，也就是对每个参数来说都一样，都用一样的学习率。调整学习率耗时耗力，因此人们设计了很多方法以期望能够自动调整学习率，甚至自动调整每一个参数。虽然许多方法仍然需要其它超参数设置，但是其核心关注点是，相对于原始学习参数来说，它们在更大范围内的超参数范围内表现良好。在这一节中，我们着重介绍一些常见的自适应方法。</p> 
<h4><a id="441_Adagrad_342"></a>4.4.1 Adagrad</h4> 
<p><strong>Adagrad</strong> 最早是由 <a href="http://jmlr.org/papers/v12/duchi11a.html" rel="nofollow">Duchi</a> 等人提出的一种自适应学习率方法。</p> 
<pre><code class="prism language-python"><span class="token comment"># Assume the gradient dx and parameter vector x</span>
cache <span class="token operator">+=</span> dx<span class="token operator">**</span><span class="token number">2</span>
x <span class="token operator">+=</span> <span class="token operator">-</span>learning_rate <span class="token operator">*</span> dx <span class="token operator">/</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
</code></pre> 
<p>变量“cache”占据和梯度一样的空间大小，跟踪每一个参数与梯度平方的和。然后，它将用来规范化参数更新步骤，以“element-wise”的方式。注意那些收到高梯度的权重将减小它们的有效学习率，那些收到很小更新的权重将增加它们的有效学习率。有趣的是，平方根操作似乎非常重要，如果没有它算法的性能会变差。平滑项eps（常常设置成1e-4到1e-8）的使用避免了除以0的情况发生。Adagrad的一个缺点是，在深度学习的任务中，单调学习率被证明太过激进而且过早停止学习。</p> 
<h4><a id="442_RMSprop_354"></a>4.4.2 RMSprop</h4> 
<p><strong>RMSprop</strong> 是一种非常有效，但是当前没有公布的自适应学习率方法。有趣的是，所有用这个方法的人都注明他们这个方法出自于Geoff Hinton在<a href="http://www.cs.toronto.edu/~tijmen/csc321/slides/lecture_slides_lec6.pdf" rel="nofollow">coursera课程</a>中的讲解。RMSprop用了一些简单的方法在Adagrad方法上做了一些调整，使其变得不那么激进，单调地减少学习率。特别地，它利用梯度平方的滑动平均值作为替代：</p> 
<pre><code class="prism language-python">
cache <span class="token operator">=</span> decay_reate <span class="token operator">*</span> cache <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> decay_rate<span class="token punctuation">)</span> <span class="token operator">*</span> dx<span class="token operator">**</span><span class="token number">2</span>
x <span class="token operator">+=</span> <span class="token operator">-</span> learning_rate <span class="token operator">*</span> dx <span class="token operator">/</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>

</code></pre> 
<p>这里，decay_rate是一个超参数，常在[0.9,0.99,0.999]中取值。注意 x + = 更新和 Adagrad一样，但是变量 cache 是“泄露的”（这里是一语双关，缓存斜率了，但是其实cache 只是滑动平均变化，相对于原来那种不变的更新方式）。因此，RMSprop依然是基于各个权重的量级来调整每个权重的学习率，这种方式会有一种有益的均衡化效果，但是不像 Adagrad，其更新并不是单调的变小的。</p> 
<h4><a id="443_Adam_369"></a>4.4.3 Adam</h4> 
<p><a href="http://arxiv.org/abs/1412.6980" rel="nofollow">Adam</a> 是最近才被提出的更新方法。它有点像结合了动量更新的 RMSprop 。（简化的）更新方法如下：</p> 
<pre><code class="prism language-python">
m <span class="token operator">=</span> beta1<span class="token operator">*</span>m <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> beta1<span class="token punctuation">)</span><span class="token operator">*</span>dx
v <span class="token operator">=</span> beta2<span class="token operator">*</span>v <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>beta2<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>dx<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
x <span class="token operator">+=</span> <span class="token operator">-</span> learning_rate <span class="token operator">*</span> m <span class="token operator">/</span> <span class="token punctuation">(</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">+</span> eps <span class="token punctuation">)</span>

</code></pre> 
<p>注意这个更新方式和 RMSprop 非常像，除了替代原始的梯度向量而改用梯度的“滑动”版本（也就是m）之外。相关的推荐值是 eps = 1e-8 ， beta1 = 0.9 , beta2 = 0.999 . 在实践中 Adam方法被推荐作为默认的优化方法而被使用，而且效果比 RMSprop 好那么一点点。 但是， 作为一种替代方案，利用 SGD + Nesterov 也是值得尝试的。 完整的 因为在“完全进入状态”之前、更新进程最开始那几步，由于向量m ，v 都被初始化导致偏置为0，作为一种“补偿作用”,Adam 包含了这用这样一种称之为“偏置校准”的机制。包含“偏置校准”的更新如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># t 是迭代次数，范围从1到正无穷</span>

m <span class="token operator">=</span> beta1<span class="token operator">*</span>m <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> beta1<span class="token punctuation">)</span><span class="token operator">*</span>dx
mt <span class="token operator">=</span> m <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> beta1<span class="token operator">**</span>t<span class="token punctuation">)</span>
v <span class="token operator">=</span> beta2<span class="token operator">*</span>v <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>beta2<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>dx<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>
vt <span class="token operator">=</span> v <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>beta2<span class="token operator">**</span>t<span class="token punctuation">)</span>
x <span class="token operator">+=</span> <span class="token operator">-</span> learning_rate <span class="token operator">*</span> mt <span class="token operator">/</span> <span class="token punctuation">(</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>vt<span class="token punctuation">)</span> <span class="token operator">+</span> eps <span class="token punctuation">)</span>

</code></pre> 
<p>注意，如同其他参数一样，更新式也变成了迭代的函数。我们会让读者查阅论文细节，或者课程幻灯片上对此进行展开。</p> 
<p>更多的参考：</p> 
<ul><li><a href="http://arxiv.org/abs/1312.6055" rel="nofollow">Unit Tests for Stochastic Optimization</a> 针对随机优化设计了一系列测试，这些测试结果可以作为基线。<br> <img src="https://images2.imgbox.com/ac/07/KrH4DbZ1_o.jpg" alt="在这里插入图片描述"></li></ul> 
<p>动画能够帮你对学习过程中的变化过程有一个直观的印象，左边：损失函数的等高线以及不同的优化算法随时间变化的过程。注意基于动量方法的“过火”行为，它是优化看起来像小球滚下山一样。右边：这是某个优化空间中的一个鞍点的图像，不同维度方向上的曲率有不同的符号（一个维度向上弯曲，一个维度向下弯曲）<br> 【这句话这么理解：<br> 咱们就以note上的这个三维的优化空间为例，这是一个比较简单的情况，损失函数只有两个参数需要优化。<br> 曲率是什么概念，是反映曲线弯曲程度的一个值，具体的公式我忘了，但是弯曲程度越大的曲线相同的角度扫过的线段长度也越长嘛，但是我记得好像曲率也有一个微积分定义的。这里不管了啊，应该不影响理解，因为曲率这个东西最好还是从形象的角度去理解。<br> 纬度是什么感觉，在这张图上就是X轴和Y轴嘛。这张图也没标哪个轴是X轴哪个轴是Y轴。那我就随便定一下了。<br> <img src="https://images2.imgbox.com/33/3a/HzZ54NQD_o.jpg" alt="在这里插入图片描述"></p> 
<p>以鞍点（鞍点也正好是X轴、Y轴的原点）为出发点，沿着X的方向是往下走的嘛。如果看剖面图，就是一个向下的曲线。同理沿着Y轴是向上的。<br> 】<br> 注意到，SGD很难打破对称性，而且在最高点停留了很久。相反，类似于RMSprop则在鞍点的方向达到了相当低的梯度。由于RMSprop更新式中的分母部分会增加沿着这个方向的学习速率，因此加速了RMSprop进程。图片来源：<a href="https://twitter.com/alecrad" rel="nofollow">Alec Radford</a></p> 
<h2><a id="_412"></a>五、超参数优化</h2> 
<p>训练神经网络涉及大量的超参数设置。最常见的超参数包含：</p> 
<ul><li>初始学习速率</li><li>学习率衰减策略（比如设置衰减率常数）</li><li>正则化强度（L2 惩罚，随机失活强度）</li></ul> 
<p>但是如同我们看到的那样，有很多不那么敏感的超参数，比如“逐个参数适应学习方法”，动量与其策略的设置。在这一部分中，就超参数的搜索问题我们会描述一些更多的技巧和注意事项。</p> 
<h3><a id="51__421"></a>5.1 实现</h3> 
<p>大型的神经网络一般需要很长时间训练，因此调参这事一干就是好多天（好多星期）。记住这一点很重要，因为它会影响代码底层的设计。有一种设计是让worker连续地随机设置超参数并执行优化。在训练的过程中，worker对每一轮训练后的验证集的准确率进行跟踪，并且将模型的检查点（这里包含各种各样的训练统计数据比如随时间变化的损失情况）写入到一个文件中，最好是共享文件系统中的文件中。最好将验证集的准确率也写到那个检查点的文件名里面，这样方便我们后期进行查看和分类。第二个程序我们称之为master，它的作用是在计算机集群中启动或者终止worker，也可能对worker保存的检查点进行进一步的检查，绘制训练统计数据的图表。<br> 【注：这一段如果你真的看过现代的代码是怎么跑的，你就知道了。光靠这点说没有用。】</p> 
<h3><a id="52__425"></a>5.2 选择一个验证集进行验证而不用交叉验证</h3> 
<p>在大多数情况下，一个单一的包含客观数量的验证集就能起到作用了，并不需要利用多折来进行交叉验证。【注：这里我把simplifies the code base 进行意译了，因为你就用但一个一个验证集进行验证嘛，自然代码就可以少写很多，其实这里想表示的本质意思是，一个验证集就足以起到作用了】。你可能会听到人们说他们“交叉验证”一种参数，但是实际上他们只用了一个验证集。</p> 
<h3><a id="53__430"></a>5.3 超参数范围</h3> 
<p>在对数数量级内寻找超参数。比如说一个典型的学习率设置可能看上去这样： learning_rate = 10 ** uniform(-6, 1)。 也就是说我们从均匀分布里生成了一个随机数，但是把它提到幂的位置上（相对于10的）。这个策略也可以用在正则化强度的设置上。直观上，这是因为学习率和正则化强度对于训练的动态进程有乘的效果。比如说，对于同一个增加量0.01来说，当学习率是0.001时，增加这样一个值会对训练过程产生巨大的影响。但是当学习率是10的时候，这个增加量几乎起不了什么作用。这是由于在更新的过程中，学习率与更新好梯度是相乘的关系（梯度更新里是有学习率这个参数的，嵌套的带带入一下，学习率就是相乘的）。因此我们很自然的想到学习率的范围乘以或者除以某一个值，而不是学习率的范围加上或减去某一个值。有一些参数（比如失活强度）则是在原有的数量级中调整（eg. dropout = uniform(0,1)）</p> 
<h3><a id="54__434"></a>5.4 选择随机搜索而不是网格搜索</h3> 
<p>如同 Bergstra 和 Bengio 在<a href="http://www.jmlr.org/papers/volume13/bergstra12a/bergstra12a.pdf" rel="nofollow">Random Search for Hyper-Parameter Optimization</a>论证的那样，随机选择的试验比网格上的试验更有效地进行超参数优化。就想它所表现出来的，也更容易实现。<br> <img src="https://images2.imgbox.com/15/a6/JPREh5hb_o.jpg" alt="在这里插入图片描述"></p> 
<p>Bergstra 和 Bengio所著的<a href="http://www.jmlr.org/papers/volume13/bergstra12a/bergstra12a.pdf" rel="nofollow">Random Search for Hyper-Parameter Optimization</a>中说明其核心思想的图片。大多数情况下，一些超参数要比其它超参数重要的多。利用随机搜索而不是网格搜索可以让你更准确的发现那些更重要的超参数好数值0。</p> 
<h3><a id="55__443"></a>5.5 留意在边界处的最优值</h3> 
<p>有的时候会发生这种情况：你从一个非常坏的区域寻找超参数。比如说，假设我们利用 learning_rate = 10 ** uniform(-6,1)。一旦我们得到结果，对最终的学习率不在这个间隔的边缘进行双重验证，这点非常重要。否则，你可能就会错失获得哪些超过间隔的更优参数设置。【这句话看得真是不明不白。参考了知乎翻译，这个意思是这样的，其实这个跟调参没有关系了，这就是数学可能性，当你得到的最优解是在区间的边缘上的时候，你要猜测有没有可能在边缘之外可能有更好的解】</p> 
<h3><a id="56__446"></a>5.6 搜索要从粗调到精调</h3> 
<p>在实践中，首先从一个比较大的范围进行快速搜索，之后在根据最有可能在哪儿出现最优值缩小这个范围。粗略搜索只需要在第一个训练周期进行，甚至第一个训练周期都不用执行完。因为大多数参数的设置根本不起作用，要不然就是这些参数根本就没法让模型学习，要不然就是让损失函数直接爆炸。在第二个阶段在较小的范围里搜索5个周期。在最后的阶段里，在最小的那个搜索范围里进行深度细致的搜索，这个过程要重复很多的周期。</p> 
<h3><a id="57__450"></a>5.7 贝叶斯超参数优化</h3> 
<p>贝叶斯超参数优化是一个完整的研究领域，这个领域的主要目的就是提出一些算法来更有效的在超参数空间进行搜索。它的核心理念是——在不同的超参数设置下查看其性能的时候，平衡探索-利用。基于这个模型，有很多库被开发出来了。比较有名的有 <a href="https://github.com/JasperSnoek/spearmint">Spearmint</a>, <a href="http://www.cs.ubc.ca/labs/beta/Projects/SMAC/" rel="nofollow">SMAC</a>以及 <a href="http://jaberg.github.io/hyperopt/" rel="nofollow">Hyperopt</a>。然而，在卷积神经网络的实际使用中，比起上面介绍的先认真挑选的一个范围，然后在该范围内随机搜索的方法，这个方法还是差一些。更多与实战相关的讨论在<a href="http://nlpers.blogspot.com/2014/10/hyperparameter-search-bayesian.html" rel="nofollow">这里</a>。</p> 
<h2><a id="_455"></a>六、评价</h2> 
<h3><a id="_456"></a>模型集成</h3> 
<p>在实践中，为了能将神经网络的性能提高几个百分点，一种比较可靠的方式是训练多个独立的模型，然后在测试阶段综合它们的预测结果。集成模型的性能会随着模型的个数单调的增加（尽管收益率递减）。还有，模型的多样性程度越高，模型改进效果越明显。下面是一些构造集成模型的方法。</p> 
<ul><li><strong>模型相同，初始化参数不一样</strong> ： 利用交叉验证决定最好的超参数，之后在不同的随机初始化条件下训练多个最优超参数组合。这个方法的危险性在于，多样性仅取决于初始化。</li><li><strong>交叉验证中发现的最好模型</strong> ：利用交叉验证决定最好的超参数，选最好的前10个构成集成模型。这个方法改进了多样性，但是不足的地方是包含了次优模型。在实践中，这个比较容易实现因为在交叉验证之后不需要额外的训练模型了。</li><li><strong>单一模型，不同的检查点</strong> ：当训练非常耗时时，将单个神经网络在训练中生成的若干记录点拿出来做成一个集成模型，这种方法多少也起点作用。<br> 虽然缺乏多样性，但是在实践中工作的还行。这种方法的特点是构造起来比较容易。</li><li><strong>在训练的过程中运行参数平均值</strong>：这种方法跟上一个提到的方法有点关联。也是一种很廉价的方法，但是几乎总是可以提高一到两个百分点的性能。它的方法是保存一份网络参数副本到内存中。更准确的说是对训练过程中产生的参数，对它们进行指数衰减求和（是一个累加的过程），并把结果保存在内存中【这句话是参考后面的文本根据自己的理解写出来的，而且我觉得知乎专栏写的不对】。用这种方法你其实把网络最后几次迭代的状态进行了平均。这种把最后几步权重进行平滑的方法往往能有更好的验证误差。对这种现象一种直观的解释是：咱们目标函数是一个碗状空间，我们的网络在这个空间上跳跃，我们对网络参数做平均有助于这个网络跳到中心去。</li></ul> 
<p>集成模型的缺点之一在测试集上获取评价指标需要花很长时间。感兴趣的读者可以看一下 Geoff Hinton最近的工作，他在“<a href="https://www.youtube.com/watch?v=EK61htlw8hY" rel="nofollow">Dark Konwledge</a>”中提出一种想法，他的想法是把集成模型通过一种“蒸馏”的方法萃取成一种单一的模型，其方法是把集成模型的对数似然概率合并到改进的目标函数里。</p> 
<h2><a id="_469"></a>七、总结</h2> 
<p>训练一个神经网络：</p> 
<ul><li>利用小批量的数据对你的代码实现进行梯度检查，注意一些坑（pitfall）</li><li>进行合理性检查。为此你要做到：保证训练一开始的时候你的损失值是合理的。保证你的模型在小份数据上的训练精度能达到100%。</li><li>在训练的过程中监控这些值：损失（随时间的变化）、训练精度/验证精度。如果你想来点花哨的，可以把跟参数有关的更新变化也监控起来（不管是什么参数的更新，这种更新的变化应该都在1e-3）。如果你在训练卷积网络，第一层权重也要监控。</li><li>推荐两种更新方式： SGD+Nesterov ， Adma</li><li>设计一种机制令学习率随着训练进程的深入逐步的减少。比方说每隔几轮就调低一点学习率，或者当验证精度达到最高不再增长的时候再减少一点。</li><li>利用随机搜索的方法来搜索最优超参数（不要用网格搜索）。从粗调到精调</li><li>利用集成的方法提高性能。</li></ul> 
<h2><a id="_480"></a>八、更多参考</h2> 
<ul><li>Leon Bottou 写得有关<a href="http://research.microsoft.com/pubs/192769/tricks-2012.pdf" rel="nofollow">SGD</a>的技巧</li><li>Yann LeCun 写得<a href="http://yann.lecun.com/exdb/publis/pdf/lecun-98b.pdf" rel="nofollow">Efficient BackProp</a></li><li>Yoshua Bengio 所著的<a href="http://arxiv.org/pdf/1206.5533v2.pdf" rel="nofollow">Practical Recommendations for Gradient-Based Training of Deep Architectures</a></li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/806b5a74b3edb47fa568e517a68df673/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">蓝桥杯——2020第十一届C/C&#43;&#43;真题[省赛][B组]</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/033134d5637ceaefdf36a1b466c9fd37/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">DPABI安装教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>