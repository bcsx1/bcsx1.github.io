<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>html5录音支持pc和Android、ios部分浏览器，微信也是支持的，JavaScript getUserMedia - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="html5录音支持pc和Android、ios部分浏览器，微信也是支持的，JavaScript getUserMedia" />
<meta property="og:description" content="以前在前人基础上重复造了一个网页录音的轮子，顺带把github仓库使用研究了一下，扔到了github上。
优势在于结构简单，可插拔式的录音格式支持，几乎可以支持任意格式（前提有相应的编码器）；默认提供实时音量反馈、有一个波形显示扩展支持。录音结果非常容易立即播放录音或者上传录音到服务器（提供参考源码）。
2018-05-16首发，2019-04-21更新
GitHub地址：https://github.com/xiangyuecn/Recorder
在线测试demo传送门：https://xiangyuecn.github.io/Recorder/
效果图 自述 以前准备做一个网页版聊天界面，表情啊、图片啊、上传文件啊都应该要有，视频就算了，语音还是要的。
当下环境html5的录音功能支持情况大为良好（IOS上偏落后点）
如是，就有了这个轮子。
以下内容copy自README
Recorder用于html5录音 在线测试，支持大部分已实现getUserMedia的移动端、PC端浏览器，包括腾讯Android X5内核(QQ、微信)。点此查看浏览器支持情况。
录音默认输出mp3格式，另外可选wav格式（此格式录音文件超大）；有限支持ogg(beta)、webm(beta)、amr(beta)格式；支持任意格式扩展（前提有相应编码器）。
mp3默认16kbps的比特率，2kb每秒的录音大小，音质还可以（如果使用8kbps可达到1kb每秒，不过音质太渣）。
mp3使用lamejs编码，压缩后的recorder.mp3.min.js文件150kb左右（开启gzip后54kb）。如果对录音文件大小没有特别要求，可以仅仅使用录音核心&#43;wav编码器，源码不足300行，压缩后的recorder.wav.min.js不足4kb。
浏览器Audio Media兼容性mp3最好，wav还行，其他要么不支持播放，要么不支持编码。
特别注：IOS(11.X、12.X)上只有Safari支持getUserMedia，其他浏览器均不支持，参考下面的已知问题。
快速使用 【1】加载框架 在需要录音功能的页面引入压缩好的recorder.***.min.js文件即可 （注意：需要在https等安全环境下才能进行录音）
&lt;script src=&#34;recorder.mp3.min.js&#34;&gt;&lt;/script&gt; 或者直接使用源码（src内的为源码、dist内的为压缩后的），可以引用src目录中的recorder-core.js&#43;相应类型的实现文件，比如要mp3录音：
&lt;script src=&#34;src/recorder-core.js&#34;&gt;&lt;/script&gt; &lt;!--必须引入的录音核心--&gt; &lt;script src=&#34;src/engine/mp3.js&#34;&gt;&lt;/script&gt; &lt;!--相应格式支持文件--&gt; &lt;script src=&#34;src/engine/mp3-engine.js&#34;&gt;&lt;/script&gt; &lt;!--如果此格式有额外的编码引擎的话，也要加上--&gt; 【2】调用录音 然后使用，假设立即运行，只录3秒
var rec=Recorder();//使用默认配置，mp3格式 rec.open(function(){//打开麦克风授权获得相关资源 rec.start();//开始录音 setTimeout(function(){ rec.stop(function(blob,duration){//到达指定条件停止录音 console.log(URL.createObjectURL(blob),&#34;时长:&#34;&#43;duration&#43;&#34;ms&#34;); rec.close();//释放录音资源 //已经拿到blob文件对象想干嘛就干嘛：立即播放、上传 /*立即播放例子*/ var audio=document.createElement(&#34;audio&#34;); audio.controls=true; document.body.appendChild(audio); //简单的一哔 audio.src=URL.createObjectURL(blob); audio.play(); },function(msg){ console.log(&#34;录音失败:&#34;&#43;msg); }); },3000); },function(msg,isUserNotAllow){//用户拒绝未授权或不支持 console.log((isUserNotAllow?&#34;UserNotAllow，&#34;:&#34;&#34;)&#43;&#34;无法录音:&#34;&#43;msg); }); 【附】录音上传示例 var TestApi=&#34;/test_request&#34;;//用来在控制台network中能看到请求数据，测试的请求结果无关紧要 var rec=Recorder();rec.open(function(){rec.start();setTimeout(function(){rec.stop(function(blob,duration){ //-----↓↓↓以下才是主要代码↓↓↓------- //本例子假设使用jQuery封装的请求方式，实际使用中自行调整为自己的请求方式 //录音结束时拿到了blob文件对象，可以用FileReader读取出内容，或者用FormData上传 var api=TestApi; /***方式一：将blob文件转成base64纯文本编码，使用普通application/x-www-form-urlencoded表单上传***/ var reader=new FileReader(); reader." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/add63b359cd1c48a87f9c3bd04727a7d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-05-16T23:17:41+08:00" />
<meta property="article:modified_time" content="2018-05-16T23:17:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">html5录音支持pc和Android、ios部分浏览器，微信也是支持的，JavaScript getUserMedia</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>以前在前人基础上重复造了一个网页录音的轮子，顺带把github仓库使用研究了一下，扔到了github上。</p> 
 <p>优势在于结构简单，可插拔式的录音格式支持，几乎可以支持任意格式（前提有相应的编码器）；默认提供实时音量反馈、有一个波形显示扩展支持。录音结果非常容易立即播放录音或者上传录音到服务器（提供参考源码）。</p> 
 <p>2018-05-16首发，2019-04-21更新</p> 
</blockquote> 
<p>GitHub地址：<a href="https://github.com/xiangyuecn/Recorder">https://github.com/xiangyuecn/Recorder</a></p> 
<p>在线测试demo传送门：<a href="https://xiangyuecn.github.io/Recorder/" rel="nofollow">https://xiangyuecn.github.io/Recorder/</a></p> 
<h2><a id="_11"></a>效果图</h2> 
<p><img src="https://images2.imgbox.com/5d/03/dsljxIWD_o.png" alt=""></p> 
<h2><a id="_16"></a>自述</h2> 
<p>以前准备做一个网页版聊天界面，表情啊、图片啊、上传文件啊都应该要有，视频就算了，语音还是要的。</p> 
<p>当下环境html5的录音功能支持情况大为良好（IOS上偏落后点）<br> <img src="https://images2.imgbox.com/78/f2/8yJ8zkON_o.png" alt="2019-04浏览器支持情况，棒棒哒"></p> 
<p>如是，就有了这个轮子。</p> 
<blockquote> 
 <p>以下内容copy自README</p> 
</blockquote> 
<h2><a id="Recorderhtml5_28"></a>Recorder用于html5录音</h2> 
<p><a href="https://xiangyuecn.github.io/Recorder/" rel="nofollow">在线测试</a>，支持大部分已实现<code>getUserMedia</code>的移动端、PC端浏览器，包括腾讯Android X5内核(QQ、微信)。<a href="https://caniuse.com/#search=getUserMedia" rel="nofollow">点此</a>查看浏览器支持情况。</p> 
<p>录音默认输出mp3格式，另外可选wav格式（此格式录音文件超大）；有限支持ogg(beta)、webm(beta)、amr(beta)格式；支持任意格式扩展（前提有相应编码器）。</p> 
<p>mp3默认16kbps的比特率，2kb每秒的录音大小，音质还可以（如果使用8kbps可达到1kb每秒，不过音质太渣）。</p> 
<p>mp3使用lamejs编码，压缩后的recorder.mp3.min.js文件150kb左右（开启gzip后54kb）。如果对录音文件大小没有特别要求，可以仅仅使用录音核心+wav编码器，源码不足300行，压缩后的recorder.wav.min.js不足4kb。</p> 
<p>浏览器Audio Media<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Supported_media_formats#Browser_compatibility" rel="nofollow">兼容性</a>mp3最好，wav还行，其他要么不支持播放，要么不支持编码。</p> 
<p>特别注：<code>IOS(11.X、12.X)</code>上只有<code>Safari</code>支持<code>getUserMedia</code>，其他浏览器均不支持，参考下面的已知问题。</p> 
<h2><a id="_44"></a>快速使用</h2> 
<h3><a id="1_46"></a>【1】加载框架</h3> 
<p>在需要录音功能的页面引入压缩好的recorder.***.min.js文件即可 （<strong>注意：需要在https等安全环境下才能进行录音</strong>）</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>recorder.mp3.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>或者直接使用源码（src内的为源码、dist内的为压缩后的），可以引用src目录中的recorder-core.js+相应类型的实现文件，比如要mp3录音：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>src/recorder-core.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--必须引入的录音核心--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>src/engine/mp3.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--相应格式支持文件--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>src/engine/mp3-engine.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--如果此格式有额外的编码引擎的话，也要加上--&gt;</span>
</code></pre> 
<h3><a id="2_58"></a>【2】调用录音</h3> 
<p>然后使用，假设立即运行，只录3秒</p> 
<pre><code class="prism language-javascript"><span class="token keyword">var</span> rec<span class="token operator">=</span><span class="token function">Recorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使用默认配置，mp3格式</span>

rec<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//打开麦克风授权获得相关资源</span>
    rec<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始录音</span>
    
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        rec<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span>duration<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//到达指定条件停止录音</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"时长:"</span><span class="token operator">+</span>duration<span class="token operator">+</span><span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rec<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放录音资源</span>
            <span class="token comment">//已经拿到blob文件对象想干嘛就干嘛：立即播放、上传</span>
            
            <span class="token comment">/*立即播放例子*/</span>
            <span class="token keyword">var</span> audio<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"audio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            audio<span class="token punctuation">.</span>controls<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>audio<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//简单的一哔</span>
            audio<span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            audio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"录音失败:"</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span>isUserNotAllow<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//用户拒绝未授权或不支持</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span>isUserNotAllow<span class="token operator">?</span><span class="token string">"UserNotAllow，"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"无法录音:"</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_89"></a>【附】录音上传示例</h3> 
<pre><code class="prism language-javascript"><span class="token keyword">var</span> TestApi<span class="token operator">=</span><span class="token string">"/test_request"</span><span class="token punctuation">;</span><span class="token comment">//用来在控制台network中能看到请求数据，测试的请求结果无关紧要</span>
<span class="token keyword">var</span> rec<span class="token operator">=</span><span class="token function">Recorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>rec<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>rec<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>rec<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span>duration<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token comment">//-----↓↓↓以下才是主要代码↓↓↓-------</span>

<span class="token comment">//本例子假设使用jQuery封装的请求方式，实际使用中自行调整为自己的请求方式</span>
<span class="token comment">//录音结束时拿到了blob文件对象，可以用FileReader读取出内容，或者用FormData上传</span>
<span class="token keyword">var</span> api<span class="token operator">=</span>TestApi<span class="token punctuation">;</span>

<span class="token comment">/***方式一：将blob文件转成base64纯文本编码，使用普通application/x-www-form-urlencoded表单上传***/</span>
<span class="token keyword">var</span> reader<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function-variable function">onloadend</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        url<span class="token punctuation">:</span>api <span class="token comment">//上传接口地址</span>
        <span class="token punctuation">,</span>type<span class="token punctuation">:</span><span class="token string">"POST"</span>
        <span class="token punctuation">,</span>data<span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
            mime<span class="token punctuation">:</span>blob<span class="token punctuation">.</span>type <span class="token comment">//告诉后端，这个录音是什么格式的，可能前后端都固定的mp3可以不用写</span>
            <span class="token punctuation">,</span>upfile_b64<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token regex">/.+;\s*base64\s*,\s*(.+)$/i</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">//录音文件内容，后端进行base64解码成二进制</span>
            <span class="token comment">//...其他表单参数</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">,</span>success<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"上传成功"</span><span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">,</span>error<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"上传失败"</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/***方式二：使用FormData用multipart/form-data表单上传文件***/</span>
<span class="token keyword">var</span> form<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
form<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"upfile"</span><span class="token punctuation">,</span>blob<span class="token punctuation">,</span><span class="token string">"recorder.mp3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//和普通form表单并无二致，后端接收到upfile参数的文件，文件名为recorder.mp3</span>
<span class="token comment">//...其他表单参数</span>
$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    url<span class="token punctuation">:</span>api <span class="token comment">//上传接口地址</span>
    <span class="token punctuation">,</span>type<span class="token punctuation">:</span><span class="token string">"POST"</span>
    <span class="token punctuation">,</span>contentType<span class="token punctuation">:</span><span class="token boolean">false</span> <span class="token comment">//让xhr自动处理Content-Type header，multipart/form-data需要生成随机的boundary</span>
    <span class="token punctuation">,</span>processData<span class="token punctuation">:</span><span class="token boolean">false</span> <span class="token comment">//不要处理data，让xhr自动处理</span>
    <span class="token punctuation">,</span>data<span class="token punctuation">:</span>form
    <span class="token punctuation">,</span>success<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"上传成功"</span><span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">,</span>error<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"上传失败"</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//-----↑↑↑以上才是主要代码↑↑↑-------</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"录音失败:"</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"无法录音:"</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_142"></a>【附】问题排查</h3> 
<ul><li>打开<a href="https://xiangyuecn.github.io/Recorder/" rel="nofollow">Demo页面</a>试试看，是不是也有同样的问题。</li><li>检查是不是在https之类的安全环境下调用的。</li><li>检查是不是IOS系统，确认<a href="https://caniuse.com/#search=getUserMedia" rel="nofollow">caniuse</a>IOS对<code>getUserMedia</code>的支持情况。</li><li>检查上面第1步是否把框架加载到位，在<a href="https://xiangyuecn.github.io/Recorder/" rel="nofollow">Demo页面</a>有应该加载哪些js的提示。</li><li>提交Issue，热心网友帮你解答。</li></ul> 
<h2><a id="_150"></a>方法文档</h2> 
<h4><a id="recRecorderset_152"></a>【构造】rec=Recorder(set)</h4> 
<p>构造函数，拿到<code>Recorder</code>的实例，然后可以进行请求获取麦克风权限和录音。</p> 
<p><code>set</code>参数为配置对象，默认配置值如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">set</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    type<span class="token punctuation">:</span><span class="token string">"mp3"</span> <span class="token comment">//输出类型：mp3,wav等，使用一个类型前需要先引入对应的编码引擎</span>
    <span class="token punctuation">,</span>bitRate<span class="token punctuation">:</span><span class="token number">16</span> <span class="token comment">//比特率 wav(位):16、8，MP3(单位kbps)：8kbps时文件大小1k/s，16kbps 2k/s，录音文件很小</span>
    
    <span class="token punctuation">,</span>sampleRate<span class="token punctuation">:</span><span class="token number">16000</span> <span class="token comment">//采样率，wav格式文件大小=sampleRate*时间；mp3此项对低比特率文件大小有影响，高比特率几乎无影响。</span>
                <span class="token comment">//wav任意值，mp3取值范围：48000, 44100, 32000, 24000, 22050, 16000, 12000, 11025, 8000</span>
    
    <span class="token punctuation">,</span>bufferSize<span class="token punctuation">:</span><span class="token number">4096</span> <span class="token comment">//AudioContext缓冲大小。会影响onProcess调用速度，相对于AudioContext.sampleRate=48000时，4096接近12帧/s，调节此参数可生成比较流畅的回调动画。</span>
                <span class="token comment">//取值256, 512, 1024, 2048, 4096, 8192, or 16384</span>
                <span class="token comment">//注意，取值不能过低，2048开始不同浏览器可能回调速率跟不上造成音质问题（低端浏览器→说的就是腾讯X5）</span>
    
    <span class="token punctuation">,</span>onProcess<span class="token punctuation">:</span><span class="token constant">NOOP</span> <span class="token comment">//接收到录音数据时的回调函数：fn(this.buffer,powerLevel,bufferDuration,bufferSampleRate) </span>
                <span class="token comment">//buffer=[缓冲PCM数据,...]，powerLevel：当前缓冲的音量级别0-100，bufferDuration：已缓冲时长，bufferSampleRate：缓冲使用的采样率</span>
                <span class="token comment">//如果需要绘制波形之类功能，需要实现此方法即可，使用以计算好的powerLevel可以实现音量大小的直观展示，使用buffer可以达到更高级效果</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>注意：set内是数字的明确传数字</strong>，不要传字符串之类的导致不可预测的异常，其他有配置的地方也是一样（感谢<code>214282049@qq.com</code>19-01-10发的反馈邮件）。</p> 
<h4><a id="recopensuccessfail_177"></a>【方法】rec.open(success,fail)</h4> 
<p>请求打开录音资源，如果浏览器不支持录音或用户拒绝麦克风权限将会调用<code>fail</code>，打开后需要调用<code>close</code>。</p> 
<p>注意：此方法是异步的；一般使用时打开，用完立即关闭；可重复调用，可用来测试是否能录音。</p> 
<p>另外：因为此方法会调起用户授权请求，如果仅仅想知道浏览器是否支持录音（比如：如果浏览器不支持就走另外一套录音方案），应使用<code>Recorder.Support()</code>方法。</p> 
<p><code>success</code>=fn();</p> 
<p><code>fail</code>=fn(errMsg,isUserNotAllow); 如果是用户主动拒绝的录音权限，除了有错误消息外，isUserNotAllow=true，方便程序中做不同的提示，提升用户主动授权概率</p> 
<h4><a id="recclosesuccess_189"></a>【方法】rec.close(success)</h4> 
<p>关闭释放录音资源，释放完成后会调用<code>success()</code>回调</p> 
<h4><a id="recstart_192"></a>【方法】rec.start()</h4> 
<p>开始录音，需先调用<code>open</code>；如果不支持、错误，不会有任何提示，因为stop时自然能得到错误。</p> 
<h4><a id="recstopsuccessfail_195"></a>【方法】rec.stop(success,fail)</h4> 
<p>结束录音并返回录音数据<code>blob对象</code>，拿到blob对象就可以为所欲为了，不限于立即播放、上传</p> 
<p><code>success(blob,duration)</code>：<code>blob</code>：录音数据audio/mp3|wav…格式，<code>duration</code>：录音时长，单位毫秒</p> 
<p><code>fail(errMsg)</code>：录音出错回调</p> 
<p>提示：stop时会进行音频编码，音频编码可能会很慢，10几秒录音花费2秒左右算是正常，编码并未使用Worker方案(文件多)，内部采取的是分段编码+setTimeout来处理，界面卡顿不明显。</p> 
<h4><a id="recpause_205"></a>【方法】rec.pause()</h4> 
<p>暂停录音。</p> 
<h4><a id="recresume_208"></a>【方法】rec.resume()</h4> 
<p>恢复继续录音。</p> 
<h4><a id="recmockpcmDatapcmSampleRate_211"></a>【方法】rec.mock(pcmData,pcmSampleRate)</h4> 
<p>模拟一段录音数据，后面可以调用stop进行编码。需提供pcm数据int[]，和pcm数据的采样率。</p> 
<p>可用于将一个音频解码出来的pcm数据方便的转换成另外一个格式：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">var</span> amrBlob<span class="token operator">=</span><span class="token operator">...</span><span class="token punctuation">;</span><span class="token comment">//amr音频blob对象</span>
<span class="token keyword">var</span> amrSampleRate<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">;</span><span class="token comment">//amr音频采样率</span>

<span class="token comment">//解码amr得到pcm数据</span>
<span class="token keyword">var</span> reader<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Recorder<span class="token punctuation">.</span><span class="token constant">AMR</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>pcm<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">transformOgg</span><span class="token punctuation">(</span>pcm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>amrBlob<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//将pcm转成ogg</span>
<span class="token keyword">function</span> <span class="token function">transformOgg</span><span class="token punctuation">(</span>pcmData<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">Recorder</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>type<span class="token punctuation">:</span><span class="token string">"ogg"</span><span class="token punctuation">,</span>bitRate<span class="token punctuation">:</span><span class="token number">64</span><span class="token punctuation">,</span>sampleRate<span class="token punctuation">:</span><span class="token number">32000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span>pcmData<span class="token punctuation">,</span>amrSampleRate<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span>duration<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//我们就得到了新采样率和比特率的ogg文件</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="RecorderSupport_239"></a>【静态方法】Recorder.Support()</h4> 
<p>判断浏览器是否支持录音，随时可以调用。注意：仅仅是检测浏览器支持情况，不会判断和调起用户授权（rec.open()会判断用户授权），不会判断是否支持特定格式录音。</p> 
<h4><a id="RecorderIsOpen_242"></a>【静态方法】Recorder.IsOpen()</h4> 
<p>由于Recorder持有的录音资源是全局唯一的，可通过此方法检测是否有Recorder已调用过open打开了录音功能。</p> 
<h2><a id="js_246"></a>压缩合并一个自己需要的js文件</h2> 
<p>可参考/src/package-build.js中如何合并的一个文件，比如mp3是由<code>recorder-core.js</code>,<code>engine/mp3.js</code>,<code>engine/mp3-engine.js</code>组成的。</p> 
<p>除了<code>recorder-core.js</code>其他引擎文件都是可选的，可以把全部编码格式合到一起也，也可以只合并几种，然后就可以支持相应格式的录音了。</p> 
<p>可以修改/src/package-build.js后，在src目录内执行压缩：</p> 
<pre><code class="prism language-javascript">cnpm install
npm start
</code></pre> 
<h2><a id="_257"></a>关于现有编码器</h2> 
<p>如果你有其他格式的编码器并且想贡献出来，可以提交新增格式文件的pull（文件放到/src/engine中），我们升级它。</p> 
<h3><a id="wav_260"></a>wav</h3> 
<p>wav格式编码器时参考网上资料写的，会发现代码和别人家的差不多。源码2kb大小。</p> 
<h3><a id="mp3_263"></a>mp3</h3> 
<p>采用的是<a href="https://github.com/zhuker/lamejs">lamejs</a>(LGPL License)这个库的代码，<code>https://github.com/zhuker/lamejs/blob/bfb7f6c6d7877e0fe1ad9e72697a871676119a0e/lame.all.js</code>这个版本的文件代码；已对lamejs源码进行了部分改动，用于修复发现的问题。LGPL协议涉及到的文件：<code>mp3-engine.js</code>；这些文件也采用LGPL授权，不适用MIT协议。源码518kb大小，压缩后150kb左右，开启gzip后50来k。</p> 
<h3><a id="betaogg_266"></a>beta-ogg</h3> 
<p>采用的是<a href="https://github.com/higuma/ogg-vorbis-encoder-js">ogg-vorbis-encoder-js</a>(MIT License)，<code>https://github.com/higuma/ogg-vorbis-encoder-js/blob/7a872423f416e330e925f5266d2eb66cff63c1b6/lib/OggVorbisEncoder.js</code>这个版本的文件代码。此编码器源码2.2M，超级大，压缩后1.6M，开启gzip后327K左右。对录音的压缩率比lamejs高出一倍, 但Vorbis in Ogg好像Safari不支持（<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Supported_media_formats#Browser_compatibility" rel="nofollow">真的假的</a>）。</p> 
<h3><a id="betawebm_269"></a>beta-webm</h3> 
<p>这个编码器时通过查阅MDN编写的一个玩意，没多大使用价值：录几秒就至少要几秒来编码。。。原因是：未找到对已有pcm数据进行快速编码的方法。数据导入到MediaRecorder，音频有几秒就要等几秒，类似边播放边收听形。(想接原始录音Stream？我不可能给的!)输出音频虽然可以通过比特率来控制文件大小，但音频文件中的比特率并非设定比特率，采样率由于是我们自己采样的，到这个编码器随他怎么搞。只有比较新的浏览器支持（需实现浏览器MediaRecorder），压缩率和mp3差不多。源码2kb大小。</p> 
<h3><a id="betaamr_272"></a>beta-amr</h3> 
<p>采用的是<a href="https://github.com/BenzLeung/benz-amr-recorder">benz-amr-recorder</a>(MIT License)优化后的<a href="https://github.com/jpemartins/amr.js">amr.js</a>(Unknown License)，<code>https://github.com/BenzLeung/benz-amr-recorder/blob/462c6b91a67f7d9f42d0579fb5906fad9edb2c9d/src/amrnb.js</code>这个版本的文件代码，已对此代码进行过调整更方便使用。支持编码和解码操作。由于最高只有12.8kbps的码率，音质和同比配置的mp3、ogg差一个档次。由于支持解码操作，理论上所有支持Audio的浏览器都可以播放（需要自己写代码实现）。源码1M多，蛮大，压缩后445K，开启gzip后136K。优点：录音文件小。</p> 
<h4><a id="Recorderamr2wavamrBlobTrueFalse_275"></a>Recorder.amr2wav(amrBlob,True,False)</h4> 
<p>已实现的一个把amr转成wav格式来播放的方法，<code>True=fn(wavBlob,duration)</code>。要使用此方法需要带上上面的<code>wav</code>格式编码器。仿照此方法可轻松转成别的格式，参考<code>mock</code>方法介绍那节。</p> 
<h2><a id="_280"></a>其他音频格式支持办法</h2> 
<pre><code class="prism language-javascript"><span class="token comment">//比如增加aac格式支持 (可参考/src/engine/mp3.js实现)</span>

<span class="token comment">//新增一个aac.js，编写以下格式代码即可实现这个类型</span>
Recorder<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">aac</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span>pcmData<span class="token punctuation">,</span>successCall<span class="token punctuation">,</span>failCall<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//通过aac编码器把pcm数据转成aac格式数据，通过this.set拿到传入的配置数据</span>
    <span class="token operator">...</span> pcmData<span class="token operator">-</span><span class="token operator">&gt;</span>aacData
    
    <span class="token comment">//返回数据</span>
    <span class="token function">successCall</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span>aacData<span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>type<span class="token punctuation">:</span><span class="token string">"audio/aac"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//调用</span>
<span class="token function">Recorder</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>type<span class="token punctuation">:</span><span class="token string">"aac"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_298"></a>扩展</h2> 
<p>在<code>src/extensions</code>目录内为扩展支持库，这些扩展库默认都没有合并到生成代码中，需单独引用(<code>dist</code>或<code>src</code>中的)才能使用。</p> 
<h3><a id="WaveView_301"></a><code>WaveView</code>扩展</h3> 
<p><code>waveview.js</code>，4kb大小源码，录音时动态显示波形，具体样子参考演示地址页面。此扩展参考<a href="https://github.com/HaloMartin/MCVoiceWave">MCVoiceWave</a>库编写的，具体代码在<code>https://github.com/HaloMartin/MCVoiceWave/blob/f6dc28975fbe0f7fc6cc4dbc2e61b0aa5574e9bc/MCVoiceWave/MCVoiceWaveView.m</code>中。</p> 
<p>此扩展是在录音时<code>onProcess</code>回调中使用；<code>bufferSize</code>会影响绘制帧率，越小越流畅（但越消耗cpu），默认配置的大概12帧/s。基础使用方法：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">var</span> wave<span class="token punctuation">;</span>
<span class="token keyword">var</span> rec<span class="token operator">=</span><span class="token function">Recorder</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    onProcess<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>buffers<span class="token punctuation">,</span>powerLevel<span class="token punctuation">,</span>bufferDuration<span class="token punctuation">,</span>bufferSampleRate<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        wave<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span>buffers<span class="token punctuation">[</span>buffers<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>powerLevel<span class="token punctuation">,</span>bufferSampleRate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输入音频数据，更新显示波形</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rec<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    wave<span class="token operator">=</span>Recorder<span class="token punctuation">.</span><span class="token function">WaveView</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>elem<span class="token punctuation">:</span><span class="token string">".elem"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建wave对象，写这里面浏览器妥妥的</span>
    
    rec<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="waveRecorderWaveViewset_319"></a>【构造】wave=Recorder.WaveView(set)</h4> 
<p>构造函数，<code>set</code>参数为配置对象，默认配置值如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">set</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    elem<span class="token punctuation">:</span><span class="token string">"css selector"</span> <span class="token comment">//自动显示到dom，并以此dom大小为显示大小</span>
        <span class="token comment">//或者配置显示大小，手动把waveviewObj.elem显示到别的地方</span>
    <span class="token punctuation">,</span>width<span class="token punctuation">:</span><span class="token number">0</span> <span class="token comment">//显示宽度</span>
    <span class="token punctuation">,</span>height<span class="token punctuation">:</span><span class="token number">0</span> <span class="token comment">//显示高度</span>
    
    <span class="token comment">//以上配置二选一</span>
    
    scale<span class="token punctuation">:</span><span class="token number">2</span> <span class="token comment">//缩放系数，因为正整数，使用2(3? no!)倍宽高进行绘制，避免移动端绘制模糊</span>
    <span class="token punctuation">,</span>speed<span class="token punctuation">:</span><span class="token number">8</span> <span class="token comment">//移动速度系数，越大越快</span>
    
    <span class="token punctuation">,</span>lineWidth<span class="token punctuation">:</span><span class="token number">2</span> <span class="token comment">//线条基础粗细</span>
            
    <span class="token comment">//渐变色配置：[位置，css颜色，...] 位置: 取值0.0-1.0之间</span>
    <span class="token punctuation">,</span>linear1<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"rgba(150,97,236,1)"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"rgba(54,197,252,1)"</span><span class="token punctuation">]</span> <span class="token comment">//线条渐变色1，从左到右</span>
    <span class="token punctuation">,</span>linear2<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"rgba(209,130,253,0.6)"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"rgba(54,197,252,0.6)"</span><span class="token punctuation">]</span> <span class="token comment">//线条渐变色2，从左到右</span>
    <span class="token punctuation">,</span>linearBg<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"rgba(255,255,255,0.2)"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"rgba(54,197,252,0.2)"</span><span class="token punctuation">]</span> <span class="token comment">//背景渐变色，从上到下</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="waveinputpcmDatapowerLevelsampleRate_342"></a>【方法】wave.input(pcmData,powerLevel,sampleRate)</h4> 
<p>输入音频数据，更新波形显示，这个方法调用的越快，波形越流畅。pcmData为当前的录音数据片段，其他参数和<code>onProcess</code>回调相同。</p> 
<h2><a id="_346"></a>兼容性</h2> 
<p>对于支持录音的浏览器能够正常录音并返回录音数据；对于不支持的浏览器，引入js和执行相关方法都不会产生异常，并且进入相关的fail回调。一般在open的时候就能检测到是否支持或者被用户拒绝，可在用户开始录音之前提示浏览器不支持录音或授权。</p> 
<h2><a id="Android_Hybrid_App_350"></a>Android Hybrid App中录音示例</h2> 
<p>在Android Hybrid App中使用本库来录音，需要在App源码中实现以下两步分：</p> 
<ol><li>在<code>AndroidManifest.xml</code>声明需要用到的两个权限</li></ol> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.RECORD_AUDIO<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.MODIFY_AUDIO_SETTINGS<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> 
<ol start="2"><li><code>WebChromeClient</code>中实现<code>onPermissionRequest</code>网页授权请求</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPermissionRequest</span><span class="token punctuation">(</span>PermissionRequest request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>此处应包裹一层系统权限请求
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>LOLLIPOP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        request<span class="token punctuation">.</span><span class="token function">grant</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>注：如果应用的<code>腾讯X5内核</code>，除了上面两个权限外，还必须提供<code>android.permission.CAMERA</code>权限。另外无法重写此<code>onPermissionRequest</code>方法，他会自己弹框询问，如果被拒绝了就永远拒绝了，参考已知问题部分。</p> 
</blockquote> 
<p>如果不出意外，App内显示的网页就能正常录音了。</p> 
<h4><a id="_374"></a>附带测试项目</h4> 
<p><code>.assets/android_test</code>目录中提供了Android测试源码（如果不想自己打包可以用打包好的apk来测试，位于<code>.assets/android_test/app-debug-xxx.apk</code>）。提供了<code>系统自带WebView</code>、和<code>腾讯X5内核</code>两个测试界面。</p> 
<h2><a id="JsSDK_379"></a>关于微信JsSDK</h2> 
<p>微信内浏览器他家的<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115" rel="nofollow">JsSDK</a>也支持录音，涉及笨重难调的公众号开发（光sdk初始化就能阻碍很多新奇想法的产生，signature限制太多），只能满足最基本的使用（大部分情况足够了）。如果JsSDK录完音能返回音频数据，这个SDK将好用10000倍，如果能实时返回音频数据，将好用100000倍。关键是他们家是拒绝给这种简单好用的功能的，必须绕一个大圈：录好音了-&gt;上传到微信服务器-&gt;自家服务器请求微信服务器多进行媒体下载-&gt;保存录音（微信小程序以前也是二逼路子，现在稍微好点能实时拿到录音mp3数据），如果能升级：录好音了拿到音频数据-&gt;上传保存录音，目测对最终结果是没有区别的，还简单不少，对微信自家也算是非常经济实用。[2018]由于微信IOS上不支持原生JS录音，Android上又支持，为了兼容而去兼容的事情我是拒绝的（而且是仅仅为了兼容IOS上面的微信），其实也算不上去兼容，因为微信JsSDK中的接口完全算是另外一种东西，接入的话对整个录音流程都会产生完全不一样的变化，还不如没有进入录音流程之前就进行分支判断处理。</p> 
<p>最后：如果是在微信上用的多，应优先直接接入他家的JsSDK（没有公众号开个订阅号又不要钱），基本上可以忽略兼容性问题，就是麻烦点。</p> 
<h2><a id="_390"></a>已知问题</h2> 
<p><em>2018-09-19</em> <a href="https://caniuse.com/#search=getUserMedia" rel="nofollow">caniuse</a> 注明<code>IOS</code> <code>11.X - 12.X</code> 上 只有<code>Safari</code>支持调用<code>getUserMedia</code>，其他App下WKWebView(UIWebView?)(<a href="https://forums.developer.apple.com/thread/88052" rel="nofollow">相关资料</a>)均不支持。经用户测试验证IOS 12上chrome、UC都无法录音，部分IOS 12 Safari可以获取到并且能正常录音，但部分不行，原因未知，参考<a href="https://www.v2ex.com/t/490695" rel="nofollow">ios 12 支不支持录音了</a>。在IOS上不支持录音的环境下应该采用其他解决方案，参考<code>案例演示</code>、<code>关于微信JsSDK</code>部分。</p> 
<p><em>2019-02-28</em> <a href="https://github.com/xiangyuecn/Recorder/issues/14">issues#14</a> 如果<code>getUserMedia</code>返回的<a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaStreamTrack" rel="nofollow"><code>MediaStreamTrack.readyState == "ended"</code>，<code>"ended" which indicates that the input is not giving any more data and will never provide new data.</code></a> ，导致无法录音。如果产生这种情况，目前在<code>rec.open</code>方法调用时会正确检测到，并执行<code>fail</code>回调。造成<code>issues#14</code> <code>ended</code>原因是App源码中<code>AndroidManifest.xml</code>中没有声明<code>android.permission.MODIFY_AUDIO_SETTINGS</code>权限，导致腾讯X5不能正常录音。</p> 
<p><em>2019-03-09</em> 在Android上QQ、微信里，请求授权使用麦克风的提示，经过长时间观察发现，他们的表现很随机、很奇特。可能每次在调用<code>getUserMedia</code>时候都会弹选择，也可能选择一次就不会再弹提示，也可能重启App后又会弹。如果用户拒绝了，可能第二天又会弹，或者永远都不弹了，要么重置(装)App。使用腾讯X5内核的App测试也是一样奇特表现，拒绝权限后可能必须要重置(装)。这个问题貌似跟X5内核自动升级的版本有关。</p> 
<blockquote> 
 <p>如果这个库有帮助到您，请 Star 一下。GitHub：<a href="https://github.com/xiangyuecn/Recorder">https://github.com/xiangyuecn/Recorder</a></p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fbe154c07d7a59a43e2e30d433e56e97/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SQLServer中各种存储过程创建及执行方式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4c8b29d08ebce222208894a201b23cf7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java中properties类中关于store(arg0,arg1)用法的讲解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>