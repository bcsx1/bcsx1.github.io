<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kong API网关使用笔记 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kong API网关使用笔记" />
<meta property="og:description" content="背景 Kong是基于OpenResty的开源网关，其将API相关信息配置到postgresql或者是cassandra。通过lua扩展模块，扩展网关平台的功能。
本文记录着笔者在对Kong网关的具体使用过程。包括Kong部署，Kong组件使用，Kong插件使用。其他Kong相关的内容，可以到官网上查阅。
关注微信公众号：战渣渣
回复关键字“kong”获取测试代码
Kong部署 Kong的部署方式有很多种，这里采取的是基于Docker的部署过程。
postgresql部署 Docker部署Postgresql9.6 创建网络 docker network create kong-net 启动数据库 docker run -d --name kong-database \ --network=kong-net \ -p 5432:5432 \ -e &#34;POSTGRES_USER=mykong&#34; \ -e &#34;POSTGRES_DB=mykong&#34; \ -e &#34;POSTGRES_PASSWORD=mykong&#34; \ postgres:9.6 数据库高可用性，可将数据库做双机热备。笔者没有实际需求，下面是收集的一些资料并未执行，待到以后有需求再做执行
流复制&#43;双机热备方案
配置postgresql的主从流复制
https://www.cnblogs.com/cxy486/p/5164612.html利用pgpool-II中间件实现高可用性
https://www.iteye.com/blog/iwin-2108807
https://www.xiaomastack.com/2019/08/16/postgresql%E9%9B%86%E7%BE%A4/利用keepalived&#43;pgpoll-II完成双机热备切换
https://www.cnblogs.com/songyuejie/p/4561089.html 部署kong 创建kong所需要数据库
创建数据库时指定的用户名，密码，数据库等，需要使用KONG_前缀的参数使用。
其他环境变量说明
docker run --rm \ --network=kong-net \ -e &#34;KONG_DATABASE=postgres&#34; \ -e &#34;KONG_PG_HOST=kong-database&#34; \ -e &#34;KONG_PG_USER=mykong&#34; \ -e &#34;KONG_PG_PASSWORD=mykong&#34; \ -e &#34;KONG_PG_DATABASE=mykong&#34; \ kong:2.0.1 kong migrations bootstrap 使用kong最新版本 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2613db94e60082a1f944f75863045e38/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-03T20:30:59+08:00" />
<meta property="article:modified_time" content="2020-03-03T20:30:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kong API网关使用笔记</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_2"></a>背景</h2> 
<p>Kong是基于OpenResty的开源网关，其将API相关信息配置到postgresql或者是cassandra。通过lua扩展模块，扩展网关平台的功能。</p> 
<p>本文记录着笔者在对Kong网关的具体使用过程。包括Kong部署，Kong组件使用，Kong插件使用。其他Kong相关的内容，可以到官网上查阅。</p> 
<blockquote> 
 <p>关注微信公众号：战渣渣<br> 回复关键字“kong”获取测试代码</p> 
</blockquote> 
<h2><a id="Kong_8"></a>Kong部署</h2> 
<p>Kong的部署方式有很多种，这里采取的是基于Docker的部署过程。</p> 
<h3><a id="postgresql_10"></a>postgresql部署</h3> 
<h4><a id="DockerPostgresql96_11"></a>Docker部署Postgresql9.6</h4> 
<ul><li>创建网络</li></ul> 
<pre><code class="prism language-shell">docker network create kong-net
</code></pre> 
<ul><li>启动数据库</li></ul> 
<pre><code class="prism language-shell">docker run -d --name kong-database \
               --network<span class="token operator">=</span>kong-net \
               -p 5432:5432 \
               -e <span class="token string">"POSTGRES_USER=mykong"</span> \
               -e <span class="token string">"POSTGRES_DB=mykong"</span> \
               -e <span class="token string">"POSTGRES_PASSWORD=mykong"</span> \
               postgres:9.6
</code></pre> 
<p><strong>数据库高可用性，可将数据库做双机热备。笔者没有实际需求，下面是收集的一些资料并未执行，待到以后有需求再做执行</strong></p> 
<p><strong>流复制+双机热备方案</strong></p> 
<ul><li>配置postgresql的主从流复制<br> https://www.cnblogs.com/cxy486/p/5164612.html</li><li>利用pgpool-II中间件实现高可用性<br> https://www.iteye.com/blog/iwin-2108807<br> https://www.xiaomastack.com/2019/08/16/postgresql%E9%9B%86%E7%BE%A4/</li><li>利用keepalived+pgpoll-II完成双机热备切换<br> https://www.cnblogs.com/songyuejie/p/4561089.html</li></ul> 
<h3><a id="kong_38"></a>部署kong</h3> 
<p>创建kong所需要数据库<br> 创建数据库时指定的用户名，密码，数据库等，需要使用KONG_前缀的参数使用。<br> <a href="https://docs.konghq.com/2.0.x/configuration/#prefix" rel="nofollow">其他环境变量说明</a></p> 
<pre><code class="prism language-shell">docker run --rm \
     --network<span class="token operator">=</span>kong-net \
     -e <span class="token string">"KONG_DATABASE=postgres"</span> \
     -e <span class="token string">"KONG_PG_HOST=kong-database"</span> \
     -e <span class="token string">"KONG_PG_USER=mykong"</span> \
     -e <span class="token string">"KONG_PG_PASSWORD=mykong"</span> \
     -e <span class="token string">"KONG_PG_DATABASE=mykong"</span> \
     kong:2.0.1 kong migrations bootstrap
</code></pre> 
<p><strong>使用kong最新版本 2.0.1</strong></p> 
<p>节点1：172.17.23.14</p> 
<pre><code class="prism language-shell">docker run -d --name kong  \
    --network<span class="token operator">=</span>kong-net \
    -e <span class="token string">"KONG_DATABASE=postgres"</span> \
    -e <span class="token string">"KONG_PG_HOST=kong-database"</span> \
    -e <span class="token string">"KONG_PG_USER=mykong"</span> \
    -e <span class="token string">"KONG_PG_PASSWORD=mykong"</span> \
    -e <span class="token string">"KONG_PG_DATABASE=mykong"</span> \
    -e <span class="token string">"KONG_ADMIN_LISTEN=0.0.0.0:8001"</span> \
    -e <span class="token string">"KONG_ADMIN_LISTEN_SSL=0.0.0.0:8444"</span> \
    -e <span class="token string">"KONG_PROXY_ACCESS_LOG=/usr/local/kong/logs/proxy_access.log"</span>     \
    -e <span class="token string">"KONG_ADMIN_ACCESS_LOG=/usr/local/kong/logs/admin_access.log"</span>     \
    -e <span class="token string">"KONG_PROXY_ERROR_LOG=/usr/local/kong/logs/proxy_error.log"</span>     \
    -e <span class="token string">"KONG_ADMIN_ERROR_LOG=/usr/local/kong/logs/admin_error.log"</span> \
    -e <span class="token string">"KONG_TRUSTED_IPS=0.0.0.0/0,::/0"</span>     \ <span class="token comment"># 使用IP-restriction插件时，保证真实IP地址的传递</span>
    -e <span class="token string">"KONG_REAL_IP_HEADER=X-Forwarded-For"</span> \ <span class="token comment"># 使用IP-restriction插件时，保证真实IP地址的传递</span>
    -p 8000:8000 \
    -p 8443:8443 \
    -p 8001:8001 \
    -p 8444:8444 \
    kong:2.0.1
</code></pre> 
<p>节点2：172.17.23.17</p> 
<pre><code class="prism language-shell">docker run -d --name kong  \
    -e <span class="token string">"KONG_DATABASE=postgres"</span> \
    -e <span class="token string">"KONG_PG_HOST=172.17.23.14"</span> \
    -e <span class="token string">"KONG_PG_USER=mykong"</span> \
    -e <span class="token string">"KONG_PG_PASSWORD=mykong"</span> \
    -e <span class="token string">"KONG_PG_DATABASE=mykong"</span> \
    -e <span class="token string">"KONG_ADMIN_LISTEN=0.0.0.0:8001"</span> \
    -e <span class="token string">"KONG_ADMIN_LISTEN_SSL=0.0.0.0:8444"</span> \
    -e <span class="token string">"KONG_PROXY_ACCESS_LOG=/usr/local/kong/logs/proxy_access.log"</span>     \
    -e <span class="token string">"KONG_ADMIN_ACCESS_LOG=/usr/local/kong/logs/admin_access.log"</span>     \
    -e <span class="token string">"KONG_PROXY_ERROR_LOG=/usr/local/kong/logs/proxy_error.log"</span>     \
    -e <span class="token string">"KONG_ADMIN_ERROR_LOG=/usr/local/kong/logs/admin_error.log"</span> \
    -e <span class="token string">"KONG_TRUSTED_IPS=0.0.0.0/0,::/0"</span>     \ <span class="token comment"># 使用IP-restriction插件时，保证真实IP地址的传递</span>
    -e <span class="token string">"KONG_REAL_IP_HEADER=X-Forwarded-For"</span> \ <span class="token comment"># 使用IP-restriction插件时，保证真实IP地址的传递</span>
    -p 8000:8000 \
    -p 8443:8443 \
    -p 8001:8001 \
    -p 8444:8444 \
    kong:2.0.1
</code></pre> 
<h3><a id="NGINX_102"></a>配置NGINX</h3> 
<p>Kong部署了集群后，使用NGINX做负载均衡，为提高可用性，防止进群中某台服务宕机，NGINX对服务启用健康检查。</p> 
<p>NGINX本身就具有被动检查，如下配置：</p> 
<pre><code class="prism language-shell">upstream kong_cluster<span class="token punctuation">{<!-- --></span>
    server 172.17.23.14:80  max_fails<span class="token operator">=</span>1 fail_timeout<span class="token operator">=</span>10s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{<!-- --></span>
    listen 80<span class="token punctuation">;</span>
    server_name example.com<span class="token punctuation">;</span> 
    location / <span class="token punctuation">{<!-- --></span>
      proxy_pass         http://kong_cluster<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>但是我这里使用的主动健康检查。</p> 
<p>主动健康检查需要安装三方插件，这里使用的是淘宝开发的第三方模块，upstream_check模块，需要重新编译NGINX。</p> 
<p>我的操作系统中本身已经有了nginx1.10。所以我要重新编译一下，将三方模块编译进去<br> <a href="https://www.cnblogs.com/linyouyi/p/11502282.html" rel="nofollow">参考资料</a></p> 
<ul><li>下载主动检查模块<br> <a href="https://github.com/yaoweibin/nginx_upstream_check_module">下载地址</a></li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># git clone http://github.com/yaoweibin/nginx_upstream_check_module</span>
</code></pre> 
<ul><li>重新下载NGINX1.16.1</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># 下载NGINX  1.16.1</span>
<span class="token function">wget</span> http://nginx.org/download/nginx-1.16.1.tar.gz
<span class="token comment">## 因为我的操作系统中本身已经安装了nginx，所以我要重新安装，查看原来安装的命令，并把扩展的check模块编译到nginx中</span>
<span class="token comment"># 查看原安装的命令</span>
nginx -V 
<span class="token comment"># ubuntu系统下，安装nginx依赖包</span>
<span class="token comment"># zlib依赖包</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> zlib1g-dev
<span class="token comment"># openssl依赖包</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openssl libssl-dev
<span class="token comment"># 安装pcre依赖包</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libpcre3 libpcre3-dev
<span class="token comment"># 安装 libxml2/libxslt</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libxslt1-dev
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libxml2-dev
<span class="token comment"># 安装GD依赖包</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libgd-dev
<span class="token comment"># 安装 GeoIP依赖包</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libgeoip-dev
<span class="token comment"># 重新安装下载的nginx1.16.1</span>
<span class="token function">tar</span> zxvf nginx-1.16.1.tar.gz
<span class="token function">cd</span> nginx-1.16.1
<span class="token comment"># 下载三方模块并打补丁  根据nginx版本选定补丁</span>
patch -p1 <span class="token operator">&lt;</span> /root/install/nginx_upstream_check_module/check_1.16.1+.patch
<span class="token comment"># 补丁打完之后，安装nginx</span>
./configure \
--with-cc-opt<span class="token operator">=</span><span class="token string">'-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2'</span> \
--with-ld-opt<span class="token operator">=</span><span class="token string">'-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now'</span> \
--prefix<span class="token operator">=</span>/usr/share/nginx \
--conf-path<span class="token operator">=</span>/etc/nginx/nginx.conf \
--http-log-path<span class="token operator">=</span>/var/log/nginx/access.log \
--error-log-path<span class="token operator">=</span>/var/log/nginx/error.log \
--lock-path<span class="token operator">=</span>/var/lock/nginx.lock \
--pid-path<span class="token operator">=</span>/run/nginx.pid \
--http-client-body-temp-path<span class="token operator">=</span>/var/lib/nginx/body \
--http-fastcgi-temp-path<span class="token operator">=</span>/var/lib/nginx/fastcgi \
--http-proxy-temp-path<span class="token operator">=</span>/var/lib/nginx/proxy \
--http-scgi-temp-path<span class="token operator">=</span>/var/lib/nginx/scgi \
--http-uwsgi-temp-path<span class="token operator">=</span>/var/lib/nginx/uwsgi \
--with-debug \
--with-pcre-jit \
--with-http_ssl_module \
--with-http_stub_status_module \
--with-http_realip_module \
--with-http_auth_request_module \
--with-http_addition_module \
--with-http_dav_module \
--with-http_geoip_module \
--with-http_gunzip_module \
--with-http_gzip_static_module \
--with-http_image_filter_module \
--with-http_v2_module \
--with-http_sub_module \
--with-http_xslt_module \
--with-stream \
--with-stream_ssl_module \
--with-mail \
--with-mail_ssl_module \
--with-threads \
--with-pcre \
--add-module<span class="token operator">=</span>/root/install/nginx_upstream_check_module
<span class="token comment"># 编译安装</span>
<span class="token function">make</span>
<span class="token comment"># 如果是已经安装过了，只需要make</span>
<span class="token comment"># 然后将生成nginx拷贝到原来的目录</span>
<span class="token function">cp</span> objs/nginx /usr/sbin/nginx
</code></pre> 
<h4><a id="nginx_202"></a>部署nginx</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 配置https</span>
upstream kong_cluster<span class="token punctuation">{<!-- --></span>
    <span class="token comment"># 最简单的轮询方式</span>
    server 172.17.23.17:8000<span class="token punctuation">;</span>
    server 172.17.23.14:8000<span class="token punctuation">;</span>
    
    <span class="token comment"># 配置三方模块主动检查健康状态，检查TCP，只要确保Kong服务没有断掉即可，实际的服务健康检查使用Kong插件检查</span>
    <span class="token comment"># 其他配置参考 http://tengine.taobao.org/document_cn/http_upstream_check_cn.html</span>
    check interval<span class="token operator">=</span>3000 rise<span class="token operator">=</span>2 fall<span class="token operator">=</span>3 timeout<span class="token operator">=</span>1000 type<span class="token operator">=</span>tcp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{<!-- --></span>
    listen 443 ssl<span class="token punctuation">;</span>
    server_name example.com<span class="token punctuation">;</span> <span class="token comment"># 更换自己的域名信息</span>

    ssl_certificate   cert/214533299050973.pem<span class="token punctuation">;</span>  <span class="token comment"># 更换成自己的证书信息</span>
    ssl_certificate_key  cert/214533299050973.key<span class="token punctuation">;</span> <span class="token comment"># 更换成自己的证书信息</span>
    ssl_session_timeout 5m<span class="token punctuation">;</span>
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:<span class="token operator">!</span>NULL:<span class="token operator">!</span>aNULL:<span class="token operator">!</span>MD5:<span class="token operator">!</span>ADH:<span class="token operator">!</span>RC4<span class="token punctuation">;</span>
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2<span class="token punctuation">;</span>
    ssl_prefer_server_ciphers on<span class="token punctuation">;</span>

    <span class="token comment"># https 因为安全原因，需要禁用 gzip</span>
    <span class="token comment"># 但是在一些场景下，不需要禁用</span>
    <span class="token comment"># gzip off;</span>
    <span class="token function">gzip</span> on<span class="token punctuation">;</span>
    <span class="token comment"># 设置允许压缩的页面最小字节数</span>
    gzip_min_length 1000<span class="token punctuation">;</span>
    gzip_buffers 4 16k<span class="token punctuation">;</span>
    gzip_http_version 1.1<span class="token punctuation">;</span>
    <span class="token comment"># 1~9，默认为1，数值越大，压缩率越高，CPU占用越多，时间越久</span>
    gzip_comp_level 3<span class="token punctuation">;</span>
    gzip_vary on<span class="token punctuation">;</span>
    <span class="token comment"># 禁用对 IE 6 使用 gzip 压缩</span>
    gzip_disable <span class="token string">"MSIE [1-6]\."</span><span class="token punctuation">;</span>
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/javascript <span class="token string">"application/javascript; charset=utf-8"</span> application/xml application/xml+rss application/json <span class="token string">"application/json; charset=utf-8"</span> font/ttf font/otf image/svg+xml<span class="token punctuation">;</span>

    <span class="token comment"># 设置最大允许的POST数据量，如果提交的文件超过这个值，会出现413错误</span>
    client_max_body_size 20m<span class="token punctuation">;</span>
    keepalive_timeout 15<span class="token punctuation">;</span>

    <span class="token comment"># 不显示 nginx 的版本号</span>
    server_tokens off<span class="token punctuation">;</span>

    <span class="token comment"># 设置请求头的长度大小</span>
    client_header_buffer_size 32k<span class="token punctuation">;</span>
    large_client_header_buffers 4 32k<span class="token punctuation">;</span>


    <span class="token comment">## Individual nginx logs</span>
    access_log  /var/log/nginx/kong_access.log<span class="token punctuation">;</span>
    error_log   /var/log/nginx/kong_error.log<span class="token punctuation">;</span>

    location ^~ /robots.txt <span class="token punctuation">{<!-- --></span>
        expires 30d<span class="token punctuation">;</span>
        <span class="token comment"># add_header Content-Type text/plain;</span>
        <span class="token keyword">return</span> 200 <span class="token string">"User-Agent:  *\nDisallow:  /"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    location ~ /<span class="token punctuation">(</span>\w+<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment"># websocket 支持</span>
        proxy_http_version 1.1<span class="token punctuation">;</span>
        proxy_set_header Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
        proxy_set_header Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>

        proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
        proxy_redirect off<span class="token punctuation">;</span>
        proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        proxy_set_header X-Scheme <span class="token variable">$scheme</span><span class="token punctuation">;</span>
        proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span> <span class="token comment"># 真实地址传递，IP限制插件使用</span>
        proxy_pass http://kong_cluster<span class="token punctuation">;</span>
        expires -1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># 主页返回 404</span>
    location <span class="token operator">=</span> / <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> 404<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{<!-- --></span>
   listen 80<span class="token punctuation">;</span>
   server_name  example.com<span class="token punctuation">;</span> <span class="token comment"># 更换自己的域名信息</span>
   <span class="token comment">#告诉浏览器有效期内只准用 https 访问</span>
   add_header Strict-Transport-Security max-age<span class="token operator">=</span>15768000<span class="token punctuation">;</span>
   <span class="token comment">#永久重定向到 https 站点</span>
   <span class="token keyword">return</span> 301 https://<span class="token variable">$server_name</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="NGINX_294"></a>重启NGINX</h4> 
<p>systemctl restart nginx</p> 
<h3><a id="APIKong_297"></a>将API配置到Kong</h3> 
<h4><a id="Kong_298"></a>Kong常用组件说明</h4> 
<ul><li>Service</li></ul> 
<pre><code>    Service是定义的服务，通过Kong转发后根据请求的协议，host，method，path匹配到实际的服务地址。
    
    Service可以与Route进行关联，一个Service可以有很多Route， Route匹配后就会转发到Service，
    处理过程中也会通过Plugin的处理，增加或者减少一些相应的Header或者其他信息
    
    Service可以是一个实际的地址，也可以是Kong内部提供的Upstream组件关联，由Upstream将请求转发到实际的服务。
</code></pre> 
<ul><li>Route：</li></ul> 
<pre><code>    Route就是路由，实际就是我们通过定义一些规则来匹配客户端的请求，每个路由都会关联一个Service,
    并且Service可以关联多个Route，当匹配到客户端的请求时，每个请求都会被代理到其配置的Service中
    
    Route作为客户端的入口，通过将Route和Service的松耦合，可以通过hosts path等规则的配置，最终让请求转发到不同的Service。
    
    例如，我们规定api.example.com 和 api.service.com的登录请求都能够代理到123.11.11.11:8000端口上，那我们可以通过hosts和path来路由
    
    首先，创建一个Service s1，其相应的host和port以及协议为http://123.11.11.11:8000
    然后，创建一个Route，关联的Service为s1，其hosts为[api.service.com, api.example.com],path为login
    最后，将域名api.example.com和api.service.com的请求转到到我们的Kong集群上，也就是我们上面一节中通过Nginx配置的请求地址
    那么，当我们请求api.example.com/login和api.service.com/login时，其通过Route匹配，然后转发到Service，最终将会请求我们自己的服务。
 
</code></pre> 
<ul><li>Upstream</li></ul> 
<pre><code>    这是指您自己的API /服务位于Kong后面，客户端请求被转发到该服务器。
    
    相当于Kong提供了一个负载的功能，基于Nginx的虚拟主机的方式做的负载功能
    
    当我们部署集群时，一个单独的地址不足以满足我们的时候，我们可以使用Kong的upstream来进行设置
    
    首先在service中指定host的时候，可以指定为我们的upstream定义的hostname
    
    我们在创建upstream时指定名字，然后指定solts(暂时不确定具体作用)，upstream可以进行健康检查等系列操作。这里先不开启（还没有研究）
    
    然后我们可以再创建target类型，将target绑定到upstream上，那么基本上我们部署集群时，也可以使用
</code></pre> 
<ul><li>Target</li></ul> 
<pre><code>    target 就是在upstream进行负载均衡的终端，当我们部署集群时，需要将每个节点作为一个target，并设置负载的权重，当然也可以通过upstream的设置对target进行健康检查。
    当我们使用upstream时，整个路线是 Route &gt;&gt; Service &gt;&gt; Upstream &gt;&gt; Target 
</code></pre> 
<ul><li>Consumer</li></ul> 
<pre><code>    Consumer 可以代表一个服务，可以代表一个用户，也可以代表消费者，可以根据我们自己的需求来定义
    
    可以将一个Consumer对应到实际应用中的一个用户，也可以只是作为一个Service的请求消费者
    
    Consumer具体可以在Plugin使用时再做深入了解
</code></pre> 
<ul><li>Plugin</li></ul> 
<pre><code>    在请求被代理到上游API之前或之后执行Kong内的动作的插件。
    
    例如，请求之前的Authentication或者是请求限流插件的使用
    
    Plugin可以和Service绑定，也可以和Route以及Consumer进行关联，也可以是全局的插件。

    常用的限流插件，IP限制插件等。
    
</code></pre> 
<h4><a id="Kong_369"></a>Kong使用</h4> 
<p>主要使用4个组件Service，Route，Upstream和Target</p> 
<p>Target配置的就是服务节点，不过要将其关联到到Upstream。</p> 
<p>Upstream可以对Target做负载均衡和健康检查等，通过设置name于Service关联，Service匹配到请求时转发到相应的Upstream。</p> 
<p>Service根据业务设置不同的服务，Service和Route绑定获取实际请求，通过protocol,host,port和path匹配请求，并将匹配到的请求转发到Upstream。</p> 
<p>Route是Kong中实际的入口点。主要根据protocols，hosts，methods，paths设置，匹配请求，将请求转发到相应的服务上</p> 
<p>我们按照这个顺序，依次创建Service，Route，Upstream和Target</p> 
<h5><a id="Service_382"></a>配置Service</h5> 
<p>Service还有一些其他参数，可根据具体需求定制。<a href="https://docs.konghq.com/2.0.x/admin-api/#add-service" rel="nofollow">官网资料</a></p> 
<ul><li>添加命令</li></ul> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -i -X POST \
    --url http://localhost:8001/services/ \
    --data <span class="token string">'name=example-service'</span> \
    --data <span class="token string">'protocol=http'</span> \
    --data <span class="token string">'host=api.example.service'</span>
    
<span class="token comment"># host属性在创建Upstream时使用</span>
</code></pre> 
<ul><li>添加结果</li></ul> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token string">"api.example.service"</span><span class="token punctuation">,</span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1582626079</span><span class="token punctuation">,</span>
    <span class="token string">"connect_timeout"</span><span class="token punctuation">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"71b28160-15fc-4215-a68f-d0b607e9cb9f"</span><span class="token punctuation">,</span>
    <span class="token string">"protocol"</span><span class="token punctuation">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"example-service"</span><span class="token punctuation">,</span>
    <span class="token string">"read_timeout"</span><span class="token punctuation">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token string">"port"</span><span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
    <span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token number">1582626079</span><span class="token punctuation">,</span>
    <span class="token string">"retries"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string">"write_timeout"</span><span class="token punctuation">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"client_certificate"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>修改命令</li></ul> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -i -X PATCH \
    --url http://localhost:8001/services/71b28160-15fc-4215-a68f-d0b607e9cb9f/ \
    --data <span class="token string">'name=test-kong'</span> \
    --data <span class="token string">'protocol=http'</span>  \
    --data <span class="token string">'host=test.kong.service'</span>
</code></pre> 
<ul><li>修改结果</li></ul> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token string">"test.kong.service"</span><span class="token punctuation">,</span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1582626079</span><span class="token punctuation">,</span>
    <span class="token string">"connect_timeout"</span><span class="token punctuation">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"71b28160-15fc-4215-a68f-d0b607e9cb9f"</span><span class="token punctuation">,</span>
    <span class="token string">"protocol"</span><span class="token punctuation">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"test-kong"</span><span class="token punctuation">,</span>
    <span class="token string">"read_timeout"</span><span class="token punctuation">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token string">"port"</span><span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
    <span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token number">1582626120</span><span class="token punctuation">,</span>
    <span class="token string">"retries"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string">"write_timeout"</span><span class="token punctuation">:</span> <span class="token number">60000</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"client_certificate"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Route_444"></a>配置Route</h5> 
<p>Route还有一些其他参数，可根据具体需求定制。<a href="https://getkong.org/docs/2.0.x/admin-api/#add-route" rel="nofollow">官网资料</a></p> 
<ul><li>添加命令</li></ul> 
<p><strong>实际使用时，将hosts变更为实际的域名</strong></p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -i -X POST \
    --url http://localhost:8001/routes/ \
    --data <span class="token string">'protocols[]=http'</span> \
    --data <span class="token string">'protocols[]=https'</span> \
    --data <span class="token string">'methods[]=GET'</span> \
    --data <span class="token string">'methods[]=POST'</span> \
    --data <span class="token string">'methods[]=DELETE'</span> \
    --data <span class="token string">'methods[]=PUT'</span> \
    --data <span class="token string">'hosts[]=api.example.com'</span> \
    --data <span class="token string">'paths[]=/v1/test_kong'</span> \
    --data <span class="token string">'strip_path=false'</span> \ <span class="token comment"># 此属性代表是否清除原有的path，默认是清除，如果不需要清除需要再添加的时候指定为false</span>
    --data <span class="token string">'service.id=71b28160-15fc-4215-a68f-d0b607e9cb9f'</span>
</code></pre> 
<ul><li>添加结果</li></ul> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"c156de0e-4b08-43a3-bc2d-3f0cf5d5d00a"</span><span class="token punctuation">,</span>
    <span class="token string">"path_handling"</span><span class="token punctuation">:</span> <span class="token string">"v0"</span><span class="token punctuation">,</span>
    <span class="token string">"paths"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\/v1\/test_kong"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"destinations"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"headers"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"protocols"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"methods"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"snis"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"service"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"71b28160-15fc-4215-a68f-d0b607e9cb9f"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"strip_path"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string">"preserve_host"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string">"regex_priority"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> <span class="token number">1582627872</span><span class="token punctuation">,</span>
    <span class="token string">"sources"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"hosts"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"api.example.com"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"https_redirect_status_code"</span><span class="token punctuation">:</span> <span class="token number">426</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1582627872</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Upstream_493"></a>配置Upstream</h5> 
<ul><li>添加命令</li></ul> 
<p><strong>这里只配置主动检查</strong></p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -i -X POST \
    --url http://localhost:8001/upstreams/ \
    --data <span class="token string">'name=test.kong.service'</span>  \
    --data <span class="token string">'algorithm=round-robin'</span> \
    --data <span class="token string">'healthchecks.active.type=http'</span> \
    --data <span class="token string">'healthchecks.active.http_path=/'</span> \
    --data <span class="token string">'healthchecks.active.timeout=2'</span> \
    --data <span class="token string">'healthchecks.active.healthy.successes=3'</span> \
    --data <span class="token string">'healthchecks.active.healthy.interval=10'</span> \
    --data <span class="token string">'healthchecks.active.unhealthy.interval=10'</span> \
    --data <span class="token string">'healthchecks.active.unhealthy.http_failures=3'</span>
</code></pre> 
<ul><li>添加结果</li></ul> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1582626649</span><span class="token punctuation">,</span>
    <span class="token string">"hash_on"</span><span class="token punctuation">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"1d3638c6-d5a0-4bb5-907b-015c8daf7861"</span><span class="token punctuation">,</span>
    <span class="token string">"algorithm"</span><span class="token punctuation">:</span> <span class="token string">"round-robin"</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"test.kong.service"</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"hash_fallback_header"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"hash_fallback"</span><span class="token punctuation">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>
    <span class="token string">"hash_on_cookie"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"host_header"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"hash_on_cookie_path"</span><span class="token punctuation">:</span> <span class="token string">"\/"</span><span class="token punctuation">,</span>
    <span class="token string">"healthchecks"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"threshold"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">"active"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"unhealthy"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"http_statuses"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">429</span><span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">501</span><span class="token punctuation">,</span> <span class="token number">502</span><span class="token punctuation">,</span> <span class="token number">503</span><span class="token punctuation">,</span> <span class="token number">504</span><span class="token punctuation">,</span> <span class="token number">505</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"tcp_failures"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"timeouts"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"http_failures"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string">"interval"</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>
            <span class="token string">"http_path"</span><span class="token punctuation">:</span> <span class="token string">"\/"</span><span class="token punctuation">,</span>
            <span class="token string">"timeout"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token string">"healthy"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"successes"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string">"interval"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
                <span class="token string">"http_statuses"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"https_sni"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token string">"https_verify_certificate"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">"concurrency"</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"passive"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"unhealthy"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"http_failures"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"http_statuses"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">429</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">503</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"tcp_failures"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">"timeouts"</span><span class="token punctuation">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"healthy"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"http_statuses"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">,</span> <span class="token number">203</span><span class="token punctuation">,</span> <span class="token number">204</span><span class="token punctuation">,</span> <span class="token number">205</span><span class="token punctuation">,</span> <span class="token number">206</span><span class="token punctuation">,</span> <span class="token number">207</span><span class="token punctuation">,</span> <span class="token number">208</span><span class="token punctuation">,</span> <span class="token number">226</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">301</span><span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">,</span> <span class="token number">303</span><span class="token punctuation">,</span> <span class="token number">304</span><span class="token punctuation">,</span> <span class="token number">305</span><span class="token punctuation">,</span> <span class="token number">306</span><span class="token punctuation">,</span> <span class="token number">307</span><span class="token punctuation">,</span> <span class="token number">308</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"successes"</span><span class="token punctuation">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"http"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"hash_on_header"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"slots"</span><span class="token punctuation">:</span> <span class="token number">10000</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="target_568"></a>配置target</h5> 
<ul><li>添加命令</li></ul> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -i -X POST \
--url http://localhost:8001/upstreams/1d3638c6-d5a0-4bb5-907b-015c8daf7861/targets \
--data <span class="token string">'target=172.17.23.14:38001'</span>
    
<span class="token function">curl</span> -i -X POST \
    --url http://localhost:8001/upstreams/1d3638c6-d5a0-4bb5-907b-015c8daf7861/targets \
    --data <span class="token string">'target=172.17.23.14:38002'</span>

</code></pre> 
<ul><li>添加结果</li></ul> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1582627463.954</span><span class="token punctuation">,</span>
    <span class="token string">"upstream"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"1d3638c6-d5a0-4bb5-907b-015c8daf7861"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"66c83e7d-f006-43da-990b-d493a966fc66"</span><span class="token punctuation">,</span>
    <span class="token string">"target"</span><span class="token punctuation">:</span> <span class="token string">"172.17.23.14:38001"</span><span class="token punctuation">,</span>
    <span class="token string">"weight"</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1582627517.872</span><span class="token punctuation">,</span>
    <span class="token string">"upstream"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"1d3638c6-d5a0-4bb5-907b-015c8daf7861"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"d9940f44-30ad-437a-aaab-836dfaf27b93"</span><span class="token punctuation">,</span>
    <span class="token string">"target"</span><span class="token punctuation">:</span> <span class="token string">"172.17.23.14:38002"</span><span class="token punctuation">,</span>
    <span class="token string">"weight"</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="kong_606"></a>检查配置kong是否可行</h6> 
<ul><li>检查配置的请求</li></ul> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -X GET https://example.com/v1/test_kong

<span class="token punctuation">{<!-- --></span><span class="token string">"code"</span><span class="token keyword">:</span> 200, <span class="token string">"message"</span><span class="token keyword">:</span> <span class="token string">"test kong get success"</span><span class="token punctuation">}</span>

<span class="token function">curl</span> -X POST https://example.com/v1/test_kong

<span class="token punctuation">{<!-- --></span><span class="token string">"code"</span><span class="token keyword">:</span> 200, <span class="token string">"message"</span><span class="token keyword">:</span> <span class="token string">"test post get success"</span><span class="token punctuation">}</span>

<span class="token function">curl</span> -X DELETE https://example.com/v1/test_kong

<span class="token punctuation">{<!-- --></span><span class="token string">"code"</span><span class="token keyword">:</span> 200, <span class="token string">"message"</span><span class="token keyword">:</span> <span class="token string">"test kong delete success"</span><span class="token punctuation">}</span>

<span class="token function">curl</span> -X PUT https://example.com/v1/test_kong

<span class="token punctuation">{<!-- --></span><span class="token string">"code"</span><span class="token keyword">:</span> 200, <span class="token string">"message"</span><span class="token keyword">:</span> <span class="token string">"test kong put success"</span><span class="token punctuation">}</span>

</code></pre> 
<ul><li>检查配置的健康检查</li></ul> 
<p>看到服务配置的东西一直在被检查</p> 
<pre><code>[I 200225 19:03:10 web:2246] 200 GET / (172.17.23.14) 0.88ms
[I 200225 19:03:20 web:2246] 200 GET / (172.17.23.17) 1.34ms
[I 200225 19:03:20 web:2246] 200 GET / (172.17.23.14) 0.67ms
[I 200225 19:03:30 web:2246] 200 GET / (172.17.23.14) 0.88ms
[I 200225 19:03:30 web:2246] 200 GET / (172.17.23.17) 1.02ms
[I 200225 19:03:40 web:2246] 200 GET / (172.17.23.14) 0.88ms
[I 200225 19:03:40 web:2246] 200 GET / (172.17.23.17) 1.15ms
</code></pre> 
<h5><a id="Kong_639"></a>Kong插件使用</h5> 
<p>插件的作用范围，从小到大可以是 Route，Service，Consumer，Global。</p> 
<p>可以根据需求使用一些插件，比如做一些限流操作，IP白名单和IP黑名单等</p> 
<p>下面是Kong官方就提供的开源版可用的插件</p> 
<h6><a id="Rate_Limiting___646"></a>Rate Limiting 限流插件</h6> 
<p>限流插件，限制在指定时间内可以访问的次数，可以是几秒内，几分钟内，几小时，几天等。<br> 插件可以设置在Service，Route或者全局，如果启用Consumer，则根据Consumer来计算限制时间，否则根据客户端IP地址</p> 
<p>给定service添加插件</p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -X POST http://localhost:8001/services/71b28160-15fc-4215-a68f-d0b607e9cb9f/plugins \
    --data <span class="token string">"name=rate-limiting"</span>  \
    --data <span class="token string">"config.second=2"</span> \
    --data <span class="token string">"config.hour=10000"</span> \
    --data <span class="token string">"config.policy=local"</span> \
    --data <span class="token string">"config.limit_by=ip"</span>
</code></pre> 
<p>添加结果</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1582637075</span><span class="token punctuation">,</span>
    <span class="token string">"config"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"minute"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string">"policy"</span><span class="token punctuation">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>
        <span class="token string">"month"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string">"redis_timeout"</span><span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
        <span class="token string">"limit_by"</span><span class="token punctuation">:</span> <span class="token string">"consumer"</span><span class="token punctuation">,</span>
        <span class="token string">"hide_client_headers"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">"second"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string">"day"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string">"redis_password"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string">"year"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string">"redis_database"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">"hour"</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
        <span class="token string">"redis_port"</span><span class="token punctuation">:</span> <span class="token number">6379</span><span class="token punctuation">,</span>
        <span class="token string">"redis_host"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string">"fault_tolerant"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"9f8d08c9-4bdf-4912-b4dd-f96b32e38019"</span><span class="token punctuation">,</span>
    <span class="token string">"service"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"71b28160-15fc-4215-a68f-d0b607e9cb9f"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">"protocols"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"grpc"</span><span class="token punctuation">,</span> <span class="token string">"grpcs"</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"rate-limiting"</span><span class="token punctuation">,</span>
    <span class="token string">"consumer"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"route"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试效果</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">test_rate_limiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">"https://example.com/v1/test_kong"</span>
    <span class="token keyword">def</span> <span class="token function">_request</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request {} start by : {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request {} result &gt;&gt;&gt;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
        resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request {} status_code {} "</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request {} json {} "</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request {} result &lt;&lt;&lt;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"request {} end by : {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>_request<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>执行结果</p> 
<pre><code class="prism language-shell">request 3 status_code 200
request 3 json <span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token keyword">:</span> <span class="token string">'test kong get success'</span>, <span class="token string">'code'</span><span class="token keyword">:</span> 200<span class="token punctuation">}</span>
request 3 result <span class="token operator">&lt;&lt;&lt;</span>
request 3 end by <span class="token keyword">:</span> 2020-02-25 21:45:18.566325
request 6 status_code 429
request 6 json <span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token keyword">:</span> <span class="token string">'API rate limit exceeded'</span><span class="token punctuation">}</span>
request 5 status_code 429
</code></pre> 
<h6><a id="IP_Restriction_724"></a>IP Restriction</h6> 
<p>IP Restriction就是通过设置IP白名单和黑名单，根据客户端IP来对一些请求进行拦截和防护，通过插件的源码可以看到其工作原理是，通过NGINX的变量binary_remote_addr以及设置的黑名单和白名单来进行限制，先看黑名单再看白名单，就是说白名单优先级更高一些，如果同时设置一个IP即在黑名单又在白名单列表，那么这个IP是可以进行访问。</p> 
<p>IP Restriction插件可以作用于Service, Route, Consumer, 也可以作用于全局。<br> 我们现在将其作用于Service上</p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -X POST http://localhost:8001/services/71b28160-15fc-4215-a68f-d0b607e9cb9f/plugins \
--data <span class="token string">"name=ip-restriction"</span> \
--data <span class="token string">"config.whitelist=172.17.23.14"</span> \
--data <span class="token string">"config.whitelist=172.17.23.17"</span>
</code></pre> 
<p>添加结果</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1582980903</span><span class="token punctuation">,</span>
    <span class="token string">"config"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"whitelist"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"172.17.23.14"</span><span class="token punctuation">,</span> <span class="token string">"172.17.23.17"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"blacklist"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"c0364fe4-2d43-451e-9330-b45964cf1483"</span><span class="token punctuation">,</span>
    <span class="token string">"service"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"71b28160-15fc-4215-a68f-d0b607e9cb9f"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">"protocols"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"grpc"</span><span class="token punctuation">,</span> <span class="token string">"grpcs"</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"ip-restriction"</span><span class="token punctuation">,</span>
    <span class="token string">"consumer"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"route"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试结果</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"Your IP address is not allowed"</span><span class="token punctuation">}</span>
</code></pre> 
<h6><a id="Zipkin_761"></a>Zipkin</h6> 
<p>Zipkin是分布式跟踪系统，我们使用者插件的目的是来监控我们的API耗时情况，尤其是可以根据这些结果来跟踪相应的性能消耗。</p> 
<p>所以我们先部署Zipkin服务，直接使用Docker安装。</p> 
<p>zipkin具体信息，查看<a href="https://zipkin.io/" rel="nofollow">官网</a></p> 
<h6><a id="Zipkin_767"></a>部署Zipkin</h6> 
<pre><code class="prism language-shell">docker run -d -p 9411:9411 openzipkin/zipkin
</code></pre> 
<h6><a id="_772"></a>添加插件</h6> 
<p>zipkin插件可以作用于Service, Route, Consumer, 也可以作用于全局。<br> 我们现在将其作用于Service上</p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -X POST http://localhost:8001/services/71b28160-15fc-4215-a68f-d0b607e9cb9f/plugins \
    --data <span class="token string">"name=zipkin"</span>  \
    --data <span class="token string">"config.http_endpoint=http://172.17.23.14:9411/api/v2/spans"</span> \
    --data <span class="token string">"config.sample_ratio=1"</span> \   <span class="token comment"># 全部采样</span>
    --data <span class="token string">"config.include_credential=true"</span>
</code></pre> 
<p>添加结果</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1582812902</span><span class="token punctuation">,</span>
    <span class="token string">"config"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"sample_ratio"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"http_endpoint"</span><span class="token punctuation">:</span> <span class="token string">"http:\/\/172.17.23.14:9411\/api\/v2\/spans"</span><span class="token punctuation">,</span>
        <span class="token string">"include_credential"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">"default_service_name"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"c58654d8-2fd5-43b6-854f-0fd65a353f7e"</span><span class="token punctuation">,</span>
    <span class="token string">"service"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"71b28160-15fc-4215-a68f-d0b607e9cb9f"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">"protocols"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"grpc"</span><span class="token punctuation">,</span> <span class="token string">"grpcs"</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"zipkin"</span><span class="token punctuation">,</span>
    <span class="token string">"consumer"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"route"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>http_endpoint：zipkin的服务地址</p> 
<p>sample_ratio：采集的频率 设置为1时全部采集，设置为0时，全部不采集， 设置为0-1之间的小数，则会采<br> 用算法按照设定的参数随机采集</p> 
<p>测试插件使用效果：<br> 访问配置的地址之后，前面设置的采集频率是1，表示全部采集，访问之后登陆zipkin的地址http://172.17.23.14:9411/zipkin<br> <img src="https://images2.imgbox.com/d3/3c/JB2B3bWQ_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="HMAC_Authentication_815"></a>HMAC Authentication</h6> 
<p>HMAC签名身份验证，Kong网关签名验证通过后，才可以向后请求，实际应用场景听多，具体流程如下：</p> 
<ol><li>创建消费者Consumer</li><li>给消费Consumer创建插件HMAC对应的username和secret，客户端使用其签名</li><li>在Service或者Route中启用HMAC插件</li><li>客户端在请求时，根据前面返回的username和secret签名，Kong网关匹配后进行签名验证</li></ol> 
<ul><li>创建消费者</li></ul> 
<p>创建命令</p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -i http://localhost:8001/consumers/ -d <span class="token string">"username=test_hmac&amp;custom_id=test_hmac_id"</span>
</code></pre> 
<p>创建结果</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"custom_id"</span><span class="token punctuation">:</span> <span class="token string">"test_hmac_id"</span><span class="token punctuation">,</span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1583071044</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"c9a4ad0e-174f-4a7f-81b0-ce9e3261c177"</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"test_hmac"</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>创建消费者相应HMAC插件信息</li></ul> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -X POST http://localhost:8001/consumers/test_hmac/hmac-auth \
--data <span class="token string">"username=test_hmac"</span> \
--data <span class="token string">"secret=test_hmac_secret123"</span>
</code></pre> 
<p><strong>username:在HMAC签名验证中使用的用户名。</strong><br> <strong>secret: 在HMAC签名验证中使用的秘钥。</strong></p> 
<p>创建结果</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1583071212</span><span class="token punctuation">,</span>
    <span class="token string">"consumer"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"c9a4ad0e-174f-4a7f-81b0-ce9e3261c177"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"834a8f69-c63d-4183-8a50-b52ab6a6187e"</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"secret"</span><span class="token punctuation">:</span> <span class="token string">"test_hmac_secret123"</span><span class="token punctuation">,</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"test_hmac"</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>启用HMAC插件</li></ul> 
<p><em>先把之前的Service上的IP Restriction插件去掉。否则我本地和服务器上的测试会提示无法处理</em></p> 
<p>根据之前创建插件产生的ID，直接删除即可。</p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -i -X DELETE http://localhost:8001/plugins/c0364fe4-2d43-451e-9330-b45964cf1483
</code></pre> 
<p>把插件添加到指定的Route或者Service都可以，这次把这个插件加到Route上，也来测试一遍</p> 
<p>添加命令</p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -i -X POST http://localhost:8001/routes/c156de0e-4b08-43a3-bc2d-3f0cf5d5d00a/plugins \
      -d <span class="token string">"name=hmac-auth"</span> \
      -d <span class="token string">"config.enforce_headers=date"</span> \
      -d <span class="token string">"config.algorithms=hmac-sha1"</span> \
      -d <span class="token string">"config.algorithms=hmac-sha256"</span> \
      -d <span class="token string">"config.validate_request_body=true"</span>
</code></pre> 
<pre><code>enforce_headers： Header中必须要有的参数，后续用于签名验证

algorithms：用户想要支持的HMAC摘要算法列表。允许的值是hmac-sha1，hmac-sha256，
hmac-sha384，和hmac-sha512客户端请求时，从中选择一个即可

validate_request_body：启用验证请求体，设置为true之后，客户端请求头中若是有Digest，
Kong则会使用HMAC算法验证请求体body。
</code></pre> 
<p>添加结果</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"created_at"</span><span class="token punctuation">:</span> <span class="token number">1583072768</span><span class="token punctuation">,</span>
    <span class="token string">"config"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"clock_skew"</span><span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
        <span class="token string">"validate_request_body"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">"enforce_headers"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"date"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"algorithms"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"hmac-sha1"</span><span class="token punctuation">,</span> <span class="token string">"hmac-sha256"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"anonymous"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string">"hide_credentials"</span><span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"39188d02-5425-4f76-8795-5e028f793476"</span><span class="token punctuation">,</span>
    <span class="token string">"service"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">"protocols"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"grpc"</span><span class="token punctuation">,</span> <span class="token string">"grpcs"</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"hmac-auth"</span><span class="token punctuation">,</span>
    <span class="token string">"consumer"</span><span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"route"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"c156de0e-4b08-43a3-bc2d-3f0cf5d5d00a"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>客户端请求测试</li></ul> 
<pre><code>重要请求头信息
1. Authorization 或者 Proxy-Authorization
    这个头的组成是
    credentials 签名算法  使用HMAC插件，固定值就是hmac
    params 具体的参数，参数用","分割。
        algorithm: 签名算法 
        headers: 签名计算包括的key 
        signature: 生成的签名，生成规则 
2. Digest：启用validate_request_body，需要生成
3. Date：必须是GMT时间格式
</code></pre> 
<p>Python测试函数</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">test_hmac_authentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建消费者对应HMAC插件时的用户名和秘钥</span>
    hmac_username <span class="token operator">=</span> <span class="token string">"test_hmac"</span>
    hmac_secret <span class="token operator">=</span> <span class="token string">"test_hmac_secret123"</span>

    url <span class="token operator">=</span> <span class="token string">"https://example.com/v1/test_kong"</span>

    <span class="token comment"># 请求头</span>
    <span class="token comment"># 注意，请求头的时间格式必须是GMT时间格式</span>
    request_headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        <span class="token string">"Digest"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        <span class="token string">"Date"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%a, %d %b %Y %H:%M:%S GMT"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># 请求体</span>
    request_body <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"test"</span><span class="token punctuation">:</span> <span class="token string">"hmac"</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># 生成Digest</span>
    <span class="token comment">#  body="A small body"</span>
    <span class="token comment">#  digest=SHA-256(body)</span>
    <span class="token comment">#  base64_digest=base64(digest)</span>
    <span class="token comment">#  Digest: SHA-256=&lt;base64_digest&gt;</span>
    base64_digest <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>request_body<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    request_headers<span class="token punctuation">[</span><span class="token string">'Digest'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SHA-256={}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>base64_digest<span class="token punctuation">)</span>

    <span class="token comment"># 生成签名</span>
    <span class="token comment"># signing_string = "date: Thu, 22 Jun 2017 17:15:21 GMT\nGET /requests HTTP/1.1"</span>
    <span class="token comment"># digest = HMAC - SHA256( &lt; signing_string &gt;, "secret")</span>
    <span class="token comment"># base64_digest = base64( &lt; digest &gt;)</span>
    <span class="token comment"># 签名字符串构造</span>
    <span class="token comment"># 如果参数不是request-line，则名字用小写，然后跟":"和一个空格" "，</span>
    <span class="token comment"># 如果参数是request-line，则追加http请求行【GET /requests HTTP/1.1】</span>
    <span class="token comment"># 中间用换行符"\n"将所有的参数连接起来。</span>

    <span class="token comment"># 按照上述规则拼接字符串</span>
    sign_string <span class="token operator">=</span> <span class="token string">"date: {}\ndigest: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>request_headers<span class="token punctuation">[</span><span class="token string">'Date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> request_headers<span class="token punctuation">[</span><span class="token string">'Digest'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 开始签名</span>
    sign_digest <span class="token operator">=</span> hmac<span class="token punctuation">.</span>new<span class="token punctuation">(</span>hmac_secret<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sign_string<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> digestmod<span class="token operator">=</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sign_base64_digest <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>sign_digest<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

    <span class="token comment"># 构建Authorization参数 具体信息 https://docs.konghq.com/hub/kong-inc/hmac-auth/#signature-authentication-scheme</span>
    authorization <span class="token operator">=</span> <span class="token string">'hmac username="{}", algorithm="hmac-sha256", headers="date digest", signature="{}"'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
        hmac_username<span class="token punctuation">,</span> sign_base64_digest<span class="token punctuation">)</span>

    request_headers<span class="token punctuation">[</span><span class="token string">'Authorization'</span><span class="token punctuation">]</span> <span class="token operator">=</span> authorization
    resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>request_headers<span class="token punctuation">,</span> json<span class="token operator">=</span>request_body<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>request_headers<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>测试结果</p> 
<pre><code class="prism language-json"># 失败
<span class="token number">401</span>
<span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'HMAC signature cannot be verified'</span><span class="token punctuation">}</span>

# 成功
<span class="token number">200</span>
<span class="token punctuation">{<!-- --></span><span class="token string">'code'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'test kong post success'</span><span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d3e2f5ce14ebc8708a1e1c6a8f8fc2c7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信小程序未授权的用户获取openId</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/396dd4e10c5c879a213d3a6df13b9f27/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">通过binlog恢复误delete的数据(一)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>