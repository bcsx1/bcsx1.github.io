<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>æµ…è°ˆC&#43;&#43;20 åç¨‹é‚£ç‚¹äº‹å„¿ - ç¼–ç¨‹éšæƒ³</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="æµ…è°ˆC&#43;&#43;20 åç¨‹é‚£ç‚¹äº‹å„¿" />
<meta property="og:description" content="æœ¬æ–‡æ˜¯Â C&#43;&#43;20 çš„åç¨‹å…¥é—¨æ–‡ç« ï¼Œä½œè€…å›´ç»•åç¨‹çš„æ¦‚å¿µåˆ°åç¨‹çš„å®ç°æ€è·¯å…¨æ–¹ä½è¿›è¡Œè®²è§£ï¼ŒåŠªåŠ›è®©æœ¬æ–‡æˆä¸ºå…¨ç½‘æœ€å¥½ç†è§£çš„ã€ŒC&#43;&#43;20 åç¨‹ã€åŸç†è§£ææ–‡ç« ã€‚
åç¨‹æ¦‚å¿µ æµ…è°ˆC&#43;&#43;20 åç¨‹é‚£ç‚¹äº‹å„¿ å…ˆä»‹ç»ä¸€ç‚¹åç¨‹çš„æ¦‚å¿µï¼Œå¦‚æœä½ å·²ç»ç†è§£å’ŒæŒæ¡äº†ç›¸å…³çš„èƒŒæ™¯çŸ¥è¯†å°±å¯ä»¥è·³è¿‡è¿™ä¸ªç« èŠ‚ï¼ˆæˆ–è€…å¿«é€Ÿæµè§ˆä¸‹ï¼Œä¹Ÿè®¸æˆ‘ä»¬æœ‰äº›è§‚å¿µä¸ä¸€è‡´å¯ä»¥è®¨è®ºï¼‰ã€‚è¿™é‡Œæˆ‘æƒ³ç¨å¾®èŠçš„æ·±å…¥ä¸€ç‚¹ï¼Œè¿™æ¶‰åŠåˆ°å…¥é—¨åé‡åˆ°å¤æ‚çš„åç¨‹é—®é¢˜æ—¶èƒ½ä¸èƒ½æ­£ç¡®çš„ç†è§£å¹¶è§£å†³é—®é¢˜ã€‚
åç¨‹ï¼ˆCoroutinesï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸ºå¾®çº¿ç¨‹ï¼Œçº¤ç¨‹ã€‚ä¸€èˆ¬æŒ‡ä¸€ä¸ªå¯ä»¥è¢«æš‚åœå’Œæ¢å¤æ‰§è¡Œçš„é€»è¾‘ä½“ã€‚
ä¸€ä¸ªæ™®é€šçš„å‡½æ•°æœ‰ 2 ä¸ªå¸¸è§„çš„æ“ä½œå’Œè¡Œä¸ºï¼šè°ƒç”¨ï¼ˆCallï¼‰å’Œè¿”å›ï¼ˆReturnï¼‰ã€‚å½“è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œä¼šæš‚åœå½“å‰çš„æ‰§è¡Œï¼Œè·³è½¬åˆ°è¿™ä¸ªå‡½æ•°çš„èµ·å§‹ä½ç½®å»æ‰§è¡Œã€‚å½“å‡½æ•°æ‰§è¡Œå®Œæˆåä¼šè¿”å›ç»“æœï¼ˆæˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚
è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹é€šå¸¸æ˜¯â€œä¸€æ¬¡æ€§â€çš„ï¼Œå†æ¬¡è°ƒç”¨è¿™ä¸ªå‡½æ•°åˆæ˜¯ä¸€æ¬¡ç‹¬ç«‹çš„è¡Œä¸ºã€‚
ä½†æ˜¯åç¨‹ä¸æ˜¯ï¼Œåç¨‹çš„æ“ä½œå’Œè¡Œä¸ºæ˜¯ï¼š
è°ƒç”¨/åˆ›å»ºï¼ˆCreateï¼‰ã€æš‚åœ/æŒ‚èµ·ï¼ˆSuspendï¼‰ã€Â æ¢å¤æ‰§è¡Œï¼ˆResumeï¼‰å’Œé”€æ¯ï¼ˆDestroyï¼‰ã€‚
åç¨‹å¯ä»¥å…è®¸è¿™ä¸ªè¢«è°ƒç”¨çš„å‡½æ•°æ‰§è¡Œåˆ°æŸä¸ªä½ç½®ä¹‹åæš‚æ—¶ä¿ç•™è‡ªå·±çš„ä¸´æ—¶ä¿¡æ¯å¹¶æŒ‚èµ·ã€‚
åœ¨åé¢çš„æŸä¸ªæ—¶é—´ç‚¹å¯ä»¥å†å›åˆ°å½“æ—¶æ‰§è¡Œçš„ä½ç½®å’ŒçŠ¶æ€ç»§ç»­æ‰§è¡Œã€‚
æ‰€ä»¥ä»æŸç§æ„ä¹‰ä¸Šå¯ä»¥è¯´åç¨‹æ˜¯æ™®é€šå‡½æ•°çš„æ³›åŒ–ï¼ˆGeneralisationï¼‰ã€‚
å½“ä¸€ä¸ªç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ›å»ºå‡ºä¸€ä¸ªè¿›ç¨‹ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸é‡Œä¹Ÿä¼šåˆ›å»ºå‡ºä¸€ä¸ªè°ƒåº¦å®ä½“ï¼ˆä¸€ä¸ªè®°å½•è¿™ä¸ªè¿›ç¨‹ç›¸å…³ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼‰ï¼Œç„¶åè·³è½¬åˆ°è¿™ä¸ªç¨‹åºçš„ä»£ç å…¥å£å»æ‰§è¡Œã€‚
åŒä¸€æ—¶é—´æ“ä½œç³»ç»Ÿå¾€å¾€åŒæ—¶åœ¨æ‰§è¡Œå¾ˆå¤šä¸ªè¿›ç¨‹ã€‚è¿™äº›è¿›ç¨‹åœ¨çœŸå®çš„å¤šæ ¸ CPU ä¸Šå¹¶è¡Œæˆ–è€…è½®æµæ‰§è¡Œï¼ˆå½“è¿›ç¨‹æ•°å¤§äº CPU æ ¸æ•°æ—¶æ’é˜Ÿï¼‰ã€‚æ“ä½œç³»ç»Ÿè´Ÿè´£å¯¹è¿™äº›è°ƒåº¦å®ä½“è¿›è¡Œç›‘æ§ã€ç»Ÿè®¡ã€åˆ‡æ¢ç­‰ä¸€åˆ‡è°ƒåº¦å·¥ä½œã€‚ä¸€ä¸ªè¿›ç¨‹é€šå¸¸åªæœ‰ä¸€ä¸ªå¸¸è§„çš„æ‰§è¡Œæµï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œå¯¹åº”åˆ° C/C&#43;&#43; è¯­è¨€é‡Œå°±æ˜¯ä¸€ä¸ªä¸²è¡Œæ‰§è¡Œçš„main()å‡½æ•°ï¼Œmain()å‡½æ•°é‡Œä¼šè°ƒç”¨å…¶ä»–å‡½æ•°ã€‚
å…¶ä»–å‡½æ•°å¯èƒ½ç»§ç»­è°ƒç”¨å¦å¤–çš„å‡½æ•°ï¼Œæœ€ç»ˆmain()å‡½æ•°æ‰§è¡Œå®Œæˆåè¿›ç¨‹é€€å‡ºã€‚å½“ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œä»£ç æ—¶ï¼ŒCPU çš„å¯„å­˜å™¨ä¿å­˜ç€å½“å‰å‡½æ•°çš„æ‰§è¡ŒçŠ¶æ€ï¼Œä¸´æ—¶ç»“æœç­‰ä¿¡æ¯ã€‚å¦‚æœè¦è°ƒç”¨æ–°çš„å‡½æ•°ï¼Œé‚£ä¹ˆéœ€è¦æŠŠå½“å‰éƒ¨åˆ†å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨å†…å­˜é‡Œå†å»è°ƒç”¨æ–°çš„å‡½æ•°ï¼ˆå› ä¸ºæ–°çš„å‡½æ•°ä¹Ÿä¼šä½¿ç”¨è¿™äº›å¯„å­˜å™¨è¿›è¡Œè¿ç®—ï¼‰ã€‚
é‚£ä¹ˆå“ªäº›å¯„å­˜å™¨éœ€è¦ä¿å­˜ï¼Ÿä¼ é€’ç»™æ–°å‡½æ•°çš„å‚æ•°æ”¾åœ¨å“ªé‡Œï¼Ÿè°ƒç”¨å®Œçš„è¿”å›å€¼ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ
è°ƒç”¨çº¦å®šï¼ˆCalling Conventionsï¼‰è§„å®šäº†è¿™äº›ç»†èŠ‚ã€‚æœ¬æ–‡ä¸è¯¦ç»†è°ƒç”¨çº¦å®šçš„ç»†èŠ‚ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥é˜…è¯»å‚è€ƒæ–‡çŒ® [1]ã€‚
åœ¨ AMD64/x86_64 æ¶æ„ä¸‹ï¼Œå‡½æ•°è°ƒç”¨ä½¿ç”¨æ ˆï¼ˆStackï¼‰æ¥å®ç°ï¼Œæ¯ä¸ªå‡½æ•°ä½¿ç”¨çš„æ ˆåŒºåŸŸç§°ä¹‹ä¸ºä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ã€‚ä¸‹é¢å±•ç¤ºä¸€æ®µä»£ç å’Œå…¶æ‰§è¡Œæ—¶å¯¹åº”çš„æ ˆçŠ¶æ€ï¼š
å½“ä»£ç æ‰§è¡Œåˆ°main()-&gt;func1()-&gt;func2()çš„æ—¶å€™ï¼Œå†…å­˜æ ˆæ˜¯å¦‚å›¾çš„å½¢å¼ã€‚æ–°çš„å‡½æ•°è°ƒç”¨ä¼šä½¿å¾—æ ˆç©ºé—´å‘ä¸Šå¢é•¿ä¸ºæ–°å‡½æ•°åˆ›å»ºæ ˆå¸§ï¼Œåˆ›å»ºå±€éƒ¨å˜é‡ä»¥åŠä¿å­˜ä¹‹å‰å‡½æ•°ä½¿ç”¨çš„å¯„å­˜å™¨ã€‚
å‡½æ•°è°ƒç”¨è¿”å›åï¼Œæ ˆå¸§å°±ä¼šè¢«å›æ”¶ï¼ŒåŒæ—¶ä»æ ˆé‡Œæ¢å¤å‡ºä¹‹å‰çš„å¯„å­˜å™¨å€¼å¹¶è·³è½¬åˆ°ä¹‹å‰æ‰§è¡Œçš„ä»£ç åœ°å€ï¼ˆæ‰€ä»¥ C/C&#43;&#43;ä»£ç é‡Œä¸èƒ½è¿”å›å‡½æ•°å±€éƒ¨å˜é‡çš„æŒ‡é’ˆï¼Œå› ä¸ºå‡½æ•°è¿”å›åå†è®¿é—®è¢«å›æ”¶çš„æ ˆå¸§æ˜¯å¾ˆå±é™©çš„ï¼Œè¿™äº›ç©ºé—´éšåå°±è¢«å…¶ä»–å‡½æ•°çš„ä¸´æ—¶æ•°æ®è¦†ç›–äº†ï¼‰ã€‚
éšç€å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›ï¼Œæ ˆä¸æ–­çš„å¢å¤§å’Œç¼©å°ã€‚è¿™ä¸ªæ ˆé»˜è®¤æœ‰å¤šå¤§ï¼Ÿåœ¨ Linux ç³»ç»Ÿä¸Šæ‰§è¡Œulimit -så°±èƒ½çœ‹åˆ°é»˜è®¤çš„å€¼æ˜¯ 8192 KBã€‚å¦‚æœç¨‹åºé‡Œå®šä¹‰äº†è¿‡å¤§çš„å‡½æ•°å±€éƒ¨å˜é‡æˆ–è€…å‡½æ•°è°ƒç”¨æ·±åº¦å¤ªé•¿ï¼ˆå°¤å…¶æ˜¯é€’å½’ï¼‰ï¼Œå°±æœ‰æ ˆæº¢å‡ºçš„é£é™©ã€‚
ä¸æ ˆç›¸å¯¹çš„å†…å­˜åŒºåŸŸæ˜¯å †ï¼Œä¸€èˆ¬åœ¨ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨brk(2)æˆ–è€…mmap(2)è¿›è¡Œåˆ†é…ï¼ŒC/C&#43;&#43;ç¨‹åºé‡Œä½¿ç”¨çš„malloc(3)/free(3)æˆ–è€…new/deleteï¼ˆåªè®¨è®ºå†…å­˜åˆ†é…çš„è¯­ä¹‰éƒ¨åˆ†ï¼‰åˆ†é…ä¸€èˆ¬æ˜¯ CRT çš„å°è£…ï¼ˆæˆ–è€…jemallocä¹‹ç±»çš„å†…å­˜åˆ†é…åº“ï¼‰ã€‚
å †å†…å­˜åŒºåŸŸä¸éšç€å‡½æ•°è°ƒç”¨ç»“æŸè€Œè‡ªåŠ¨å›æ”¶ï¼Œéœ€è¦ç¨‹åºè‡ªè¡Œåœ¨ä½¿ç”¨å®Œæˆåè¿›è¡Œæ˜¾å¼çš„é‡Šæ”¾åŠ¨ä½œã€‚æœ¬è´¨ä¸Šå †ã€æ ˆåªæ˜¯å†…å­˜é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œåªæ˜¯åˆ›å»ºæ—¶æœºå’Œä½¿ç”¨æ–¹å¼çš„ä¸åŒè€Œå·²ï¼Œå¹¶æ— æœ¬è´¨åŒºåˆ«ã€‚
å¦‚æœé€»è¾‘ä¸Šä¸€ä¸ªç¨‹åºéœ€è¦æ›´å¤šçš„æ‰§è¡Œæµï¼Œå¯ä»¥åˆ›å»ºçº¿ç¨‹æ¥å¹¶å‘åœ°æ‰§è¡Œå¦ä¸€ä¸ªå‡½æ•°ã€‚è¿™é‡Œçš„çº¿ç¨‹é€šå¸¸æ˜¯æ“ä½œç³»ç»Ÿæ”¯æŒçš„æ¦‚å¿µï¼Œå¯¹åº”å†…æ ¸çš„ä¸€ä¸ªè°ƒåº¦å®ä½“ï¼Œå¯ä»¥åœ¨ä¸åŒçš„ CPU æ ¸ä¸Šå’Œä¸»çº¿ç¨‹å¹¶è¡Œçš„æ‰§è¡Œã€‚æ“ä½œç³»ç»Ÿå†…æ ¸åœ¨ä»€ä¹ˆæ—¶å€™è¿›è¡Œä»»åŠ¡è°ƒåº¦å‘¢ï¼Ÿ
è‡ªç„¶æ˜¯æ‰§è¡Œæµè·³è½¬åˆ°å†…æ ¸ä»£ç çš„æ—¶å€™ï¼Œé™¤äº†ç³»ç»Ÿè°ƒç”¨ä¼šé™·å…¥å†…æ ¸é¢å¤–è§¦å‘è°ƒåº¦å¤–ï¼Œè¿˜éœ€è¦ç¡¬ä»¶æ—¶é’Ÿä¸­æ–­å¼ºè¡Œä¸­æ–­å½“å‰æ‰§è¡Œçš„ç¨‹åºæ¥åˆ‡æ¢åˆ°å†…æ ¸é€»è¾‘æ¥å…œåº•ï¼ˆå¦åˆ™ä¸€ä¸ªåœ¨ç”¨æˆ·æ€æ­»å¾ªç¯çš„ç¨‹åºå²‚ä¸æ˜¯æ°¸è¿œä¸äº¤å‡ºæ‰§è¡Œæƒäº†ï¼‰ã€‚è¿™ä¸ªåˆ›å»ºçš„çº¿ç¨‹è·Ÿä¸»çº¿ç¨‹ä¸€æ ·ï¼Œæ‹¥æœ‰ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„çº¿ç¨‹æ ˆå»è¿›è¡Œè‡ªèº«å‡½æ•°è°ƒç”¨çš„çŠ¶æ€ä¿å­˜ã€‚
é“ºå«äº†è¿™ä¹ˆå¤šï¼Œé‚£åç¨‹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿå‰æ–‡æåˆ°åç¨‹å‡½æ•°çš„æ“ä½œå’Œè¡Œä¸ºæœ‰ï¼šè°ƒç”¨/åˆ›å»ºï¼ˆCreateï¼‰ã€æš‚åœ/æŒ‚èµ·ï¼ˆSuspendï¼‰ã€æ¢å¤æ‰§è¡Œï¼ˆResumeï¼‰å’Œé”€æ¯ï¼ˆDestroyï¼‰ã€‚
åˆ›å»ºå’Œé”€æ¯æ¯”è¾ƒå¥½ç†è§£ï¼Œåˆ›å»ºçº¿ç¨‹ä¹Ÿæ˜¯æœ‰è¿™ 2 ä¸ªæ­¥éª¤ã€‚å¤šå‡ºæ¥çš„æŒ‚èµ·å’Œæ¢å¤æ“ä½œï¼Œæ˜¯å› ä¸ºè¿™ä¸ªæ‰§è¡Œé€»è¾‘å®Œå…¨æ˜¯åœ¨ç”¨æˆ·æ€æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼Œä¸å­˜åœ¨ä¸€ä¸ªå†…æ ¸çš„è°ƒåº¦å®ä½“ï¼Œé‚£ä¹ˆè‡ªç„¶éœ€è¦åœ¨ç”¨æˆ·æ€å»ç®¡ç†è¿™äº›æ‰§è¡Œæµçš„æŒ‚èµ·å’Œæ¢å¤æ‰§è¡Œã€‚å¦‚æœä½ ç†Ÿæ‚‰ Linux çº¿ç¨‹å‘å±•å²çš„è¯ï¼Œä½ ä¼šçŸ¥é“åœ¨ Linux å†…æ ¸æ”¯æŒçº¿ç¨‹æ¦‚å¿µå‰ï¼Œç”¨æˆ·æ€æ¨¡æ‹Ÿå‡ºçš„å¤šä¸ªå¯ä»¥åˆ‡æ¢çš„â€œçº¿ç¨‹â€å…¶å®å°±æ˜¯åç¨‹çš„ä¸€ç§å®ç°ã€‚
åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹é‡Œï¼Œä¸€èˆ¬ä¸åœ¨çº¿ç¨‹é‡Œæ·»åŠ ä¸»åŠ¨åˆ‡æ¢çš„é€»è¾‘ï¼Œå¾€å¾€éƒ½æ˜¯è¢«åŠ¨çš„è¢«å†…æ ¸ä»æ‰§è¡ŒçŠ¶æ€è½¬æ¢ä¸ºç­‰å¾…çŠ¶æ€ï¼Œæ¯”å¦‚ IO æ“ä½œæœªå®Œæˆï¼Œå°è¯•è·å–çš„èµ„æºæš‚æ—¶è¢«å¼ºå çš„æ—¶å€™ï¼ˆæœ€å¤šå°±æ˜¯è°ƒç”¨æŸäº›ç³»ç»Ÿè°ƒç”¨å‘Šè¯‰å†…æ ¸è‡ªå·±æš‚æ—¶è®©å‡º CPUï¼Œè®©å†…æ ¸çœ‹çœ‹è¦ä¸è¦æ‰§è¡Œåˆ«çš„ä»»åŠ¡ï¼‰ã€‚ä½†åç¨‹ä¸æ˜¯ï¼Œåç¨‹éœ€è¦ç”¨æˆ·é€»è¾‘åœ¨åç»­æ‰§è¡Œæ¡ä»¶ä¸æ»¡è¶³çš„æ—¶å€™ä¸»åŠ¨åˆ‡æ¢è®©å‡ºæ‰§è¡Œæƒã€‚
è¿™é‡Œå§‘ä¸”å°†è¿™ç§åç¨‹ç§°ä¹‹ä¸ºç¬¬ä¸€ä»£åç¨‹ï¼Œå…¶ä»…ä»…æ˜¯çº¿ç¨‹ç­‰æ¦‚å¿µåœ¨ç†è®ºä¸Šçš„æ¨æ¼”ã€‚è€Œå¹¿ä¹‰çš„åç¨‹ï¼ˆCoroutinesï¼‰æ˜¯ä¸ªå¾ˆå®½æ³›çš„æ¦‚å¿µã€‚å°¤å…¶æ˜¯async/awaitè¯­ä¹‰å¸¦æ¥äº†æ–°çš„æµªæ½®ä¹‹åã€‚è¿™å‡ å¹´æ–°çš„ç¼–ç¨‹è¯­è¨€é‡Œå¼•å…¥çš„åç¨‹æ¨¡å‹å‡ ä¹éƒ½æ˜¯async/awaitè¯­ä¹‰çš„ï¼ˆé™¤äº† go è¯­è¨€ ğŸ˜ï¼‰ã€‚æœ¬æ–‡ä¸è€ƒå¤async/awaitæ¦‚å¿µåœ¨å¾®è½¯çš„å‘å±•å†å²ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥å‚é˜…ç›¸å…³èµ„æ–™ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/9c290fb2a248ec777f45a2ec9064f670/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-29T11:38:15+08:00" />
<meta property="article:modified_time" content="2023-12-29T11:38:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹éšæƒ³" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹éšæƒ³</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">æµ…è°ˆC&#43;&#43;20 åç¨‹é‚£ç‚¹äº‹å„¿</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>æœ¬æ–‡æ˜¯Â C++20 çš„åç¨‹å…¥é—¨æ–‡ç« ï¼Œä½œè€…å›´ç»•åç¨‹çš„æ¦‚å¿µåˆ°åç¨‹çš„å®ç°æ€è·¯å…¨æ–¹ä½è¿›è¡Œè®²è§£ï¼ŒåŠªåŠ›è®©æœ¬æ–‡æˆä¸ºå…¨ç½‘æœ€å¥½ç†è§£çš„ã€ŒC++20 åç¨‹ã€åŸç†è§£ææ–‡ç« ã€‚</p> 
<hr> 
<h2>åç¨‹æ¦‚å¿µ</h2> 
<h3><a href="https://mp.weixin.qq.com/s/0njDHtz_SGPkrr4ndAWHaA" rel="nofollow" title="æµ…è°ˆC++20 åç¨‹é‚£ç‚¹äº‹å„¿">æµ…è°ˆC++20 åç¨‹é‚£ç‚¹äº‹å„¿</a></h3> 
<p>å…ˆä»‹ç»ä¸€ç‚¹åç¨‹çš„æ¦‚å¿µï¼Œå¦‚æœä½ å·²ç»ç†è§£å’ŒæŒæ¡äº†ç›¸å…³çš„èƒŒæ™¯çŸ¥è¯†å°±å¯ä»¥è·³è¿‡è¿™ä¸ªç« èŠ‚ï¼ˆæˆ–è€…å¿«é€Ÿæµè§ˆä¸‹ï¼Œä¹Ÿè®¸æˆ‘ä»¬æœ‰äº›è§‚å¿µä¸ä¸€è‡´å¯ä»¥è®¨è®ºï¼‰ã€‚è¿™é‡Œæˆ‘æƒ³ç¨å¾®èŠçš„æ·±å…¥ä¸€ç‚¹ï¼Œè¿™æ¶‰åŠåˆ°å…¥é—¨åé‡åˆ°å¤æ‚çš„åç¨‹é—®é¢˜æ—¶èƒ½ä¸èƒ½æ­£ç¡®çš„ç†è§£å¹¶è§£å†³é—®é¢˜ã€‚</p> 
<blockquote> 
 <p><strong>åç¨‹</strong>ï¼ˆCoroutinesï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸ºå¾®çº¿ç¨‹ï¼Œçº¤ç¨‹ã€‚ä¸€èˆ¬æŒ‡ä¸€ä¸ªå¯ä»¥è¢«æš‚åœå’Œæ¢å¤æ‰§è¡Œçš„é€»è¾‘ä½“ã€‚</p> 
</blockquote> 
<p>ä¸€ä¸ªæ™®é€šçš„å‡½æ•°æœ‰ 2 ä¸ªå¸¸è§„çš„æ“ä½œå’Œè¡Œä¸ºï¼š<strong>è°ƒç”¨</strong>ï¼ˆCallï¼‰å’Œ<strong>è¿”å›</strong>ï¼ˆReturnï¼‰ã€‚å½“è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œä¼šæš‚åœå½“å‰çš„æ‰§è¡Œï¼Œè·³è½¬åˆ°è¿™ä¸ªå‡½æ•°çš„èµ·å§‹ä½ç½®å»æ‰§è¡Œã€‚å½“å‡½æ•°æ‰§è¡Œå®Œæˆåä¼šè¿”å›ç»“æœï¼ˆæˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚</p> 
<p>è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹é€šå¸¸æ˜¯â€œä¸€æ¬¡æ€§â€çš„ï¼Œå†æ¬¡è°ƒç”¨è¿™ä¸ªå‡½æ•°åˆæ˜¯ä¸€æ¬¡ç‹¬ç«‹çš„è¡Œä¸ºã€‚</p> 
<blockquote> 
 <p>ä½†æ˜¯åç¨‹ä¸æ˜¯ï¼Œåç¨‹çš„æ“ä½œå’Œè¡Œä¸ºæ˜¯ï¼š</p> 
 <p><strong>è°ƒç”¨/åˆ›å»º</strong>ï¼ˆCreateï¼‰ã€<strong>æš‚åœ/æŒ‚èµ·</strong>ï¼ˆSuspendï¼‰ã€Â <strong>æ¢å¤æ‰§è¡Œ</strong>ï¼ˆResumeï¼‰å’Œ<strong>é”€æ¯</strong>ï¼ˆDestroyï¼‰ã€‚</p> 
</blockquote> 
<p>åç¨‹å¯ä»¥å…è®¸è¿™ä¸ªè¢«è°ƒç”¨çš„å‡½æ•°æ‰§è¡Œåˆ°æŸä¸ªä½ç½®ä¹‹åæš‚æ—¶ä¿ç•™è‡ªå·±çš„ä¸´æ—¶ä¿¡æ¯å¹¶æŒ‚èµ·ã€‚</p> 
<p>åœ¨åé¢çš„æŸä¸ªæ—¶é—´ç‚¹å¯ä»¥å†å›åˆ°å½“æ—¶æ‰§è¡Œçš„ä½ç½®å’ŒçŠ¶æ€ç»§ç»­æ‰§è¡Œã€‚</p> 
<p>æ‰€ä»¥ä»æŸç§æ„ä¹‰ä¸Šå¯ä»¥è¯´åç¨‹æ˜¯æ™®é€šå‡½æ•°çš„æ³›åŒ–ï¼ˆGeneralisationï¼‰ã€‚</p> 
<p>å½“ä¸€ä¸ªç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ›å»ºå‡ºä¸€ä¸ªè¿›ç¨‹ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸é‡Œä¹Ÿä¼šåˆ›å»ºå‡ºä¸€ä¸ªè°ƒåº¦å®ä½“ï¼ˆä¸€ä¸ªè®°å½•è¿™ä¸ªè¿›ç¨‹ç›¸å…³ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼‰ï¼Œç„¶åè·³è½¬åˆ°è¿™ä¸ªç¨‹åºçš„ä»£ç å…¥å£å»æ‰§è¡Œã€‚</p> 
<p>åŒä¸€æ—¶é—´æ“ä½œç³»ç»Ÿå¾€å¾€åŒæ—¶åœ¨æ‰§è¡Œå¾ˆå¤šä¸ªè¿›ç¨‹ã€‚è¿™äº›è¿›ç¨‹åœ¨çœŸå®çš„å¤šæ ¸ CPU ä¸Šå¹¶è¡Œæˆ–è€…è½®æµæ‰§è¡Œï¼ˆå½“è¿›ç¨‹æ•°å¤§äº CPU æ ¸æ•°æ—¶æ’é˜Ÿï¼‰ã€‚æ“ä½œç³»ç»Ÿè´Ÿè´£å¯¹è¿™äº›è°ƒåº¦å®ä½“è¿›è¡Œç›‘æ§ã€ç»Ÿè®¡ã€åˆ‡æ¢ç­‰ä¸€åˆ‡è°ƒåº¦å·¥ä½œã€‚ä¸€ä¸ªè¿›ç¨‹é€šå¸¸åªæœ‰ä¸€ä¸ªå¸¸è§„çš„æ‰§è¡Œæµï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œå¯¹åº”åˆ° C/C++ è¯­è¨€é‡Œå°±æ˜¯ä¸€ä¸ªä¸²è¡Œæ‰§è¡Œçš„main()å‡½æ•°ï¼Œmain()å‡½æ•°é‡Œä¼šè°ƒç”¨å…¶ä»–å‡½æ•°ã€‚</p> 
<p>å…¶ä»–å‡½æ•°å¯èƒ½ç»§ç»­è°ƒç”¨å¦å¤–çš„å‡½æ•°ï¼Œæœ€ç»ˆmain()å‡½æ•°æ‰§è¡Œå®Œæˆåè¿›ç¨‹é€€å‡ºã€‚å½“ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œä»£ç æ—¶ï¼ŒCPU çš„å¯„å­˜å™¨ä¿å­˜ç€å½“å‰å‡½æ•°çš„æ‰§è¡ŒçŠ¶æ€ï¼Œä¸´æ—¶ç»“æœç­‰ä¿¡æ¯ã€‚å¦‚æœè¦è°ƒç”¨æ–°çš„å‡½æ•°ï¼Œé‚£ä¹ˆéœ€è¦æŠŠå½“å‰éƒ¨åˆ†å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨å†…å­˜é‡Œå†å»è°ƒç”¨æ–°çš„å‡½æ•°ï¼ˆå› ä¸ºæ–°çš„å‡½æ•°ä¹Ÿä¼šä½¿ç”¨è¿™äº›å¯„å­˜å™¨è¿›è¡Œè¿ç®—ï¼‰ã€‚</p> 
<p>é‚£ä¹ˆå“ªäº›å¯„å­˜å™¨éœ€è¦ä¿å­˜ï¼Ÿä¼ é€’ç»™æ–°å‡½æ•°çš„å‚æ•°æ”¾åœ¨å“ªé‡Œï¼Ÿè°ƒç”¨å®Œçš„è¿”å›å€¼ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ</p> 
<p><strong>è°ƒç”¨çº¦å®š</strong>ï¼ˆCalling Conventionsï¼‰è§„å®šäº†è¿™äº›ç»†èŠ‚ã€‚æœ¬æ–‡ä¸è¯¦ç»†è°ƒç”¨çº¦å®šçš„ç»†èŠ‚ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥é˜…è¯»å‚è€ƒæ–‡çŒ® [1]ã€‚</p> 
<p>åœ¨ AMD64/x86_64 æ¶æ„ä¸‹ï¼Œå‡½æ•°è°ƒç”¨ä½¿ç”¨æ ˆï¼ˆStackï¼‰æ¥å®ç°ï¼Œæ¯ä¸ªå‡½æ•°ä½¿ç”¨çš„æ ˆåŒºåŸŸç§°ä¹‹ä¸ºä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ã€‚ä¸‹é¢å±•ç¤ºä¸€æ®µä»£ç å’Œå…¶æ‰§è¡Œæ—¶å¯¹åº”çš„æ ˆçŠ¶æ€ï¼š</p> 
<p class="img-center"><img alt="Image" height="455" src="https://images2.imgbox.com/03/09/5s3LoYhm_o.png" width="805"></p> 
<p>å½“ä»£ç æ‰§è¡Œåˆ°main()-&gt;func1()-&gt;func2()çš„æ—¶å€™ï¼Œå†…å­˜æ ˆæ˜¯å¦‚å›¾çš„å½¢å¼ã€‚æ–°çš„å‡½æ•°è°ƒç”¨ä¼šä½¿å¾—æ ˆç©ºé—´å‘ä¸Šå¢é•¿ä¸ºæ–°å‡½æ•°åˆ›å»ºæ ˆå¸§ï¼Œåˆ›å»ºå±€éƒ¨å˜é‡ä»¥åŠä¿å­˜ä¹‹å‰å‡½æ•°ä½¿ç”¨çš„å¯„å­˜å™¨ã€‚</p> 
<p>å‡½æ•°è°ƒç”¨è¿”å›åï¼Œæ ˆå¸§å°±ä¼šè¢«å›æ”¶ï¼ŒåŒæ—¶ä»æ ˆé‡Œæ¢å¤å‡ºä¹‹å‰çš„å¯„å­˜å™¨å€¼å¹¶è·³è½¬åˆ°ä¹‹å‰æ‰§è¡Œçš„ä»£ç åœ°å€ï¼ˆæ‰€ä»¥ C/C++ä»£ç é‡Œä¸èƒ½è¿”å›å‡½æ•°å±€éƒ¨å˜é‡çš„æŒ‡é’ˆï¼Œå› ä¸ºå‡½æ•°è¿”å›åå†è®¿é—®è¢«å›æ”¶çš„æ ˆå¸§æ˜¯å¾ˆå±é™©çš„ï¼Œè¿™äº›ç©ºé—´éšåå°±è¢«å…¶ä»–å‡½æ•°çš„ä¸´æ—¶æ•°æ®è¦†ç›–äº†ï¼‰ã€‚</p> 
<p>éšç€å‡½æ•°çš„è°ƒç”¨å’Œè¿”å›ï¼Œæ ˆä¸æ–­çš„å¢å¤§å’Œç¼©å°ã€‚è¿™ä¸ªæ ˆé»˜è®¤æœ‰å¤šå¤§ï¼Ÿåœ¨ Linux ç³»ç»Ÿä¸Šæ‰§è¡Œulimit -så°±èƒ½çœ‹åˆ°é»˜è®¤çš„å€¼æ˜¯ 8192 KBã€‚å¦‚æœç¨‹åºé‡Œå®šä¹‰äº†è¿‡å¤§çš„å‡½æ•°å±€éƒ¨å˜é‡æˆ–è€…å‡½æ•°è°ƒç”¨æ·±åº¦å¤ªé•¿ï¼ˆå°¤å…¶æ˜¯é€’å½’ï¼‰ï¼Œå°±æœ‰æ ˆæº¢å‡ºçš„é£é™©ã€‚</p> 
<p>ä¸æ ˆç›¸å¯¹çš„å†…å­˜åŒºåŸŸæ˜¯å †ï¼Œä¸€èˆ¬åœ¨ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨brk(2)æˆ–è€…mmap(2)è¿›è¡Œåˆ†é…ï¼ŒC/C++ç¨‹åºé‡Œä½¿ç”¨çš„malloc(3)/free(3)æˆ–è€…new/deleteï¼ˆåªè®¨è®ºå†…å­˜åˆ†é…çš„è¯­ä¹‰éƒ¨åˆ†ï¼‰åˆ†é…ä¸€èˆ¬æ˜¯ CRT çš„å°è£…ï¼ˆæˆ–è€…jemallocä¹‹ç±»çš„å†…å­˜åˆ†é…åº“ï¼‰ã€‚</p> 
<p>å †å†…å­˜åŒºåŸŸä¸éšç€å‡½æ•°è°ƒç”¨ç»“æŸè€Œè‡ªåŠ¨å›æ”¶ï¼Œéœ€è¦ç¨‹åºè‡ªè¡Œåœ¨ä½¿ç”¨å®Œæˆåè¿›è¡Œæ˜¾å¼çš„é‡Šæ”¾åŠ¨ä½œã€‚æœ¬è´¨ä¸Šå †ã€æ ˆåªæ˜¯å†…å­˜é€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œåªæ˜¯åˆ›å»ºæ—¶æœºå’Œä½¿ç”¨æ–¹å¼çš„ä¸åŒè€Œå·²ï¼Œå¹¶æ— æœ¬è´¨åŒºåˆ«ã€‚</p> 
<p>å¦‚æœé€»è¾‘ä¸Šä¸€ä¸ªç¨‹åºéœ€è¦æ›´å¤šçš„æ‰§è¡Œæµï¼Œå¯ä»¥åˆ›å»ºçº¿ç¨‹æ¥å¹¶å‘åœ°æ‰§è¡Œå¦ä¸€ä¸ªå‡½æ•°ã€‚è¿™é‡Œçš„çº¿ç¨‹é€šå¸¸æ˜¯æ“ä½œç³»ç»Ÿæ”¯æŒçš„æ¦‚å¿µï¼Œå¯¹åº”å†…æ ¸çš„ä¸€ä¸ªè°ƒåº¦å®ä½“ï¼Œå¯ä»¥åœ¨ä¸åŒçš„ CPU æ ¸ä¸Šå’Œä¸»çº¿ç¨‹å¹¶è¡Œçš„æ‰§è¡Œã€‚æ“ä½œç³»ç»Ÿå†…æ ¸åœ¨ä»€ä¹ˆæ—¶å€™è¿›è¡Œä»»åŠ¡è°ƒåº¦å‘¢ï¼Ÿ</p> 
<p>è‡ªç„¶æ˜¯æ‰§è¡Œæµè·³è½¬åˆ°å†…æ ¸ä»£ç çš„æ—¶å€™ï¼Œé™¤äº†ç³»ç»Ÿè°ƒç”¨ä¼šé™·å…¥å†…æ ¸é¢å¤–è§¦å‘è°ƒåº¦å¤–ï¼Œè¿˜éœ€è¦ç¡¬ä»¶æ—¶é’Ÿä¸­æ–­å¼ºè¡Œä¸­æ–­å½“å‰æ‰§è¡Œçš„ç¨‹åºæ¥åˆ‡æ¢åˆ°å†…æ ¸é€»è¾‘æ¥å…œåº•ï¼ˆå¦åˆ™ä¸€ä¸ªåœ¨ç”¨æˆ·æ€æ­»å¾ªç¯çš„ç¨‹åºå²‚ä¸æ˜¯æ°¸è¿œä¸äº¤å‡ºæ‰§è¡Œæƒäº†ï¼‰ã€‚è¿™ä¸ªåˆ›å»ºçš„çº¿ç¨‹è·Ÿä¸»çº¿ç¨‹ä¸€æ ·ï¼Œæ‹¥æœ‰ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„çº¿ç¨‹æ ˆå»è¿›è¡Œè‡ªèº«å‡½æ•°è°ƒç”¨çš„çŠ¶æ€ä¿å­˜ã€‚</p> 
<p>é“ºå«äº†è¿™ä¹ˆå¤šï¼Œé‚£åç¨‹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿå‰æ–‡æåˆ°åç¨‹å‡½æ•°çš„æ“ä½œå’Œè¡Œä¸ºæœ‰ï¼š<strong>è°ƒç”¨/åˆ›å»º</strong>ï¼ˆCreateï¼‰ã€<strong>æš‚åœ/æŒ‚èµ·</strong>ï¼ˆSuspendï¼‰ã€<strong>æ¢å¤æ‰§è¡Œ</strong>ï¼ˆResumeï¼‰å’Œ<strong>é”€æ¯</strong>ï¼ˆDestroyï¼‰ã€‚</p> 
<p>åˆ›å»ºå’Œé”€æ¯æ¯”è¾ƒå¥½ç†è§£ï¼Œåˆ›å»ºçº¿ç¨‹ä¹Ÿæ˜¯æœ‰è¿™ 2 ä¸ªæ­¥éª¤ã€‚å¤šå‡ºæ¥çš„æŒ‚èµ·å’Œæ¢å¤æ“ä½œï¼Œæ˜¯å› ä¸ºè¿™ä¸ªæ‰§è¡Œé€»è¾‘å®Œå…¨æ˜¯åœ¨ç”¨æˆ·æ€æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼Œä¸å­˜åœ¨ä¸€ä¸ªå†…æ ¸çš„è°ƒåº¦å®ä½“ï¼Œé‚£ä¹ˆè‡ªç„¶éœ€è¦åœ¨ç”¨æˆ·æ€å»ç®¡ç†è¿™äº›æ‰§è¡Œæµçš„æŒ‚èµ·å’Œæ¢å¤æ‰§è¡Œã€‚å¦‚æœä½ ç†Ÿæ‚‰ Linux çº¿ç¨‹å‘å±•å²çš„è¯ï¼Œä½ ä¼šçŸ¥é“åœ¨ Linux å†…æ ¸æ”¯æŒçº¿ç¨‹æ¦‚å¿µå‰ï¼Œç”¨æˆ·æ€æ¨¡æ‹Ÿå‡ºçš„å¤šä¸ªå¯ä»¥åˆ‡æ¢çš„â€œçº¿ç¨‹â€å…¶å®å°±æ˜¯åç¨‹çš„ä¸€ç§å®ç°ã€‚</p> 
<p>åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹é‡Œï¼Œä¸€èˆ¬ä¸åœ¨çº¿ç¨‹é‡Œæ·»åŠ ä¸»åŠ¨åˆ‡æ¢çš„é€»è¾‘ï¼Œå¾€å¾€éƒ½æ˜¯è¢«åŠ¨çš„è¢«å†…æ ¸ä»æ‰§è¡ŒçŠ¶æ€è½¬æ¢ä¸ºç­‰å¾…çŠ¶æ€ï¼Œæ¯”å¦‚ IO æ“ä½œæœªå®Œæˆï¼Œå°è¯•è·å–çš„èµ„æºæš‚æ—¶è¢«å¼ºå çš„æ—¶å€™ï¼ˆæœ€å¤šå°±æ˜¯è°ƒç”¨æŸäº›ç³»ç»Ÿè°ƒç”¨å‘Šè¯‰å†…æ ¸è‡ªå·±æš‚æ—¶è®©å‡º CPUï¼Œè®©å†…æ ¸çœ‹çœ‹è¦ä¸è¦æ‰§è¡Œåˆ«çš„ä»»åŠ¡ï¼‰ã€‚ä½†åç¨‹ä¸æ˜¯ï¼Œåç¨‹éœ€è¦ç”¨æˆ·é€»è¾‘åœ¨åç»­æ‰§è¡Œæ¡ä»¶ä¸æ»¡è¶³çš„æ—¶å€™ä¸»åŠ¨åˆ‡æ¢è®©å‡ºæ‰§è¡Œæƒã€‚</p> 
<p>è¿™é‡Œå§‘ä¸”å°†è¿™ç§åç¨‹ç§°ä¹‹ä¸ºç¬¬ä¸€ä»£åç¨‹ï¼Œå…¶ä»…ä»…æ˜¯çº¿ç¨‹ç­‰æ¦‚å¿µåœ¨ç†è®ºä¸Šçš„æ¨æ¼”ã€‚è€Œå¹¿ä¹‰çš„<strong>åç¨‹</strong>ï¼ˆCoroutinesï¼‰æ˜¯ä¸ªå¾ˆå®½æ³›çš„æ¦‚å¿µã€‚å°¤å…¶æ˜¯async/awaitè¯­ä¹‰å¸¦æ¥äº†æ–°çš„æµªæ½®ä¹‹åã€‚è¿™å‡ å¹´æ–°çš„ç¼–ç¨‹è¯­è¨€é‡Œå¼•å…¥çš„åç¨‹æ¨¡å‹å‡ ä¹éƒ½æ˜¯async/awaitè¯­ä¹‰çš„ï¼ˆé™¤äº† go è¯­è¨€ ğŸ˜ï¼‰ã€‚æœ¬æ–‡ä¸è€ƒå¤async/awaitæ¦‚å¿µåœ¨å¾®è½¯çš„å‘å±•å†å²ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥å‚é˜…ç›¸å…³èµ„æ–™ã€‚</p> 
<p>é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨ C/C++ è¯­è¨€é‡Œå®ç°åç¨‹ï¼Ÿå®¹æ˜“æƒ³åˆ°çš„æ–¹å¼å°±æ˜¯ç±»ä¼¼çº¿ç¨‹çš„å®ç°æ–¹å¼ï¼ˆç¬¬ä¸€ä»£åç¨‹æŠ½è±¡ï¼‰ï¼Œä¸ºæ¯ä¸€ä¸ªåç¨‹åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å†…å­˜æ ˆè¿›è¡Œä¸Šä¸‹æ–‡çš„ä¿å­˜å’Œå‡½æ•°è°ƒç”¨ã€‚è¿™ç§æ–¹å¼åœ¨åç¨‹é—´è¿›è¡Œåˆ‡æ¢çš„æ–¹æ³•å°±æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦ç”¨æˆ·ä»£ç è‡ªè¡Œä¿å­˜ä¸Šä¸‹æ–‡ä¹‹åç›´æ¥è·³è½¬åˆ°ç›®æ ‡å‡½æ•°ä½ç½®æ‰§è¡Œå³å¯ã€‚è¿™å’Œæ“ä½œç³»ç»Ÿå†…æ ¸åˆ‡æ¢å¤šä¸ªæ‰§è¡Œæµçš„æ–¹å¼ä¹Ÿå¾ˆç±»ä¼¼ã€‚è¿™å†ä¹Ÿå°±æ˜¯åœ¨ C++20 åç¨‹ç›¸å…³çš„èµ„æ–™é‡Œæåˆ°çš„æ‰€è°“çš„<strong>æœ‰æ ˆåç¨‹</strong>ï¼ˆStackful Coroutineï¼‰ã€‚</p> 
<p>æœ‰æ ˆåç¨‹çš„åˆ›å»ºä»£ä»·æ¯”è¾ƒå¤§ã€‚å› ä¸ºåç¨‹å‡½æ•°æ‰§è¡Œå‰è¦é¢„å…ˆåˆ›å»ºå¥½ç‹¬ç«‹çš„åç¨‹æ ˆï¼Œé¢„åˆ†é…å†…å­˜è¿™ä¹Ÿå°±é™åˆ¶äº†åŒæ—¶å¹¶å‘çš„åç¨‹æ•°é‡ã€‚è€Œä¸”é¢„åˆ†é…çš„æ ˆè¿‡å¤§ä¼šé€ æˆæµªè´¹ï¼Œè¿‡å°äº†åˆä¼šå¯¼è‡´å‡½æ•°è°ƒç”¨æ·±äº†ä»¥åå¯¼è‡´æ ˆæº¢å‡ºï¼ˆå…¶å®ä» Linux å†…æ ¸å†…å­˜åˆ†é…çš„è§’åº¦è®²ï¼Œå®é™…ç”¨åˆ°äº†æ‰ä¼šåˆ†é…å†…å­˜é¡µï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåç¨‹æ ˆæœ€å¤šä¹Ÿå°±æ¯”å®é™…ä½¿ç”¨çš„å†…å­˜æµªè´¹ä¸€ä¸ªç‰©ç†é¡µï¼‰ã€‚</p> 
<p>å¦å¤–ç°ä»£ CPU çš„åˆ†æ”¯é¢„æµ‹é‡Œæœ‰è¿”å›æ ˆç¼“å†²åŒºï¼ˆReturn Stack Bufferï¼ŒRSBï¼‰çš„é¢„æµ‹ï¼Œä¸æ–­æ‰‹åŠ¨çš„æ ˆåˆ‡æ¢å°±åœ¨ä¸æ–­çš„ç ´å RSB çš„é¢„æµ‹æœºåˆ¶ï¼Œä¸”è¶Šå¤æ‚è¶Šé«˜é¢‘çš„åˆ‡æ¢å½±å“å°±è¶Šå¤§ã€‚ä½†è¿™ç§æ¨¡å‹çš„å¥½å¤„æ˜¯å®ƒå¯¹ç¼–è¯‘å™¨å‡ ä¹æ˜¯é€æ˜çš„ï¼Œå¯¹å·²æœ‰ä»£ç çš„åç¨‹åŒ–æ”¹é€ ä¼šéå¸¸ç®€å•ï¼Œåªéœ€è¦ä¿®æ”¹åˆ›å»ºåç¨‹çš„ä½ç½®å¹¶åœ¨ä»£ç é‡Œæ·»åŠ ä¸»åŠ¨çš„åˆ‡æ¢ç‚¹å³å¯ï¼ˆç”šè‡³å¯ä»¥ç”¨ hook çš„æ–¹å¼è‡ªåŠ¨åŠ yieldè¿›å»åšåˆ°å®Œå…¨ä¸éœ€è¦ä¿®æ”¹å·²æœ‰ä»£ç ï¼‰ã€‚</p> 
<blockquote> 
 <p>è¿™é‡Œç¨å¾®æä¸€ä¸‹<strong>å…±äº«æ ˆåç¨‹</strong>ï¼ˆCopying the Stack Coroutineï¼‰ï¼Œæ—¢ç„¶æ¯ä¸ªåç¨‹éƒ½åˆ›å»ºä¸€ä¸ªé¢å¤–çš„æ ˆå¤ªæµªè´¹äº†ï¼Œé‚£å°±åªåˆ›å»ºä¸€ä¸ªã€‚åœ¨åç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œæ‹·è´å½“å‰å·²ä½¿ç”¨çš„æ ˆåˆ°å¦å¤–çš„å†…å­˜é‡Œï¼Œè…¾å‡ºæ¥æ ˆç»™æ–°çš„åç¨‹ç”¨å³å¯ã€‚éœ€è¦åˆ‡æ¢å›æ¥çš„æ—¶å€™ï¼Œæ‹·è´å›æ¥ä¹‹å‰çš„æ ˆå³å¯ã€‚å…±äº«æ ˆåç¨‹è§£å†³äº†é¢„åˆ†é…çš„å†…å­˜æµªè´¹é—®é¢˜ï¼Œä½†æ˜¯å¼•å…¥äº†æ ˆå¤‡ä»½å’Œè¿˜åŸçš„å¼€é”€ã€‚è¦æƒ³æ€§èƒ½å¥½çš„è¯ï¼Œè¿˜éœ€è¦å°½é‡å‡å°‘å‡½æ•°è°ƒç”¨æ·±åº¦ä»¥åŠå°½é‡ä¸åœ¨æ ˆä¸Šåˆ†é…å¤ªå¤§çš„æ•°æ®ç»“æ„ã€‚æ‰€ä»¥å…±äº«æ ˆåç¨‹åªæ˜¯ä¸€ç§ä¼˜åŒ–æ‰‹æ®µï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸å•ç‹¬æ‹¿å‡ºæ¥å¯¹æ¯”å’Œè®¨è®ºã€‚</p> 
</blockquote> 
<p>ä¸æœ‰æ ˆåç¨‹ç›¸å¯¹çš„æ˜¯<strong>æ— æ ˆåç¨‹</strong>ï¼ˆStackless Coroutineï¼‰ï¼Œå³ C++20 æ‰€é‡‡ç”¨çš„æ¨¡å¼ã€‚è¿™ä¸ªæ¨¡å¼ä¸‹åˆ›å»ºçš„åç¨‹å¾ˆè½»é‡ï¼Œä¸€å¼€å§‹å°±ä¼šåœ¨å †ä¸Šä¿å­˜æ‰€æœ‰çš„åç¨‹å‡½æ•°çš„â€œä¸´æ—¶å˜é‡â€ä»¥åŠè°ƒç”¨å‚æ•°ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä»åç¨‹å‡½æ•°é‡Œåˆ‡æ¢å‡ºæ¥çš„æ—¶å€™ï¼Œå› ä¸ºå¤§å¤šæ•°ä¸œè¥¿éƒ½æ˜¯ä¿å­˜åœ¨å †ä¸Šçš„ï¼Œæ‰€ä»¥åˆ‡æ¢åŠ¨ä½œå¯ä»¥å¾ˆçŸ­å¾ˆå¿«ã€‚æ¢å¤æ‰§è¡Œçš„æ—¶å€™ä¹Ÿä¸éœ€è¦å¤ªå¤šçš„æ ˆä¸Šç»“æ„è¿˜åŸå°±å¯ä»¥è·³è½¬å›åŸæ¥çš„ä»£ç ä½ç½®æ‰§è¡Œã€‚å› ä¸ºåˆ›å»ºå‡ºæ¥çš„åç¨‹ä¸ç”³è¯·æ–°çš„å†…å­˜æ ˆè€Œæ˜¯åœ¨è°ƒç”¨/æ¢å¤ä½ç½®åŸåœ°è¿˜åŸä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥è¢«ç§°ä¹‹ä¸ºæ— æ ˆåç¨‹ã€‚ä½†æ˜¯è¿™ç§æ¨¡å¼æ— æ³•ç®€å•é€‚é…å·²æœ‰ä»£ç æ¥å®ç°åç¨‹åŒ–æ”¹é€ ï¼Œéœ€è¦å¯¹æ—§ä»£ç é‡æ„ç”šè‡³é‡å†™æ‰èƒ½å®Œæˆæ”¹é€ ã€‚</p> 
<p>å¼ºè°ƒä¸€ä¸‹ï¼Œè¿™ä¸ªæœ‰æ ˆæ— æ ˆæ˜¯ç«™åœ¨ C/C++ è¯­è¨€çš„è§’åº¦å»è®¨è®ºçš„ã€‚æœ‰äº›è¯­è¨€ï¼ˆæ¯”å¦‚ Pythonï¼‰å¹¶ä¸åœ¨æ ˆç©ºé—´ä¸ºæ‰§è¡Œæµåˆ†é…ä¿å­˜ä¸Šä¸‹æ–‡çš„ã€Œæ ˆã€ï¼Œæ‰€ä»¥ä¸å­˜åœ¨ Stackful å’Œ Stackless è®¨è®ºã€‚ç”šè‡³åœ¨çº¯ç†è®ºçš„è®¨è®ºåç¨‹æ¦‚å¿µæ—¶ï¼Œæåˆ°æ ˆï¼ˆStackï¼‰éƒ½æ˜¾å¾—æœ‰äº›ã€Œä¸šä½™ã€ã€‚å› ä¸ºæ ˆä¸æ˜¯å®ç°å‡½æ•°è°ƒç”¨çš„å”¯ä¸€æ–¹å¼ï¼Œåªæ˜¯ç°ä»£ä¸»æµç¼–ç¨‹è¯­è¨€å¤§éƒ½è¿™ä¹ˆå®ç°çš„è€Œå·²ã€‚å°½ç®¡è¿™ä¸å½±å“è¿™ç¯‡æ–‡æ¡£æƒ³è¡¨è¾¾çš„å®é™…æ„æ€ï¼Œä½†è¿™é‡Œè¿˜æ˜¯é˜æ˜ä¸€ä¸‹ï¼Œæœ¬æ–‡åªæ˜¯åœ¨ C/C++ è¯­è¨€ç°çŠ¶ä¸‹åå‘äºå·¥ç¨‹åŒ–çš„è®¨è®ºï¼Œä¸æ‹”é«˜åˆ°çº¯ç²¹çš„ç†è®ºé«˜åº¦ã€‚å¦å¤–æˆ‘ä¹Ÿåªæ˜¯ä¸ªæ™®é€šçš„å†™ä»£ç çš„ç¨‹åºå‘˜è€Œå·²ï¼Œæ— æ³•ä»ç§‘å­¦ï¼ˆæ•°å­¦ï¼‰è§’åº¦è®¨è®ºasync/awaitçš„è¯­ä¹‰ï¼Œè¿˜è¯·è§è°… ğŸ˜ã€‚</p> 
<blockquote> 
 <p>è¯´å¤šäº†å®¹æ˜“è®©è¯»è€…ç³Šæ¶‚ï¼Œä½†æ˜¯ä¸è¯´çš„è¯åˆæ‹…å¿ƒè®©è¯»è€…ä¸€å¶éšœç›®ã€‚æœ¬æ–‡ä»‹ç»å…·ä½“çš„å®ç°åŸç†æ˜¯ä¸ºäº†å¿«é€Ÿçš„ç†è§£æŠ½è±¡ç†è®ºï¼Œä½†ä¹Ÿå®¹æ˜“é€ æˆå¯¹åç¨‹ç†è®ºçš„ç‹­éš˜ç†è§£ï¼Œè¿™ä¸€ç‚¹è¿˜è¯·è¯»è€…æ³¨æ„ã€‚</p> 
</blockquote> 
<p>åç¨‹çš„å‘å±•æ–¹å‘æ˜¯ä»€ä¹ˆï¼Ÿç›®å‰çœ‹éƒ½æ˜¯åœ¨ç€åŠ›è§£å†³å¼‚æ­¥ä»£ç çš„ã€Œå½¢å¼åŒ–åŒæ­¥ç¼–å†™ã€çš„é—®é¢˜ï¼Œå³å¸®åŠ©ç¨‹åºå‘˜ä»¥è¿‘ä¼¼åŒæ­¥çš„æ–¹å¼æ¥ç¼–å†™å¼‚æ­¥é€»è¾‘ï¼Œåœ¨å½¢å¼ä¸Šä½¿å¾—æœ‰é€»è¾‘å…³ç³»çš„ä»£ç ä¸è¦å‰²è£‚ã€‚ä½†æ˜¯è¿™ç§æŠ½è±¡æ˜¯æœ‰è¿è¡Œæ—¶çš„æˆæœ¬çš„ã€‚è¿™é‡Œä¸å¦¨æ¥ä¸€å¥æš´è®ºï¼šåœ¨çº¯ç²¹ç†è®ºä¸Šåç¨‹ä¸€èˆ¬ä¸å¦‚çº¿ç¨‹ + callbacks çš„æ€§èƒ½æ¥å¾—å¥½ï¼ˆè‡³å°‘å½“å‰çš„è‡ªåŠ¨ä¼˜åŒ–æ°´å¹³ä¸‹ï¼‰ã€‚è¿½æ±‚æé™æ€§èƒ½çš„è¯è¿˜æ˜¯ç®—äº†ã€‚<strong>è¿½æ±‚ç»´æŠ¤æˆæœ¬å’Œæ€§èƒ½çš„å¹³è¡¡æˆ–è€…ä¸ºäº†é™ä½å¼€å‘æˆæœ¬ï¼Œè¿™æ‰æ˜¯åç¨‹æ­£ç¡®çš„æ‰“å¼€æ–¹å¼ã€‚</strong></p> 
<p>æœ‰äººè¯´ã€Œç¨‹åºå°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œçº¿ç¨‹/åç¨‹æ˜¯ç»™é‚£äº›å†™ä¸å¥½çŠ¶æ€æœºçš„äººå‡†å¤‡çš„ã€[2]ã€‚è¿™å¥è¯æœ‰é“ç†å—ï¼Ÿå…¶å®æœ‰ä¸€ç‚¹é“ç†ã€‚ä»æœ€ç»ˆçš„æ‰§è¡Œä¸Šçœ‹ï¼Œç¨‹åºå°±æ˜¯ä¸€ä¸ªåœ¨ CPU ä¸Šæ‰§è¡Œçš„çŠ¶æ€æœºã€‚ä½†æ˜¯ä»ç¨‹åºçš„è®¾è®¡ä¸Šè®²ï¼Œæ›´é«˜çº§åˆ«çš„æŠ½è±¡æ–¹å¼å’Œæ–¹æ³•æœ‰åŠ©äºå†™å‡ºæ¥æ›´å®¹æ˜“è¢«ã€Œäººç±»ã€ç†è§£å’Œæ”¹è¿›çš„é€»è¾‘ã€‚é«˜çº§æŠ½è±¡æ˜¯æ„å»ºå¤§å‹è½¯ä»¶ç³»ç»Ÿæ‰€å¿…é¡»çš„åŸºç¡€è®¾æ–½ã€‚å“ªæ€•ä»˜å‡ºä¸€ç‚¹è¿è¡Œæ—¶æˆæœ¬ä¹Ÿæ˜¯å€¼å¾—çš„ã€‚éšç€æŠ€æœ¯çš„å‘å±•ï¼Œè¿è¡Œæ—¶æˆæœ¬ä¼šé€æ¸ä¼˜åŒ–é™ä½çš„ã€‚è€Œæˆ‘ä»¬å¿…é¡»æ—¶åˆ»æé†’è‡ªå·±ï¼Œä»£ç æ˜¯å†™ç»™ã€Œäººã€çœ‹çš„ï¼Œè€Œä¸æ˜¯ã€Œæœºå™¨ã€ã€‚</p> 
<p>C++20 çš„åç¨‹å®ç°</p> 
<p class="img-center"><img alt="Image" height="450" src="https://images2.imgbox.com/40/1d/R93GAp1W_o.png" width="793"></p> 
<p>å‰é¢è®¨è®ºè¿™ä¹ˆå¤šèƒŒæ™¯å’ŒåŸç†åšä»€ä¹ˆï¼Ÿè¯´æ¥æƒ­æ„§ï¼ŒC++20 çš„åç¨‹æœºåˆ¶æˆ‘çœ‹äº†å¥½å‡ é cppreference çš„æ–‡æ¡£æ‰ç†è§£ã€‚</p> 
<p>ç›®å‰ C++20 å®ç°çš„åç¨‹æœºåˆ¶ä¸é€‚åˆç»™æœ€ç»ˆç”¨æˆ·å»ä½¿ç”¨ï¼Œè€Œæ˜¯ç»™åç¨‹åº“çš„ä½œè€…æä¾›çš„ä¸€äº›ç¼–è¯‘å™¨çš„åç¨‹æ”¯æŒå’Œè¯­æ³•ç³–ã€‚æˆ‘è®¤ä¸ºæƒ³ç†è§£ç›®å‰å®ç°æœ€å¥½çš„æ–¹å¼å°±æ˜¯ä»è®¾è®¡è€…çš„è§’åº¦å»ç†è§£ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚</p> 
<p>å‰æ–‡æåˆ°ï¼ŒC++20 çš„åç¨‹å®ç°æ˜¯ Stackless çš„å®ç°ã€‚å…¶åˆ›å»ºå‡ºæ¥çš„åç¨‹å°†å…¶æ‰§è¡Œæ‰€éœ€è¦çš„å¿…è¦æ•°æ®ä¿å­˜åœ¨å †ä¸Šã€‚åœ¨åç¨‹åˆ‡æ¢å‡ºå»ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯åˆ°å †åï¼Œä¾æ—§åœ¨åŸæ¥çš„æ ˆä½ç½®æ¢å¤ä¹‹å‰çš„å‡½æ•°æ‰§è¡Œã€‚åç¨‹åˆ‡æ¢å›æ¥çš„æ—¶å€™ä¹Ÿæ˜¯åœ¨å½“å‰è°ƒç”¨æ¢å¤æ“ä½œçš„æ ˆä¸Šè¿˜åŸä¹‹å‰çš„çŠ¶æ€ç„¶åæ‰§è¡Œã€‚æ‰€ä»¥ç¼–è¯‘å™¨åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ”¯æŒäº†ä»€ä¹ˆï¼Ÿ</p> 
<p>ç¼–è¯‘å™¨æ”¯æŒäº†è‡ªåŠ¨çš„åç¨‹ä¸Šä¸‹æ–‡ä¿å­˜/æ¢å¤ï¼Œä»¥åŠè‡ªåŠ¨çš„å˜é‡æ•è·å’Œå †ä¸Šä¿å­˜æœºåˆ¶ï¼ˆæœ‰ go è¯­è¨€é‚£å‘³äº†ï¼Œgo è¯­è¨€æ”¯æŒè¿”å›å‡½æ•°å±€éƒ¨å˜é‡çš„ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°†å…¶ä¿å­˜åœ¨å †ä¸Šï¼‰ã€‚æ‰€ä»¥ C++20 ç›®å‰çš„åç¨‹ä»…ä»…å°±æ˜¯ä¸ªå¸¦äº†ç¼–è¯‘å™¨è¾…åŠ©æœºåˆ¶çš„åŸºç¡€å®ç°ï¼ˆå½“ç„¶è¿™ç¬¦åˆ C++ çš„ä¸€è´¯é£æ ¼ï¼Œéƒ½æ˜¯ç¼–è¯‘å™¨æ¥æ”¯æŒæ ‡å‡†åº“æ— æ³•å®ç°çš„æœ€å°åŒ–ç‰¹æ€§ï¼Œå…¶ä»–çš„äº¤ç»™æ ‡å‡†åº“å»åšï¼‰ã€‚</p> 
<p>C++20 çš„åç¨‹ä»£ç åƒè¯­æ³•ç³–ä¸€æ ·ä¼šè¢«ç¼–è¯‘å™¨å±•å¼€æˆæ›´å¤æ‚çš„ä»£ç ï¼Œè¿™å°±éœ€è¦å¾ˆå¤šã€Œçº¦å®šã€æ¥å†™ç”¨æˆ·ä¾§çš„ä»£ç ï¼Œç„¶åä¾èµ–ç¼–è¯‘å™¨å»é‡‡ç”¨è¿‘ä¼¼ codegen çš„æ–¹å¼æ¥ç”Ÿæˆåç»­éƒ¨åˆ†ï¼ˆå¦‚æœä½ æ‡‚ js å¹¶ä¸”ç ”ç©¶è¿‡ React ç”Ÿå‘½å‘¨æœŸçš„è¯ï¼Œä½ å¯èƒ½è„‘æµ·é‡Œå·²ç»æœ‰ç”»é¢äº†ï¼‰ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆçœ‹äº†å¾ˆå¤š C++20 åç¨‹ä»£ç çš„ demo åä»æ—§ä¸€å¤´é›¾æ°´çš„åŸå› ã€‚æ‰€ä»¥æœ¬è´¨ä¸Šæ˜¯ç†è§£ç”Ÿæˆåä»£ç çš„æµç¨‹ï¼Œç„¶åå°±èƒ½ç†è§£ä¸ºä»€ä¹ˆè¦é¢„å…ˆå®šä¹‰è¿™äº›ç±»å‹å’Œå›è°ƒæ¥å¸®åŠ©ç¼–è¯‘å™¨å±•å¼€ä»£ç ã€‚</p> 
<p><strong>ä»ä¸€ä¸ªâ€œç®€å•â€çš„ demo å¼€å§‹</strong></p> 
<p>ä¸‹é¢æ˜¯ä¸€ä¸ª C++20 åç¨‹çš„ç®€å• demo ä»£ç ï¼Œå¦‚æœæ²¡æœ‰é«˜ç‰ˆæœ¬ç¼–è¯‘å™¨çš„è¯å¯ä»¥ç”¨ Complier Explorer [3] æ‰§è¡Œï¼š</p> 
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;coroutine&gt;

template &lt;bool READY&gt;
struct Awaiter {
    bool await_ready() noexcept {
        std::cout &lt;&lt; "await_ready: " &lt;&lt; READY &lt;&lt; std::endl;
        return READY;
    }
    void await_resume() noexcept {
        std::cout &lt;&lt; "await_resume" &lt;&lt; std::endl;
    }
    void await_suspend(std::coroutine_handle&lt;&gt;) noexcept {
        std::cout &lt;&lt; "await_suspend" &lt;&lt; std::endl;
    }
};
struct TaskPromise {
    struct promise_type {
        TaskPromise get_return_object() {
            std::cout &lt;&lt; "get_return_object" &lt;&lt; std::endl;
            return TaskPromise{std::coroutine_handle&lt;promise_type&gt;::from_promise(*this)
};        }
        Awaiter&lt;true&gt; initial_suspend() noexcept {
            std::cout &lt;&lt; "initial_suspend" &lt;&lt; std::endl;
            return {};
        }
        Awaiter&lt;true&gt; final_suspend() noexcept {
            std::cout &lt;&lt; "final_suspend" &lt;&lt; std::endl;
            return {};
        }
        void unhandled_exception() {
            std::cout &lt;&lt; "unhandled_exception" &lt;&lt; std::endl;
        }
        void return_void() noexcept {
            std::cout &lt;&lt; "return_void" &lt;&lt; std::endl;
        }
    };</code></pre> 
<pre><code>    void resume() {<!-- --></code><code>        std::cout &lt;&lt; "resume" &lt;&lt; std::endl;</code><code>        handle.resume();</code><code>    }</code>
<code>    std::coroutine_handle&lt;promise_type&gt; handle;</code><code>};</code>
<code>TaskPromise task_func() {<!-- --></code><code>    std::cout &lt;&lt; "task first run" &lt;&lt; std::endl;</code><code>    co_await Awaiter&lt;false&gt;{};</code><code>    std::cout &lt;&lt; "task resume" &lt;&lt; std::endl;</code><code>}</code>
<code>int main() {<!-- --></code><code>    auto promise = task_func();</code><code>    promise.resume();</code>
<code>    return 0;</code><code>}</code></pre> 
<p>è¿™æ®µä»£ç [4]è¿è¡Œåè¾“å‡ºï¼š</p> 
<pre><code>get_return_object</code><code>initial_suspend</code><code>await_ready: 1</code><code>await_resume</code><code>task first run</code><code>await_ready: 0</code><code>await_suspend</code><code>resume</code><code>await_resume</code><code>task resume</code><code>return_void</code><code>final_suspend</code><code>await_ready: 1</code><code>await_resume</code></pre> 
<p>å°½ç®¡æˆ‘å·²ç»å°½åŠ›æŠŠç¬¬ä¸€ä¸ª demo å†™çš„è¶³å¤Ÿå°äº†ï¼Œä½†æ˜¯ä¾æ—§æ¯”å…¶ä»–è¯­è¨€çš„åç¨‹ demo é•¿å¾ˆå¤šã€‚åŸå› ä¹Ÿå¾ˆç®€å•ï¼ŒC++ æƒ³è®©ç¨‹åºå‘˜å¯ä»¥å®šåˆ¶åç¨‹åˆ›å»ºå’Œæ‰§è¡Œçš„ä»»æ„ä¸€ä¸ªé˜¶æ®µçš„ä»»æ„æ­¥éª¤çš„è¡Œä¸ºï¼Œé‚£ä¹ˆå°±å¿…é¡»å®šä¹‰è¶³å¤Ÿå¤šçš„å›è°ƒå‡½æ•°æ¥å®šä¹‰æ¯ä¸ªé˜¶æ®µçš„è¡Œä¸ºã€‚ä¸å‚è€ƒä»»ä½•æ–‡çŒ®æƒ³çœ‹æ‡‚ä¸Šé¢çš„ä»£ç çš„è¯è¿˜æ˜¯æœ‰äº›éš¾åº¦çš„ã€‚ä½†æ˜¯å›æƒ³ä¸€ä¸‹ä¸Šæ–‡æ‰€è¯´çš„â€œç¼–è¯‘å™¨å±•å¼€â€ä»£ç çš„å®ç°åŸç†ï¼Œç»“åˆè¿™äº›å‡½æ•°çš„æ‰§è¡Œé¡ºåºå°±å¯ä»¥å¤§è‡´æ¨æµ‹å‡ºæ¥ç¼–è¯‘å™¨å±•å¼€ä»£ç åå‡½æ•°è°ƒç”¨çš„é¡ºåºã€‚å…¶å® cppreference ç»™å‡ºæ¥äº†å…·ä½“çš„æ‰§è¡Œè¿‡ç¨‹ [5]ï¼Œä½†æ˜¯æœ‰äº›è¯­ç„‰ä¸è¯¦ï¼Œè¿™é‡Œæˆ‘ä»¬æ›´è¯¦ç»†çš„è®²è¿°æµç¨‹å¹¶è§£é‡Šä¸€äº›ç»†èŠ‚ï¼š</p> 
<p></p> 
<p class="img-center"><img alt="Image" height="1163" src="https://images2.imgbox.com/a7/cf/xc1OQYzs_o.png" width="1080"></p> 
<p></p> 
<p class="img-center"><img alt="Image" height="887" src="https://images2.imgbox.com/4c/64/UPUCdVkm_o.png" width="1080"></p> 
<p></p> 
<p>ä¸Šé¢çš„task_func ä»£ç è¿è¡Œç»“æœç»“åˆè¿™ä¸ªæµç¨‹ä»‹ç»ï¼Œç¼–è¯‘å™¨å±•å¼€åçš„ä»£ç éƒ½èƒ½å¤§è‡´æƒ³è±¡å‡ºæ¥äº†ï¼š</p> 
<p></p> 
<p></p> 
<pre><code>TaskPromise task_func() {<!-- --></code><code>    // No parameters and local variables.</code><code>    auto state = new __TaskPromise_state_(); // has TaskPromise::promise_type promise; </code><code>    TaskPromise coro = state.promise.get_return_object();</code><code>    try {<!-- --></code><code>        co_await p.inital_suspend();</code><code>        std::cout &lt;&lt; "task first run" &lt;&lt; std::endl;</code><code>        co_await Awaiter&lt;false&gt;{};</code><code>        std::cout &lt;&lt; "task resume" &lt;&lt; std::endl;</code><code>    } catch (...) {<!-- --></code><code>        state.promise.unhandled_exception();</code><code>    }</code><code>    co_await state.promise.final_suspend();</code><code>}</code></pre> 
<p>co_await å±•å¼€ä¼šéº»çƒ¦ç‚¹ï¼Œå°¤å…¶æ˜¯await_suspend()åŒæ­¥çš„è¿”å›å€¼å«ä¹‰æ˜¯ä¸åŒçš„ã€‚è¿™é‡Œå…ˆä¸æ·±ç©¶ç¼–è¯‘å™¨ä»£ç å±•å¼€çš„æ›´å…·ä½“çš„ç»†èŠ‚äº†ï¼ŒåŸºæœ¬çš„åŸç†è§£é‡Šæ¸…æ¥šäº†å°±å…ˆæŠŠå…³æ³¨ç‚¹æ”¾åœ¨å¦‚ä½•åº”ç”¨ä¸Š[8]ã€‚</p> 
<p>ä¸Šæ–‡æåˆ°äº†åç¨‹å‡½æ•°è¿”å›çš„å¿…é¡»æ˜¯ä¸€ä¸ªç¬¦åˆè§„èŒƒçš„Promiseå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å†…éƒ¨å¿…é¡»æœ‰ä¸€ä¸ªPromise::promise_typeç±»å‹ï¼ˆåå­—ä¸èƒ½å˜ï¼Œä½†æ˜¯å¯ä»¥ç”¨åˆ«çš„åå­—å®šä¹‰åœ¨åˆ«å¤„ï¼Œåœ¨ç±»é‡Œé¢ using å£°æ˜ä¸ºè¿™ä¸ªåå­—ï¼‰ã€‚è¿™ä¸ªPromise::promise_typeç±»å‹å¿…é¡»å®ç°ä¸Šé¢æµç¨‹é‡Œè¯´çš„è¿™äº›å¿…å¤‡çš„å‡½æ•°ï¼Œå¦åˆ™ç¼–è¯‘ä¸é€šè¿‡ã€‚</p> 
<p>ä¸Šé¢æåˆ°äº†Awaiterå¯¹è±¡ä¸‰ä¸ªæ¥å£å‡½æ•°await_ready()ã€await_suspend()å’Œawait_resume()æ¥å£çš„è¡Œä¸ºï¼Œè¿™é‡Œå†™ä¸€ä¸ªä¾‹å­æ¥æ¼”ç¤ºï¼š</p> 
<p></p> 
<p></p> 
<pre><code>#include &lt;iostream&gt;</code><code>#include &lt;coroutine&gt;</code><code>#include &lt;future&gt;</code><code>#include &lt;thread&gt;</code>
<code>struct TaskPromise {<!-- --></code><code>    struct promise_type {<!-- --></code><code>        TaskPromise get_return_object() {<!-- --></code><code>            std::cout &lt;&lt; "get_return_object(), thread_id: " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</code><code>            return TaskPromise{std::coroutine_handle&lt;promise_type&gt;::from_promise(*this)};</code><code>        }</code><code>        std::suspend_always initial_suspend() noexcept { return {}; }</code><code>        std::suspend_always final_suspend() noexcept { return {}; }</code><code>        void unhandled_exception() {}</code><code>        void return_void() noexcept {}</code><code>        size_t data = 0;</code><code>    };</code><code>    std::coroutine_handle&lt;promise_type&gt; handle;</code><code>};</code>
<code>struct Awaiter {<!-- --></code><code>    bool await_ready() noexcept {<!-- --></code><code>        std::cout &lt;&lt; "await_ready(), thread_id: " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</code><code>        return false;</code><code>    }</code><code>    void await_suspend(std::coroutine_handle&lt;TaskPromise::promise_type&gt; handle) noexcept {<!-- --></code><code>        std::cout &lt;&lt; "await_suspend(), thread_id: " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</code><code>        auto thread = std::thread([=]() {<!-- --></code><code>            std::this_thread::sleep_for(std::chrono::seconds(1));</code><code>            handle.promise().data = 1;</code><code>            handle.resume();</code><code>        });</code><code>        thread.join();</code><code>    }</code><code>    void await_resume() noexcept {<!-- --></code><code>        std::cout &lt;&lt; "await_resume(), thread_id: " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</code><code>    }</code><code>};</code>
<code>TaskPromise task_func() {<!-- --></code><code>    std::cout &lt;&lt; "task_func() step 1, thread_id: " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</code><code>    co_await Awaiter{};</code><code>    std::cout &lt;&lt; "task_func() step 2, thread_id: " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</code><code>}</code>
<code>int main() {<!-- --></code><code>    std::cout &lt;&lt; "main(), thread_id: " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</code><code>    auto promise = task_func();</code><code>    std::cout &lt;&lt; "main(), data: " &lt;&lt; promise.handle.promise().data &lt;&lt; ", thread_id: " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</code><code>    promise.handle.resume();</code><code>    std::cout &lt;&lt; "main(), data: " &lt;&lt; promise.handle.promise().data &lt;&lt; ", thread_id: " &lt;&lt; std::this_thread::get_id() &lt;&lt; std::endl;</code>
<code>    return 0;</code><code>}</code></pre> 
<p>æ‰§è¡Œç»“æœå¦‚ä¸‹</p> 
<p></p> 
<p></p> 
<pre><code>main(), thread_id: 0x1d9d91ec0</code><code>get_return_object(), thread_id: 0x1d9d91ec0</code><code>main(), data: 0, thread_id: 0x1d9d91ec0</code><code>task_func() step 1, thread_id: 0x1d9d91ec0</code><code>await_ready(), thread_id: 0x1d9d91ec0</code><code>await_suspend(), thread_id: 0x1d9d91ec0</code><code>await_resume(), thread_id: 0x16dce7000</code><code>task_func() step 2, thread_id: 0x16dce7000</code><code>main(), data: 1, thread_id: 0x1d9d91ec0</code></pre> 
<p>ç»“åˆæ—¥å¿—å’Œä¸Šé¢çš„æµç¨‹è¯´æ˜å¾ˆå¥½ç†è§£è¿™æ®µä»£ç ã€‚ä»£ç é‡Œ 26 è¡Œè°ƒç”¨await_suspend()çš„handleå‚æ•°æ˜¯ç¼–è¯‘å™¨å¸®ç€ä¼ å…¥çš„ï¼ˆè¿™ä¸ª handle å°±ä¸€ä¸ªvoid *æŒ‡é’ˆï¼Œå€¼ä¼ é€’çš„æˆæœ¬å¾ˆä½ï¼‰ã€‚è€Œ 31 è¡Œä»£ç æ˜¯åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸Šè°ƒç”¨çš„ï¼Œè€Œåç»­çš„åç¨‹ä»£ç ä¹Ÿæ˜¯åœ¨å¦ä¸€ä¸ªçº¿ç¨‹è¿è¡Œçš„ã€‚è¿™ä¹Ÿæ­ç¤ºäº†åç¨‹çš„è·¨çº¿ç¨‹ä¼ é€’çš„èƒ½åŠ›ï¼Œåªè¦ä¼ é€’åç¨‹å¥æŸ„ï¼Œå°±å¯ä»¥å®ç°åœ¨ä»»æ„çº¿ç¨‹ä¸Šæ¢å¤åç¨‹çš„æ‰§è¡Œã€‚é‚£ä¹ˆå½“åç¨‹è·¨çº¿ç¨‹ä¼ é€’æ—¶ï¼Œçº¿ç¨‹å®‰å…¨çš„é—®é¢˜ä¾æ—§è¦æ³¨æ„ï¼Œè€Œä¸”å› ä¸ºæ‰§è¡Œæµå¯ä»¥ä»»æ„ç§»åŠ¨ï¼Œå› æ­¤å¸¦æ¥çš„å…¶ä»–åŒæ­¥é—®é¢˜éœ€è¦é¢å¤–æ³¨æ„ã€‚</p> 
<p></p> 
<p><strong>å®ç°ä¸€ä¸ªç®€å•çš„ generator</strong></p> 
<h4></h4> 
<p>generatorï¼ˆç”Ÿæˆå™¨ï¼‰åœ¨ Python/Js ç­‰è¯­è¨€é‡Œå·²ç»åº”ç”¨çš„å¾ˆå¸¸è§çš„ï¼Œåœ¨ C++20 ä¹‹å‰æ— æ³•ç®€å•çš„å®ç°ï¼Œåˆ©ç”¨ä¸Šé¢çš„åç¨‹æœºåˆ¶å¯ä»¥æ–¹ä¾¿çš„å†™å‡ºæ¥ç®€å•çš„å®ç°ã€‚</p> 
<p>ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªè·å–æ–æ³¢é‚£å¥‘æ•°åˆ—çš„éœ€æ±‚ï¼Œæ¯æ¬¡æ‹¿åˆ°æ•°åˆ—åç»­çš„ä¸€ä¸ªæ•°å­—ã€‚å¦‚æœç”¨ C++ æœ´ç´ å®ç°çš„è¯è¦æ€ä¹ˆåšï¼Ÿéœ€è¦å®šä¹‰ä¸€ä¸ªæ–æ³¢é‚£å¥‘æ•°åˆ—ç”Ÿæˆå™¨çš„ç±»ã€‚è¿™ä¸ªç±»æœ‰ä¸€ä¸ªå½¢å¦‚size_t next()çš„å‡½æ•°ï¼Œæ¯æ¬¡è°ƒç”¨å°±ä¼šè¿”å›ä¸‹ä¸€ä¸ªä¸ªæ•°å­—ï¼Œé‚£ä¹ˆç›¸å…³çš„å˜é‡å°±è¦ä¿å­˜åœ¨ç±»æˆå‘˜å˜é‡é‡Œï¼Œä»¥ä¾¿äºä¸‹ä¸€æ¬¡è°ƒç”¨next()å‡½æ•°æ—¶æ ¹æ®ä¹‹å‰çš„å€¼è®¡ç®—æœ¬æ¬¡éœ€è¦è¿”å›çš„å€¼ã€‚è¿™ä¸ªç±»çš„ä»£ç å¾ˆç®€å•ï¼Œè¿™é‡Œå°±ä¸å ç”¨ç¯‡å¹…äº†ã€‚è¿™é‡Œåªè´´åç¨‹å½¢å¼çš„å®ç°ï¼š</p> 
<p></p> 
<p></p> 
<pre><code>#include &lt;iostream&gt;</code><code>#include &lt;coroutine&gt;</code>
<code>template &lt;typename T&gt;</code><code>struct Generator {<!-- --></code><code>    struct promise_type {<!-- --></code><code>        Generator get_return_object() {<!-- --></code><code>            return Generator{std::coroutine_handle&lt;promise_type&gt;::from_promise(*this)};</code><code>        }</code><code>        std::suspend_always initial_suspend() noexcept { return {}; }</code><code>        std::suspend_always final_suspend() noexcept { return {}; }</code><code>        void unhandled_exception() {}</code><code>        void return_value(T t) noexcept {<!-- --></code><code>            v = t;</code><code>        }</code><code>        std::suspend_always yield_value(T t) {<!-- --></code><code>            v = t;</code><code>            return {};</code><code>        }</code><code>        T v{};</code><code>    };</code><code>    bool has_next() {<!-- --></code><code>        return !handle.done();</code><code>    }</code><code>    size_t next() {<!-- --></code><code>        handle.resume();</code><code>        return handle.promise().v;</code><code>    }</code><code>    std::coroutine_handle&lt;promise_type&gt; handle;</code><code>};</code>
<code>Generator&lt;size_t&gt; fib(size_t max_count) {<!-- --></code><code>    co_yield 1;</code><code>    size_t a = 0, b = 1, count = 0;</code><code>    while (++count &lt; max_count - 1) {<!-- --></code><code>        co_yield a + b;</code><code>        b = a + b;</code><code>        a = b - a;</code><code>    }</code><code>    co_return a + b;</code><code>}</code>
<code>int main() {<!-- --></code><code>    size_t max_count = 10;</code><code>    auto generator = fib(max_count);</code><code>    size_t i = 0;</code><code>    while (generator.has_next()) {<!-- --></code><code>        std::cout &lt;&lt; "No." &lt;&lt; ++i &lt;&lt; ": " &lt;&lt; generator.next() &lt;&lt; std::endl;</code><code>    }</code><code>    return 0;</code><code>}</code></pre> 
<p>ä»£ç è¿è¡Œç»“æœä¸ºï¼š</p> 
<p></p> 
<p></p> 
<pre><code>No.1: 1</code><code>No.2: 1</code><code>No.3: 2</code><code>No.4: 3</code><code>No.5: 5</code><code>No.6: 8</code><code>No.7: 13</code><code>No.8: 21</code><code>No.9: 34</code><code>No.10: 55</code></pre> 
<p>å‰æ–‡ä»‹ç»è¿‡co_awaitå’Œco_returnï¼Œæ–°å‡ºç°çš„æ ‡è¯†ç¬¦co_yieldç®—æ˜¯co_awaitçš„è¯­æ³•ç³–ï¼Œå¯ä»¥æ¯”co_awaitæ›´æ–¹ä¾¿çš„ä¼ é€’å‡ºæ¥ä¸€ä¸ªå€¼[9]ã€‚</p> 
<p>è¿™é‡Œçš„Generatorå®šä¹‰ä¸ºä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå¯ä»¥ç”¨äºå„ç§ç±»å‹çš„Generatorçš„å¿«é€Ÿå®šä¹‰ï¼Œå¦‚æœæœ‰å…¶ä»–éœ€æ±‚çš„è¯å°±å¯ä»¥å¿«é€Ÿå®ç°äº†ã€‚å½“ç„¶è¿™é‡Œçš„Generatorè€ƒè™‘çš„ä¸æ˜¯å¾ˆå…¨é¢ã€‚ä¸€èˆ¬è¿˜éœ€è¦è€ƒè™‘ handle å¯¹åº”çš„ coroutine state çš„ç”Ÿå‘½å‘¨æœŸè¦å’Œè¿”å›çš„ promise å¯¹è±¡ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦final_suspend()è¿”å›std::suspend_alwaysåï¼Œpromise éœ€è¦è‡ªå·±å»é‡Šæ”¾ handle å¯¹åº”çš„åç¨‹çš„ç›¸å…³å†…å­˜ã€‚ææ„å‡½æ•°é‡ŒåŠ ä¸Šé‡Šæ”¾é€»è¾‘åå°±éœ€è¦å®Œå–„Promiseç±»çš„æ„é€ ï¼Œæ‹·è´ç­‰å‡½æ•°ï¼ˆä¸‰äº”æ³•åˆ™ï¼‰ã€‚ç¨å¾®å®Œå–„ç‚¹çš„Generatorä»£ç å¦‚ä¸‹ï¼š</p> 
<p></p> 
<p></p> 
<pre><code>template &lt;typename T&gt;</code><code>class Generator {<!-- --></code><code>public:</code><code>    struct promise_type;</code><code>    using promise_handle_t = std::coroutine_handle&lt;promise_type&gt;;</code><code>    explicit Generator(promise_handle_t h) : handle(h) {}</code><code>    explicit Generator(Generator &amp;&amp;generator) : handle(std::exchange(generator.handle, {})) {}</code><code>    ~Generator() {<!-- --></code><code>        if (handle) {<!-- --></code><code>            handle.destroy();</code><code>        }</code><code>    }</code><code>    Generator(Generator &amp;) = delete;</code><code>    Generator &amp;operator=(Generator &amp;) = delete;</code>
<code>    struct promise_type {<!-- --></code><code>        Generator get_return_object() {<!-- --></code><code>            return Generator{std::coroutine_handle&lt;promise_type&gt;::from_promise(*this)};</code><code>        }</code><code>        std::suspend_always initial_suspend() noexcept { return {}; }</code><code>        std::suspend_always final_suspend() noexcept { return {}; }</code><code>        void unhandled_exception() {}</code><code>        void return_value(T t) noexcept {<!-- --></code><code>            v = t;</code><code>        }</code><code>        std::suspend_always yield_value(T t) {<!-- --></code><code>            v = t;</code><code>            return {};</code><code>        }</code><code>        T v{};</code><code>    };</code><code>    bool has_next() {<!-- --></code><code>        return !handle.done();</code><code>    }</code><code>    size_t next() {<!-- --></code><code>        handle.resume();</code><code>        return handle.promise().v;</code><code>    }</code><code>private:</code><code>    std::coroutine_handle&lt;promise_type&gt; handle;</code><code>};</code></pre> 
<p></p> 
<p>å®ç°è¿™ä¸ªgeneratoræ˜¯ä¸€æ¬¡æ€§å·¥ä½œï¼Œä¸€åŠ³æ°¸é€¸ã€‚å½“ç„¶å¦‚æœæ ‡å‡†åº“æœ‰std::generatoræ¨¡æ¿çš„è¯å°±æ›´çœäº‹äº†ï¼Œä½†æ˜¯è¿™ä¸ªæ„¿æœ›è¦ç­‰ C++23 æ‰ä¼šå®ç°ã€‚</p> 
<p>å¯èƒ½ä½ ä¼šè§‰å¾—å†™ä¸ªç®€å•çš„ç±»å»å®ç°ç›¸å…³çš„é€»è¾‘å¹¶ä¸å›°éš¾ã€‚ä½†æ˜¯è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœè¿™ä¸ªç®—æ³•å¾ˆå¤æ‚ï¼Œæ‰€éœ€è¦ä¿å­˜çš„å˜é‡å€¼æœ‰å¾ˆå¤šçš„è¯ã€‚å°†è¿™äº›å˜é‡æŠ½åˆ°æˆå‘˜å˜é‡é‡Œå¹¶ä¸”åœ¨next()å‡½æ•°é‡Œå®ç°é˜¶æ®µæ€§è¿”å›å°±ä¸é‚£ä¹ˆå®¹æ˜“äº†ï¼Œè€Œä¸”å†™å‡ºæ¥çš„ä»£ç ç»å¯¹æ²¡æœ‰è¿™ä¸ªåç¨‹ç‰ˆæœ¬å¥½ç»´æŠ¤ã€‚</p> 
<p>generatoréƒ½æœ‰äº†ï¼Œpython çš„å…¶ä»–å‡½æ•°å¼ç¼–ç¨‹çš„filterã€mapä¹‹ç±»çš„å‡½æ•°èƒ½å®ç°å—ï¼Ÿå½“ç„¶èƒ½ï¼Œä½†æ˜¯å°±åˆæ‰¯è¿œäº†ã€‚æœ¬æ–‡ä¸ç»§ç»­è®¨è®ºå‡½æ•°å¼äº†ï¼Œè¿˜æ˜¯å›åˆ°åç¨‹ä¸Šæ¥ã€‚</p> 
<p></p> 
<p><strong>é€šç”¨çš„åç¨‹è¿”å›ç±» Task</strong></p> 
<p>æˆªæ­¢ç›®å‰ï¼Œå·²ç»æœ‰ä¸€äº›åŸºäº C++20 åç¨‹åŸºç¡€æ”¯æŒçš„å¼€æºåç¨‹åº“å¼€æºäº†ï¼Œæ¯”å¦‚ cppcoro [10] ï¼Œfollyl é‡Œçš„åç¨‹åº“ coro [11]ã€ä»¥åŠæˆ‘å¸ï¼ˆé˜¿é‡Œå·´å·´ï¼‰å¼€æºçš„ async_simplep [12]ã€‚è¿™é‡Œæ‚„æ‚„è¯´ä¸€å¥ï¼Œasync_simple çš„åå­—èµ·çš„ä¸å¤Ÿâ€œé«˜å¤§ä¸Šâ€ï¼Œä½†æ˜¯ä»£ç è´¨é‡è¿˜æ˜¯ä¸é”™çš„ ğŸ˜„ã€‚</p> 
<p>è¿™äº›åç¨‹åº“éƒ½ä¼šæä¾›ä¸€äº›é€šç”¨çš„Coroutine Typesã€Awaitable Typesç­‰è¾…åŠ©ç±»ä»¥åŠä¸€äº›åŸºäº C++20 åç¨‹çš„é”ç­‰åŒæ­¥æœºåˆ¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°åç¨‹é€»è¾‘ã€‚è€Œè¿™äº›åŸºç¡€è®¾æ–½é‡Œï¼Œæœ€æœ€åŸºæœ¬çš„å°±æ˜¯ä¸€ä¸ªé€šç”¨çš„åç¨‹è¿”å›ç±»å‹Task&lt;T&gt;çš„å®ç°ã€‚</p> 
<p>ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡ä¸”æå…·å¯æ‰©å±•æ€§çš„Task&lt;T&gt;å®åœ¨æ˜¯å¤ªå¤æ‚äº†ï¼Œä½†æ˜¯ç®€å•çš„ä¸€ä¸ª demo è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ã€‚åœ¨å‚ï¼ˆæŠ„ï¼‰è€ƒï¼ˆè¢­ï¼‰äº†ä¸Šè¿°åç¨‹åº“çš„å¤§è‡´æ€è·¯ä»¥åŠå…¶ä»–å‚è€ƒæ–‡çŒ®åï¼Œè¿™é‡Œç»™å‡ºæ¥ä¸€ä¸ªç®€å•çš„å®ç°ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œå¿½ç•¥äº†æ‰€æœ‰ C++ å¼‚å¸¸çš„ä¿å­˜å’Œå¤„ç†ï¼ˆæˆ‘ä»¬å¹³æ—¶ C++ é¡¹ç›®ä¸€èˆ¬ä¹Ÿä¸è®©ä½¿ç”¨å¼‚å¸¸æœºåˆ¶ï¼Œæœ‰éé¢„æœŸå¼‚å¸¸éƒ½æ˜¯ç›´æ¥let it crashçš„ï¼‰ï¼š</p> 
<p></p> 
<p></p> 
<pre><code>#include &lt;iostream&gt;</code><code>#include &lt;functional&gt;</code><code>#include &lt;deque&gt;</code><code>#include &lt;optional&gt;</code><code>#include &lt;coroutine&gt;</code><code>#include &lt;thread&gt;</code>
<code>template &lt;typename T&gt;</code><code>class Task {<!-- --></code><code>public:</code><code>    struct promise_type;</code><code>    using promise_handle_t = std::coroutine_handle&lt;promise_type&gt;;</code>
<code>    explicit Task(promise_handle_t h) : handle(h) {}</code><code>    Task(Task &amp;&amp;task) noexcept : handle(std::exchange(task.handle, {})) {}</code><code>    ~Task() { if (handle) { handle.destroy(); } }</code>
<code>    template &lt;typename R&gt;</code><code>    struct task_awaiter {<!-- --></code><code>        explicit task_awaiter(Task&lt;R&gt; &amp;&amp;task) noexcept : task(std::move(task)) {}</code>
<code>        task_awaiter(task_awaiter &amp;) = delete;</code><code>        task_awaiter &amp;operator=(task_awaiter &amp;) = delete;</code>
<code>        bool await_ready() noexcept { return false; }</code><code>        void await_suspend(std::coroutine_handle&lt;&gt; handle) noexcept {<!-- --></code><code>            task.finally([handle]() { handle.resume(); });</code><code>        }</code><code>        R await_resume() noexcept { return task.get_result(); }</code>
<code>    private:</code><code>        Task&lt;R&gt; task;</code><code>    };</code>
<code>    struct promise_type {<!-- --></code><code>        Task get_return_object() {<!-- --></code><code>            return Task(promise_handle_t::from_promise(*this));</code><code>        }</code>
<code>        std::suspend_never initial_suspend() { return {}; }</code><code>        std::suspend_always final_suspend() noexcept { return {}; }</code>
<code>        template &lt;typename U&gt;</code><code>        task_awaiter&lt;U&gt; await_transform(Task&lt;U&gt; &amp;&amp;task) {<!-- --></code><code>            return task_awaiter&lt;U&gt;(std::move(task));</code><code>        }</code>
<code>        void unhandled_exception() {}</code>
<code>        void return_value(T t) {<!-- --></code><code>            data_ = t;</code><code>            notify_callbacks();</code><code>        }</code>
<code>        void on_completed(std::function&lt;void(T)&gt; &amp;&amp;callback) {<!-- --></code><code>            if (data_.has_value()) {<!-- --></code><code>                callback(data_.value());</code><code>            } else {<!-- --></code><code>                callbacks_.push_back(callback);</code><code>            }</code><code>        }</code>
<code>        T get() {<!-- --></code><code>            return data_.value();</code><code>        }</code>
<code>    private:</code><code>        void notify_callbacks() {<!-- --></code><code>            for (auto &amp;callback : callbacks_) {<!-- --></code><code>                callback(data_.value());</code><code>            }</code><code>            callbacks_.clear();</code><code>        }</code>
<code>        std::optional&lt;T&gt; data_;</code><code>        std::deque&lt;std::function&lt;void(T)&gt;&gt; callbacks_;</code><code>    };</code>
<code>    T get_result() {<!-- --></code><code>        return handle.promise().get();</code><code>    }</code>
<code>    void then(std::function&lt;void(T)&gt; &amp;&amp;callback) {<!-- --></code><code>        handle.promise().on_completed([callback](auto data) {<!-- --></code><code>            callback(data);</code><code>        });</code><code>    }</code>
<code>    void finally(std::function&lt;void()&gt; &amp;&amp;callback) {<!-- --></code><code>        handle.promise().on_completed([callback](auto result) {<!-- --></code><code>            callback();</code><code>        });</code><code>    }</code>
<code>private:</code><code>    promise_handle_t handle;</code><code>};</code>
<code>Task&lt;int&gt; task1() {<!-- --></code><code>    std::cout &lt;&lt; "task1 run" &lt;&lt; std::endl;</code><code>    co_return 1;</code><code>}</code>
<code>Task&lt;int&gt; task2() {<!-- --></code><code>    std::cout &lt;&lt; "task2 run" &lt;&lt; std::endl;</code><code>    co_return 2;</code><code>}</code>
<code>Task&lt;int&gt; call_task() {<!-- --></code><code>    std::cout &lt;&lt; "call_task" &lt;&lt; std::endl;</code><code>    int data1 = co_await task1();</code><code>    std::cout &lt;&lt; "call_task task1 data: " &lt;&lt; data1 &lt;&lt; std::endl;</code><code>    int data2 = co_await task2();</code><code>    std::cout &lt;&lt; "call_task task2 data: " &lt;&lt; data2 &lt;&lt; std::endl;</code><code>    co_return data1 + data2;</code><code>}</code>
<code>int main() {<!-- --></code><code>    Task&lt;int&gt; task = call_task();</code><code>    task.then([](int data) {<!-- --></code><code>        std::cout &lt;&lt; "call_task data: " &lt;&lt; data &lt;&lt; std::endl;</code><code>    });</code><code>    return 0;</code><code>}</code></pre> 
<p>ä»£ç æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p> 
<p></p> 
<p></p> 
<pre><code>call_task</code><code>task1 run</code><code>call_task task1 data: 1</code><code>task2 run</code><code>call_task task2 data: 2</code><code>call_task data: 3</code></pre> 
<p>å¯ä»¥åœ¨æºç çš„å‡½æ•°é‡Œåƒä¹‹å‰çš„ demo é‡ŒåŠ ç‚¹æ—¥å¿—å»ç†è§£æµç¨‹ï¼ˆæˆ–è€…ç›´æ¥ä½¿ç”¨è°ƒè¯•å™¨å•æ­¥è·Ÿè¸ªï¼‰ã€‚å®é™…ä¸Šè¿™ä¸ª demo æ²¡æœ‰å®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„ç­‰å¾…å’Œå”¤é†’ï¼ˆç”šè‡³æœ‰äº›å”¤é†’çš„é€»è¾‘éƒ½æ²¡è¿è¡Œåˆ°ï¼‰ã€‚ç‰¹åˆ«åœ°ï¼Œå¦‚æœè¿™äº›åç¨‹ä»»åŠ¡éœ€è¦è¢«è°ƒåº¦åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„è¯ï¼Œè¿˜è¦è€ƒè™‘è¿™äº›å¯¹è±¡å†…éƒ¨æ•°æ®ç»“æ„çš„å¹¶å‘å®‰å…¨æ€§ï¼ˆç›´æ¥ä½¿ç”¨std::mutexå†™ä¸å¥½å°±æ¯”æ™®é€šçš„å‡½æ•°æ›´å®¹æ˜“å‡ºç°æ­»é”äº† ï¼‰ã€‚å¦å¤–è¿™ä¸ª demo ä¹Ÿæ­ç¤ºäº†ä¸€æ—¦ä½¿ç”¨äº†C++20 çš„åç¨‹å¼‚æ­¥æ‰‹æ®µï¼Œä»å…¥å£å¼€å§‹è¦ä¸€ç›´æ”¹é€ ä¸‹å»ï¼Œæœ€ç»ˆã€Œä¼ æŸ“ã€åˆ°æ•´ä¸ªé¡¹ç›®çš„æ‰€æœ‰å¼‚æ­¥å‡½æ•°ã€‚</p> 
<p>å¦‚æœä½ æœ‰è€å¿ƒè¯»åˆ°è¿™é‡Œçš„è¯ï¼Œåº”è¯¥ç®—æ˜¯å¯¹ C++20 çš„åç¨‹å‹‰å¼ºã€Œå…¥é—¨ã€äº†ã€‚å°±å¯ä»¥èƒ½ä»¥è¿™ä¸ªæ–‡ç« ä¸ºè·³æ¿å»é˜…è¯»å…¶ä»–èµ·ç‚¹æ›´é«˜çš„æ–‡ç« äº†ã€‚ä»¥ç›®å‰ C++ æ ‡å‡†åº“æä¾›çš„æ”¯æŒè¦æ‰‹æ“ä¸€ä¸ªç”Ÿäº§ç¯å¢ƒçš„åç¨‹æ¡†æ¶è¿˜æ˜¯æ¯”è¾ƒå›°éš¾çš„ã€‚è¿™é‡Œæ¨èä½ é˜…è¯» async_simple çš„æ–‡æ¡£ [13] ä»¥åŠè¿™ä¸¤ç¯‡æºç åˆ†ææ–‡ç«  [14] [15]ã€‚ä¹Ÿå¯ä»¥å›è¿‡å¤´å»é˜…è¯»æœ€ç»å…¸çš„è¿™ä¸ªåç¨‹ç³»åˆ—æ–‡ç«  [0]ï¼Œè¯»å®Œäº†è¿™ç¯‡æ–‡ç« åï¼Œè¿™ä¸ªç³»åˆ—æ–‡ç« å·²ç»ä¸æ˜¯é‚£ä¹ˆéš¾å•ƒäº†ã€‚</p> 
<p>å†™åœ¨åé¢</p> 
<h3></h3> 
<p>æ–‡ç« åœ¨è¿™é‡Œç»“æŸå¾ˆä¸è¿‡ç˜¾ï¼Œåƒæ˜¯åˆšæ¨å¼€é—¨åˆæ‰­å¤´å¿«é€Ÿç¦»å¼€äº†ã€‚ä½†å¦‚æœä»¥C++ 20/23 æ ‡å‡†åç¨‹è½åœ°çš„æƒ…å†µçœ‹ï¼Œè¿™ç¯‡æ–‡ç« å…¶å®ä¹Ÿè¯¥co_yieldäº†ã€‚æ¯•ç«Ÿå†å†™ä¸‹å»å°±æ˜¯ä»‹ç»å…¶ä»–äºŒæ–¹åº“ä¸‰æ–¹åº“çš„å®ç°æ€è·¯äº†ã€‚è¿˜æ˜¯ç­‰ C++26 å®Œå…¨è½åœ°å§ï¼Œåˆ°æ—¶å€™çœ‹å¿ƒæƒ…å¯èƒ½ä¼šç»§ç»­handle.resume()Â å®Œæˆåç»­çš„å†…å®¹ã€‚åˆ°é‚£ä¸ªæ—¶å€™ï¼Œä½¿ç”¨ C++ æ ‡å‡†åº“çš„åç¨‹å®ç°ä¸€äº›ä¸œè¥¿çš„éš¾åº¦åº”è¯¥ä¼šä¸‹é™ä¸€ä¸ªæ•°é‡çº§ï¼ˆä½†æ„¿ï¼‰ã€‚</p> 
<h3><strong>å‚è€ƒæ–‡çŒ®ï¼š</strong></h3> 
<p>[0] å¾ˆå¤šäººæ¨èÂ https://lewissbaker.github.io/ï¼Œè¿™ç®—æ˜¯æœ€æ—©æœ€å…¨é¢çš„èµ„æ–™ï¼Œå€¼å¾—ä¸€è¯»ã€‚<br> [1] x86 calling conventions,Â https://en.wikipedia.org/wiki/X86_calling_conventions<br> [2] è¿™å¥è¯çš„èƒŒæ™¯æ˜¯å•æ ¸ CPU æ—¶ä»£ï¼Œå½“æ—¶è¿˜æ²¡æœ‰å¤šä¸ªæ‰§è¡Œæµæå‡æ€§èƒ½çš„ç”¨é€”ã€‚<br> [3] Complier Explorer,Â https://godbolt.org/<br> [4] demo ä»£ç åœ¨ï¼šhttps://godbolt.org/z/vdnY1GEoT<br> [5] cppreference Coroutines,Â https://en.cppreference.com/w/cpp/language/coroutines<br> [6] æ³¨æ„æ˜¯å€¼æ‹·è´ï¼Œå³å¦‚æœæ˜¯æŒ‡é’ˆ/å¼•ç”¨ï¼Œéœ€è¦è°ƒç”¨æ–¹ä¿è¯å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå¤§äºåç¨‹çš„ç”Ÿå‘½å‘¨æœŸ<br> [7] æ³¨æ„è¿™é‡Œçš„Promiseå’Œçº¿ç¨‹åº“é‡Œçš„std::promise æ²¡ä»€ä¹ˆå…³ç³»ã€‚<br> [8] Lewis Baker çš„ç¬¬äº”ç¯‡åšæ–‡è¯¦ç»†è®²äº†ç¼–è¯‘å™¨ç”Ÿæˆä»£ç ,Â https://lewissbaker.github.io/2022/08/27/understanding-the-compiler-transform<br> [9] æ–‡ä¸­æœªæ¼”ç¤ºä½¿ç”¨co_awaitä¼ é€’ä¸€ä¸ªå€¼çš„æ–¹æ³•ï¼Œé€šå¸¸çš„æ–¹å¼æ˜¯ä¸ºco_awaitåé¢è¿”å›çš„ç±»å‹Tå®šä¹‰await_transform(T t)å‡½æ•°ï¼Œç±»ä¼¼ç¤ºä¾‹é‡Œä¸ºco_yieldå®šä¹‰çš„yield_value()å‡½æ•°ã€‚ä¼ é€’ä¸€ä¸ªå€¼è¿˜æ˜¯å»ºè®®ä½¿ç”¨co_yieldæ¥è¿›è¡Œï¼Œè€Œä¸ä½¿ç”¨co_awaitè¿ç®—ç¬¦ï¼ˆæ²¡é”™ï¼Œå®ƒæ˜¯ä¸ªè¿ç®—ç¬¦ï¼Œå¯ä»¥è¢«é‡è½½ï¼‰ã€‚<br> [10] cppcoroï¼Œhttps://github.com/lewissbaker/cppcoro, ä½†æ˜¯ä½œè€…ä¸ç»´æŠ¤äº†ï¼Œå»ç©std::executionäº†,å¸Œæœ› C++26 èƒ½æœ‰å¯ä»¥ç”¨çš„std::executionå§ã€‚<br> [11] folly coro,Â https://github.com/facebook/folly/tree/main/folly/experimental/coro<br> [12] async_simple,Â https://github.com/alibaba/async_simple<br> [13] async_simple doc:Â https://alibaba.github.io/async_simple/docs.cn/GetStarted.html<br> [14] async_simple æºç åˆ†æï¼ˆä¸Šï¼‰,Â https://zhuanlan.zhihu.com/p/619684326<br> [15] async_simple æºç åˆ†æï¼ˆä¸‹ï¼‰,Â https://zhuanlan.zhihu.com/p/619998880</p> 
<p></p> 
<p></p> 
<p></p> 
<ol><li> <p>è°ƒç”¨operator newç”³è¯·ç©ºé—´å¹¶åˆå§‹åŒ–åç¨‹çŠ¶æ€ï¼ˆCoroutine Stateï¼‰ï¼Œåç¨‹çŠ¶æ€æ˜¯ç¼–è¯‘å™¨æ ¹æ®åç¨‹å‡½æ•°è‡ªåŠ¨ç”Ÿæˆçš„ç±»ï¼Œæ¯ä¸ªä¸åŒçš„åç¨‹éƒ½å¾—ç”Ÿæˆå•ç‹¬çš„ã€‚</p> </li><li> <p>å¤åˆ¶/ç§»åŠ¨è°ƒç”¨åç¨‹å‡½æ•°çš„å‚æ•°åˆ°åç¨‹çŠ¶æ€å¯¹è±¡é‡Œï¼ˆå‚æ•°è¦ä¿å­˜åˆ°å †é‡Œæ‰èƒ½åœ¨åˆ‡æ¢æ—¶ä¿ç•™ï¼‰[6]ï¼Œå¦å¤–è¿™ä¸ªå‡½æ•°ä½“å†…éƒ¨å¦‚æœå®šä¹‰äº†å…¶ä»–æ ˆä¸Šå˜é‡ï¼Œä¹Ÿéœ€è¦æ”¾åˆ°å †ä¸Šï¼ˆdemo é‡Œæ²¡æœ‰å®šä¹‰ï¼‰ã€‚è¿™æ˜¯é ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†æå®Œæˆçš„ï¼Œæœ‰äº›ä¸ä¾èµ–ç¼–è¯‘å™¨å®ç°çš„â€œStackless C/C++â€åç¨‹åº“ä¼šç»™ä¸ªå‡½æ•°åˆ›å»ºä¸´æ—¶å˜é‡ï¼ˆåˆ†é…åœ¨å †ä¸Šï¼‰ã€‚å½“ç„¶è¿˜æ˜¯ç¼–è¯‘å™¨åŸç”Ÿæ”¯æŒä¼šç®€å•è‡ªç„¶å¾ˆå¤šã€‚è¿™é‡Œå¼•ç”³ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæŸäº›ä¸´æ—¶å¯¹è±¡åœ¨åç¨‹è¿”å›æ—¶å·²ç»ç¦»å¼€äº†ä½œç”¨åŸŸè€Œç†è®ºä¸Šä¸éœ€è¦æ•è·ï¼Œæ˜¯ä¸æ˜¯ä¸ç”¨é¢å¤–ä¿å­˜å‘¢ï¼Ÿæ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥ææ„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œï¼Œå› ä¸º C++ æœ‰ä¸ªè§„åˆ™æ˜¯å¯¹è±¡çš„ææ„é¡ºåºæ˜¯æ„é€ çš„åé¡ºåºã€‚æ‰€ä»¥ä¸€æ—¦ä¸­é—´çš„æŸä¸ªå¯¹è±¡è¢«ä¿å­˜åœ¨å †ä¸Šï¼Œå°±å¯èƒ½è¢«è¿«ä¿å­˜æ›´å¤šçš„å¯¹è±¡ä»¥ä¿è¯ææ„é¡ºåºï¼ˆå¸Œæœ›åç»­æ ‡å‡†èƒ½ä¿®è®¢åç¨‹å‡½æ•°åœ¨è¿™é‡Œçš„è¡Œä¸ºè§„èŒƒï¼Œå¯ä»¥æå‡æ€§èƒ½ï¼‰ã€‚</p> </li><li> <p>æ„é€ åç¨‹çš„Promise::promise_typeå¯¹è±¡ï¼ˆä¹Ÿä¿å­˜åœ¨åç¨‹çŠ¶æ€é‡Œï¼‰ã€‚Promiseå¯¹è±¡æ˜¯ C++ è§„å®šçš„åç¨‹çš„è¿”å›å€¼å¯¹è±¡ï¼Œå¯¹åº”ä¸Šé¢ demo ä»£ç é‡Œçš„TaskPromise ç±» [7]ã€‚å¦‚æœç”¨æˆ·å®šä¹‰çš„Promise::promise_typeæœ‰æ¥å—æ‰€æœ‰åç¨‹å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œåˆ™è°ƒç”¨è¯¥æ„é€ å‡½æ•°æ„é€ ã€‚å¦åˆ™è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°æ„é€ ã€‚éšåè°ƒç”¨promise_type.get_return_object()å‡½æ•°åˆ›å»ºåç¨‹å‡½æ•°çš„è¿”å›å€¼å¯¹è±¡TaskPromiseã€‚è¯¥å¯¹è±¡ä¼šåœ¨åç¨‹é¦–æ¬¡æŒ‚èµ·æ—¶è¿”å›åˆ°è°ƒç”¨åç¨‹å‡½æ•°çš„ä½ç½®ã€‚coroutine_handle&lt;promise_type&gt;å’Œpromise_typeæ˜¯å¯ä»¥ä½¿ç”¨handle::from_promise()å’Œhandle.promise()æ¥å£ç›¸äº’è½¬æ¢çš„ï¼ˆæš‚æ—¶ä¸ç”¨æ·±ç©¶åŸç†ï¼Œè¿™æ¶‰åŠåˆ°ä¸€äº›ç¼–è¯‘å™¨ builtin çš„å®ç°ï¼Œå’Œå…·ä½“å¯¹è±¡çš„å†…å­˜å¸ƒå±€æœ‰å…³ç³»ï¼‰ã€‚åç¨‹å¥æŸ„ï¼ˆstd::coroutine_handle&lt;&gt;ï¼‰æ˜¯ä¸€ä¸ªå¯ä»¥æ“ä½œåç¨‹çš„å¯¹è±¡ï¼ˆç±»ä¼¼å¯ä»¥æ“ä½œçº¿ç¨‹çš„std::threadå¯¹è±¡ä¸€æ ·ï¼‰ã€‚ä¸ºäº†åç¨‹å‡½æ•°å¯ä»¥åƒæ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ ·å»è°ƒç”¨ï¼Œæ‰€ä»¥è¿™ä¸ª handle çš„è·å–æ–¹å¼å°±æœ‰äº›åˆ«æ‰­ã€‚</p> </li><li> <p>è°ƒç”¨Promise::promise_type.initial_suspend()ï¼Œåè€…ä¼šè¿”å›ä¸€ä¸ªawaitableçš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æœ‰ä¸‰ä¸ªå®šä¹‰å¥½çš„æˆå‘˜å‡½æ•°ï¼Œè¿™é‡Œåªéœ€è¦çŸ¥é“await_ready()æˆå‘˜è¿”å› true æ—¶ä¸è¿›è¡Œé»˜è®¤æŒ‚èµ·å¹¶ç«‹å³è°ƒç”¨await_resume()å‡½æ•°ï¼Œå¦åˆ™ç«‹å³æŒ‚èµ·åç¨‹å¹¶è°ƒç”¨await_suspend()å‡½æ•°å³å¯ã€‚å› ä¸ºå¾ˆå¤šæ—¶å€™çš„co_awaitåªéœ€è¦çŸ¥é“è¦ä¸è¦ç«‹å³æ‰§è¡Œå°±è¡Œï¼Œæ‰€ä»¥æ ‡å‡†åº“æä¾›äº†é»˜è®¤çš„Awaiterå®ç°ï¼šstd::suspend_neverå’Œstd::suspend_alwaysç±»ã€‚å‰è€…æ°¸è¿œä¸æŒ‚èµ·ï¼Œåè€…æ°¸è¿œæŒ‚èµ·ã€‚è¿™é‡Œä¸ºä»€ä¹ˆæè¿™ä¹ˆå¤æ‚ï¼Ÿç­”æ¡ˆæ˜¯ä¸ºäº†å¯æ‰©å±•æ€§ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªè¿”å›çš„å¯¹è±¡æ¥æ§åˆ¶ä¸€ä¸ªåç¨‹åˆ›å»ºåæ˜¯ç«‹å³æ‰§è¡Œè¿˜æ˜¯ç«‹å³æŒ‚èµ·ï¼Œä»¥åŠæ‰§è¡Œå‰æ˜¯å¦è¦é¢å¤–åšä¸€äº›æ“ä½œï¼Œå¯ä»¥è®©ç”¨æˆ·æ–¹ä¾¿çš„æ”¯æŒåç¨‹çš„è°ƒåº¦æœºåˆ¶ã€‚é¡ºä¾¿è¯´ä¸€å¥ï¼Œdemo é‡Œçš„await_resume()å‡½æ•°è¿”å›å€¼æ˜¯ voidï¼Œä½†å…¶å®å¯ä»¥è¿”å›ä»»æ„ç±»å‹ï¼Œè¯¥è¿”å›å€¼ä½œä¸ºco_awaitè¡¨è¾¾å¼çš„è¿”å›å€¼ï¼ˆdemo é‡Œæ²¡è¿”å›ï¼‰ã€‚å¦å¤– demo é‡Œçš„await_suspend()å‡½æ•°è¿”å›çš„æ˜¯ void ç±»å‹ï¼Œä½†å®é™…ä¸Šå¯ä»¥è¿”å› bool ç±»å‹ï¼ˆè¿”å› false åˆä¼šå˜æˆä¸æŒ‚èµ·ï¼‰ç”šè‡³å…¶ä»–åç¨‹çš„coroutine_handleå¯¹è±¡ï¼Œæ­¤æ—¶ä¼šåˆ‡æ¢åˆ°è¯¥åç¨‹å»æ‰§è¡Œã€‚è¿™å°±æœ‰äº†åˆ‡æ¢å’Œè°ƒåº¦çš„åŸºç¡€æ”¯æŒäº†ï¼Œåé¢ä¼šè¯¦ç»†èŠè¿™ä¸ªæœºåˆ¶ã€‚</p> </li><li> <p>æ ¹æ® 4 çš„é€‰æ‹©æ˜¯ç›´æ¥æ‰§è¡Œè¿˜æ˜¯æŒ‚èµ·ï¼Œç›´æ¥æŒ‚èµ·çš„è¯å°±ç«‹å³è¿”å›Promiseå¯¹è±¡ç»™è°ƒç”¨è€…ï¼Œå¦åˆ™è¦ç­‰åˆ°åç¨‹æ˜¾å¼æŒ‚èµ·æˆ–è€…æ‰§è¡Œå®Œæˆæ‰ä¼šè¿”å›è°ƒç”¨è€…ã€‚demo é‡Œæ˜¯é»˜è®¤ä¸æŒ‚èµ·ï¼Œç­‰ç¬¬ä¸€æ¬¡æŒ‚èµ·æ—¶æ‰è¿”å›ç»™è°ƒç”¨è€…ã€‚è°ƒç”¨è€…ç«‹å³resume()äº†è¿™ä¸ªåç¨‹å‡½æ•°ï¼Œç„¶ååç¨‹å‡½æ•°æ‰§è¡Œå®Œæˆé€€å‡ºã€‚ä¸Šé¢çš„ä»£ç æ²¡æœ‰æ˜¾å¼çš„å†™è¿”å›è¯­å¥ï¼Œç¼–è¯‘å™¨ä¼šåœ¨æœ€åè¡¥ä¸Šco_returnï¼Œco_returnä¼šè°ƒç”¨ promise.return_void()å‡½æ•°ã€‚è¿™é‡Œæ²¡è¿”å›å€¼ï¼Œå¦‚æœco_returnè¿”å›äº†ä¸€ä¸ªå€¼T tçš„è¯ï¼Œå°±éœ€è¦å®šä¹‰ä¸€ä¸ªå«void return_value(T t)çš„å‡½æ•°ï¼Œreturn_value()å’Œreturn_void()ä¸èƒ½å…±å­˜ã€‚</p> </li><li> <p>æœ€åç¼–è¯‘å™¨è°ƒç”¨co_await Promise::promise_type.final_suspend()å‡½æ•°ç»“æŸåç¨‹ï¼ˆæ— è®ºæ˜¯æŠ›å¼‚å¸¸ç»“æŸè¿˜æ˜¯æ­£å¸¸é€€å‡ºéƒ½ä¼šè°ƒç”¨ï¼‰ã€‚æ³¨æ„final_suspend()è¿”å›çš„åˆæ˜¯ä¸€ä¸ªawaitableçš„å¯¹è±¡ï¼Œä½†æ˜¯è¿™é‡Œç”¨std::suspend_always()Â è¿”å›â€œæŒ‚èµ·â€æ—¶åç¨‹ä¸ä¼šç«‹å³é”€æ¯å†…éƒ¨çš„çŠ¶æ€ä¿¡æ¯ï¼ˆå¦åˆ™ç›´æ¥é”€æ¯ï¼‰ï¼Œå› ä¸ºæœ‰éƒ¨åˆ†ä¿¡æ¯è¿˜ä¿å­˜åœ¨promiseé‡Œå‘¢ã€‚æœ€ä½³å®è·µæ˜¯è‡ªå·±åœ¨Promiseçš„ææ„å‡½æ•°é‡Œå†™coroutine_handle&lt;&gt;.destroy()ã€‚è®©handleçš„ç”Ÿå‘½å‘¨æœŸå’ŒPromiseå¯¹è±¡ä¸€è‡´æ¯”è¾ƒå¥½ï¼Œå¦åˆ™åç¨‹é€€å‡ºåå†æ“ä½œPromiseå¯¹è±¡å°±æ˜¯ UAF äº†ï¼ˆè¿™ä¸ª demo ç›®å‰ä¸éœ€è¦ï¼Œæ‰€ä»¥ç®€å•èµ·è§æ²¡è¿™ä¹ˆå¤„ç†ï¼‰ã€‚</p> </li><li> <p>è‡³äºpromise.unhandled_exception()ï¼Œæ˜¯åœ¨åç¨‹é‡Œå‡ºç°æœªæ•è·çš„å¼‚å¸¸æ—¶å€™è°ƒç”¨çš„ã€‚ä½†æ˜¯æ³¨æ„åœ¨promise.get_return_object()ä¹‹å‰å°±æŠ›å‡ºçš„å¼‚å¸¸ä¸ä¼šæ¥åˆ°è¿™é‡Œï¼Œæ¯”å¦‚newå¯¼è‡´çš„std::bad_allocå¼‚å¸¸å°±ä¸ä¼šè°ƒç”¨åˆ°è¿™é‡Œã€‚å¼‚å¸¸å¤„ç†æµç¨‹ä¸è¯¦ç»†è§£é‡Šäº†ï¼Œcppreference æè¿°çš„å¾ˆæ¸…æ¥šã€‚</p> </li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6881add97d162774cd56e856e42a3d05/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">ç›‘æ§è®¾å¤‡IPåœ°å€æ˜¯å¦‚ä½•è®¾ç½®çš„</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/74902249eed2c502a0cfb35aa5e2d90c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">OpenCV-Python(21)ï¼šè½®å»“å±‚æ¬¡ç»“æ„</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 ç¼–ç¨‹éšæƒ³.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>