<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android OkHttp完全解析 是时候来了解OkHttp了 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android OkHttp完全解析 是时候来了解OkHttp了" />
<meta property="og:description" content="转载请标明出处： http://blog.csdn.net/lmj623565791/article/details/47911083； 本文出自:【张鸿洋的博客】
一、概述 最近在群里听到各种讨论okhttp的话题，可见okhttp的口碑相当好了。再加上Google貌似在6.0版本里面删除了HttpClient相关API，对于这个行为不做评价。为了更好的在应对网络访问，学习下okhttp还是蛮必要的，本篇博客首先介绍okhttp的简单使用，主要包含：
一般的get请求一般的post请求基于Http的文件上传文件下载加载图片支持请求回调，直接返回对象、对象集合支持session的保持 最后会对上述几个功能进行封装，完整的封装类的地址见：https://github.com/hongyangAndroid/okhttp-utils
使用前，对于Android Studio的用户，可以选择添加:
compile &#39;com.squareup.okhttp:okhttp:2.4.0&#39; 或者Eclipse的用户，可以下载最新的jar okhttp he latest JAR ，添加依赖就可以用了。
注意:okhttp内部依赖okio，别忘了同时导入okio：
gradle: compile &#39;com.squareup.okio:okio:1.5.0&#39;
最新的jar地址：okio the latest JAR 二、使用教程 （一）Http Get 对了网络加载库，那么最常见的肯定就是http get请求了，比如获取一个网页的内容。
//创建okHttpClient对象 OkHttpClient mOkHttpClient = new OkHttpClient(); //创建一个Request final Request request = new Request.Builder() .url(&#34;https://github.com/hongyangAndroid&#34;) .build(); //new call Call call = mOkHttpClient.newCall(request); //请求加入调度 call.enqueue(new Callback() { @Override public void onFailure(Request request, IOException e) { } @Override public void onResponse(final Response response) throws IOException { //String htmlStr = response." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/161188e87319b67fa92e8c3fc6f69f25/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-08-24T15:36:45+08:00" />
<meta property="article:modified_time" content="2015-08-24T15:36:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android OkHttp完全解析 是时候来了解OkHttp了</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>转载请标明出处： <br> <a href="http://blog.csdn.net/lmj623565791/article/details/47911083">http://blog.csdn.net/lmj623565791/article/details/47911083</a>； <br> 本文出自:<a href="http://blog.csdn.net/lmj623565791/">【张鸿洋的博客】</a></p> 
</blockquote> 
<h4 id="一概述">一、概述</h4> 
<p>最近在群里听到各种讨论okhttp的话题，可见okhttp的口碑相当好了。再加上Google貌似在6.0版本里面删除了HttpClient相关API，对于这个行为不做评价。为了更好的在应对网络访问，学习下okhttp还是蛮必要的，本篇博客首先介绍okhttp的简单使用，主要包含：</p> 
<ul><li>一般的get请求</li><li>一般的post请求</li><li>基于Http的文件上传</li><li>文件下载</li><li>加载图片</li><li>支持请求回调，直接返回对象、对象集合</li><li>支持session的保持</li></ul> 
<p>最后会对上述几个功能进行封装，完整的封装类的地址见：<a href="https://github.com/hongyangAndroid/okhttp-utils">https://github.com/hongyangAndroid/okhttp-utils</a></p> 
<p>使用前，对于Android Studio的用户，可以选择添加:</p> 
<pre class="prettyprint"><code class="language-xml hljs ">compile 'com.squareup.okhttp:okhttp:2.4.0'</code></pre> 
<p>或者Eclipse的用户，可以下载最新的jar <a href="https://search.maven.org/remote_content?g=com.squareup.okhttp&amp;a=okhttp&amp;v=LATEST" rel="nofollow">okhttp he latest JAR </a>，添加依赖就可以用了。</p> 
<p>注意:okhttp内部依赖okio，别忘了同时导入okio：</p> 
<p>gradle: <code>compile 'com.squareup.okio:okio:1.5.0'</code></p> 
<p>最新的jar地址：<a href="https://search.maven.org/remote_content?g=com.squareup.okio&amp;a=okio&amp;v=LATEST" rel="nofollow">okio the latest JAR </a></p> 
<hr> 
<h4 id="二使用教程">二、使用教程</h4> 
<h5 id="一http-get">（一）Http Get</h5> 
<p>对了网络加载库，那么最常见的肯定就是http get请求了，比如获取一个网页的内容。</p> 
<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-comment">//创建okHttpClient对象</span>
OkHttpClient mOkHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
<span class="hljs-comment">//创建一个Request</span>
<span class="hljs-keyword">final</span> Request request = <span class="hljs-keyword">new</span> Request.Builder()
                .url(<span class="hljs-string">"https://github.com/hongyangAndroid"</span>)
                .build();
<span class="hljs-comment">//new call</span>
Call call = mOkHttpClient.newCall(request); 
<span class="hljs-comment">//请求加入调度</span>
call.enqueue(<span class="hljs-keyword">new</span> Callback()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span>(Request request, IOException e)
            {
            }

            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(<span class="hljs-keyword">final</span> Response response) <span class="hljs-keyword">throws</span> IOException
            {
                    <span class="hljs-comment">//String htmlStr =  response.body().string();</span>
            }
        });             

</code></pre> 
<ol><li><p>以上就是发送一个get请求的步骤，首先构造一个Request对象，参数最起码有个url，当然你可以通过Request.Builder设置更多的参数比如：<code>header</code>、<code>method</code>等。</p></li><li><p>然后通过request的对象去构造得到一个Call对象，类似于将你的请求封装成了任务，既然是任务，就会有<code>execute()</code>和<code>cancel()</code>等方法。</p></li><li><p>最后，我们希望以异步的方式去执行请求，所以我们调用的是call.enqueue，将call加入调度队列，然后等待任务执行完成，我们在Callback中即可得到结果。</p></li></ol> 
<p>看到这，你会发现，整体的写法还是比较长的，所以封装肯定是要做的，不然每个请求这么写，得累死。</p> 
<p>ok，需要注意几点：</p> 
<ul><li><p>onResponse回调的参数是response，一般情况下，比如我们希望获得返回的字符串，可以通过<code>response.body().string()</code>获取；如果希望获得返回的二进制字节数组，则调用<code>response.body().bytes()</code>；如果你想拿到返回的inputStream，则调用<code>response.body().byteStream()</code> </p> <p>看到这，你可能会奇怪，竟然还能拿到返回的inputStream，看到这个最起码能意识到一点，这里支持大文件下载，有inputStream我们就可以通过IO的方式写文件。不过也说明一个问题，这个<code>onResponse</code>执行的线程并不是UI线程。的确是的，如果你希望操作控件，还是需要使用handler等，例如：</p> <pre class="prettyprint"><code class="language-java hljs "><span class="hljs-annotation">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(<span class="hljs-keyword">final</span> Response response) <span class="hljs-keyword">throws</span> IOException
{
      <span class="hljs-keyword">final</span> String res = response.body().string();
      runOnUiThread(<span class="hljs-keyword">new</span> Runnable()
      {
          <span class="hljs-annotation">@Override</span>
          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()
          {
            mTv.setText(res);
          }

      });
}</code></pre></li><li>我们这里是异步的方式去执行，当然也支持阻塞的方式，上面我们也说了Call有一个<code>execute()</code>方法，你也可以直接调用<code>call.execute()</code>通过返回一个<code>Response</code>。</li></ul> 
<hr> 
<h5 id="二-http-post-携带参数">(二) Http Post 携带参数</h5> 
<p>看来上面的简单的get请求，基本上整个的用法也就掌握了，比如post携带参数，也仅仅是Request的构造的不同。</p> 
<pre class="prettyprint"><code class="language-java hljs ">Request request = buildMultipartFormRequest(
        url, <span class="hljs-keyword">new</span> File[]{file}, <span class="hljs-keyword">new</span> String[]{fileKey}, <span class="hljs-keyword">null</span>);
FormEncodingBuilder builder = <span class="hljs-keyword">new</span> FormEncodingBuilder();   
builder.add(<span class="hljs-string">"username"</span>,<span class="hljs-string">"张鸿洋"</span>);

Request request = <span class="hljs-keyword">new</span> Request.Builder()
                   .url(url)
                .post(builder.build())
                .build();
 mOkHttpClient.newCall(request).enqueue(<span class="hljs-keyword">new</span> Callback(){});</code></pre> 
<p>大家都清楚，post的时候，参数是包含在请求体中的；所以我们通过FormEncodingBuilder。添加多个String键值对，然后去构造RequestBody，最后完成我们Request的构造。</p> 
<p>后面的就和上面一样了。</p> 
<hr> 
<h5 id="三基于http的文件上传">（三）基于Http的文件上传</h5> 
<p>接下来我们在介绍一个可以构造RequestBody的Builder，叫做<code>MultipartBuilder</code>。当我们需要做类似于表单上传的时候，就可以使用它来构造我们的requestBody。</p> 
<pre class="prettyprint"><code class="language-java hljs ">File file = <span class="hljs-keyword">new</span> File(Environment.getExternalStorageDirectory(), <span class="hljs-string">"balabala.mp4"</span>);

RequestBody fileBody = RequestBody.create(MediaType.parse(<span class="hljs-string">"application/octet-stream"</span>), file);

RequestBody requestBody = <span class="hljs-keyword">new</span> MultipartBuilder()
     .type(MultipartBuilder.FORM)
     .addPart(Headers.of(
          <span class="hljs-string">"Content-Disposition"</span>, 
              <span class="hljs-string">"form-data; name=\"username\""</span>), 
          RequestBody.create(<span class="hljs-keyword">null</span>, <span class="hljs-string">"张鸿洋"</span>))
     .addPart(Headers.of(
         <span class="hljs-string">"Content-Disposition"</span>, 
         <span class="hljs-string">"form-data; name=\"mFile\"; 
         filename=\"wjd.mp4\""</span>), fileBody)
     .build();

Request request = <span class="hljs-keyword">new</span> Request.Builder()
    .url(<span class="hljs-string">"http://192.168.1.103:8080/okHttpServer/fileUpload"</span>)
    .post(requestBody)
    .build();

Call call = mOkHttpClient.newCall(request);
call.enqueue(<span class="hljs-keyword">new</span> Callback()
{
    <span class="hljs-comment">//...</span>
});</code></pre> 
<p>上述代码向服务器传递了一个键值对<code>username:张鸿洋</code>和一个文件。我们通过MultipartBuilder的addPart方法可以添加键值对或者文件。</p> 
<p>其实类似于我们拼接模拟浏览器行为的方式，如果你对这块不了解，可以参考：<a href="http://blog.csdn.net/lmj623565791/article/details/23781773">从原理角度解析Android （Java） http 文件上传</a></p> 
<p>ok，对于我们最开始的目录还剩下图片下载，文件下载；这两个一个是通过回调的Response拿到byte[]然后decode成图片；文件下载，就是拿到inputStream做写文件操作，我们这里就不赘述了。</p> 
<p>关于用法，也可以参考<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0106/2275.html" rel="nofollow">泡网OkHttp使用教程</a></p> 
<p>接下来我们主要看如何封装上述的代码。</p> 
<hr> 
<h4 id="三封装">三、封装</h4> 
<p>由于按照上述的代码，写多个请求肯定包含大量的重复代码，所以我希望封装后的代码调用是这样的：</p> 
<h5 id="一使用">（一）使用</h5> 
<ol><li><p>一般的get请求</p> <pre class="prettyprint"><code class="language-java hljs "> OkHttpClientManager.getAsyn(<span class="hljs-string">"https://www.baidu.com"</span>, <span class="hljs-keyword">new</span> OkHttpClientManager.ResultCallback&lt;String&gt;()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span>(Request request, Exception e)
            {
                e.printStackTrace();
            }

            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(String u)
            {
                mTv.setText(u);<span class="hljs-comment">//注意这里是UI线程</span>
            }
        });</code></pre> <p>对于一般的请求，我们希望给个url，然后CallBack里面直接操作控件。</p></li><li><p>文件上传且携带参数</p> <p>我们希望提供一个方法，传入url,params,file,callback即可。</p> <pre class="prettyprint"><code class="language-java hljs ">  OkHttpClientManager.postAsyn(<span class="hljs-string">"http://192.168.1.103:8080/okHttpServer/fileUpload"</span>,<span class="hljs-comment">//</span>
    <span class="hljs-keyword">new</span> OkHttpClientManager.ResultCallback&lt;String&gt;()
    {
        <span class="hljs-annotation">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span>(Request request, IOException e)
        {
            e.printStackTrace();
        }

        <span class="hljs-annotation">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(String result)
        {

        }
    },<span class="hljs-comment">//</span>
    file,<span class="hljs-comment">//</span>
    <span class="hljs-string">"mFile"</span>,<span class="hljs-comment">//</span>
    <span class="hljs-keyword">new</span> OkHttpClientManager.Param[]{
            <span class="hljs-keyword">new</span> OkHttpClientManager.Param(<span class="hljs-string">"username"</span>, <span class="hljs-string">"zhy"</span>),
            <span class="hljs-keyword">new</span> OkHttpClientManager.Param(<span class="hljs-string">"password"</span>, <span class="hljs-string">"123"</span>)}
        );
</code></pre> <p>键值对没什么说的，参数3为file，参数4为file对应的name，这个name不是文件的名字； <br> 对应于http中的</p> <p><code>&lt;input type="file" name="mFile" &gt;</code> </p> <p>对应的是name后面的值，即mFile.</p></li><li><p>文件下载</p> <p>对于文件下载，提供url，目标dir，callback即可。</p> <pre class="prettyprint"><code class="language-java hljs ">OkHttpClientManager.downloadAsyn(
    <span class="hljs-string">"http://192.168.1.103:8080/okHttpServer/files/messenger_01.png"</span>,    
    Environment.getExternalStorageDirectory().getAbsolutePath(), 
<span class="hljs-keyword">new</span> OkHttpClientManager.ResultCallback&lt;String&gt;()
    {
        <span class="hljs-annotation">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span>(Request request, IOException e)
        {

        }

        <span class="hljs-annotation">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(String response)
        {
            <span class="hljs-comment">//文件下载成功，这里回调的reponse为文件的absolutePath</span>
        }
});</code></pre></li><li><p>展示图片</p> <p>展示图片，我们希望提供一个url和一个imageview，如果下载成功，直接帮我们设置上即可。</p> <pre class="prettyprint"><code class="language-java hljs "> OkHttpClientManager.displayImage(mImageView, 
     <span class="hljs-string">"http://images.csdn.net/20150817/1.jpg"</span>);</code></pre> <p>内部会自动根据imageview的大小自动对图片进行合适的压缩。虽然，这里可能不适合一次性加载大量图片的场景，但是对于app中偶尔有几个图片的加载，还是可用的。</p></li></ol> 
<hr> 
<h4 id="四整合gson">四、整合Gson</h4> 
<p>很多人提出项目中使用时，服务端返回的是Json字符串，希望客户端回调可以直接拿到对象，于是整合进入了Gson，完善该功能。</p> 
<h5 id="一直接回调对象">（一）直接回调对象</h5> 
<p>例如现在有个User实体类：</p> 
<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span> com.zhy.utils.http.okhttp;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> {<!-- --></span>

    <span class="hljs-keyword">public</span> String username ; 
    <span class="hljs-keyword">public</span> String password  ;

    <span class="hljs-keyword">public</span> <span class="hljs-title">User</span>() {
        <span class="hljs-comment">// TODO Auto-generated constructor stub</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title">User</span>(String username, String password) {
        <span class="hljs-keyword">this</span>.username = username;
        <span class="hljs-keyword">this</span>.password = password;
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span>()
    {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"User{"</span> +
                <span class="hljs-string">"username='"</span> + username + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", password='"</span> + password + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">'}'</span>;
    }
}</code></pre> 
<p>服务端返回：</p> 
<pre class="prettyprint"><code class="language-xml hljs ">{"username":"zhy","password":"123"}</code></pre> 
<p>客户端可以如下方式调用：</p> 
<pre class="prettyprint"><code class="language-java hljs "> OkHttpClientManager.getAsyn(<span class="hljs-string">"http://192.168.56.1:8080/okHttpServer/user!getUser"</span>,
<span class="hljs-keyword">new</span> OkHttpClientManager.ResultCallback&lt;User&gt;()
{
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span>(Request request, Exception e)
    {
        e.printStackTrace();
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(User user)
    {
        mTv.setText(u.toString());<span class="hljs-comment">//UI线程</span>
    }
});</code></pre> 
<p>我们传入泛型User，在onResponse里面直接回调User对象。 <br> 这里特别要注意的事，如果在<code>json字符串-&gt;实体对象</code>过程中发生错误，程序不会崩溃，<code>onError</code>方法会被回调。</p> 
<p>注意：这里做了少许的更新，接口命名从<code>StringCallback</code>修改为<code>ResultCallback</code>。接口中的<code>onFailure</code>方法修改为<code>onError</code>。</p> 
<h5 id="二-回调对象集合">(二) 回调对象集合</h5> 
<p>依然是上述的User类，服务端返回</p> 
<pre class="prettyprint"><code class="language-xml hljs ">[{"username":"zhy","password":"123"},{"username":"lmj","password":"12345"}]</code></pre> 
<p>则客户端可以如下调用：</p> 
<pre class="prettyprint"><code class="language-java hljs ">OkHttpClientManager.getAsyn(<span class="hljs-string">"http://192.168.56.1:8080/okHttpServer/user!getUsers"</span>,
<span class="hljs-keyword">new</span> OkHttpClientManager.ResultCallback&lt;List&lt;User&gt;&gt;()
{
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span>(Request request, Exception e)
    {
        e.printStackTrace();
    }
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(List&lt;User&gt; us)
    {
        Log.e(<span class="hljs-string">"TAG"</span>, us.size() + <span class="hljs-string">""</span>);
        mTv.setText(us.get(<span class="hljs-number">1</span>).toString());
    }
});</code></pre> 
<p>唯一的区别，就是泛型变为<code>List&lt;User&gt;</code> ，ok ， 如果发现bug或者有任何意见欢迎留言。</p> 
<hr> 
<h4 id="源码">源码</h4> 
<p>ok，基本介绍完了，对于封装的代码其实也很简单，我就直接贴出来了，因为也没什么好介绍的，如果你看完上面的用法，肯定可以看懂：</p> 
<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span> com.zhy.utils.http.okhttp;

<span class="hljs-keyword">import</span> android.graphics.Bitmap;
<span class="hljs-keyword">import</span> android.graphics.BitmapFactory;
<span class="hljs-keyword">import</span> android.os.Handler;
<span class="hljs-keyword">import</span> android.os.Looper;
<span class="hljs-keyword">import</span> android.widget.ImageView;

<span class="hljs-keyword">import</span> com.google.gson.Gson;
<span class="hljs-keyword">import</span> com.google.gson.internal.$Gson$Types;
<span class="hljs-keyword">import</span> com.squareup.okhttp.Call;
<span class="hljs-keyword">import</span> com.squareup.okhttp.Callback;
<span class="hljs-keyword">import</span> com.squareup.okhttp.FormEncodingBuilder;
<span class="hljs-keyword">import</span> com.squareup.okhttp.Headers;
<span class="hljs-keyword">import</span> com.squareup.okhttp.MediaType;
<span class="hljs-keyword">import</span> com.squareup.okhttp.MultipartBuilder;
<span class="hljs-keyword">import</span> com.squareup.okhttp.OkHttpClient;
<span class="hljs-keyword">import</span> com.squareup.okhttp.Request;
<span class="hljs-keyword">import</span> com.squareup.okhttp.RequestBody;
<span class="hljs-keyword">import</span> com.squareup.okhttp.Response;

<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.lang.reflect.ParameterizedType;
<span class="hljs-keyword">import</span> java.lang.reflect.Type;
<span class="hljs-keyword">import</span> java.net.CookieManager;
<span class="hljs-keyword">import</span> java.net.CookiePolicy;
<span class="hljs-keyword">import</span> java.net.FileNameMap;
<span class="hljs-keyword">import</span> java.net.URLConnection;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-javadoc">/**
 * Created by zhy on 15/8/17.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OkHttpClientManager</span>
{<!-- --></span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OkHttpClientManager mInstance;
    <span class="hljs-keyword">private</span> OkHttpClient mOkHttpClient;
    <span class="hljs-keyword">private</span> Handler mDelivery;
    <span class="hljs-keyword">private</span> Gson mGson;


    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TAG = <span class="hljs-string">"OkHttpClientManager"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-title">OkHttpClientManager</span>()
    {
        mOkHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
        <span class="hljs-comment">//cookie enabled</span>
        mOkHttpClient.setCookieHandler(<span class="hljs-keyword">new</span> CookieManager(<span class="hljs-keyword">null</span>, CookiePolicy.ACCEPT_ORIGINAL_SERVER));
        mDelivery = <span class="hljs-keyword">new</span> Handler(Looper.getMainLooper());
        mGson = <span class="hljs-keyword">new</span> Gson();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> OkHttpClientManager <span class="hljs-title">getInstance</span>()
    {
        <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-keyword">null</span>)
        {
            <span class="hljs-keyword">synchronized</span> (OkHttpClientManager.class)
            {
                <span class="hljs-keyword">if</span> (mInstance == <span class="hljs-keyword">null</span>)
                {
                    mInstance = <span class="hljs-keyword">new</span> OkHttpClientManager();
                }
            }
        }
        <span class="hljs-keyword">return</span> mInstance;
    }

    <span class="hljs-javadoc">/**
     * 同步的Get请求
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @return</span> Response
     */</span>
    <span class="hljs-keyword">private</span> Response <span class="hljs-title">_getAsyn</span>(String url) <span class="hljs-keyword">throws</span> IOException
    {
        <span class="hljs-keyword">final</span> Request request = <span class="hljs-keyword">new</span> Request.Builder()
                .url(url)
                .build();
        Call call = mOkHttpClient.newCall(request);
        Response execute = call.execute();
        <span class="hljs-keyword">return</span> execute;
    }

    <span class="hljs-javadoc">/**
     * 同步的Get请求
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @return</span> 字符串
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title">_getAsString</span>(String url) <span class="hljs-keyword">throws</span> IOException
    {
        Response execute = _getAsyn(url);
        <span class="hljs-keyword">return</span> execute.body().string();
    }


    <span class="hljs-javadoc">/**
     * 异步的get请求
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @param</span> callback
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_getAsyn</span>(String url, <span class="hljs-keyword">final</span> ResultCallback callback)
    {
        <span class="hljs-keyword">final</span> Request request = <span class="hljs-keyword">new</span> Request.Builder()
                .url(url)
                .build();
        deliveryResult(callback, request);
    }


    <span class="hljs-javadoc">/**
     * 同步的Post请求
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @param</span> params post的参数
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">private</span> Response <span class="hljs-title">_post</span>(String url, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        Request request = buildPostRequest(url, params);
        Response response = mOkHttpClient.newCall(request).execute();
        <span class="hljs-keyword">return</span> response;
    }


    <span class="hljs-javadoc">/**
     * 同步的Post请求
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @param</span> params post的参数
     *<span class="hljs-javadoctag"> @return</span> 字符串
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title">_postAsString</span>(String url, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        Response response = _post(url, params);
        <span class="hljs-keyword">return</span> response.body().string();
    }

    <span class="hljs-javadoc">/**
     * 异步的post请求
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @param</span> callback
     *<span class="hljs-javadoctag"> @param</span> params
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_postAsyn</span>(String url, <span class="hljs-keyword">final</span> ResultCallback callback, Param... params)
    {
        Request request = buildPostRequest(url, params);
        deliveryResult(callback, request);
    }

    <span class="hljs-javadoc">/**
     * 异步的post请求
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @param</span> callback
     *<span class="hljs-javadoctag"> @param</span> params
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_postAsyn</span>(String url, <span class="hljs-keyword">final</span> ResultCallback callback, Map&lt;String, String&gt; params)
    {
        Param[] paramsArr = map2Params(params);
        Request request = buildPostRequest(url, paramsArr);
        deliveryResult(callback, request);
    }

    <span class="hljs-javadoc">/**
     * 同步基于post的文件上传
     *
     *<span class="hljs-javadoctag"> @param</span> params
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">private</span> Response <span class="hljs-title">_post</span>(String url, File[] files, String[] fileKeys, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        Request request = buildMultipartFormRequest(url, files, fileKeys, params);
        <span class="hljs-keyword">return</span> mOkHttpClient.newCall(request).execute();
    }

    <span class="hljs-keyword">private</span> Response <span class="hljs-title">_post</span>(String url, File file, String fileKey) <span class="hljs-keyword">throws</span> IOException
    {
        Request request = buildMultipartFormRequest(url, <span class="hljs-keyword">new</span> File[]{file}, <span class="hljs-keyword">new</span> String[]{fileKey}, <span class="hljs-keyword">null</span>);
        <span class="hljs-keyword">return</span> mOkHttpClient.newCall(request).execute();
    }

    <span class="hljs-keyword">private</span> Response <span class="hljs-title">_post</span>(String url, File file, String fileKey, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        Request request = buildMultipartFormRequest(url, <span class="hljs-keyword">new</span> File[]{file}, <span class="hljs-keyword">new</span> String[]{fileKey}, params);
        <span class="hljs-keyword">return</span> mOkHttpClient.newCall(request).execute();
    }

    <span class="hljs-javadoc">/**
     * 异步基于post的文件上传
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @param</span> callback
     *<span class="hljs-javadoctag"> @param</span> files
     *<span class="hljs-javadoctag"> @param</span> fileKeys
     *<span class="hljs-javadoctag"> @throws</span> IOException
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_postAsyn</span>(String url, ResultCallback callback, File[] files, String[] fileKeys, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        Request request = buildMultipartFormRequest(url, files, fileKeys, params);
        deliveryResult(callback, request);
    }

    <span class="hljs-javadoc">/**
     * 异步基于post的文件上传，单文件不带参数上传
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @param</span> callback
     *<span class="hljs-javadoctag"> @param</span> file
     *<span class="hljs-javadoctag"> @param</span> fileKey
     *<span class="hljs-javadoctag"> @throws</span> IOException
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_postAsyn</span>(String url, ResultCallback callback, File file, String fileKey) <span class="hljs-keyword">throws</span> IOException
    {
        Request request = buildMultipartFormRequest(url, <span class="hljs-keyword">new</span> File[]{file}, <span class="hljs-keyword">new</span> String[]{fileKey}, <span class="hljs-keyword">null</span>);
        deliveryResult(callback, request);
    }

    <span class="hljs-javadoc">/**
     * 异步基于post的文件上传，单文件且携带其他form参数上传
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @param</span> callback
     *<span class="hljs-javadoctag"> @param</span> file
     *<span class="hljs-javadoctag"> @param</span> fileKey
     *<span class="hljs-javadoctag"> @param</span> params
     *<span class="hljs-javadoctag"> @throws</span> IOException
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_postAsyn</span>(String url, ResultCallback callback, File file, String fileKey, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        Request request = buildMultipartFormRequest(url, <span class="hljs-keyword">new</span> File[]{file}, <span class="hljs-keyword">new</span> String[]{fileKey}, params);
        deliveryResult(callback, request);
    }

    <span class="hljs-javadoc">/**
     * 异步下载文件
     *
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @param</span> destFileDir 本地文件存储的文件夹
     *<span class="hljs-javadoctag"> @param</span> callback
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_downloadAsyn</span>(<span class="hljs-keyword">final</span> String url, <span class="hljs-keyword">final</span> String destFileDir, <span class="hljs-keyword">final</span> ResultCallback callback)
    {
        <span class="hljs-keyword">final</span> Request request = <span class="hljs-keyword">new</span> Request.Builder()
                .url(url)
                .build();
        <span class="hljs-keyword">final</span> Call call = mOkHttpClient.newCall(request);
        call.enqueue(<span class="hljs-keyword">new</span> Callback()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span>(<span class="hljs-keyword">final</span> Request request, <span class="hljs-keyword">final</span> IOException e)
            {
                sendFailedStringCallback(request, e, callback);
            }

            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(Response response)
            {
                InputStream is = <span class="hljs-keyword">null</span>;
                <span class="hljs-keyword">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">2048</span>];
                <span class="hljs-keyword">int</span> len = <span class="hljs-number">0</span>;
                FileOutputStream fos = <span class="hljs-keyword">null</span>;
                <span class="hljs-keyword">try</span>
                {
                    is = response.body().byteStream();
                    File file = <span class="hljs-keyword">new</span> File(destFileDir, getFileName(url));
                    fos = <span class="hljs-keyword">new</span> FileOutputStream(file);
                    <span class="hljs-keyword">while</span> ((len = is.read(buf)) != -<span class="hljs-number">1</span>)
                    {
                        fos.write(buf, <span class="hljs-number">0</span>, len);
                    }
                    fos.flush();
                    <span class="hljs-comment">//如果下载文件成功，第一个参数为文件的绝对路径</span>
                    sendSuccessResultCallback(file.getAbsolutePath(), callback);
                } <span class="hljs-keyword">catch</span> (IOException e)
                {
                    sendFailedStringCallback(response.request(), e, callback);
                } <span class="hljs-keyword">finally</span>
                {
                    <span class="hljs-keyword">try</span>
                    {
                        <span class="hljs-keyword">if</span> (is != <span class="hljs-keyword">null</span>) is.close();
                    } <span class="hljs-keyword">catch</span> (IOException e)
                    {
                    }
                    <span class="hljs-keyword">try</span>
                    {
                        <span class="hljs-keyword">if</span> (fos != <span class="hljs-keyword">null</span>) fos.close();
                    } <span class="hljs-keyword">catch</span> (IOException e)
                    {
                    }
                }

            }
        });
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title">getFileName</span>(String path)
    {
        <span class="hljs-keyword">int</span> separatorIndex = path.lastIndexOf(<span class="hljs-string">"/"</span>);
        <span class="hljs-keyword">return</span> (separatorIndex &lt; <span class="hljs-number">0</span>) ? path : path.substring(separatorIndex + <span class="hljs-number">1</span>, path.length());
    }

    <span class="hljs-javadoc">/**
     * 加载图片
     *
     *<span class="hljs-javadoctag"> @param</span> view
     *<span class="hljs-javadoctag"> @param</span> url
     *<span class="hljs-javadoctag"> @throws</span> IOException
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">_displayImage</span>(<span class="hljs-keyword">final</span> ImageView view, <span class="hljs-keyword">final</span> String url, <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> errorResId)
    {
        <span class="hljs-keyword">final</span> Request request = <span class="hljs-keyword">new</span> Request.Builder()
                .url(url)
                .build();
        Call call = mOkHttpClient.newCall(request);
        call.enqueue(<span class="hljs-keyword">new</span> Callback()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span>(Request request, IOException e)
            {
                setErrorResId(view, errorResId);
            }

            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(Response response)
            {
                InputStream is = <span class="hljs-keyword">null</span>;
                <span class="hljs-keyword">try</span>
                {
                    is = response.body().byteStream();
                    ImageUtils.ImageSize actualImageSize = ImageUtils.getImageSize(is);
                    ImageUtils.ImageSize imageViewSize = ImageUtils.getImageViewSize(view);
                    <span class="hljs-keyword">int</span> inSampleSize = ImageUtils.calculateInSampleSize(actualImageSize, imageViewSize);
                    <span class="hljs-keyword">try</span>
                    {
                        is.reset();
                    } <span class="hljs-keyword">catch</span> (IOException e)
                    {
                        response = _getAsyn(url);
                        is = response.body().byteStream();
                    }

                    BitmapFactory.Options ops = <span class="hljs-keyword">new</span> BitmapFactory.Options();
                    ops.inJustDecodeBounds = <span class="hljs-keyword">false</span>;
                    ops.inSampleSize = inSampleSize;
                    <span class="hljs-keyword">final</span> Bitmap bm = BitmapFactory.decodeStream(is, <span class="hljs-keyword">null</span>, ops);
                    mDelivery.post(<span class="hljs-keyword">new</span> Runnable()
                    {
                        <span class="hljs-annotation">@Override</span>
                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()
                        {
                            view.setImageBitmap(bm);
                        }
                    });
                } <span class="hljs-keyword">catch</span> (Exception e)
                {
                    setErrorResId(view, errorResId);

                } <span class="hljs-keyword">finally</span>
                {
                    <span class="hljs-keyword">if</span> (is != <span class="hljs-keyword">null</span>) <span class="hljs-keyword">try</span>
                    {
                        is.close();
                    } <span class="hljs-keyword">catch</span> (IOException e)
                    {
                        e.printStackTrace();
                    }
                }
            }
        });


    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setErrorResId</span>(<span class="hljs-keyword">final</span> ImageView view, <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> errorResId)
    {
        mDelivery.post(<span class="hljs-keyword">new</span> Runnable()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()
            {
                view.setImageResource(errorResId);
            }
        });
    }


    <span class="hljs-comment">//*************对外公布的方法************</span>


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Response <span class="hljs-title">getAsyn</span>(String url) <span class="hljs-keyword">throws</span> IOException
    {
        <span class="hljs-keyword">return</span> getInstance()._getAsyn(url);
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getAsString</span>(String url) <span class="hljs-keyword">throws</span> IOException
    {
        <span class="hljs-keyword">return</span> getInstance()._getAsString(url);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getAsyn</span>(String url, ResultCallback callback)
    {
        getInstance()._getAsyn(url, callback);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Response <span class="hljs-title">post</span>(String url, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        <span class="hljs-keyword">return</span> getInstance()._post(url, params);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">postAsString</span>(String url, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        <span class="hljs-keyword">return</span> getInstance()._postAsString(url, params);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postAsyn</span>(String url, <span class="hljs-keyword">final</span> ResultCallback callback, Param... params)
    {
        getInstance()._postAsyn(url, callback, params);
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postAsyn</span>(String url, <span class="hljs-keyword">final</span> ResultCallback callback, Map&lt;String, String&gt; params)
    {
        getInstance()._postAsyn(url, callback, params);
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Response <span class="hljs-title">post</span>(String url, File[] files, String[] fileKeys, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        <span class="hljs-keyword">return</span> getInstance()._post(url, files, fileKeys, params);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Response <span class="hljs-title">post</span>(String url, File file, String fileKey) <span class="hljs-keyword">throws</span> IOException
    {
        <span class="hljs-keyword">return</span> getInstance()._post(url, file, fileKey);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Response <span class="hljs-title">post</span>(String url, File file, String fileKey, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        <span class="hljs-keyword">return</span> getInstance()._post(url, file, fileKey, params);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postAsyn</span>(String url, ResultCallback callback, File[] files, String[] fileKeys, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        getInstance()._postAsyn(url, callback, files, fileKeys, params);
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postAsyn</span>(String url, ResultCallback callback, File file, String fileKey) <span class="hljs-keyword">throws</span> IOException
    {
        getInstance()._postAsyn(url, callback, file, fileKey);
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postAsyn</span>(String url, ResultCallback callback, File file, String fileKey, Param... params) <span class="hljs-keyword">throws</span> IOException
    {
        getInstance()._postAsyn(url, callback, file, fileKey, params);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">displayImage</span>(<span class="hljs-keyword">final</span> ImageView view, String url, <span class="hljs-keyword">int</span> errorResId) <span class="hljs-keyword">throws</span> IOException
    {
        getInstance()._displayImage(view, url, errorResId);
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">displayImage</span>(<span class="hljs-keyword">final</span> ImageView view, String url)
    {
        getInstance()._displayImage(view, url, -<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">downloadAsyn</span>(String url, String destDir, ResultCallback callback)
    {
        getInstance()._downloadAsyn(url, destDir, callback);
    }

    <span class="hljs-comment">//****************************</span>


    <span class="hljs-keyword">private</span> Request <span class="hljs-title">buildMultipartFormRequest</span>(String url, File[] files,
                                              String[] fileKeys, Param[] params)
    {
        params = validateParam(params);

        MultipartBuilder builder = <span class="hljs-keyword">new</span> MultipartBuilder()
                .type(MultipartBuilder.FORM);

        <span class="hljs-keyword">for</span> (Param param : params)
        {
            builder.addPart(Headers.of(<span class="hljs-string">"Content-Disposition"</span>, <span class="hljs-string">"form-data; name=\""</span> + param.key + <span class="hljs-string">"\""</span>),
                    RequestBody.create(<span class="hljs-keyword">null</span>, param.value));
        }
        <span class="hljs-keyword">if</span> (files != <span class="hljs-keyword">null</span>)
        {
            RequestBody fileBody = <span class="hljs-keyword">null</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; files.length; i++)
            {
                File file = files[i];
                String fileName = file.getName();
                fileBody = RequestBody.create(MediaType.parse(guessMimeType(fileName)), file);
                <span class="hljs-comment">//TODO 根据文件名设置contentType</span>
                builder.addPart(Headers.of(<span class="hljs-string">"Content-Disposition"</span>,
                                <span class="hljs-string">"form-data; name=\""</span> + fileKeys[i] + <span class="hljs-string">"\"; filename=\""</span> + fileName + <span class="hljs-string">"\""</span>),
                        fileBody);
            }
        }

        RequestBody requestBody = builder.build();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Request.Builder()
                .url(url)
                .post(requestBody)
                .build();
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title">guessMimeType</span>(String path)
    {
        FileNameMap fileNameMap = URLConnection.getFileNameMap();
        String contentTypeFor = fileNameMap.getContentTypeFor(path);
        <span class="hljs-keyword">if</span> (contentTypeFor == <span class="hljs-keyword">null</span>)
        {
            contentTypeFor = <span class="hljs-string">"application/octet-stream"</span>;
        }
        <span class="hljs-keyword">return</span> contentTypeFor;
    }


    <span class="hljs-keyword">private</span> Param[] <span class="hljs-title">validateParam</span>(Param[] params)
    {
        <span class="hljs-keyword">if</span> (params == <span class="hljs-keyword">null</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Param[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> params;
    }

    <span class="hljs-keyword">private</span> Param[] <span class="hljs-title">map2Params</span>(Map&lt;String, String&gt; params)
    {
        <span class="hljs-keyword">if</span> (params == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Param[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">int</span> size = params.size();
        Param[] res = <span class="hljs-keyword">new</span> Param[size];
        Set&lt;Map.Entry&lt;String, String&gt;&gt; entries = params.entrySet();
        <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : entries)
        {
            res[i++] = <span class="hljs-keyword">new</span> Param(entry.getKey(), entry.getValue());
        }
        <span class="hljs-keyword">return</span> res;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SESSION_KEY = <span class="hljs-string">"Set-Cookie"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String mSessionKey = <span class="hljs-string">"JSESSIONID"</span>;

    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; mSessions = <span class="hljs-keyword">new</span> HashMap&lt;String, String&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deliveryResult</span>(<span class="hljs-keyword">final</span> ResultCallback callback, Request request)
    {
        mOkHttpClient.newCall(request).enqueue(<span class="hljs-keyword">new</span> Callback()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span>(<span class="hljs-keyword">final</span> Request request, <span class="hljs-keyword">final</span> IOException e)
            {
                sendFailedStringCallback(request, e, callback);
            }

            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(<span class="hljs-keyword">final</span> Response response)
            {
                <span class="hljs-keyword">try</span>
                {
                    <span class="hljs-keyword">final</span> String string = response.body().string();
                    <span class="hljs-keyword">if</span> (callback.mType == String.class)
                    {
                        sendSuccessResultCallback(string, callback);
                    } <span class="hljs-keyword">else</span>
                    {
                        Object o = mGson.fromJson(string, callback.mType);
                        sendSuccessResultCallback(o, callback);
                    }


                } <span class="hljs-keyword">catch</span> (IOException e)
                {
                    sendFailedStringCallback(response.request(), e, callback);
                } <span class="hljs-keyword">catch</span> (com.google.gson.JsonParseException e)<span class="hljs-comment">//Json解析的错误</span>
                {
                    sendFailedStringCallback(response.request(), e, callback);
                }

            }
        });
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendFailedStringCallback</span>(<span class="hljs-keyword">final</span> Request request, <span class="hljs-keyword">final</span> Exception e, <span class="hljs-keyword">final</span> ResultCallback callback)
    {
        mDelivery.post(<span class="hljs-keyword">new</span> Runnable()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()
            {
                <span class="hljs-keyword">if</span> (callback != <span class="hljs-keyword">null</span>)
                    callback.onError(request, e);
            }
        });
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendSuccessResultCallback</span>(<span class="hljs-keyword">final</span> Object object, <span class="hljs-keyword">final</span> ResultCallback callback)
    {
        mDelivery.post(<span class="hljs-keyword">new</span> Runnable()
        {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()
            {
                <span class="hljs-keyword">if</span> (callback != <span class="hljs-keyword">null</span>)
                {
                    callback.onResponse(object);
                }
            }
        });
    }

    <span class="hljs-keyword">private</span> Request <span class="hljs-title">buildPostRequest</span>(String url, Param[] params)
    {
        <span class="hljs-keyword">if</span> (params == <span class="hljs-keyword">null</span>)
        {
            params = <span class="hljs-keyword">new</span> Param[<span class="hljs-number">0</span>];
        }
        FormEncodingBuilder builder = <span class="hljs-keyword">new</span> FormEncodingBuilder();
        <span class="hljs-keyword">for</span> (Param param : params)
        {
            builder.add(param.key, param.value);
        }
        RequestBody requestBody = builder.build();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Request.Builder()
                .url(url)
                .post(requestBody)
                .build();
    }


    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResultCallback</span>&lt;<span class="hljs-title">T</span>&gt;
    {<!-- --></span>
        Type mType;

        <span class="hljs-keyword">public</span> <span class="hljs-title">ResultCallback</span>()
        {
            mType = getSuperclassTypeParameter(getClass());
        }

        <span class="hljs-keyword">static</span> Type getSuperclassTypeParameter(Class&lt;?&gt; subclass)
        {
            Type superclass = subclass.getGenericSuperclass();
            <span class="hljs-keyword">if</span> (superclass <span class="hljs-keyword">instanceof</span> Class)
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"Missing type parameter."</span>);
            }
            ParameterizedType parameterized = (ParameterizedType) superclass;
            <span class="hljs-keyword">return</span> $Gson$Types.canonicalize(parameterized.getActualTypeArguments()[<span class="hljs-number">0</span>]);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span>(Request request, Exception e);

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span>(T response);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Param</span>
    {<!-- --></span>
        <span class="hljs-keyword">public</span> <span class="hljs-title">Param</span>()
        {
        }

        <span class="hljs-keyword">public</span> <span class="hljs-title">Param</span>(String key, String value)
        {
            <span class="hljs-keyword">this</span>.key = key;
            <span class="hljs-keyword">this</span>.value = value;
        }

        String key;
        String value;
    }


}

</code></pre> 
<p>源码地址<a href="https://github.com/hongyangAndroid/okhttp-utils">okhttp-utils</a>，大家可以自己下载查看。</p> 
<hr> 
<p>欢迎关注我的微博： <br> <a href="http://weibo.com/u/3165018720" rel="nofollow">http://weibo.com/u/3165018720</a></p> 
<hr> 
<blockquote> 
 <p>群号：<font color="red">463081660</font>，欢迎入群</p> 
 <p>微信公众号：hongyangAndroid <br> （欢迎关注，第一时间推送博文信息） <br> <img src="https://images2.imgbox.com/eb/19/2T9mhC9l_o.jpg" width="200px"></p> 
</blockquote> 
<h4 id="参考文章">参考文章</h4> 
<ul><li><a href="https://github.com/square/okhttp">https://github.com/square/okhttp</a></li><li><a href="http://square.github.io/okhttp/" rel="nofollow">http://square.github.io/okhttp/</a></li><li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0106/2275.html" rel="nofollow">泡网OkHttp使用教程</a></li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9290327d3466ad67520dea553b91c8ff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">EF学习和使用（三）Code First</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a59d8d9f3ac37b9ade46925e9110b9b4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用数据库管理工具navicat----命令行界面</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>