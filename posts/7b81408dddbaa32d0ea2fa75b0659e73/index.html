<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>socket编程原理，TCP和UDP - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="socket编程原理，TCP和UDP" />
<meta property="og:description" content="socket
1、问题的引入 1) 普通的I/O操作过程: UNIX系统的I/O命令集，是从Maltics和早期系统中的命令演变出来的，其模式为打开一读/写一关闭（open-write-read-close）。在一个用户进程进行I/O操作时，它首先调用“打开”获得对指定文件或设备的使用权，并返回称为文件描述符的整型数，以描述用户在打开的文件或设备上进行I/O操作的进程。然后这个用户进程多次调用“读/写”以传输数据。当所有的传输操作完成后，用户进程关闭调用，通知操作系统已经完成了对某对象的使用。 2) TCP/IP协议被集成到UNIX内核中
TCP/IP协议被集成到UNIX内核中时，相当于在UNIX系统引入了一种新型的I/O操作。UNIX用户进程与网络协议的交互作用比用户进程与传统的I/O设备相互作用复杂得多。首先，进行网络操作的两个进程在不同机器上，如何建立它们之间的联系？其次，网络协议存在多种，如何建立一种通用机制以支持多种协议？这些都是网络应用编程界面所要解决的问题。 3) 需要一种通用的网络编程接口: 独立于具体协议和通用的网络编程
在UNIX系统中，网络应用编程界面有两类：UNIX BSD的套接字（socket）和UNIX System V的TLI。由于Sun公司采用了支持TCP/IP的UNIX BSD操作系统，使TCP/IP的应用有更大的发展，其网络应用编程界面──套接字（socket）在网络软件中被广泛应用，至今已引进微机操作系统DOS和Windows系统中，成为开发网络应用软件的强有力工具，本章将要详细讨论这个问题。
2、SOCKET编程基本概念 开始使用套接字编程之前，首先必须建立以下概念。 2.1 网间进程通信 进程通信的概念最初来源于单机系统。由于每个进程都在自己的地址范围内运行，为保证两个相互通信的进程之间既互不干扰又协调一致工作，操作系统为进程通信提供了相应设施，
如UNIX BSD有：管道（pipe）、命名管道（named pipe）软中断信号（signal）
UNIX system V有：消息（message）、共享存储区（shared memory）和信号量（semaphore)等.
他们都仅限于用在本机进程之间通信。网间进程通信要解决的是不同主机进程间的相互通信问题（可把同机进程通信看作是其中的特例）。为此，首先要解决的是网间进程标识问题。同一主机上，不同进程可用进程号（process ID）唯一标识。但在网络环境下，各主机独立分配的进程号不能唯一标识该进程。例如，主机A赋于某进程号5，在B机中也可以存在5号进程，因此，“5号进程”这句话就没有意义了。 其次，操作系统支持的网络协议众多，不同协议的工作方式不同，地址格式也不同。因此，网间进程通信还要解决多重协议的识别问题。 为了解决上述问题，TCP/IP协议引入了下列几个概念。 1）端口 网络中可以被命名和寻址的通信端口，是操作系统可分配的一种资源。 按照OSI七层协议的描述，传输层与网络层在功能上的最大区别是传输层提供进程通信能力。从这个意义上讲，网络通信的最终地址就不仅仅是主机地址了，还包括可以描述进程的某种标识符。为此，TCP/IP协议提出了协议端口（protocol port，简称端口）的概念，用于标识通信的进程。 端口是一种抽象的软件结构（包括一些数据结构和I/O缓冲区）。应用程序（即进程）通过系统调用与某端口建立连接（binding）后，传输层传给该端口的数据都被相应进程所接收，相应进程发给传输层的数据都通过该端口输出。在TCP/IP协议的实现中，对端口的操作类似于一般的I/O操作，进程获取一个端口，相当于获取本地唯一的I/O文件，可以用一般的读写原语访问之。 类似于文件描述符，每个端口都拥有一个叫端口号（port number）的整数型标识符，用于区别不同端口。
由于TCP/IP传输层的两个协议TCP和UDP是完全独立的两个软件模块，因此各自的端口号也相互独立，如TCP有一个255号端口，UDP也可以有一个255号端口，二者并不冲突。 端口号的分配是一个重要问题。有两种基本分配方式：第一种叫全局分配，这是一种集中控制方式，由一个公认的中央机构根据用户需要进行统一分配，并将结果公布于众。第二种是本地分配，又称动态连接，即进程需要访问传输层服务时，向本地操作系统提出申请，操作系统返回一个本地唯一的端口号，进程再通过合适的系统调用将自己与该端口号联系起来（绑扎）。TCP/IP端口号的分配中综合了上述两种方式。TCP/IP将端口号分为两部分，少量的作为保留端口，以全局方式分配给服务进程。因此，每一个标准服务器都拥有一个全局公认的端口（即周知口，well-known port），即使在不同的机器上，其端口号也相同。剩余的为自由端口，以本地方式进行分配。TCP和UDP均规定，小于256的端口号才能作保留端口。 2）地址 网络通信中通信的两个进程分别在不同的机器上。在互连网络中，两台机器可能位于不同的网络，这些网络通过网络互连设备（网关，网桥，路由器等）连接。因此需要三级寻址： 1. 某一主机可与多个网络相连，必须指定一特定网络地址； 2. 网络上每一台主机应有其唯一的地址； 3. 每一主机上的每一进程应有在该主机上的唯一标识符。 通常主机地址由网络ID和主机ID组成，在TCP/IP协议中用32位整数值表示；TCP和UDP均使用16位端口号标识用户进程。 3）网络字节顺序 不同的计算机存放多字节值的顺序不同，有的机器在起始地址存放低位字节（小端序），有的存高位字节（大端序）。为保证数据的正确性，在网络协议中须指定网络字节顺序。TCP/IP协议使用16位整数和32位整数的高价先存格式，它们均含在协议头文件中。 详解http://blog.csdn.net/hguisu/article/details/7449955#t1
4）连接 两个进程间的通信链路称为连接。连接在内部表现为一些缓冲区和一组协议机制，在外部表现出比无连接高的可靠性。 5）半相关 综上所述，网络中用一个三元组可以在全局唯一标志一个进程： （协议，本地地址，本地端口号） 这样一个三元组，叫做一个半相关（half-association），它指定连接的每半部分。 6）全相关 一个完整的网间进程通信需要由两个进程组成，并且只能使用同一种高层协议。也就是说，不可能通信的一端用TCP协议，而另一端用UDP协议。因此一个完整的网间通信需要一个五元组来标识： （协议，本地地址，本地端口号，远地地址，远地端口号） 这样一个五元组，叫做一个相关（association），即两个协议相同的半相关才能组合成一个合适的相关，或完全指定组成一连接。 2.2 服务方式 在网络分层结构中，各层之间是严格单向依赖的，各层次的分工和协作集中体现在不同层之间的界面上。“服务”是描述不同层之间关系的抽象概念，即网络中各层向紧邻上层提供的一组操作。下层是服务提供者，上层是请求服务的用户。服务的表现形式是原语（primitive），如系统调用或库函数。系统调用是操作系统内核向网络应用程序或高层协议提供的服务原语。网络中的n层总要向n&#43;1层提供比n-1层更完备的服务，否则n层就没有存在的价值。 在OSI的术语中，网络层及其以下各层又称为通信子网，只提供点到点通信，没有程序或进程的概念。而传输层实现的是“端到端”通信，引进网间进程通信概念，同时也要解决差错控制，流量控制，数据排序（报文排序），连接管理等问题，为此提供不同的服务方式： 1）面向连接（虚电路）或无连接 面向连接服务（TCP协议） ：是电话系统服务模式的抽象，即每一次完整的数据传输都要经过建立连接，使用连接，终止连 接的过程。在数据传输过程中，各数据分组不携带目的地址，而使用连接号（connect ID）。本质上，连接 是一个管道，收发数据不但顺序一致，而且内容相同。TCP协议提供面向连接的虚电路。 无连接服务（UDP协议）：是邮政系统服务的抽象，每个分组都携带完整的目的地址，各分组在系统中独立传送。无连接服务不能保证分组的先后顺序，不进行分组出错的恢复与重传，不保证传输的可靠性。UDP协议提供无连接的数据报服务。 下面给出这两种服务的类型及应用中的例子： 2）顺序 在网络传输中，两个连续报文在端－端通信中可能经过不同路径，这样到达目的地时的顺序可能会与发送时不同。“顺序”是指接收数据顺序与发送数据顺序相同。TCP协议提供这项服务。 3）差错控制 保证应用程序接收的数据无差错的一种机制。检查差错的方法一般是采用检验“检查和（Checksum）”的方法。而保证传送无差错的方法是双方采用确认应答技术。TCP协议提供这项服务。 4）流控制 在数据传输过程中控制数据传输速率的一种机制，以保证数据不被丢失。TCP协议提供这项服务。 5）字节流 字节流方式指的是仅把传输中的报文看作是一个字节序列，不提供数据流的任何边界。TCP协议提供字节流服务。 6）报文 接收方要保存发送方的报文边界。UDP协议提供报文服务。 7）全双工/半双工 端－端间数据同时以两个方向/一个方向传送。 8）缓存/带外数据 在字节流服务中，由于没有报文边界，用户进程在某一时刻可以读或写任意数量的字节。为保证传输正确或采用有流控制的协议时，都要进行缓存。但对某些特殊的需求，如交互式应用程序，又会要求取消这种缓存。 在数据传送过程中，希望不通过常规传输方式传送给用户以便及时处理的某一类信息，如UNIX系统的中断键（Delete或Control-c）、终端流控制符（Control-s和Control-q），称为带外数据。逻辑上看，好象用户进程使用了一个独立的通道传输这些数据。该通道与每对连接的流相联系。由于Berkeley Software Distribution中对带外数据的实现与RFC 1122中规定的Host Agreement不一致,为了将互操作中的问题减到最小，应用程序编写者除非与现有服务互操作时要求带外数据外，最好不使用它。 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/7b81408dddbaa32d0ea2fa75b0659e73/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-11-12T21:52:36+08:00" />
<meta property="article:modified_time" content="2015-11-12T21:52:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">socket编程原理，TCP和UDP</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="font-size:12px"><span style="color:rgb(51,51,255); text-decoration:none; line-height:30px; font-family:'Microsoft YaHei'; font-size:20px"><a target="_blank" href="http://blog.csdn.net/hguisu/article/details/7444092" style="color:rgb(34,0,0); text-decoration:none; line-height:30px; font-family:'Microsoft YaHei'; font-size:20px" rel="noopener noreferrer">socket</a></span></span></p> 
<h3 style="margin:0px; padding:0px; color:rgb(51,51,51); font-family:Arial; line-height:26px"> <a target="_blank" name="t0" style="color:rgb(51,102,153)"></a> </h3><p style="font-family:Simsun; font-size:14px; text-indent:2em"></p>  
<h3 class="headline-1 bk-sidecatalog-title" style="margin:0px 0px 10px; padding:0px 0px 6px; color:rgb(51,51,51); font-family:Arial; line-height:26px; border-bottom-color:rgb(222,223,225); border-bottom-width:1px; border-bottom-style:solid; clear:both"> <a target="_blank" name="t1" style="color:rgb(51,102,153)"></a><span style="color:rgb(51,102,153); font-size:22px; line-height:36px">1、问题的引入</span></h3> 
<blockquote style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px; border:medium none; padding:0px; margin:0px 0px 0px 40px"> 
 <p></p> 
 <div> 
  <strong>1) 普通的I/O操作过程</strong>: 
 </div> 
 <p></p> 
 <p><span style="font-size:12px">UNIX系统的I/O命令集，是从Maltics和早期系统中的命令演变出来的，<strong>其模式为打开一读/写一关闭（open-write-read-close）</strong>。在一个用户进程进行I/O操作时，它首先调用“打开”获得对指定文件或设备的使用</span><span style="font-size:12px">权，并返回称为文件描述符的整型数，以描述用户在打开的文件或设备上进行I/O操作的进程。然后这个用</span><span style="font-size:12px">户进程多次调用“读/写”以传输数据。当所有的传输操作完成后，用户进程关闭调用，通知操作系统已经</span><span style="font-size:12px">完成了对某对象的使用。 </span></p> 
 <p><strong><span style="font-size:12px">2) TCP/IP协议被集成到UNIX内核中</span></strong></p> 
 <p><span style="font-size:12px">TCP/IP协议被集成到UNIX内核中时，相当于在UNIX系统引入了一种新型的I/O操作。UNIX用户进程与网络协</span><span style="font-size:12px">议的交互作用比用户进程与传统的I/O设备相互作用复杂得多。首先，进行网络操作的两个进程在不同机器</span><span style="font-size:12px">上，如何建立它们之间的联系？其次，网络协议存在多种，如何建立一种通用机制以支持多种协议？这些都</span><span style="font-size:12px">是网络应用编程界面所要解决的问题。 </span></p> 
 <p><span style="font-size:12px"><strong>3) 需要一种<span style="color:rgb(255,51,0)">通用</span>的网络编程接口:  </strong>独立于具体协议和<span style="line-height:25px">通用的网络编程</span></span></p> 
 <p><span style="font-size:12px">在UNIX系统中，网络应用编程界面有两类：UNIX BSD的套接字（socket）和UNIX System V的TLI。由于Sun</span><span style="font-size:12px">公司采用了支持TCP/IP的UNIX BSD操作系统，使TCP/IP的应用有更大的发展，其网络应用编程界面──套接</span><span style="font-size:12px">字（socket）在网络软件中被广泛应用，至今已引进微机操作系统DOS和Windows系统中，成为开发网络应用</span><span style="font-size:12px">软件的强有力工具，本章将要详细讨论这个问题。</span></p> 
</blockquote> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <h3 class="headline-1 bk-sidecatalog-title" style="margin:0px 0px 10px; padding:0px 0px 6px; border-bottom-color:rgb(222,223,225); border-bottom-width:1px; border-bottom-style:solid; clear:both"> <a target="_blank" name="t3" style="color:rgb(51,102,153)"></a><span style="color:rgb(51,102,153)"><span style="line-height:36px; font-size:22px">2、SOCKET编程基本概念</span></span></h3> 
 <br> 
</div> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="font-size:12px">         开始使用套接字编程之前，首先必须建立以下概念。 </span></p> 
<blockquote style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px; border:medium none; padding:0px; margin:0px 0px 0px 40px"> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t4" style="color:rgb(51,102,153)"></a>2.1 网间进程通信  </h4> 
 <p></p> 
 <p><span style="font-size:12px">进程通信的概念最初来源于单机系统。由于每个进程都在自己的地址范围内运行，为保证两个相互通信的进</span><span style="font-size:12px">程之间既互不干扰又协调一致工作，操作系统为进程通信提供了相应设施，</span></p> 
 <p><span style="font-size:12px"><strong>如</strong></span><span style="font-size:12px"><strong>UNIX BSD有：</strong>管道（pipe）、命名管道（named pipe）软中断信号（signal）</span></p> 
 <p><span style="font-size:12px"></span><span style="font-size:12px"><strong>UNIX system V有：</strong>消息（message）、共享存储区</span><span style="font-size:12px">（shared memory）和信号量（semaphore)等.</span></p> 
 <p><span style="font-size:12px">他们都仅限于用在本机进程之间通信。</span><span style="font-size:12px">网间进程通信要解决的</span><span style="font-size:12px">是不同主机进程间的相互通信问题（可把同机进程通信看作是其中的特例）。为此，首先要解决的是网间进</span><span style="font-size:12px">程标识问题。同一主机上，不同进程可用进程号（process ID）唯一标识。但在网络环境下，各主机独立分</span><span style="font-size:12px">配的进程号不能唯一标识该进程。例如，主机A赋于某进程号5，在B机中也可以存在5号进程，因此，“5号</span><span style="font-size:12px">进程”这句话就没有意义了。 </span><span style="font-size:12px">其次，操作系统支持的网络协议众多，不同协议的工作方式不同，地址格式也不同。因此，网间进程通信还</span><span style="font-size:12px">要解决多重协议的识别问题。 </span><span style="font-size:12px">为了解决上述问题，TCP/IP协议引入了下列几个概念。 </span></p> 
 <h5 style="margin:0px; padding:0px"><a target="_blank" name="t5" style="color:rgb(51,102,153)"></a><span style="font-size:12px">1）端口 </span></h5> 
 <p><span style="font-size:12px">网络中可以被命名和寻址的通信端口，是操作系统可分配的一种资源。 </span></p> 
 <p><span style="font-size:12px">按照OSI七层协议的描述，传输层与网络层在功能上的最大区别是传输层提供进程通信能力。从这个意义上</span><span style="font-size:12px">讲，网络通信的最终地址就不仅仅是主机地址了，还包括可以描述进程的某种标识符。为此，TCP/IP协议提</span><span style="font-size:12px">出了协议端口（protocol port，简称端口）的概念，用于标识通信的进程。 </span></p> 
 <p><span style="font-size:12px">端口是一种抽象的软件结构（包括一些数据结构和I/O缓冲区）。应用程序（即进程）通过系统调用与某端</span><span style="font-size:12px">口建立连接（binding）后，传输层传给该端口的数据都被相应进程所接收，相应进程发给传输层的数据都</span><span style="font-size:12px">通过该端口输出。在TCP/IP协议的实现中，对端口的操作类似于一般的I/O操作，进程获取一个端口，相当</span><span style="font-size:12px">于获取本地唯一的I/O文件，可以用一般的读写原语访问之。 </span><span style="font-size:12px">类似于文件描述符，每个端口都拥有一个叫端口号（port number）的整数型标识符，用于区别不同端口。</span></p> 
 <p><span style="font-size:12px">由于TCP/IP传输层的两个协议TCP和UDP是完全独立的两个软件模块，因此各自的端口号也相互独立，如TCP有一个255号端口，UDP也可以有一个255号端口，二者并不冲突。 </span></p> 
 <p><span style="font-size:12px">端口号的分配是一个重要问题。有两种基本分配方式：第一种叫全局分配，这是一种集中控制方式，由一个</span><span style="font-size:12px">公认的中央机构根据用户需要进行统一分配，并将结果公布于众。第二种是本地分配，又称动态连接，即进</span><span style="font-size:12px">程需要访问传输层服务时，向本地操作系统提出申请，操作系统返回一个本地唯一的端口号，进程再通过合</span><span style="font-size:12px">适的系统调用将自己与该端口号联系起来（绑扎）。TCP/IP端口号的分配中综合了上述两种方式。TCP/IP将</span><span style="font-size:12px">端口号分为两部分，少量的作为保留端口，以全局方式分配给服务进程。因此，每一个标准服务器都拥有一</span><span style="font-size:12px">个全局公认的端口（即周知口，well-known port），即使在不同的机器上，其端口号也相同。剩余的为自</span><span style="font-size:12px">由端口，以本地方式进行分配。TCP和UDP均规定，小于256的端口号才能作保留端口。 </span></p> 
 <h5 style="margin:0px; padding:0px"><a target="_blank" name="t6" style="color:rgb(51,102,153)"></a><span style="font-size:12px">2）地址 </span></h5> 
 <p><span style="font-size:12px">网络通信中通信的两个进程分别在不同的机器上。在互连网络中，两台机器可能位于不同的网络，这些网络</span><span style="font-size:12px">通过网络互连设备（网关，网桥，路由器等）连接。因此需要三级寻址： </span></p> 
 <p><span style="font-size:12px">1. 某一主机可与多个网络相连，必须指定一特定网络地址； </span></p> 
 <p><span style="font-size:12px">2. 网络上每一台主机应有其唯一的地址； </span></p> 
 <p><span style="font-size:12px">3. 每一主机上的每一进程应有在该主机上的唯一标识符。 </span></p> 
 <p><span style="font-size:12px">通常主机地址由网络ID和主机ID组成，在TCP/IP协议中用32位整数值表示；TCP和UDP均使用16位端口号标识用户进程。 </span></p> 
 <p></p> 
 <h5 style="margin:0px; padding:0px"><a target="_blank" name="t7" style="color:rgb(51,102,153)"></a><span style="font-size:12px">3）网络字节顺序 </span></h5> 
 <p></p> 
 <p><span style="font-size:12px">不同的计算机存放多字节值的顺序不同，有的机器在起始地址存放低位字节（小端序），有的存高位字节</span><span style="font-size:12px">（大端序）。为保证数据的正确性，在网络协议中须指定网络字节顺序。TCP/IP协议使用16位整数和32位</span><span style="font-size:12px">整数的高价先存格式，它们均含在协议头文件中。 详解<a target="_blank" href="http://blog.csdn.net/hguisu/article/details/7449955#t1" style="color:rgb(51,102,153); text-decoration:none" rel="noopener noreferrer">http://blog.csdn.net/hguisu/article/details/7449955#t1</a></span></p> 
 <p></p> 
 <h5 style="margin:0px; padding:0px"><a target="_blank" name="t8" style="color:rgb(51,102,153)"></a><span style="font-size:12px">4）连接 </span></h5> 
 <p></p> 
 <p><span style="font-size:12px">两个进程间的通信链路称为连接。连接在内部表现为一些缓冲区和一组协议机制，在外部表现出比无连接高</span><span style="font-size:12px">的可靠性。 </span></p> 
 <p></p> 
 <h5 style="margin:0px; padding:0px"><a target="_blank" name="t9" style="color:rgb(51,102,153)"></a><span style="font-size:12px">5）半相关 </span></h5> 
 <p></p> 
 <p><span style="font-size:12px">综上所述，网络中用一个三元组可以在全局唯一标志一个进程： </span></p> 
 <p><span style="font-size:12px">（协议，本地地址，本地端口号） 这样一个三元组，叫做一个半相关（half-association），它指定连接的每半部分。 </span></p> 
 <h5 style="margin:0px; padding:0px"><a target="_blank" name="t10" style="color:rgb(51,102,153)"></a><span style="font-size:12px">6）全相关 </span></h5> 
 <p><span style="font-size:12px">一个完整的网间进程通信需要由两个进程组成，并且只能使用同一种高层协议。也就是说，不可能通信的一</span><span style="font-size:12px">端用TCP协议，而另一端用UDP协议。因此一个完整的网间通信需要一个五元组来标识： </span></p> 
 <p><span style="font-size:12px">（协议，本地地址，本地端口号，远地地址，远地端口号） 这样一个五元组，叫做一个相关（association），即两个协议相同的半相关才能组合成一个合适的相关，</span><span style="font-size:12px">或完全指定组成一连接。 </span></p> 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t11" style="color:rgb(51,102,153)"></a>2.2 服务方式  </h4> 
 <p></p> 
 <p><span style="font-size:12px">在网络分层结构中，各层之间是严格单向依赖的，各层次的分工和协作集中体现在不同层之间的界面上。“</span><span style="font-size:12px">服务”是描述不同层之间关系的抽象概念，即网络中各层向紧邻上层提供的一组操作。下层是服务提供者，</span><span style="font-size:12px">上层是请求服务的用户。服务的表现形式是原语（primitive），如系统调用或库函数。系统调用是操作系</span><span style="font-size:12px">统内核向网络应用程序或高层协议提供的服务原语。网络中的n层总要向n+1层提供比n-1层更完备的服务，</span><span style="font-size:12px">否则n层就没有存在的价值。 </span><span style="font-size:12px">在OSI的术语中，网络层及其以下各层又称为通信子网，只提供点到点通信，没有程序或进程的概念。而传</span><span style="font-size:12px">输层实现的是“端到端”通信，引进网间进程通信概念，同时也要解决差错控制，流量控制，数据排序（报</span><span style="font-size:12px">文排序），连接管理等问题，为此提供不同的服务方式： </span></p> 
 <p><strong><span style="font-size:12px">1）面向连接（虚电路）或无连接 </span></strong></p> 
 <span style="font-size:12px"><span style="color:rgb(51,51,255)">面向连接服务（</span><span style="color:rgb(51,51,255)">TCP协议</span><span style="color:rgb(51,51,255)">）</span></span> 
 <span style="font-size:12px">：是电话系统服务模式的抽象，即每一次完整的数据传输都要经过建立连接，使用连接，终止连</span> 
 <span style="font-size:12px">接的过程。在数据传输过程中，各数据分组不携带目的地址，而使用连接号（connect ID）。本质上，连接</span> 
 <span style="font-size:12px">是一个管道，收发数据不但顺序一致，而且内容相同。TCP协议提供面向连接的虚电路。</span> 
 <p><span style="font-size:12px"><span style="color:rgb(51,51,255)">无连接服务（UDP协议）</span></span><span style="font-size:12px">：是邮政系统服务的抽象，每个分组都携带完整的目的地址，各分组在系统中独立传送。无连接服</span><span style="font-size:12px">务不能保证分组的先后顺序，不进行分组出错的恢复与重传，不保证传输的可靠性。UDP协议提供无连接的</span><span style="font-size:12px">数据报服务。 </span></p> 
 <p><span style="font-size:12px">下面给出这两种服务的类型及应用中的例子： </span></p> 
 <p><span style="font-size:12px"><img alt="" src="https://images2.imgbox.com/9f/dd/4WHXHVTh_o.jpg" style="border:none; max-width:100%"></span></p> 
 <p></p> 
 <h3 style="margin:0px; padding:0px"><a target="_blank" name="t12" style="color:rgb(51,102,153)"></a><span style="font-size:12px">2）顺序 </span></h3> 
 <p><span style="font-size:12px">在网络传输中，两个连续报文在端－端通信中可能经过不同路径，这样到达目的地时的顺序可能会与发送时</span><span style="font-size:12px">不同。“顺序”是指接收数据顺序与发送数据顺序相同。TCP协议提供这项服务。 </span></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t13" style="color:rgb(51,102,153)"></a><span style="font-size:12px">3）差错控制 </span></h4> 
 <p><span style="font-size:12px">保证应用程序接收的数据无差错的一种机制。检查差错的方法一般是采用检验“检查和（Checksum）”的方</span><span style="font-size:12px">法。而保证传送无差错的方法是双方采用确认应答技术。TCP协议提供这项服务。 </span></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t14" style="color:rgb(51,102,153)"></a><span style="font-size:12px">4）流控制 </span></h4> 
 <p><span style="font-size:12px">在数据传输过程中控制数据传输速率的一种机制，以保证数据不被丢失。TCP协议提供这项服务。 </span></p> 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t15" style="color:rgb(51,102,153)"></a><span style="font-size:12px">5）字节流 </span></h4> 
 <p></p> 
 <p><span style="font-size:12px">字节流方式指的是仅把传输中的报文看作是一个字节序列，不提供数据流的任何边界。TCP协议提供字节流</span>服务。 </p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t16" style="color:rgb(51,102,153)"></a><span style="font-size:12px">6）报文 </span></h4> 
 <p><span style="font-size:12px">接收方要保存发送方的报文边界。UDP协议提供报文服务。 </span></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t17" style="color:rgb(51,102,153)"></a><span style="font-size:12px">7）全双工/半双工 </span></h4> 
 <p><span style="font-size:12px">端－端间数据同时以两个方向/一个方向传送。 </span></p> 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t18" style="color:rgb(51,102,153)"></a><span style="font-size:12px">8）缓存/带外数据 </span></h4> 
 <p></p> 
 <p><span style="font-size:12px">在字节流服务中，由于没有报文边界，用户进程在某一时刻可以读或写任意数量的字节。为保证传输正确或</span><span style="font-size:12px">采用有流控制的协议时，都要进行缓存。但对某些特殊的需求，如交互式应用程序，又会要求取消这种缓存</span><span style="font-size:12px">。 </span><span style="font-size:12px">在数据传送过程中，希望不通过常规传输方式传送给用户以便及时处理的某一类信息，如UNIX系统的中断键</span><span style="font-size:12px">（Delete或Control-c）、终端流控制符（Control-s和Control-q），称为带外数据。逻辑上看，好象用户</span><span style="font-size:12px">进程使用了一个独立的通道传输这些数据。该通道与每对连接的流相联系。由于Berkeley Software </span><span style="font-size:12px">Distribution中对带外数据的实现与RFC 1122中规定的Host Agreement不一致,为了将互操作中的问题减到</span><span style="font-size:12px">最小，应用程序编写者除非与现有服务互操作时要求带外数据外，最好不使用它。 </span></p> 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t19" style="color:rgb(51,102,153)"></a>2.3 客户/服务器模式  </h4> 
 <p></p> 
 <p><span style="font-size:12px">在TCP/IP网络应用中，通信的两个进程间相互作用的主要模式是客户/服务器模式（Client/Server model）</span><span style="font-size:12px">，即客户向服务器发出服务请求，服务器接收到请求后，提供相应的服务。客户/服务器模式的建立基于以</span><span style="font-size:12px">下两点：首先，建立网络的起因是网络中软硬件资源、运算能力和信息不均等，需要共享，从而造就拥有众</span><span style="font-size:12px">多资源的主机提供服务，资源较少的客户请求服务这一非对等作用。其次，网间进程通信完全是异步的，相</span><span style="font-size:12px">互通信的进程间既不存在父子关系，又不共享内存缓冲区，因此需要一种机制为希望通信的进程间建立联系</span><span style="font-size:12px">，为二者的数据交换提供同步，这就是基于不同的客户/服务器模式的TCP/IP。 </span><span style="font-size:12px">客户/服务器模式在工作过程中采取的是主动请求方式： </span></p> 
 <p><span style="color:rgb(51,51,255)"><span style="font-size:12px">服务器方：</span></span></p> 
 <p><span style="font-size:12px">首先服务器方要先启动，并根据请求提供相应服务： </span></p> 
 <p><span style="font-size:12px">1. 打开一通信通道并告知本地主机，它愿意在某一公认地址上（周知口，如FTP为21）接收客户请求； </span></p> 
 <p><span style="font-size:12px">2. 等待客户请求到达该端口； </span></p> 
 <p><span style="font-size:12px">3. 接收到重复服务请求，处理该请求并发送应答信号。接收到并发服务请求，要激活一新进程来处理这个</span><span style="font-size:12px">客户请求（如UNIX系统中用fork、exec）。新进程处理此客户请求，并不需要对其它请求作出应答。服务完</span><span style="font-size:12px">成后，关闭此新进程与客户的通信链路，并终止。 </span></p> 
 <p><span style="font-size:12px">4. 返回第二步，等待另一客户请求。 </span></p> 
 <p><span style="font-size:12px">5. 关闭服务器 </span></p> 
 <span style="font-size:12px"><span style="color:rgb(51,51,255)">客户方</span>： </span> 
 <p><span style="font-size:12px">1. 打开一通信通道，并连接到服务器所在主机的特定端口； </span></p> 
 <p><span style="font-size:12px">2. 向服务器发服务请求报文，等待并接收应答；继续提出请求...... </span></p> 
 <p><span style="font-size:12px">3. 请求结束后关闭通信通道并终止。 </span><span style="font-size:12px"><br> </span></p> 
 <p><span style="font-size:12px">从上面所描述过程可知： </span></p> 
 <p><span style="font-size:12px">1. 客户与服务器进程的作用是非对称的，因此编码不同。 </span></p> 
 <p><span style="font-size:12px">2. 服务进程一般是先于客户请求而启动的。只要系统运行，该服务进程一直存在，直到正常或强迫终止。 </span></p> 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t20" style="color:rgb(51,102,153)"></a>2.4 套接字类型  </h4> 
 <p></p> 
 <p><span style="font-size:12px">TCP/IP的socket提供下列三种类型套接字。 </span></p> 
 <span style="font-size:12px"><span style="color:rgb(51,51,255)">流式套接字（SOCK_STREAM）：</span><br> </span> 
 <p><span style="font-size:12px">提供了一个面向连接、可靠的数据传输服务，数据无差错、无重复地发送，且按发送顺序接收。内设流量控</span></p> 
 <p><span style="font-size:12px">制，避免数据流超限；数据被看作是字节流，无长度限制。文件传送协议（FTP）即使用流式套接字。 </span></p> 
 <span style="font-size:12px"><span style="color:rgb(51,51,255)">数据报式套接字（SOCK_DGRAM）：</span><br> </span> 
 <p><span style="font-size:12px">提供了一个无连接服务（<span style="color:rgb(51,51,255)">UDP</span>）。数据包以独立包形式被发送，不提供无错保证，</span></p> 
 <p><span style="font-size:12px">数据可能丢失或重复，并且接收顺序混乱。网络文件系统（NFS）使用数据报式套接字。 </span></p> 
 <p><span style="color:rgb(51,51,255)"><span style="font-size:12px">原始式套接字（SOCK_RAW） ：</span></span></p> 
 <p><span style="font-size:12px">该接口允许对较低层协议，如IP、ICMP直接访问。常用于检验新的协议实现或访问现有服务中配置的新设备。 </span></p> 
 <p><span style="font-size:12px"></span></p> 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t21" style="color:rgb(51,102,153)"></a>2.4 典型套接字调用过程举例  </h4> 
 <span style="font-size:12px">如前所述，TCP/IP协议的应用一般采用客户/服务器模式，因此在实际应用中，必须有客户和服务器两个进</span> 
 <span style="font-size:12px">程，并且首先启动服务器，其系统调用时序图如下。 </span> 
 <span style="font-size:12px">面向连接的协议（如TCP）的套接字系统调用如图2.1所示：</span> 
 <p><span style="font-size:12px"> <img alt="" src="https://images2.imgbox.com/66/e1/yxe48Be3_o.jpg" style="border:none; max-width:100%"></span></p> 
 <p><span style="font-size:12px">服务器必须首先启动，直到它执行完accept()调用，进入等待状态后，方能接收客户请求。假如客户在此前</span><span style="font-size:12px">启动，则connect()将返回出错代码，连接不成功。</span></p> 
 <p><span style="font-size:12px"><br> </span></p> 
 <p><span style="font-size:12px"> </span><span style="font-size:12px">无连接协议（<span style="color:rgb(51,51,255)">UDP</span>）的套接字调用如图2.2所示：  </span></p> 
 <p><span style="font-size:12px"><img alt="" src="https://images2.imgbox.com/65/e3/oz2Lwx6O_o.jpg" style="border:none; max-width:100%"><br> </span></p> 
 <p><span style="font-size:12px">无连接服务器也必须先启动，否则客户请求传不到服务进程。无连接客户不调用connect()。因此在数据发</span><span style="font-size:12px">送之前，客户与服务器之间尚未建立完全相关，但各自通过socket()和bind()建立了半相关。发送数据时，</span><span style="font-size:12px">发送方除指定本地套接字号外，还需指定接收方套接字号，从而在数据收发过程中动态地建立了全相关。 </span></p> 
 <p></p> 
 <p><span style="font-size:12px">实例 </span></p> 
 <p><span style="font-size:12px">本实例使用面向连接协议的客户/服务器模式，其流程如图2.3所示： </span></p> 
 <p><span style="font-size:12px"><img alt="" src="https://images2.imgbox.com/08/f9/ji03L79h_o.jpg" style="border:none; max-width:100%"><br> </span></p> 
 <p><span style="font-size:12px">服务器方程序： </span></p> 
 <p><span style="font-size:12px"></span></p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* File Name: streams.c */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;winsock.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;stdio.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#define TRUE 1 </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 这个程序建立一个套接字，然后开始无限循环；每当它通过循环接收到一个连接，则打印出一个信息。</span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">当连接断开，或接收到终止信息，则此连接结束，程序再接收一个新的连接。命令行的格式是：streams */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">main( )   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sock, length;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr_in server;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr tcpaddr;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> msgsock;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> buf[1024];   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> rval, len;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 建立套接字 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">sock = socket(AF_INET, SOCK_STREAM, 0);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (sock &lt; 0) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">perror(“opening stream socket”);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">exit(1);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 使用任意端口命名套接字 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">server.sin_family = AF_INET;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">server.sin_port = INADDR_ANY;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (bind(sock, (</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr *)&amp;server, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(server)) &lt; 0) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">perror(“binding stream socket”);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">exit(1);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 找出指定的端口号并打印出来 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">length = <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(server);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (getsockname(sock, (</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr *)&amp;server, &amp;length) &lt; 0) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">perror(“getting socket name”);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">exit(1);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">printf(“socket port #%d/n”, ntohs(server.sin_port));   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 开始接收连接 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">listen(sock, 5);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">len = <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">do</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">msgsock = accept(sock, (<span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr *)&amp;tcpaddr, (</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *)&amp;len);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (msgsock == -1)   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">perror(“accept”);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">else</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">do</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">{   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">memset(buf, 0, <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(buf));   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((rval = recv(msgsock, buf, 1024)) &lt; 0)   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">perror(“reading stream message”);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (rval == 0)   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">printf(“ending connection /n”);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">else</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">printf(“--&gt;;%s/n”, buf);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}<span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">while</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (rval != 0);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">closesocket(msgsock);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">} <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">while</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (TRUE);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 因为这个程序已经有了一个无限循环，所以套接字“sock”从来不显式关闭。然而，当进程被杀死或正</span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">常终止时，所有套接字都将自动地被关闭。*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">exit(0);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li></ol> 
 </div> 
 <p></p> 
 <p></p> 
 <p><span style="font-size:12px">客户方程序： </span></p> 
 <p></p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* File Name: streamc.c */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;winsock.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;stdio.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#define DATA “half a league, half a league ...” </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 这个程序建立套接字，然后与命令行给出的套接字连接；连接结束时，在连接上发送 </span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">一个消息，然后关闭套接字。命令行的格式是：streamc 主机名 端口号 </span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">端口号要与服务器程序的端口号相同 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">main(argc, argv)   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> argc;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *argv[ ];   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sock;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr_in server;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> hostent *hp, *gethostbyname( );   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> buf[1024];   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 建立套接字 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">sock = socket(AF_INET, SOCK_STREAM, 0);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (sock &lt; 0) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">perror(“opening stream socket”);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">exit(1);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 使用命令行中指定的名字连接套接字 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">server.sin_family = AF_INET;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">hp = gethostbyname(argv[1]);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (hp == 0) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">fprintf(stderr, “%s: unknown host /n”, argv[1]);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">exit(2);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">memcpy((<span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">*)&amp;server.sin_addr, (</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">*)hp-&gt;;h_addr, hp-&gt;;h_length);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">sever.sin_port = htons(atoi(argv[2]));   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (connect(sock, (</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr*)&amp;server, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(server)) &lt; 0) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">perror(“connecting stream socket”);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">exit(3);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (send(sock, DATA, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(DATA)) &lt; 0)   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">perror(“sending on stream socket”);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">closesocket(sock);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">exit(0);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li></ol> 
 </div> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t22" style="color:rgb(51,102,153)"></a>2.5 一个通用的实例程序  </h4> 
 <span style="font-size:12px">在上一节中，我们介绍了一个简单的socket程序实例。从这个例子我们可以看出，使用socket编程几乎有一</span> 
 <span style="font-size:12px">个模式，即所有的程序几乎毫无例外地按相同的顺序调用相同的函数。因此我们可以设想，设计一个中间层</span> 
 <span style="font-size:12px">，它向上提供几个简单的函数，程序只要调用这几个函数就可以实现普通的网络数据传输，程序设计者不必</span> 
 <span style="font-size:12px">太多地关心socket程序设计的细节。 </span> 
 <span style="font-size:12px">本节我们将介绍一个通用的网络程序接口，它向上层提供几个简单的函数，程序设计者只要使用这几个函数</span> 
 <span style="font-size:12px">就可以完成绝大多数网络数据传输。这些函数将socket编程和上层隔离开来，它使用面向连接的流式套接字</span> 
 <span style="font-size:12px">，采用非阻塞的工作机制，程序只要调用这些函数查询网络消息并作出相应的响应即可。这些函数包括： </span> 
 <p><span style="font-size:12px">l InitSocketsStruct：初始化socket结构，获取服务端口号。客户程序使用。 </span></p> 
 <p><span style="font-size:12px">l InitPassiveSock：初始化socket结构，获取服务端口号，建立主套接字。服务器程序使用。 </span></p> 
 <p><span style="font-size:12px">l CloseMainSock：关闭主套接字。服务器程序使用。 </span></p> 
 <p><span style="font-size:12px">l CreateConnection：建立连接。客户程序使用。 </span></p> 
 <p><span style="font-size:12px">l AcceptConnection：接收连接。服务器程序使用。 </span></p> 
 <p><span style="font-size:12px">l CloseConnection：关闭连接。 </span></p> 
 <p><span style="font-size:12px">l QuerySocketsMsg：查询套接字消息。 </span></p> 
 <p><span style="font-size:12px">l SendPacket：发送数据。 </span></p> 
 <p><span style="font-size:12px">l RecvPacket：接收数据。 </span></p> 
 <p></p> 
 <p><strong><span style="font-size:12px">2.5.1 头文件  </span></strong></p> 
 <span style="font-size:12px">/* File Name: tcpsock.h */ </span> 
 <p></p> 
 <p><span style="font-size:12px">/* 头文件包括socket程序经常用到的系统头文件（本例中给出的是SCO Unix下的头文件，其它版本的Unix</span><span style="font-size:12px">的头文件可能略有不同），并定义了我们自己的两个数据结构及其实例变量，以及我们提供的函数说明。*/</span></p> 
 <p></p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* File Name: tcpsock.h */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  头文件包括 socket 程序经常用到的系统头文件（本例中给出的是 SCO Unix下的头文件，其它版本的 Unix的头文件</span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">可能略有不同），并定义了我们自己的两个数据结构及其实例变量，以及我们提供的函数说明。*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;stdio.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;string.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;time.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/tape.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/signal.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/errno.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/types.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/ioctl.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/select.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/socket.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/stat.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/netinet/in.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;sys/netinet/tcp.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;arpa/inet.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include &lt;netdb.h&gt; </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">typedef</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> SocketsMsg{ </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  套接字消息结构 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> AcceptNum;  </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  指示是否有外来连接等待接收 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ReadNum;   </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  有外来数据等待读取的连接数 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ReadQueue[32];   </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  有外来数据等待读取的连接队列 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> WriteNum;   </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  可以发送数据的连接数 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> WriteQueue[32];   </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  可以发送数据的连接队列 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ExceptNum;  </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  有例外的连接数 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ExceptQueue[32];   </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  有例外的连接队列 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">} SocketsMsg;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"> <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">typedef</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> Sockets {  </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  套接字结构 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> DaemonSock;  </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  主套接字 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> SockNum;   </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  数据套接字数目 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> Sockets[64];  </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  数据套接字数组 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    fd_set readfds, writefds, exceptfds; <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  要被检测的可</span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">    int Port;    /*  端口号 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">} Sockets;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">Sockets Mysock;   <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  全局变量 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">SocketsMsg SockMsg;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> InitSocketsStruct(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> * servicename) ;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> InitPassiveSock(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> * servicename) ;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">void</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> CloseMainSock();   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> CreateConnection(</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> in_addr *sin_addr);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> AcceptConnection(</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> in_addr *IPaddr);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> CloseConnection(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> Sockno);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> QuerySocketsMsg();   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> SendPacket(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> Sockno, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">void</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *buf, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> len);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> RecvPacket(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> Sockno, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">void</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *buf, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> size);   </span></span></li></ol> 
 </div> 
 <p></p> 
 <p><span style="font-size:12px"><strong>2.5.2 函数源文件</strong>  </span></p> 
 <p><span style="font-size:12px"></span></p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* File Name: tcpsock.c */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  本文件给出九个函数的源代码，其中部分地方给出中文注释 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include "tcpsock.h" </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> InitSocketsStruct(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> * servicename)    </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Initialize Sockets structure. If succeed then return 1, else return error code (&lt;0) */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  此函数用于只需要主动套接字的客户程序，它用来获取服务信息。服务的定义 </span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">    在/etc/services 文件中 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> servent *servrec;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr_in serv_addr;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((servrec = getservbyname(servicename, </span><span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"tcp"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">)) == NULL) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">         <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-1);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     }           </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     bzero((<span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *)&amp;Mysock, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(Sockets));  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     Mysock.Port = servrec-&gt;s_port;  <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Service Port in Network Byte Order */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(1);       </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> InitPassiveSock(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> * servicename)    </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Initialize Passive Socket. If succeed then return 1, else return error code (&lt;0) */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  此函数用于需要被动套接字的服务器程序，它除了获取服务信息外，还建立 </span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">    一个被动套接字。*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> mainsock, flag=1;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> servent *servrec;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr_in serv_addr;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((servrec = getservbyname(servicename, </span><span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"tcp"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">)) == NULL) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-1);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    }           </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    bzero((<span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *)&amp;Mysock, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(Sockets));   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    Mysock.Port = servrec-&gt;s_port;  <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Service Port in Network Byte Order */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">((mainsock = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-2);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    }bzero((<span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *)&amp;serv_addr, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(serv_addr));   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    serv_addr.sin_family = AF_INET;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);   <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  任意网络接口 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    serv_addr.sin_port = servrec-&gt;s_port;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (bind(mainsock, (</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr*)&amp;serv_addr, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(serv_addr)) &lt; 0) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        close(mainsock);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-3);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (listen(mainsock, 5) == -1) { </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  将主动套接字变为被动套接字，准备好接收连接 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      close(mainsock);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-4);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    }   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Set this socket as a Non-blocking socket. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (ioctl(mainsock, FIONBIO, &amp;flag) == -1) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      close(mainsock);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-5);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    }   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    Mysock.DaemonSock = mainsock;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_SET(mainsock, &amp;Mysock.readfds);  <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  申明对主套接字“可读”感兴趣 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_SET(mainsock, &amp;Mysock.exceptfds);  <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  申明对主套接字上例外事件感兴趣 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(1);       </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">void</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> CloseMainSock()   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  关闭主套接字，并清除对它上面事件的申明。在程序结束前关闭主套接字是一个好习惯 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    close(Mysock.DaemonSock);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_CLR(Mysock.DaemonSock, &amp;Mysock.readfds);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_CLR(Mysock.DaemonSock, &amp;Mysock.exceptfds);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> CreateConnection(</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> in_addr *sin_addr)   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Create a Connection to remote host which IP address is in sin_addr.  </span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">   Param: sin_addr indicates the IP address in Network Byte Order.  </span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">   if succeed return the socket number which indicates this connection, </span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">   else return error code (&lt;0) */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr_in server;  </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* server address */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> tmpsock, flag=1, i;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((tmpsock = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0)   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-1);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    server.sin_family = AF_INET;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    server.sin_port = Mysock.Port;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    server.sin_addr.s_addr = sin_addr-&gt;s_addr;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Set this socket as a Non-blocking socket. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (ioctl(tmpsock, FIONBIO, &amp;flag) == -1) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      close(tmpsock);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-2);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    }   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Connect to the server. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (connect(tmpsock, (</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr *)&amp;server, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(server)) &lt; 0) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((errno != EWOULDBLOCK) &amp;&amp; (errno != EINPROGRESS)) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">         <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  如果错误代码是 EWOULDBLOCK 和 EINPROGRESS，则不用关闭套接字，因为系统将在之后继续为套接字建</span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">        立连接，连接是否建立成功可用 select()函数来检测套接字是否“可写”来确定。*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           close(tmpsock);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-3); </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Connect error. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   }  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   FD_SET(tmpsock, &amp;Mysock.readfds);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   FD_SET(tmpsock, &amp;Mysock.writefds);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   FD_SET(tmpsock, &amp;Mysock.exceptfds);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    i = 0;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">while</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (Mysock.Sockets[i] != 0) i++; </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* look for a blank sockets position */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (i &gt;= 64) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        close(tmpsock);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-4); </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* too many connections */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    }   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    Mysock.Sockets[i] = tmpsock;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    Mysock.SockNum++;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(i);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> AcceptConnection(</span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> in_addr *IPaddr)   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Accept a connection. If succeed, return the data sockets number, else return -1. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> newsock, len, flag=1, i;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr_in addr;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    len = <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(addr);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    bzero((<span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *)&amp;addr, len);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((newsock = accept(Mysock.DaemonSock, &amp;addr, &amp;len)) == -1)    </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-1); </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Accept error. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Set this socket as a Non-blocking socket. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    ioctl(newsock, FIONBIO, &amp;flag);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_SET(newsock, &amp;Mysock.readfds);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_SET(newsock, &amp;Mysock.writefds);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_SET(newsock, &amp;Mysock.exceptfds);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Return IP address in the Parameter. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    IPaddr-&gt;s_addr = addr.sin_addr.s_addr;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     i = 0;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">while</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (Mysock.Sockets[i] != 0) i++; </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* look for a blank sockets position */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (i &gt;= 64) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        close(newsock);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-4); </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* too many connections */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    Mysock.Sockets[i] = newsock;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    Mysock.SockNum++;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(i);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> CloseConnection(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> Sockno)   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Close a connection indicated by Sockno. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> retcode;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((Sockno &gt;= 64) || (Sockno &lt; 0) || (Mysock.Sockets[Sockno] == 0））  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(0);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     retcode = close(Mysock.Sockets[Sockno]);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_CLR(Mysock.Sockets[Sockno], &amp;Mysock.readfds);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_CLR(Mysock.Sockets[Sockno], &amp;Mysock.writefds);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    FD_CLR(Mysock.Sockets[Sockno], &amp;Mysock.exceptfds);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    Mysock.Sockets[Sockno] = 0;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    Mysock.SockNum--;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(retcode);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> QuerySocketsMsg()   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Query Sockets Message. If succeed return message number, else return -1. </span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">  The message information stored in struct SockMsg. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    fd_set rfds, wfds, efds;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> retcode, i;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> timeval TimeOut;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     rfds = Mysock.readfds;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     wfds = Mysock.writefds;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     efds = Mysock.exceptfds;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     TimeOut.tv_sec = 0;  <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  立即返回，不阻塞。*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     TimeOut.tv_usec = 0;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     bzero((<span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *)&amp;SockMsg, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(SockMsg));   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((retcode = select(64, &amp;rfds, &amp;wfds, &amp;efds, &amp;TimeOut)) == 0)   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(0);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (FD_ISSET(Mysock.DaemonSock, &amp;rfds))   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      SockMsg.AcceptNum = 1;  <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* some client call server. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">for</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (i=0; i&lt;64; i++)  </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Data in message */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     {   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((Mysock.Sockets[i] &gt; 0) &amp;&amp; (FD_ISSET(Mysock.Sockets[i], &amp;rfds)))    </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           SockMsg.ReadQueue[SockMsg.ReadNum++] = i;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     }   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">for</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (i=0; i&lt;64; i++)  </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Data out ready message */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     {   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((Mysock.Sockets[i] &gt; 0) &amp;&amp; (FD_ISSET(Mysock.Sockets[i], &amp;wfds)))    </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           SockMsg.WriteQueue[SockMsg.WriteNum++] = i;   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     }   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (FD_ISSET(Mysock.DaemonSock, &amp;efds))   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      SockMsg.AcceptNum = -1;  <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* server socket error. */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">for</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (i=0; i&lt;64; i++)  </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Error message */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     {   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((Mysock.Sockets[i] &gt; 0) &amp;&amp; (FD_ISSET(Mysock.Sockets[i], &amp;efds)))    </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           SockMsg.ExceptQueue[SockMsg.ExceptNum++] = i;   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(retcode);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> SendPacket(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> Sockno, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">void</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *buf, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> len)   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Send a packet. If succeed return the number of send data, else return -1 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">    </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> actlen;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((Sockno &gt;= 64) || (Sockno &lt; 0) || (Mysock.Sockets[Sockno] == 0))   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(0);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((actlen = send(Mysock.Sockets[Sockno], buf, len, 0)) &lt; 0)   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(-1);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"> <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(actlen);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> RecvPacket(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> Sockno, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">void</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *buf, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> size)   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* Receive a packet. If succeed return the number of receive data, else if the connection </span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">  is shutdown by peer then return 0, otherwise return 0-errno */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">    </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> actlen;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((Sockno &gt;= 64) || (Sockno &lt; 0) || (Mysock.Sockets[Sockno] == 0))   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(0);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((actlen = recv(Mysock.Sockets[Sockno], buf, size, 0)) &lt; 0)   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(0-errno);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"> <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">return</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(actlen); </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* actlen 是接收的数据长度，如果为零，指示连接被对方关闭。*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}  </span></li></ol> 
 </div> 
 <p></p> 
 <p><span style="font-size:12px"><strong>2.5.3 简单服务器程序示例  </strong></span></p> 
 <p></p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* File Name: server.c */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  这是一个很简单的重复服务器程序，它初始化好被动套接字后，循环等待接收连接。如果接收到连接，它显示数据</span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">套接字序号和客户端的 IP 地址；如果数据套接字上有数据到来，它接收数据并显示该连接的数据套接字序号和接收到</span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">的字符串。*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include "tcpsock.c" </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">main(argc, argv)   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> argc;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> **argv;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"> <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> in_addr sin_addr;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> retcode, i;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> buf[32];   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  对于服务器程序，它经常是处于无限循环状态，只有在用户主动 kill 该进程或系统关机时，它才结束。对于使用 kill</span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">强行终止的服务器程序，由于主套接字没有关闭，资源没有主动释放，可能会给随后的服务器程序重新启动产生影响。</span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">因此，主动关闭主套接字是一个良好的变成习惯。下面的语句使程序在接收到 SIGINT、SIGQUIT和 SIGTERM 等信号</span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">时先执行 CloseMainSock()函数关闭主套接字，然后再结束程序。因此，在使用 kill 强行终止服务器进程时，应该先使</span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">用 kill -2 PID 给服务器程序一个消息使其关闭主套接字，然后在用 kill -9 PID 强行结束该进程。*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    (<span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">void</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">) signal(SIGINT, CloseMainSock);    </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    (<span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">void</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">) signal(SIGQUIT, CloseMainSock);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    (<span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">void</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">) signal(SIGTERM, CloseMainSock);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"> <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((retcode = InitPassiveSock(</span><span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"TestService"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">)) &lt; 0) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"InitPassiveSock: error code = %d\n"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, retcode);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  exit(-1);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     }   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">while</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (1) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  retcode = QuerySocketsMsg(); <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  查询网络消息 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (SockMsg.AcceptNum == 1) { </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  有外来连接等待接收？*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       retcode = AcceptConnection(&amp;sin_addr);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"retcode = %d, IP = %s \n"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, retcode, inet_ntoa(sin_addr.s_addr));   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">else</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (SockMsg.AcceptNum == -1) </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  主套接字错误？*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"Daemon Sockets error.\n"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">for</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (i=0; i&lt;SockMsg.ReadNum; i++) { </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  接收外来数据 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((retcode = RecvPacket(SockMsg.ReadQueue[i], buf, 32)) &gt; 0)   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"sockno %d Recv string = %s \n"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, SockMsg.ReadQueue[i], buf);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">else</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  返回数据长度为零，指示连接中断，关闭套接字。*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    CloseConnection(SockMsg.ReadQueue[i]);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  } <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* end while */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">}  </span></li></ol> 
 </div> 
 <span style="font-size:12px"></span> 
 <p></p> 
 <p></p> 
 <p><strong><span style="font-size:12px">2.5.4 简单客户程序示例</span></strong></p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* File Name: client.c */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  客户程序在执行时，先初始化数据结构，然后等待用户输入命令。它识别四个命令： </span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">conn(ect)：  和服务器建立连接； </span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">send：  给指定连接发送数据； </span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">clos(e)：  关闭指定连接； </span> </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">quit：   退出客户程序。 </span> </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="preprocessor" style="margin:0px; padding:0px; border:none; color:gray; background-color:inherit">#include "tcpsock.h" </span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">main(argc, argv)   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> argc;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> **argv;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">{   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">  <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> cmd_buf[16];   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> in_addr sin_addr;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockno1, retcode;   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> *buf = </span><span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"This is a string for test."</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">;   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     sin_addr.s_addr = inet_addr(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"166.111.5.249"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">);    </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  运行服务器程序的主机的 IP 地址 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((retcode = InitSocketsStruct(</span><span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"TestService"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">)) &lt; 0) { </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  初始化数据结构 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">          printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"InitSocketsStruct: error code =  %d\n"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, retcode);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      exit(1);   </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">     }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">        </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">         <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">while</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (1) {   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">       printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"&gt;"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      gets(cmd_buf);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (!strncmp(cmd_buf, </span><span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"conn"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, 4)) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           retcode = CreateConnection(&amp;sin_addr); <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  建立连接 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"return code: %d\n"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, retcode);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">else</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(!strncmp(cmd_buf, </span><span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"send"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, 4)) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"Sockets Number:"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           scanf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"%d"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, &amp;sockno1);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           retcode = SendPacket(sockno1, buf, 26); <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  发送数据 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"return code: %d\n"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, retcode, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">sizeof</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(buf));   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">else</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (!strncmp(cmd_buf, </span><span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"close"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, 4)) {   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"Sockets Number:"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           scanf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"%d"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, &amp;sockno1);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           retcode = CloseConnection(sockno1);  <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*  关闭连接 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           printf(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"return code: %d\n"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, retcode);   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      }   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">else</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (!strncmp(cmd_buf, </span><span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">"quit"</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">, 4))    </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           exit(0);   </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">else</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">   </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">           putchar(<span class="string" style="margin:0px; padding:0px; border:none; color:rgb(0,153,0); background-color:inherit">'\007'</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">);   </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">      } <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* e</span></span></li></ol> 
 </div> 
</blockquote> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <h3 class="headline-1 bk-sidecatalog-title" style="margin:0px 0px 10px; padding:0px 0px 6px; border-bottom-color:rgb(222,223,225); border-bottom-width:1px; border-bottom-style:solid; clear:both"> <a target="_blank" name="t24" style="color:rgb(51,102,153)"></a><span style="color:rgb(51,102,153)"><span style="line-height:36px; font-size:22px">3、基本socket系统条调用</span></span></h3> 
 <br> 
</div> 
<blockquote style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px; border:medium none; padding:0px; margin:0px 0px 0px 40px"> 
 <p><span style="font-size:12px">为了更好地说明套接字编程原理，下面给出几个基本套接字系统调用说明。</span></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t25" style="color:rgb(51,102,153)"></a>3.1 创建套接字──socket()</h4> 
 <p><span style="font-size:12px">应用程序在使用套接字前，首先必须拥有一个套接字，系统调用socket()向应用程序提供创建套接字的手段，其调用格式如下：</span></p> 
 <p><span style="font-size:12px"></span></p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span style="margin:0px; padding:0px; border:none; background-color:inherit">SOCKET PASCAL FAR socket(</span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> af, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> type, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> protocol);  </span></span></li></ol> 
 </div> 
 <p></p> 
 <p><span style="font-size:12px"></span></p> 
 <p></p> 
 <p>该调用要接收三个参数：af、type、protocol。参数af指定通信发生的区域，UNIX系统支持的地址族有：AF_UNIX、AF_INET、AF_NS等，而DOS、WINDOWS中仅支持AF_INET，它是网际网区域。因此，地址族与协议族相同。参数type 描述要建立的套接字的类型。参数protocol说明该套接字使用的特定协议，如果调用者不希望特别指定使用的协议，则置为0，使用默认的连接模式。根据这三个参数建立一个套接字，并将相应的资源分配给它，同时返回一个整型套接字号。因此，socket()系统调用实际上指定了相关五元组中的“协议”这一元。</p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t26" style="color:rgb(51,102,153)"></a><br> 3.2 指定本地地址──bind()</h4> 
 <p><strong></strong><br>  当一个套接字用socket()创建后，存在一个名字空间(地址族),但它没有被命名。bind()将套接字地址（包括本地主机地址和本地端口地址）与所创建的套接字号联系起来，即将名字赋予套接字，以指定本地半相关。其调用格式如下：<br> </p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> PASCAL FAR bind(SOCKET s, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">const</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr FAR * name, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> namelen);  </span></span></li></ol> 
 </div> 
 <br> 参数s：是由socket()调用返回的并且未作连接的套接字描述符(套接字号)。 
 <br> 参数name： 是赋给套接字s的本地地址（名字），其长度可变，结构随通信域的不同而不同。 
 <br> 参数namelen：表明了name的长度。 
 <br> 如果没有错误发生，bind()返回0。否则返回值SOCKET_ERROR。 
 <br> 地址在建立套接字通信过程中起着重要作用，作为一个网络应用程序设计者对套接字地址结构必须有明确认识。例如，UNIX BSD有一组描述套接字地址的数据结构，其中使用TCP/IP协议的地址结构为： 
 <br> 
 <p></p> 
 <p></p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr_in{  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">short</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sin_family; </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*AF_INET*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    u_short sin_port; <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*16位端口号，网络字节顺序*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> in_addr sin_addr; </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*32位IP地址，网络字节顺序*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sin_zero[8]; </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/*保留*/</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    }  </span></li></ol> 
 </div> 
 <br> 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t27" style="color:rgb(51,102,153)"></a>3.3 建立套接字连接──connect()与accept()</h4> 
 <p><strong></strong><br> 这两个系统调用用于完成一个完整相关的建立，其中connect()用于建立连接。无连接的套接字进程也可以调用connect()，但这时在进程之间没有实际的报文交换，调用将从本地操作系统直接返回。这样做的优点是程序员不必为每一数据指定目的地址，而且如果收到的一个数据报，其目的端口未与任何套接字建立“连接”，便能判断该端<span style="line-height:25.984375px"><span style="font-size:12px">便能判断该端口不可操作</span></span>。而accept()用于使服务器等待来自某客户进程的实际连接。<br>     connect()的调用格式如下：<br>  </p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> PASCAL FAR connect(SOCKET s, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">const</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr FAR * name, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> namelen);  </span></span></li></ol> 
 </div> 
 <br>     参数s：是欲建立连接的本地套接字描述符。 
 <br>     参数name：指出说明对方套接字地址结构的指针。 
 <br>     namele：对方套接字地址长度由namelen说明。 
 <br>     如果没有错误发生，connect()返回0。否则返回值SOCKET_ERROR。在面向连接的协议中，该调用导致本地系统和外部系统之间连接实际建立。 
 <br>     由于地址族总被包含在套接字地址结构的前两个字节中，并通过socket()调用与某个协议族相关。因此bind()和connect()无须协议作为参数。 
 <br>     accept()的调用格式如下： 
 <br> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span style="margin:0px; padding:0px; border:none; background-color:inherit">SOCKET PASCAL FAR accept(SOCKET s, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">struct</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> sockaddr FAR* addr, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> FAR* addrlen);  </span></span></li></ol> 
 </div> 
 <br> 参数s：为本地套接字描述符，在用做accept()调用的参数前应该先调用过listen()。 
 <br> 参数addr： 指向客户方套接字地址结构的指针，用来接收连接实体的地址。addr的确切格式由套接字创建时建立的地址族决定。 
 <br> 参数addrlen: 为客户方套接字地址的长度（字节数）。如果没有错误发生，accept()返回一个SOCKET类型的值，表示接收到的套接字的描述符。否则返回值INVALID_SOCKET。 
 <br>     accept()用于面向连接服务器。参数addr和addrlen存放客户方的地址信息。调用前，参数addr 指向一个初始值为空的地址结构，而addrlen 的初始值为0；调用accept()后，服务器等待从编号为s的套接字上接受客户连接请求，而连接请求是由客户方的connect()调用发出的。当有连接请求到达时，accept()调用将请求连接队列上的第一个客户方套接字地址及长度放入addr 和addrlen，并创建一个与s有相同特性的新套接字号。新的套接字可用于处理服务器并发请求。 
 <br>     四个套接字系统调用，socket()、bind()、connect()、accept()，可以完成一个完全五元相关的建立。socket()指定五元组中的协议元，它的用法与是否为客户或服务器、是否面向连接无关。bind()指定五元组中的本地二元，即本地主机地址和端口号，其用法与是否面向连接有关：在服务器方，无论是否面向连接，均要调用bind()；在客户方，若采用面向连接，则可以不调用bind()，而通过connect()自动完成。若采用无连接，客户方必须使用bind()以获得一个唯一的地址。 
 <br> 
 <p>    以上讨论仅对客户/服务器模式而言，实际上套接字的使用是非常灵活的，唯一需遵循的原则是进程通信之前，必须建立完整的相关。</p> 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t28" style="color:rgb(51,102,153)"></a><br>  3.4 监听连接──listen()</h4> 
 <p><strong></strong> </p> 
 <p>    此调用用于面向连接服务器，表明它愿意接收连接。listen()需在accept()之前调用，其调用格式如下：<br> int PASCAL FAR listen(SOCKET s, int backlog);<br>     参数s标识一个本地已建立、尚未连接的套接字号，服务器愿意从它上面接收请求。backlog表示请求连接队列的最大长度，用于限制排队请求的个数，目前允许的最大值为5。如果没有错误发生，listen()返回0。否则它返回SOCKET_ERROR。<br>     listen()在执行调用过程中可为没有调用过bind()的套接字s完成所必须的连接，并建立长度为backlog的请求连接队列。<br>     调用listen()是服务器接收一个连接请求的四个步骤中的第三步。它在调用socket()分配一个流套接字，且调用bind()给s赋于一个名字之后调用，而且一定要在accept()之前调用。<br>     2.3节中提到钥纪纪户/服务器模式中，有两种类型的服务：重复服务和并发服务。accept()调用为实现并发服务提供了极大方便，因为它要返回一个新的套接字号，其典型结构为：<br> </p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> initsockid, newsockid;  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((initsockid = socket(....)) &lt; 0)  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   error(“can’t create socket”);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (bind(initsockid,....) &lt; 0)  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   error(“bind error”);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (listen(initsockid , 5) &lt; 0)  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   error(“listen error”);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">for</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (; {  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   newsockid = accept(initsockid, ...) <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 阻塞 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (newsockid &lt; 0)  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   error(“accept error“);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (fork() == 0){ </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 子进程 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   closesocket(initsockid);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">do</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(newsockid); </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 处理请求 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   exit(0);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   }  </span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   closesocket(newsockid); <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 父进程 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">   }  </span></li></ol> 
 </div> 
 <br> 
 <br>     这段程序执行的结果是newsockid与客户的套接字建立相关，子进程启动后，关闭继承下来的主服务器的initsockid,并利用新的newsockid与客户通信。主服务器的initsockid可继续等待新的客户连接请求。由于在Unix等抢先多任务系统中，在系统调度下，多个进程可以同时进行。因此，使用并发服务器可以使服务器进程在同一时间可以有多个子进程和不同的客户程序连接、通信。钥纪纪户程序看来，服务器可以同时并发地处理多个客户的请求，这就是并发服务器名称的来由。 
 <br>     面向连接服务器也可以是重复服务器，其结构如下： 
 <br> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> initsockid, newsockid;  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> ((initsockid = socket(....))&lt;0)  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    error(“can’t create socket”);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (bind(initsockid,....)&lt;0)  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    error(“bind error”);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (listen(initsockid,5)&lt;0)  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    error(“listen error”);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">for</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (; {  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    newsockid = accept(initsockid, ...) <span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 阻塞 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">if</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> (newsockid &lt; 0)  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    error(“accept error“);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    <span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">do</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">(newsockid); </span><span class="comment" style="margin:0px; padding:0px; border:none; color:rgb(153,153,153); background-color:inherit">/* 处理请求 */</span><span style="margin:0px; padding:0px; border:none; background-color:inherit">  </span></span></li><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    closesocket(newsockid);  </span></li><li style="border:none; list-style:decimal-leading-zero outside; line-height:13px; margin:0px!important; padding:0px 3px 0px 10px!important"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit">    }  </span></li></ol> 
 </div> 
 <br> 
 <br>     重复服务器在一个时间只能和一个客户程序建立连接，它对多个客户程序的处理是采用循环的方式重复进行，因此叫重复服务器。并发服务器和重复服务器各有利弊：并发服务器可以改善客户程序的响应速度，但它增加了系统调度的开销；重复服务器正好与其相反，因此用户在决定是使用并发服务器还是重复服务器时，要根据应用的实际情考网考网来定。 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t29" style="color:rgb(51,102,153)"></a><br> 3.5 数据传输──send()与recv()</h4> 
 <p><strong></strong><br>     当一个连接建立以后，就可以传输数据了。常用的系统调用有send()和recv()。<br>     send()调用用于钥纪纪数s指定的已连接的数据报或流套接字上发送输出数据，格式如下：<br> </p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> PASCAL FAR send(SOCKET s, </span><span class="keyword" style="margin:0px; padding:0px; border:none; color:rgb(0,0,255); background-color:inherit; font-weight:bold">const</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> FAR *buf, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> len, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> flags);  </span></span></li></ol> 
 </div> 
 <br> 参数s:为已连接的本地套接字描述符。 
 <br> buf 指向存有发送数据的缓冲区的指针， 
 <br> len :buf长度由len 指定。 
 <br> flags 指定传输控制方式，如是否发送带外数据等。 
 <br> 如果没有错误发生，send()返回总共发送的字节数。否则它返回SOCKET_ERROR。 
 <br>     recv()调用用于钥纪纪数s指定的已连接的数据报或流套接字上接收输入数据，格式如下： 
 <br> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> PASCAL FAR recv(SOCKET s, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">char</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> FAR *buf, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> len, </span><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">int</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> flags);  </span></span></li></ol> 
 </div> 
 <br> 参数s 为已连接的套接字描述符。 
 <br> buf:指向接收输入数据缓冲区的指针， 
 <br> len :buf长度由len 指定。 
 <br> flags 指定传输控制方式，如是否接收带外数据等。 
 <br> 如果没有错误发生，recv()返回总共接收的字节数。如果连接被关闭，返回0。否则它返回SOCKET_ERROR。 
 <p></p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t30" style="color:rgb(51,102,153)"></a><br> 3.6 输入/输出多路复用──select()</h4> 
 <p><strong></strong><br>      select()调用用来检测一个或多个套接字的状态。对每一个套接字来说，这个调用可以请求读、写或错误状态方面的信息。请求给定状态的套接字集合由一个fd_set结构指示。在返回时，此结构被更新，以反映那些满足特定条件的套接字的子集，同时， select()调用返回满足条件的套接字的数目，其调用格式如下：<br>     int PASCAL FAR select(int nfds, fd_set FAR * readfds, fd_set FAR * writefds, fd_set FAR * exceptfds, const struct timeval FAR * timeout);<br> 参数nfds:指明被检查的套接字描述符的值域，此变量一般被忽略。<br> 参数readfds:指向要做读检测的套接字描述符集合的指针，调用者希望从中读取数据。<br> 参数writefds :指向要做写检测的套接字描述符集合的指针。<br> exceptfds指向要检测是否出错的套接字描述符集合的指针。<br> imeout指向select()函数等待的最大时间，如果设为NULL则为阻塞操作。<br> select()返回包含在fd_set结构中已准备好的套接字描述符的总数目，或者是发生错误则返回SOCKET_ERROR。</p> 
 <h4 style="margin:0px; padding:0px"><a target="_blank" name="t31" style="color:rgb(51,102,153)"></a><br> 3.7 关闭套接字──closesocket()</h4> 
 <p><strong><br> </strong>      closesocket()关闭套接字s，并释放分配给该套接字的资源；如果s涉及一个打开的TCP连接，则该连接被释放。closesocket()的调用格式如下：<br> </p> 
 <div class="dp-highlighter bg_cpp" style="font-family:Consolas,'Courier New',Courier,mono,serif; border:1px dashed rgb(153,153,153); background-color:rgb(245,245,245); font-size:12px; width:661.3125px; overflow:auto; padding-top:1px; margin:18px 0px!important"> 
  <ol start="1" class="dp-cpp" style="margin:0px; padding:5px 0px; border:none; position:relative; list-style-position:initial; color:rgb(92,92,92)"><li class="alt" style="margin:0px!important; padding:0px 3px 0px 10px!important; border:none; list-style:decimal-leading-zero outside; color:inherit; line-height:13px"> <span style="margin:0px; padding:0px; border:none; color:black; background-color:inherit"><span class="datatypes" style="margin:0px; padding:0px; border:none; color:rgb(46,139,87); background-color:inherit; font-weight:bold">BOOL</span><span style="margin:0px; padding:0px; border:none; background-color:inherit"> PASCAL FAR closesocket(SOCKET s);  </span></span></li></ol> 
 </div> 
 <br> 参数s待关闭的套接字描述符。如果没有错误发生，closesocket()返回0。否则返回值SOCKET_ERROR。 
 <br>         
 <br> 
 <p></p> 
</blockquote> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="font-size:18px"></span></p> 
<p style="color:rgb(51,51,51); font-size:14px; line-height:26px; font-family:Simsun; text-indent:2em"> </p> 
<h3 class="headline-1 bk-sidecatalog-title" style="margin:0px 0px 10px; padding:0px 0px 6px; color:rgb(51,51,51); font-family:Arial; line-height:26px; border-bottom-color:rgb(222,223,225); border-bottom-width:1px; border-bottom-style:solid; clear:both"> <a target="_blank" name="t32" style="color:rgb(51,102,153)"></a><span style="color:rgb(51,102,153)"><span style="line-height:36px; font-size:22px">4、TCP（socket建立）连接的时间</span></span></h3> 
<span style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">TCP建立连接，根据网络环境不同，使用的时间如下：</span> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> </p> 
<p style="color:rgb(51,51,51); font-size:14px; line-height:26px; font-family:Simsun; text-indent:2em"> <span style="line-height:19px; white-space:pre; background-color:rgb(248,248,248)">1、本机的话，通信内容直接走内存。</span></p> 
<p style="color:rgb(51,51,51); font-size:14px; line-height:26px; font-family:Simsun; text-indent:2em"> <span style="line-height:19px; white-space:pre; background-color:rgb(248,248,248)">2、局域网走网卡，然后通过交换机，指定到相应主机。tcp建立3次握手，一般耗0.6毫秒左右。</span></p> 
<p style="color:rgb(51,51,51); font-size:14px; line-height:26px; font-family:Simsun; text-indent:2em"> <span style="line-height:19px; white-space:pre; background-color:rgb(248,248,248)">3、外网通过网卡-&gt;路由器-&gt;互联网。</span></p> 
<p style="color:rgb(51,51,51); font-size:14px; line-height:26px; font-family:Simsun; text-indent:2em"> <span style="line-height:19px; white-space:pre; background-color:rgb(248,248,248)"><img src="https://images2.imgbox.com/7a/da/1tKRspJ3_o.png" alt="" style="border:none; max-width:100%"><br> </span></p> 
<h3 class="headline-1 bk-sidecatalog-title" style="margin:0px 0px 10px; padding:0px 0px 6px; color:rgb(51,51,51); font-family:Arial; line-height:26px; border-bottom-color:rgb(222,223,225); border-bottom-width:1px; border-bottom-style:solid; clear:both"> <a target="_blank" name="t33" style="color:rgb(51,102,153)"></a><span style="color:rgb(51,102,153)"><span style="line-height:36px; font-size:22px">5、TCP粘包的问题</span></span></h3> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; line-height:19px; text-indent:28px; font-family:宋体"><br> </span></p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; line-height:19px; text-indent:28px; font-family:宋体"><span style="color:rgb(255,0,0)">1、什么是粘包：</span></span></p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; line-height:19px; text-indent:28px; font-family:宋体">   简单的说就是通过</span><span lang="EN-US" style="margin:0px; padding:0px; font-family:微软雅黑,arial,tahoma,宋体; line-height:19px; text-indent:28px">TCP</span><span style="margin:0px; padding:0px; line-height:19px; text-indent:28px; font-family:宋体">协议发送了多条独立的数据，但接收的时候，有些数据不幸的合并成了一个。比如客户端向服务器发送两个命令：</span></p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; line-height:19px; text-indent:28px; font-family:宋体">    1)Hello</span></p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; line-height:19px; text-indent:28px; font-family:宋体">    2)world</span></p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; line-height:19px; text-indent:28px; font-family:宋体">   但是服务器接收的时候，很可能不是分两次接收，而是一次接收到 Helloworld</span></p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; line-height:19px; text-indent:28px; font-family:宋体"><br> </span></p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; line-height:19px; text-indent:28px; font-family:宋体"><span style="font-family:Arial; line-height:26px; color:rgb(255,0,0)">2、粘包出现原因</span><span style="font-family:Arial; line-height:26px">：</span></span></p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <br> </p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; text-indent:28px; font-family:宋体"><span style="font-family:Arial">    </span><span style="line-height:28px; font-family:Arial">由于TCP协议本身的机制（面向连接的可靠地协议-三次握手机制）客户端与服务器会维持一个连接（Channel），数据在连接不断开的情况下，可以持续不断地将多个数据包发往服务器，但是如果发送的网络数据包太小，那么他本身会启用Nagle算法（可配置是否启用）对较小的数据包进行合并（基于此，TCP的网络延迟要UDP的高些）然后再发送（超时或者包大小足够）。那么这样的话，服务器在接收到消息（数据流）的时候就无法区分哪些数据包是客户端自己分开发送的，这样产生了粘包；服务器在接收到数据库后，放到缓冲区中，如果消息没有被及时从缓存区取走，下次在取数据的时候可能就会出现一次取出多个数据包的情况，造成粘包现象（确切来讲，对于基于TCP协议的应用，不应用包来</span><span style="line-height:28px; font-family:Arial">描述</span><span style="line-height:28px; font-family:Arial">，而应 用 流来描述），个人认为服务器接收端产生的粘包应该与linux内核处理socket的方式 select轮询机制的线性扫描频度无关。</span><span style="line-height:19px"><span style="font-family:Arial; line-height:26px"></span></span></span></p> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
  再说UDP：本身作为无连接的不可靠的传输协议（适合频繁发送较小的数据包），他不会对数据包进行合并发送（也就没有Nagle算法之说了） 
 <span style="line-height:28px">，他直接是一端发送什么数据，直接就发出去了</span> 
 <span style="line-height:28px">，既然他不会对数据合并，每一个数据包都是完整的（数据+UDP头+IP头等等发一次数据封装一次）也就没有粘包一说了。</span> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <span style="text-indent:28px"> 也就是说：UDP不是流协议，有消息边界，不存在粘包的问题。要丢就是整个包都丢了。</span> 
 <br> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <span style="text-indent:28px">原因：</span> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <span style="text-indent:28px">1)、<span style="font-family:宋体; line-height:19px">可能是IP分片传输导致的，也可能是传输过程中丢失部分包导致出现的半包</span></span> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <span style="text-indent:28px">2)、为了提高传输速度和效率, 把发送缓冲区中的数据拼为一个数据包发送到目的地 </span> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <span style="text-indent:28px">      比如:发送方需要等缓冲区满才发送出去，造成粘包<br>        3)、接收方不及时接收缓冲区的包，造成多个包接收。</span> 
</div> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> </p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <span style="margin:0px; padding:0px; line-height:19px; font-family:宋体"></span></p> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <br> 
 <span style="color:rgb(255,0,0)">2、解决方案</span> 
 <span style="text-indent:28px">：</span> 
 <br> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
  1）、一个是采用分隔符的方式，即我们在封装要传输的数据包的时候，采用固定的符号作为结尾符（数据中不能含结尾符），这样我们接收到数据后，如果出现结尾标识，即人为的将粘包分开，如果一个包中没有出现结尾符，认为出现了分包，则等待下个包中出现后 组合成一个完整的数据包，这种方式适合于文本传输的数据，如采用/r/n之类的分隔符； 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <br> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
  2）、另一种是采用在数据包中添加长度的方式，即在数据包中的固定位置封装数据包的长度信息（或可计算数据包总长度的信息），服务器接收到数据后，先是解析包长度，然后根据包长度截取数据包（此种方式常出现于自定义协议中），但是有个小问题就是如果客户端第一个数据包数据长度封装的有错误，那么很可能就会导致后面接收到的所有数据包都解析出错（由于TCP建立连接后流式传输机制），只有客户端关闭连接后重新打开才可以消除此问题，我在处理这个问题的时候对数据长度做了校验，会适时的对接收到的有问题的包进行人为的丢弃处理（客户端有自动重发机制，故而在应用层不会导致数据的不完整性）； 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <br> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
  3）另一种不建议的方式是TCP采用短连接处理粘包（这个得根据需要来，所以不建议） 
</div> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> </p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> <a target="_blank" name="t34" style="font-size:12px; background-color:rgb(255,255,255); color:rgb(51,102,153)"></a><span style="color:rgb(51,102,153); font-size:22px; line-height:36px">6、TCP与UDP区别</span></p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> </p> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> </p> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <strong><span style="color:rgb(255,0,0)">TCP（Transmission Control Protocol）传输控制协议：</span></strong> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
       该协议主要用于在主机间建立一个虚拟连接，以实现高可靠性的数据包交换。IP协议可以进行IP数据包的分割和组装，但是通过IP协议并不能清楚地了解到数据包是否顺利地发送给目标计算机。而使用TCP协议就不同了，在该协议传输模式中在将数据包成功发送给目标计算机后，TCP会要求发送一个确认；如果在某个时限内没有收到确认，那么TCP将重新发送数据包。另外，在传输的过程中，如果接收到无序、丢失以及被破坏的数据包，TCP还可以负责恢复。 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
       传输控制协议是一种面向连接的、可靠的、基于字节流的运输层通信协议，通常由IETF的RFC793说明。在简化的计算机网络OSI模型中，它完成运输层所指定的功能。 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <strong>    <span style="color:rgb(51,51,255)"> </span></strong> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <strong><span style="color:rgb(51,51,255)">   TCP字节流：</span></strong> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <span style="color:rgb(51,51,255)"><strong><br> </strong></span> 
 <div>
        打个比方比喻TCP，你家里有个蓄水池，你可以里面倒水，蓄水池上有个龙头，你可以通过龙头将水池里的水放出来，然后用各种各样的容器装（杯子、矿泉水瓶、锅碗瓢盆）接水。 
 </div> 
 <div>
     
 </div> 
 <div>
       上面的例子中，往水池里倒几次水和接几次水是没有必然联系的，也就是说你可以只倒一次水，然后分10次接完。另外，水池里的水接多少就会少多少；往里面倒多少水，就会增加多少水，但是不能超过水池的容量，多出的水会溢出。 
 </div> 
 <div>
     
 </div> 
 <div>
        结合TCP的概念，水池就好比接收缓冲区，倒水就相当于发送数据，接水就相当于读取数据。好比你通过TCP连接给另一端发送数据，你只调用了一次write，发送了100个字节，但是对方可以分10次收完，每次10个字节；你也可以调用10次write，每次10个字节，但是对方可以一次就收完。（假设数据都能到达）但是，你发送的数据量不能大于对方的接收缓存（流量控制），如果你硬是要发送过量数据，则对方的缓存满了就会把多出的数据丢弃。 
 </div> 
 <div>
     
  <span style="color:rgb(51,51,255); font-weight:bold">UDP  (User Datagram Protocol） 用户数据报协议：</span> 
 </div> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
       用户数据报协议（UDP）是 ISO参考模型中一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。 UDP 协议基本上是 IP 协议与上层协议的接口。 UDP协议适用端口分辨运行在同一台设备上的多个应用程序。  
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
       由于大多数网络应用程序都在同一台机器上运行，计算机上必须能够确保目的地机器上的软件程序能从源地址机器处获得数据包，以及源计算机能收到正确的回复。这是通过使用UDP 的“端口号”完成的。 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
 <br>      
 <span style="color:rgb(51,51,255)"> UDP数据报：</span> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <span style="color:rgb(51,51,255)"><br> </span> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
       UDP和TCP不同，发送端调用了几次write，接收端必须用相同次数的read读完。UPD是基于报文的，在接收的时候，每次最多只能读取一个报文，报文和报文是不会合并 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
  的，如果缓冲区小于报文长度，则多出的部分会被丢弃。也就说，如果不指定MSG_PEEK标志，每次读取操作将消耗一个报文。 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <br> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
 <span style="color:rgb(255,0,0); font-weight:bold">区别：</span> 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    1、基于连接与无连接 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
  TCP---传输控制协议提供的是面向连接、可靠的字节流服务。当客户和服务器彼此交换数据前，必须先在双方之间建立一个TCP连接，之后才能传输数据。TCP提供超时重发，丢弃重复数据，检验数据，流量控制等功能，保证数据能从一端传到另一端。 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
  每个数据包的传输过程是：先建立链路、数据传输、然后清除链路。数据包不包含目的地址。受端和发端不但顺序一致，而且内容相同。它的可靠性高。 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
  UDP---用户数据报协议是面向无连接的，每个数据包都有完整的源、目的地址及分组编号，各自在网络中独立传输，传输中不管其顺序，数据到达收端后再进行排序组装，遇有丢失、差错和失序等情况，通过请求重发来解决。它的效率比较高。 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
  是一个简单的面向数据报的运输层协议。UDP不提供可靠性，它只是把应用程序传给IP层的数据报发送出去，但是并不能保证它们能到达目的地。由于UDP在传输数据报前不用在客户和服务器之间建立一个连接，且没有超时重发等机制，故而传输速度很快。   
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    2、对 
 <a target="_blank" href="http://www.2cto.com/os/" rel="nofollow noopener noreferrer" class="keylink" style="color:rgb(51,102,153); text-decoration:none">系统</a>资源的要求（TCP较多，UDP少） 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    3、UDP程序结构较简单 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    4、流模式与数据报模式 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    5、TCP保证数据正确性，UDP可能丢包，TCP保证数据顺序，UDP不保证 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    6、TCP是面可靠的字节流服务 ，UDP 并不提供对 IP协议的可靠机制、流控制以及错误恢复功能等。 
</div> 
<div style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px">
    
</div> 
<br style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> 
<p style="color:rgb(51,51,51); font-family:Arial; font-size:14px; line-height:26px"> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e333f7306045d411ecca6f35c5204acf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android开发 之 Github常见的开源库</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a23ba44e16f9952805ab4bc74b6a7d5e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android中 Bitmap和Drawable相互转换的方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>