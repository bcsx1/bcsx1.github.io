<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>工具系列：TensorFlow决策森林_(7)检查和调试决策森林模型 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="工具系列：TensorFlow决策森林_(7)检查和调试决策森林模型" />
<meta property="og:description" content="文章目录 设置训练一个简单的随机森林绘制模型检查模型结构手动创建模型结束树写作 在本文中，您将学习如何直接检查和创建模型的结构。我们假设您已经熟悉了在初级和中级介绍的概念。 在本文中，您将：
训练一个随机森林模型并以编程方式访问其结构。
手动创建一个随机森林模型，并将其用作经典模型。
设置 # 安装 TensorFlow Decision Forests 库 !pip install tensorflow_decision_forests # 安装 wurlitzer 库，用于显示训练日志 !pip install wurlitzer Collecting tensorflow_decision_forests Using cached tensorflow_decision_forests-1.1.0-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (16.2 MB) Requirement already satisfied: wheel in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (0.37.1) Requirement already satisfied: numpy in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (1.24.0rc2) Requirement already satisfied: absl-py in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (1.3.0) Requirement already satisfied: six in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (1.16.0) Collecting wurlitzer Using cached wurlitzer-3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/bacc7dfb50ad9cc7a8a36bd37a708704/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-25T00:41:05+08:00" />
<meta property="article:modified_time" content="2023-12-25T00:41:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">工具系列：TensorFlow决策森林_(7)检查和调试决策森林模型</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_9" rel="nofollow">设置</a></li><li><a href="#_115" rel="nofollow">训练一个简单的随机森林</a></li><li><a href="#_534" rel="nofollow">绘制模型</a></li><li><a href="#_981" rel="nofollow">检查模型结构</a></li><li><a href="#_1230" rel="nofollow">手动创建模型</a></li><li><a href="#_1289" rel="nofollow">结束树写作</a></li></ul> 
 </li></ul> 
</div> 
<br> 在本文中，您将学习如何直接检查和创建模型的结构。我们假设您已经熟悉了在初级和中级介绍的概念。 
<p></p> 
<p>在本文中，您将：</p> 
<ol><li> <p>训练一个随机森林模型并以编程方式访问其结构。</p> </li><li> <p>手动创建一个随机森林模型，并将其用作经典模型。</p> </li></ol> 
<h3><a id="_9"></a>设置</h3> 
<pre><code class="prism language-python"><span class="token comment"># 安装 TensorFlow Decision Forests 库</span>
!pip install tensorflow_decision_forests

<span class="token comment"># 安装 wurlitzer 库，用于显示训练日志</span>
!pip install wurlitzer
</code></pre> 
<pre><code>Collecting tensorflow_decision_forests
  Using cached tensorflow_decision_forests-1.1.0-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (16.2 MB)
Requirement already satisfied: wheel in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (0.37.1)
Requirement already satisfied: numpy in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (1.24.0rc2)
Requirement already satisfied: absl-py in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (1.3.0)
Requirement already satisfied: six in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (1.16.0)
Collecting wurlitzer
  Using cached wurlitzer-3.0.3-py3-none-any.whl (7.3 kB)
Requirement already satisfied: pandas in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (1.5.2)
Requirement already satisfied: tensorflow~=2.11.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow_decision_forests) (2.11.0)
Requirement already satisfied: setuptools in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (65.6.3)
Requirement already satisfied: gast&lt;=0.4.0,&gt;=0.2.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (0.4.0)
Requirement already satisfied: h5py&gt;=2.9.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (3.7.0)
Requirement already satisfied: libclang&gt;=13.0.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (14.0.6)
Requirement already satisfied: flatbuffers&gt;=2.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (22.12.6)
Requirement already satisfied: tensorboard&lt;2.12,&gt;=2.11 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2.11.0)
Requirement already satisfied: typing-extensions&gt;=3.6.6 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (4.4.0)
Requirement already satisfied: keras&lt;2.12,&gt;=2.11.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2.11.0)
Requirement already satisfied: wrapt&gt;=1.11.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (1.14.1)
Requirement already satisfied: astunparse&gt;=1.6.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (1.6.3)
Requirement already satisfied: tensorflow-estimator&lt;2.12,&gt;=2.11.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2.11.0)
Requirement already satisfied: protobuf&lt;3.20,&gt;=3.9.2 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (3.19.6)
Requirement already satisfied: opt-einsum&gt;=2.3.2 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (3.3.0)
Requirement already satisfied: grpcio&lt;2.0,&gt;=1.24.3 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (1.51.1)
Requirement already satisfied: packaging in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (22.0)
Requirement already satisfied: termcolor&gt;=1.1.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2.1.1)
Requirement already satisfied: tensorflow-io-gcs-filesystem&gt;=0.23.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (0.28.0)
Requirement already satisfied: google-pasta&gt;=0.1.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (0.2.0)
Requirement already satisfied: python-dateutil&gt;=2.8.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from pandas-&gt;tensorflow_decision_forests) (2.8.2)
Requirement already satisfied: pytz&gt;=2020.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from pandas-&gt;tensorflow_decision_forests) (2022.6)
Requirement already satisfied: werkzeug&gt;=1.0.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2.2.2)
Requirement already satisfied: markdown&gt;=2.6.8 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (3.4.1)
Requirement already satisfied: tensorboard-plugin-wit&gt;=1.6.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (1.8.1)
Requirement already satisfied: tensorboard-data-server&lt;0.7.0,&gt;=0.6.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (0.6.1)
Requirement already satisfied: requests&lt;3,&gt;=2.21.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2.28.1)
Requirement already satisfied: google-auth-oauthlib&lt;0.5,&gt;=0.4.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (0.4.6)
Requirement already satisfied: google-auth&lt;3,&gt;=1.6.3 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2.15.0)
Requirement already satisfied: cachetools&lt;6.0,&gt;=2.0.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (5.2.0)
Requirement already satisfied: rsa&lt;5,&gt;=3.1.4 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (4.9)
Requirement already satisfied: pyasn1-modules&gt;=0.2.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (0.3.0rc1)
Requirement already satisfied: requests-oauthlib&gt;=0.7.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from google-auth-oauthlib&lt;0.5,&gt;=0.4.1-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (1.3.1)
Requirement already satisfied: importlib-metadata&gt;=4.4 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from markdown&gt;=2.6.8-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (5.1.0)
Requirement already satisfied: charset-normalizer&lt;3,&gt;=2 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from requests&lt;3,&gt;=2.21.0-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2.1.1)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from requests&lt;3,&gt;=2.21.0-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (3.4)
Requirement already satisfied: certifi&gt;=2017.4.17 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from requests&lt;3,&gt;=2.21.0-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2022.12.7)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from requests&lt;3,&gt;=2.21.0-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (1.26.13)
Requirement already satisfied: MarkupSafe&gt;=2.1.1 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from werkzeug&gt;=1.0.1-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (2.1.1)
Requirement already satisfied: zipp&gt;=0.5 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from importlib-metadata&gt;=4.4-&gt;markdown&gt;=2.6.8-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (3.11.0)
Requirement already satisfied: pyasn1&lt;0.6.0,&gt;=0.4.6 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from pyasn1-modules&gt;=0.2.1-&gt;google-auth&lt;3,&gt;=1.6.3-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (0.5.0rc2)
Requirement already satisfied: oauthlib&gt;=3.0.0 in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (from requests-oauthlib&gt;=0.7.0-&gt;google-auth-oauthlib&lt;0.5,&gt;=0.4.1-&gt;tensorboard&lt;2.12,&gt;=2.11-&gt;tensorflow~=2.11.0-&gt;tensorflow_decision_forests) (3.2.2)
Installing collected packages: wurlitzer, tensorflow_decision_forests
Successfully installed tensorflow_decision_forests-1.1.0 wurlitzer-3.0.3
Requirement already satisfied: wurlitzer in /tmpfs/src/tf_docs_env/lib/python3.9/site-packages (3.0.3)
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 导入tensorflow_decision_forests库</span>
<span class="token keyword">import</span> tensorflow_decision_forests <span class="token keyword">as</span> tfdf

<span class="token comment"># 导入os、numpy、pandas、tensorflow、matplotlib.pyplot、math、collections库</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> math
<span class="token keyword">import</span> collections

</code></pre> 
<pre><code>2022-12-14 12:24:51.050867: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library 'libnvinfer.so.7'; dlerror: libnvinfer.so.7: cannot open shared object file: No such file or directory
2022-12-14 12:24:51.050964: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library 'libnvinfer_plugin.so.7'; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory
2022-12-14 12:24:51.050973: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.
</code></pre> 
<p>隐藏的代码单元格限制了在colab中的输出高度。</p> 
<pre><code class="prism language-python">
<span class="token comment"># 导入所需的模块</span>
<span class="token keyword">from</span> IPython<span class="token punctuation">.</span>core<span class="token punctuation">.</span>magic <span class="token keyword">import</span> register_line_magic
<span class="token keyword">from</span> IPython<span class="token punctuation">.</span>display <span class="token keyword">import</span> Javascript
<span class="token keyword">from</span> IPython<span class="token punctuation">.</span>display <span class="token keyword">import</span> display <span class="token keyword">as</span> ipy_display

<span class="token comment"># 定义一个魔术命令，用于设置单元格的最大高度</span>
<span class="token decorator annotation punctuation">@register_line_magic</span>
<span class="token keyword">def</span> <span class="token function">set_cell_height</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># 调用Javascript代码，设置单元格的最大高度</span>
  ipy_display<span class="token punctuation">(</span>
      Javascript<span class="token punctuation">(</span><span class="token string">"google.colab.output.setIframeHeight(0, true, {maxHeight: "</span> <span class="token operator">+</span>
                 <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"})"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_115"></a>训练一个简单的随机森林</h3> 
<p>我们像在<a href="beginner_colab.ipynb" rel="nofollow">初学者colab</a>中一样训练一个随机森林。</p> 
<pre><code class="prism language-python"><span class="token comment"># 下载数据集</span>
!wget <span class="token operator">-</span>q https<span class="token punctuation">:</span><span class="token operator">//</span>storage<span class="token punctuation">.</span>googleapis<span class="token punctuation">.</span>com<span class="token operator">/</span>download<span class="token punctuation">.</span>tensorflow<span class="token punctuation">.</span>org<span class="token operator">/</span>data<span class="token operator">/</span>palmer_penguins<span class="token operator">/</span>penguins<span class="token punctuation">.</span>csv <span class="token operator">-</span>O <span class="token operator">/</span>tmp<span class="token operator">/</span>penguins<span class="token punctuation">.</span>csv

<span class="token comment"># 将数据集加载到Pandas Dataframe中</span>
dataset_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">"/tmp/penguins.csv"</span><span class="token punctuation">)</span>

<span class="token comment"># 显示前三个示例</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>dataset_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 将Pandas Dataframe转换为tf数据集</span>
dataset_tf <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>pd_dataframe_to_tf_dataset<span class="token punctuation">(</span>dataset_df<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"species"</span><span class="token punctuation">)</span>

<span class="token comment"># 训练随机森林模型</span>
model <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>RandomForestModel<span class="token punctuation">(</span>compute_oob_variable_importances<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>x<span class="token operator">=</span>dataset_tf<span class="token punctuation">)</span>
</code></pre> 
<pre><code>  species     island  bill_length_mm  bill_depth_mm  flipper_length_mm  \
0  Adelie  Torgersen            39.1           18.7              181.0   
1  Adelie  Torgersen            39.5           17.4              186.0   
2  Adelie  Torgersen            40.3           18.0              195.0   

   body_mass_g     sex  year  
0       3750.0    male  2007  
1       3800.0  female  2007  
2       3250.0  female  2007  
Warning: The `num_threads` constructor argument is not set and the number of CPU is os.cpu_count()=32 &gt; 32. Setting num_threads to 32. Set num_threads manually to use more than 32 cpus.


WARNING:absl:The `num_threads` constructor argument is not set and the number of CPU is os.cpu_count()=32 &gt; 32. Setting num_threads to 32. Set num_threads manually to use more than 32 cpus.


Use /tmpfs/tmp/tmpvr7urazn as temporary training directory
Reading training dataset...
WARNING:tensorflow:From /tmpfs/src/tf_docs_env/lib/python3.9/site-packages/tensorflow/python/autograph/pyct/static_analysis/liveness.py:83: Analyzer.lamba_check (from tensorflow.python.autograph.pyct.static_analysis.liveness) is deprecated and will be removed after 2023-09-23.
Instructions for updating:
Lambda fuctions will be no more assumed to be used in the statement where they are used, or at least in the same block. https://github.com/tensorflow/tensorflow/issues/56089


WARNING:tensorflow:From /tmpfs/src/tf_docs_env/lib/python3.9/site-packages/tensorflow/python/autograph/pyct/static_analysis/liveness.py:83: Analyzer.lamba_check (from tensorflow.python.autograph.pyct.static_analysis.liveness) is deprecated and will be removed after 2023-09-23.
Instructions for updating:
Lambda fuctions will be no more assumed to be used in the statement where they are used, or at least in the same block. https://github.com/tensorflow/tensorflow/issues/56089


Training dataset read in 0:00:02.961832. Found 344 examples.
Training model...
Model trained in 0:00:00.093680
Compiling model...


[INFO 2022-12-14T12:24:58.955519768+00:00 kernel.cc:1175] Loading model from path /tmpfs/tmp/tmpvr7urazn/model/ with prefix fb8057db01324481
[INFO 2022-12-14T12:24:58.971817533+00:00 abstract_model.cc:1306] Engine "RandomForestGeneric" built
[INFO 2022-12-14T12:24:58.97187255+00:00 kernel.cc:1021] Use fast generic engine


WARNING:tensorflow:AutoGraph could not transform &lt;function simple_ml_inference_op_with_handle at 0x7f9b54f644c0&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: could not get source code
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert


WARNING:tensorflow:AutoGraph could not transform &lt;function simple_ml_inference_op_with_handle at 0x7f9b54f644c0&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: could not get source code
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert


WARNING: AutoGraph could not transform &lt;function simple_ml_inference_op_with_handle at 0x7f9b54f644c0&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: could not get source code
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
Model compiled.





&lt;keras.callbacks.History at 0x7f9b5394c6d0&gt;
</code></pre> 
<p>请注意模型构造函数中的<code>compute_oob_variable_importances=True</code>超参数。此选项在训练过程中计算袋外（OOB）变量重要性。这是随机森林模型的一种流行的<a href="https://christophm.github.io/interpretable-ml-book/feature-importance.html" rel="nofollow">排列变量重要性</a>。</p> 
<p>计算OOB变量重要性不会影响最终模型，但会减慢大型数据集的训练速度。</p> 
<p>请检查模型摘要：</p> 
<pre><code class="prism language-python"><span class="token comment"># 打印模型的概述信息</span>
model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>&lt;IPython.core.display.Javascript object&gt;


Model: "random_forest_model"
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
=================================================================
Total params: 1
Trainable params: 0
Non-trainable params: 1
_________________________________________________________________
Type: "RANDOM_FOREST"
Task: CLASSIFICATION
Label: "__LABEL"

Input Features (7):
	bill_depth_mm
	bill_length_mm
	body_mass_g
	flipper_length_mm
	island
	sex
	year

No weights

Variable Importance: MEAN_DECREASE_IN_ACCURACY:
    1.    "bill_length_mm"  0.151163 ################
    2.            "island"  0.008721 #
    3.     "bill_depth_mm"  0.000000 
    4.       "body_mass_g"  0.000000 
    5.               "sex"  0.000000 
    6.              "year"  0.000000 
    7. "flipper_length_mm" -0.002907 

Variable Importance: MEAN_DECREASE_IN_AP_1_VS_OTHERS:
    1.    "bill_length_mm"  0.083305 ################
    2.            "island"  0.007664 #
    3. "flipper_length_mm"  0.003400 
    4.     "bill_depth_mm"  0.002741 
    5.       "body_mass_g"  0.000722 
    6.               "sex"  0.000644 
    7.              "year"  0.000000 

Variable Importance: MEAN_DECREASE_IN_AP_2_VS_OTHERS:
    1.    "bill_length_mm"  0.508510 ################
    2.            "island"  0.023487 
    3.     "bill_depth_mm"  0.007744 
    4. "flipper_length_mm"  0.006008 
    5.       "body_mass_g"  0.003017 
    6.               "sex"  0.001537 
    7.              "year" -0.000245 

Variable Importance: MEAN_DECREASE_IN_AP_3_VS_OTHERS:
    1.            "island"  0.002192 ################
    2.    "bill_length_mm"  0.001572 ############
    3.     "bill_depth_mm"  0.000497 #######
    4.               "sex"  0.000000 ####
    5.              "year"  0.000000 ####
    6.       "body_mass_g" -0.000053 ####
    7. "flipper_length_mm" -0.000890 

Variable Importance: MEAN_DECREASE_IN_AUC_1_VS_OTHERS:
    1.    "bill_length_mm"  0.071306 ################
    2.            "island"  0.007299 #
    3. "flipper_length_mm"  0.004506 #
    4.     "bill_depth_mm"  0.002124 
    5.       "body_mass_g"  0.000548 
    6.               "sex"  0.000480 
    7.              "year"  0.000000 

Variable Importance: MEAN_DECREASE_IN_AUC_2_VS_OTHERS:
    1.    "bill_length_mm"  0.108642 ################
    2.            "island"  0.014493 ##
    3.     "bill_depth_mm"  0.007406 #
    4. "flipper_length_mm"  0.005195 
    5.       "body_mass_g"  0.001012 
    6.               "sex"  0.000480 
    7.              "year" -0.000053 

Variable Importance: MEAN_DECREASE_IN_AUC_3_VS_OTHERS:
    1.            "island"  0.002126 ################
    2.    "bill_length_mm"  0.001393 ###########
    3.     "bill_depth_mm"  0.000293 #####
    4.               "sex"  0.000000 ###
    5.              "year"  0.000000 ###
    6.       "body_mass_g" -0.000037 ###
    7. "flipper_length_mm" -0.000550 

Variable Importance: MEAN_DECREASE_IN_PRAUC_1_VS_OTHERS:
    1.    "bill_length_mm"  0.083122 ################
    2.            "island"  0.010887 ##
    3. "flipper_length_mm"  0.003425 
    4.     "bill_depth_mm"  0.002731 
    5.       "body_mass_g"  0.000719 
    6.               "sex"  0.000641 
    7.              "year"  0.000000 

Variable Importance: MEAN_DECREASE_IN_PRAUC_2_VS_OTHERS:
    1.    "bill_length_mm"  0.497611 ################
    2.            "island"  0.024045 
    3.     "bill_depth_mm"  0.007734 
    4. "flipper_length_mm"  0.006017 
    5.       "body_mass_g"  0.003000 
    6.               "sex"  0.001528 
    7.              "year" -0.000243 

Variable Importance: MEAN_DECREASE_IN_PRAUC_3_VS_OTHERS:
    1.            "island"  0.002187 ################
    2.    "bill_length_mm"  0.001568 ############
    3.     "bill_depth_mm"  0.000495 #######
    4.               "sex"  0.000000 ####
    5.              "year"  0.000000 ####
    6.       "body_mass_g" -0.000053 ####
    7. "flipper_length_mm" -0.000886 

Variable Importance: MEAN_MIN_DEPTH:
    1.           "__LABEL"  3.479602 ################
    2.              "year"  3.463891 ###############
    3.               "sex"  3.430498 ###############
    4.       "body_mass_g"  2.898112 ###########
    5.            "island"  2.388925 ########
    6.     "bill_depth_mm"  2.336100 #######
    7.    "bill_length_mm"  1.282960 
    8. "flipper_length_mm"  1.270079 

Variable Importance: NUM_AS_ROOT:
    1. "flipper_length_mm" 157.000000 ################
    2.    "bill_length_mm" 76.000000 #######
    3.     "bill_depth_mm" 52.000000 #####
    4.            "island" 12.000000 
    5.       "body_mass_g"  3.000000 

Variable Importance: NUM_NODES:
    1.    "bill_length_mm" 778.000000 ################
    2.     "bill_depth_mm" 463.000000 #########
    3. "flipper_length_mm" 414.000000 ########
    4.            "island" 342.000000 ######
    5.       "body_mass_g" 338.000000 ######
    6.               "sex" 36.000000 
    7.              "year" 19.000000 

Variable Importance: SUM_SCORE:
    1.    "bill_length_mm" 36515.793787 ################
    2. "flipper_length_mm" 35120.434174 ###############
    3.            "island" 14669.408395 ######
    4.     "bill_depth_mm" 14515.446617 ######
    5.       "body_mass_g" 3485.330881 #
    6.               "sex" 354.201073 
    7.              "year" 49.737758 



Winner takes all: true
Out-of-bag evaluation: accuracy:0.976744 logloss:0.0678223
Number of trees: 300
Total number of nodes: 5080

Number of nodes by tree:
Count: 300 Average: 16.9333 StdDev: 3.10197
Min: 11 Max: 31 Ignored: 0
----------------------------------------------
[ 11, 12)  6   2.00%   2.00% #
[ 12, 13)  0   0.00%   2.00%
[ 13, 14) 46  15.33%  17.33% #####
[ 14, 15)  0   0.00%  17.33%
[ 15, 16) 70  23.33%  40.67% ########
[ 16, 17)  0   0.00%  40.67%
[ 17, 18) 84  28.00%  68.67% ##########
[ 18, 19)  0   0.00%  68.67%
[ 19, 20) 46  15.33%  84.00% #####
[ 20, 21)  0   0.00%  84.00%
[ 21, 22) 30  10.00%  94.00% ####
[ 22, 23)  0   0.00%  94.00%
[ 23, 24) 13   4.33%  98.33% ##
[ 24, 25)  0   0.00%  98.33%
[ 25, 26)  2   0.67%  99.00%
[ 26, 27)  0   0.00%  99.00%
[ 27, 28)  2   0.67%  99.67%
[ 28, 29)  0   0.00%  99.67%
[ 29, 30)  0   0.00%  99.67%
[ 30, 31]  1   0.33% 100.00%

Depth by leafs:
Count: 2690 Average: 3.53271 StdDev: 1.06789
Min: 2 Max: 7 Ignored: 0
----------------------------------------------
[ 2, 3) 545  20.26%  20.26% ######
[ 3, 4) 747  27.77%  48.03% ########
[ 4, 5) 888  33.01%  81.04% ##########
[ 5, 6) 444  16.51%  97.55% #####
[ 6, 7)  62   2.30%  99.85% #
[ 7, 7]   4   0.15% 100.00%

Number of training obs by leaf:
Count: 2690 Average: 38.3643 StdDev: 44.8651
Min: 5 Max: 155 Ignored: 0
----------------------------------------------
[   5,  12) 1474  54.80%  54.80% ##########
[  12,  20)  124   4.61%  59.41% #
[  20,  27)   48   1.78%  61.19%
[  27,  35)   74   2.75%  63.94% #
[  35,  42)   58   2.16%  66.10%
[  42,  50)   85   3.16%  69.26% #
[  50,  57)   96   3.57%  72.83% #
[  57,  65)   87   3.23%  76.06% #
[  65,  72)   49   1.82%  77.88%
[  72,  80)   23   0.86%  78.74%
[  80,  88)   30   1.12%  79.85%
[  88,  95)   23   0.86%  80.71%
[  95, 103)   42   1.56%  82.27%
[ 103, 110)   62   2.30%  84.57%
[ 110, 118)  115   4.28%  88.85% #
[ 118, 125)  115   4.28%  93.12% #
[ 125, 133)   98   3.64%  96.77% #
[ 133, 140)   49   1.82%  98.59%
[ 140, 148)   31   1.15%  99.74%
[ 148, 155]    7   0.26% 100.00%

Attribute in nodes:
	778 : bill_length_mm [NUMERICAL]
	463 : bill_depth_mm [NUMERICAL]
	414 : flipper_length_mm [NUMERICAL]
	342 : island [CATEGORICAL]
	338 : body_mass_g [NUMERICAL]
	36 : sex [CATEGORICAL]
	19 : year [NUMERICAL]

Attribute in nodes with depth &lt;= 0:
	157 : flipper_length_mm [NUMERICAL]
	76 : bill_length_mm [NUMERICAL]
	52 : bill_depth_mm [NUMERICAL]
	12 : island [CATEGORICAL]
	3 : body_mass_g [NUMERICAL]

Attribute in nodes with depth &lt;= 1:
	250 : bill_length_mm [NUMERICAL]
	244 : flipper_length_mm [NUMERICAL]
	183 : bill_depth_mm [NUMERICAL]
	170 : island [CATEGORICAL]
	53 : body_mass_g [NUMERICAL]

Attribute in nodes with depth &lt;= 2:
	462 : bill_length_mm [NUMERICAL]
	320 : flipper_length_mm [NUMERICAL]
	310 : bill_depth_mm [NUMERICAL]
	287 : island [CATEGORICAL]
	162 : body_mass_g [NUMERICAL]
	9 : sex [CATEGORICAL]
	5 : year [NUMERICAL]

Attribute in nodes with depth &lt;= 3:
	669 : bill_length_mm [NUMERICAL]
	410 : bill_depth_mm [NUMERICAL]
	383 : flipper_length_mm [NUMERICAL]
	328 : island [CATEGORICAL]
	286 : body_mass_g [NUMERICAL]
	32 : sex [CATEGORICAL]
	10 : year [NUMERICAL]

Attribute in nodes with depth &lt;= 5:
	778 : bill_length_mm [NUMERICAL]
	462 : bill_depth_mm [NUMERICAL]
	413 : flipper_length_mm [NUMERICAL]
	342 : island [CATEGORICAL]
	338 : body_mass_g [NUMERICAL]
	36 : sex [CATEGORICAL]
	19 : year [NUMERICAL]

Condition type in nodes:
	2012 : HigherCondition
	378 : ContainsBitmapCondition
Condition type in nodes with depth &lt;= 0:
	288 : HigherCondition
	12 : ContainsBitmapCondition
Condition type in nodes with depth &lt;= 1:
	730 : HigherCondition
	170 : ContainsBitmapCondition
Condition type in nodes with depth &lt;= 2:
	1259 : HigherCondition
	296 : ContainsBitmapCondition
Condition type in nodes with depth &lt;= 3:
	1758 : HigherCondition
	360 : ContainsBitmapCondition
Condition type in nodes with depth &lt;= 5:
	2010 : HigherCondition
	378 : ContainsBitmapCondition
Node format: NOT_SET

Training OOB:
	trees: 1, Out-of-bag evaluation: accuracy:0.964286 logloss:1.28727
	trees: 13, Out-of-bag evaluation: accuracy:0.959064 logloss:0.4869
	trees: 31, Out-of-bag evaluation: accuracy:0.95614 logloss:0.284603
	trees: 54, Out-of-bag evaluation: accuracy:0.973837 logloss:0.175283
	trees: 73, Out-of-bag evaluation: accuracy:0.97093 logloss:0.175816
	trees: 85, Out-of-bag evaluation: accuracy:0.973837 logloss:0.171781
	trees: 96, Out-of-bag evaluation: accuracy:0.97093 logloss:0.077417
	trees: 116, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0761788
	trees: 127, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0745239
	trees: 137, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0753508
	trees: 150, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0741464
	trees: 160, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0749481
	trees: 170, Out-of-bag evaluation: accuracy:0.979651 logloss:0.0719624
	trees: 190, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0711787
	trees: 203, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0701121
	trees: 213, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0682979
	trees: 224, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0689686
	trees: 248, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0674086
	trees: 260, Out-of-bag evaluation: accuracy:0.976744 logloss:0.068218
	trees: 270, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0680733
	trees: 280, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0685965
	trees: 290, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0683421
	trees: 300, Out-of-bag evaluation: accuracy:0.976744 logloss:0.0678223
</code></pre> 
<p>注意，变量重要性有多个名称为<code>MEAN_DECREASE_IN_*</code>。</p> 
<h3><a id="_534"></a>绘制模型</h3> 
<p>接下来，绘制模型。</p> 
<p>随机森林是一个庞大的模型（该模型有300棵树和约5k个节点；请参见上面的摘要）。因此，只绘制第一棵树，并将节点限制在深度3。</p> 
<pre><code class="prism language-python"><span class="token comment"># 使用model_plotter模块中的plot_model_in_colab函数来绘制模型</span>
<span class="token comment"># 参数model表示要绘制的模型</span>
<span class="token comment"># 参数tree_idx表示要绘制的树的索引，这里设置为0表示绘制第一棵树</span>
<span class="token comment"># 参数max_depth表示要绘制的树的最大深度，这里设置为3表示绘制到第三层</span>
tfdf<span class="token punctuation">.</span>model_plotter<span class="token punctuation">.</span>plot_model_in_colab<span class="token punctuation">(</span>model<span class="token punctuation">,</span> tree_idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> max_depth<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<div id="tree_plot_05707b35c4f748738efd3da21ab9197f"></div> 
<p>/**</p> 
<ul><li>Plotting of decision trees generated by TF-DF.</li><li><li>A tree is a recursive structure of node objects.</li><li>A node contains one or more of the following components:</li><li><li> 
  <ul><li>A value: Representing the output of the node. If the node is not a leaf,</li></ul> </li><li> <pre><code> the value is only present for analysis i.e. it is not used for
</code></pre> </li><li> <pre><code> predictions.
</code></pre> </li><li><li> 
  <ul><li>A condition : For non-leaf nodes, the condition (also known as split)</li></ul> </li><li> <pre><code> defines a binary test to branch to the positive or negative child.
</code></pre> </li><li><li> 
  <ul><li>An explanation: Generally a plot showing the relation between the label</li></ul> </li><li> <pre><code> and the condition to give insights about the effect of the condition.
</code></pre> </li><li><li> 
  <ul><li>Two children : For non-leaf nodes, the children nodes. The first</li></ul> </li><li> <pre><code> children (i.e. "node.children[0]") is the negative children (drawn in
</code></pre> </li><li> <pre><code> red). The second children is the positive one (drawn in green).
</code></pre> </li><li></ul> 
<p>*/</p> 
<p>/**</p> 
<ul><li>Plots a single decision tree into a DOM element.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!tree} raw_tree Recursive tree structure.</li><li>@param {string} canvas_id Id of the output dom element.<br> */<br> function display_tree(options, raw_tree, canvas_id) {<!-- --><br> console.log(options);</li></ul> 
<p>// Determine the node placement.<br> const tree_struct = d3.tree().nodeSize(<br> [options.node_y_offset, options.node_x_offset])(d3.hierarchy(raw_tree));</p> 
<p>// Boundaries of the node placement.<br> let x_min = Infinity;<br> let x_max = -x_min;<br> let y_min = Infinity;<br> let y_max = -x_min;</p> 
<p>tree_struct.each(d =&gt; {<!-- --><br> if (d.x &gt; x_max) x_max = d.x;<br> if (d.x &lt; x_min) x_min = d.x;<br> if (d.y &gt; y_max) y_max = d.y;<br> if (d.y &lt; y_min) y_min = d.y;<br> });</p> 
<p>// Size of the plot.<br> const width = y_max - y_min + options.node_x_size + options.margin * 2;<br> const height = x_max - x_min + options.node_y_size + options.margin * 2 +<br> options.node_y_offset - options.node_y_size;</p> 
<p>const plot = d3.select(canvas_id);</p> 
<p>// Tool tip<br> options.tooltip = plot.append(‘div’)<br> .attr(‘width’, 100)<br> .attr(‘height’, 100)<br> .style(‘padding’, ‘4px’)<br> .style(‘background’, ‘#fff’)<br> .style(‘box-shadow’, ‘4px 4px 0px rgba(0,0,0,0.1)’)<br> .style(‘border’, ‘1px solid black’)<br> .style(‘font-family’, ‘sans-serif’)<br> .style(‘font-size’, options.font_size)<br> .style(‘position’, ‘absolute’)<br> .style(‘z-index’, ‘10’)<br> .attr(‘pointer-events’, ‘none’)<br> .style(‘display’, ‘none’);</p> 
<p>// Create canvas<br> const svg = plot.append(‘svg’).attr(‘width’, width).attr(‘height’, height);<br> const graph =<br> svg.style(‘overflow’, ‘visible’)<br> .append(‘g’)<br> .attr(‘font-family’, ‘sans-serif’)<br> .attr(‘font-size’, options.font_size)<br> .attr(<br> ‘transform’,<br> () =&gt; <code>translate(${options.margin},${ - x_min + options.node_y_offset / 2 + options.margin})</code>);</p> 
<p>// Plot bounding box.<br> if (options.show_plot_bounding_box) {<!-- --><br> svg.append(‘rect’)<br> .attr(‘width’, width)<br> .attr(‘height’, height)<br> .attr(‘fill’, ‘none’)<br> .attr(‘stroke-width’, 1.0)<br> .attr(‘stroke’, ‘black’);<br> }</p> 
<p>// Draw the edges.<br> display_edges(options, graph, tree_struct);</p> 
<p>// Draw the nodes.<br> display_nodes(options, graph, tree_struct);<br> }</p> 
<p>/**</p> 
<ul><li>Draw the nodes of the tree.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!graph} graph D3 search handle containing the graph.</li><li>@param {!tree_struct} tree_struct Structure of the tree (node placement,</li><li> <pre><code>data, etc.).
</code></pre> </li></ul> 
<p>*/<br> function display_nodes(options, graph, tree_struct) {<!-- --><br> const nodes = graph.append(‘g’)<br> .selectAll(‘g’)<br> .data(tree_struct.descendants())<br> .join(‘g’)<br> .attr(‘transform’, d =&gt; <code>translate(${d.y},${d.x})</code>);</p> 
<p>nodes.append(‘rect’)<br> .attr(‘x’, 0.5)<br> .attr(‘y’, 0.5)<br> .attr(‘width’, options.node_x_size)<br> .attr(‘height’, options.node_y_size)<br> .attr(‘stroke’, ‘lightgrey’)<br> .attr(‘stroke-width’, 1)<br> .attr(‘fill’, ‘white’)<br> .attr(‘y’, -options.node_y_size / 2);</p> 
<p>// Brackets on the right of condition nodes without children.<br> non_leaf_node_without_children =<br> nodes.filter(node =&gt; node.data.condition != null &amp;&amp; node.children == null)<br> .append(‘g’)<br> .attr(‘transform’, <code>translate(${options.node_x_size},0)</code>);</p> 
<p>non_leaf_node_without_children.append(‘path’)<br> .attr(‘d’, ‘M0,0 C 10,0 0,10 10,10’)<br> .attr(‘fill’, ‘none’)<br> .attr(‘stroke-width’, 1.0)<br> .attr(‘stroke’, ‘#F00’);</p> 
<p>non_leaf_node_without_children.append(‘path’)<br> .attr(‘d’, ‘M0,0 C 10,0 0,-10 10,-10’)<br> .attr(‘fill’, ‘none’)<br> .attr(‘stroke-width’, 1.0)<br> .attr(‘stroke’, ‘#0F0’);</p> 
<p>const node_content = nodes.append(‘g’).attr(<br> ‘transform’,<br> <code>translate(0,${options.node_padding - options.node_y_size / 2})</code>);</p> 
<p>node_content.append(node =&gt; create_node_element(options, node));<br> }</p> 
<p>/**</p> 
<ul><li>Creates the D3 content for a single node.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!node} node Node to draw.</li><li>@return {!d3} D3 content.<br> */<br> function create_node_element(options, node) {<!-- --><br> // Output accumulator.<br> let output = {<!-- --><br> // Content to draw.<br> content: d3.create(‘svg:g’),<br> // Vertical offset to the next element to draw.<br> vertical_offset: 0<br> };</li></ul> 
<p>// Conditions.<br> if (node.data.condition != null) {<!-- --><br> display_condition(options, node.data.condition, output);<br> }</p> 
<p>// Values.<br> if (node.data.value != null) {<!-- --><br> display_value(options, node.data.value, output);<br> }</p> 
<p>// Explanations.<br> if (node.data.explanation != null) {<!-- --><br> display_explanation(options, node.data.explanation, output);<br> }</p> 
<p>return output.content.node();<br> }</p> 
<p>/**</p> 
<ul><li>Adds a single line of text inside of a node.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {string} text Text to display.</li><li>@param {!output} output Output display accumulator.<br> */<br> function display_node_text(options, text, output) {<!-- --><br> output.content.append(‘text’)<br> .attr(‘x’, options.node_padding)<br> .attr(‘y’, output.vertical_offset)<br> .attr(‘alignment-baseline’, ‘hanging’)<br> .text(text);<br> output.vertical_offset += 10;<br> }</li></ul> 
<p>/**</p> 
<ul><li>Adds a single line of text inside of a node with a tooltip.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {string} text Text to display.</li><li>@param {string} tooltip Text in the Tooltip.</li><li>@param {!output} output Output display accumulator.<br> */<br> function display_node_text_with_tooltip(options, text, tooltip, output) {<!-- --><br> const item = output.content.append(‘text’)<br> .attr(‘x’, options.node_padding)<br> .attr(‘alignment-baseline’, ‘hanging’)<br> .text(text);</li></ul> 
<p>add_tooltip(options, item, () =&gt; tooltip);<br> output.vertical_offset += 10;<br> }</p> 
<p>/**</p> 
<ul><li>Adds a tooltip to a dom element.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!dom} target Dom element to equip with a tooltip.</li><li>@param {!func} get_content Generates the html content of the tooltip.<br> */<br> function add_tooltip(options, target, get_content) {<!-- --><br> function show(d) {<!-- --><br> options.tooltip.style(‘display’, ‘block’);<br> options.tooltip.html(get_content());<br> }</li></ul> 
<p>function hide(d) {<!-- --><br> options.tooltip.style(‘display’, ‘none’);<br> }</p> 
<p>function move(d) {<!-- --><br> options.tooltip.style(‘display’, ‘block’);<br> options.tooltip.style(‘left’, (d.pageX + 5) + ‘px’);<br> options.tooltip.style(‘top’, d.pageY + ‘px’);<br> }</p> 
<p>target.on(‘mouseover’, show);<br> target.on(‘mouseout’, hide);<br> target.on(‘mousemove’, move);<br> }</p> 
<p>/**</p> 
<ul><li>Adds a condition inside of a node.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!condition} condition Condition to display.</li><li>@param {!output} output Output display accumulator.<br> */<br> function display_condition(options, condition, output) {<!-- --><br> threshold_format = d3.format(‘r’);</li></ul> 
<p>if (condition.type === ‘IS_MISSING’) {<!-- --><br> display_node_text(options, <code>${condition.attribute} is missing</code>, output);<br> return;<br> }</p> 
<p>if (condition.type === ‘IS_TRUE’) {<!-- --><br> display_node_text(options, <code>${condition.attribute} is true</code>, output);<br> return;<br> }</p> 
<p>if (condition.type === ‘NUMERICAL_IS_HIGHER_THAN’) {<!-- --><br> format = d3.format(‘r’);<br> display_node_text(<br> options,<br> <code>${condition.attribute} &gt;= ${threshold_format(condition.threshold)}</code>,<br> output);<br> return;<br> }</p> 
<p>if (condition.type === ‘CATEGORICAL_IS_IN’) {<!-- --><br> display_node_text_with_tooltip(<br> options, <code>${condition.attribute} in [...]</code>,<br> <code>${condition.attribute} in [${condition.mask}]</code>, output);<br> return;<br> }</p> 
<p>if (condition.type === ‘CATEGORICAL_SET_CONTAINS’) {<!-- --><br> display_node_text_with_tooltip(<br> options, <code>${condition.attribute} intersect [...]</code>,<br> <code>${condition.attribute} intersect [${condition.mask}]</code>, output);<br> return;<br> }</p> 
<p>if (condition.type === ‘NUMERICAL_SPARSE_OBLIQUE’) {<!-- --><br> display_node_text_with_tooltip(<br> options, <code>Sparse oblique split...</code>,<br> <code>[${condition.attributes}]*[${condition.weights}]&gt;=${ threshold_format(condition.threshold)}</code>,<br> output);<br> return;<br> }</p> 
<p>display_node_text(<br> options, <code>Non supported condition ${condition.type}</code>, output);<br> }</p> 
<p>/**</p> 
<ul><li> <p>Adds a value inside of a node.</p> </li><li> <p>@param {!options} options Dictionary of configurations.</p> </li><li> <p>@param {!value} value Value to display.</p> </li><li> <p>@param {!output} output Output display accumulator.<br> */<br> function display_value(options, value, output) {<!-- --><br> if (value.type === ‘PROBABILITY’) {<!-- --><br> const left_margin = 0;<br> const right_margin = 50;<br> const plot_width = options.node_x_size - options.node_padding * 2 -<br> left_margin - right_margin;</p> <p>let cusum = Array.from(d3.cumsum(value.distribution));<br> cusum.unshift(0);<br> const distribution_plot = output.content.append(‘g’).attr(<br> ‘transform’, <code>translate(0,${output.vertical_offset + 0.5})</code>);</p> <p>distribution_plot.selectAll(‘rect’)<br> .data(value.distribution)<br> .join(‘rect’)<br> .attr(‘height’, 10)<br> .attr(<br> ‘x’,<br> (d, i) =&gt;<br> (cusum[i] * plot_width + left_margin + options.node_padding))<br> .attr(‘width’, (d, i) =&gt; d * plot_width)<br> .style(‘fill’, (d, i) =&gt; d3.schemeSet1[i]);</p> <p>const num_examples =<br> output.content.append(‘g’)<br> .attr(‘transform’, <code>translate(0,${output.vertical_offset})</code>)<br> .append(‘text’)<br> .attr(‘x’, options.node_x_size - options.node_padding)<br> .attr(‘alignment-baseline’, ‘hanging’)<br> .attr(‘text-anchor’, ‘end’)<br> .text(<code>(${value.num_examples})</code>);</p> <p>const distribution_details = d3.create(‘ul’);<br> distribution_details.selectAll(‘li’)<br> .data(value.distribution)<br> .join(‘li’)<br> .append(‘span’)<br> .text(<br> (d, i) =&gt;<br> ‘class ’ + i + ‘: ’ + d3.format(’.3%’)(value.distribution[i]));</p> <p>add_tooltip(options, distribution_plot, () =&gt; distribution_details.html());<br> add_tooltip(options, num_examples, () =&gt; ‘Number of examples’);</p> <p>output.vertical_offset += 10;<br> return;<br> }</p> </li></ul> 
<p>if (value.type === ‘REGRESSION’) {<!-- --><br> display_node_text(<br> options,<br> ‘value: ’ + d3.format(‘r’)(value.value) + <code> (</code> +<br> d3.format(’.6’)(value.num_examples) + <code>)</code>,<br> output);<br> return;<br> }</p> 
<p>display_node_text(options, <code>Non supported value ${value.type}</code>, output);<br> }</p> 
<p>/**</p> 
<ul><li>Adds an explanation inside of a node.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!explanation} explanation Explanation to display.</li><li>@param {!output} output Output display accumulator.<br> */<br> function display_explanation(options, explanation, output) {<!-- --><br> // Margin before the explanation.<br> output.vertical_offset += 10;</li></ul> 
<p>display_node_text(<br> options, <code>Non supported explanation ${explanation.type}</code>, output);<br> }</p> 
<p>/**</p> 
<ul><li>Draw the edges of the tree.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!graph} graph D3 search handle containing the graph.</li><li>@param {!tree_struct} tree_struct Structure of the tree (node placement,</li><li> <pre><code>data, etc.).
</code></pre> </li></ul> 
<p>*/<br> function display_edges(options, graph, tree_struct) {<!-- --><br> // Draw an edge between a parent and a child node with a bezier.<br> function draw_single_edge(d) {<!-- --><br> return ‘M’ + (d.source.y + options.node_x_size) + ‘,’ + d.source.x + ’ C’ +<br> (d.source.y + options.node_x_size + options.edge_rounding) + ‘,’ +<br> d.source.x + ’ ’ + (d.target.y - options.edge_rounding) + ‘,’ +<br> d.target.x + ’ ’ + d.target.y + ‘,’ + d.target.x;<br> }</p> 
<p>graph.append(‘g’)<br> .attr(‘fill’, ‘none’)<br> .attr(‘stroke-width’, 1.2)<br> .selectAll(‘path’)<br> .data(tree_struct.links())<br> .join(‘path’)<br> .attr(‘d’, draw_single_edge)<br> .attr(<br> ‘stroke’, d =&gt; (d.target === d.source.children[0]) ? ‘#0F0’ : ‘#F00’);<br> }</p> 
<p>display_tree({“margin”: 10, “node_x_size”: 160, “node_y_size”: 28, “node_x_offset”: 180, “node_y_offset”: 33, “font_size”: 10, “edge_rounding”: 20, “node_padding”: 2, “show_plot_bounding_box”: false}, {“value”: {“type”: “PROBABILITY”, “distribution”: [0.47093023255813954, 0.19476744186046513, 0.33430232558139533], “num_examples”: 344.0}, “condition”: {“type”: “NUMERICAL_IS_HIGHER_THAN”, “attribute”: “bill_length_mm”, “threshold”: 43.25}, “children”: [{“value”: {“type”: “PROBABILITY”, “distribution”: [0.005847953216374269, 0.3567251461988304, 0.6374269005847953], “num_examples”: 171.0}, “condition”: {“type”: “CATEGORICAL_IS_IN”, “attribute”: “island”, “mask”: [“Biscoe”]}, “children”: [{“value”: {“type”: “PROBABILITY”, “distribution”: [0.00909090909090909, 0.0, 0.990909090909091], “num_examples”: 110.0}, “condition”: {“type”: “NUMERICAL_IS_HIGHER_THAN”, “attribute”: “bill_depth_mm”, “threshold”: 17.225584030151367}, “children”: [{“value”: {“type”: “PROBABILITY”, “distribution”: [0.16666666666666666, 0.0, 0.8333333333333334], “num_examples”: 6.0}}, {“value”: {“type”: “PROBABILITY”, “distribution”: [0.0, 0.0, 1.0], “num_examples”: 104.0}}]}, {“value”: {“type”: “PROBABILITY”, “distribution”: [0.0, 1.0, 0.0], “num_examples”: 61.0}}]}, {“value”: {“type”: “PROBABILITY”, “distribution”: [0.930635838150289, 0.03468208092485549, 0.03468208092485549], “num_examples”: 173.0}, “condition”: {“type”: “NUMERICAL_IS_HIGHER_THAN”, “attribute”: “bill_depth_mm”, “threshold”: 15.100000381469727}, “children”: [{“value”: {“type”: “PROBABILITY”, “distribution”: [0.9640718562874252, 0.03592814371257485, 0.0], “num_examples”: 167.0}, “condition”: {“type”: “NUMERICAL_IS_HIGHER_THAN”, “attribute”: “flipper_length_mm”, “threshold”: 187.5}, “children”: [{“value”: {“type”: “PROBABILITY”, “distribution”: [1.0, 0.0, 0.0], “num_examples”: 104.0}}, {“value”: {“type”: “PROBABILITY”, “distribution”: [0.9047619047619048, 0.09523809523809523, 0.0], “num_examples”: 63.0}, “condition”: {“type”: “NUMERICAL_IS_HIGHER_THAN”, “attribute”: “bill_length_mm”, “threshold”: 42.30000305175781}}]}, {“value”: {“type”: “PROBABILITY”, “distribution”: [0.0, 0.0, 1.0], “num_examples”: 6.0}}]}]}, “#tree_plot_05707b35c4f748738efd3da21ab9197f”)<br> </p> 
<h3><a id="_981"></a>检查模型结构</h3> 
<p>模型结构和元数据可以通过<code>make_inspector()</code>创建的<strong>inspector</strong>来获取。</p> 
<p>**注意：**根据学习算法和超参数的不同，inspector将暴露不同的专门属性。例如，<code>winner_take_all</code>字段是随机森林模型特有的。</p> 
<pre><code class="prism language-python"><span class="token comment"># 创建一个模型检查器对象，用于检查模型的性能和质量</span>
inspector <span class="token operator">=</span> model<span class="token punctuation">.</span>make_inspector<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>对于我们的模型，可用的检查员字段有：</p> 
<pre><code class="prism language-python"><span class="token comment"># 使用列表推导式，遍历inspector模块中的所有属性</span>
<span class="token comment"># 过滤掉以"_"开头的属性</span>
fields <span class="token operator">=</span> <span class="token punctuation">[</span>field <span class="token keyword">for</span> field <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>inspector<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> field<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>['MODEL_NAME',
 'dataspec',
 'evaluation',
 'export_to_tensorboard',
 'extract_all_trees',
 'extract_tree',
 'features',
 'header',
 'iterate_on_nodes',
 'label',
 'label_classes',
 'metadata',
 'model_type',
 'num_trees',
 'objective',
 'specialized_header',
 'task',
 'training_logs',
 'tuning_logs',
 'variable_importances',
 'winner_take_all_inference']
</code></pre> 
<p>记得查看<a href="https://tensorflow.org/decision_forests/api_docs/python/tfdf/inspector/AbstractInspector" rel="nofollow">API参考</a>或使用<code>?</code>查看内置文档。</p> 
<pre><code class="prism language-python">?inspector<span class="token punctuation">.</span>model_type

</code></pre> 
<p>一些模型元数据：</p> 
<pre><code class="prism language-python"><span class="token comment"># 打印模型类型</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Model type:"</span><span class="token punctuation">,</span> inspector<span class="token punctuation">.</span>model_type<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 打印模型中树的数量</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Number of trees:"</span><span class="token punctuation">,</span> inspector<span class="token punctuation">.</span>num_trees<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 打印模型的目标函数</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Objective:"</span><span class="token punctuation">,</span> inspector<span class="token punctuation">.</span>objective<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 打印模型的输入特征</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Input features:"</span><span class="token punctuation">,</span> inspector<span class="token punctuation">.</span>features<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Model type: RANDOM_FOREST
Number of trees: 300
Objective: Classification(label=__LABEL, class=None, num_classes=3)
Input features: ["bill_depth_mm" (1; #0), "bill_length_mm" (1; #1), "body_mass_g" (1; #2), "flipper_length_mm" (1; #3), "island" (4; #4), "sex" (4; #5), "year" (1; #6)]
</code></pre> 
<p><code>evaluate()</code>是在训练期间计算的模型评估。用于此评估的数据集取决于算法。例如，它可以是验证数据集或袋外数据集。</p> 
<p>**注意：**虽然在训练期间计算，但<code>evaluate()</code>从未对训练数据集进行评估。</p> 
<pre><code class="prism language-python"><span class="token comment"># 创建一个名为inspector的对象</span>
inspector <span class="token operator">=</span> Inspector<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 调用inspector对象的evaluation()方法</span>
inspector<span class="token punctuation">.</span>evaluation<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Evaluation(num_examples=344, accuracy=0.9767441860465116, loss=0.06782230959804512, rmse=None, ndcg=None, aucs=None, auuc=None, qini=None)
</code></pre> 
<p>变量重要性如下：</p> 
<p>The variable importances are:</p> 
<pre><code class="prism language-python"><span class="token comment"># 打印可用的变量重要性</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Available variable importances:"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 遍历变量重要性字典的键，并打印出来</span>
<span class="token keyword">for</span> importance <span class="token keyword">in</span> inspector<span class="token punctuation">.</span>variable_importances<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">,</span> importance<span class="token punctuation">)</span>
</code></pre> 
<pre><code>Available variable importances:
	 MEAN_DECREASE_IN_AP_1_VS_OTHERS
	 MEAN_DECREASE_IN_PRAUC_3_VS_OTHERS
	 SUM_SCORE
	 MEAN_DECREASE_IN_PRAUC_1_VS_OTHERS
	 MEAN_DECREASE_IN_ACCURACY
	 MEAN_DECREASE_IN_AUC_1_VS_OTHERS
	 MEAN_DECREASE_IN_AP_3_VS_OTHERS
	 NUM_AS_ROOT
	 MEAN_DECREASE_IN_AP_2_VS_OTHERS
	 MEAN_DECREASE_IN_AUC_2_VS_OTHERS
	 MEAN_MIN_DEPTH
	 MEAN_DECREASE_IN_AUC_3_VS_OTHERS
	 NUM_NODES
	 MEAN_DECREASE_IN_PRAUC_2_VS_OTHERS
</code></pre> 
<p>不同的变量重要性具有不同的语义。例如，具有<strong>平均减少auc</strong>为<code>0.05</code>的特征意味着从训练数据集中移除该特征会使AUC降低/受损5%。</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取类别1与其他类别之间的AUC的平均减少量</span>
mean_decrease_in_auc_1_vs_others <span class="token operator">=</span> inspector<span class="token punctuation">.</span>variable_importances<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"MEAN_DECREASE_IN_AUC_1_VS_OTHERS"</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>[("bill_length_mm" (1; #1), 0.0713061951754389),
 ("island" (4; #4), 0.007298519736842035),
 ("flipper_length_mm" (1; #3), 0.004505893640351366),
 ("bill_depth_mm" (1; #0), 0.0021244517543865804),
 ("body_mass_g" (1; #2), 0.0005482456140351033),
 ("sex" (4; #5), 0.00047971491228060437),
 ("year" (1; #6), 0.0)]
</code></pre> 
<p>绘制使用Matplotlib的检查器中的变量重要性</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 创建一个大小为12x4的图形</span>

<span class="token comment"># 平均AUC下降值（class 1相对于其他类别）</span>
variable_importance_metric <span class="token operator">=</span> <span class="token string">"MEAN_DECREASE_IN_AUC_1_VS_OTHERS"</span>
variable_importances <span class="token operator">=</span> inspector<span class="token punctuation">.</span>variable_importances<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>variable_importance_metric<span class="token punctuation">]</span>

<span class="token comment"># 提取特征名称和重要性值</span>
<span class="token comment">#</span>
<span class="token comment"># `variable_importances` 是一个包含&lt;特征, 重要性&gt;元组的列表</span>
feature_names <span class="token operator">=</span> <span class="token punctuation">[</span>vi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token keyword">for</span> vi <span class="token keyword">in</span> variable_importances<span class="token punctuation">]</span>  <span class="token comment"># 提取特征名称</span>
feature_importances <span class="token operator">=</span> <span class="token punctuation">[</span>vi<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> vi <span class="token keyword">in</span> variable_importances<span class="token punctuation">]</span>  <span class="token comment"># 提取重要性值</span>
<span class="token comment"># 特征按重要性值降序排列</span>
feature_ranks <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>feature_names<span class="token punctuation">)</span><span class="token punctuation">)</span>

bar <span class="token operator">=</span> plt<span class="token punctuation">.</span>barh<span class="token punctuation">(</span>feature_ranks<span class="token punctuation">,</span> feature_importances<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> feature_ranks<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 创建水平条形图</span>
plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span>feature_ranks<span class="token punctuation">,</span> feature_names<span class="token punctuation">)</span>  <span class="token comment"># 设置y轴刻度为特征名称</span>
plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>invert_yaxis<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 反转y轴刻度顺序，使重要性高的特征在上方</span>

<span class="token comment"># TODO: 当可用时，替换为 "plt.bar_label()"</span>
<span class="token comment"># 使用值标记每个条形图</span>
<span class="token keyword">for</span> importance<span class="token punctuation">,</span> patch <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>feature_importances<span class="token punctuation">,</span> bar<span class="token punctuation">.</span>patches<span class="token punctuation">)</span><span class="token punctuation">:</span>
  plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span>patch<span class="token punctuation">.</span>get_x<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> patch<span class="token punctuation">.</span>get_width<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> patch<span class="token punctuation">.</span>get_y<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>importance<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> va<span class="token operator">=</span><span class="token string">"top"</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span>variable_importance_metric<span class="token punctuation">)</span>  <span class="token comment"># 设置x轴标签为重要性度量</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"Mean decrease in AUC of the class 1 vs the others"</span><span class="token punctuation">)</span>  <span class="token comment"># 设置图形标题</span>
plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 调整图形布局，以防止标签重叠</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 显示图形</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/52/3EhRgbKR_o.png" alt=""></p> 
<p>最后，访问实际的树结构：</p> 
<pre><code class="prism language-python"><span class="token comment"># 从inspector对象中提取树的信息</span>
<span class="token comment"># 参数tree_idx表示要提取的树的索引，这里为0表示提取第一棵树的信息</span>
inspector<span class="token punctuation">.</span>extract_tree<span class="token punctuation">(</span>tree_idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>Tree(root=NonLeafNode(condition=(bill_length_mm &gt;= 43.25; miss=True, score=0.5482327342033386), pos_child=NonLeafNode(condition=(island in ['Biscoe']; miss=True, score=0.6515106558799744), pos_child=NonLeafNode(condition=(bill_depth_mm &gt;= 17.225584030151367; miss=False, score=0.027205035090446472), pos_child=LeafNode(value=ProbabilityValue([0.16666666666666666, 0.0, 0.8333333333333334],n=6.0), idx=7), neg_child=LeafNode(value=ProbabilityValue([0.0, 0.0, 1.0],n=104.0), idx=6), value=ProbabilityValue([0.00909090909090909, 0.0, 0.990909090909091],n=110.0)), neg_child=LeafNode(value=ProbabilityValue([0.0, 1.0, 0.0],n=61.0), idx=5), value=ProbabilityValue([0.005847953216374269, 0.3567251461988304, 0.6374269005847953],n=171.0)), neg_child=NonLeafNode(condition=(bill_depth_mm &gt;= 15.100000381469727; miss=True, score=0.150658518075943), pos_child=NonLeafNode(condition=(flipper_length_mm &gt;= 187.5; miss=True, score=0.036139510571956635), pos_child=LeafNode(value=ProbabilityValue([1.0, 0.0, 0.0],n=104.0), idx=4), neg_child=NonLeafNode(condition=(bill_length_mm &gt;= 42.30000305175781; miss=True, score=0.23430533707141876), pos_child=LeafNode(value=ProbabilityValue([0.0, 1.0, 0.0],n=5.0), idx=3), neg_child=NonLeafNode(condition=(bill_length_mm &gt;= 40.55000305175781; miss=True, score=0.043961383402347565), pos_child=LeafNode(value=ProbabilityValue([0.8, 0.2, 0.0],n=5.0), idx=2), neg_child=LeafNode(value=ProbabilityValue([1.0, 0.0, 0.0],n=53.0), idx=1), value=ProbabilityValue([0.9827586206896551, 0.017241379310344827, 0.0],n=58.0)), value=ProbabilityValue([0.9047619047619048, 0.09523809523809523, 0.0],n=63.0)), value=ProbabilityValue([0.9640718562874252, 0.03592814371257485, 0.0],n=167.0)), neg_child=LeafNode(value=ProbabilityValue([0.0, 0.0, 1.0],n=6.0), idx=0), value=ProbabilityValue([0.930635838150289, 0.03468208092485549, 0.03468208092485549],n=173.0)), value=ProbabilityValue([0.47093023255813954, 0.19476744186046513, 0.33430232558139533],n=344.0)), label_classes=None)
</code></pre> 
<p>提取树并不高效。如果速度很重要，可以使用<code>iterate_on_nodes()</code>方法来进行模型检查。这个方法是对模型的所有节点进行深度优先的前序遍历迭代器。</p> 
<p><strong>注意：</strong><code>extract_tree()</code>是使用<code>iterate_on_nodes()</code>实现的。</p> 
<p>以下示例计算每个特征被使用的次数（这是一种结构变量重要性的指标）：</p> 
<pre><code class="prism language-python"><span class="token comment"># 创建一个默认字典number_of_use，用于记录每个特征在其条件中被使用的次数</span>
number_of_use <span class="token operator">=</span> collections<span class="token punctuation">.</span>defaultdict<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment"># 对所有节点进行深度优先的前序遍历</span>
<span class="token keyword">for</span> node_iter <span class="token keyword">in</span> inspector<span class="token punctuation">.</span>iterate_on_nodes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

  <span class="token comment"># 如果节点不是叶节点，则跳过</span>
  <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>node_iter<span class="token punctuation">.</span>node<span class="token punctuation">,</span> tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>node<span class="token punctuation">.</span>NonLeafNode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">continue</span>

  <span class="token comment"># 遍历节点条件中使用的所有特征</span>
  <span class="token comment"># 默认情况下，模型是"oblique"的，即每个节点测试一个特征</span>
  <span class="token keyword">for</span> feature <span class="token keyword">in</span> node_iter<span class="token punctuation">.</span>node<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>features<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 特征在使用次数上加1</span>
    number_of_use<span class="token punctuation">[</span>feature<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>

<span class="token comment"># 打印每个特征的条件节点数</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Number of condition nodes per features:"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> feature<span class="token punctuation">,</span> count <span class="token keyword">in</span> number_of_use<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">,</span> feature<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
</code></pre> 
<pre><code>Number of condition nodes per features:
	 bill_length_mm : 778
	 bill_depth_mm : 463
	 flipper_length_mm : 414
	 island : 342
	 body_mass_g : 338
	 year : 19
	 sex : 36
</code></pre> 
<h3><a id="_1230"></a>手动创建模型</h3> 
<p>在本节中，您将手动创建一个小的随机森林模型。为了使其更加简单，该模型只包含一个简单的树：</p> 
<pre><code>3个标签类别：红色、蓝色和绿色。
2个特征：f1（数值型）和f2（字符串分类型）

f1&gt;=1.5
    ├─(正)─ f2在["猫","狗"]中
    │         ├─(正)─ 值：[0.8, 0.1, 0.1]
    │         └─(负)─ 值：[0.1, 0.8, 0.1]
    └─(负)─ 值：[0.1, 0.1, 0.8]
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 创建模型构建器</span>
builder <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>RandomForestBuilder<span class="token punctuation">(</span>
    path<span class="token operator">=</span><span class="token string">"/tmp/manual_model"</span><span class="token punctuation">,</span>  <span class="token comment"># 指定模型保存的路径</span>
    objective<span class="token operator">=</span>tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>objective<span class="token punctuation">.</span>ClassificationObjective<span class="token punctuation">(</span>
        label<span class="token operator">=</span><span class="token string">"color"</span><span class="token punctuation">,</span>  <span class="token comment"># 指定目标变量为"color"</span>
        classes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"red"</span><span class="token punctuation">,</span> <span class="token string">"blue"</span><span class="token punctuation">,</span> <span class="token string">"green"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 指定目标变量的类别为["red", "blue", "green"]</span>
</code></pre> 
<p>每棵树都逐个添加。</p> 
<p><strong>注意：</strong> 树对象（<code>tfdf.py_tree.tree.Tree</code>）与前一节中<code>extract_tree()</code>返回的树对象相同。</p> 
<pre><code class="prism language-python"><span class="token comment"># 导入所需的模块和类</span>
Tree <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>tree<span class="token punctuation">.</span>Tree  <span class="token comment"># 树结构</span>
SimpleColumnSpec <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>dataspec<span class="token punctuation">.</span>SimpleColumnSpec  <span class="token comment"># 列规范</span>
ColumnType <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>dataspec<span class="token punctuation">.</span>ColumnType  <span class="token comment"># 列类型</span>
NonLeafNode <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>node<span class="token punctuation">.</span>NonLeafNode  <span class="token comment"># 非叶节点</span>
LeafNode <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>node<span class="token punctuation">.</span>LeafNode  <span class="token comment"># 叶节点</span>
NumericalHigherThanCondition <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>NumericalHigherThanCondition  <span class="token comment"># 数值大于条件</span>
CategoricalIsInCondition <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>CategoricalIsInCondition  <span class="token comment"># 类别在条件</span>
ProbabilityValue <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>py_tree<span class="token punctuation">.</span>value<span class="token punctuation">.</span>ProbabilityValue  <span class="token comment"># 概率值</span>

<span class="token comment"># 创建树结构并添加到builder中</span>
builder<span class="token punctuation">.</span>add_tree<span class="token punctuation">(</span>
    Tree<span class="token punctuation">(</span>
        NonLeafNode<span class="token punctuation">(</span>
            condition<span class="token operator">=</span>NumericalHigherThanCondition<span class="token punctuation">(</span>
                feature<span class="token operator">=</span>SimpleColumnSpec<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"f1"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span>ColumnType<span class="token punctuation">.</span>NUMERICAL<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 数值特征"f1"</span>
                threshold<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">,</span>  <span class="token comment"># 阈值为1.5</span>
                missing_evaluation<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 不考虑缺失值</span>
            pos_child<span class="token operator">=</span>NonLeafNode<span class="token punctuation">(</span>
                condition<span class="token operator">=</span>CategoricalIsInCondition<span class="token punctuation">(</span>
                    feature<span class="token operator">=</span>SimpleColumnSpec<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"f2"</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token operator">=</span>ColumnType<span class="token punctuation">.</span>CATEGORICAL<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 类别特征"f2"</span>
                    mask<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"cat"</span><span class="token punctuation">,</span> <span class="token string">"dog"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 类别为"cat"或"dog"</span>
                    missing_evaluation<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 不考虑缺失值</span>
                pos_child<span class="token operator">=</span>LeafNode<span class="token punctuation">(</span>value<span class="token operator">=</span>ProbabilityValue<span class="token punctuation">(</span>probability<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_examples<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 正向子节点为叶节点，概率值为[0.8, 0.1, 0.1]，样本数为10</span>
                neg_child<span class="token operator">=</span>LeafNode<span class="token punctuation">(</span>value<span class="token operator">=</span>ProbabilityValue<span class="token punctuation">(</span>probability<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_examples<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 负向子节点为叶节点，概率值为[0.1, 0.8, 0.1]，样本数为20</span>
            neg_child<span class="token operator">=</span>LeafNode<span class="token punctuation">(</span>value<span class="token operator">=</span>ProbabilityValue<span class="token punctuation">(</span>probability<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_examples<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 负向子节点为叶节点，概率值为[0.1, 0.1, 0.8]，样本数为30</span>
</code></pre> 
<h3><a id="_1289"></a>结束树写作</h3> 
<pre><code class="prism language-python"><span class="token comment"># 关闭builder对象</span>
builder<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>[INFO 2022-12-14T12:25:00.790486355+00:00 kernel.cc:1175] Loading model from path /tmp/manual_model/tmp/ with prefix e09a067144bc479b
[INFO 2022-12-14T12:25:00.790802259+00:00 decision_forest.cc:640] Model loaded with 1 root(s), 5 node(s), and 2 input feature(s).
[INFO 2022-12-14T12:25:00.790878962+00:00 kernel.cc:1021] Use fast generic engine
WARNING:absl:Found untraced functions such as call_get_leaves, _update_step_xla while saving (showing 2 of 2). These functions will not be directly callable after loading.


INFO:tensorflow:Assets written to: /tmp/manual_model/assets


INFO:tensorflow:Assets written to: /tmp/manual_model/assets
</code></pre> 
<p>现在您可以将该模型作为常规的keras模型打开，并进行预测：</p> 
<pre><code class="prism language-python"><span class="token comment"># 加载预训练模型</span>
manual_model <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models<span class="token punctuation">.</span>load_model<span class="token punctuation">(</span><span class="token string">"/tmp/manual_model"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>[INFO 2022-12-14T12:25:01.436506097+00:00 kernel.cc:1175] Loading model from path /tmp/manual_model/assets/ with prefix e09a067144bc479b
[INFO 2022-12-14T12:25:01.436871761+00:00 decision_forest.cc:640] Model loaded with 1 root(s), 5 node(s), and 2 input feature(s).
[INFO 2022-12-14T12:25:01.436909696+00:00 kernel.cc:1021] Use fast generic engine
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 创建一个tf.data.Dataset对象，从给定的张量中切片得到数据集</span>
<span class="token comment"># 数据集包含两个特征"f1"和"f2"，分别是浮点数和字符串类型</span>
<span class="token comment"># 数据集中的每个样本是一个字典，包含"f1"和"f2"两个键</span>
<span class="token comment"># 样本数据为：</span>
<span class="token comment">#   "f1": [1.0, 2.0, 3.0]</span>
<span class="token comment">#   "f2": ["cat", "cat", "bird"]</span>
<span class="token comment"># 使用batch(2)方法将数据集划分为大小为2的批次</span>
examples <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span>from_tensor_slices<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"f1"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"f2"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cat"</span><span class="token punctuation">,</span> <span class="token string">"cat"</span><span class="token punctuation">,</span> <span class="token string">"bird"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>batch<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 使用manual_model对examples进行预测</span>
predictions <span class="token operator">=</span> manual_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>examples<span class="token punctuation">)</span>

<span class="token comment"># 打印预测结果</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"predictions:\n"</span><span class="token punctuation">,</span> predictions<span class="token punctuation">)</span>
</code></pre> 
<pre><code>1/2 [==============&gt;...............] - ETA: 0s
2/2 [==============================] - 0s 2ms/step
predictions:
 [[0.1 0.1 0.8]
 [0.8 0.1 0.1]
 [0.1 0.8 0.1]]
</code></pre> 
<p>访问结构：</p> 
<p><strong>注意：</strong> 由于模型是序列化和反序列化的，您需要使用一种替代但等效的形式。</p> 
<pre><code class="prism language-python"><span class="token comment"># 代码注释</span>

<span class="token comment"># 获取yggdrasil模型路径</span>
yggdrasil_model_path <span class="token operator">=</span> manual_model<span class="token punctuation">.</span>yggdrasil_model_path_tensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"yggdrasil_model_path:"</span><span class="token punctuation">,</span>yggdrasil_model_path<span class="token punctuation">)</span>

<span class="token comment"># 创建一个模型检查器，用于检查模型的输入特征</span>
inspector <span class="token operator">=</span> tfdf<span class="token punctuation">.</span>inspector<span class="token punctuation">.</span>make_inspector<span class="token punctuation">(</span>yggdrasil_model_path<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Input features:"</span><span class="token punctuation">,</span> inspector<span class="token punctuation">.</span>features<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>yggdrasil_model_path: /tmp/manual_model/assets/
Input features: ["f1" (1; #1), "f2" (4; #2)]
</code></pre> 
<p>当然，您可以手动绘制这个构建的模型：</p> 
<pre><code class="prism language-python"><span class="token comment"># 导入tfdf库中的plot_model_in_colab函数</span>
<span class="token keyword">import</span> tensorflow_decision_forests <span class="token keyword">as</span> tfdf

<span class="token comment"># 使用plot_model_in_colab函数绘制manual_model模型的结构图</span>
tfdf<span class="token punctuation">.</span>model_plotter<span class="token punctuation">.</span>plot_model_in_colab<span class="token punctuation">(</span>manual_model<span class="token punctuation">)</span>
</code></pre> 
<div id="tree_plot_34c8fb6cf7ca49eda845b971be7f0560"></div> 
<p>/**</p> 
<ul><li>Plotting of decision trees generated by TF-DF.</li><li><li>A tree is a recursive structure of node objects.</li><li>A node contains one or more of the following components:</li><li><li> 
  <ul><li>A value: Representing the output of the node. If the node is not a leaf,</li></ul> </li><li> <pre><code> the value is only present for analysis i.e. it is not used for
</code></pre> </li><li> <pre><code> predictions.
</code></pre> </li><li><li> 
  <ul><li>A condition : For non-leaf nodes, the condition (also known as split)</li></ul> </li><li> <pre><code> defines a binary test to branch to the positive or negative child.
</code></pre> </li><li><li> 
  <ul><li>An explanation: Generally a plot showing the relation between the label</li></ul> </li><li> <pre><code> and the condition to give insights about the effect of the condition.
</code></pre> </li><li><li> 
  <ul><li>Two children : For non-leaf nodes, the children nodes. The first</li></ul> </li><li> <pre><code> children (i.e. "node.children[0]") is the negative children (drawn in
</code></pre> </li><li> <pre><code> red). The second children is the positive one (drawn in green).
</code></pre> </li><li></ul> 
<p>*/</p> 
<p>/**</p> 
<ul><li>Plots a single decision tree into a DOM element.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!tree} raw_tree Recursive tree structure.</li><li>@param {string} canvas_id Id of the output dom element.<br> */<br> function display_tree(options, raw_tree, canvas_id) {<!-- --><br> console.log(options);</li></ul> 
<p>// Determine the node placement.<br> const tree_struct = d3.tree().nodeSize(<br> [options.node_y_offset, options.node_x_offset])(d3.hierarchy(raw_tree));</p> 
<p>// Boundaries of the node placement.<br> let x_min = Infinity;<br> let x_max = -x_min;<br> let y_min = Infinity;<br> let y_max = -x_min;</p> 
<p>tree_struct.each(d =&gt; {<!-- --><br> if (d.x &gt; x_max) x_max = d.x;<br> if (d.x &lt; x_min) x_min = d.x;<br> if (d.y &gt; y_max) y_max = d.y;<br> if (d.y &lt; y_min) y_min = d.y;<br> });</p> 
<p>// Size of the plot.<br> const width = y_max - y_min + options.node_x_size + options.margin * 2;<br> const height = x_max - x_min + options.node_y_size + options.margin * 2 +<br> options.node_y_offset - options.node_y_size;</p> 
<p>const plot = d3.select(canvas_id);</p> 
<p>// Tool tip<br> options.tooltip = plot.append(‘div’)<br> .attr(‘width’, 100)<br> .attr(‘height’, 100)<br> .style(‘padding’, ‘4px’)<br> .style(‘background’, ‘#fff’)<br> .style(‘box-shadow’, ‘4px 4px 0px rgba(0,0,0,0.1)’)<br> .style(‘border’, ‘1px solid black’)<br> .style(‘font-family’, ‘sans-serif’)<br> .style(‘font-size’, options.font_size)<br> .style(‘position’, ‘absolute’)<br> .style(‘z-index’, ‘10’)<br> .attr(‘pointer-events’, ‘none’)<br> .style(‘display’, ‘none’);</p> 
<p>// Create canvas<br> const svg = plot.append(‘svg’).attr(‘width’, width).attr(‘height’, height);<br> const graph =<br> svg.style(‘overflow’, ‘visible’)<br> .append(‘g’)<br> .attr(‘font-family’, ‘sans-serif’)<br> .attr(‘font-size’, options.font_size)<br> .attr(<br> ‘transform’,<br> () =&gt; <code>translate(${options.margin},${ - x_min + options.node_y_offset / 2 + options.margin})</code>);</p> 
<p>// Plot bounding box.<br> if (options.show_plot_bounding_box) {<!-- --><br> svg.append(‘rect’)<br> .attr(‘width’, width)<br> .attr(‘height’, height)<br> .attr(‘fill’, ‘none’)<br> .attr(‘stroke-width’, 1.0)<br> .attr(‘stroke’, ‘black’);<br> }</p> 
<p>// Draw the edges.<br> display_edges(options, graph, tree_struct);</p> 
<p>// Draw the nodes.<br> display_nodes(options, graph, tree_struct);<br> }</p> 
<p>/**</p> 
<ul><li>Draw the nodes of the tree.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!graph} graph D3 search handle containing the graph.</li><li>@param {!tree_struct} tree_struct Structure of the tree (node placement,</li><li> <pre><code>data, etc.).
</code></pre> </li></ul> 
<p>*/<br> function display_nodes(options, graph, tree_struct) {<!-- --><br> const nodes = graph.append(‘g’)<br> .selectAll(‘g’)<br> .data(tree_struct.descendants())<br> .join(‘g’)<br> .attr(‘transform’, d =&gt; <code>translate(${d.y},${d.x})</code>);</p> 
<p>nodes.append(‘rect’)<br> .attr(‘x’, 0.5)<br> .attr(‘y’, 0.5)<br> .attr(‘width’, options.node_x_size)<br> .attr(‘height’, options.node_y_size)<br> .attr(‘stroke’, ‘lightgrey’)<br> .attr(‘stroke-width’, 1)<br> .attr(‘fill’, ‘white’)<br> .attr(‘y’, -options.node_y_size / 2);</p> 
<p>// Brackets on the right of condition nodes without children.<br> non_leaf_node_without_children =<br> nodes.filter(node =&gt; node.data.condition != null &amp;&amp; node.children == null)<br> .append(‘g’)<br> .attr(‘transform’, <code>translate(${options.node_x_size},0)</code>);</p> 
<p>non_leaf_node_without_children.append(‘path’)<br> .attr(‘d’, ‘M0,0 C 10,0 0,10 10,10’)<br> .attr(‘fill’, ‘none’)<br> .attr(‘stroke-width’, 1.0)<br> .attr(‘stroke’, ‘#F00’);</p> 
<p>non_leaf_node_without_children.append(‘path’)<br> .attr(‘d’, ‘M0,0 C 10,0 0,-10 10,-10’)<br> .attr(‘fill’, ‘none’)<br> .attr(‘stroke-width’, 1.0)<br> .attr(‘stroke’, ‘#0F0’);</p> 
<p>const node_content = nodes.append(‘g’).attr(<br> ‘transform’,<br> <code>translate(0,${options.node_padding - options.node_y_size / 2})</code>);</p> 
<p>node_content.append(node =&gt; create_node_element(options, node));<br> }</p> 
<p>/**</p> 
<ul><li>Creates the D3 content for a single node.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!node} node Node to draw.</li><li>@return {!d3} D3 content.<br> */<br> function create_node_element(options, node) {<!-- --><br> // Output accumulator.<br> let output = {<!-- --><br> // Content to draw.<br> content: d3.create(‘svg:g’),<br> // Vertical offset to the next element to draw.<br> vertical_offset: 0<br> };</li></ul> 
<p>// Conditions.<br> if (node.data.condition != null) {<!-- --><br> display_condition(options, node.data.condition, output);<br> }</p> 
<p>// Values.<br> if (node.data.value != null) {<!-- --><br> display_value(options, node.data.value, output);<br> }</p> 
<p>// Explanations.<br> if (node.data.explanation != null) {<!-- --><br> display_explanation(options, node.data.explanation, output);<br> }</p> 
<p>return output.content.node();<br> }</p> 
<p>/**</p> 
<ul><li>Adds a single line of text inside of a node.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {string} text Text to display.</li><li>@param {!output} output Output display accumulator.<br> */<br> function display_node_text(options, text, output) {<!-- --><br> output.content.append(‘text’)<br> .attr(‘x’, options.node_padding)<br> .attr(‘y’, output.vertical_offset)<br> .attr(‘alignment-baseline’, ‘hanging’)<br> .text(text);<br> output.vertical_offset += 10;<br> }</li></ul> 
<p>/**</p> 
<ul><li>Adds a single line of text inside of a node with a tooltip.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {string} text Text to display.</li><li>@param {string} tooltip Text in the Tooltip.</li><li>@param {!output} output Output display accumulator.<br> */<br> function display_node_text_with_tooltip(options, text, tooltip, output) {<!-- --><br> const item = output.content.append(‘text’)<br> .attr(‘x’, options.node_padding)<br> .attr(‘alignment-baseline’, ‘hanging’)<br> .text(text);</li></ul> 
<p>add_tooltip(options, item, () =&gt; tooltip);<br> output.vertical_offset += 10;<br> }</p> 
<p>/**</p> 
<ul><li>Adds a tooltip to a dom element.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!dom} target Dom element to equip with a tooltip.</li><li>@param {!func} get_content Generates the html content of the tooltip.<br> */<br> function add_tooltip(options, target, get_content) {<!-- --><br> function show(d) {<!-- --><br> options.tooltip.style(‘display’, ‘block’);<br> options.tooltip.html(get_content());<br> }</li></ul> 
<p>function hide(d) {<!-- --><br> options.tooltip.style(‘display’, ‘none’);<br> }</p> 
<p>function move(d) {<!-- --><br> options.tooltip.style(‘display’, ‘block’);<br> options.tooltip.style(‘left’, (d.pageX + 5) + ‘px’);<br> options.tooltip.style(‘top’, d.pageY + ‘px’);<br> }</p> 
<p>target.on(‘mouseover’, show);<br> target.on(‘mouseout’, hide);<br> target.on(‘mousemove’, move);<br> }</p> 
<p>/**</p> 
<ul><li>Adds a condition inside of a node.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!condition} condition Condition to display.</li><li>@param {!output} output Output display accumulator.<br> */<br> function display_condition(options, condition, output) {<!-- --><br> threshold_format = d3.format(‘r’);</li></ul> 
<p>if (condition.type === ‘IS_MISSING’) {<!-- --><br> display_node_text(options, <code>${condition.attribute} is missing</code>, output);<br> return;<br> }</p> 
<p>if (condition.type === ‘IS_TRUE’) {<!-- --><br> display_node_text(options, <code>${condition.attribute} is true</code>, output);<br> return;<br> }</p> 
<p>if (condition.type === ‘NUMERICAL_IS_HIGHER_THAN’) {<!-- --><br> format = d3.format(‘r’);<br> display_node_text(<br> options,<br> <code>${condition.attribute} &gt;= ${threshold_format(condition.threshold)}</code>,<br> output);<br> return;<br> }</p> 
<p>if (condition.type === ‘CATEGORICAL_IS_IN’) {<!-- --><br> display_node_text_with_tooltip(<br> options, <code>${condition.attribute} in [...]</code>,<br> <code>${condition.attribute} in [${condition.mask}]</code>, output);<br> return;<br> }</p> 
<p>if (condition.type === ‘CATEGORICAL_SET_CONTAINS’) {<!-- --><br> display_node_text_with_tooltip(<br> options, <code>${condition.attribute} intersect [...]</code>,<br> <code>${condition.attribute} intersect [${condition.mask}]</code>, output);<br> return;<br> }</p> 
<p>if (condition.type === ‘NUMERICAL_SPARSE_OBLIQUE’) {<!-- --><br> display_node_text_with_tooltip(<br> options, <code>Sparse oblique split...</code>,<br> <code>[${condition.attributes}]*[${condition.weights}]&gt;=${ threshold_format(condition.threshold)}</code>,<br> output);<br> return;<br> }</p> 
<p>display_node_text(<br> options, <code>Non supported condition ${condition.type}</code>, output);<br> }</p> 
<p>/**</p> 
<ul><li> <p>Adds a value inside of a node.</p> </li><li> <p>@param {!options} options Dictionary of configurations.</p> </li><li> <p>@param {!value} value Value to display.</p> </li><li> <p>@param {!output} output Output display accumulator.<br> */<br> function display_value(options, value, output) {<!-- --><br> if (value.type === ‘PROBABILITY’) {<!-- --><br> const left_margin = 0;<br> const right_margin = 50;<br> const plot_width = options.node_x_size - options.node_padding * 2 -<br> left_margin - right_margin;</p> <p>let cusum = Array.from(d3.cumsum(value.distribution));<br> cusum.unshift(0);<br> const distribution_plot = output.content.append(‘g’).attr(<br> ‘transform’, <code>translate(0,${output.vertical_offset + 0.5})</code>);</p> <p>distribution_plot.selectAll(‘rect’)<br> .data(value.distribution)<br> .join(‘rect’)<br> .attr(‘height’, 10)<br> .attr(<br> ‘x’,<br> (d, i) =&gt;<br> (cusum[i] * plot_width + left_margin + options.node_padding))<br> .attr(‘width’, (d, i) =&gt; d * plot_width)<br> .style(‘fill’, (d, i) =&gt; d3.schemeSet1[i]);</p> <p>const num_examples =<br> output.content.append(‘g’)<br> .attr(‘transform’, <code>translate(0,${output.vertical_offset})</code>)<br> .append(‘text’)<br> .attr(‘x’, options.node_x_size - options.node_padding)<br> .attr(‘alignment-baseline’, ‘hanging’)<br> .attr(‘text-anchor’, ‘end’)<br> .text(<code>(${value.num_examples})</code>);</p> <p>const distribution_details = d3.create(‘ul’);<br> distribution_details.selectAll(‘li’)<br> .data(value.distribution)<br> .join(‘li’)<br> .append(‘span’)<br> .text(<br> (d, i) =&gt;<br> ‘class ’ + i + ‘: ’ + d3.format(’.3%’)(value.distribution[i]));</p> <p>add_tooltip(options, distribution_plot, () =&gt; distribution_details.html());<br> add_tooltip(options, num_examples, () =&gt; ‘Number of examples’);</p> <p>output.vertical_offset += 10;<br> return;<br> }</p> </li></ul> 
<p>if (value.type === ‘REGRESSION’) {<!-- --><br> display_node_text(<br> options,<br> ‘value: ’ + d3.format(‘r’)(value.value) + <code> (</code> +<br> d3.format(’.6’)(value.num_examples) + <code>)</code>,<br> output);<br> return;<br> }</p> 
<p>display_node_text(options, <code>Non supported value ${value.type}</code>, output);<br> }</p> 
<p>/**</p> 
<ul><li>Adds an explanation inside of a node.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!explanation} explanation Explanation to display.</li><li>@param {!output} output Output display accumulator.<br> */<br> function display_explanation(options, explanation, output) {<!-- --><br> // Margin before the explanation.<br> output.vertical_offset += 10;</li></ul> 
<p>display_node_text(<br> options, <code>Non supported explanation ${explanation.type}</code>, output);<br> }</p> 
<p>/**</p> 
<ul><li>Draw the edges of the tree.</li><li>@param {!options} options Dictionary of configurations.</li><li>@param {!graph} graph D3 search handle containing the graph.</li><li>@param {!tree_struct} tree_struct Structure of the tree (node placement,</li><li> <pre><code>data, etc.).
</code></pre> </li></ul> 
<p>*/<br> function display_edges(options, graph, tree_struct) {<!-- --><br> // Draw an edge between a parent and a child node with a bezier.<br> function draw_single_edge(d) {<!-- --><br> return ‘M’ + (d.source.y + options.node_x_size) + ‘,’ + d.source.x + ’ C’ +<br> (d.source.y + options.node_x_size + options.edge_rounding) + ‘,’ +<br> d.source.x + ’ ’ + (d.target.y - options.edge_rounding) + ‘,’ +<br> d.target.x + ’ ’ + d.target.y + ‘,’ + d.target.x;<br> }</p> 
<p>graph.append(‘g’)<br> .attr(‘fill’, ‘none’)<br> .attr(‘stroke-width’, 1.2)<br> .selectAll(‘path’)<br> .data(tree_struct.links())<br> .join(‘path’)<br> .attr(‘d’, draw_single_edge)<br> .attr(<br> ‘stroke’, d =&gt; (d.target === d.source.children[0]) ? ‘#0F0’ : ‘#F00’);<br> }</p> 
<p>display_tree({“margin”: 10, “node_x_size”: 160, “node_y_size”: 28, “node_x_offset”: 180, “node_y_offset”: 33, “font_size”: 10, “edge_rounding”: 20, “node_padding”: 2, “show_plot_bounding_box”: false, “labels”: “[“red”, “blue”, “green”]”}, {“condition”: {“type”: “NUMERICAL_IS_HIGHER_THAN”, “attribute”: “f1”, “threshold”: 1.5}, “children”: [{“condition”: {“type”: “CATEGORICAL_IS_IN”, “attribute”: “f2”, “mask”: [“cat”, “dog”]}, “children”: [{“value”: {“type”: “PROBABILITY”, “distribution”: [0.8, 0.1, 0.1], “num_examples”: 10.0}}, {“value”: {“type”: “PROBABILITY”, “distribution”: [0.1, 0.8, 0.1], “num_examples”: 20.0}}]}, {“value”: {“type”: “PROBABILITY”, “distribution”: [0.1, 0.1, 0.8], “num_examples”: 30.0}}]}, “#tree_plot_34c8fb6cf7ca49eda845b971be7f0560”)<br> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/60f35f7a454ab364078a550ee3b9dd0c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">工具系列：TensorFlow决策森林_(3)使用dtreeviz可视化</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/188a8aa0cdecb9bc8d35022ab5a1bde9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于个人Git学习记录及相关</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>