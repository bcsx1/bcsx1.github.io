<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>再次解释Spring中一个bean的注入过程 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="再次解释Spring中一个bean的注入过程" />
<meta property="og:description" content="目录 一. 前置知识学习Spring中对bean的分类1. BeanDefinition2. BeanFactoryPostProcess3. BeanDefinitionRegistryPostProcessor4. BeanPostProcessors 后置处理器5. Aware 接口6. BeanFactory 与 ApplicationContext有什么区别7. BeanFactory 与 FactoryBean 有什么区别8. 重点:预习Spring中创建不同类型bean的先后顺序 二. 由SpringBoot启动run()源码引出ApplicationContext上线文的创建与基于注解的BeanDefinition读取器AnnotatedBeanDefinitionReader和基于ClassPath路径下的BeanDefinition扫描器ClassPathBeanDefinitionScanner1. AnnotatedBeanDefinitionReader引出一系列BeanFactoryPostProcessor,BeanPostProcessor的注册2. ClassPathBeanDefinitionScanner扫描beanfindCandidateComponents()将扫描到的class转换为转换为BeanDefinitionregisterBeanDefinition() 注册 BeanDefinition 到 BeanFactory 中 三. refresh()方法执行到BeanFactory的创建---&gt;BeanFactoryPostProcessor---&gt;BeanPostProcessor---&gt;其它单利bean的创建1. refresh()创建bean工厂,加载并实例化bean方法概述2. refresh---&gt;obtainFreshBeanFactory() bean工厂BeanFactory或BeanDefinitionRegistry与BeanDefinition xml解析器 XmlBeanDefinitionReade相关3. refresh()---&gt;invokeBeanFactoryPostProcessors() bean工厂后置处理器BeanFactoryPostProcessor的创建与执行4. refresh()---&gt;registerBeanPostProcessors() bean后置处理器的创建5. refresh()---&gt;initApplicationEventMulticaster() 初始化事件派发器,多播器6. refresh()---&gt; this.onRefresh() 用来初始化子容器中的bean,默认是空方法7. refresh()---&gt;this.registerListeners() 注册监听器8. refresh()---&gt;finishBeanFactoryInitialization()与beanFactory.getBean()引出bean的创建,是怎么由BeanDefinition实例化为bean的9. refresh()---&gt;this.finishRefresh() 完成ben的创建初始化工作,完成 IOC 容器的创建,发布容器刷新完成事件10. 概述 Spring 启动refresh()方法执行bean的状态流转过程11. Bean的生产顺序是由什么决定的,BeanDefinition的注册顺序是由什么决定的12. 怎么给Spring做扩展Spring IOC过程中有哪些扩展点如何在所有BeanDefinition注册完成后做扩展如何在所有的bean创建完成后做扩展 四. 其它问题总结1. BeanDefinitionRegistry的注册2. Spring 实例化bean有几种方式3. Spring有哪几种配置方式4. bean的配置方式5. @ComponentScan不设置basePackage为什么也会包扫描6. javaConfig如何代替spring.xml的7. @Component,@Controller,@Repository,@Service有什么区别8. @Import有几种使用方式9. @Configuration的作用及原理解析10. @Bean修饰的方法的调用是怎么保证单例的11. 如何将一个三方的类配置为Bean12." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/93425accc47d31a20eb82f33626a42b2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-17T17:12:09+08:00" />
<meta property="article:modified_time" content="2023-07-17T17:12:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">再次解释Spring中一个bean的注入过程</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#__1" rel="nofollow">一. 前置知识学习</a></li><li><ul><li><a href="#Springbean_8" rel="nofollow">Spring中对bean的分类</a></li><li><ul><li><a href="#1_BeanDefinition_16" rel="nofollow">1. BeanDefinition</a></li><li><a href="#2_BeanFactoryPostProcess_28" rel="nofollow">2. BeanFactoryPostProcess</a></li><li><a href="#3_BeanDefinitionRegistryPostProcessor_32" rel="nofollow">3. BeanDefinitionRegistryPostProcessor</a></li><li><a href="#4_BeanPostProcessors__36" rel="nofollow">4. BeanPostProcessors 后置处理器</a></li><li><a href="#5_Aware__49" rel="nofollow">5. Aware 接口</a></li><li><a href="#6_BeanFactory__ApplicationContext_59" rel="nofollow">6. BeanFactory 与 ApplicationContext有什么区别</a></li><li><a href="#7_BeanFactory__FactoryBean__61" rel="nofollow">7. BeanFactory 与 FactoryBean 有什么区别</a></li><li><a href="#8_Springbean_66" rel="nofollow">8. 重点:预习Spring中创建不同类型bean的先后顺序</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_SpringBootrunApplicationContextBeanDefinitionAnnotatedBeanDefinitionReaderClassPathBeanDefinitionClassPathBeanDefinitionScanner_78" rel="nofollow">二. 由SpringBoot启动run()源码引出ApplicationContext上线文的创建与基于注解的BeanDefinition读取器AnnotatedBeanDefinitionReader和基于ClassPath路径下的BeanDefinition扫描器ClassPathBeanDefinitionScanner</a></li><li><ul><li><a href="#1_AnnotatedBeanDefinitionReaderBeanFactoryPostProcessorBeanPostProcessor_210" rel="nofollow">1. AnnotatedBeanDefinitionReader引出一系列BeanFactoryPostProcessor,BeanPostProcessor的注册</a></li><li><a href="#2_ClassPathBeanDefinitionScannerbean_347" rel="nofollow">2. ClassPathBeanDefinitionScanner扫描bean</a></li><li><ul><li><a href="#findCandidateComponentsclassBeanDefinition_444" rel="nofollow">findCandidateComponents()将扫描到的class转换为转换为BeanDefinition</a></li><li><a href="#registerBeanDefinition__BeanDefinition__BeanFactory__612" rel="nofollow">registerBeanDefinition() 注册 BeanDefinition 到 BeanFactory 中</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_refreshBeanFactoryBeanFactoryPostProcessorBeanPostProcessorbean_699" rel="nofollow">三. refresh()方法执行到BeanFactory的创建---&gt;BeanFactoryPostProcessor---&gt;BeanPostProcessor---&gt;其它单利bean的创建</a></li><li><ul><li><a href="#1_refreshbeanbean_709" rel="nofollow">1. refresh()创建bean工厂,加载并实例化bean方法概述</a></li><li><a href="#2_refreshobtainFreshBeanFactory_beanBeanFactoryBeanDefinitionRegistryBeanDefinition_xml_XmlBeanDefinitionReade_769" rel="nofollow">2. refresh---&gt;obtainFreshBeanFactory() bean工厂BeanFactory或BeanDefinitionRegistry与BeanDefinition xml解析器 XmlBeanDefinitionReade相关</a></li><li><a href="#3_refreshinvokeBeanFactoryPostProcessors_beanBeanFactoryPostProcessor_909" rel="nofollow">3. refresh()---&gt;invokeBeanFactoryPostProcessors() bean工厂后置处理器BeanFactoryPostProcessor的创建与执行</a></li><li><a href="#4_refreshregisterBeanPostProcessors_bean_930" rel="nofollow">4. refresh()---&gt;registerBeanPostProcessors() bean后置处理器的创建</a></li><li><a href="#5_refreshinitApplicationEventMulticaster__941" rel="nofollow">5. refresh()---&gt;initApplicationEventMulticaster() 初始化事件派发器,多播器</a></li><li><a href="#6_refresh_thisonRefresh_bean_944" rel="nofollow">6. refresh()---&gt; this.onRefresh() 用来初始化子容器中的bean,默认是空方法</a></li><li><a href="#7_refreshthisregisterListeners__946" rel="nofollow">7. refresh()---&gt;this.registerListeners() 注册监听器</a></li><li><a href="#8_refreshfinishBeanFactoryInitializationbeanFactorygetBeanbeanBeanDefinitionbean_1002" rel="nofollow">8. refresh()---&gt;finishBeanFactoryInitialization()与beanFactory.getBean()引出bean的创建,是怎么由BeanDefinition实例化为bean的</a></li><li><a href="#9_refreshthisfinishRefresh_ben_IOC__1104" rel="nofollow">9. refresh()---&gt;this.finishRefresh() 完成ben的创建初始化工作,完成 IOC 容器的创建,发布容器刷新完成事件</a></li><li><a href="#10__Spring_refreshbean_1154" rel="nofollow">10. 概述 Spring 启动refresh()方法执行bean的状态流转过程</a></li><li><a href="#11_BeanBeanDefinition_1159" rel="nofollow">11. Bean的生产顺序是由什么决定的,BeanDefinition的注册顺序是由什么决定的</a></li><li><a href="#12_Spring_1169" rel="nofollow">12. 怎么给Spring做扩展</a></li><li><ul><li><a href="#Spring_IOC_1170" rel="nofollow">Spring IOC过程中有哪些扩展点</a></li><li><a href="#BeanDefinition_1178" rel="nofollow">如何在所有BeanDefinition注册完成后做扩展</a></li><li><a href="#bean_1180" rel="nofollow">如何在所有的bean创建完成后做扩展</a></li></ul> 
  </li></ul> 
  </li><li><a href="#__1184" rel="nofollow">四. 其它问题总结</a></li><li><ul><li><ul><li><a href="#1_BeanDefinitionRegistry_1185" rel="nofollow">1. BeanDefinitionRegistry的注册</a></li><li><a href="#2_Spring_bean_1195" rel="nofollow">2. Spring 实例化bean有几种方式</a></li><li><a href="#3_Spring_1202" rel="nofollow">3. Spring有哪几种配置方式</a></li><li><a href="#4_bean_1207" rel="nofollow">4. bean的配置方式</a></li><li><a href="#5_ComponentScanbasePackage_1223" rel="nofollow">5. @ComponentScan不设置basePackage为什么也会包扫描</a></li><li><a href="#6_javaConfigspringxml_1225" rel="nofollow">6. javaConfig如何代替spring.xml的</a></li><li><a href="#7_ComponentControllerRepositoryService_1230" rel="nofollow">7. @Component,@Controller,@Repository,@Service有什么区别</a></li><li><a href="#8_Import_1233" rel="nofollow">8. @Import有几种使用方式</a></li><li><a href="#9_Configuration_1239" rel="nofollow">9. @Configuration的作用及原理解析</a></li><li><a href="#10_Bean_1251" rel="nofollow">10. @Bean修饰的方法的调用是怎么保证单例的</a></li><li><a href="#11_Bean_1254" rel="nofollow">11. 如何将一个三方的类配置为Bean</a></li><li><a href="#12_bean_bean_1260" rel="nofollow">12. 什么是bean的装配, 什么是bean的自动装配</a></li><li><a href="#13_Spring_BeanFactoryPostProcess_1263" rel="nofollow">13. Spring 容器启动时为什么先加载BeanFactoryPostProcess</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="__1"></a>一. 前置知识学习</h2> 
<ol><li>参考博客</li></ol> 
<blockquote> 
 <ol><li><a href="https://blog.csdn.net/qq_29799655/article/details/105398225">Spring refresh() 方法详解(启动Spring,bean的创建过程) </a> Spring IOC 过程</li><li><a href="https://editor.csdn.net/md/?articleId=105309538" rel="nofollow">Spring Bean 源码解析初始化与销毁通,与循环依赖问题</a></li><li><a href="https://editor.csdn.net/md/?articleId=105387051" rel="nofollow">Spring 事件驱动模型开发 </a></li><li><a href="https://editor.csdn.net/md/?articleId=121490135" rel="nofollow">面试题整理. 七 Spring 相关 </a></li><li><a href="https://editor.csdn.net/md/?articleId=121873022" rel="nofollow">面试题整理. 九 SpringBoot/Cloud</a></li></ol> 
</blockquote> 
<h3><a id="Springbean_8"></a>Spring中对bean的分类</h3> 
<ol><li>Spring在服务启动时针对功能,创建顺序的不同等,对bean进行了分类,提出了</li></ol> 
<blockquote> 
 <ol><li>BeanDefinition: 存储了bean的定义信息,可以看为bean的描述,在创建bean对象时会先读取到该bean的定义信息转换为BeanDefinition,然后在合适的时机通过这个BeanDefinition创建出对应的bean</li><li>BeanDefinitionRegistry: 可以看为BeanDefinition管理器或者仓库管理了BeanDefinition</li><li>BeanFactory : bean工厂,用来管理bean的获取,创建,销毁等</li><li>BeanFactoryPostProcessor: bean工厂的后置处理器,内部有一个特殊的方法postProcessBeanFactory()</li><li>BeanPostProcessors: bean的后置处理器内部有两个特殊的方法,用来监听指定bean进行特殊处理</li><li>Aware: 一个能被Spring监听感知的标识接口,当判断是该类型时可以进行一些特殊处理</li></ol> 
</blockquote> 
<h4><a id="1_BeanDefinition_16"></a>1. BeanDefinition</h4> 
<ol><li>用来存储bean的定义信息,class的描述,在服务启动时将扫描到的class解析为BeanDefinition,后续会通过BeanDefinition创建对应的bean对象</li><li>项目启动时会先扫描获取到指定bean信息后,将解析到的bean的路径保存到BeanDefinition的class属性,bean的模式保存到scope属性属性中,bean属性的初始化值保存到property中…,最终将得到的BeanDefinition存储到beanDefinitionMap中</li><li>后续IOC注入的流程,创建BeanFactory,加载所有BeanDefinition,通过BeanFactory.getBean()–&gt;createBean()–&gt;通过beanName在beanDefinitionMap中获取到对应的BeanDefinition,拿到这个bean的class属性也就是路径,通过反射调用构造器创建…那么BeanDefinition是在哪一步读取进入的呢: 是在invokeDifinitionRegistryPostProcessor()</li><li>BeanDefinition是定义Bean的配置元信息的接口内部包含<br> <img src="https://images2.imgbox.com/83/5a/9mOWSqVz_o.png" alt="在这里插入图片描述"></li><li>BeanDefinition的继承关系: 继承了AttributeAccessor和BeanMetadataElement两个接口<br> <img src="https://images2.imgbox.com/fc/58/QmJsZUEB_o.png" alt="在这里插入图片描述"></li><li>RootBeanDefinition: 是 Spring BeanFactory 运行时统一的 BeanDefinition 视图,代表了一个 merged bean definition，是 Spring BeanFactory 在运行时支持的一个特殊的 bean,也就是Spring 在通过 BeanDefinition 创建 bean 的实例时，通常都会将 BeanDefinition 转化为 RootBeanDefinition 后，再进行 bean 实例的创建, 但是自 Spring 2.5 以来,以编程方式注册 bean 定义的首选方法是 GenericBeanDefinition ,优点是它允许动态定义父依赖项，而不是将角色“硬编码”为 RootBeanDefinition</li><li>GenericBeanDefinition: 以编程方式注册 BeanDefinition 的首选类,除了可以指定一些基本的 BeanDefinition 属性外，还可以通过“setParentName()”来灵活地配置 parent bean definition,基本上可以完全替代掉 ChildBeanDefinition</li><li>ChildBeanDefinition: 一种可以继承 parent 配置的 BeanDefinition,在创建 bean 时，会通过 AbstractBeanFactory#getMergedLocalBeanDefinition() 来将 child 和 parent bean definition 进行合并(Spring 2.5 之后，推荐通过 GenericBeanDefinition#setParentName() 的方式来替代 ChildBeanDefinition)</li><li>merged bean definition: 是 Spring 对 BeanDefinition 进行的一种合并操作,会将 child 的属性与 parent 的属性进行合并，当有相同属性时，以 child 的为准,什么时候会对 BeanDefinition 进行 merge 操作: AbstractBeanFactory#getMergedLocalBeanDefinition() 来进行 merge 操作</li></ol> 
<h4><a id="2_BeanFactoryPostProcess_28"></a>2. BeanFactoryPostProcess</h4> 
<ol><li>BeanFactoryPostProcessor 是一个接口,该接口中有一个 postProcessBeanFactory() 抽象方法,与 BeanPostProcessor 不同的的是:</li></ol> 
<blockquote> 
 <ol><li>BeanPostProcessor 是 bean 的后置处理器,监控 bean 的创建,在Bean的初始化前后,拦截执行 BeanPostProcessor 中的方法</li><li>BeanFactoryPostProcess 可以看为是更上一层的后置处理器,(可以理解为 BeanFactory 的后置处理器)当所有 bean 加载完成放入BeanFactory 后,但是还未创建时执行该接口中的方法</li></ol> 
</blockquote> 
<h4><a id="3_BeanDefinitionRegistryPostProcessor_32"></a>3. BeanDefinitionRegistryPostProcessor</h4> 
<ol><li>BeanFactoryPostProcess 如果细分的话,其下层还有继承于该接口的 BeanDefinitionRegistryPostProcessor,多了一个postProcessBeanDefinitionRegistry()方法,进而得知实现BeanDefinitionRegistryPostProcessor接口的类需要重新两个抽象方法</li></ol> 
<blockquote> 
 <ol><li>BeanFactoryPostProcess 中的 postProcessBeanFactory()</li><li>BeanDefinitionRegistryPostProcessor 中的 postProcessBeanDefinitionRegistry()</li></ol> 
</blockquote> 
<h4><a id="4_BeanPostProcessors__36"></a>4. BeanPostProcessors 后置处理器</h4> 
<ol><li>先了解一下BeanPostProcessor接口中的两个方法</li></ol> 
<blockquote> 
 <ol><li>postProcessBeforeInitialization(Object o, String s) 初始化 bean 之前需要执行的方法,</li><li>postProcessAfterInitialization(Object o, String s) 初始化bean之后需要执行的方法,</li><li>后续在创建bean 向容器中注入时首获取容器中所有存在的BeanPostProcessors对象,在初始化当前bean的前后执行这两个方法</li><li>这两个方法中都有两个参数 Object o, String s, o代表执行初始化的bean, s 代表这个 bean 在容器中的 id</li></ol> 
</blockquote> 
<ol start="2"><li>在向Spring中注入bean时会优先注入该类型的bean,后续Spring注入其它类型的bean时在初始化前后执行postProcessBeforeInitialization()与postProcessAfterInitialization()两个方法</li><li>还有一个后置处理器接口 InstantiationAwareBeanPostProcessor 该接口继承 BeanPostProcessor 接口, 比 BeanPostProcessor 接口中多了一个 postProcessBeforeInstantiation() 方法, 该方法是在,创建 bean 前执行的</li><li>那么BeanPostProcessors中的两个方法是在什么时候调用的:具体要了解Spring IOC的过程, 在启动Spring容器时会先创建BeanFactory, 创建BeanFactoryPostProcessor类型的bean对象,然后创建BeanPostProssor注入到容器中,最后再创建其它单实例bean,创建bean对象时会调用getBean(),getSingleton()方法,通过beanName在容器中获取,如果不存在,调用一个doCreateBean()方法创建,对象创建后执行populateBean()装配bean的依赖,然后执行initializeBean(), 查看initializeBean()内部,重点关注内部调用的四个方法</li></ol> 
<blockquote> 
 <ol><li>invokeAwareMethods() ,通过该方法,判断要初始化的bean 是否是某个Aware类型,通过执行接口中的setXX()方法(Aware,通常用来获取 Spring 提供的组件,通过重写的抽象方法赋值给当前初始化的 bean)</li><li>applyBeanPostProcessorsBeforeInitialization() 通过该方法获取容器中的BeanPostProcessor,执行初始化bean前需要执行的方法postProcessBeforeInitialization()</li><li>invokeInitMethods() 方法,通过该方法执行初始化方法(例如调用InitializingBean的afterPropertiesSet,调用自定义的init-method 等)</li><li>applyBeanPostProcessorsAfterInitialization() 通过该方法获取容器中的BeanPostProcessor,执行初始化bean后需要执行的方法postProcessAfterInitialization()</li></ol> 
</blockquote> 
<h4><a id="5_Aware__49"></a>5. Aware 接口</h4> 
<ol><li>Aware接口没有任何定义，仅仅是一个声明，起到一个标识的作用, 实现了Aware接口的类就会被Spring容器所感知。而具体需要感知什么内容需要具体的子接口去定义, 每个Aware接口的子接口，内部都需要有一个set方法，将本身设置进去，这样实现了该接口的类就可以获取到该对象了</li><li>以BeanFactoryAware接口为例: BeanFactoryAware接口中有setBeanFactroy(BeanFactroy beanFactory)方法,子类实现了之后,可以得到beanFactory对象了。同理实现了XXXAware接口，就可以得到XXX这个对象</li><li>Spring中提供的实现了Aware接口的子类</li></ol> 
<blockquote> 
 <ol><li>BeanFactoryAware接口（获取BeanFactory对象）</li><li>ApplicatioContextAware接口（获取ApplicationContext对象）</li><li>BeanNameAware接口（获取当前bean的beanName）</li><li>ApplicationEventPublisherAware接口（获取容器中事件发布器,可以用于发布事件）</li><li>ResourceLoaderAware接口（获取资源加载器，用于获取外部资源文件）</li><li>…</li></ol> 
</blockquote> 
<h4><a id="6_BeanFactory__ApplicationContext_59"></a>6. BeanFactory 与 ApplicationContext有什么区别</h4> 
<ol><li>ApplicationContext 实现了BeanFactory 接口,并重写了getBean()方法, 在重写方法中实际是先getBeanFactory()获取到BeanFactory,然后通过BeanFactory再去getBean()的,ApplicationContext 不会去创建bean,而是获取BeanFactory通过BeanFactory去创建,ApplicationContext 功能更多例如加载环境变量,实现事件监听,注册其它扩展点等等</li></ol> 
<h4><a id="7_BeanFactory__FactoryBean__61"></a>7. BeanFactory 与 FactoryBean 有什么区别</h4> 
<ol><li>BeanFactory 是一个Bean工厂用来管理和生产bean的</li></ol> 
<blockquote> 
 <p>Spring启动时执行obtainFreshBeanFactory()首先会创建BeanFactory, 默认情况下会创建一个 DefaultListableBeanFactory类型的 bean工厂赋值给 beanFactory 属性,然后再创建其它bean,管理了bean的生产,初始化,销毁生命周期</p> 
</blockquote> 
<ol start="2"><li>而FactoryBean 是一个接口,必须被一个bean来实现,被BeanFactory管理,但不是一个普通的bean,可以看为是一个工厂方法模式,内部有一个getObject()方法,用来获取FactoryBean生产的对象,也就是说继承FactoryBean接口的bean,当获取该bean时,并不是通过构造器返回的,底层实际会执行重写的getObject()方法,通过该方法返回一个实例,继承FactoryBean的bean是懒加载,如果想要返回实际的可以通过"&amp;"符去获取原实例,<br> <img src="https://images2.imgbox.com/86/68/sLpfzRwR_o.png" alt="在这里插入图片描述"></li></ol> 
<h4><a id="8_Springbean_66"></a>8. 重点:预习Spring中创建不同类型bean的先后顺序</h4> 
<ol><li>Spring启动时会调用run方法,在run方法中首先会创建ApplicationContext上下文,执行refresh()方法创建bean,先简述一下内部流程</li></ol> 
<blockquote> 
 <ol><li>首先Spring启动时会扫描获取的bean的定义信息,比如class文件,xml文件等,将获取到的bean信息封装为BeanDefinition</li><li>创建BeanDefinitionRegistry也就是用来管理BeanDefinition的仓库,创建BeanFactory用来管理bean的工厂</li><li>接着开始实例化bean</li><li>先获取BeanFactoryPostProcessor工厂后置处理器类型的bean调用它的postProcessBeanFactory()方法,或者获取实际类型是BeanFactoryPostProcessor的BeanDefinition,进行初始化创建,然后执行postProcessBeanFactory()方法</li><li>接着获取BeanPostProcessors后置处理器类型的BeanDefinition优先将该类型的bean初始化创建</li><li>初始化事件派发器,多播器ApplicationEventMulticaster</li><li>注册监听器ApplicationListener</li><li>完成ben的创建初始化工作,完成 IOC 容器的创建,发布容器刷新完成事件</li><li>最后再创建其它单利bean,在创建初始化前后会被BeanPostProcessors监控到,对指定类型的bean进行一些特殊处理</li></ol> 
</blockquote> 
<ol start="2"><li>先后顺序为: run()方法启动—&gt;ApplicationContext创建上下文—&gt;创建BeanDefinition 注解解析器AnnotatedBeanDefinitionReader—&gt;BeanDefinition扫描器ClassPathBeanDefinitionScanner----&gt;创建BeanDefinitionRegistry—&gt;BeanFactory—&gt;BeanDefinition xml解析器 XmlBeanDefinitionReade—&gt;基于BeanDefinition注解解析器,扫描器,xml解析器扫描bean资源将bean转换为BeanDefinition—&gt;创建BeanFactoryPostProcessor—&gt;BeanPostProcessors—&gt;创建ApplicationEventMulticaster事件派发器多播器—&gt;注册监听器ApplicationListener—&gt;其它单实例bean—&gt;完成ben的创建初始化工作,完成 IOC 容器的创建,发布容器刷新完成事件</li></ol> 
<h2><a id="_SpringBootrunApplicationContextBeanDefinitionAnnotatedBeanDefinitionReaderClassPathBeanDefinitionClassPathBeanDefinitionScanner_78"></a>二. 由SpringBoot启动run()源码引出ApplicationContext上线文的创建与基于注解的BeanDefinition读取器AnnotatedBeanDefinitionReader和基于ClassPath路径下的BeanDefinition扫描器ClassPathBeanDefinitionScanner</h2> 
<ol><li>首先要了解几个问题,Spring支持</li></ol> 
<blockquote> 
 <ol><li>基于XML配置</li><li>Spring2.5+提出, 基于注解例如配置中使用&lt; component-scan&gt; 开启包扫描,基于包扫描,与注解进行注入</li><li>在Spring3.0后又提出基于javaConfig配置方式,可以使用:@Configuration, @Bean,@PropertySource, @Value, @ComponentScan</li></ol> 
</blockquote> 
<ol start="2"><li>通过问题引出底层源码</li></ol> 
<blockquote> 
 <ol><li>基于什么实现XML配置: 针对解析xml提供了BeanDefinition xml解析器 XmlBeanDefinitionReade</li><li>包扫描装配是怎么实现的: 针对包扫描提供了BeanDefinition 扫描器 ClassPathBeanDefinitionScanner</li><li>注解装配是怎么实现的: 针对javaConfig注解方式提供了基于注解的BeanDefinition解析器AnnotatedBeanDefinitionReader</li></ol> 
</blockquote> 
<ol start="3"><li>接下来就要找到AnnotatedBeanDefinitionReader, ClassPathBeanDefinitionScanner,XmlBeanDefinitionReade是什么时候创建的</li><li>SpringBoot启动代码示例,启动SpringBoot项目需要调用SpringApplication的run()方法</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestActuatorApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TestActuatorApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>查看run方法底层,会调用多个重载的run方法</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> primarySource<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>primarySource<span class="token punctuation">}</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> primarySources<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span>primarySources<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span>… args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
		<span class="token comment">// 创建一个计时器，用于记录启动时间 </span>
		<span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 开始计时 stopWatch.start(); </span>
		<span class="token comment">// 声明一个可配置的应用上下文对象，用于返回 </span>
		<span class="token class-name">ConfigurableApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
		<span class="token comment">// 声明一个异常报告器的集合，用于处理启动过程中的异常 </span>
		<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpringBootExceptionReporter</span><span class="token punctuation">&gt;</span></span> exceptionReporters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token comment">// 配置 headless 属性，用于判断是否是无头模式（没有显示器、键盘或鼠标的系统） </span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">configureHeadlessProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token comment">// 获取 SpringApplicationRunListener 的实例，用于监听启动过程中的事件 </span>
		<span class="token class-name">SpringApplicationRunListeners</span> listeners <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRunListeners</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token comment">// 通知所有的监听器，应用正在启动 </span>
		listeners<span class="token punctuation">.</span><span class="token function">starting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Collection</span> exceptionReporters<span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    		<span class="token comment">// 创建一个应用参数对象，用于封装命令行参数</span>
    		<span class="token class-name">ApplicationArguments</span> applicationArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultApplicationArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token comment">// 准备环境对象，用于配置应用运行时的环境变量</span>
    		<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareEnvironment</span><span class="token punctuation">(</span>listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token comment">// 配置是否忽略 BeanInfo 的属性信息，以提高性能</span>
    		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">configureIgnoreBeanInfo</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token comment">// 打印 banner 图案，如果有的话</span>
    		<span class="token class-name">Banner</span> printedBanner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">printBanner</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token comment">// TODO 重点:创建应用上下文对象，根据不同的 web 类型选择不同的实现类</span>
    		context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token comment">// 获取 SpringBootExceptionReporter 的实例，用于处理启动过程中的异常</span>
    		exceptionReporters <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span><span class="token class-name">SpringBootExceptionReporter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 准备应用上下文对象，设置环境、注册监听器、加载源等操作</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">,</span> printedBanner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 刷新应用上下文对象，加载 bean 定义并实例化 bean</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refreshContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 在刷新后执行一些操作，例如注册关闭钩子等</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">afterRefresh</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 停止计时器</span>
    	stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 如果启用了日志打印，打印启动信息和耗时</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logStartupInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StartupInfoLogger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mainApplicationClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logStarted</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getApplicationLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stopWatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>

    	<span class="token comment">// 通知所有的监听器，应用已经启动完成</span>
    	listeners<span class="token punctuation">.</span><span class="token function">started</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 调用 ApplicationRunner 和 CommandLineRunner 的实例，执行自定义逻辑</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callRunners</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var10<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 如果出现异常，处理启动失败的情况，销毁上下文，通知监听器，并抛出异常</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRunFailure</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> var10<span class="token punctuation">,</span> exceptionReporters<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>var10<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 通知所有的监听器，应用正在运行中</span>
    	listeners<span class="token punctuation">.</span><span class="token function">running</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 返回应用上下文对象</span>
    	<span class="token keyword">return</span> context<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var9<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 如果出现异常，处理运行失败的情况，并抛出异常</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRunFailure</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> var9<span class="token punctuation">,</span> exceptionReporters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">SpringApplicationRunListeners</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>var9<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>在最底层调用的run()方法内部,重点关注调用了一个createApplicationContext()方法,根据不同的 web 类型设置不同的上下文的地址,使用反射创建不同的ApplicationContext上下文对象</li></ol> 
<blockquote> 
 <ol><li>NONE 表示普通的 JAVA 程序，不涉及 web 容器,默认情况下创建AnnotationConfigApplicationContext</li><li>SERVLET 表示使用 servlet 作为 web 容器，一般使用的就是这种类型,该类型时创建AnnotationConfigServletWebServerApplicationContext上下文</li><li>REACTIVE 是在 Spring 5 之后新增的一种应用类型，也是一种 web 框架，但并不是基于 servlet，而是基于 reactive,该类型时创建AnnotationConfigReactiveWebServerApplicationContext上下文</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> contextClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContextClass<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>contextClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token constant">SERVLET</span><span class="token operator">:</span>
                    contextClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">REACTIVE</span><span class="token operator">:</span>
                    contextClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"org.springframework.boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    contextClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"org.springframework.context.annotation.AnnotationConfigApplicationContext"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unable create a default ApplicationContext, please specify an ApplicationContextClass"</span><span class="token punctuation">,</span> var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">)</span><span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>contextClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="7"><li>以上几种ApplicationContext上下文的基本介绍:</li></ol> 
<blockquote> 
 <ol><li>AnnotationConfigServletWebServerApplicationContext：这个上下文是用于基于Servlet的web应用程序的，它继承自WebApplicationContext接口，可以支持web相关的功能，如ServletContext、ServletConfig等。它也可以使用注解来配置bean定义，而不需要XML文件</li><li>AnnotationConfigReactiveWebServerApplicationContext：这个上下文是用于基于Reactive的web应用程序的，它继承自ReactiveWebApplicationContext接口，可以支持Reactive相关的功能，如WebFlux、Netty等。它也可以使用注解来配置bean定义，而不需要XML文件</li><li>AnnotationConfigApplicationContext：这个上下文是用于非web应用程序的，它继承自GenericApplicationContext接口，可以支持一般的功能，如事件发布、资源加载等。它也可以使用注解来配置bean定义，而不需要XML文件</li></ol> 
</blockquote> 
<ol start="8"><li>查看以上几种ApplicationContext上下文对象的构造器,发现以上几种上下文对象的构造器中都初始化了基于注解的BeanDefinition读取器AnnotatedBeanDefinitionReader,基于ClassPath路径下的BeanDefinition扫描器ClassPathBeanDefinitionScanner</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//基于注解的BeanDefinition读取器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//基于ClassPath路径下的BeanDefinition扫描器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="1_AnnotatedBeanDefinitionReaderBeanFactoryPostProcessorBeanPostProcessor_210"></a>1. AnnotatedBeanDefinitionReader引出一系列BeanFactoryPostProcessor,BeanPostProcessor的注册</h3> 
<ol><li>问题AnnotatedBeanDefinitionReader 是怎么获取被注解修饰的bean进行解析创建的,这里就要了解BeanPostProcessor</li><li>继续查看创建BeanDefinition注解解析器AnnotatedBeanDefinitionReader的构造函数</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token function">getOrCreateEnvironment</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
		<span class="token comment">// 创建一个注解bean名称生成器，用于根据注解生成bean的名称 </span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationBeanNameGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token comment">// 创建一个注解作用域元数据解析器，用于根据注解解析bean的作用域 </span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationScopeMetadataResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token comment">// 断言注册表和环境对象不能为空，否则抛出异常 </span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> “<span class="token class-name">BeanDefinitionRegistry</span> must not be <span class="token keyword">null</span>”<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> “<span class="token class-name">Environment</span> must not be <span class="token keyword">null</span>”<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token comment">// 保存注册表和条件评估器对象，用于后续操作，ConditionEvaluator用于解析 Condition 相关注解</span>
		<span class="token comment">//在注册 BeanDefinition 之前，会根据其 @Conditional 注解的条件进行过滤</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConditionEvaluator</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token comment">//注册一些注解配置处理器到注册表中，</span>
		<span class="token comment">//用于处理@Configuration、@ComponentScan、@Import、@ImportResource等注解 </span>
		<span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>在BeanDefinition注解解析器AnnotatedBeanDefinitionReader的构造函数中,首先重点关注调用的AnnotationConfigUtils的registerAnnotationConfigProcessors()方法,通过该方法会优先创建一系列BeanPostProcessor的BeanDefinition,保存到beanDefs一个set集合中,例如:</li></ol> 
<blockquote> 
 <ol><li>ConfigurationClassPostProcessor: 非常重要下方有解释</li><li>AutowiredAnnotationBeanPostProcessor: 用来支持 @Autowired @Value 等注解的解析</li><li>CommonAnnotationBeanPostProcessor: 引入 了JSR-250 相关依赖，可以处理@PostConstruct和@PreDestroy还有@Resource等</li><li>PersistenceAnnotationBeanPostProcessor: 引入了 JPA 相关依赖且不存在对应 BeanDefinition 则注册，支持 JPA 相关后处理</li><li>EventListenerMethodProcessor:负责对 @EventListener 注解标注的方法进行处理</li><li>DefaultEventListenerFactory: 主要由 EventListenerMethodProcessor 使用，用来基于 @EventListener 注解标注的方法获取对应 ApplicationListener</li></ol> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="token operator">=</span> <span class="token string">"org.springframework.context.annotation.internalConfigurationAnnotationProcessor"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIGURATION_BEAN_NAME_GENERATOR</span> <span class="token operator">=</span> <span class="token string">"org.springframework.context.annotation.internalConfigurationBeanNameGenerator"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="token operator">=</span> <span class="token string">"org.springframework.context.annotation.internalAutowiredAnnotationProcessor"</span><span class="token punctuation">;</span>
    <span class="token comment">/** @deprecated */</span>
    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="token operator">=</span> <span class="token string">"org.springframework.context.annotation.internalRequiredAnnotationProcessor"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="token operator">=</span> <span class="token string">"org.springframework.context.annotation.internalCommonAnnotationProcessor"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="token operator">=</span> <span class="token string">"org.springframework.context.annotation.internalPersistenceAnnotationProcessor"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span> <span class="token operator">=</span> <span class="token string">"org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span> <span class="token operator">=</span> <span class="token string">"org.springframework.context.event.internalEventListenerProcessor"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EVENT_LISTENER_FACTORY_BEAN_NAME</span> <span class="token operator">=</span> <span class="token string">"org.springframework.context.event.internalEventListenerFactory"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> jsr250Present<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> jpaPresent<span class="token punctuation">;</span>


	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span>
            <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> source<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">DefaultListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">unwrapDefaultListableBeanFactory</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getDependencyComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//注册了实现Order接口的排序器,后续会通过它实现解析@Order和@Priority</span>
                beanFactory<span class="token punctuation">.</span><span class="token function">setDependencyComparator</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//设置@AutoWired的候选的解析器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ContextAnnotationAutowireCandidateResolver</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//ContextAnnotationAutowireCandidateResolver提供处理延迟加载的功能</span>
                beanFactory<span class="token punctuation">.</span><span class="token function">setAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextAnnotationAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//注册解析我们配置类的后置处理器ConfigurationClassPostProcessor</span>
        <span class="token comment">//org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClassPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

         <span class="token comment">//注册处理@Autowired 注解的处理器AutowiredAnnotationBeanPostProcessor</span>
         <span class="token comment">//org.springframework.context.annotation.internalAutowiredAnnotationProcessor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">AutowiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

         <span class="token comment">//注册处理@Required属性的注解处理器RequiredAnnotationBeanPostProcessor</span>
         <span class="token comment">// org.springframework.context.annotation.internalRequiredAnnotationProcessor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">RequiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

         <span class="token comment">//注册处理JSR规范的注解处理器CommonAnnotationBeanPostProcessor</span>
         <span class="token comment">//org.springframework.context.annotation.internalCommonAnnotationProcessor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jsr250Present <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">CommonAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//处理jpa注解的处理器org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jpaPresent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                def<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="token punctuation">,</span>
                        <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                        <span class="token string">"Cannot load optional framework class: "</span> <span class="token operator">+</span> <span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//处理监听方法的注解解析器EventListenerMethodProcessor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">EventListenerMethodProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//注册事件监听器工厂</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">DefaultEventListenerFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> beanDefs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>其中ConfigurationClassPostProcessor间接继承了BeanFactoryPostProcessor后置处理器非常重要,会处理不管是手动注册还是扫描机制所有<strong>BeanDefinition中符合注解条件的BeanDefinition</strong>，过滤出带有相关注解的BeanDefinition包括(@Configuration、@Component、@ComponentScan、@Import、@ImportResource或者@Bean)进行进一步处理</li><li>ConfigurationClassPostProcessor到底怎么解析@Bean, @Import, @ComponentScan, @Component…修饰的bean到beanDefinitionMap的,ConfigurationClassPostProcessor是一个后置处理器,在processConfigBeanDefinitions()方法中遍历容器的beanDefinition集合,通过ConfigurationClassUtils工具类找到配置类beanDefinition,将其放入configCandidates集合中,创建<strong>ConfigurationClassParser</strong>对象，调用对象的parse方法最终会调用doProcessConfigurationClass()方法,扫描对应的注解,进行解析<a href="https://blog.csdn.net/weixin_37607613/article/details/126228867">参考博客1</a>，<a href="https://blog.csdn.net/yu_kang/article/details/88205458">参考博客2</a></li><li>那ConfigurationClassParser怎么扫描的,以 @ComponentScan 为例Spring提供了ClassPathBeanDefinitionSacnner通过该类下的doScan()方法扫描,根据包路径找到所有的.class文件,判断类是不是标准的@Component注解,判断是不是接口,是不是抽象类…</li><li>前面说过Spring将bean分成了不同类型,根据这个类型使其在创建时保证一定的先后顺序,上方先一步将BeanPostProcessor转换为BeanDefinition,根据BeanDefinition注册时间的不同,bean的创建顺序也不同,自此这些带功能的bean会先一步创建注入到容器中,在后续创建其它bean时,就可以通过这些bean感知到,进行特殊处理</li></ol> 
<h3><a id="2_ClassPathBeanDefinitionScannerbean_347"></a>2. ClassPathBeanDefinitionScanner扫描bean</h3> 
<ol><li>在创建ApplicationContext上下文时查看构造器,内部会创建一个ClassPathBeanDefinitionScanner对象,在Spring 2.5提供的"&lt;context:component-scan base-package=“com.x.y”&gt;&lt;/context:component-scan&gt;"包扫描就是通过它实现的,一个BefanDefinition扫描器,检测classpath上的bean,判断bean上是否存在指定的@Component(包含@Repository，@Service或@Controller)注解也会扫描JSR-250 的 @ManagedBean 和 JSR-330 的 @Named ,注册响应的BefanDefinition</li><li>ConfigurationClassParser怎么扫描的,重点依赖与该类中的scan(), doScan()方法,在Spring启动时有多个位置调用这个方法(注意此时支持创建出来,调用是在下面几个方法中执行的)</li></ol> 
<blockquote> 
 <ol><li>Spring启动refresh()内部postProcessBeanFactory()中会调用</li><li>refresh()启动refresh()内部invokeBeanFactoryPostProcessors()中会调用</li><li>使用@ComponentScan注解时,这个注解使用几次doScan()就会调用几次</li></ol> 
</blockquote> 
<ol start="3"><li>调用doScan()扫描加载依赖组件的初始化以及将BeanDefinition注册到registry,内部重点:</li></ol> 
<blockquote> 
 <ol><li>调用findCandidateComponents()方法扫描bean,创建BeanDefinition(调用了大量的父类中的方法)</li><li>调用registerBeanDefinition()–&gt;最终会调用到DefaultListableBeanFactory下的registerBeanDefinition()方法注册BeanDefinition,也就是将创建好的BeanDefinition保存到DefaultListableBeanFactory的beanDefinitionMap中</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span> <span class="token keyword">extends</span> <span class="token class-name">ClassPathScanningCandidateComponentProvider</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//bean定义的注册器接口，用于注册BeanDefinition</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">BeanDefinitionDefaults</span> beanDefinitionDefaults <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> autowireCandidatePatterns<span class="token punctuation">;</span>

    <span class="token comment">// bean的名称生成器</span>
    <span class="token keyword">private</span> <span class="token class-name">BeanNameGenerator</span> beanNameGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationBeanNameGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ScopeMetadataResolver</span> scopeMetadataResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationScopeMetadataResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> includeAnnotationConfig <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">//构造函数，创建ClassPathBeanDefinitionScanner扫描器，同时根据参数设置filter以及resourceLoader</span>
    <span class="token keyword">public</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useDefaultFilters<span class="token punctuation">,</span>
            <span class="token class-name">Environment</span> environment<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>useDefaultFilters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">//设置Filter</span>
            <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//设置environment</span>
        <span class="token function">setEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置resourceLoader</span>
        <span class="token function">setResourceLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//扫描给定的包路径，生成BeanDefinition并注册到注册器</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取注册器中已注册的bean数量</span>
        <span class="token keyword">int</span> beanCountAtScanStart <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通过doScan给定包路径并生成BeanDefinition注册到registry中</span>
        <span class="token function">doScan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>includeAnnotationConfig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//如果includeAnnotationConfig属性为true，就注册一些注解配置处理器到注册表中，</span>
        	<span class="token comment">//用于处理@Configuration、@ComponentScan、@Import、@ImportResource等注解</span>
            <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//返回扫描后与扫描前的bean定义数量之差，即新增的数量</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beanCountAtScanStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//扫描给定的包路径，生成BeanDefinition并注册到注册器</span>
    <span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//遍历给定扫描的包</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> basePackage <span class="token operator">:</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 调用findCandidateComponents扫描包组装BeanDefinition集合</span>
           <span class="token comment">//findCandidateComponents方法为父类方法</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//遍历BeanDefinition，根据条件将BeanDefinition注册到注册中心</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//调用scopeMetadataResolver解析Bean定义的作用域元数据</span>
                <span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//设置Bean定义的作用域</span>
                candidate<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//调用beanNameGenerator生成Bean定义的名称</span>
                <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果Bean定义是AbstractBeanDefinition的子类，那么进行后处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">postProcessBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//如果Bean定义是AnnotatedBeanDefinition的子类，那么处理一些通用的注解</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//检查是否有同名的Bean定义已经存在，如果没有，那么继续注册</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">//创建一个Bean定义持有者对象，包含了Bean定义和名称</span>
                    <span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//根据作用域元数据，应用代理模式，可能会修改持有者对象</span>
                    definitionHolder <span class="token operator">=</span><span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将持有者对象添加到集合中</span>
                    beanDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//调用registerBeanDefinition方法，将持有者对象注册到BeanFactory中</span>
                    <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="findCandidateComponentsclassBeanDefinition_444"></a>findCandidateComponents()将扫描到的class转换为转换为BeanDefinition</h4> 
<ol><li>doScan()方法中会调用了findCandidateComponents()这个方法是ClassPathBeanDefinitionScanner父类ClassPathScanningCandidateComponentProvider的,查看父类源码, 重点关注:</li></ol> 
<blockquote> 
 <ol><li>findCandidateComponents(): 该方法内会继续调用scanCandidateComponents()根据basePackage地址,扫描对应的class文件,</li><li>scanCandidateComponents()方法内遍历根据basePackage扫描到的资源,通过getMetadataReader()读取到 metadataReader 也就是当前class的元数据(包括类的地址,类上的注解…等信息),然后创建ScannedGenericBeanDefinition对象,这个就是创建对应的BeanDefinition,最终将BeanDefinition保存到candidates一个Set集合中</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassPathScanningCandidateComponentProvider</span> <span class="token keyword">implements</span> <span class="token class-name">EnvironmentCapable</span><span class="token punctuation">,</span> <span class="token class-name">ResourceLoaderAware</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//默认的资源匹配后缀</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_RESOURCE_PATTERN</span> <span class="token operator">=</span> <span class="token string">"**/*.class"</span><span class="token punctuation">;</span>
    <span class="token comment">//资源匹配后缀信息</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> resourcePattern <span class="token operator">=</span> <span class="token constant">DEFAULT_RESOURCE_PATTERN</span><span class="token punctuation">;</span>
    <span class="token comment">// bean定义包含过滤器，用户过滤查找到的类</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeFilter</span><span class="token punctuation">&gt;</span></span> includeFilters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// bean定义剔除过滤器，用户过滤查找到的类</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeFilter</span><span class="token punctuation">&gt;</span></span> excludeFilters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">Environment</span> environment<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">ConditionEvaluator</span> conditionEvaluator<span class="token punctuation">;</span>

    <span class="token comment">//资源路径匹配转换资源的转换器，通过资源匹配字符串在classpath查找匹配到class并将其转换为resource </span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">ResourcePatternResolver</span> resourcePatternResolver<span class="token punctuation">;</span>

    <span class="token comment">//元数据读取器创建工厂，用于创建元数据的读取器</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">MetadataReaderFactory</span> metadataReaderFactory<span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">CandidateComponentsIndex</span> componentsIndex<span class="token punctuation">;</span>

    <span class="token comment">//添加包含过滤器</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addIncludeFilter</span><span class="token punctuation">(</span><span class="token class-name">TypeFilter</span> includeFilter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>includeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//添加剔除过滤器</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addExcludeFilter</span><span class="token punctuation">(</span><span class="token class-name">TypeFilter</span> excludeFilter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>excludeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> excludeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//重置过滤器</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resetFilters</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> useDefaultFilters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>excludeFilters<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>useDefaultFilters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//注册默认的过滤器</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//添加对Component注解匹配的过滤器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">ClassPathScanningCandidateComponentProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 添加对javax.annotation.ManagedBean注解匹配的过滤器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"javax.annotation.ManagedBean"</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 添加对javax.inject.Named注解匹配的过滤器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"javax.inject.Named"</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// JSR-330 API not available - simply skip.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
	<span class="token comment">//获取资源路径匹配转换资源的转换器，默认为PathMatchingResourcePatternResolver</span>
    <span class="token keyword">private</span> <span class="token class-name">ResourcePatternResolver</span> <span class="token function">getResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePatternResolver <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePatternResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePatternResolver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取元数据读取器创建工厂，默认为CachingMetadataReaderFactory</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">MetadataReaderFactory</span> <span class="token function">getMetadataReaderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CachingMetadataReaderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//扫描bean,转换为BeanDefinition</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePackage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//是否有META-INF/spring.components文件，有的话去读取其中的文件进行bean注册</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentsIndex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">indexSupportsIncludeFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token function">addCandidateComponentsFromIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentsIndex<span class="token punctuation">,</span> basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//得到带有beanClass属性的beanDefination</span>
			<span class="token keyword">return</span> <span class="token function">scanCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

    <span class="token comment">//扫描包将扫描到的class生成BeanDefinition集合</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">scanCandidateComponents</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePackage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//根据包名组装包扫描路径</span>
            <span class="token class-name">String</span> packageSearchPath <span class="token operator">=</span> <span class="token class-name">ResourcePatternResolver</span><span class="token punctuation">.</span><span class="token constant">CLASSPATH_ALL_URL_PREFIX</span> <span class="token operator">+</span>
                    <span class="token function">resolveBasePackage</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token char">'/'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePattern<span class="token punctuation">;</span>
                    
            <span class="token comment">// 通过资源路径匹配转换资源的转换器 生成资源（class类）数组</span>
            <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token punctuation">]</span> resources <span class="token operator">=</span> <span class="token function">getResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>packageSearchPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//遍历资源（class）</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Resource</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//通过元数据读取器工厂，根据资源生成元数据读取器。</span>
                        <span class="token comment">// 此处通过asm将class文件读取成元数据模型</span>
                        <span class="token class-name">MetadataReader</span> metadataReader <span class="token operator">=</span> <span class="token function">getMetadataReaderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetadataReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//判断元数据是否需要组装成BeanDefinition</span>
                        <span class="token comment">// 此处判断当前class是否需要注册到spring的IOC容器中，通过IOC容器管理。</span>
                    	<span class="token comment">//spring默认对Component注解的类进行动态注册到IOC容器</span>
                    	<span class="token comment">// 通过includeFilters与excludeFilters来判定匹配。</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCandidateComponent</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                           <span class="token comment">//创建BeanDefinition</span>
                          <span class="token class-name">ScannedGenericBeanDefinition</span> sbd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScannedGenericBeanDefinition</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sbd<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sbd<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCandidateComponent</span><span class="token punctuation">(</span>sbd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                               <span class="token comment">//添加到集合中</span>
                                candidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> candidates<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//通过过滤器判断给定的元数据是否需要组装生成BeanDefinition，spring默认对classpath中的</span>
    <span class="token comment">// Component，javax.inject.Named，javax.annotation.ManagedBean注解注解的类组装生成BeanDefinition</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isCandidateComponent</span><span class="token punctuation">(</span><span class="token class-name">MetadataReader</span> metadataReader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//当元数据通过剔除过滤器时返回false</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TypeFilter</span> tf <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>excludeFilters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tf<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">,</span> <span class="token function">getMetadataReaderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//当元数据通过包含过滤器时返回true</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TypeFilter</span> tf <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tf<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">,</span> <span class="token function">getMetadataReaderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">isConditionMatch</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="registerBeanDefinition__BeanDefinition__BeanFactory__612"></a>registerBeanDefinition() 注册 BeanDefinition 到 BeanFactory 中</h4> 
<ol><li>在doScan()中先调用了findCandidateComponents()方法,根据basePackages地址扫描class文件,将class转换成了BeanDefinition, 代码继续向下执行会调用registerBeanDefinition(),最终实现BeanDefinition的注册,也就是将BeanDefinition保存到DefaultListableBeanFactory的beanDefinitionMap中,查看源码</li><li>doScan()中调用当前类中的registerBeanDefinition()方法–&gt;调用BeanDefinitionReaderUtils下的registerBeanDefinition()静态方法, 在该方法中会获取到工厂默认情况下是DefaultListableBeanFactory然后执行工厂的registerBeanDefinition()方法实现注册</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> definitionHolder<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//BeanDefinitionReaderUtils下的registerBeanDefinition()方法,不是一个版本</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> definitionHolder<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> beanName <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//默认调用DefaultListableBeanFactory 工厂上的registerBeanDefinition()方法实现注册</span>
        registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var4 <span class="token operator">=</span> aliases<span class="token punctuation">;</span>
            <span class="token keyword">int</span> var5 <span class="token operator">=</span> aliases<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> var6 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> var6 <span class="token operator">&lt;</span> var5<span class="token punctuation">;</span> <span class="token operator">++</span>var6<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> alias <span class="token operator">=</span> var4<span class="token punctuation">[</span>var6<span class="token punctuation">]</span><span class="token punctuation">;</span>
                registry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>查看DefaultListableBeanFactory下的registerBeanDefinition()方法</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Bean name must not be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> <span class="token string">"BeanDefinition must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span>beanDefinition<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> var9<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Validation of bean definition failed"</span><span class="token punctuation">,</span> var9<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">BeanDefinition</span> existingDefinition <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingDefinition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionOverrideException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">,</span> existingDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>existingDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> beanDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Overriding user-defined bean definition for bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' with a framework-generated bean definition: replacing ["</span> <span class="token operator">+</span> existingDefinition <span class="token operator">+</span> <span class="token string">"] with ["</span> <span class="token operator">+</span> beanDefinition <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanDefinition<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>existingDefinition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Overriding bean definition for bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' with a different definition: replacing ["</span> <span class="token operator">+</span> existingDefinition <span class="token operator">+</span> <span class="token string">"] with ["</span> <span class="token operator">+</span> beanDefinition <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Overriding bean definition for bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' with an equivalent definition: replacing ["</span> <span class="token operator">+</span> existingDefinition <span class="token operator">+</span> <span class="token string">"] with ["</span> <span class="token operator">+</span> beanDefinition <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasBeanCreationStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updatedDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    updatedDefinitions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    updatedDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames <span class="token operator">=</span> updatedDefinitions<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updatedSingletons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        updatedSingletons<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames <span class="token operator">=</span> updatedSingletons<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>frozenBeanDefinitionNames <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingDefinition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_refreshBeanFactoryBeanFactoryPostProcessorBeanPostProcessorbean_699"></a>三. refresh()方法执行到BeanFactory的创建—&gt;BeanFactoryPostProcessor—&gt;BeanPostProcessor—&gt;其它单利bean的创建</h2> 
<ol><li>通过上面启动项目的run()方法源码我们了解到在启动服务创建ApplicationContext时</li></ol> 
<blockquote> 
 <ol><li>初始化创建了用于解析注解的BeanDefinition解析器AnnotatedBeanDefinitionReader,并且通创建这个解析器是构造器内部调用了AnnotationConfigUtils的registerAnnotationConfigProcessors()注册了一系列的BeanPostProcessor</li><li>初始化创建了BeanDefinition 扫描器 ClassPathBeanDefinitionScanne,后续会在多个位置执行该类中的doScan()方法,根据basePackage路径扫描指定的class,调用findCandidateComponents()将扫描到的class资源封装为ScannedGenericBeanDefinition也就是转换为BeanDefinition, 然后调用registerBeanDefinition() 注册 BeanDefinition 到 BeanFactory 中也就是将BeanDefinition保存到DefaultListableBeanFactory的beanDefinitionMap中</li></ol> 
</blockquote> 
<ol start="2"><li>问题:</li></ol> 
<blockquote> 
 <ol><li>BeanDefinition 最终要注册到BeanFactory中,BeanFactory是怎么创建的</li><li>AnnotatedBeanDefinitionReader是针对注解的BeanDefinition解析器,ClassPathBeanDefinitionScanne是针对包扫描的BeanDefinition扫描器,那xml配置的bean是怎么处理的</li><li>在创建AnnotatedBeanDefinitionReader时创建一系列的BeanFactoryPostProcessor,BeanPostProcessor,这些后置处理器是如何执行的</li><li>在项目启动过程中会多次执行 ClassPathBeanDefinitionScanne扫描器中的doScan()方法,扫描指定的class进行注册,是在哪发起执行的</li></ol> 
</blockquote> 
<ol start="3"><li>接下来跟着源码解答一下上面的问题,下方只针对上面的问题,其它的就先不做解释了</li></ol> 
<h3><a id="1_refreshbeanbean_709"></a>1. refresh()创建bean工厂,加载并实例化bean方法概述</h3> 
<ol><li>先看一下项目启动时如何执行到refresh()这个方法的,在run方法中先创建ApplicationContext,创建完毕后会调用refreshContext(context),内部会调用refresh方法</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refreshContext</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//刷新应用上下文对象，加载 bean 定义并实例化 bean,会继续向下调用refresh内部的refresh()</span>
		<span class="token comment">//下方示例中就省略了直接到我们最终的refresh()</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registerShutdownHook<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                context<span class="token punctuation">.</span><span class="token function">registerShutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessControlException</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//激活开启容器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取 bean 工厂,默认会返回DefaultListableBeanFactory类型的bean工厂</span>
            <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//对获取到的 beanFactory 做预处理设置</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//beanFactory准备工作完成后进行的后置处理工作</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//执行 beanFactory 后置处理器的方法</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//注册 bean 的后置处理器</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//初始化 MessageSource 组件</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//初始化事件派发器,多播器</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//用来初始化子容器中的bean,默认是空方法</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//注册监听器</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//初始化所有剩下的单实例 bean</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//完成ben的创建初始化工作,完成 IOC 容器的创建</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> var9<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception encountered during context initialization - cancelling refresh attempt: "</span> <span class="token operator">+</span> var9<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelRefresh</span><span class="token punctuation">(</span>var9<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> var9<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2_refreshobtainFreshBeanFactory_beanBeanFactoryBeanDefinitionRegistryBeanDefinition_xml_XmlBeanDefinitionReade_769"></a>2. refresh—&gt;obtainFreshBeanFactory() bean工厂BeanFactory或BeanDefinitionRegistry与BeanDefinition xml解析器 XmlBeanDefinitionReade相关</h3> 
<ol><li>首先在服务启动时会获取指定bean的class,扫描转换为BeanDefinition,这些BeanDefinition是如何管理的,服务启动继续执行会将这些根据这些BeanDefinition创建出实例bean,如何创建的,创建过程中或创建完成后是如何管理的</li><li>refresh中调用了obtainFreshBeanFactory()方法,该方法中重点关注调用的refreshBeanFactory()方法,刷新bean工厂,默认创建一个 DefaultListableBeanFactory类型的 bean工厂,<strong>而DefaultListableBeanFactory继承了BeanFactory,并且实现了BeanDefinitionRegistry所以DefaultListableBeanFactory除了是个管理bean的bean工厂以外,还管理了解析到的BeanDefinition</strong></li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">protected</span> <span class="token class-name">ConfigurableListableBeanFactory</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//1.创建bean工厂</span>
            <span class="token class-name">DefaultListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanFactory<span class="token punctuation">.</span><span class="token function">setSerializationId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//创建xml文件读取器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactoryMonitor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> beanFactory<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">"I/O error parsing bean definition source for "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> var5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>在refreshBeanFactory()中创建BeanFactory完毕后,会执行一个loadBeanDefinitions(),通过这个方法创建了xml文件读取器,也就BeanDefinition xml解析器XmlBeanDefinitionReader</li></ol> 
<pre><code class="prism language-java">	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">DefaultListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//用来解析xml中配置的bean</span>
        <span class="token class-name">XmlBeanDefinitionReader</span> beanDefinitionReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
　　　　　beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
　　　　  beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    　　 beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setEntityResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceEntityResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    　　 <span class="token function">initBeanDefinitionReader</span><span class="token punctuation">(</span>beanDefinitionReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
　　　　	<span class="token comment">//这里才是核心，加载beanDefinition的工作还没开始</span>
        <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanDefinitionReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>当XmlBeanDefinitionReader创建完毕后会调用loadBeanDefinitions()—&gt;doLoadBeanDefinitions(),解析xml生成Document对象,调用registerBeanDefinitions()</li></ol> 
<pre><code class="prism language-go">	protected <span class="token builtin">int</span> <span class="token function">doLoadBeanDefinitions</span><span class="token punctuation">(</span>InputSource inputSource<span class="token punctuation">,</span> Resource resource<span class="token punctuation">)</span> throws BeanDefinitionStoreException <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 1.根据inputSource和resource加载XML文件，并封装成Document</span>
        Document doc <span class="token operator">=</span> <span class="token function">doLoadDocument</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
　　　　　<span class="token comment">//注册BeanDefinition</span>
        <span class="token keyword">return</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>registerBeanDefinitions()向下链路比较深</li></ol> 
<blockquote> 
 <ol><li>实例化BeanDefinitionDocumentReader</li><li>调用registerBeanDefinitions()解析并注册BeanDefinition</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Document</span> doc<span class="token punctuation">,</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.使用DefaultBeanDefinitionDocumentReader实例化BeanDefinitionDocumentReader</span>
    <span class="token class-name">BeanDefinitionDocumentReader</span> documentReader <span class="token operator">=</span> <span class="token function">createBeanDefinitionDocumentReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.记录统计前BeanDefinition的加载个数</span>
    <span class="token keyword">int</span> countBefore <span class="token operator">=</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.createReaderContext：根据resource创建一个XmlReaderContext</span>
    <span class="token comment">// 4.registerBeanDefinitions：加载及注册Bean定义</span>
    documentReader<span class="token punctuation">.</span><span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token function">createReaderContext</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.返回本次加载的BeanDefinition个数</span>
    <span class="token keyword">return</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> countBefore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>查看registerBeanDefinitions()内部是怎么解析注册的</li></ol> 
<blockquote> 
 <ol><li>会基于Document拿到xml中配置的bean的节点信息</li><li>最终会调用到parseBeanDefinitions(), bean 定义的核心部分,遍历 root 节点(正常为 &lt; beans&gt; 节点)下的所有子节点，对子节点进行解析处理,如果节点的命名空间是 spring 默认的命名空间，则走 parseDefaultElement(ele, delegate) 方法进行解析，例如最常见的：&lt; bean&gt;, 如果节点的命名空间不是 spring默认的命名空间,也就是自定义命名空间，则走 delegate.parseCustomElement(ele) 方法进行解析，例如常见的： &lt; context:component-scan/&gt;、&lt; aop:aspectj-autoproxy/&gt;<br> 默认的命名空间为：http://www.springframework.org/schema/beans，其他都是自定义命名空间，例如 aop 的命名空间为：http://www.springframework.org/schema/aop</li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Document</span> doc<span class="token punctuation">,</span> <span class="token class-name">XmlReaderContext</span> readerContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext <span class="token operator">=</span> readerContext<span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Loading bean definitions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.拿到文档的子节点，对于Spring的配置文件来说，理论上应该都是&lt;beans&gt;</span>
    <span class="token class-name">Element</span> root <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getDocumentElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.通过拿到的节点，注册 Bean 定义</span>
    <span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Element</span> root<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">BeanDefinitionParserDelegate</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
    <span class="token comment">// 构建BeanDefinitionParserDelegate</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token function">createDelegate</span><span class="token punctuation">(</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 1.校验root节点的命名空间是否为默认的命名空间（默认命名空间http://www.springframework.org/schema/beans）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 2.处理profile属性</span>
        <span class="token class-name">String</span> profileSpec <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token constant">PROFILE_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>profileSpec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specifiedProfiles <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span>
                    profileSpec<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span><span class="token punctuation">.</span><span class="token constant">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 校验当前节点的 profile 是否符合当前环境定义的, 如果不是则直接跳过, 不解析该节点下的内容</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acceptsProfiles</span><span class="token punctuation">(</span>specifiedProfiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Skipped XML bean definition file due to specified profiles ["</span> <span class="token operator">+</span> profileSpec <span class="token operator">+</span>
                            <span class="token string">"] not matching: "</span> <span class="token operator">+</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.解析前处理, 留给子类实现</span>
    <span class="token function">preProcessXml</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析并注册bean定义</span>
    <span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.解析后处理, 留给子类实现</span>
    <span class="token function">postProcessXml</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> parent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Element</span> root<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.默认命名空间的处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">NodeList</span> nl <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历root的子节点列表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nl<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Node</span> node <span class="token operator">=</span> nl<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Element</span> ele <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">)</span> node<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 1.1 默认命名空间节点的处理，例如： &lt;bean id="test" class="" /&gt;</span>
                    <span class="token function">parseDefaultElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 1.2 自定义命名空间节点的处理，例如：&lt;context:component-scan/&gt;、&lt;aop:aspectj-autoproxy/&gt;</span>
                    delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 2.自定义命名空间的处理</span>
        delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_refreshinvokeBeanFactoryPostProcessors_beanBeanFactoryPostProcessor_909"></a>3. refresh()—&gt;invokeBeanFactoryPostProcessors() bean工厂后置处理器BeanFactoryPostProcessor的创建与执行</h3> 
<ol><li>Spring中创建bean的顺序是有优先级的,在BeanFactory创建完后后会进行一些处理,并且在BeanFactory创建完后后说明要接下来要开始初始化创建其它的bean了,要进行一些预处理,所以提供了BeanFactoryPostProcessor,在BeanFactory创建完成,bean转换为BeanDefinition后,通过refresh()中的invokeBeanFactoryPostProcessors()获取BeanFactoryPostProcessor,执行它的postProcessBeanFactory()方法实现这些预处理功能</li><li>Spring中提供了多个直接或间接实现了BeanFactoryPostProcessor的类,以基于注解注入来说,在启动服务创建针对注解的BeanDefinition解析器AnnotatedBeanDefinitionReader时,会创建一系列的BeanFactoryPostProcessor,BeanPostProcessor的BeanDefinition,其中就有ConfigurationClassPostProcessor间接继承了BeanFactoryPostProcessor,通过invokeBeanFactoryPostProcessors()的执行优先将这个bean创建注入,那么在创建其它bean时就可以获取到这个bean,处理不管是手动注册还是扫描机制所有BeanDefinition中符合注解条件的BeanDefinition，过滤出带有相关注解的BeanDefinition包括(@Configuration、@Component、@ComponentScan、@Import、@ImportResource或者@Bean)进行进一步处理</li><li>查看invokeBeanFactoryPostProcessors()源码,内部会调用PostProcessorRegistrationDelegate下的invokeBeanFactoryPostProcessors()静态方法,该方法中首先会获取已有的BeanFactoryPostProcessor执行它的postProcessBeanFactory(),执行完毕后,会通过BeanFactory获取实现了BeanFactoryPostProcessor 接口的所有 Bean 名称,然后通过bean名称获取到对应的BeanDefinition,调用beanFactory的getBean()方法进行初始化创建拿到对象实例,然后执行它的postProcessBeanFactory()方法(查看源码实际上是比较复杂的,有很多判断,还有创建顺序什么的,省略掉一些其它代码,针对BeanFactoryPostProcessor的创建执行就以下几行,)</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>
	<span class="token comment">//1.获取以及存在的BeanFactoryPostProcessor,执行它的postProcessBeanFactory()方法</span>
	<span class="token comment">//......</span>
	
    <span class="token comment">//2.获取所有实现了 BeanFactoryPostProcessor 接口的 Bean 名称</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 执行 BeanFactoryPostProcessor</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> postProcessorName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取对应的 BeanFactoryPostProcessor 实例</span>
        <span class="token class-name">BeanFactoryPostProcessor</span> postProcessor <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>postProcessorName<span class="token punctuation">,</span> <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用 postProcessBeanFactory() 方法</span>
        postProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4_refreshregisterBeanPostProcessors_bean_930"></a>4. refresh()—&gt;registerBeanPostProcessors() bean后置处理器的创建</h3> 
<ol><li>在服务启动时创建ApplicationContext后会创建BeanDefinition 注解解析器AnnotatedBeanDefinitionReader,通过这个注解解析器会创建一系列BeanFactoryPostProcessor,BeanPostProcessor,前面已经讲了ConfigurationClassPostProcessor是一个BeanFactoryPostProcessor,另外还有BeanPostProcessor比如</li></ol> 
<blockquote> 
 <ol><li>用来支持 @Autowired @Value 等注解的解析AutowiredAnnotationBeanPostProcessor</li><li>可以处理@PostConstruct和@PreDestroy还有@Resource等注解的CommonAnnotationBeanPostProcessor</li><li>用来支持JPA的PersistenceAnnotationBeanPostProcessor</li></ol> 
</blockquote> 
<ol start="2"><li>另外还有比如支持aop的AnnotationAwareAspectJAutoProxyCreator 在使用aop是需要通过@EnableAspectJAutoProxy开启aop功能,通过这个注解最重要的是向容器中添加了AnnotationAwareAspectJAutoProxyCreator ,该类间接继承了 BeanFactoryAware与BeanPostProcessor接口,在创建其它bean对象时,判断如果需要aop增强,则通过AnnotationAwareAspectJAutoProxyCreator 重写的BeanPostProcessor中的postProcessAfterInitialization创建代理类</li><li>也就是BeanPostProcessor要先一步创建,通过它来监听其它bean的创建,在创建其它bean对象时,通过BeanPostProcessor中的postProcessBeforeInitialization()方法,和postProcessAfterInitialization()方法,对监控到的bean对象进行特殊处理</li><li>那BeanPostProcessor是怎么先一步创建的,就是在这里registerBeanPostProcessors()中创建出来的,简单看一下源码:</li></ol> 
<blockquote> 
 <ol><li>调用beanFactory的getBeanNamesForType()方法获取到所有实现了BeanPostProcessor接口的类名称</li><li>遍历获取到的这些bean名称,将这些BeanPostProcessor进行分类,例如:实现了 PriorityOrdered 的放入priorityOrderedPostProcessors集合中,实现了PriorityOrdered 并且是MergedBeanDefinitionPostProcessor类型的放入internalPostProcessors,实现了 Ordered 的放入 orderedPostProcessorNames 集合中,否则放入 nonOrderedPostProcessorNames 集合中</li><li>然后遍历这些BeanPostProcessor名称,执行beanFactory的getBean()方法获取到bean对象,调用beanFactory的addBeanPostProcessor()将这个BeanPostProcessor对象添加到beanFactory的beanPostProcessors属性中</li></ol> 
</blockquote> 
<h3><a id="5_refreshinitApplicationEventMulticaster__941"></a>5. refresh()—&gt;initApplicationEventMulticaster() 初始化事件派发器,多播器</h3> 
<ol><li>该方法中没有什么特殊的操作,只是用来初始化实际派发器,多播器,在后面事件驱动模型开发时使用,该方法中首先判断容器中是否存在id为"applicationEventMulticaster"的事件派发器,如果没有则创建一个类型为SimpleApplicationEventMulticaster事件派发器,设置到BeanFactory的applicationEventMulticaster属性上,并以"applicationEventMulticaster"为id添加到singletonObjects中</li><li>这里注册的applicationEventMulticaster事件派发器要与下面refresh()—&gt;registerListeners()监听器的注册放到一块来看</li></ol> 
<h3><a id="6_refresh_thisonRefresh_bean_944"></a>6. refresh()—&gt; this.onRefresh() 用来初始化子容器中的bean,默认是空方法</h3> 
<p>可以提供子类重写这个方法,在容器刷新时,做些其它扩展操作</p> 
<h3><a id="7_refreshthisregisterListeners__946"></a>7. refresh()—&gt;this.registerListeners() 注册监听器</h3> 
<ol><li>该方法中首先会调用getBeanNamesForType(ApplicationListener.class, true, false)获取到类型为ApplicationListener所有监听器的名字</li><li>遍历获取到的监听器名称,通过beanFactory获取到前面注册的applicationEventMulticaster事件派发器,调用派发器的addApplicationListenerBean()方法,将监听器名称,注意是名称添加到事件派发器中</li><li>然后会获取之前注册的事件earlyApplicationEvents,如果不为空遍历这些事件调用applicationEventMulticaster事件派发器的广播事件方法multicastEvent()将这些事件广播出去,问题:这里执行了之前注册的事件,那么之后注册的事件如何执行,这里要结合refresh()—&gt;finishRefresh() 去理解</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//获取的是成员applicationListeners</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> listener <span class="token operator">:</span> <span class="token function">getApplicationListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 获取SimpleApplicationEventMulticaster触发其方法</span>
		<span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addApplicationListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 从容器中获取ApplicationListener</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> listenerBeanNames <span class="token operator">=</span> <span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> listenerBeanName <span class="token operator">:</span> listenerBeanNames<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 获取SimpleApplicationEventMulticaster触发其方法-这里放的是beanName</span>
		<span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addApplicationListenerBean</span><span class="token punctuation">(</span>listenerBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 发布早期事件，本文这里为空</span>
	<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span> earlyEventsToProcess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents<span class="token punctuation">;</span>

	<span class="token comment">//设置为null，这个很重要</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>earlyEventsToProcess <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 如果早期/渴望的事件存在，则将其广播出去</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> earlyEvent <span class="token operator">:</span> earlyEventsToProcess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multicastEvent</span><span class="token punctuation">(</span>earlyEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//SimpleApplicationEventMulticaster 事件派发器中,广播事件方法示例</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">multicastEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">,</span> <span class="token class-name">ResolvableType</span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ResolvableType</span> type <span class="token operator">=</span> eventType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> eventType <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveDefaultEventType</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取所有通过发布的事件对象获取对应的 ApplicationListener 监听器</span>
        <span class="token class-name">Iterator</span> var4 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getApplicationListeners</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//遍历获取到的监听器</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> listener <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">)</span>var4<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Executor</span> executor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//判断是否可以异步执行,如果可以则使用多线程方式进行异步执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//多线程方式异步执行</span>
                executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">SimpleApplicationEventMulticaster</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invokeListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//同步执行</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invokeListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="8_refreshfinishBeanFactoryInitializationbeanFactorygetBeanbeanBeanDefinitionbean_1002"></a>8. refresh()—&gt;finishBeanFactoryInitialization()与beanFactory.getBean()引出bean的创建,是怎么由BeanDefinition实例化为bean的</h3> 
<ol><li>beanFactory的getBean()方法会在多个位置调用,比如在invokeBeanFactoryPostProcessors()创建BeanFactoryPostProcessor或registerBeanPostProcessors()BeanPostProcessor时中都调用了该方法,该方法时创建bean对象的入口</li><li>finishBeanFactoryInitialization()初始化所有剩下的单实例 bean时,方法内会获取到一个ConfigurableListableBeanFactory 类型的对象beanFactory,通过这个对象默认调用它的实现子类 DefaultListableBeanFactory 中的 preInstantiateSingletons()方法<br> ,该方法中会通过 while 循环调用AbstractBeanFactory的 getBean(beanName)方法, 在 getBean() 方法中调用 doGetBean() 方法中会通过 getSingleton() 方法去获取 bean, 如果首次执行时,没有这个 bean, 则调用AbstractAutowireCapableBeanFactory 子类实现的 createBean() 方法,在createBean()方法中通过调用 doCreateBean()</li><li>注意: 在createBean()或doCreateBean()方法进行实际创建前首先会调用resolveBeforeInstantiation(beanName, mbdToUse) 通过后置处理器,创建当前 ben 的代理对象返回(<strong>动态代理,在AOP中有详细讲解</strong>)</li><li>createBean()整个调用链路很长,此处就先简单描述一下,查看doCreateBean()源码:</li></ol> 
<blockquote> 
 <ol><li>通过 getSingleton() 方法通过singletonObjects一级缓存获取 bean, 如果首次执行时,没有这个 bean, 则调用createBean() 创建这个 bean, 当这个bean创建初始化完成以后,会将这个bean放入 singletonObjects 集合中</li><li>在createBean()中首先调用"getMergedLocalBeanDefinition(beanName)"通过mergedBeanDefinitions根据当前bean的名称获取到对应的BeanDefinition(mergedBeanDefinitions 存储的是经过合并和解析后的 BeanDefinition),<strong>然后调用resolveBeforeInstantiation(beanName, mbdToUse) 尝试通过后置处理器,创建当前 ben 的代理对象返回,也就是动态代理</strong>,比如aop<a href="https://blog.csdn.net/qq_29799655/article/details/105325591">参考前面的笔记: Spring AOP 的搭建与源码分析</a></li><li>如果没有创建出代理类createBean()继续向下执行最终会调用到createBeanInstance()通过BeanDefinition利用反射等功能创建bean实例</li></ol> 
</blockquote> 
<ol start="5"><li>查看createBeanInstance()源码:</li></ol> 
<blockquote> 
 <ol><li>首先会通过BeanDefinition中读取到的定义信息进行一系列的校验,例如是否是public权限</li><li>通过BeanDefinition判断能否通过回调方法创建当前获取的bean,例如FactoryBean的getObject()</li><li>判断当前bean构造器是否需要入参等,调用autowireConstructor()或instantiateBean()基于BeanDefinition创建出实例bean并返回</li><li><a href="https://blog.csdn.net/qq_40223516/article/details/126391763">参考博客</a></li></ol> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Make sure bean class is actually resolved at this point.</span>
		<span class="token comment">// 确认需要创建的bean实例的类可以实例化</span>
		<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 确保class不为空，并且访问权限是public</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
					<span class="token string">"Bean class isn't public, and non-public access not allowed: "</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 判断当前beanDefinition中是否包含实例供应器，此处相当于一个回调方法，利用回调方法来创建bean</span>
		<span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> instanceSupplier <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getInstanceSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>instanceSupplier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token function">obtainFromSupplier</span><span class="token punctuation">(</span>instanceSupplier<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 如果工厂方法不为空则使用工厂方法初始化策略</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token function">instantiateUsingFactoryMethod</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 一个类可能有多个构造器，所以Spring得根据参数个数、类型确定需要调用的构造器</span>
		<span class="token comment">// 在使用构造器创建实例后，Spring会将解析过后确定下来的构造器或工厂方法保存在缓存中，避免再次创建相同bean时再次解析</span>

		<span class="token comment">// Shortcut when re-creating the same bean...</span>
		<span class="token comment">// 标记下，防止重复创建同一个bean</span>
		<span class="token keyword">boolean</span> resolved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">// 是否需要自动装配</span>
		<span class="token keyword">boolean</span> autowireNecessary <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token comment">// 如果没有参数</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 因为一个类可能由多个构造函数，所以需要根据配置文件中配置的参数或传入的参数来确定最终调用的构造函数。</span>
				<span class="token comment">// 因为判断过程会比较，所以spring会将解析、确定好的构造函数缓存到BeanDefinition中的resolvedConstructorOrFactoryMethod字段中。</span>
				<span class="token comment">// 在下次创建相同时直接从RootBeanDefinition中的属性resolvedConstructorOrFactoryMethod缓存的值获取，避免再次解析</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					resolved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					autowireNecessary <span class="token operator">=</span> mbd<span class="token punctuation">.</span>constructorArgumentsResolved<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 有构造参数的或者工厂方法</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 构造器有参数</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>autowireNecessary<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 构造函数自动注入</span>
				<span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 使用默认构造函数构造</span>
				<span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Candidate constructors for autowiring?</span>
		<span class="token comment">// 从bean后置处理器中为自动装配寻找构造方法, 有且仅有一个有参构造或者有且仅有@Autowired注解构造</span>
		<span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 以下情况符合其一即可进入</span>
		<span class="token comment">// 1、存在可选构造方法</span>
		<span class="token comment">// 2、自动装配模型为构造函数自动装配</span>
		<span class="token comment">// 3、给BeanDefinition中设置了构造参数值</span>
		<span class="token comment">// 4、有参与构造函数参数列表的参数</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">AUTOWIRE_CONSTRUCTOR</span> <span class="token operator">||</span>
				mbd<span class="token punctuation">.</span><span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Preferred constructors for default construction?</span>
		<span class="token comment">// 找出最合适的默认构造方法</span>
		ctors <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPreferredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 构造函数自动注入</span>
			<span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// No special handling: simply use no-arg constructor.</span>
		<span class="token comment">// 使用默认无参构造函数创建对象，如果没有无参构造且存在多个有参构造且没有@AutoWired注解构造，会报错</span>
		<span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>doCreateBean() 方法中首先调用会调用 populateBean() 方法, 对创建的 bean 的属性赋值 ,然后调用 initializeBean() 方法,执行创建这个 bean 的初始化方法</li><li>initializeBean() 方法中先后调用了三个主要的方法 : 
  <ul><li>applyBeanPostProcessorsBeforeInitialization() 执行初始化前的方法,</li><li>invokeInitMethods() 执行初始化方法,例如我们自定义的一些初始化方法,框架中定义的一些初始化方法</li><li>applyBeanPostProcessorsAfterInitialization() 执行初始化后的方法</li><li>初始化前后的方法执行,主要是判断需要初始化的bean是否是 BeanPostProcessor 的实现子类,如果是,在初始化前,调用执行 postProcessBeforeInitialization() 方法, 在初始化后,调用执行 postProcessAfterInitialization() 方法</li></ul> </li></ol> 
<h3><a id="9_refreshthisfinishRefresh_ben_IOC__1104"></a>9. refresh()—&gt;this.finishRefresh() 完成ben的创建初始化工作,完成 IOC 容器的创建,发布容器刷新完成事件</h3> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//初始化跟生命周期有关的后置处理器,在容器中获取LifecycleProcessor</span>
		<span class="token comment">//类型的后置处理器接口,在容器刷新完成以及关闭时执行的方法,此处是注册</span>
		<span class="token comment">//如果没有会注册一个默认的生命周期组件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拿到生命周期处理器,回调onRefresh()容器刷新完成方法,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//推送上下文刷新完毕事件到相应的监听器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextRefreshedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LiveBeansView</span><span class="token punctuation">.</span><span class="token function">registerApplicationContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<ol><li>当前终点关注内部调用的publishEvent()推送上下文刷新完毕事件到相应的监听器</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token class-name">Object</span> event<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResolvableType</span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">"Event must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.如有必要，将事件装饰为ApplicationEvent</span>
        <span class="token class-name">ApplicationEvent</span> applicationEvent<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            applicationEvent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            applicationEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayloadApplicationEvent</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                eventType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PayloadApplicationEvent</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> applicationEvent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResolvableType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>applicationEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2.使用事件广播器广播事件到相应的监听器</span>
            <span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multicastEvent</span><span class="token punctuation">(</span>applicationEvent<span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

       
        <span class="token comment">// 3.同样的，通过parent发布事件.....</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token keyword">instanceof</span> <span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="10__Spring_refreshbean_1154"></a>10. 概述 Spring 启动refresh()方法执行bean的状态流转过程</h3> 
<ol><li>也是就是上面说的启动Spring IOC注入过程: BeanFactory—&gt;BeanFactoryPostProcessor —&gt; BeanPostProcessor—&gt;其它bean<br> <img src="https://images2.imgbox.com/c7/b7/OWfKDaBS_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4d/c3/hSZVII7g_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7c/82/QfD1Nh4b_o.png" alt="在这里插入图片描述"></li></ol> 
<h3><a id="11_BeanBeanDefinition_1159"></a>11. Bean的生产顺序是由什么决定的,BeanDefinition的注册顺序是由什么决定的</h3> 
<ol><li>首先bean的创建顺序是由BeanDefinition的注册顺序决定的,依赖关系也会影响bean的创建顺序</li><li>BeanDefinition的注册顺序是由什么来决定的: 是由配置或使用的@那种注解来决定,是由解析顺序来决定的</li><li>BeanDefinition解析注解的顺序依次: @Configuration, @Component, @Impotr, @Bean, @ImportBeanDefinitionRegistrar,其中内部还有很多其它细节,例如当多个@Component时,可以通过@Order去影响多个@Component的解析顺序等等</li><li>假设通过@Configuration, @Component, @Impotr, @Bean, @ImportBeanDefinitionRegistrar等不同方式向容器中注入相同beanName的bean,根据BeanDefinition解析顺序,后面的会覆盖前面的</li><li>还有其它几种复杂情况:</li></ol> 
<blockquote> 
 <ol><li>@Import 与@Configuration:通过@Import导入了一个配置类此时的顺序是:普通@Configuration—&gt;@Import 与@Configuration组合—&gt;@Component, @Impotr, @Bean, @ImportBeanDefinitionRegistrar</li><li>@Import 与@Bean: 通过@Import 导入了一个配置类配置类中有@Bean此时这个组合出来的@Bean的顺序是: 在@Impotr后 @Bean前</li><li>另外@ImportBeanDefinitionRegistrar是向容器中手动注入BeanDefinitionRegistrar解析器的方式,所以是最后执行<br> 还有一种情况,假设一个类使用@Component修饰,但是该类又实现了BeanDefinitionRegistryPostProcessor接口,此时该类的执行顺序: 会在@Component这个级别执行,但是多个@Component时又会按照类的不同类型,@Order等等再次排序加载</li></ol> 
</blockquote> 
<h3><a id="12_Spring_1169"></a>12. 怎么给Spring做扩展</h3> 
<h4><a id="Spring_IOC_1170"></a>Spring IOC过程中有哪些扩展点</h4> 
<ol><li>Spring在启动时提供了很多扩展接口,提供了钩子方法供用户实现,提供附加功能</li><li>在启动Spring容器时先调用obtainFreshBeanFactory() 创建DefaultListableBeanFactoryB,然后执行invokeBeanFactoryPostProcessors(beanFactory),通过该方法执行的<strong>创建bean工厂后的扩展点</strong></li></ol> 
<blockquote> 
 <ol><li>BeanDefinitionRegistryPostProcessor —&gt; postProcessBeanDefinitionRegistry() 动态的去注册BeanDefinition</li><li>BeanFactoryPostProcessor —&gt; postProcessBeanFactory()</li></ol> 
</blockquote> 
<ol start="3"><li>BeanPostProcessor 中的两个抽象方法,在创建bean完成后,执行populateBean()方法对属性赋值,通过执行initializeBean(),<strong>初始化bean后的扩展点</strong> (Spring中提供了多种后置处理器,最起码要说出这个初始化前后的)</li></ol> 
<blockquote> 
 <p>BeanPostProcessor —&gt; 初始化前: postProcessBeforeInitialization(), 初始化后: postProcessAfterInitialization()</p> 
</blockquote> 
<ol start="4"><li>另外还对象初始化前后,销毁前后执行的init-method,destroy-method方法</li></ol> 
<h4><a id="BeanDefinition_1178"></a>如何在所有BeanDefinition注册完成后做扩展</h4> 
<ol><li>Spring提供了BeanFactoryPostPropersser,内部有postProcesserBeanFactory(),在BeanDefinition注册完成后,可以通过beanFactory调用getBeanDefinitionNames()获取到容器中所有的BeanDefinition 名称,然后通过这个名称可以获取到所有BeanDefinition,进行指定操作,并且Spring在启动时创建BeanFactory后,会通过invokeDifinitionRegistryPostProcessor()方法先执行BeanDefinition相关bean的操作,在然后执行BeanFactoryPostPropersser下的postProcesserBeanFactory()方法, 该方法就可以看为是所有BeanDefinition注册完成后的扩展点</li></ol> 
<h4><a id="bean_1180"></a>如何在所有的bean创建完成后做扩展</h4> 
<ol><li>Spring启动按顺序创建为指定类型bean后,会执行finishBeanFactoryInitialization方法,获取到所有的BeanDefinition,通过beanFactory.getBean()创建其它的单实例bean,该方法执行完毕后所有bean才创建完毕</li><li>在bean创建完成后,遍历bean,判断是否是SmartInitializingSingleton类型,如果是执行该类下的afterSingletonsInstantiated()方法,该方法就是所有bean创建完成后的扩展点</li><li>另外,在refresh()下,执行finishBeanFactoryInitialization()完毕后,还会执行一个finishRefresh()方法,在该方法中会执行一个publishEvent(new ContextRefreshedEvent(this)),通过该方法发布事件,可以通过事件监听机制,EventListener监听到ContextRefreshedEvent事件进行扩展,也是一个扩展点</li></ol> 
<h2><a id="__1184"></a>四. 其它问题总结</h2> 
<h4><a id="1_BeanDefinitionRegistry_1185"></a>1. BeanDefinitionRegistry的注册</h4> 
<ol><li>我们定义bean时不管是通过java config方式，还是xml配置文件的方式，最终都会解析成BeanDefinition，而这些BeanDefinition都需要注册到容器中，这个注册的过程是通过接口org.springframework.beans.factory.support.BeanDefinitionRegistry来完成的</li><li>BeanDefinitionRegistry 是一个接口,定义了关于 BeanDefinition 的注册、移除、查询等一系列的操作,该接口有三个实现类：DefaultListableBeanFactory、GenericApplicationContext、SimpleBeanDefinitionRegistry,在项目启动时默认使用的是DefaultListableBeanFactory</li><li>DefaultListableBeanFactory中通过成员变量。来保存所以的beanDefinition</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> beanDefinitionMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="4"><li>DefaultListableBeanFactory除了实现BeanDefinitionRegistry 接口,还实现了BeanFactory接口，提供了基本的BeanFactory功能,默认情况下Spring启动,创建的BeanFactory工厂就是DefaultListableBeanFactory</li></ol> 
<blockquote> 
 <ol><li>通过实现BeanDefinitionRegistry接口:实现了对 BeanDefinition 的注册、移除、查询等一系列的操作。</li><li>通过实现BeanFactory接口: 变为了Bean工厂的默认实现,提供了bean的实例化、定位、配置应用程序中的对象及建立这些对象间的依赖能力</li></ol> 
</blockquote> 
<h4><a id="2_Spring_bean_1195"></a>2. Spring 实例化bean有几种方式</h4> 
<ol><li>大概有四种方式:</li></ol> 
<blockquote> 
 <ol><li>利用反射调用构造器实例化: 以Spring xml配置bean举例,需要配置该bean的class属性为该bean的路径,在Spring启动时,通过BeanDifinition读取class属性指向的路径,然后通过反射根据这个类路径调用构造器,进行实例化</li><li>静态工厂方式,配置bean的factory-method工厂静态方法,通过这个静态工厂方法返回实例对象</li><li>实例工厂方式例如@Bean: 在factory-method静态工厂的基础上,指定一个factory-bean工厂bean,底层在实例化时会调用指定工厂中的factory-method, 而@Bean底层就是通过该方式实现的,在使用@Configuration+@Bean注解时,会将@Bean所在的配置类读取到BeanDefinition的factoryBeanName属性中,会将@Bean修饰的方法名读取到BeanDefinition的factoryMethodName中</li><li>FactoryBean方式,实现FactoryBean接口重写getObject()方法,该方式创建对象是懒加载</li></ol> 
</blockquote> 
<ol start="2"><li>有什么不同: 1是由Spring去控制创建处理,2,3,4可以通过编码的方式自己控制实例化的过程更灵活</li></ol> 
<h4><a id="3_Spring_1202"></a>3. Spring有哪几种配置方式</h4> 
<ol><li>也就是怎么给Spring容器配置元数据</li></ol> 
<blockquote> 
 <ol><li>XML配置: Spring.xml,配置&lt; bean&gt;标签等</li><li>注解配置: Spring2.5+提出, 基于注解例如配置中使用&lt; component-scan&gt; 开启包扫描,基于包扫描,与注解进行注入</li><li>java配置: 又被称为javaConfig,Spring3.0后提出:@Configuration, @Bean,@PropertySource, @Value, @ComponentScan</li></ol> 
</blockquote> 
<h4><a id="4_bean_1207"></a>4. bean的配置方式</h4> 
<blockquote> 
 <ol><li>xml方式,通过bean标签配置</li><li>@Component方式: (@Controller,@Service, @Repostory…)前提: 需要配置包扫描@ComponentScan,该方式底层是通过反射调用构造方法创建的</li><li>@Bean方式:通常用来修饰方法与@Configuration配合使用,可以自己控制实例化过程</li><li>@Impot方式: @ImportSelectot返回一个对象数组,@ImportBeanDefinitionRegistrar提供了一个BeanDefinition注册器,可以动态的去注入</li></ol> 
</blockquote> 
<ol start="3"><li>对应读取XML有XmlBeanDefinitionReader实现子类, 对应读取javaConfig的有AnnotatedBeanDefinitionReader实现子类</li></ol> 
<blockquote> 
 <ol><li>javaconfing方式: 在创建Spring容器,调用refresh()注入bean前,会先执行一个register(),该方法中会执一个"reader.register(anotatedClasses);"方法,通过AnnotatedBeanDefinitionReader读取项目中的配置类也就是配置类相关注解</li><li>xml方式:是在refresh()方法中,会执行一个obtainFreshBeanFactory(),该方法中会执行refreshBeanFactory()—&gt;loadBeanDefinitions(beanFactory)在该方中通过XmlBeanDefinitionReader读取xml,进行读取</li></ol> 
</blockquote> 
<ol start="4"><li>解析阶段: 最终会解析xml中的节点,或javaConfiguration中的配置类到BeanDefinition</li></ol> 
<blockquote> 
 <ol><li>对应javaConfig使用ConfigurationClassParser 配置类解析器—&gt;doProcessConfigurationClass()该方法中会解析@PropertySource,@ComponentScan, @Import, @Bean…等注解注册为BeanDefinition</li><li>对应xml使用DefaultBeanDefinitionDocumentReader----&gt;parseDefaultElement()方法解析xml中各种节点,注册为BeanDefinition</li></ol> 
</blockquote> 
<ol start="5"><li>读取解析到bean信息后,将解析到的bean的路径保存到BeanDefinition的class属性,bean的模式保存到scope属性属性中,bean属性的初始化值保存到property中…,最终将得到的BeanDefinition存储到beanDefinitionMap中,在创作该bean时,Spring底层会通过这个BeanDefinition拿到这些配置信息,然后通过BeanFactory创建这个bean</li><li>后续创建bean时跟还是Spring启动IOC注入的流程,创建BeanFactory,加载所有BeanDefinition,通过BeanFactory.getBean()–&gt;createBean()–&gt;通过beanName在beanDefinitionMap中获取到对应的BeanDefinition,拿到这个bean的class属性也就是路径,通过反射调用构造器创建…</li><li>怎么解析@Bean, @Import, @ComponentScan, @Component…修饰的bean到beanDefinitionMap的,Spring提供了ConfigurationClassParser,会执行该类下的doProcessConfigurationClass()方法,扫描对应的注解,进行解析</li><li>那ConfigurationClassParser怎么扫描的,以 @ComponentScan 为例Spring提供了ClassPathBeanDefinitionSacnner通过该类下的doScan()方法扫描,根据包路径找到所有的.class文件,判断类是不是标准的@Component注解,判断是不是接口,是不是抽象类…</li><li>那么BeanDefinition是在哪一步读取进入的呢: 是在invokeDifinitionRegistryPostProcessor()</li></ol> 
<h4><a id="5_ComponentScanbasePackage_1223"></a>5. @ComponentScan不设置basePackage为什么也会包扫描</h4> 
<p>Spring底层在解析@ComponentScan时,如果没有设置basePackage值,默认会拿@ComponentScan所在类所在的包的地址,扫描该地址下的</p> 
<h4><a id="6_javaConfigspringxml_1225"></a>6. javaConfig如何代替spring.xml的</h4> 
<ol><li>java配置又被称为javaConfig,Spring3.0后提出,通过注解配置类来代替以前的Spring.xml配置文件</li><li>例如使用@Config修饰配置类,通过这个配置类代替以前的Spring.mxl,向容器中注入bean时,@Bean代替了Spring.xml的&lt; bean&gt; 标签,其它还有@Scope, @Lazy,包扫描的@ComponentScan, 读取配置文件的@PropertySource,@Value…</li></ol> 
<blockquote> 
 <ol><li>在Spring.xml时,Spring容器提供了ClassPathXmlApplicationContext上下文</li><li>javaConfig时: Spring容器提供了AnnotationConfigApplicationContext上下文</li></ol> 
</blockquote> 
<h4><a id="7_ComponentControllerRepositoryService_1230"></a>7. @Component,@Controller,@Repository,@Service有什么区别</h4> 
<ol><li>首先@Component是@Controller,@Repository,@Service的元注解,也可以将后面三个统一看为是@Component</li><li>那么为什么要分出四个来:让代码的阅读性更好,@Controller标注控制器,@Service标注业务逻辑层,@Repository标注数据访问层</li></ol> 
<h4><a id="8_Import_1233"></a>8. @Import有几种使用方式</h4> 
<p>仔细来说的话应该有四种</p> 
<blockquote> 
 <ol><li>使用@Import直接导入一个类</li><li>导入一个实现了ImportSelector接口的类,重写的selectImports()方法,返回一个存储类路径的数组,@Import在注入时会执行该方法,注入方法返回的数组中的类路径指定的bean,因为是数组可以一次注册多个bean</li><li>导入一个实现了ImportBeanDefinitionRegistrar接口的类,重写registerBeanDefinitions(),通过执行该方法向容器中注入bean,注意点,该方式使用的是BeanDefinitionRegistry注册器方式注入,需要自己先创建一个BeanDefinition,由于是注册器方式注册,该方式注册的bean的</li><li>另外查看第2中方式ImportSelector接口下还存在一个子接口DeferredImportSelector,使用@Import导入实现了该接口的类也可以,注意点SpringBoot的自动配置就是使用的该方式,特点是与注册时机晚于ImportSelector,并且具有延迟,分组的特性</li></ol> 
</blockquote> 
<h4><a id="9_Configuration_1239"></a>9. @Configuration的作用及原理解析</h4> 
<ol><li>Spring3.0后提出的基于javaConfig方式,使用注解配置中的其中一个注解,也可代替Spring.xml配置文件,实际这样说并不太标准,通常情况下使用@Configuration+@Bean向容器中配置bean,但是只是用@Bean实际也可以注入bean的</li><li>那么在向Spring中配置bean时,加@Configuration与不加有什么区别:加了@Configuration会<strong>为配置类</strong>创建cglib动态代理,用来保证内部被@Bean修饰的方法创建的bean是单例的,例如:</li></ol> 
<blockquote> 
 <ol><li>通过@Bean修饰方法1,方法1内部new了一个a对象注入到了容器中</li><li>通过@Bean修饰方法2,在该方法手动调用了两次方法1,</li><li>方法2中两次调用方法1,相当于new了两次a对象,就会出现多例的情况</li><li>使用@Configuration后,在方法2调用方法1时,会带来增强,会先在IOC容器中获取,获取不到再去创建</li></ol> 
</blockquote> 
<ol start="3"><li>原理: 在启动Spring容器时会创建ApplicationConfigApplicationContext,在执行refresh()方法前会调用一个this()无参构造器,在构造器中会new一个new AnnotatedBeanDefinitionReader(this),在这里面会创建用于支撑整个SpringIOC加载的内部组件,其中就包括ConfigurationClassPostProcessor,用来解析@Configuration注解的后置处理器</li><li>ConfigurationClassPostProcessor 中重点关注实现的BeanFactoryPostProcess与BeanDefinitionRegistryPostProcessor两个接口, 在Spring启动时通过执行refresh()方法中的invokeBeanFactoryPostProcessor():</li></ol> 
<blockquote> 
 <ol><li>执行ConfigurationClassPostProcessor重写的BeanDefinitionRegistryPostProcessor中的postProcessBeanDefinitionRegistry()方法,解析@Configuration, @Bean, @Import, @Component…等注解,注册为BeanDefinition</li><li>执行ConfigurationClassPostProcessor重写的BeanFactoryPostProcess中的postProcessBeanFactory()方法,创建cglib动态代理</li><li>通过动态代理对配置类方法代理增强,例如增强配置类中@Bean修饰的方法,在通过该方法创建对象时先去容器中查询,查询不到才创建</li></ol> 
</blockquote> 
<h4><a id="10_Bean_1251"></a>10. @Bean修饰的方法的调用是怎么保证单例的</h4> 
<ol><li>先解释一下@Bean修饰的方法为什么会出现不是是多例的情况: @Bean方法中new对象,然后手动多次调用,而不是通过容器去获取就会出现多例的情况,</li><li>怎么保证单例: 可以查看上方的"@Configuration的作用及原理解析", 就是通过@Configuration修饰@Bean方法所在的类,在Spring启动时底层会对@Configuration修饰的类进行代理增强,当手动调用@Bean修饰的方法,获取bean时,会先去容器中查找,如果查找不到再创建</li></ol> 
<h4><a id="11_Bean_1254"></a>11. 如何将一个三方的类配置为Bean</h4> 
<ol><li>这个问题的意思是一个三方类,我们无法修改这个类,例如在类上使用注解注入为Bean到容器中,</li><li>那么可以如何导入:</li></ol> 
<blockquote> 
 <ol><li>@Import(三种),</li><li>@Bean</li><li>实现BeanDefinitionRegistryPostProcessor接口,通过重写方法,以DefinitionRegistry注册器方式…</li></ol> 
</blockquote> 
<h4><a id="12_bean_bean_1260"></a>12. 什么是bean的装配, 什么是bean的自动装配</h4> 
<ol><li>装配,就是依赖注入,以Spring xml配置bean为例,假设当前配置的bean需要一个属性,我们可以通过property属性设置这个属性值,这个方式我们称为手动装配</li><li>那么什么是自动装配,例如使用@Autowired,@Resource注解,自动的在容器中获取需要注入的bean进行注入,这个称为自动注入</li></ol> 
<h4><a id="13_Spring_BeanFactoryPostProcess_1263"></a>13. Spring 容器启动时为什么先加载BeanFactoryPostProcess</h4> 
<ol><li>首先Spring启动时先创建BeanFactory,然后执行invokeBeanFactoryPostProcessors(beanFactory) ,在该方法中会加载所有的BeanDefinition,读取所有bean的配置信息,而BeanFactoryPostProcess中提供了一个postProcessBeanFactory(), 是在所有BeanDefinition都加载完成后执行的,可以看为是所有BeanDefinition注册完成后的的扩展,然后通过BeanDefinition创建实际的bean对象</li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1d315d0493a0d510cb008145498b6a73/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue跳转页面常用的几种方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/247be8553a54b90b2dbcd7c05668e23c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL 优化</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>