<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux Power supply子系统分析 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux Power supply子系统分析" />
<meta property="og:description" content="1.概述 对于便携式设备，如手机或者pad来说，battery都是必不可少的一个组成部分。kernel中为了方便对battery的管理，专门提供了power supply framework。
battery管理我觉得可以分开为两个部分，一个是电池监控（fuelgauge），另一个是充放电管理（charger），所以我们在内核中也是把它分成了两个驱动来管理。
电池监控（fuelgauge）驱动主要是负责向上层android系统提供当前电池的电量以及健康状态信息等等，另外除了这个以外，它也向charger驱动提供电池的相关信息；
充放电管理（charger）驱动主要负责电源线的插拔检测，以及充放电的过程管理。对于battery管理，硬件上有电量计IC和充放电IC。
2.Power Supply设计思路 先来回答一个问题：kernel中设备驱动的目的，是管理设备，并提供给用户空间程序使用，那么对PSY设备而言，kernel要管理什么？用户空间程序要使用什么？
其实PSY设备是一个特例，它的目的很单纯，就为系统供电。如果只考虑这个目的，就不需要任何驱动了，但情况会稍微复杂，因为：
1.PSY设备可能是电池，这引申出来电量检测， 充电管理等多个议题。此时，PSY driver需要管理的事情包括：检测电池类型，检测电池电量；检测充电状态等等。而用户空间则需要将检测到的结果显示给用户。
2.系统中可能有多个PSY设备，这些设备可能还有级联关系，如有些平板电脑中，可能同时存在DC-charger、USB-charger和battery供电。此时，PSY driver需要管理的事情包括，获取外部供电设备的连接状态，充电状态等等，用户空间需要将这些信息显示给用户。
那么，共性已经总结出来了，PSY driver的主要功能，就是向用户空间汇报各类状态信息，因此power supply class的核心思路就是：将这些状态信息，抽象为属性“properties”。由于状态信息是类型是有限的，properties的个数也是有限的。
PSY driver只需要负责：该PSY设备具备有哪些“属性”，这些“属性”的值（value）是什么；当属性值发生改变时，通知power supply class。
power supply class负责：将某个PSY 设备支持的属性及value，以sysfs的形式，提供给用户空间，当属性值改变时，以uevent的形式，广播给用户空间程序。
另外，power supply class也会协助处理PSY级联的情况。
3.Power Supply软件架构 power supply framework在kernel/drivers/power/下。内核抽象出来power supply子系统为驱动提供了统一的框架。功能包括：
1.抽象PSY设备的共性，向用户空间提供统一的API
2.为底层PSY驱动的编写，提供简单、统一的方式。同事封装并实现公共逻辑。
power supply class位于drivers/power/目录中，主要由3部分组成（可参考下图的软件架构）：
1）power supply core，用于抽象核心数据结构、实现公共逻辑。位于drivers/power/power_supply_core.c中。
2）power supply sysfs，实现sysfs以及uevent功能。位于drivers/power/power_supply_sysfs.c中。
3）power supply leds，基于linux led class，提供PSY设备状态指示的通用实现。位于drivers/power/power_suppply_leds.c中。
最后，驱动工程师可以基于power supply class，实现具体的PSY drivers，主要处理平台相关、硬件相关的逻辑。这些drivers都位于drivers/power/目录下。
接着来看一下核心数据结构drivers/power/power_supply_core.c中。
1.struct power_supply struct power_supply为power supply class的核心数据结构，用于抽象PSY设备，定义如下(kernel/msm-4.19/include/linux/power_supply.h)：
struct power_supply { const char *name; //该PSY的名称 enum power_supply_type type; //该PSY的类型，枚举类型，一般包括:battery、USB-charger、DC-charger。 enum power_supply_property *properties; //该PSY具有的属性列表，枚举型。#ifdef CONFIG_CHARGING_NODEADD Int charge_node_add //需要添加节点的话要在这里添加节点属性" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/6d5efb5fc51fb7ae79ebf995ece3ba9b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-10T11:05:05+08:00" />
<meta property="article:modified_time" content="2022-06-10T11:05:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux Power supply子系统分析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><a name="t0"></a><strong><span style="color:#4f4f4f;">1.</span></strong><strong><span style="color:#4f4f4f;">概述</span></strong></span></h2> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">对于便携式设备，如手机或者</span><span style="color:#4d4d4d;">pad</span><span style="color:#4d4d4d;">来说，</span><span style="color:#4d4d4d;">battery</span><span style="color:#4d4d4d;">都是必不可少的一个组成部分。</span><span style="color:#4d4d4d;">kernel</span><span style="color:#4d4d4d;">中为了方便对</span><span style="color:#4d4d4d;">battery</span><span style="color:#4d4d4d;">的管理，专门提供了</span><span style="color:#4d4d4d;">power supply framework</span><span style="color:#4d4d4d;">。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">battery</span><span style="color:#4d4d4d;">管理我觉得可以分开为两个部分，一个是</span><strong><span style="color:#ff0000;">电池监控（</span></strong><strong><span style="color:#ff0000;">fuelgauge</span></strong><strong><span style="color:#ff0000;">）</span></strong><span style="color:#4d4d4d;">，</span><strong><span style="color:#ff0000;">另一个是充放电管理（</span></strong><strong><span style="color:#ff0000;">charger</span></strong><strong><span style="color:#ff0000;">）</span></strong><span style="color:#4d4d4d;">，所以我们在内核中也是把它分成了两个驱动来管理。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><strong><span style="color:#ff0000;">电池监控（</span></strong><strong><span style="color:#ff0000;">fuelgauge</span></strong><strong><span style="color:#ff0000;">）</span></strong><span style="color:#ff0000;">驱动主要是负责向上层</span><span style="color:#ff0000;">android</span><span style="color:#ff0000;">系统提供当前电池的</span><strong><span style="color:#ff0000;">电量</span></strong><span style="color:#ff0000;">以及</span><strong><span style="color:#ff0000;">健康状态</span></strong><span style="color:#ff0000;">信息等等，另外除了这个以外，它</span><strong><span style="color:#ff0000;">也向</span></strong><strong><span style="color:#ff0000;">charger</span></strong><strong><span style="color:#ff0000;">驱动提供电池的相关信息</span></strong><span style="color:#ff0000;">；</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><strong><span style="color:#ff0000;">充放电管理（</span></strong><strong><span style="color:#ff0000;">charger</span></strong><strong><span style="color:#ff0000;">）</span></strong><span style="color:#ff0000;">驱动主要负责</span><strong><span style="color:#ff0000;">电源线的插拔检测</span></strong><span style="color:#ff0000;">，以及</span><strong><span style="color:#ff0000;">充放电的过程</span></strong><span style="color:#ff0000;">管理。</span><strong><span style="color:#ff0000;">对于</span></strong><strong><span style="color:#ff0000;">battery</span></strong><strong><span style="color:#ff0000;">管理，硬件上有电量计</span></strong><strong><span style="color:#ff0000;">IC</span></strong><strong><span style="color:#ff0000;">和充放电</span></strong><strong><span style="color:#ff0000;">IC</span></strong><strong><span style="color:#ff0000;">。</span></strong></span></p> 
<h2 style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><a name="t1"></a><strong><span style="color:#4f4f4f;">2.Power Supply</span></strong><strong><span style="color:#4f4f4f;">设计思路</span></strong></span></h2> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">先来回答一个问题：</span><span style="color:#4d4d4d;">kernel</span><span style="color:#4d4d4d;">中设备驱动的目的，是管理设备，并提供给用户空间程序使用，那么对</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">设备而言，</span><span style="color:#4d4d4d;">kernel</span><span style="color:#4d4d4d;">要管理什么？用户空间程序要使用什么？</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">其实</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">设备是一个特例，它的目的很单纯，就为系统供电。如果只考虑这个目的，就不需要任何驱动了，但情况会稍微复杂，因为：</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">1.<strong>PSY</strong></span><strong><span style="color:#4d4d4d;">设备可能是电池，这引申出来电量检测</span></strong><span style="color:#4d4d4d;">，</span> <span style="color:#4d4d4d;">充电管理等多个议题。此时，</span><strong><span style="color:#ff0000;">PSY driver</span></strong><strong><span style="color:#4d4d4d;">需要管理的事情包括：</span></strong><strong><span style="color:#ff0000;">检测电池类型</span></strong><strong><span style="color:#4d4d4d;">，</span></strong><strong><span style="color:#ff0000;">检测电池电量</span></strong><strong><span style="color:#4d4d4d;">；</span></strong><strong><span style="color:#ff0000;">检测充电状态</span></strong><strong><span style="color:#4d4d4d;">等等。而用户空间则需要将检测到的</span></strong><strong><span style="color:#ff0000;">结果显示给用户</span></strong><strong><span style="color:#4d4d4d;">。</span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">2.</span><span style="color:#4d4d4d;">系统中可能有多个</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">设备，这些设备可能还有级联关系，如有些平板电脑中，<strong>可能同时存在</strong></span><span style="color:#4d4d4d;">DC-charger</span><span style="color:#4d4d4d;">、</span><span style="color:#4d4d4d;">USB-charger</span><span style="color:#4d4d4d;">和</span><span style="color:#4d4d4d;">battery</span><span style="color:#4d4d4d;">供电。此时，</span><span style="color:#4d4d4d;">PSY driver</span><span style="color:#4d4d4d;">需要管理的事情包括，获取外部供电设备的连接状态，充电状态等等，用户空间需要将这些信息显示给用户。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">那么，共性已经总结出来了，</span><span style="color:#ff0000;">PSY driver</span><span style="color:#ff0000;">的主要功能</span><span style="color:#4d4d4d;">，</span><span style="color:#ff0000;">就是向用户空间汇报各类状态信息</span><span style="color:#4d4d4d;">，</span><span style="color:#ff0000;">因此</span><span style="color:#ff0000;">power supply class</span><span style="color:#ff0000;">的核心思路就是：将这些</span><strong><span style="color:#ff0000;">状态信息，抽象为属性</span></strong><strong><span style="color:#ff0000;">“properties”</span></strong><span style="color:#ff0000;">。由于状态信息是类型是有限的，</span><span style="color:#ff0000;">properties</span><span style="color:#ff0000;">的个数也是有限的。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#ff0000;">PSY driver</span><span style="color:#ff0000;">只需要负责：该</span><span style="color:#ff0000;">PSY</span><span style="color:#ff0000;">设备具备有哪些</span><span style="color:#ff0000;">“</span><span style="color:#ff0000;">属性</span><span style="color:#ff0000;">”</span><span style="color:#ff0000;">，这些</span><span style="color:#ff0000;">“</span><span style="color:#ff0000;">属性</span><span style="color:#ff0000;">”</span><span style="color:#ff0000;">的值（</span><span style="color:#ff0000;">value</span><span style="color:#ff0000;">）是什么；</span><strong><span style="color:#ff0000;">当属性值发生改变时，通知</span></strong><strong><span style="color:#ff0000;">power supply class</span></strong><strong><span style="color:#ff0000;">。</span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#ff0000;">power supply class</span><span style="color:#ff0000;">负责：将某个</span><span style="color:#ff0000;">PSY </span><span style="color:#ff0000;">设备支持的属性及</span><span style="color:#ff0000;">value</span><span style="color:#ff0000;">，以</span><span style="color:#ff0000;">sysfs</span><span style="color:#ff0000;">的形式，</span><strong><span style="color:#ff0000;">提供给用户空间</span></strong><span style="color:#ff0000;">，</span><strong><span style="color:#ff0000;">当属性值改变时，以</span></strong><strong><span style="color:#ff0000;">uevent</span></strong><strong><span style="color:#ff0000;">的形式，广播给用户空间程序。</span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="color:#ff0000;">另外，</span></strong><strong><span style="color:#ff0000;">power supply class</span></strong><strong><span style="color:#ff0000;">也会协助处理</span></strong><strong><span style="color:#ff0000;">PSY</span></strong><strong><span style="color:#ff0000;">级联的情况。</span></strong></p> 
<h2 style="margin-left:.0001pt;text-align:left;"><a name="t2"></a><strong><span style="color:#4f4f4f;">3.Power Supply</span></strong><strong><span style="color:#4f4f4f;">软件架构</span></strong></h2> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">power supply framework</span><span style="color:#4d4d4d;">在</span><span style="color:#4d4d4d;">kernel/drivers/power/</span><span style="color:#4d4d4d;">下。内核抽象出来</span><span style="color:#4d4d4d;">power supply</span><span style="color:#4d4d4d;">子系统为驱动提供了统一的框架。功能包括：</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">1.</span><span style="color:#4d4d4d;">抽象</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">设备的共性，向用户空间提供统一的</span><span style="color:#4d4d4d;">API</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">   2.</span><span style="color:#4d4d4d;">为底层</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">驱动的编写，提供简单、统一的方式。同事封装并实现公共逻辑。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#ff0000;">power supply class</span><span style="color:#ff0000;">位于</span><strong><span style="color:#ff0000;">drivers/power/</span></strong><strong><span style="color:#ff0000;">目录中</span></strong><span style="color:#ff0000;">，主要由</span><span style="color:#ff0000;">3</span><span style="color:#ff0000;">部分组成（可参考下图的软件架构）：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#ff0000;">1</span><span style="color:#ff0000;">）</span><span style="color:#ff0000;">power supply </span><strong><span style="color:#ff0000;">core</span></strong><span style="color:#ff0000;">，用于</span><strong><span style="color:#ff0000;">抽象核心数据结构、实现公共逻辑。</span></strong><span style="color:#ff0000;">位于</span><span style="color:#ff0000;">drivers/power/power_supply_core.c</span><span style="color:#ff0000;">中。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#ff0000;">2</span><span style="color:#ff0000;">）</span><span style="color:#ff0000;">power supply </span><strong><span style="color:#ff0000;">sysfs</span></strong><span style="color:#ff0000;">，</span><strong><span style="color:#ff0000;">实现</span></strong><strong><span style="color:#ff0000;">sysfs</span></strong><strong><span style="color:#ff0000;">以及</span></strong><strong><span style="color:#ff0000;">uevent</span></strong><strong><span style="color:#ff0000;">功能</span></strong><span style="color:#ff0000;">。位于</span><span style="color:#ff0000;">drivers/power/power_supply_sysfs.c</span><span style="color:#ff0000;">中。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#ff0000;">3</span><span style="color:#ff0000;">）</span><span style="color:#ff0000;">power supply </span><strong><span style="color:#ff0000;">leds</span></strong><span style="color:#ff0000;">，基于</span><span style="color:#ff0000;">linux led class</span><span style="color:#ff0000;">，</span><strong><span style="color:#ff0000;">提供</span></strong><strong><span style="color:#ff0000;">PSY</span></strong><strong><span style="color:#ff0000;">设备状态指示的通用实现。</span></strong><span style="color:#ff0000;">位于</span><span style="color:#ff0000;">drivers/power/power_suppply_leds.c</span><span style="color:#ff0000;">中。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#ff0000;">最后，驱动工程师可以基于</span><span style="color:#ff0000;">power supply class</span><span style="color:#ff0000;">，实现具体的</span><span style="color:#ff0000;">PSY drivers</span><span style="color:#ff0000;">，<strong>主要处理平台相关、硬件相关的逻辑。这些</strong></span><strong><span style="color:#ff0000;">drivers</span></strong><strong><span style="color:#ff0000;">都位于</span></strong><strong><span style="color:#ff0000;">drivers/power/</span></strong><strong><span style="color:#ff0000;">目录下。</span></strong></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;"><img alt="https://img-blog.csdn.net/20180507172954608" height="480" src="https://images2.imgbox.com/55/bf/NUGUMqcg_o.gif" width="587"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">接着来看一下核心数据结构</span><span style="color:#4d4d4d;">drivers/power/power_supply_core.c</span><span style="color:#4d4d4d;">中。</span></p> 
<h3 style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">1.struct power_supply</span></h3> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">struct power_supply</span><span style="color:#4d4d4d;">为</span><span style="color:#4d4d4d;">power supply class</span><span style="color:#4d4d4d;">的核心数据结构，用于抽象</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">设备，定义如下</span><span style="color:#4d4d4d;">(kernel/msm-4.19/include/linux/power_supply.h)</span><span style="color:#4d4d4d;">：</span></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply {<!-- --></span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">const</span></span> <span style="background-color:#fafafa;"><span style="color:#a626a4;">char</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> *name;   </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">该</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">的名称</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">enum</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_type type; </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">该</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">的类型，枚举类型，一般包括</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">:battery</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">、</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">USB-charger</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">、</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">DC-charger</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">。</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">enum</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_property *properties; </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">该</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">具有的属性列表，枚举型。</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">#ifdef CONFIG_CHARGING_NODEADD</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">        Int charge_node_add    //</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">需要添加节点的话要在这里添加节点属性</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">#endif </span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       size_t num_properties;  </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">属性的个数</span></span></li><li style="text-align:left;"><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">char</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> **supplied_to; </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">一个字符串数组，保存了由该</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">供电的</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">列表，以此可将</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PAY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">组成互相级联的</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">链表。这些被供电的</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">，称作</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">supplicant</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">（客户端，乞求者）</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       size_t num_supplicants;</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//supplicant</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">的个数。</span></span></li><li style="text-align:left;"><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">char</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> **supplied_from; </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">一个字符串数组，保存了该</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">供电的</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">列表，也称作</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">supply</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">（提供者），从另外一个方向组织</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">之间的级联关系。</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       size_t num_supplies; </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//supply</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">的个数</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#4078f2;">#</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">ifdef</span></span><span style="background-color:#fafafa;"><span style="color:#4078f2;"> CONFIG_OF</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> device_node *of_node; </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">用于保存</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">of_node</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">指针。</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#4078f2;">#</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">endif</span></span></li><li style="text-align:left;"><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">int</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> (*get_property)(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply *psy, </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//PSY driver</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">需要实现的回调函数，用于获取属性值。</span></span></li><li style="text-align:left;">                          <span style="background-color:#fafafa;"><span style="color:#a626a4;">enum</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_property psp,</span></span></li><li style="text-align:left;">                          <span style="background-color:#fafafa;"><span style="color:#a626a4;">union</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_propval *val);</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">int</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> (*set_property)(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply *psy,  </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//PSY driver</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">需要实现的回调函数，用于设置属性值。</span></span></li><li style="text-align:left;">                            <span style="background-color:#fafafa;"><span style="color:#a626a4;">enum</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_property psp,</span></span></li><li style="text-align:left;">                          <span style="background-color:#fafafa;"><span style="color:#a626a4;">const</span></span> <span style="background-color:#fafafa;"><span style="color:#a626a4;">union</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_propval *val);</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">int</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> (*property_is_writeable)(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply *psy,  </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">返回指定的属性值是否可写（用于</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">sysfs</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">）；</span></span></li><li style="text-align:left;">                                   <span style="background-color:#fafafa;"><span style="color:#a626a4;">enum</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_property psp);</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">void</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> (*external_power_changed)(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply *psy); </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">当一个</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">设备存在</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">supply PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">，且该</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">supply PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">的属性发生改变（如</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">online offline</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">）时，</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">power supply core</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">会调用该回调函数，通知</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY driver</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">以便让它做出相应处理。</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">void</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> (*set_charged)(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply *psy);     </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">该回调函数的应用场景有点奇怪，外部模块通知</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PAY driver</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">，该</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">设备的状态改变了，自己改变了自己不知道，要外部通知，希望大家在实际工作中不要遇到，太纠结了。</span></span></li><li style="text-align:left;"><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* For APM emulation, think legacy userspace. */</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">int</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> use_for_apm;</span></span></li><li style="text-align:left;"><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* private */</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> device *dev;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> work_struct changed_work; </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">用户处理状态改变的</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">work queue</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">，主要思路是当该</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">的状态发生改变，启动一个</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">workqueue</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">，查询并通知所有的</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">supplicants</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">。</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       spinlock_t changed_lock;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">bool</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> changed;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#4078f2;">#</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">ifdef</span></span><span style="background-color:#fafafa;"><span style="color:#4078f2;"> CONFIG_THERMAL</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> thermal_zone_device *tzd;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> thermal_cooling_device *tcd;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#4078f2;">#</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">endif</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#4078f2;">#</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">ifdef</span></span><span style="background-color:#fafafa;"><span style="color:#4078f2;"> CONFIG_LEDS_TRIGGERS</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> led_trigger *charging_full_trig;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">char</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> *charging_full_trig_name;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> led_trigger *charging_trig;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">char</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> *charging_trig_name;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> led_trigger *full_trig;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">char</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> *full_trig_name;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> led_trigger *online_trig; </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">如果配置了</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">CONFIC_LED_TRIGGERS</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">，则调用的</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">linux led class</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">的接口，注册相应的</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">LED</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">设备，用于</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">状态指示。</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">char</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> *online_trig_name;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> led_trigger *charging_blink_full_solid_trig;</span></span></li><li style="text-align:left;">       <span style="background-color:#fafafa;"><span style="color:#a626a4;">char</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> *charging_blink_full_solid_trig_name;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#4078f2;">#</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">endif</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">};</span></span></li></ol> 
<h3 style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">2.PSY</span><span style="color:#4d4d4d;">的类型</span></h3> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">类型由</span><span style="color:#4d4d4d;">enum power_supply_type(power_supply.h)</span><span style="color:#4d4d4d;">定义：</span></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#a626a4;">enum</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_type {<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_TYPE_UNKNOWN = </span></span><span style="background-color:#fafafa;"><span style="color:#986801;">0</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">, </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">未知</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_TYPE_BATTERY,     </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">电池，手机平板上面最常用的</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_TYPE_UPS,         </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">不间断供电的，一般用户服务器</span></span>   </li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_TYPE_MAINS,        </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">主供电设备，如笔记本电脑适配器，特点是可以单独供电，当其断开时，再由辅助设备供电。</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_TYPE_USB,         </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* Standard Downstream Port */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_TYPE_USB_DCP,     </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* Dedicated Charging Port */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_TYPE_USB_CDP,     </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* Charging Downstream Port */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_TYPE_USB_ACA,     </span></span><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* Accessory Charger Adapters */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">};</span></span></li></ol> 
<h3 style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">3.PSY</span><span style="color:#4d4d4d;">属性</span></h3> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">power supply class</span><span style="color:#4d4d4d;">将所有可能</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">属性</span><span style="color:#4d4d4d;">(power_supply.h)</span><span style="color:#4d4d4d;">，以枚举型变量形式抽象出来，</span><span style="color:#4d4d4d;">PSY driver</span><span style="color:#4d4d4d;">可以根据设备的实际情况，从中选取一些。</span></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">enum power_supply_property {<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       /* Properties of type `int' */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_STATUS = 0, //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">该</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">的</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">status</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">，主要是充电状态，包括：</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">unknown,charging,discharging,not charging full,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_TYPE,//</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">充电类型</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_HEALTH, //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">健康状况，包括：</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">good dead  over voltage</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">等</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_PRESENT, //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">电量百分比</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_ONLINE,  //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">是否在线</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_AUTHENTIC,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TECHNOLOGY, //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">采用的技术</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CYCLE_COUNT,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_VOLTAGE_MAX,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_VOLTAGE_MIN,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_VOLTAGE_NOW,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_VOLTAGE_AVG,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_VOLTAGE_OCV,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CURRENT_MAX,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CURRENT_NOW,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CURRENT_AVG,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_POWER_NOW,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_POWER_AVG,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_EMPTY_DESIGN,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_FULL,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_EMPTY,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_NOW,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_AVG,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_COUNTER,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_CONTROL_LIMIT,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_CONTROL_LIMIT_MAX,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_ENERGY_FULL_DESIGN,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_ENERGY_EMPTY_DESIGN,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_ENERGY_FULL,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_ENERGY_EMPTY,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_ENERGY_NOW,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_ENERGY_AVG,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CAPACITY, /* in percents! */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CAPACITY_ALERT_MIN, /* in percents! */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CAPACITY_ALERT_MAX, /* in percents! */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CAPACITY_LEVEL, //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">容量</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TEMP,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TEMP_ALERT_MIN,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TEMP_ALERT_MAX,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TEMP_AMBIENT,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TEMP_AMBIENT_ALERT_MIN,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TEMP_AMBIENT_ALERT_MAX,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TIME_TO_EMPTY_AVG,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TIME_TO_FULL_NOW,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TIME_TO_FULL_AVG,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_TYPE, /* use power_supply.type instead */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_SCOPE,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       /* Local extensions */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_USB_HC,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_USB_OTG,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_ENABLED,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       /* Local extensions of type int64_t */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_CHARGE_COUNTER_EXT,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       /* Properties of type `const char *' */</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_MODEL_NAME,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_MANUFACTURER,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_PROP_SERIAL_NUMBER,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">};</span></span></li></ol> 
<h3 style="margin-left:.0001pt;text-align:left;"><a name="t3"></a><strong><span style="color:#4f4f4f;">4.</span></strong><strong><span style="color:#4f4f4f;">向具体的PSY driver提供的API</span></strong></h3> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="color:#4d4d4d;">power supply class </span></strong><strong><span style="color:#4d4d4d;">首要任务，是向</span></strong><strong><span style="color:#4d4d4d;">PSY driver</span></strong><strong><span style="color:#4d4d4d;">提供统一的驱动编程接口</span></strong><span style="color:#4d4d4d;">，主要包括：</span></p> 
<h4 style="text-align:left;"><span style="color:#4d4d4d;">1.PSY </span><span style="color:#4d4d4d;">的</span><span style="color:#4d4d4d;">register/unregister API</span></h4> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">在</span><span style="color:#4d4d4d;">driver/power/power_supply_core.c</span><span style="color:#4d4d4d;">中</span></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">extern int </span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">power_supply_register</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">(struct device *parent,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">                               struct power_supply *psy);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">extern void</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;"> power_supply_unregister</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">(struct power_supply *psy);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">extern int</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;"> power_supply_powers</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">(struct power_supply *psy, struct device *dev);</span></span></li></ol> 
<h4 style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;"> 2.</span><span style="color:#ff0000;">PSY</span><span style="color:#ff0000;">状态改变时通知</span><span style="color:#ff0000;">power supply core</span><span style="color:#ff0000;">的</span><span style="color:#ff0000;">API</span></h4> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">extern void </span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">power_supply_changed</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">(struct power_supply *psy);</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#ff0000;">当</span><span style="color:#ff0000;">PSY driver</span><span style="color:#ff0000;">检测到该设备某些</span><strong><span style="color:#ff0000;">属性改变</span></strong><span style="color:#ff0000;">时，需要</span><strong><span style="color:#ff0000;">调用这个接口</span></strong><strong>(</strong><span style="background-color:#fafafa;"><span style="color:#ff0000;">power_supply_changed</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">(struct power_supply *psy)</span></span><strong><span style="background-color:#fafafa;"><span style="color:#383a42;">)</span></span></strong><span style="color:#ff0000;">，通知</span><span style="color:#ff0000;">power supply core</span><span style="color:#ff0000;">，</span><span style="color:#ff0000;">power supply core</span><span style="color:#ff0000;">会有如下动作</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#ff0000;">如果该</span><span style="color:#ff0000;">PSY</span><span style="color:#ff0000;">是其他</span><span style="color:#ff0000;">PSY</span><span style="color:#ff0000;">的供电源，调用这些</span><span style="color:#ff0000;">PSY</span><span style="color:#ff0000;">的</span><span style="color:#ff0000;">external_power_changed</span><span style="color:#ff0000;">回调函数，通知他们（这些</span><span style="color:#ff0000;">PSY</span><span style="color:#ff0000;">具体要做什么，由他们自身的逻辑决定）；</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#ff0000;">发生</span><span style="color:#ff0000;">notifier</span><span style="color:#ff0000;">通知那些关心</span><span style="color:#ff0000;">PSY</span><span style="color:#ff0000;">设备状态的</span><span style="color:#ff0000;">drivers</span><span style="color:#ff0000;">；</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="color:#ff0000;">以统一的格式向用户空间发送</span></strong><strong><span style="color:#ff0000;">uevent</span></strong><span style="color:#ff0000;">。（这就是设备模型中</span><span style="color:#ff0000;">class</span><span style="color:#ff0000;">的魅力，对外接口由</span><span style="color:#ff0000;">class core</span><span style="color:#ff0000;">提供，可以节省</span><span style="color:#ff0000;">driver</span><span style="color:#ff0000;">的工作量，同时确保了接口的一致性）。</span></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">3.</span><span style="color:#4d4d4d;">其他杂项接口</span></h4> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#a626a4;">extern</span></span> <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply *power_supply_get_by_name(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">const</span></span> <span style="background-color:#fafafa;"><span style="color:#a626a4;">char</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> *name); </span></span><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">通过名字获取</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">指针</span></span></em></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#a626a4;">extern</span></span> <span style="background-color:#fafafa;"><span style="color:#a626a4;">int</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_am_i_supplied(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply *psy);</span></span><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">查询自己是否由其他</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">供电</span></span></em></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#a626a4;">extern</span></span> <span style="background-color:#fafafa;"><span style="color:#a626a4;">int</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_set_battery_charged(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply *psy);</span></span><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">调用指定的</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">的</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">set_changed</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">回调。</span></span></em></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#a626a4;">extern</span></span> <span style="background-color:#fafafa;"><span style="color:#a626a4;">int</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_is_system_supplied(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">void</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">); </span></span><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">检查系统中是否有有效的或者处于</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">online</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">状态的</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">，如果没有，可能为桌面系统、</span></span></em></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#a626a4;">extern</span></span> <span style="background-color:#fafafa;"><span style="color:#a626a4;">int</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply_powers(</span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> power_supply *psy, </span></span><span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> device *dev);</span></span><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">//</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">在指定的设备的</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">sysfs</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">目录下创建指定的</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">PSY</span></span></em><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">符合连接。</span></span></em></li></ol> 
<h3 style="margin-left:.0001pt;text-align:left;"><strong><span style="color:#4d4d4d;">5.</span><span style="color:#4d4d4d;">向用户空间提供的</span><span style="color:#4d4d4d;">API</span></strong></h3> 
<p style="margin-left:.0001pt;text-align:left;"><strong><span style="color:#ff0000;">power supply class</span></strong><strong><span style="color:#ff0000;">通过两种形式向用户空间提供接口。</span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">  </span><span style="color:#ff0000;">1）uevent，以“名字</span><span style="color:#ff0000;">=value”</span><span style="color:#ff0000;">的形式，上报所有</span><span style="color:#ff0000;">property</span><span style="color:#ff0000;">的值，格式如下：</span></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">POWER_SUPPLY_NAME=xxx                     <em>/* power supply name */</em> </span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">POWER_SUPPLY_xxx1=xxx                       <em>/* property = value */</em> </span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">POWER_SUPPLY_xxx2=xxx </span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">uevent</span><span style="color:#4d4d4d;">一般会在</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">设备添加到</span><span style="color:#4d4d4d;">kernel</span><span style="color:#4d4d4d;">时，或者</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">属性发生改变时发生。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">   2</span><span style="color:#4d4d4d;">）sysfs，power supply class</span><span style="color:#4d4d4d;">在</span><span style="color:#4d4d4d;">power_supply_sysfs.c</span><span style="color:#4d4d4d;">中，定义了相当多的默认</span><span style="color:#4d4d4d;">attribute</span><span style="color:#4d4d4d;">，如果某个</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">设备具有某个属性，该属性对应的</span><span style="color:#4d4d4d;">attribute</span><span style="color:#4d4d4d;">就会体现在</span><span style="color:#4d4d4d;">sysfs</span><span style="color:#4d4d4d;">中（一般位于</span><span style="color:#4d4d4d;">“/sys/class/power_supply/xxx/”</span><span style="color:#4d4d4d;">中）</span></p> 
<ol><li style="text-align:left;"><em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* Must be in the same order as POWER_SUPPLY_PROP_* */</span></span></em></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#a626a4;">static</span></span> <span style="background-color:#fafafa;"><span style="color:#a626a4;">struct</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;"> device_attribute power_supply_attrs[] = {<!-- --></span></span></li><li style="text-align:left;">       <em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* Properties of type `int' */</span></span></em></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(status),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_type),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(health),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(present),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(online),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(authentic),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(technology),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(cycle_count),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(voltage_max),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(voltage_min),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(voltage_max_design),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(voltage_min_design),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(voltage_now),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(voltage_avg),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(voltage_ocv),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(current_max),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(current_now),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(current_avg),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(power_now),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(power_avg),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_full_design),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_empty_design),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_full),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_empty),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_now),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_avg),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_counter),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(constant_charge_current),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(constant_charge_current_max),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(constant_charge_voltage),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(constant_charge_voltage_max),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_control_limit),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_control_limit_max),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(energy_full_design),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(energy_empty_design),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(energy_full),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(energy_empty),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(energy_now),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(energy_avg),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(capacity),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(capacity_alert_min),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(capacity_alert_max),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(capacity_level),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(temp),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(temp_alert_min),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(temp_alert_max),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(temp_ambient),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(temp_ambient_alert_min),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(temp_ambient_alert_max),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(time_to_empty_now),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(time_to_empty_avg),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(time_to_full_now),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(time_to_full_avg),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(type),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(scope),</span></span></li><li style="text-align:left;">       <em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* Local extensions */</span></span></em></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(usb_hc),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(usb_otg),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_enabled),</span></span></li><li style="text-align:left;">       <em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* Local extensions of type int64_t */</span></span></em></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(charge_counter_ext),</span></span></li><li style="text-align:left;">       <em><span style="background-color:#fafafa;"><span style="color:#a0a1a7;">/* Properties of type `const char *' */</span></span></em></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(model_name),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(manufacturer),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       POWER_SUPPLY_ATTR(serial_number),</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">};</span></span></li></ol> 
<h3 style="margin-left:.0001pt;text-align:left;"><a name="t4"></a><strong><span style="color:#4f4f4f;">6.</span></strong><strong><span style="color:#4f4f4f;">怎样基于power supply class编写PSY driver</span></strong></h3> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">最后从</span><span style="color:#4d4d4d;">PSY driver</span><span style="color:#4d4d4d;">的角度，说明一下怎么基于</span><span style="color:#4d4d4d;">power supply class</span><span style="color:#4d4d4d;">编写驱动：</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#ff0000;">（1</span><span style="color:#ff0000;">）</span><strong><span style="color:#ff0000;">根据硬件spec</span></strong><strong><span style="color:#ff0000;">，确定</span></strong><strong><span style="color:#ff0000;">PSY</span></strong><strong><span style="color:#ff0000;">设备具备哪些特性，并把他们和</span></strong><strong><span style="color:#ff0000;">enum power_supply_property</span></strong><strong><span style="color:#ff0000;">对应。</span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#ff0000;">（</span><span style="color:#ff0000;">2</span><span style="color:#ff0000;">）</span><strong><span style="color:#ff0000;">根据实际情况，实现这些</span></strong><strong><span style="color:#ff0000;">properties</span></strong><strong><span style="color:#ff0000;">的</span></strong><strong><span style="color:#ff0000;">get/set</span></strong><strong><span style="color:#ff0000;">接口。</span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#ff0000;">（</span><span style="color:#ff0000;">3</span><span style="color:#ff0000;">）</span><strong><span style="color:#ff0000;">定义一个</span></strong><strong><span style="color:#ff0000;">struct power_supply </span></strong><strong><span style="color:#ff0000;">变量，并初始化必要字段后，调用</span></strong><strong><span style="color:#ff0000;">power_supply_register</span></strong><strong><span style="color:#ff0000;">或者</span></strong><strong><span style="color:#ff0000;">power_supply_register_no_ws</span></strong><strong><span style="color:#ff0000;">，将其注册到</span></strong><strong><span style="color:#ff0000;">kernel</span></strong><strong><span style="color:#ff0000;">中。</span></strong></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#ff0000;">（</span><span style="color:#ff0000;">4</span><span style="color:#ff0000;">）</span><strong><span style="color:#ff0000;">根据实际情况，启动设备属性变化的监控逻辑，例如中断，轮询等，并在发生改变时，调用</span></strong><strong><span style="color:#ff0000;">power_supply_changed</span></strong><strong><span style="color:#ff0000;">，通知</span></strong><strong><span style="color:#ff0000;">power suopply core</span></strong><strong><span style="color:#ff0000;">。</span></strong></p> 
<h2 style="margin-left:.0001pt;text-align:justify;"></h2> 
<h2 style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#4f4f4f;">power supply</span></strong><strong><span style="color:#4f4f4f;">子系统的引入</span></strong></h2> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">以市面上一款常见的的平板方案来看一看，进入</span><strong><span style="color:#4d4d4d;">平板的</span></strong><span style="color:#4d4d4d;">sys/class/power_supply/</span><span style="color:#4d4d4d;">目录下</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="https://img-blog.csdn.net/20180525154253933?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTI4MzAxNDg=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" height="100" src="https://images2.imgbox.com/ba/75/gtYadigf_o.png" width="350"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">可以看到这里有<strong>三个</strong></span><strong><span style="color:#4d4d4d;">PSY</span></strong><strong><span style="color:#4d4d4d;">设备，分别对应</span></strong><strong><span style="color:#4d4d4d;">USB</span></strong><strong><span style="color:#4d4d4d;">充电器</span></strong><strong><span style="color:#4d4d4d;"> DC</span></strong><strong><span style="color:#4d4d4d;">充电器</span></strong><span style="color:#4d4d4d;">，和电池。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">进入</span><span style="color:#4d4d4d;">battery</span><span style="color:#4d4d4d;">目录下，发现下面有各种各样的属性，另外两个</span><span style="color:#4d4d4d;">atc260x-usb </span><span style="color:#4d4d4d;">、</span><span style="color:#4d4d4d;">atc260x-wall</span><span style="color:#4d4d4d;">目录下分别也是这样。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="https://img-blog.csdn.net/2018052515440585?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTI4MzAxNDg=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" height="336" src="https://images2.imgbox.com/b3/93/p3rwhhXr_o.png" width="554"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">那么在内核中肯定有三个驱动对应这个三个</span><span style="color:#4d4d4d;">PSY设备。</span></p> 
<h2 style="margin-left:.0001pt;text-align:justify;"><strong><span style="color:#4f4f4f;">PSY设备驱动分析</span></strong></h2> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">我们先以</span><strong><span style="color:#4d4d4d;">battery</span></strong><strong><span style="color:#4d4d4d;">驱动为例</span></strong><span style="color:#4d4d4d;">来分析。</span></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">static int __init atc260x_gauge_init(void)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">{<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       struct device_node *node =</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">              of_find_compatible_node(NULL, NULL, "actions,atc2603c-battery");//</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">获取设备树中对应的属性节点</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       if (!node) {<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">              GAUGE_INFO("%s fail to find atc2603c-battery node\n", __func__);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">              return 0;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       }</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       GAUGE_INFO("atc2603c_battery:version(%s), time stamp(%s)\n",</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">              ATC2603C_BATTERY_DRV_VERSION, ATC2603C_BATTERY_DRV_TIMESTAMP);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       return platform_driver_register(&amp;atc260x_gauge_driver);   //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">将</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">PSY</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">设备驱动注册为</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">platform</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">设备驱动</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">}</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">看看</span><span style="color:#4d4d4d;">atc260x_gauge_driver</span><span style="color:#4d4d4d;">的</span><span style="color:#4d4d4d;">probe</span><span style="color:#4d4d4d;">函数。</span></p> 
<ol><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">static  int atc260x_gauge_probe(struct platform_device *pdev)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">{<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   struct atc260x_gauge_info *info; //</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   int ret;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   info = kzalloc(sizeof(struct atc260x_gauge_info), GFP_KERNEL); //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">分配一个</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">atc260x_gauge_info</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   if (info == NULL)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">       return -ENOMEM;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   info-&gt;atc260x = atc260x;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   info-&gt;node = pdev-&gt;dev.of_node;   //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">一些初始化工作</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   global_gauge_info_ptr = info;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   first_store_gauge_info = 1;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   mutex_init(&amp;info-&gt;lock);</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">   platform_set_drvdata(pdev, info);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">/*init battery power supply*/     //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">这里就是</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">power supply</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">相关的了</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">info-&gt;battery.name = "battery";  //</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">这</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">name </span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">“</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">battery</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">”就是对应我们在</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">/sys/class/power_supply/</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">目录下看到的</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">battery</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">info-&gt;battery.use_for_apm = 1;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">info-&gt;battery.type = POWER_SUPPLY_TYPE_BATTERY; //</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">设备</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">type</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">info-&gt;battery.properties = atc260x_gauge_props; //</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">设置属性列表</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">info-&gt;battery.num_properties = ARRAY_SIZE(atc260x_gauge_props); //</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">设置属性列表的大小</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">info-&gt;battery.get_property = atc260x_gauge_get_props;  //</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">设置获取属性值的回调函数。</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">ret =<strong> power_supply_register(&amp;pdev-&gt;dev, &amp;info-&gt;battery); //</strong></span></span><strong><span style="background-color:#fafafa;"><span style="color:#ff0000;">将这个</span></span></strong><strong><span style="background-color:#fafafa;"><span style="color:#ff0000;">power_supply</span></span></strong><strong><span style="background-color:#fafafa;"><span style="color:#ff0000;">设备注册进内核中。</span></span></strong></li><li style="text-align:left;">        <span style="background-color:#fafafa;"><span style="color:#383a42;">。。。</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">//</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">其他电量计相关的省略</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">return ret;</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">}</span></span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">从上面可以看出</span> <span style="color:#ff0000;">编写</span><span style="color:#ff0000;">PSY driver</span><span style="color:#ff0000;">相当的简单。就调用了一个</span><span style="color:#ff0000;">power_supply_register</span><span style="color:#ff0000;">函数。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#ff0000;">后面再电量计的轮询函数中，如果检测到相关的属性发生了变化。就调用</span><span style="color:#ff0000;">power_supply_changed</span><span style="color:#ff0000;">函数，上报给</span><span style="color:#ff0000;">power supply core</span><span style="color:#ff0000;">。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">static void soc_post_process(struct atc260x_gauge_info *info)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">{<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        int soc_last;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (info-&gt;soc_pre != info-&gt;soc_show) {<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               info-&gt;soc_pre = info-&gt;soc_show;</span></span></li><li style="text-align:left;">               <span style="background-color:#fafafa;"><span style="color:#ff0000;">power_supply_changed(&amp;info-&gt;battery); //</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">如果</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">soc</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">发生了变化，则调用</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">power_supply_changed</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">上报变化信息。</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        }</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        info-&gt;bat_temp = get_battery_temperature();</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (info-&gt;pre_temp!= info-&gt;bat_temp) {<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               info-&gt;pre_temp = info-&gt;bat_temp;</span></span></li><li style="text-align:left;">               <span style="background-color:#fafafa;"><span style="color:#ff0000;">power_supply_changed(&amp;info-&gt;battery); //</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">如果温度发生了变化也进行上报</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        }</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">省略其他不相关的。。。</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">}</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">对于</span><span style="color:#4d4d4d;">USB </span><span style="color:#4d4d4d;">和</span><span style="color:#4d4d4d;">WALL </span><span style="color:#4d4d4d;">的</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">设备，其编程方法也是类似的，这里不再赘述。</span></p> 
<h4 style="margin-left:.0001pt;text-align:justify;"></h4> 
<h2 style="margin-left:0cm;"><span style="background-color:#ffffff;"><strong><span style="color:#4f4f4f;">power supply framework</span><span style="color:#4f4f4f;">的分析</span></strong></span></h2> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">先从</span><span style="color:#4d4d4d;">power_supply_register</span><span style="color:#4d4d4d;">分析起</span></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">int power_supply_register(struct device *parent, struct power_supply *psy)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">{<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        struct device *dev;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        int rc;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        dev = kzalloc(sizeof(*dev), GFP_KERNEL); //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">分配一个</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">device </span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">结构</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (!dev)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               return -ENOMEM;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        device_initialize(dev);</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        dev-&gt;class = power_supply_class;  //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">指定</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">power_supply_class</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        dev-&gt;type = &amp;power_supply_dev_type; //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">指定设备类型</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        dev-&gt;parent = parent;               //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">指定此设备的父设备</span></span>  </li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        dev-&gt;release = power_supply_dev_release;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        dev_set_drvdata(dev, psy);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        psy-&gt;dev = dev;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        INIT_WORK(&amp;psy-&gt;changed_work, power_supply_changed_work); //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">初始化一个</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">power_supply_changed_work </span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">工做队列</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        rc = power_supply_check_supplies(psy);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (rc) {<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               dev_info(dev, "Not all required supplies found, defer probe\n");</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               goto check_supplies_failed;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        }</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        rc = kobject_set_name(&amp;dev-&gt;kobj, "%s", psy-&gt;name);  //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">设置</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">kobject</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">的</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">name</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">，其实就是“</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">battery</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">”</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (rc)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               goto kobject_set_name_failed;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        rc = device_add(dev);  //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">将这个设备添加到设备链表中去</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (rc)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               goto device_add_failed;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        spin_lock_init(&amp;psy-&gt;changed_lock);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        rc = device_init_wakeup(dev, true);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (rc)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               goto wakeup_init_failed;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        rc = psy_register_thermal(psy);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (rc)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               goto register_thermal_failed;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        rc = psy_register_cooler(psy);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (rc)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               goto register_cooler_failed;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        rc = power_supply_create_triggers(psy);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (rc)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               goto create_triggers_failed;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        power_supply_changed(psy); //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">调用一次</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">changed</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">，上报一次属性值</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        goto success;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">}</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">接着看看</span><strong><span style="color:#ff0000;">power_supply_changed</span></strong></p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">void power_supply_changed(struct power_supply *psy)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">{<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        unsigned long flags;</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        dev_dbg(psy-&gt;dev, "%s\n", __func__);</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        spin_lock_irqsave(&amp;psy-&gt;changed_lock, flags);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        psy-&gt;changed = true;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        pm_stay_awake(psy-&gt;dev);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        spin_unlock_irqrestore(&amp;psy-&gt;changed_lock, flags);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#ff0000;">schedule_work(<strong>&amp;psy-&gt;changed_work</strong>); //</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">将</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">psy-&gt;changed_work</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">任务提交到工做队列，这个工做队列就是在</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">power_supply_register</span></span><span style="background-color:#fafafa;"><span style="color:#ff0000;">中初始化的</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">}</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">EXPORT_SYMBOL_GPL(power_supply_changed);</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">既然如此，那我们就应该继续去看</span><span style="color:#ff0000;">psy-&gt;changed_work</span><span style="color:#ff0000;">的工作队列函数。</span><span style="color:#ff0000;">power_supply_changed_work</span>​​​​​​​</p> 
<ol><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">static void power_supply_changed_work(struct work_struct *work)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">{<!-- --></span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        unsigned long flags;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        struct power_supply *psy = container_of(work, struct power_supply, //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">获取到</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">PSY</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">                                              changed_work);</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        dev_dbg(psy-&gt;dev, "%s\n", __func__);</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        spin_lock_irqsave(&amp;psy-&gt;changed_lock, flags);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (psy-&gt;changed) {                    //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">已经在</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">power_supply_changed</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">中被设置成</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">true</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">了。</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               psy-&gt;changed = false;</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               spin_unlock_irqrestore(&amp;psy-&gt;changed_lock, flags);</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               class_for_each_device(power_supply_class, NULL, psy,</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">                                     __power_supply_changed_work);</span></span></li><li style="text-align:left;"><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               power_supply_update_leds(psy);          //</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">更改</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">led</span></span><span style="background-color:#fafafa;"><span style="color:#383a42;">指示状态</span></span></li><li style="text-align:left;"><li style="text-align:left;">               <strong><span style="background-color:#fafafa;"><span style="color:#ff0000;">kobject_uevent(&amp;psy-&gt;dev-&gt;kobj, KOBJ_CHANGE); //</span></span></strong><strong><span style="background-color:#fafafa;"><span style="color:#ff0000;">发送</span></span></strong><strong><span style="background-color:#fafafa;"><span style="color:#ff0000;">uevent</span></span></strong><strong><span style="background-color:#fafafa;"><span style="color:#ff0000;">事件，通知应用层</span></span></strong></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               spin_lock_irqsave(&amp;psy-&gt;changed_lock, flags);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        }</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        if (!psy-&gt;changed)</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">               pm_relax(psy-&gt;dev);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">        spin_unlock_irqrestore(&amp;psy-&gt;changed_lock, flags);</span></span></li><li style="text-align:left;"><span style="background-color:#fafafa;"><span style="color:#383a42;">}</span></span></li></ol> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">至此，</span><span style="color:#ff0000;">每当驱动中计算出</span><span style="color:#ff0000;">battery</span><span style="color:#ff0000;">的电量信息发生了变化，或者充电器的插拔状态发生了变化，驱动都会调用</span><span style="color:#ff0000;">power_supply_changed函数，随后在power_supply_changed中会启动工作队列，上报uevent事件，通知Android层去sysfs中读取电池相关的属性信息，展现给用户空间。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">/drivers/power/supply/qcom/qpnp-smb5.c   charger driver</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">/drivers/power/supply/qcom/smb5-lib.c     </span><span style="color:#4d4d4d;">依赖的</span><span style="color:#4d4d4d;">SMB library</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4d4d4d;">/arch/arm64/boot/dts/qcom/pmi632.dtsi     dtsi</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="https://img-blog.csdnimg.cn/2019062811202677.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2J1cnRfeXU=,size_16,color_FFFFFF,t_70" height="489" src="https://images2.imgbox.com/40/e2/KlUHfwJg_o.png" width="554"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<h2 style="margin-left:0;"><span style="background-color:#ffffff;"><strong><span style="color:#222226;">高通平台power_supply 框架下添加第三方充电IC的驱动方法</span></strong></span></h2> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">原文链接：</span><span style="color:#4d4d4d;">https://blog.csdn.net/stoic163/article/details/99680422</span></p> 
<h3 style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">1.power_supply</span><span style="color:#4d4d4d;">电源框架介绍：</span></h3> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">power supply framework</span><span style="color:#4d4d4d;">在</span><span style="color:#4d4d4d;">kernel/drivers/power/</span><span style="color:#4d4d4d;">下。内核抽象出来</span><span style="color:#4d4d4d;">power supply</span><span style="color:#4d4d4d;">子系统为驱动提供了统一的框架。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">功能包括：</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">1.</span><span style="color:#4d4d4d;">抽象</span><span style="color:#4d4d4d;">PSY</span><span style="color:#4d4d4d;">设备的共性，向用户空间提供统一的</span><span style="color:#4d4d4d;">API；</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">2.</span><span style="color:#4d4d4d;">为底层</span><span style="color:#4d4d4d;">PSY驱动的编写，提供简单、统一的方式，同时封装并实现公共逻辑。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">power supply class</span><span style="color:#4d4d4d;">位于</span><span style="color:#4d4d4d;">drivers/power/</span><span style="color:#4d4d4d;">目录中，主要由</span><span style="color:#4d4d4d;">3部分组成（可参考下图的软件架构）：</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">1</span><span style="color:#4d4d4d;">）</span><span style="color:#4d4d4d;">power_supply_core</span><span style="color:#4d4d4d;">，用于</span><strong><span style="color:#ff0000;">抽象核心数据结构、实现公共逻辑</span></strong><span style="color:#4d4d4d;">。位于</span><span style="color:#4d4d4d;">drivers/power/power_supply_core.c中。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">2</span><span style="color:#4d4d4d;">）</span><span style="color:#4d4d4d;">power_supply_sysfs</span><span style="color:#4d4d4d;">，</span><strong><span style="color:#ff0000;">实现</span></strong><strong><span style="color:#ff0000;">sysfs</span></strong><strong><span style="color:#ff0000;">以及</span></strong><strong><span style="color:#ff0000;">uevent</span></strong><strong><span style="color:#ff0000;">功能</span></strong><strong><span style="color:#4d4d4d;">。</span></strong><span style="color:#4d4d4d;">位于</span><span style="color:#4d4d4d;">drivers/power/power_supply_sysfs.c中。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">3</span><span style="color:#4d4d4d;">）</span><span style="color:#4d4d4d;">power_supply_leds</span><span style="color:#4d4d4d;">，基于</span><span style="color:#4d4d4d;">Linux led class</span><span style="color:#4d4d4d;">，<strong>提</strong></span><strong><span style="color:#ff0000;">供</span></strong><strong><span style="color:#ff0000;">PSY</span></strong><strong><span style="color:#ff0000;">设备状态指示</span></strong><span style="color:#4d4d4d;">的通用实现。位于</span><span style="color:#4d4d4d;">drivers/power/power_suppply_leds.c</span><span style="color:#4d4d4d;">中。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">最后，驱动工程师可以<strong>基于</strong></span><strong><span style="color:#4d4d4d;">power supply class</span></strong><span style="color:#4d4d4d;">，<strong>实现具体的</strong></span><strong><span style="color:#4d4d4d;">PSY drivers</span></strong><span style="color:#4d4d4d;">，主要处理平台相关、硬件相关的逻辑。</span><span style="color:#ff0000;">这些</span><span style="color:#ff0000;">drivers</span><span style="color:#ff0000;">都位于</span><span style="color:#ff0000;">drivers/power/power_supply目录下。</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">在具体设备文件中在</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">/sys/class/power_supply,</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">具体如下：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="https://img-blog.csdnimg.cn/20190816161208575.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0b2ljMTYz,size_16,color_FFFFFF,t_70" height="228" src="https://images2.imgbox.com/12/4f/rWTm2lfM_o.png" width="554"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#5b9bd5;">power_supply </span><span style="color:#4d4d4d;">框架工作流程</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="color:#4d4d4d;">Linux</span><span style="color:#4d4d4d;">的设备文件目录中可以在</span><span style="color:#4d4d4d;">sys/class/</span><span style="color:#4d4d4d;">下看到</span><span style="color:#4d4d4d;">power_supply</span><span style="color:#4d4d4d;">目录；</span><span style="color:#ff0000;">这个</span><span style="color:#ff0000;">power_supply</span><span style="color:#ff0000;">的类是通过</span><span style="color:#ff0000;">power_supply_core.c</span><span style="color:#ff0000;">文件中的</span><span style="color:#ff0000;">power_supply_class_init()</span><span style="color:#ff0000;">中的</span><span style="color:#ff0000;">class_create()</span><span style="color:#ff0000;">函数来进行</span><span style="color:#ff0000;">power_supply</span><span style="color:#ff0000;">类的创建</span><span style="color:#4d4d4d;">，如下：</span></p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="https://img-blog.csdnimg.cn/20190816161208575.png" height="228" src="https://images2.imgbox.com/8b/25/ZvYQpgy4_o.png" width="554"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">进入</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">power_supply</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">的目录下：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="https://img-blog.csdnimg.cn/20190816161208573.png" height="32" src="https://images2.imgbox.com/8c/3a/hsdi0Eys_o.png" width="299"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">我们可以看到出现了</span><span style="color:#4d4d4d;">battery</span><span style="color:#4d4d4d;">与</span><span style="color:#4d4d4d;">usb</span><span style="color:#4d4d4d;">两个目录，这两个目录就是充电</span><span style="color:#4d4d4d;">IC(battery)</span><span style="color:#4d4d4d;">与</span><span style="color:#4d4d4d;">USB(usb)</span><span style="color:#4d4d4d;">电源管理部分的注册的设备节点内容的集合。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">进入</span><span style="color:#4d4d4d;">battery</span><span style="color:#4d4d4d;">目录下</span><span style="color:#4d4d4d;">:</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161208572.png" height="80" src="https://images2.imgbox.com/89/53/kUbHWnT4_o.png" width="523"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">可以看到很多设备节点，这些节点就是通过</span><span style="color:#4d4d4d;">power_supply</span><span style="color:#4d4d4d;">的电源框架提供的方法进行注册并实现其内容的。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">对于上述的节点内容，是怎么实现的，其实</span><span style="color:#4d4d4d;">power_supply</span><span style="color:#4d4d4d;">都提供了相应的节点名称，在文件</span><span style="color:#4d4d4d;">/kernel/include/linux/</span><span style="color:#ff0000;">power_supply.h</span><span style="color:#4d4d4d;">中提供了相关的</span><strong><span style="color:#ff0000;">属性</span></strong><span style="color:#4d4d4d;">枚举定义。如下：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161208711.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0b2ljMTYz,size_16,color_FFFFFF,t_70" height="429" src="https://images2.imgbox.com/47/52/LkRkqV0B_o.png" width="554"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">这里提供了大部分的设备节点属性。作为驱动工程师，只需要选取芯片存在的并且自己需要的属性并实现其内容即可。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">在</span><span style="color:#4d4d4d;">power_supply</span><span style="color:#4d4d4d;">的结构体中</span><span style="color:#4d4d4d;">(</span><span style="color:#4d4d4d;">也可能是在结构体之外</span><span style="color:#4d4d4d;">)</span><span style="color:#4d4d4d;">：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="370" src="https://images2.imgbox.com/6e/cd/V6tK8qvY_o.png" width="554"></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">在这个结构体中，可以看到有</span></span><strong><span style="background-color:#ffffff;"><span style="color:#ff0000;">set_property</span></span></strong><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">与</span></span><strong><span style="background-color:#ffffff;"><span style="color:#ff0000;">get_property</span></span></strong><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">两个属性的函数指针</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">，这两个函数指针就是用来具体</span></span><strong><span style="background-color:#ffffff;"><span style="color:#ff0000;">实现相关属性</span></span></strong><span style="background-color:#ffffff;"><span style="color:#ff0000;">功能的。</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><a name="power_supply_sysfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><strong><span style="color:#4ea1db;">power_supply_sysfy</span></strong></a><strong><span style="color:#4d4d4d;">文件系统</span></strong></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#ff0000;">power_supply_</span><strong><span style="color:#ff0000;">sysfs.c</span></strong><span style="color:#4d4d4d;">文件中，具体进行的</span><strong><span style="color:#ff0000;">是</span></strong><strong><span style="color:#ff0000;">设备节点</span></strong><strong><span style="color:#ff0000;">的</span></strong><strong><span style="color:#ff0000;">注册过程</span></strong><span style="color:#4d4d4d;">，以及相关功能的实现：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161208621.png" height="97" src="https://images2.imgbox.com/b4/c7/UxLMeYK2_o.png" width="554"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">从上面可以看出，</span><strong><span style="color:#ff0000;">在</span></strong><strong><span style="color:#ff0000;">power_supply_sysfs</span></strong><strong><span style="color:#ff0000;">文件中主要是实现</span></strong><strong><span style="color:#ff0000;">power_supply_attrs</span></strong><strong><span style="color:#ff0000;">数组中的成员的</span></strong><strong><span style="color:#ff0000;">show</span></strong><strong><span style="color:#ff0000;">与</span></strong><strong><span style="color:#ff0000;">store</span></strong><strong><span style="color:#ff0000;">。</span></strong></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">先看</span><span style="color:#4d4d4d;">power_supply_attrs</span><span style="color:#4d4d4d;">数组<strong>：</strong></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161208732.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0b2ljMTYz,size_16,color_FFFFFF,t_70" height="468" src="https://images2.imgbox.com/0b/32/5D39vurq_o.png" width="553"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">从上述内容看，</span><span style="color:#4d4d4d;">power_supply_attrs</span><span style="color:#4d4d4d;">数组其实就是实现之前</span><span style="color:#4d4d4d;">power_supply.h</span><span style="color:#4d4d4d;">文件中的枚举</span><span style="color:#4d4d4d;">power_supply_property</span><span style="color:#4d4d4d;">。</span><span style="color:#ff0000;">而</span><span style="color:#ff0000;">POWER_SUPPLY_ATTR(online)</span><span style="color:#ff0000;">中括号内容即是具体设备节点。</span></span>​​​​​​​</p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">在</span><span style="color:#4d4d4d;">POWER_SUPPLY_ATTR</span><span style="color:#4d4d4d;">结构体中，有</span><span style="color:#4d4d4d;">show</span><span style="color:#4d4d4d;">与</span><span style="color:#4d4d4d;">store</span><span style="color:#4d4d4d;">两个指针。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">show</span><span style="color:#4d4d4d;">的内容就是使用</span><span style="color:#4d4d4d;">cat  xxxx</span><span style="color:#4d4d4d;">节点的操作显示出来的内容的：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161208729.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0b2ljMTYz,size_16,color_FFFFFF,t_70" height="480" src="https://images2.imgbox.com/69/fe/G5MjjyKC_o.png" width="554"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">从上面可以看到有些节点显示的内容并不是数字，而是在</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">show</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">函数中被转换成了相关的字符串。如</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">:</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161208663.png" height="108" src="https://images2.imgbox.com/f7/b5/knF0RUMk_o.png" width="554"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">而</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">store</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">函数是</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">echo xx &gt; xxx</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">节点的操作写入的内容。</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161208664.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0b2ljMTYz,size_16,color_FFFFFF,t_70" height="286" src="https://images2.imgbox.com/1b/8c/HcDGbqnO_o.png" width="554"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">在上述节点中，存在</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">uevent</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">这个节点，可以看看</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">uevent</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">节点的内容：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161208667.png" height="166" src="https://images2.imgbox.com/1a/3f/Sx8XddOr_o.png" width="554"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#ff0000;">这个节点由</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">power_supply_sysfs</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">文件中的</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">power_supply_uevent</span></span><span style="background-color:#ffffff;"><span style="color:#ff0000;">函数实现的。</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161209721.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0b2ljMTYz,size_16,color_FFFFFF,t_70" height="601" src="https://images2.imgbox.com/03/c5/YFKilJLS_o.png" width="554"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#ff0000;">这个函数的作用就是将该设备节点下所有节点的内容组合成字符串发送到</span><span style="color:#ff0000;">uevent</span><span style="color:#ff0000;">中，在通过内核的</span><span style="color:#ff0000;">uevent</span><span style="color:#ff0000;">框架发送到用户空间。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#ff0000;">当设备节点内容发生变化时，会调用</span><span style="color:#ff0000;">power_supply_changed</span><span style="color:#ff0000;">函数：</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161208690.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0b2ljMTYz,size_16,color_FFFFFF,t_70" height="174" src="https://images2.imgbox.com/b6/cd/IdWrAWRR_o.png" width="554"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">可以看到该函数是将</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">psy-&gt;changed_work</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">加入到工作队列中，具体的调用设备的</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">changed_work</span></span><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">的工作队列，看看具体做什么：</span></span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><img alt="https://img-blog.csdnimg.cn/20190816161209685.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0b2ljMTYz,size_16,color_FFFFFF,t_70" height="387" src="https://images2.imgbox.com/f1/06/jsf548VH_o.png" width="553"></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">可以看到，</span><span style="color:#ff0000;">对该类中查询每个设备的更新操作，再更新</span><span style="color:#ff0000;">led</span><span style="color:#ff0000;">灯的操作，还有就是发送新的事件</span><span style="color:#ff0000;">(uevent)</span><span style="color:#ff0000;">通知应用层。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"><span style="background-color:#ffffff;"><span style="color:#4d4d4d;">至此</span><span style="color:#4d4d4d;">power_supply</span><span style="color:#4d4d4d;">就介绍结束了。</span></span></p> 
<p style="margin-left:.0001pt;text-align:left;"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f0af7e490ddd5500c7d3d3cfca9b6c0b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Windows10启动Docker报错：Hardware assisted virtualization and data execution protection must enabled BIOS</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8581d9811fd10666fe60fcf4e9ab1a91/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Excel如何制作动态模糊匹配的下拉菜单？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>