<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nacos注册中心集群数据一致性问题 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Nacos注册中心集群数据一致性问题" />
<meta property="og:description" content="Nacos集群数据一致性问题 一、集群架构1.1 Master - Slave1.2 Leader - Follower 二、Nacos注册中心集群架构2.1 DistroConsistencyServiceImpl2.1.1 init() 方法2.1.2 load() 方法2.1.3 Notifier 线程(事件监听)2.1.4 put(String key, Record value) 方法2.1.5 TaskDispatcher2.1.6 DataSyncer2.1.7 Nacos 分区一致性算法总结 2.2 RaftConsistencyServiceImpl2.2.1 Raft算法2.2.2 Nacos中Raft算法的具体实现2.2.2.1 RaftPeerSet(Leader选举)2.2.2.2 RaftCore1. RaftCore init()2. Notifier 线程(事件监听)3. MasterElection 线程(投票选举)4. HeartBeat 线程(心跳检测)5. RaftCore.signalPublish() 2.2.3 Nacos Raft算法总结 文章系列
【一、Nacos-配置中心原理解析】
【二、Nacos-配置中心原理解析】
【三、Nacos注册中心集群数据一致性问题】
一、集群架构 1.1 Master - Slave 也就是我们说的主从复制，主机的数据更新后根据配置和策略，自动同步到备机的master/slave机制，当主节点宕机后，集群会根据某种分布式一致性协议(Raft、gossip协议、ZAB协议等)选举出新的Master节点。
Master负责读写，Slave只负责读。
在很多组件中都有使用这种思想，比如Mysql主从架构、Redis主从架构、kafka里面的数据副本机制等等。
常见的主从复制架构有：
一主多从
主主复制
级联复制
多主一从
1.2 Leader - Follower 这也是比较常见的集群架构，各自职责如下：
Leader：领导者，主要的工作任务有两项
事物请求的唯一调度和处理者，保证集群事物处理的顺序性集群内部各服务器的调度者 Follower：跟随者，主要职责是
处理客户端非事物请求、转发事物请求给 Leader 服务器参与事物请求的投票，如Zookeeper半数以上Follower通过才能通知 Leader commit数据参与Leader选举的投票 在很多组件中都有使用这种思想，比如ZooKeeper集群等等。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/4a5b34257e884dd1615de3f26ed2cce0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-03T23:09:51+08:00" />
<meta property="article:modified_time" content="2022-09-03T23:09:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nacos注册中心集群数据一致性问题</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Nacos集群数据一致性问题</h4> 
 <ul><li><a href="#_8" rel="nofollow">一、集群架构</a></li><li><ul><li><a href="#11_Master__Slave_9" rel="nofollow">1.1 Master - Slave</a></li><li><a href="#12_Leader__Follower_29" rel="nofollow">1.2 Leader - Follower</a></li></ul> 
  </li><li><a href="#Nacos_43" rel="nofollow">二、Nacos注册中心集群架构</a></li><li><ul><li><a href="#21_DistroConsistencyServiceImpl_139" rel="nofollow">2.1 DistroConsistencyServiceImpl</a></li><li><ul><li><a href="#211_init__156" rel="nofollow">2.1.1 init() 方法</a></li><li><a href="#212_load__184" rel="nofollow">2.1.2 load() 方法</a></li><li><a href="#213_Notifier__298" rel="nofollow">2.1.3 Notifier 线程(事件监听)</a></li><li><a href="#214_putString_key_Record_value__387" rel="nofollow">2.1.4 put(String key, Record value) 方法</a></li><li><a href="#215_TaskDispatcher_421" rel="nofollow">2.1.5 TaskDispatcher</a></li><li><a href="#216_DataSyncer_546" rel="nofollow">2.1.6 DataSyncer</a></li><li><a href="#217_Nacos__728" rel="nofollow">2.1.7 Nacos 分区一致性算法总结</a></li></ul> 
   </li><li><a href="#22_RaftConsistencyServiceImpl_731" rel="nofollow">2.2 RaftConsistencyServiceImpl</a></li><li><ul><li><a href="#221_Raft_737" rel="nofollow">2.2.1 Raft算法</a></li><li><a href="#222_NacosRaft_767" rel="nofollow">2.2.2 Nacos中Raft算法的具体实现</a></li><li><ul><li><a href="#2221_RaftPeerSetLeader_879" rel="nofollow">2.2.2.1 RaftPeerSet(Leader选举)</a></li><li><a href="#2222_RaftCore_1211" rel="nofollow">2.2.2.2 RaftCore</a></li><li><ul><li><a href="#1_RaftCore_init_1214" rel="nofollow">1. RaftCore init()</a></li><li><a href="#2_Notifier__1262" rel="nofollow">2. Notifier 线程(事件监听)</a></li><li><a href="#3_MasterElection__1380" rel="nofollow">3. MasterElection 线程(投票选举)</a></li><li><a href="#4_HeartBeat__1532" rel="nofollow">4. HeartBeat 线程(心跳检测)</a></li><li><a href="#5_RaftCoresignalPublish_1905" rel="nofollow">5. RaftCore.signalPublish()</a></li></ul> 
    </li></ul> 
    </li><li><a href="#223_Nacos_Raft_2000" rel="nofollow">2.2.3 Nacos Raft算法总结</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p><strong>文章系列</strong></p> 
<p>【<a href="https://blog.csdn.net/qq_33375499/article/details/125703382">一、Nacos-配置中心原理解析</a>】<br> 【<a href="https://blog.csdn.net/qq_33375499/article/details/125710182">二、Nacos-配置中心原理解析</a>】<br> 【<a href="https://blog.csdn.net/qq_33375499/article/details/125774062">三、Nacos注册中心集群数据一致性问题</a>】</p> 
<h2><a id="_8"></a>一、集群架构</h2> 
<h3><a id="11_Master__Slave_9"></a>1.1 Master - Slave</h3> 
<p>也就是我们说的主从复制，主机的数据更新后根据配置和策略，自动同步到备机的master/slave机制，当主节点宕机后，集群会根据某种分布式一致性协议(Raft、gossip协议、ZAB协议等)选举出新的Master节点。</p> 
<p><strong>Master负责读写，Slave只负责读</strong>。</p> 
<p>在很多组件中都有使用这种思想，比如Mysql主从架构、Redis主从架构、kafka里面的数据副本机制等等。</p> 
<p><strong>常见的主从复制架构有：</strong></p> 
<ol><li> <p>一主多从<br> <img src="https://images2.imgbox.com/92/09/Gr7lHERS_o.png" alt="在这里插入图片描述"></p> </li><li> <p>主主复制<br> <img src="https://images2.imgbox.com/be/4e/8Yx7Tpwi_o.png" alt="在这里插入图片描述"></p> </li><li> <p>级联复制<br> <img src="https://images2.imgbox.com/a8/39/BDgfSPvL_o.png" alt="在这里插入图片描述"></p> </li><li> <p>多主一从<br> <img src="https://images2.imgbox.com/ca/b6/Yc7MQNbT_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="12_Leader__Follower_29"></a>1.2 Leader - Follower</h3> 
<p>这也是比较常见的集群架构，各自职责如下：</p> 
<ul><li> <p>Leader：领导者，主要的工作任务有两项</p> 
  <ol><li>事物请求的唯一调度和处理者，保证集群事物处理的顺序性</li><li>集群内部各服务器的调度者</li></ol> </li><li> <p>Follower：跟随者，主要职责是</p> 
  <ol><li>处理客户端非事物请求、转发事物请求给 Leader 服务器</li><li>参与事物请求的投票，如Zookeeper半数以上Follower通过才能通知 Leader commit数据</li><li>参与Leader选举的投票</li></ol> </li></ul> 
<p>在很多组件中都有使用这种思想，比如ZooKeeper集群等等。</p> 
<h2><a id="Nacos_43"></a>二、Nacos注册中心集群架构</h2> 
<p>Nacos 注册中心集群架构采用了Leader - Follower模式，在Nacos Server服务启动过程中，会选举出一个Leader节点，如果在运行过程中，Leader节点宕机，服务会进入不可用状态，直到选举出新的Leader节点。</p> 
<p>Nacos 提供了顶层的一致性服务类：ConsistencyService，所有的一致性算法实现，都必须实现 ConsistencyService 接口，Nacos内部根据临时节点和持久化节点，分别实现了对应两种一致性协议，整体类关系图如下：<br> <img src="https://images2.imgbox.com/a7/c9/5WVGHMLc_o.png" alt="在这里插入图片描述"><br> 其中，ConsistencyService 直接实现类或接口有三个：EphemeralConsistencyService、PersistentConsistencyService、DelegateConsistencyServiceImpl，其中 DelegateConsistencyServiceImpl采用了委派设计模式，内部存在EphemeralConsistencyService、PersistentConsistencyService两个成员变量，根据key判断，采用哪种一致性协议。</p> 
<ul><li>EphemeralConsistencyService：临时节点一致性协议，临时数据与服务器同生共死，即只要会话仍然存在，临时数据就不会丢失。</li><li>PersistentConsistencyService：持久化节点一致性协议，保证已发布数据的 CP 一致性的一致性协议。</li></ul> 
<p><strong>DelegateConsistencyServiceImpl代码实现如下：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"consistencyDelegate"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelegateConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ConsistencyService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">PersistentConsistencyService</span> persistentConsistencyService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">EphemeralConsistencyService</span> ephemeralConsistencyService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 根据key判断，采用哪种一致性协议，然后调用其put方法</span>
        <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 根据key判断，采用哪种一致性协议，然后调用其remove方法</span>
        <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Datum</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 根据key判断，采用哪种一致性协议，然后调用其get方法</span>
        <span class="token keyword">return</span> <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">RecordListener</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">// this special key is listened by both:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span>SERVICE_META_KEY_PREFIX<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            persistentConsistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ephemeralConsistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    	<span class="token comment">// 根据key判断，采用哪种一致性协议，然后调用其listen方法</span>
        <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlisten</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">RecordListener</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 根据key判断，采用哪种一致性协议，然后调用其unlisten方法</span>
        <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlisten</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 判断协议可用状态</span>
        <span class="token keyword">return</span> ephemeralConsistencyService<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> persistentConsistencyService<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 根据key判断，采用哪种一致性协议</span>
    <span class="token keyword">private</span> <span class="token class-name">ConsistencyService</span> <span class="token function">mapConsistencyService</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 判断key是否以 com.alibaba.nacos.naming.iplist.ephemeral.  开头，如果是，返回true</span>
		<span class="token comment">// 即 以 com.alibaba.nacos.naming.iplist.ephemeral.  开头的采用 ephemeralConsistencyService 一致性算法</span>
		<span class="token comment">// 否则采用 persistentConsistencyService 一致性算法</span>
        <span class="token keyword">return</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchEphemeralKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> ephemeralConsistencyService <span class="token operator">:</span> persistentConsistencyService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中 <code>KeyBuilder.matchEphemeralKey(key)</code> 逻辑如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeyBuilder</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">matchEphemeralKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// currently only instance list has ephemeral type:</span>
		<span class="token comment">// 判断key是否以 com.alibaba.nacos.naming.iplist.ephemeral.  开头，如果是，返回true</span>
        <span class="token keyword">return</span> <span class="token function">matchEphemeralInstanceListKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">matchEphemeralInstanceListKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 判断key是否以 com.alibaba.nacos.naming.iplist.ephemeral.  开头，如果是，返回true</span>
        <span class="token keyword">return</span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>INSTANCE_LIST_KEY_PREFIX <span class="token operator">+</span> EPHEMERAL_KEY_PREFIX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>DelegateConsistencyServiceImpl 类的主要作用是：判断key是否以 <code>com.alibaba.nacos.naming.iplist.ephemeral.</code> 开头，如果是，采用 ephemeralConsistencyService 一致性算法，否则采用 persistentConsistencyService 一致性算法。</p> 
<h3><a id="21_DistroConsistencyServiceImpl_139"></a>2.1 DistroConsistencyServiceImpl</h3> 
<p>DistroConsistencyServiceImpl 为 EphemeralConsistencyService 的唯一实现，如下：<br> <img src="https://images2.imgbox.com/d4/9a/UCiK1Ukz_o.png" alt="在这里插入图片描述"></p> 
<p>DistroConsistencyServiceImpl 临时节点一致性协议采用一种<strong>分区</strong>的一致性协议算法，该算法的特点如下：</p> 
<ul><li>将数据划分为许多块，每个 Nacos 服务器节点只负责一个数据块。</li><li>每个数据块都由其负责的服务器生成、删除和同步。</li><li>每个 Nacos 服务器只处理总服务数据的一个<strong>子集</strong>的写入。</li><li>每个 Nacos 服务器都会接收到其他 Nacos 服务器的数据同步。</li></ul> 
<p>最终每个 Nacos 服务器最终都会有一套完整的数据。</p> 
<p>分区 / 分片 / 分段 在很多中间件或底层源码都要体现，例如Java 7中的 ConcurrentHashMap中的 Segment、Redis集群架构的Hash槽、Kafka中的数据分片、RocketMa中的读写队列等等。</p> 
<p>DistroConsistencyServiceImpl 的类结构比较简单，如下：<br> <img src="https://images2.imgbox.com/88/13/fAFp4znx_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="211_init__156"></a>2.1.1 init() 方法</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@org.springframework.stereotype.Service</span><span class="token punctuation">(</span><span class="token string">"distroConsistencyService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistroConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">EphemeralConsistencyService</span> <span class="token punctuation">{<!-- --></span>

	<span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 执行一个线程</span>
        <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">// 尝试加载所有服务中的数据，缓存到本地。</span>
                    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"load data failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 执行 Notifier线程</span>
        executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>notifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="212_load__184"></a>2.1.2 load() 方法</h4> 
<p>尝试加载所有服务中的数据，缓存到本地。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@org.springframework.stereotype.Service</span><span class="token punctuation">(</span><span class="token string">"distroConsistencyService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistroConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">EphemeralConsistencyService</span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 如果是单机模式</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">SystemUtils</span><span class="token punctuation">.</span>STANDALONE_MODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// size = 1 means only myself in the list, we need at least one another server alive:</span>
        <span class="token comment">// size = 1 表示列表中只有我自己，至少需要另一台服务器</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>serverListManager<span class="token punctuation">.</span><span class="token function">getHealthyServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"waiting server list init..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 遍历健康的服务列表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server <span class="token operator">:</span> serverListManager<span class="token punctuation">.</span><span class="token function">getHealthyServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"sync from "</span> <span class="token operator">+</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// try sync data from remote server:</span>
            <span class="token comment">// 尝试从远程服务器同步数据</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">syncAllDataFromRemote</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 尝试从远程服务器同步数据</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">syncAllDataFromRemote</span><span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 获取Server中所有实例数据 server.getKey() -&gt; ip:port</span>
        	<span class="token comment">// 发送 /v1/ns/distro/datums 请求，获取所有实例数据</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token class-name">NamingProxy</span><span class="token punctuation">.</span><span class="token function">getAllData</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 处理数据</span>
            <span class="token function">processData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"sync full data from "</span> <span class="token operator">+</span> server <span class="token operator">+</span> <span class="token string">" failed!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 处理数据</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 解码</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Datum</span><span class="token punctuation">&lt;</span><span class="token class-name">Instances</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> datumMap <span class="token operator">=</span>
                serializer<span class="token punctuation">.</span><span class="token function">deserializeMap</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">Instances</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Datum</span><span class="token punctuation">&lt;</span><span class="token class-name">Instances</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> datumMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">// 存储数据</span>
                dataStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 发送事件监听</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listeners<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// pretty sure the service not exist:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>switchDomain<span class="token punctuation">.</span><span class="token function">isDefaultInstanceEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// create empty service</span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"creating service {}"</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Service</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> serviceName <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> namespaceId <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        service<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        service<span class="token punctuation">.</span><span class="token function">setNamespaceId</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        service<span class="token punctuation">.</span><span class="token function">setGroupName</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>DEFAULT_GROUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// now validate the service. if failed, exception will be thrown</span>
                        service<span class="token punctuation">.</span><span class="token function">setLastModifiedMillis</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        service<span class="token punctuation">.</span><span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span>SERVICE_META_KEY_PREFIX<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">buildServiceMetaKey</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

			<span class="token comment">// 发送事件监听</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Datum</span><span class="token punctuation">&lt;</span><span class="token class-name">Instances</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> datumMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listeners<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Should not happen:</span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"listener of {} not found."</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordListener</span> listener <span class="token operator">:</span> listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        listener<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-DISTRO] error while execute listener of key: {}"</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 异常continue</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Update data store if listener executed successfully:</span>
                <span class="token comment">// 如果侦听器成功执行，则更新数据存储</span>
                dataStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="213_Notifier__298"></a>2.1.3 Notifier 线程(事件监听)</h4> 
<p>Notifier 为 DistroConsistencyServiceImpl 的一个内部类，用于实现事件监听机制，完成数据变更/删除通知所有Lisenter。</p> 
<p>Notifier 采用了生产者消费者模式，通过 <code>BlockingQueue&lt;Pair&gt; tasks</code> 阻塞队列，完成生产 / 消费。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@org.springframework.stereotype.Service</span><span class="token punctuation">(</span><span class="token string">"distroConsistencyService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistroConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">EphemeralConsistencyService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Notifier</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pair</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pair</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> datumKey<span class="token punctuation">,</span> <span class="token class-name">ApplyAction</span> action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 判断是否已经处理过当前 datumKey，并且 action == ApplyAction.CHANGE，避免重复处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 添加</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                services<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span>EMPTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// 生产者消费者模式：生产任务</span>
            tasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Pair</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTaskSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"distro notifier started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 死循环：生产者消费者模式，消费任务</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>

					<span class="token comment">// 如果阻塞队列为空，阻塞</span>
                    <span class="token class-name">Pair</span> pair <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pair <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token class-name">String</span> datumKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> pair<span class="token punctuation">.</span><span class="token function">getValue0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ApplyAction</span> action <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplyAction</span><span class="token punctuation">)</span> pair<span class="token punctuation">.</span><span class="token function">getValue1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token comment">// 移出当前datumKey </span>
                    services<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listeners<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordListener</span> listener <span class="token operator">:</span> listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        count<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        	<span class="token comment">// Change 事件</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                listener<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">,</span> dataStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
							<span class="token comment">// Delete 事件</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>DELETE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                listener<span class="token punctuation">.</span><span class="token function">onDelete</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-DISTRO] error while notifying listener of key: {}"</span><span class="token punctuation">,</span> datumKey<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[NACOS-DISTRO] datum change notified, key: {}, listener count: {}, action: {}"</span><span class="token punctuation">,</span>
                            datumKey<span class="token punctuation">,</span> count<span class="token punctuation">,</span> action<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-DISTRO] Error while handling notifying task"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="214_putString_key_Record_value__387"></a>2.1.4 put(String key, Record value) 方法</h4> 
<p>我们主要看一下其中的事务处理方法，以 <code>put(String key, Record value)</code> 方法为例，其他的(如<code>remove(String key)</code>) 类似，这里不做过多分析。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@org.springframework.stereotype.Service</span><span class="token punctuation">(</span><span class="token string">"distroConsistencyService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistroConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">EphemeralConsistencyService</span> <span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">onPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加当前key 数据同步任务</span>
        taskDispatcher<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPut</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 判断是否为临时实例列表键，以 com.alibaba.nacos.naming.iplist.ephemeral. 开头</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchEphemeralInstanceListKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Datum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instances</span><span class="token punctuation">&gt;</span></span> datum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Datum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            datum<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Instances</span><span class="token punctuation">)</span> value<span class="token punctuation">;</span>
            datum<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
            datum<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 缓存</span>
            dataStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> datum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listeners<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
		<span class="token comment">// 发送Change 事件</span>
        notifier<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="215_TaskDispatcher_421"></a>2.1.5 TaskDispatcher</h4> 
<p>数据同步任务调度器。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskDispatcher</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 全局配置对象</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GlobalConfig</span> partitionConfig<span class="token punctuation">;</span>

	<span class="token comment">// 数据同步器</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSyncer</span> dataSyncer<span class="token punctuation">;</span>
	<span class="token comment">// 任务调度列表</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TaskScheduler</span><span class="token punctuation">&gt;</span></span> taskSchedulerList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// cpu核心数</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> cpuCoreCount <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
    	<span class="token comment">// 初始化 taskSchedulerList 任务调度列表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpuCoreCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">TaskScheduler</span> taskScheduler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskScheduler</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            taskSchedulerList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>taskScheduler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">submitTaskDispatch</span><span class="token punctuation">(</span>taskScheduler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// UtilsAndCommons.shakeUp(key, cpuCoreCount)：一种散列算法，根据key获取一个均匀分布在 0~cpuCoreCount 之间的数字</span>
    	<span class="token comment">// TaskScheduler.addTask 添加任务：生产者消费者模式，生成任务</span>
        taskSchedulerList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span><span class="token function">shakeUp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> cpuCoreCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskScheduler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> dataSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">long</span> lastDispatchTime <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">TaskScheduler</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 死循环，生产者消费者模式，消费任务</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">// 获取key：带超时时间</span>
                    <span class="token class-name">String</span> key <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>partitionConfig<span class="token punctuation">.</span><span class="token function">getTaskDispatchPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"got key: {}"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSyncer<span class="token punctuation">.</span><span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> dataSyncer<span class="token punctuation">.</span><span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        keys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    keys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    dataSize<span class="token operator">++</span><span class="token punctuation">;</span>

					<span class="token comment">// dataSize == 批量同步key || 当前时间 - 最后同步时间 &gt; 任务调度周期</span>
					<span class="token comment">// dataSize == partitionConfig.getBatchSyncKeyCount()：控制最大能同时处理的同步key数量</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSize <span class="token operator">==</span> partitionConfig<span class="token punctuation">.</span><span class="token function">getBatchSyncKeyCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                        <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastDispatchTime<span class="token punctuation">)</span> <span class="token operator">&gt;</span> partitionConfig<span class="token punctuation">.</span><span class="token function">getTaskDispatchPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

						<span class="token comment">// 遍历所有服务</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> member <span class="token operator">:</span> dataSyncer<span class="token punctuation">.</span><span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        	<span class="token comment">// 剔除当前服务</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            
                            <span class="token comment">// 同步任务</span>
                            <span class="token class-name">SyncTask</span> syncTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            syncTask<span class="token punctuation">.</span><span class="token function">setKeys</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            syncTask<span class="token punctuation">.</span><span class="token function">setTargetServer</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"add sync task: {}"</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>syncTask<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            
							<span class="token comment">// 提交数据同步任务</span>
                            dataSyncer<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>syncTask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// 更新最后同步时间</span>
                        lastDispatchTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 重置dataSize </span>
                        dataSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"dispatch sync task failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="216_DataSyncer_546"></a>2.1.6 DataSyncer</h4> 
<p>数据同步处理器。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@DependsOn</span><span class="token punctuation">(</span><span class="token string">"serverListManager"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSyncer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataStore</span> dataStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GlobalConfig</span> partitionConfig<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Serializer</span> serializer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DistroMapper</span> distroMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ServerListManager</span> serverListManager<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> taskMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 开启 定时同步</span>
        <span class="token function">startTimedSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">SyncTask</span> task<span class="token punctuation">,</span> <span class="token keyword">long</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If it's a new task:</span>
        <span class="token comment">// 判断是否为新的任务：重试次数 == 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getRetryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>taskMap<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token function">buildKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getTargetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// associated key already exist:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"sync already in process, key: {}"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 避免重复同步：去除重复请求</span>
                    iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// all keys are removed:</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">submitDataSync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>SRV_LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"try to sync data but server list is empty."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

					<span class="token comment">// 获取所有需要同步的key</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"sync keys: {}"</span><span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

					<span class="token comment">// 根据key获取Datum</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Datum</span><span class="token punctuation">&gt;</span></span> datumMap <span class="token operator">=</span> dataStore<span class="token punctuation">.</span><span class="token function">batchGet</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>datumMap <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> datumMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// clear all flags of this task:</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> task<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            taskMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">buildKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getTargetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

					<span class="token comment">// 序列化</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>datumMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 发送数据同步请求：/v1/ns/distro/datum</span>
                    <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token class-name">NamingProxy</span><span class="token punctuation">.</span><span class="token function">syncData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getTargetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">SyncTask</span> syncTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        syncTask<span class="token punctuation">.</span><span class="token function">setKeys</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        syncTask<span class="token punctuation">.</span><span class="token function">setRetryCount</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getRetryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        syncTask<span class="token punctuation">.</span><span class="token function">setLastExecuteTime</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        syncTask<span class="token punctuation">.</span><span class="token function">setTargetServer</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getTargetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">// 异常重试</span>
                        <span class="token function">retrySync</span><span class="token punctuation">(</span>syncTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// clear all flags of this task:</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> task<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            taskMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">buildKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getTargetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"sync data failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 异常重试</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">retrySync</span><span class="token punctuation">(</span><span class="token class-name">SyncTask</span> syncTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>syncTask<span class="token punctuation">.</span><span class="token function">getTargetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span><span class="token function">setServePort</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>syncTask<span class="token punctuation">.</span><span class="token function">getTargetServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// if server is no longer in healthy server list, ignore this task:</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// TODO may choose other retry policy.</span>
        <span class="token comment">// 重试，默认 5s 后重试</span>
        <span class="token function">submit</span><span class="token punctuation">(</span>syncTask<span class="token punctuation">,</span> partitionConfig<span class="token punctuation">.</span><span class="token function">getSyncRetryDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startTimedSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">schedulePartitionDataTimedSync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimedSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 定时同步线程</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimedSync</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"server list is: {}"</span><span class="token punctuation">,</span> <span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// send local timestamps to other servers:</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyChecksums <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> dataStore<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>distroMapper<span class="token punctuation">.</span><span class="token function">responsible</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
					<span class="token comment">// 添加 checksum</span>
                    keyChecksums<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dataStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">getChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>keyChecksums<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"sync checksums: {}"</span><span class="token punctuation">,</span> keyChecksums<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> member <span class="token operator">:</span> <span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">// 剔除当前服务</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 同步 checksum，发送 /v1/ns/distro/checksum?source=NetUtils.localServer()</span>
                    <span class="token class-name">NamingProxy</span><span class="token punctuation">.</span><span class="token function">syncCheckSums</span><span class="token punctuation">(</span>keyChecksums<span class="token punctuation">,</span> member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>DISTRO<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"timed sync task failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> serverListManager<span class="token punctuation">.</span><span class="token function">getHealthyServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">buildKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> targetServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> key <span class="token operator">+</span> <span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span>CACHE_KEY_SPLITER <span class="token operator">+</span> targetServer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="217_Nacos__728"></a>2.1.7 Nacos 分区一致性算法总结</h4> 
<p><img src="https://images2.imgbox.com/70/08/ZGdOnk9M_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22_RaftConsistencyServiceImpl_731"></a>2.2 RaftConsistencyServiceImpl</h3> 
<p>RaftConsistencyServiceImpl 为 PersistentConsistencyService 的唯一实现，如下：<br> <img src="https://images2.imgbox.com/fe/3d/HI7uyMXX_o.png" alt="在这里插入图片描述"></p> 
<p>RaftConsistencyServiceImpl 持久化节点一致性协议采用 <strong>Raft算法</strong> 实现， 保证已发布数据的 CP 一致性的一致性协议。</p> 
<h4><a id="221_Raft_737"></a>2.2.1 Raft算法</h4> 
<p>Raft 算法主要作用：</p> 
<ul><li>服务启动时，选举出集群中的 Leader节点</li><li>崩溃恢复，Leader节点挂掉后，从所有 Follower 节点中选举出新的 Leader</li><li>数据一致性，Leader 节点处理事务请求，Follower 只处理非事务请求，如果接受到事务请求，将当前请求转发给Leader，由Leader处理后，同步给Follower节点。</li></ul> 
<p><strong>Raft算法的Leader选举核心思想：先到先得，少数服从多数。</strong></p> 
<p>下面简单说明一下 Raft 算法在服务启动时，选举 Leader 的过程，其中 <strong>Node 代表节点，Term 代表选举周期</strong>。</p> 
<p>周期的含义：服务每选举一轮，为一个周期</p> 
<p>1.当所有服务启动后，每个服务会随机生成一个 Leader 选举开始倒计时(下图红色框框中的部分)。<br> <img src="https://images2.imgbox.com/21/cc/FYD3eCwI_o.jpg" alt="在这里插入图片描述"><br> 2.当集群中存在倒计时为0的节点时，它会进入一个候选状态，例如下面的Node B节点。<br> <img src="https://images2.imgbox.com/fe/38/CpmmeiFg_o.png" alt="在这里插入图片描述"><br> 3.候选节点会<strong>首先</strong>发起Leader投票(<strong>先到先得</strong>)<br> <img src="https://images2.imgbox.com/22/e4/CmGNruAP_o.png" alt="在这里插入图片描述"><br> 4.其他节点接收到投票消息后，会返回一个信息给候选节点。<br> <img src="https://images2.imgbox.com/c2/20/BqOEr3lA_o.png" alt="在这里插入图片描述"><br> 5.当某个候选节点，收到Leader选举票数大于当前集群总节点的 <strong>1/2</strong> 时，它会变成 Leader 节点，其他节点变成 Follower 节点(<strong>少数服从多数</strong>)。<br> <img src="https://images2.imgbox.com/b5/be/YnKdWpvO_o.png" alt="在这里插入图片描述"><br> 6. Leader节点需要每隔一段时间，向 Follower 发送一个心跳包，维持心跳。<br> <img src="https://images2.imgbox.com/c6/8d/EivMYR9T_o.png" alt="在这里插入图片描述"><br> 7. Follower 节点会开启一个心跳倒计时，在倒计时时间内，如果收到心跳，返回给Leader，并重新开始倒计时；如果倒计时时间内，没有收到心跳，会主动向 Leade r节点发送请求，判断当前 Leader 是否宕机，如果宕机，开始新的 Leader 选举。<br> <img src="https://images2.imgbox.com/06/61/xz0kq1r1_o.png" alt="在这里插入图片描述"><br> 当集群中存在 Leader 节点宕机后，还是会重复上面 1-7 类似步骤，选举出新的 Leader 节点。</p> 
<h4><a id="222_NacosRaft_767"></a>2.2.2 Nacos中Raft算法的具体实现</h4> 
<p>RaftConsistencyServiceImpl 持久化节点一致性协议采用 <strong>Raft算法</strong> 实现， 保证已发布数据的 CP 一致性的一致性协议。</p> 
<p>核心逻辑如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftConsistencyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">PersistentConsistencyService</span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token comment">/**
	 * Raft 核心实现
	 */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RaftCore</span> raftCore<span class="token punctuation">;</span>

	<span class="token comment">/**
	 * Raft Leader选举核心实现
	 */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RaftPeerSet</span> peers<span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 开关
	 */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SwitchDomain</span> switchDomain<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 转发事务消息给Leader进行处理：服务发布</span>
            raftCore<span class="token punctuation">.</span><span class="token function">signalPublish</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Raft put failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span>SERVER_ERROR<span class="token punctuation">,</span> <span class="token string">"Raft put failed, key:"</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">", value:"</span> <span class="token operator">+</span> value<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 判断要删除的key是否为匹配实例列表key(以com.alibaba.nacos.naming.iplist. 或 iplist. 开始)</span>
        	<span class="token comment">// 如果是，并且当前节点不是Leader</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchInstanceListKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>raftCore<span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Datum</span> datum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Datum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                datum<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
                <span class="token comment">// 直接本地删除</span>
                raftCore<span class="token punctuation">.</span><span class="token function">onDelete</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>key<span class="token punctuation">,</span> peers<span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 删除对应所有监听</span>
                raftCore<span class="token punctuation">.</span><span class="token function">unlistenAll</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 转发事务消息给Leader进行处理：服务剔除</span>
            raftCore<span class="token punctuation">.</span><span class="token function">signalDelete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 删除对应所有监听</span>
            raftCore<span class="token punctuation">.</span><span class="token function">unlistenAll</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Raft remove failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span>SERVER_ERROR<span class="token punctuation">,</span> <span class="token string">"Raft remove failed, key:"</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Datum</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// get</span>
        <span class="token keyword">return</span> raftCore<span class="token punctuation">.</span><span class="token function">getDatum</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">RecordListener</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 给当前key添加listener</span>
        raftCore<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlisten</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">RecordListener</span> listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 取消当前key的listener</span>
        raftCore<span class="token punctuation">.</span><span class="token function">unlisten</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 是否可用</span>
        <span class="token keyword">return</span> raftCore<span class="token punctuation">.</span><span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">ServerStatus</span><span class="token punctuation">.</span>UP<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>switchDomain<span class="token punctuation">.</span><span class="token function">getOverriddenServerStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPut</span><span class="token punctuation">(</span><span class="token class-name">Datum</span> datum<span class="token punctuation">,</span> <span class="token class-name">RaftPeer</span> source<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 本地发布</span>
            raftCore<span class="token punctuation">.</span><span class="token function">onPublish</span><span class="token punctuation">(</span>datum<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Raft onPut failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span>SERVER_ERROR<span class="token punctuation">,</span> <span class="token string">"Raft onPut failed, datum:"</span> <span class="token operator">+</span> datum <span class="token operator">+</span> <span class="token string">", source: "</span> <span class="token operator">+</span> source<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRemove</span><span class="token punctuation">(</span><span class="token class-name">Datum</span> datum<span class="token punctuation">,</span> <span class="token class-name">RaftPeer</span> source<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 本地剔除</span>
            raftCore<span class="token punctuation">.</span><span class="token function">onDelete</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>key<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Raft onRemove failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span>SERVER_ERROR<span class="token punctuation">,</span> <span class="token string">"Raft onRemove failed, datum:"</span> <span class="token operator">+</span> datum <span class="token operator">+</span> <span class="token string">", source: "</span> <span class="token operator">+</span> source<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看出，Raft的核心实现有两个类，一个是RaftCore，一个是RaftPeerSet，作用分别是：</p> 
<ul><li>RaftPeerSet：Raft Leader选举核心实现</li><li>RaftCore：Raft 核心实现</li></ul> 
<h5><a id="2221_RaftPeerSetLeader_879"></a>2.2.2.1 RaftPeerSet(Leader选举)</h5> 
<p>该类主要职责是进行Raft Leader选举，主要包括两个场景：</p> 
<ol><li>服务启动过程中 Leader 选举；</li><li>Leader 出现宕机后，选举出新的 Leader；</li></ol> 
<p>RaftPeerSet<strong>类关系图</strong>如下：<br> <img src="https://images2.imgbox.com/c4/e2/ATsViByD_o.png" alt="在这里插入图片描述"></p> 
<ul><li>ServerChangeListener：监听服务列表变化</li><li>@DependsOn(“serverListManager”)：在进行注入的时候，先加载serverListManager后，再加载当前实例</li><li>ApplicationContextAware：获取 ApplicationContext 对象</li><li>@Component：注入到Spring IoC容器中</li></ul> 
<p>下面我们具体看一下代码实现。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@DependsOn</span><span class="token punctuation">(</span><span class="token string">"serverListManager"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftPeerSet</span> <span class="token keyword">implements</span> <span class="token class-name">ServerChangeListener</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">// 服务器列表管理器</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ServerListManager</span> serverListManager<span class="token punctuation">;</span>

	<span class="token comment">// Spring应用上下文</span>
    <span class="token keyword">private</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>

	<span class="token comment">// Raft选举本地Term</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicLong</span> localTerm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 集群Leader</span>
    <span class="token keyword">private</span> <span class="token class-name">RaftPeer</span> leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token comment">// 集群中所有Leader、Follower对象集合</span>
	<span class="token comment">// key -&gt; ip     value  -&gt;  Raft选举对象</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RaftPeer</span><span class="token punctuation">&gt;</span></span> peers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sites <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 是否可读，port &gt; 0</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RaftPeerSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 初始化：将当前Listener添加到 ServerListManager 中的列表监听，用于实时监听服务列表变化</span>
        serverListManager<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 获取Leader对象</span>
    <span class="token keyword">public</span> <span class="token class-name">RaftPeer</span> <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 是否为单机模式，通过 nacos.standalone 配置true/false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>STANDALONE_MODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 返回当前对象</span>
            <span class="token keyword">return</span> <span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回 Leader 对象</span>
        <span class="token keyword">return</span> leader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">allSites</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> sites<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> ready<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 移除服务</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> server <span class="token operator">:</span> servers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            peers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 修改服务</span>
    <span class="token keyword">public</span> <span class="token class-name">RaftPeer</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">RaftPeer</span> peer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        peers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> peer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 是否为Leader
	 */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token class-name">String</span> ip<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>STANDALONE_MODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    		<span class="token comment">// 单机模式，直接返回true</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// Leader对象为空，直接返回false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[IS LEADER] no leader is available now!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 判断当前ip是否与Leader ip相等</span>
        <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>leader<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 获取包括当前服务的所有服务ip</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">allServersIncludeMyself</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> peers<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 获取派出当前服务的所有服务ip</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">allServersWithoutMySelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> servers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>peers<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// exclude myself</span>
        servers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> servers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 获取集群中所有服务对象</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RaftPeer</span><span class="token punctuation">&gt;</span></span> <span class="token function">allPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> peers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 大小</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> peers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">/**
     * Leader选举：在进行服务启动时，Leader选举开始时间倒计时为0后，调用当前方法，向除当前本地服务所有服务发起投票(通过Http)
     * 具体逻辑详看下面的 RaftCore MasterElection过程
     * 
     * @param candidate 候选者(投票-投候选者)
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">RaftPeer</span> <span class="token function">decideLeader</span><span class="token punctuation">(</span><span class="token class-name">RaftPeer</span> candidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        peers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>candidate<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 分拣袋：用于统计各个候选者投票次数，类似于生活中的“画正字”</span>
        <span class="token class-name">SortedBag</span> ips <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeBag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 最大票数</span>
        <span class="token keyword">int</span> maxApproveCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 最大票数拥有者</span>
        <span class="token class-name">String</span> maxApprovePeer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RaftPeer</span> peer <span class="token operator">:</span> peers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 1.判断当前RaftPeer voteFor(当前RaftPeer的投票对象ip) 是否为空</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>voteFor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

			<span class="token comment">// 存在投票者</span>
			<span class="token comment">// 2. 添加投票</span>
            ips<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>voteFor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 3. 更新最大票数、最大票数拥有者</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ips<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>voteFor<span class="token punctuation">)</span> <span class="token operator">&gt;</span> maxApproveCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                maxApproveCount <span class="token operator">=</span> ips<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>voteFor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                maxApprovePeer <span class="token operator">=</span> peer<span class="token punctuation">.</span>voteFor<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 判断最大票数是否大于 peers.size() / 2 + 1 ，即集群中节点个数的 二分之一 + 1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxApproveCount <span class="token operator">&gt;=</span> <span class="token function">majorityCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 设置Leader</span>
            <span class="token class-name">RaftPeer</span> peer <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>maxApprovePeer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            peer<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>LEADER<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>leader<span class="token punctuation">,</span> peer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        		<span class="token comment">// 设置Leader</span>
                leader <span class="token operator">=</span> peer<span class="token punctuation">;</span>
                <span class="token comment">// 发送Leader选举完成事件</span>
                applicationContext<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LeaderElectFinishedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> leader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{} has become the LEADER"</span><span class="token punctuation">,</span> leader<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> leader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">/**
     * 决定 or 设置Leader：candidate候选者-当前集群Leader对象
     * @param candidate
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">RaftPeer</span> <span class="token function">makeLeader</span><span class="token punctuation">(</span><span class="token class-name">RaftPeer</span> candidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>leader<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            leader <span class="token operator">=</span> candidate<span class="token punctuation">;</span>
            <span class="token comment">// 发送决定出Leader事件</span>
            applicationContext<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MakeLeaderEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> leader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"{} has become the LEADER, local: {}, leader: {}"</span><span class="token punctuation">,</span>
                leader<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>leader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">RaftPeer</span> peer <span class="token operator">:</span> peers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> peer<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>LEADER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">// 当前RaftPeer 不是Leader，并且当前RaftPeer 对象的状态为Leader状态，需要更新为Follower</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">// url = /v1/ns/raft/peer</span>
                    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">RaftCore</span><span class="token punctuation">.</span><span class="token function">buildURL</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> <span class="token class-name">RaftCore</span><span class="token punctuation">.</span>API_GET_PEER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 异步请求：发送 /v1/ns/raft/peer 判断当前对象是否为Leader对象</span>
                    <span class="token class-name">HttpClient</span><span class="token punctuation">.</span><span class="token function">asyncHttpGet</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                        	<span class="token comment">// 如果不是Leader对象，更新状态为Follower</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">HttpURLConnection</span><span class="token punctuation">.</span>HTTP_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-RAFT] get peer failed: {}, peer: {}"</span><span class="token punctuation">,</span>
                                    response<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> peer<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                peer<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>FOLLOWER<span class="token punctuation">;</span>
                                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
							
							<span class="token comment">// 更新结果状态</span>
                            <span class="token function">update</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RaftPeer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    peer<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>FOLLOWER<span class="token punctuation">;</span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-RAFT] error while getting peer from peer: {}"</span><span class="token punctuation">,</span> peer<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
		<span class="token comment">// 更新结果状态</span>
        <span class="token keyword">return</span> <span class="token function">update</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 获取当前服务所属的RaftPeer对象</span>
    <span class="token keyword">public</span> <span class="token class-name">RaftPeer</span> <span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RaftPeer</span> peer <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// peer为空，并且为单机模式，创建一个RaftPeer 并放入 peers 缓存中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>peer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">SystemUtils</span><span class="token punctuation">.</span>STANDALONE_MODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RaftPeer</span> localPeer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            localPeer<span class="token punctuation">.</span>ip <span class="token operator">=</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            localPeer<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>localTerm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            peers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>localPeer<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> localPeer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> localPeer<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>peer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"unable to find local peer: "</span> <span class="token operator">+</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", all peers: "</span>
                <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>peers<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> peer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 根据ip获取RaftPeer 对象</span>
    <span class="token keyword">public</span> <span class="token class-name">RaftPeer</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> server<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// Raft投票决策出Leader的值：集群节点的二分之一 + 1</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">majorityCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> peers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 重置：重置Leader、所有voteFor</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 重置Leader</span>
        leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 重置所有voteFor</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RaftPeer</span> peer <span class="token operator">:</span> peers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            peer<span class="token punctuation">.</span>voteFor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 设置Raft选举过程中的Term(周期)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">long</span> term<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        localTerm<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 获取Raft选举过程中的Term(周期)</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> localTerm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">RaftPeer</span> remote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> peers<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>remote<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">/**
     * 监听处理集群服务节点变化
     * 
     * @param latestMembers 最新的Server
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChangeServerList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> latestMembers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RaftPeer</span><span class="token punctuation">&gt;</span></span> tmpPeers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> member <span class="token operator">:</span> latestMembers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>peers<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                tmpPeers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">RaftPeer</span> raftPeer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            raftPeer<span class="token punctuation">.</span>ip <span class="token operator">=</span> member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// first time meet the local server:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                raftPeer<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>localTerm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            tmpPeers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> raftPeer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// replace raft peer set:</span>
        peers <span class="token operator">=</span> tmpPeers<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RunningConfig</span><span class="token punctuation">.</span><span class="token function">getServerPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"raft peers changed: "</span> <span class="token operator">+</span> latestMembers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onChangeHealthyServerList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> latestReachableMembers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2222_RaftCore_1211"></a>2.2.2.2 RaftCore</h5> 
<p>Nacos集群中Raft算法的核心实现，包括Leader选举、事务转发Leader等功能。下面会讲解一下其中的核心逻辑。</p> 
<h6><a id="1_RaftCore_init_1214"></a>1. RaftCore init()</h6> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftCore</span> <span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"initializing Raft sub-system"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 执行一个 Notifier 线程：后面分析</span>
        executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>notifier<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 加载基础数据</span>
		<span class="token comment">// user.home + /nacos/data/naming/data</span>
        raftStore<span class="token punctuation">.</span><span class="token function">loadDatums</span><span class="token punctuation">(</span>notifier<span class="token punctuation">,</span> datums<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 初始化当前节点Leader选举Term(周期)</span>
        <span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span>raftStore<span class="token punctuation">.</span><span class="token function">loadMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"term"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"cache loaded, datum count: {}, current term: {}"</span><span class="token punctuation">,</span> datums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> peers<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 等待 Notifier 线程执行完成</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>notifier<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 初始化</span>
        initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"finish to load data from disk, cost: {} ms."</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 开启一个Leader选举线程：</span>
		<span class="token comment">// executorService.scheduleAtFixedRate(new MasterElection(), 0, 500L, TimeUnit.MILLISECONDS);</span>
        <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">registerMasterElection</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MasterElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 开启一个心跳检查线程</span>
        <span class="token comment">// executorService.scheduleWithFixedDelay(runnable, 0, 500L, TimeUnit.MILLISECONDS);</span>
        <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">registerHeartbeat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeartBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"timer started: leader timeout ms: {}, heart-beat timeout ms: {}"</span><span class="token punctuation">,</span>
            <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span>LEADER_TIMEOUT_MS<span class="token punctuation">,</span> <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span>HEARTBEAT_INTERVAL_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2_Notifier__1262"></a>2. Notifier 线程(事件监听)</h6> 
<p>Notifier 为 RaftCore 的一个内部类，用于实现事件监听机制，完成数据变更/删除通知所有Lisenter。</p> 
<p>Notifier 采用了生产者消费者模式，通过 <code>BlockingQueue&lt;Pair&gt; tasks</code> 阻塞队列，完成生产 / 消费。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftCore</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 当前RaftCore 所有数据监听Listener</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RecordListener</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Notifier</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pair</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> datumKey<span class="token punctuation">,</span> <span class="token class-name">ApplyAction</span> action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 判断是否已经处理过当前 datumKey，并且 action == ApplyAction.CHANGE，避免重复处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>services<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 添加</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                services<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span>EMPTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"add task {}"</span><span class="token punctuation">,</span> datumKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 生产者消费者模式：生产任务</span>
            tasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Pair</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTaskSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"raft notifier started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 死循环：生产者消费者模式，消费任务</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 如果阻塞队列为空，阻塞</span>
                    <span class="token class-name">Pair</span> pair <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pair <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token class-name">String</span> datumKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> pair<span class="token punctuation">.</span><span class="token function">getValue0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ApplyAction</span> action <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplyAction</span><span class="token punctuation">)</span> pair<span class="token punctuation">.</span><span class="token function">getValue1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">// 移出当前datumKey </span>
                    services<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"remove task {}"</span><span class="token punctuation">,</span> datumKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

					<span class="token comment">// listeners中存在key为：com.alibaba.nacos.naming.domains.meta.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>listeners<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span>SERVICE_META_KEY_PREFIX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token comment">// KeyBuilder.matchServiceMetaKey(datumKey)：是否以 com.alibaba.nacos.naming.domains.meta. 或 meta. 开头</span>
						<span class="token comment">// !KeyBuilder.matchSwitchKey(datumKey)：不以 00-00---000-NACOS_SWITCH_DOMAIN-000---00-00 结尾</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchServiceMetaKey</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchSwitchKey</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token comment">// listeners.get("com.alibaba.nacos.naming.domains.meta.")</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordListener</span> listener <span class="token operator">:</span> listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span>SERVICE_META_KEY_PREFIX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                                	<span class="token comment">// 数据变更事件</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        listener<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">,</span> <span class="token function">getDatum</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                    
									<span class="token comment">// 数据删除事件</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>DELETE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        listener<span class="token punctuation">.</span><span class="token function">onDelete</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-RAFT] error while notifying listener of key: {}"</span><span class="token punctuation">,</span> datumKey<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
					
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listeners<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token comment">// 不存在当前datumKey</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

					<span class="token comment">// 遍历通知</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RecordListener</span> listener <span class="token operator">:</span> listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        count<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// 数据变更事件</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                listener<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">,</span> <span class="token function">getDatum</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

							<span class="token comment">// 数据删除事件</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>DELETE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                listener<span class="token punctuation">.</span><span class="token function">onDelete</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-RAFT] error while notifying listener of key: {}"</span><span class="token punctuation">,</span> datumKey<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[NACOS-RAFT] datum change notified, key: {}, listener count: {}"</span><span class="token punctuation">,</span> datumKey<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-RAFT] Error while handling notifying task"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="3_MasterElection__1380"></a>3. MasterElection 线程(投票选举)</h6> 
<p>用于选举出Nacos集群中的Leader节点。</p> 
<p>每隔 500L 执行一次。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftCore</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MasterElection</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peers<span class="token punctuation">.</span><span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">RaftPeer</span> local <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// local.leaderDueMs -= 500L;</span>
                local<span class="token punctuation">.</span>leaderDueMs <span class="token operator">-=</span> <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span>TICK_PERIOD_MS<span class="token punctuation">;</span>

				<span class="token comment">// 判断当前节点Leader选举倒计时是否已经结束</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>local<span class="token punctuation">.</span>leaderDueMs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">// 没有结束，等待下一个500L执行，再判断</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

				<span class="token comment">/***********当前节点Leader选举倒计时结束，开始选举Leader***********/</span>

                <span class="token comment">// reset timeout</span>
                <span class="token comment">// 重置 leaderDueMs = 15s - (0~5s)，leaderDueMs 范围为 10s ~ 15s</span>
                local<span class="token punctuation">.</span><span class="token function">resetLeaderDue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 重置 heartbeatDueMs 心跳倒计时时间：选举出Leader后，Leader 和 Follower 需要维持一个心跳</span>
                <span class="token comment">// 如果心跳超时，需要检查Leader是否宕机，如果宕机，开始新一轮Leader选举</span>
                local<span class="token punctuation">.</span><span class="token function">resetHeartbeatDue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 发送投票：开始Leader选举</span>
                <span class="token function">sendVote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[RAFT] error while master election {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 发送投票：开始Leader选举</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendVote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 获取当前服务 RaftPeer 对象</span>
            <span class="token class-name">RaftPeer</span> local <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"leader timeout, start voting,leader: {}, term: {}"</span><span class="token punctuation">,</span>
                JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> local<span class="token punctuation">.</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token comment">// 重置集群 leader=null</span>
			<span class="token comment">// 重置集群节点投票对象 RaftPeer.voteFor = null</span>
            peers<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 选举term(周期) +1</span>
            local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 先投自己</span>
            local<span class="token punctuation">.</span>voteFor <span class="token operator">=</span> local<span class="token punctuation">.</span>ip<span class="token punctuation">;</span>
            <span class="token comment">// 标记自己为候选者(Candidate)状态</span>
            local<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>CANDIDATE<span class="token punctuation">;</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"vote"</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 向除当前节点其他所有节点发送投票：投当前节点</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> server <span class="token operator">:</span> peers<span class="token punctuation">.</span><span class="token function">allServersWithoutMySelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">// url = "http://" + ip + RunningConfig.getContextPath() + /v1/ns/raft/vote</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token function">buildURL</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> API_VOTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">// 异步请求</span>
                    <span class="token class-name">HttpClient</span><span class="token punctuation">.</span><span class="token function">asyncHttpPost</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                        	<span class="token comment">/*******处理/v1/ns/raft/vote 请求结果********/</span>
                        	
                        	<span class="token comment">// 异常直接return</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">HttpURLConnection</span><span class="token punctuation">.</span>HTTP_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"NACOS-RAFT vote failed: {}, url: {}"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

							<span class="token comment">// 获取投票结果</span>
                            <span class="token class-name">RaftPeer</span> peer <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RaftPeer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"received approve from peer: {}"</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							
							<span class="token comment">// 根据投票结果，进行Leader选举：方法详解参照 2.2.2.1 RaftPeerSet(Leader选举)</span>
                            peers<span class="token punctuation">.</span><span class="token function">decideLeader</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"error while sending vote to server: {}"</span><span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 MasterElection 线程中，会向其他节点发送一个投票请求(/v1/ns/raft/vote)，服务收到请求后，最终会调用 RaftCore 中的 <code>RaftPeer receivedVote(RaftPeer remote)</code> 方法，将当前服务节点投票结果发送给请求节点，具体处理逻辑如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftCore</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 收到投票
     * @param remote 远程 RaftPeer
     * @return
     */</span>
	<span class="token keyword">public</span> <span class="token class-name">RaftPeer</span> <span class="token function">receivedVote</span><span class="token punctuation">(</span><span class="token class-name">RaftPeer</span> remote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 判断远程 RaftPeer 是否存在当前 peers中，不存在，抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>remote<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"can not find peer: "</span> <span class="token operator">+</span> remote<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 获取当前服务节点RaftPeer</span>
        <span class="token class-name">RaftPeer</span> local <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 先比较选举周期term大小：以term大的为准</span>
		<span class="token comment">// 相对也选举自己</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remote<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">"received illegitimate vote"</span> <span class="token operator">+</span>
                <span class="token string">", voter-term:"</span> <span class="token operator">+</span> remote<span class="token punctuation">.</span>term <span class="token operator">+</span> <span class="token string">", votee-term:"</span> <span class="token operator">+</span> local<span class="token punctuation">.</span>term<span class="token punctuation">;</span>

            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>local<span class="token punctuation">.</span>voteFor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                local<span class="token punctuation">.</span>voteFor <span class="token operator">=</span> local<span class="token punctuation">.</span>ip<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> local<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 否则，接收远程RaftPeer投票</span>

		<span class="token comment">// 重置 leaderDueMs = 15s - (0~5s)，leaderDueMs 范围为 10s ~ 15s</span>
        local<span class="token punctuation">.</span><span class="token function">resetLeaderDue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 设置当前节点为 Follower</span>
        local<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>FOLLOWER<span class="token punctuation">;</span>
        <span class="token comment">// 设置当前节点投票对象为 remote.ip</span>
        local<span class="token punctuation">.</span>voteFor <span class="token operator">=</span> remote<span class="token punctuation">.</span>ip<span class="token punctuation">;</span>
        <span class="token comment">// 设置当前节点投票周期term为远程term</span>
        local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>remote<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"vote {} as leader, term: {}"</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> local<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="4_HeartBeat__1532"></a>4. HeartBeat 线程(心跳检测)</h6> 
<p>HeartBeat 用于Nacos集群中，Leader 节点发送心跳包给 Follower 节点，维持心跳。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftCore</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeartBeat</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peers<span class="token punctuation">.</span><span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

				<span class="token comment">// 获取当前服务RaftPeer</span>
                <span class="token class-name">RaftPeer</span> local <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// local.heartbeatDueMs -= 500ms;</span>
                local<span class="token punctuation">.</span>heartbeatDueMs <span class="token operator">-=</span> <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span>TICK_PERIOD_MS<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>local<span class="token punctuation">.</span>heartbeatDueMs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 重置 heartbeatDueMs 心跳倒计时时间：选举出Leader后，Leader 和 Follower 需要维持一个心跳</span>
                <span class="token comment">// 如果心跳超时，需要检查Leader是否宕机，如果宕机，开始新一轮Leader选举</span>
                local<span class="token punctuation">.</span><span class="token function">resetHeartbeatDue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 发送心跳包：Leader节点向其他Follower节点发送心跳包</span>
                <span class="token function">sendBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[RAFT] error while sending beat {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

		<span class="token comment">// 发送心跳包：Leader节点向其他Follower节点发送心跳包</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">RaftPeer</span> local <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 只有当前节点为Leader节点，并且为集群模式，才需要向其他Follower节点发送心跳包</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>local<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>LEADER <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>STANDALONE_MODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[RAFT] send beat with {} keys."</span><span class="token punctuation">,</span> datums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 重置当前服务集群选举倒计时 leaderDueMs：保证心跳正常，不再重新开始选举</span>
            <span class="token comment">// leaderDueMs = 15s - (0~5s)，leaderDueMs 范围为 10s ~ 15s</span>
            local<span class="token punctuation">.</span><span class="token function">resetLeaderDue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// build data</span>
            <span class="token comment">// 心跳包</span>
            <span class="token class-name">JSONObject</span> packet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            packet<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"peer"</span><span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">JSONArray</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 是否只发送心跳包：默认false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>switchDomain<span class="token punctuation">.</span><span class="token function">isSendBeatOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[SEND-BEAT-ONLY] {}"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>switchDomain<span class="token punctuation">.</span><span class="token function">isSendBeatOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>switchDomain<span class="token punctuation">.</span><span class="token function">isSendBeatOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Datum</span> datum <span class="token operator">:</span> datums<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                    <span class="token class-name">JSONObject</span> element <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchServiceMetaKey</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        element<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">briefServiceMetaKey</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchInstanceListKey</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        element<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">briefInstanceListkey</span><span class="token punctuation">(</span>datum<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    element<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> datum<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    array<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            packet<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"datums"</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// broadcast</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"beat"</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> content <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ByteArrayOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 压缩</span>
            <span class="token class-name">GZIPOutputStream</span> gzip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GZIPOutputStream</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
            gzip<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            gzip<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> compressedBytes <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> compressedContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>compressedBytes<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"raw beat data size: {}, size of compressed data: {}"</span><span class="token punctuation">,</span>
                    content<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compressedContent<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> server <span class="token operator">:</span> peers<span class="token punctuation">.</span><span class="token function">allServersWithoutMySelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            		<span class="token comment">// url = "http://" + ip + RunningConfig.getContextPath() + /v1/ns/raft/beat</span>
                    <span class="token keyword">final</span> <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token function">buildURL</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> API_BEAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"send beat to server "</span> <span class="token operator">+</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 异步发送</span>
                    <span class="token class-name">HttpClient</span><span class="token punctuation">.</span><span class="token function">asyncHttpPostLarge</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> compressedBytes<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                        	<span class="token comment">/*******处理/v1/ns/raft/beat 请求结果********/</span>
                        	
                        	<span class="token comment">// 异常直接return</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">HttpURLConnection</span><span class="token punctuation">.</span>HTTP_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"NACOS-RAFT beat failed: {}, peer: {}"</span><span class="token punctuation">,</span>
                                    response<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token class-name">MetricsMonitor</span><span class="token punctuation">.</span><span class="token function">getLeaderSendBeatFailedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

							<span class="token comment">// 更新RaftPeerSet peers;</span>
                            peers<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RaftPeer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"receive beat response from: {}"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onThrowable</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"NACOS-RAFT error while sending heart-beat to peer: {} {}"</span><span class="token punctuation">,</span> server<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">MetricsMonitor</span><span class="token punctuation">.</span><span class="token function">getLeaderSendBeatFailedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"error while sending heart-beat to peer: {} {}"</span><span class="token punctuation">,</span> server<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">MetricsMonitor</span><span class="token punctuation">.</span><span class="token function">getLeaderSendBeatFailedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 HeartBeat 线程中，Leader节点会向其他Follower节点发送一个心跳包(/v1/ns/raft/vote)，Follower收到心跳请求后，最终会调用 RaftCore 中的 <code>RaftPeer receivedBeat(JSONObject beat)</code> 方法，具体处理逻辑如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftCore</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
     * 接收处理心跳包
     * @param beat 心跳包
     * @return 返回当前节点信息
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">RaftPeer</span> <span class="token function">receivedBeat</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span> beat<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">RaftPeer</span> local <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// step 1:获取Leader节点信息</span>
        <span class="token keyword">final</span> <span class="token class-name">RaftPeer</span> remote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        remote<span class="token punctuation">.</span>ip <span class="token operator">=</span> beat<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"peer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"ip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        remote<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>beat<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"peer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        remote<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>beat<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"peer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongValue</span><span class="token punctuation">(</span><span class="token string">"term"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        remote<span class="token punctuation">.</span>heartbeatDueMs <span class="token operator">=</span> beat<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"peer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongValue</span><span class="token punctuation">(</span><span class="token string">"heartbeatDueMs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        remote<span class="token punctuation">.</span>leaderDueMs <span class="token operator">=</span> beat<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"peer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongValue</span><span class="token punctuation">(</span><span class="token string">"leaderDueMs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        remote<span class="token punctuation">.</span>voteFor <span class="token operator">=</span> beat<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"peer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"voteFor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// step 2:不是Leader节点的心跳包，直接抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remote<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>LEADER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[RAFT] invalid state from master, state: {}, remote peer: {}"</span><span class="token punctuation">,</span>
                remote<span class="token punctuation">.</span>state<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>remote<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"invalid state from master, state: "</span> <span class="token operator">+</span> remote<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// step 3:本地term &gt; Leader中的term，抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> remote<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[RAFT] out of date beat, beat-from-term: {}, beat-to-term: {}, remote peer: {}, and leaderDueMs: {}"</span>
                <span class="token punctuation">,</span> remote<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>remote<span class="token punctuation">)</span><span class="token punctuation">,</span> local<span class="token punctuation">.</span>leaderDueMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"out of date beat, beat-from-term: "</span> <span class="token operator">+</span> remote<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">", beat-to-term: "</span> <span class="token operator">+</span> local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// step 4:本地节点不为 Follower 节点，先设置为 Follower</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>local<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>FOLLOWER<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[RAFT] make remote as leader, remote peer: {}"</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>remote<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// mk follower</span>
            local<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">RaftPeer<span class="token punctuation">.</span>State</span><span class="token punctuation">.</span>FOLLOWER<span class="token punctuation">;</span>
            local<span class="token punctuation">.</span>voteFor <span class="token operator">=</span> remote<span class="token punctuation">.</span>ip<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 注意：step 3、step 4的作用是：</span>
        <span class="token comment">// 1. 修改Leader出现后，集群所有其他节点为当前Leader的Follower节点</span>
        <span class="token comment">// 2. 处理Raft 选举中，出现网络分区的请求，以Term大的为主。</span>

        <span class="token keyword">final</span> <span class="token class-name">JSONArray</span> beatDatums <span class="token operator">=</span> beat<span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">"datums"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重置</span>
        local<span class="token punctuation">.</span><span class="token function">resetLeaderDue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        local<span class="token punctuation">.</span><span class="token function">resetHeartbeatDue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 设置Leader</span>
        peers<span class="token punctuation">.</span><span class="token function">makeLeader</span><span class="token punctuation">(</span>remote<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> receivedKeysMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>datums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Datum</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> datums<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            receivedKeysMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// now check datums</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> batch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 更新基本信息：缓存信息等</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>switchDomain<span class="token punctuation">.</span><span class="token function">isSendBeatOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> processedCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[RAFT] received beat with {} keys, RaftCore.datums' size is {}, remote server: {}, term: {}, local term: {}"</span><span class="token punctuation">,</span>
                    beatDatums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> datums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>term<span class="token punctuation">,</span> local<span class="token punctuation">.</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> object <span class="token operator">:</span> beatDatums<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                processedCount <span class="token operator">=</span> processedCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

                <span class="token class-name">JSONObject</span> entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> object<span class="token punctuation">;</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> datumKey<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchServiceMetaKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    datumKey <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">detailServiceMetaKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchInstanceListKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    datumKey <span class="token operator">=</span> <span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">detailInstanceListkey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// ignore corrupted key:</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">long</span> timestamp <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                receivedKeysMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>datums<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> datums<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> timestamp <span class="token operator">&amp;&amp;</span> processedCount <span class="token operator">&lt;</span> beatDatums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>datums<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> datums<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        batch<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>datumKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">50</span> <span class="token operator">&amp;&amp;</span> processedCount <span class="token operator">&lt;</span> beatDatums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token class-name">String</span> keys <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"get datums from leader: {}, batch size is {}, processedCount is {}, datums' size is {}, RaftCore.datums' size is {}"</span>
                        <span class="token punctuation">,</span> <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ip<span class="token punctuation">,</span> batch<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> processedCount<span class="token punctuation">,</span> beatDatums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> datums<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// update datum entry</span>
                    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token function">buildURL</span><span class="token punctuation">(</span>remote<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> API_GET<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"?keys="</span> <span class="token operator">+</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">HttpClient</span><span class="token punctuation">.</span><span class="token function">asyncHttpGet</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">HttpURLConnection</span><span class="token punctuation">.</span>HTTP_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JSONObject</span><span class="token punctuation">&gt;</span></span> datumList <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getResponseBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">JSONObject</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span> datumJson <span class="token operator">:</span> datumList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                OPERATE_LOCK<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token class-name">Datum</span> newDatum <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>

                                    <span class="token class-name">Datum</span> oldDatum <span class="token operator">=</span> <span class="token function">getDatum</span><span class="token punctuation">(</span>datumJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldDatum <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> datumJson<span class="token punctuation">.</span><span class="token function">getLongValue</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> oldDatum<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[NACOS-RAFT] timestamp is smaller than that of mine, key: {}, remote: {}, local: {}"</span><span class="token punctuation">,</span>
                                            datumJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> datumJson<span class="token punctuation">.</span><span class="token function">getLongValue</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldDatum<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>

                                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchServiceMetaKey</span><span class="token punctuation">(</span>datumJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token class-name">Datum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Service</span><span class="token punctuation">&gt;</span></span> serviceDatum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Datum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        serviceDatum<span class="token punctuation">.</span>key <span class="token operator">=</span> datumJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        serviceDatum<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>datumJson<span class="token punctuation">.</span><span class="token function">getLongValue</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        serviceDatum<span class="token punctuation">.</span>value <span class="token operator">=</span>
                                            JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>datumJson<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Service</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        newDatum <span class="token operator">=</span> serviceDatum<span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>

                                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyBuilder</span><span class="token punctuation">.</span><span class="token function">matchInstanceListKey</span><span class="token punctuation">(</span>datumJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token class-name">Datum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instances</span><span class="token punctuation">&gt;</span></span> instancesDatum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Datum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        instancesDatum<span class="token punctuation">.</span>key <span class="token operator">=</span> datumJson<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        instancesDatum<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>datumJson<span class="token punctuation">.</span><span class="token function">getLongValue</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        instancesDatum<span class="token punctuation">.</span>value <span class="token operator">=</span>
                                            JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>datumJson<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Instances</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        newDatum <span class="token operator">=</span> instancesDatum<span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>

                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newDatum <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> newDatum<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"receive null datum: {}"</span><span class="token punctuation">,</span> datumJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>

                                    raftStore<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>newDatum<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                    datums<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newDatum<span class="token punctuation">.</span>key<span class="token punctuation">,</span> newDatum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    notifier<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>newDatum<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token class-name">ApplyAction</span><span class="token punctuation">.</span>CHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                    local<span class="token punctuation">.</span><span class="token function">resetLeaderDue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">100</span> <span class="token operator">&gt;</span> remote<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                        <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>remote<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                                        local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>

                                    raftStore<span class="token punctuation">.</span><span class="token function">updateTerm</span><span class="token punctuation">(</span>local<span class="token punctuation">.</span>term<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"data updated, key: {}, timestamp: {}, from {}, local term: {}"</span><span class="token punctuation">,</span>
                                        newDatum<span class="token punctuation">.</span>key<span class="token punctuation">,</span> newDatum<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>remote<span class="token punctuation">)</span><span class="token punctuation">,</span> local<span class="token punctuation">.</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[RAFT-BEAT] failed to sync datum from leader, datum: {}"</span><span class="token punctuation">,</span> newDatum<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                                    OPERATE_LOCK<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    batch<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-RAFT] failed to handle beat entry, key: {}"</span><span class="token punctuation">,</span> datumKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>

			<span class="token comment">// 获取需要剔除的Key</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> deadKeys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> receivedKeysMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    deadKeys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> deadKey <span class="token operator">:</span> deadKeys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                	<span class="token comment">// 剔除key</span>
                    <span class="token function">deleteDatum</span><span class="token punctuation">(</span>deadKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[NACOS-RAFT] failed to remove entry, key={} {}"</span><span class="token punctuation">,</span> deadKey<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> local<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="5_RaftCoresignalPublish_1905"></a>5. RaftCore.signalPublish()</h6> 
<p>RaftCore 中的 <code>signalPublish(String key, Record value)</code> 方法，负责处理事务请求：</p> 
<ol><li>先判断当前节点是否为Leader节点</li><li>如果为Leader节点，直接处理(需集群节点半数处理完成，才算成功)</li><li>否则，转发给Leader节点，进行处理</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RaftCore</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">signalPublish</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Record</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 先判断当前节点是否为Leader节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 转发给Leader节点，进行处理</span>
            <span class="token class-name">JSONObject</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parameters<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 转发事务类请求：向Leader发送 /v1/ns/raft/datum 请求</span>
            raftProxy<span class="token punctuation">.</span><span class="token function">proxyPostLarge</span><span class="token punctuation">(</span><span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ip<span class="token punctuation">,</span> API_PUB<span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		
		<span class="token comment">// Leader节点，直接处理</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            OPERATE_LOCK<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Datum</span> datum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Datum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            datum<span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
            datum<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getDatum</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                datum<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                datum<span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">getDatum</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">JSONObject</span> json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"datum"</span><span class="token punctuation">,</span> datum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"source"</span><span class="token punctuation">,</span> peers<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 先更新Leader节点一些本地信息</span>
            <span class="token function">onPublish</span><span class="token punctuation">(</span>datum<span class="token punctuation">,</span> peers<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token class-name">String</span> content <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 半数通过，即事务请求处理成功，否则5s后抛异常</span>
            <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>peers<span class="token punctuation">.</span><span class="token function">majorityCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 同步数据给Follower节点</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> server <span class="token operator">:</span> peers<span class="token punctuation">.</span><span class="token function">allServersIncludeMyself</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLeader</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// url = /v1/ns/raft/datum/commit</span>
                <span class="token keyword">final</span> <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token function">buildURL</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> API_ON_PUB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">HttpClient</span><span class="token punctuation">.</span><span class="token function">asyncHttpPostLarge</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"key="</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncCompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">HttpURLConnection</span><span class="token punctuation">.</span>HTTP_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[RAFT] failed to publish data to peer, datumId={}, peer={}, http code={}"</span><span class="token punctuation">,</span>
                                datum<span class="token punctuation">.</span>key<span class="token punctuation">,</span> server<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">STATE</span> <span class="token function">onContentWriteCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> STATE<span class="token punctuation">.</span>CONTINUE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>

			<span class="token comment">// 最多等待5s，超时直接跑异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token class-name">UtilsAndCommons</span><span class="token punctuation">.</span>RAFT_PUBLISH_TIMEOUT<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// only majority servers return success can we consider this update success</span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"data publish failed, caused failed to notify majority, key={}"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"data publish failed, caused failed to notify majority, key="</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span>RAFT<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"signalPublish cost {} ms, key: {}"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            OPERATE_LOCK<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="223_Nacos_Raft_2000"></a>2.2.3 Nacos Raft算法总结</h4> 
<p><img src="https://images2.imgbox.com/e9/73/qazy1awU_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b201cddb32f0fc057178854727933a15/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Nacos-注册中心原理解析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/99355294ac7550e0d230d8f8509add2a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Stream 流 根据对象属性去重</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>