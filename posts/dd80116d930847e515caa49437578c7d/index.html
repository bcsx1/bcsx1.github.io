<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ffmpeg-源码 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ffmpeg-源码" />
<meta property="og:description" content="文章目录 前言编译便于调试、学习、分析ffmpeg、模块共享库调用API-获取MOV文件信息1.avformat_open_input分析2.avformat_find_stream_info分析3.av_dump_format分析4.avformat_close_input分析 调用API-分离MOV文件1.avcodec_find_decoder分析2.avcodec_get_name分析3.av_read_frame分析4.av_packet_unref分析 调用API-解码MOV文件1.avcodec_alloc_context3分析2.avcodec_parameters_to_context分析3.avcodec_open2分析4.av_frame_alloc分析5.avcodec_send_packet分析h264_decode_frame分析（不在显示调用API中）6.avcodec_receive_frame分析7.av_frame_unref分析8.av_frame_free分析9.最后将原始数据写入到文件 调用API-编码YUV文件ffmpeg对内存的释放处理 添加滤镜 前言 本文只是分析FFmpeg执行流程并不具有教学意义，都是以笔记形式记录，所得结论并不严谨，教学系列原理找官网。
面向源码学习FFmpeg框架：
为了方便调用ffmpeg api需要使用静态编译ffmpeg，一般开发大多数都是动态库为了节省应用内存，也有全静态的场景（嵌入式设备），就静态库 build/lib/libavcodec.a而言大小就有300&#43;M
编译后的头文件、动态库都放在源代码工作路径，方便管理，但是需要手动的添加头文件、链接库、动态\静态链接执行库。
觉得麻烦可以直接将make install安装到默认用户环境目录下,在下面脚本中去掉--prefix=$(pwd)/build \参数就可以了。
编译便于调试、学习、分析ffmpeg、模块共享库 该脚本编译模块库为静态库，ffmpeg为静态链接，使用版本：4.2.2。仅适用于学习、调试FFmpeg API
#!/bin/bash ScriptVersion=&#34;1.0&#34; unset file unset directory ff_version=&#34;ffmpeg-4.2.2&#34; ff=&#34;${ff_version}.tar.bz2&#34; static=1 shared=0 main(){ confirmation_info download_ffmpeg if [ &#34;$static&#34; == &#34;1&#34; ];then fetch_x264_static elif [ &#34;$shared&#34; == &#34;1&#34; ];then #Install x264 x265 depend(shared library) #apt install libx264-dev libx265-dev read -p &#34;Are you already installed libx264-dev?[Y/n]&#34; ok if [ &#34;$ok&#34; == &#34;n&#34; ];then exit;fi else exit fi build_ff } confirmation_info(){ local tips=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/dd80116d930847e515caa49437578c7d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-31T14:16:15+08:00" />
<meta property="article:modified_time" content="2023-03-31T14:16:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ffmpeg-源码</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#ffmpeg_15" rel="nofollow">编译便于调试、学习、分析ffmpeg、模块共享库</a></li><li><a href="#APIMOV_295" rel="nofollow">调用API-获取MOV文件信息</a></li><li><ul><li><a href="#1avformat_open_input_435" rel="nofollow">1.avformat_open_input分析</a></li><li><a href="#2avformat_find_stream_info_547" rel="nofollow">2.avformat_find_stream_info分析</a></li><li><a href="#3av_dump_format_1171" rel="nofollow">3.av_dump_format分析</a></li><li><a href="#4avformat_close_input_1519" rel="nofollow">4.avformat_close_input分析</a></li></ul> 
   </li><li><a href="#APIMOV_1560" rel="nofollow">调用API-分离MOV文件</a></li><li><ul><li><a href="#1avcodec_find_decoder_1683" rel="nofollow">1.avcodec_find_decoder分析</a></li><li><a href="#2avcodec_get_name_1781" rel="nofollow">2.avcodec_get_name分析</a></li><li><a href="#3av_read_frame_1841" rel="nofollow">3.av_read_frame分析</a></li><li><a href="#4av_packet_unref_2249" rel="nofollow">4.av_packet_unref分析</a></li></ul> 
   </li><li><a href="#APIMOV_2348" rel="nofollow">调用API-解码MOV文件</a></li><li><ul><li><a href="#1avcodec_alloc_context3_2567" rel="nofollow">1.avcodec_alloc_context3分析</a></li><li><a href="#2avcodec_parameters_to_context_2625" rel="nofollow">2.avcodec_parameters_to_context分析</a></li><li><a href="#3avcodec_open2_2671" rel="nofollow">3.avcodec_open2分析</a></li><li><a href="#4av_frame_alloc_2810" rel="nofollow">4.av_frame_alloc分析</a></li><li><a href="#5avcodec_send_packet_2835" rel="nofollow">5.avcodec_send_packet分析</a></li><li><a href="#h264_decode_frameAPI_3118" rel="nofollow">h264_decode_frame分析（不在显示调用API中）</a></li><li><a href="#6avcodec_receive_frame_3210" rel="nofollow">6.avcodec_receive_frame分析</a></li><li><a href="#7av_frame_unref_3293" rel="nofollow">7.av_frame_unref分析</a></li><li><a href="#8av_frame_free_3333" rel="nofollow">8.av_frame_free分析</a></li><li><a href="#9_3350" rel="nofollow">9.最后将原始数据写入到文件</a></li></ul> 
   </li><li><a href="#APIYUV_3399" rel="nofollow">调用API-编码YUV文件</a></li><li><a href="#ffmpeg_3621" rel="nofollow">ffmpeg对内存的释放处理</a></li></ul> 
  </li><li><a href="#_3648" rel="nofollow">添加滤镜</a></li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>前言</h3> 
<p>本文只是分析FFmpeg执行流程并不具有教学意义，都是以笔记形式记录，所得结论并不严谨，教学系列原理找官网。</p> 
<p>面向源码学习FFmpeg框架：</p> 
<ol><li> <p>为了方便调用ffmpeg api需要使用静态编译ffmpeg，一般开发大多数都是动态库为了节省应用内存，也有全静态的场景（嵌入式设备），就静态库<code> build/lib/libavcodec.a</code>而言大小就有<code>300+M</code></p> </li><li> <p>编译后的头文件、动态库都放在源代码工作路径，方便管理，但是需要手动的添加头文件、链接库、动态\静态链接执行库。</p> </li></ol> 
<p>觉得麻烦可以直接将<code>make install</code>安装到默认用户环境目录下,在下面脚本中去掉<code>--prefix=$(pwd)/build \</code>参数就可以了。</p> 
<h3><a id="ffmpeg_15"></a>编译便于调试、学习、分析ffmpeg、模块共享库</h3> 
<p>该脚本编译模块库为静态库，ffmpeg为静态链接，使用版本：4.2.2。仅适用于学习、调试FFmpeg API</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">ScriptVersion</span><span class="token operator">=</span><span class="token string">"1.0"</span>

<span class="token builtin class-name">unset</span> <span class="token function">file</span>
<span class="token builtin class-name">unset</span> directory

<span class="token assign-left variable">ff_version</span><span class="token operator">=</span><span class="token string">"ffmpeg-4.2.2"</span>
<span class="token assign-left variable">ff</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${ff_version}</span>.tar.bz2"</span>

<span class="token assign-left variable">static</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">shared</span><span class="token operator">=</span><span class="token number">0</span>

<span class="token function-name function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	confirmation_info
	download_ffmpeg
	<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$static</span>"</span> <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		fetch_x264_static
	<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$shared</span>"</span> <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		<span class="token comment">#Install x264 x265 depend(shared library)</span>
		<span class="token comment">#apt install libx264-dev libx265-dev</span>
		<span class="token builtin class-name">read</span> -p <span class="token string">"Are you already installed libx264-dev?[Y/n]"</span> ok
		<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$ok</span>"</span> <span class="token operator">==</span> <span class="token string">"n"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span> <span class="token builtin class-name">exit</span><span class="token punctuation">;</span><span class="token keyword">fi</span>
	<span class="token keyword">else</span>
		<span class="token builtin class-name">exit</span>
	<span class="token keyword">fi</span>
	build_ff
<span class="token punctuation">}</span>

<span class="token function-name function">confirmation_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token builtin class-name">local</span> <span class="token assign-left variable">tips</span><span class="token operator">=</span><span class="token string">"Static"</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$static</span>"</span> <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		<span class="token assign-left variable">tips</span><span class="token operator">=</span><span class="token string">"Static"</span>
	<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$shared</span>"</span> <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		<span class="token assign-left variable">tips</span><span class="token operator">=</span><span class="token string">"Dynamic"</span>
	<span class="token keyword">fi</span>
	<span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\033">\033</span>[31m<span class="token variable">${tips}</span> compilation will be used. continue?[Y/n]<span class="token entity" title="\033">\033</span>[0m"</span>
	<span class="token builtin class-name">read</span> ok
	<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$ok</span>"</span> <span class="token operator">==</span> <span class="token string">"n"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span> 
		<span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\033">\033</span>[31mTry --help<span class="token entity" title="\033">\033</span>[0m"</span>
		<span class="token builtin class-name">exit</span>
	<span class="token keyword">fi</span>
<span class="token punctuation">}</span>



<span class="token function-name function">download_ffmpeg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">pushd</span> <span class="token environment constant">$HOME</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token variable">$ff_version</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">$ff</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span> <span class="token function">wget</span> https://ffmpeg.org/releases/<span class="token variable">$ff</span><span class="token punctuation">;</span><span class="token keyword">fi</span>
		<span class="token function">tar</span> -xjvf <span class="token variable">$ff</span>
	<span class="token keyword">fi</span>
	<span class="token function">popd</span>

	<span class="token function">pushd</span> <span class="token environment constant">$HOME</span>/<span class="token variable">$ff_version</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token string">"Changelog"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		<span class="token function">rm</span> Changelog *.md COPYING.* CREDITS MAINTAINERS RELEASE* VERSION
	<span class="token keyword">fi</span>
	<span class="token function">popd</span>
<span class="token punctuation">}</span>

<span class="token function-name function">build_ff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token function">pushd</span> <span class="token environment constant">$HOME</span>/<span class="token variable">$ff_version</span>

	<span class="token builtin class-name">local</span> <span class="token assign-left variable">ret</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">find</span> <span class="token builtin class-name">.</span> -name <span class="token string">"*.o"</span><span class="token variable">)</span></span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$ret</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		<span class="token builtin class-name">echo</span> <span class="token string">"make clean..."</span>
		<span class="token function">make</span> -j16 clean
	<span class="token keyword">fi</span>

	<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$static</span>"</span> <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		confg_static
	<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$shared</span>"</span> <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		confg_shared
	<span class="token keyword">fi</span>

	<span class="token function">make</span> -j16 <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
	<span class="token function">popd</span>
<span class="token punctuation">}</span>


<span class="token function-name function">confg_static</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token comment"># 如果开启了libx265 则需要开启--pkg-config-flags="--static".</span>
	./configure <span class="token punctuation">\</span>
		--prefix<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/build <span class="token punctuation">\</span>
		--extra-cflags<span class="token operator">=</span><span class="token string">"-static -I<span class="token variable">${<!-- --><span class="token environment constant">HOME</span>}</span>/<span class="token variable">${x264_version}</span>/build/include"</span> <span class="token punctuation">\</span>
		--extra-ldflags<span class="token operator">=</span><span class="token string">"-static -L<span class="token variable">${<!-- --><span class="token environment constant">HOME</span>}</span>/<span class="token variable">${x264_version}</span>/build/lib -lx264"</span> <span class="token punctuation">\</span>
		--enable-small <span class="token punctuation">\</span>
		--disable-doc --disable-htmlpages --disable-manpages --disable-podpages --disable-txtpages <span class="token punctuation">\</span>
		--disable-ffplay --disable-ffprobe <span class="token punctuation">\</span>
		--disable-avdevice --disable-swresample --disable-postproc <span class="token punctuation">\</span>
		--disable-network <span class="token punctuation">\</span>
		--disable-asm --disable-mmx --disable-sse --disable-avx --disable-vfp --disable-neon --disable-inline-asm --disable-x86asm --disable-mipsdsp <span class="token punctuation">\</span>
		--enable-debug<span class="token operator">=</span><span class="token number">3</span> --disable-optimizations --ignore-tests<span class="token operator">=</span>TESTS <span class="token punctuation">\</span>
		--enable-gpl --enable-libx264
<span class="token punctuation">}</span>

<span class="token function-name function">fetch_x264_static</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token assign-left variable">x264_version</span><span class="token operator">=</span><span class="token string">"x264-master"</span>
	<span class="token assign-left variable">x264</span><span class="token operator">=</span><span class="token string">"x264-master.tar.bz2"</span>
	<span class="token function">pushd</span> <span class="token environment constant">$HOME</span>

	<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token string">"<span class="token variable">$x264_version</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">$x264</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span> <span class="token function">wget</span> https://code.videolan.org/videolan/x264/-/archive/master/x264-master.tar.bz2<span class="token punctuation">;</span><span class="token keyword">fi</span>
		<span class="token function">tar</span> -xjvf <span class="token variable">$x264</span>
	<span class="token keyword">fi</span>

	<span class="token builtin class-name">cd</span> <span class="token variable">$x264_version</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"./build/lib/libx264.a"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		./configure --enable-static --disable-asm --prefix<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/build --disable-opencl
		<span class="token function">make</span> -j16 <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
	<span class="token keyword">fi</span>
	<span class="token function">popd</span>
<span class="token punctuation">}</span>


<span class="token function-name function">confg_shared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token comment">#使用动态库：</span>
<span class="token comment">#1.删除 --extra-cflags="-static" --extra-ldflags="-static" \</span>
<span class="token comment">#2.添加 --enable-shared \</span>

	./configure <span class="token punctuation">\</span>
		--prefix<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/build <span class="token punctuation">\</span>
		--enable-shared <span class="token punctuation">\</span>
		--enable-small <span class="token punctuation">\</span>
		--disable-doc --disable-htmlpages --disable-manpages --disable-podpages --disable-txtpages <span class="token punctuation">\</span>
		--disable-ffplay --disable-ffprobe <span class="token punctuation">\</span>
		--disable-avdevice --disable-swresample --disable-postproc <span class="token punctuation">\</span>
		--disable-network <span class="token punctuation">\</span>
		--disable-asm --disable-mmx --disable-sse --disable-avx --disable-vfp --disable-neon --disable-inline-asm --disable-x86asm --disable-mipsdsp <span class="token punctuation">\</span>
		--enable-debug<span class="token operator">=</span><span class="token number">3</span> --disable-optimizations --ignore-tests<span class="token operator">=</span>TESTS
		--enable-gpl --enable-libx264 <span class="token comment">#--enable-libx265 </span>
<span class="token punctuation">}</span>

<span class="token function-name function">usage</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token builtin class-name">echo</span> <span class="token string">"Usage :  <span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> <span class="token string">"<span class="token variable">$0</span>"</span><span class="token variable">)</span></span> [options] [--] argument-1 argument-2

  Options:
  -h, --help                  Display this message
  -d, --debug                 Debug model run
  -p, --posix                 Posix model parse shell command
  -v, --version               Display script version
  -f, --file FILE             Target file 
  -D, --directory DIRECTORY   Target directory
  --static                    Static compilation ffmpeg components and static link(default)
  --shared                    Dynamic compilation ffmpeg components and dynamic link
  --build_ffmpeg              Separate compilation ffmpeg"</span>
<span class="token punctuation">}</span>

<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">":hdpvf:D:-:"</span> opt<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">case</span> <span class="token string">"<span class="token variable">${opt}</span>"</span> <span class="token keyword">in</span>
    h<span class="token punctuation">)</span> usage <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    d<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> -x <span class="token punctuation">;</span><span class="token punctuation">;</span>
    p<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> -o posix <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token function">v</span><span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$0</span> -- Version <span class="token variable">$ScriptVersion</span>"</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
    f<span class="token punctuation">)</span> <span class="token assign-left variable">file</span><span class="token operator">=</span><span class="token variable">${OPTARG}</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    D<span class="token punctuation">)</span> <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token variable">${OPTARG}</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    -<span class="token punctuation">)</span> <span class="token keyword">case</span> <span class="token string">"<span class="token variable">${OPTARG}</span>"</span> <span class="token keyword">in</span>
         <span class="token builtin class-name">help</span><span class="token punctuation">)</span> usage <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
         debug<span class="token punctuation">)</span>      <span class="token builtin class-name">set</span> -x <span class="token punctuation">;</span><span class="token punctuation">;</span>
         posix<span class="token punctuation">)</span>      <span class="token builtin class-name">set</span> -o posix <span class="token punctuation">;</span><span class="token punctuation">;</span>
         version<span class="token punctuation">)</span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$0</span> -- Version <span class="token variable">$ScriptVersion</span>"</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
         <span class="token function">file</span><span class="token punctuation">)</span>       <span class="token assign-left variable">file</span><span class="token operator">=</span><span class="token variable">${<!-- --><span class="token operator">!</span>OPTIND}</span><span class="token punctuation">;</span> <span class="token assign-left variable"><span class="token environment constant">OPTIND</span></span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>OPTIND<span class="token operator">+</span><span class="token number">1</span><span class="token variable">))</span></span><span class="token punctuation">;</span><span class="token punctuation">;</span>
         directory<span class="token punctuation">)</span>  <span class="token assign-left variable">directory</span><span class="token operator">=</span><span class="token variable">${<!-- --><span class="token operator">!</span>OPTIND}</span><span class="token punctuation">;</span> <span class="token assign-left variable"><span class="token environment constant">OPTIND</span></span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>OPTIND<span class="token operator">+</span><span class="token number">1</span><span class="token variable">))</span></span><span class="token punctuation">;</span><span class="token punctuation">;</span>
         static<span class="token punctuation">)</span>     <span class="token assign-left variable">static</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token assign-left variable">shared</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
         shared<span class="token punctuation">)</span>     <span class="token assign-left variable">shared</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token assign-left variable">static</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
         build_ffmpeg<span class="token punctuation">)</span>build_ff <span class="token punctuation">;</span><span class="token builtin class-name">exit</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
         *<span class="token punctuation">)</span>          <span class="token builtin class-name">echo</span> <span class="token string">"Invalid option: --<span class="token variable">${OPTARG}</span>"</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
       <span class="token keyword">esac</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token builtin class-name">:</span><span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">"Option -<span class="token variable">${OPTARG}</span> requires an argument."</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token string">"Invalid option: -<span class="token variable">${OPTARG}</span>"</span> <span class="token operator">&gt;</span><span class="token file-descriptor important">&amp;2</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
<span class="token keyword">done</span>
<span class="token builtin class-name">shift</span> <span class="token variable"><span class="token variable">$((</span>OPTIND<span class="token operator">-</span><span class="token number">1</span><span class="token variable">))</span></span>

main <span class="token string">"<span class="token variable">$@</span>"</span>
</code></pre> 
<p>过程大概3-4分钟。脚本工作：</p> 
<ol><li>下载ffmpeg4.2.2源码配置静态编译库、ffmpeg静态链接库</li><li>下载libx264源码，静态编译出<code>libx264.a</code></li><li>ffmpeg会链接到<code>libx264.a</code>，编译出来的静态库在ffmpeg源代码根目录下的<code>build</code>文件夹，编译出来的<code>libx264.a</code>也在x264-master源代码目录下的<code>build</code>文件夹</li></ol> 
<blockquote> 
 <p>最后把这x264-master/build文件夹里面的静态库放在ffmpeg-4.2.2/build目录下就可以作为头文件、链接目录了。</p> 
 <p>把静态库编译在源码目录这样做的原因是方便移植、修改（对编译链接不熟悉的直接放在系统目录就ok了）</p> 
</blockquote> 
<p>将build目录移到自己的源代码目录下，为了区分动态库目录我这里将build目录名字改为了static</p> 
<p>测试代码如下<code>demo.cpp</code>:(源代码目录下应该有一个input.mov视频)</p> 
<pre><code class="prism language-c++">#include &lt;iostream&gt;

extern "C" {
#include "libavformat/avformat.h"
}

using std::string;;

int main(int argc, char *argv[]){
    AVFormatContext *ps = nullptr;
    string url = "input.mov";
  
    if(avformat_open_input(&amp;ps, url.c_str(), nullptr, nullptr) &lt; 0){
 			std::cerr &lt;&lt; "File " &lt;&lt; url &lt;&lt; " parse failed" &lt;&lt; std::endl;
      return -1;
    }
    return 0;
}
</code></pre> 
<p>然后编译程序：</p> 
<pre><code class="prism language-bash">$ g++ demo.cpp -I static/include -L static/lib -lavfilter -lavformat -lavcodec -lavutil -lswscale -lz -lx264 -static -g
</code></pre> 
<blockquote> 
 <p>-z 是额外的系统静态库，因为ffmpeg在某些函数(libavformat/mov.c中引用了uncompress函数)中依赖的libz.a库</p> 
 <p>这里需要引用你编译的所有子模块静态库，ffmpeg中的子模块依赖性很强，且最好是按照上面的顺序来链接，不然也会出错！</p> 
</blockquote> 
<p>这样编译出来的<code>a.out</code>就是一个静态链接、使用静态库的可执行文件文件，在调试代码时候可以进入到ffmpeg-API中进行调试。（不一定非要静态链接，只要是静态库就可以，默认configure就是静态库+动态链接也是可以直接调试源码的）</p> 
<p><strong>补充下调用ffmpeg动态库的编译(可选)：</strong></p> 
<p>如果你将ffmpeg的模块库编译为动态库，那么就可以执行下面的编译：</p> 
<pre><code class="prism language-bash">$ g++ demo.cpp -I shread/include/ -L shread/lib/ -lavformat
</code></pre> 
<ul><li>这里只指定了一个<code>avformat</code>库是因为我指定了动态库目录，ld链接器会在该库下面寻找<code>avformat</code>依赖的其他库</li></ul> 
<p>设置工作目录下的动态库文件目录（这里不执行会发生运行报错，动态库是在程序运行时调用的）</p> 
<blockquote> 
 <p>一个动态库成功的使用包括3步：</p> 
 <ol><li>成功编译</li><li>成功链接</li><li>成功调用</li></ol> 
</blockquote> 
<pre><code class="prism language-bash">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token string">"./build/lib"</span>
</code></pre> 
<p><strong>使用MakeFile</strong></p> 
<p>这里不需要使用静态链接，因为会编译很慢，只要库文件是静态库就没问题</p> 
<pre><code class="prism language-makefile">CC:=g++
BIN:=a.out
CPPFLAGS:=-g -Wall -std=c++11 -I static/include
LIBS=-L static/lib/ -lavfilter -lavformat -lavcodec -lavutil -lswscale -lz -lx264
SRC:=$(wildcard *.cpp)
OBJS:=$(patsubst %.cpp,%.o,$(SRC))

$(BIN):$(OBJS)
	$(CC) $^ -o $@ $(LIBS)

clean:
	rm $(BIN) *.o output.* divide.* *.yuv *.h264
</code></pre> 
<h3><a id="APIMOV_295"></a>调用API-获取MOV文件信息</h3> 
<p>源代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavformat/avformat.h"</span></span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INPUT_FILE</span> <span class="token string">"input.mov"</span></span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  AVFormatContext <span class="token operator">*</span>ps <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  string url <span class="token operator">=</span> INPUT_FILE<span class="token punctuation">;</span>

  <span class="token comment">// 1. Open the input file</span>
  status <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ps<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"File "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">" parse failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. Retrieve stream information</span>
  status <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Stream find info failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> is_output <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// 3. Print format and stream information</span>
  <span class="token function">av_dump_format</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> index<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> is_output<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 4. Close the input file IO</span>
  <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>FFmpeg框架中最核心的结构体：<code>AVFormatContext</code>下面的每个函数执行流程都是基于它来进行操作。</p> 
<svg id="mermaid-svg-6YRZ8UnV73yYNYp0" width="787.796875" xmlns="http://www.w3.org/2000/svg" height="694" viewbox="-8 -8 787.796875 694" class="mermaid-svg"> 
 <style>#mermaid-svg-6YRZ8UnV73yYNYp0 {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#fff;}#mermaid-svg-6YRZ8UnV73yYNYp0 .error-icon{fill:hsl(180, 0%, 26.9607843137%);}#mermaid-svg-6YRZ8UnV73yYNYp0 .error-text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);stroke:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-6YRZ8UnV73yYNYp0 .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-6YRZ8UnV73yYNYp0 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-6YRZ8UnV73yYNYp0 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-6YRZ8UnV73yYNYp0 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-6YRZ8UnV73yYNYp0 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-6YRZ8UnV73yYNYp0 .marker{fill:#0b0b0b;stroke:#0b0b0b;}#mermaid-svg-6YRZ8UnV73yYNYp0 .marker.cross{stroke:#0b0b0b;}#mermaid-svg-6YRZ8UnV73yYNYp0 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-6YRZ8UnV73yYNYp0 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#fff;}#mermaid-svg-6YRZ8UnV73yYNYp0 .cluster-label text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-6YRZ8UnV73yYNYp0 .cluster-label span{color:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-6YRZ8UnV73yYNYp0 .label text,#mermaid-svg-6YRZ8UnV73yYNYp0 span{fill:#fff;color:#fff;}#mermaid-svg-6YRZ8UnV73yYNYp0 .node rect,#mermaid-svg-6YRZ8UnV73yYNYp0 .node circle,#mermaid-svg-6YRZ8UnV73yYNYp0 .node ellipse,#mermaid-svg-6YRZ8UnV73yYNYp0 .node polygon,#mermaid-svg-6YRZ8UnV73yYNYp0 .node path{fill:#383838;stroke:#fff;stroke-width:1px;}#mermaid-svg-6YRZ8UnV73yYNYp0 .node .label{text-align:center;}#mermaid-svg-6YRZ8UnV73yYNYp0 .node.clickable{cursor:pointer;}#mermaid-svg-6YRZ8UnV73yYNYp0 .arrowheadPath{fill:undefined;}#mermaid-svg-6YRZ8UnV73yYNYp0 .edgePath .path{stroke:#0b0b0b;stroke-width:2.0px;}#mermaid-svg-6YRZ8UnV73yYNYp0 .flowchart-link{stroke:#0b0b0b;fill:none;}#mermaid-svg-6YRZ8UnV73yYNYp0 .edgeLabel{background-color:hsl(-120, 0%, 21.9607843137%);text-align:center;}#mermaid-svg-6YRZ8UnV73yYNYp0 .edgeLabel rect{opacity:0.5;background-color:hsl(-120, 0%, 21.9607843137%);fill:hsl(-120, 0%, 21.9607843137%);}#mermaid-svg-6YRZ8UnV73yYNYp0 .cluster rect{fill:hsl(180, 0%, 26.9607843137%);stroke:hsl(180, 0%, 16.9607843137%);stroke-width:1px;}#mermaid-svg-6YRZ8UnV73yYNYp0 .cluster text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-6YRZ8UnV73yYNYp0 .cluster span{color:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-6YRZ8UnV73yYNYp0 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(180, 0%, 26.9607843137%);border:1px solid undefined;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-6YRZ8UnV73yYNYp0 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
 <g> 
  <g class="output"> 
   <g class="clusters"></g> 
   <g class="edgePaths"> 
    <g class="edgePath LS-0 LE-1" id="L-0-1" style="opacity: 1;"> 
     <path class="path" d="M96.07291666666667,152L109.72743055555556,131.83333333333334C123.38194444444446,111.66666666666667,150.69097222222223,71.33333333333333,176.51996527777774,51.166666666666664C202.34895833333334,31,226.69791666666666,31,238.87239583333334,31L251.046875,31" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead163)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead163" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-1 LE-2" id="L-1-2" style="opacity: 1;"> 
     <path class="path" d="M324.125,31L336.2994791666667,31C348.4739583333333,31,372.8229166666667,31,395.5611979166667,31C418.2994791666667,31,439.4270833333333,31,449.9908854166667,31L460.5546875,31" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead164)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead164" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-1-1" id="L-0-1-1" style="opacity: 1;"> 
     <path class="path" d="M127.21875,152L135.68229166666666,147.83333333333334C144.14583333333334,143.66666666666666,161.07291666666666,135.33333333333334,173.703125,131.16666666666666C186.33333333333334,127,194.66666666666666,127,198.83333333333334,127L203,127" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead165)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead165" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-2-1" id="L-0-2-1" style="opacity: 1;"> 
     <path class="path" d="M127.21875,198L135.68229166666666,202.16666666666666C144.14583333333334,206.33333333333334,161.07291666666666,214.66666666666666,178.71744791666666,218.83333333333334C196.36197916666666,223,214.72395833333334,223,223.90494791666666,223L233.0859375,223" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead166)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead166" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-2-1 LE-2-2" id="L-2-1-2-2" style="opacity: 1;"> 
     <path class="path" d="M340.0958658854167,200L349.6085340711806,195.83333333333334C359.1212022569445,191.66666666666666,378.14653862847223,183.33333333333334,392.74123806423614,179.16666666666666C407.3359375,175,417.5,175,422.58203125,175L427.6640625,175" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead167)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead167" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-2-1 LE-2-3" id="L-2-1-2-3" style="opacity: 1;"> 
     <path class="path" d="M340.0958658854167,246L349.6085340711806,250.16666666666666C359.1212022569445,254.33333333333334,378.14653862847223,262.6666666666667,392.28420681423614,266.8333333333333C406.421875,271,415.671875,271,420.296875,271L424.921875,271" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead168)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead168" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-3-1" id="L-0-3-1" style="opacity: 1;"> 
     <path class="path" d="M87.17410714285714,198L102.31175595238095,250.16666666666666C117.44940476190476,302.3333333333333,147.72470238095238,406.6666666666667,173.78422619047618,458.8333333333333C199.84375,511,221.6875,511,232.609375,511L243.53125,511" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead169)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead169" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-3-1 LE-3-2" id="L-3-1-3-2" style="opacity: 1;"> 
     <path class="path" d="M305.08924696180554,488L320.436351634838,467.8333333333333C335.7834563078704,447.6666666666667,366.4776656539352,407.3333333333333,388.0448224103009,387.1666666666667C409.6119791666667,367,422.0520833333333,367,428.2721354166667,367L434.4921875,367" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead170)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead170" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-3-1 LE-3-3" id="L-3-1-3-3" style="opacity: 1;"> 
     <path class="path" d="M331.640625,491.703500392101L342.5625,486.91958366008413C353.484375,482.13566692806734,375.328125,472.56783346403364,396.8372395833333,467.78391673201685C418.3463541666667,463,439.5208333333333,463,450.1080729166667,463L460.6953125,463" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead171)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead171" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-3-1 LE-AVCodecParameters" id="L-3-1-AVCodecParameters" style="opacity: 1;"> 
     <path class="path" d="M331.640625,530.296499607899L342.5625,535.0804163399158C353.484375,539.8643330719327,375.328125,549.4321665359663,390.4166666666667,554.2160832679832C405.5052083333333,559,413.8385416666667,559,418.0052083333333,559L422.171875,559" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead172)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead172" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-3-1 LE-AVProbeData" id="L-3-1-AVProbeData" style="opacity: 1;"> 
     <path class="path" d="M305.08924696180554,534L320.436351634838,554.1666666666666C335.7834563078704,574.3333333333334,366.4776656539352,614.6666666666666,390.2505515769676,634.8333333333334C414.0234375,655,430.875,655,439.30078125,655L447.7265625,655" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead173)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead173" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-3-2 LE-AVMediaType" id="L-3-2-AVMediaType" style="opacity: 1;"> 
     <path class="path" d="M520.1749131944445,344L535.0285734953703,323.8333333333333C549.8822337962963,303.6666666666667,579.5895543981482,263.3333333333333,600.7036313657408,243.16666666666666C621.8177083333334,223,634.3385416666666,223,640.5989583333334,223L646.859375,223" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead174)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead174" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-3-2 LE-AVCodec" id="L-3-2-AVCodec" style="opacity: 1;"> 
     <path class="path" d="M554.0559895833334,344L563.2628038194445,339.8333333333333C572.4696180555555,335.6666666666667,590.8832465277778,327.3333333333333,608.9520399305555,323.1666666666667C627.0208333333334,319,644.7447916666666,319,653.6067708333334,319L662.46875,319" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead175)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead175" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-3-2 LE-AVCodecInternal" id="L-3-2-AVCodecInternal" style="opacity: 1;"> 
     <path class="path" d="M554.0559895833334,390L563.2628038194445,394.1666666666667C572.4696180555555,398.3333333333333,590.8832465277778,406.6666666666667,604.2567274305555,410.8333333333333C617.6302083333334,415,625.9635416666666,415,630.1302083333334,415L634.296875,415" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead176)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead176" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-3-2 LE-AVFrame" id="L-3-2-AVFrame" style="opacity: 1;"> 
     <path class="path" d="M520.1749131944445,390L535.0285734953703,410.1666666666667C549.8822337962963,430.3333333333333,579.5895543981482,470.6666666666667,603.1958188657408,490.8333333333333C626.8020833333334,511,644.3072916666666,511,653.0598958333334,511L661.8125,511" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead177)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead177" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
   </g> 
   <g class="edgeLabels"> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1" class="edgeLabel L-LS-0' L-LE-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-1-2" class="edgeLabel L-LS-1' L-LE-2"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1-1" class="edgeLabel L-LS-0' L-LE-1-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-2-1" class="edgeLabel L-LS-0' L-LE-2-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-2-1-2-2" class="edgeLabel L-LS-2-1' L-LE-2-2"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-2-1-2-3" class="edgeLabel L-LS-2-1' L-LE-2-3"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-3-1" class="edgeLabel L-LS-0' L-LE-3-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-3-1-3-2" class="edgeLabel L-LS-3-1' L-LE-3-2"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-3-1-3-3" class="edgeLabel L-LS-3-1' L-LE-3-3"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-3-1-AVCodecParameters" class="edgeLabel L-LS-3-1' L-LE-AVCodecParameters"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-3-1-AVProbeData" class="edgeLabel L-LS-3-1' L-LE-AVProbeData"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-3-2-AVMediaType" class="edgeLabel L-LS-3-2' L-LE-AVMediaType"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-3-2-AVCodec" class="edgeLabel L-LS-3-2' L-LE-AVCodec"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-3-2-AVCodecInternal" class="edgeLabel L-LS-3-2' L-LE-AVCodecInternal"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-3-2-AVFrame" class="edgeLabel L-LS-3-2' L-LE-AVFrame"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
   </g> 
   <g class="nodes"> 
    <g class="node default" id="flowchart-0-207" transform="translate(80.5,175)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-72.5" y="-23" width="145" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-62.5,-13)"> 
       <foreignobject width="125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVFormatContext 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-208" transform="translate(287.5859375,31)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-36.5390625" y="-23" width="73.078125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-26.5390625,-13)"> 
       <foreignobject width="53.078125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVClass 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-2-209" transform="translate(503.234375,31)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-42.6796875" y="-23" width="85.359375" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-32.6796875,-13)"> 
       <foreignobject width="65.359375" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVOption 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-1-211" transform="translate(287.5859375,127)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-84.5859375" y="-23" width="169.171875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-74.5859375,-13)"> 
       <foreignobject width="149.171875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AV(Out\In)putFormat 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-2-1-213" transform="translate(287.5859375,223)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-54.5" y="-23" width="109" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-44.5,-13)"> 
       <foreignobject width="89" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVIOContext 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-2-2-214" transform="translate(503.234375,175)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-75.5703125" y="-23" width="151.140625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-65.5703125,-13)"> 
       <foreignobject width="131.140625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int (*read_packet) 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-2-3-216" transform="translate(503.234375,271)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-78.3125" y="-23" width="156.625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-68.3125,-13)"> 
       <foreignobject width="136.625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int (*write_packet) 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-3-1-218" transform="translate(287.5859375,511)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-44.0546875" y="-23" width="88.109375" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-34.0546875,-13)"> 
       <foreignobject width="68.109375" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVStream 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-3-2-219" transform="translate(503.234375,367)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-68.7421875" y="-23" width="137.484375" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-58.7421875,-13)"> 
       <foreignobject width="117.484375" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVCodecContext 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-3-3-221" transform="translate(503.234375,463)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-42.5390625" y="-23" width="85.078125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-32.5390625,-13)"> 
       <foreignobject width="65.078125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVPacket 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-AVCodecParameters-223" transform="translate(503.234375,559)" style="opacity: 1;"> 
     <rect rx="0" ry="0" x="-81.0625" y="-23" width="162.125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-71.0625,-13)"> 
       <foreignobject width="142.125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVCodecParameters 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-AVProbeData-225" transform="translate(503.234375,655)" style="opacity: 1;"> 
     <rect rx="0" ry="0" x="-55.5078125" y="-23" width="111.015625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-45.5078125,-13)"> 
       <foreignobject width="91.015625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVProbeData 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-AVMediaType-227" transform="translate(703.046875,223)" style="opacity: 1;"> 
     <rect rx="0" ry="0" x="-56.1875" y="-23" width="112.375" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-46.1875,-13)"> 
       <foreignobject width="92.375" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVMediaType 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-AVCodec-229" transform="translate(703.046875,319)" style="opacity: 1;"> 
     <rect rx="0" ry="0" x="-40.578125" y="-23" width="81.15625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-30.578125,-13)"> 
       <foreignobject width="61.15625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVCodec 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-AVCodecInternal-231" transform="translate(703.046875,415)" style="opacity: 1;"> 
     <rect rx="0" ry="0" x="-68.75" y="-23" width="137.5" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-58.75,-13)"> 
       <foreignobject width="117.5" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVCodecInternal 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-AVFrame-233" transform="translate(703.046875,511)" style="opacity: 1;"> 
     <rect rx="0" ry="0" x="-41.234375" y="-23" width="82.46875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-31.234375,-13)"> 
       <foreignobject width="62.46875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVFrame 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </g> 
</svg> 
<p>本文中解码中重要的结构体:</p> 
<svg id="mermaid-svg-WeeLEBRosgfKmfXu" width="713.828125" xmlns="http://www.w3.org/2000/svg" height="560" viewbox="-8 -8 713.828125 560" class="mermaid-svg"> 
 <style>#mermaid-svg-WeeLEBRosgfKmfXu {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#fff;}#mermaid-svg-WeeLEBRosgfKmfXu .error-icon{fill:hsl(180, 0%, 26.9607843137%);}#mermaid-svg-WeeLEBRosgfKmfXu .error-text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);stroke:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-WeeLEBRosgfKmfXu .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-WeeLEBRosgfKmfXu .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-WeeLEBRosgfKmfXu .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-WeeLEBRosgfKmfXu .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-WeeLEBRosgfKmfXu .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-WeeLEBRosgfKmfXu .marker{fill:#0b0b0b;stroke:#0b0b0b;}#mermaid-svg-WeeLEBRosgfKmfXu .marker.cross{stroke:#0b0b0b;}#mermaid-svg-WeeLEBRosgfKmfXu svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-WeeLEBRosgfKmfXu .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#fff;}#mermaid-svg-WeeLEBRosgfKmfXu .cluster-label text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-WeeLEBRosgfKmfXu .cluster-label span{color:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-WeeLEBRosgfKmfXu .label text,#mermaid-svg-WeeLEBRosgfKmfXu span{fill:#fff;color:#fff;}#mermaid-svg-WeeLEBRosgfKmfXu .node rect,#mermaid-svg-WeeLEBRosgfKmfXu .node circle,#mermaid-svg-WeeLEBRosgfKmfXu .node ellipse,#mermaid-svg-WeeLEBRosgfKmfXu .node polygon,#mermaid-svg-WeeLEBRosgfKmfXu .node path{fill:#383838;stroke:#fff;stroke-width:1px;}#mermaid-svg-WeeLEBRosgfKmfXu .node .label{text-align:center;}#mermaid-svg-WeeLEBRosgfKmfXu .node.clickable{cursor:pointer;}#mermaid-svg-WeeLEBRosgfKmfXu .arrowheadPath{fill:undefined;}#mermaid-svg-WeeLEBRosgfKmfXu .edgePath .path{stroke:#0b0b0b;stroke-width:2.0px;}#mermaid-svg-WeeLEBRosgfKmfXu .flowchart-link{stroke:#0b0b0b;fill:none;}#mermaid-svg-WeeLEBRosgfKmfXu .edgeLabel{background-color:hsl(-120, 0%, 21.9607843137%);text-align:center;}#mermaid-svg-WeeLEBRosgfKmfXu .edgeLabel rect{opacity:0.5;background-color:hsl(-120, 0%, 21.9607843137%);fill:hsl(-120, 0%, 21.9607843137%);}#mermaid-svg-WeeLEBRosgfKmfXu .cluster rect{fill:hsl(180, 0%, 26.9607843137%);stroke:hsl(180, 0%, 16.9607843137%);stroke-width:1px;}#mermaid-svg-WeeLEBRosgfKmfXu .cluster text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-WeeLEBRosgfKmfXu .cluster span{color:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-WeeLEBRosgfKmfXu div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(180, 0%, 26.9607843137%);border:1px solid undefined;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-WeeLEBRosgfKmfXu :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
 <g> 
  <g class="output"> 
   <g class="clusters"></g> 
   <g class="edgePaths"> 
    <g class="edgePath LS-0 LE-1" id="L-0-1" style="opacity: 1;"> 
     <path class="path" d="M55.93280707465278,306L66.29036006221065,261.8333333333333C76.64791304976852,217.66666666666666,97.36301902488425,129.33333333333334,130.8911449291088,85.16666666666667C164.41927083333334,41,210.76041666666666,41,233.93098958333334,41L257.1015625,41" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead197)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead197" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-1 LE-2" id="L-1-2" style="opacity: 1;"> 
     <path class="path" d="M396.6796875,37.65781203232565L419.8502604166667,36.54817669360471C443.0208333333333,35.43854135488377,489.3619791666667,33.219270677441884,516.69921875,32.10963533872094C544.0364583333334,31,552.3697916666666,31,556.5364583333334,31L560.703125,31" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead198)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead198" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-1 LE-1-1" id="L-1-1-1" style="opacity: 1;"> 
     <path class="path" d="M396.6796875,57.042502244836875L419.8502604166667,62.368751870697395C443.0208333333333,67.69500149655791,489.3619791666667,78.34750074827896,521.9425736350576,89.50708370747282C554.5231681034483,100.66666666666667,573.3432112068966,112.33333333333333,582.7532327586208,118.16666666666667L592.1632543103449,124" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead199)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead199" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-1 LE-1-2" id="L-1-1-2" style="opacity: 1;"> 
     <path class="path" d="M346.101375,64L377.70166666666665,101.83333333333333C409.3019583333333,139.66666666666666,472.5025416666667,215.33333333333334,513.71090625,253.16666666666666C554.9192708333334,291,574.1354166666666,291,583.7434895833334,291L593.3515625,291" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead200)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead200" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-2-1" id="L-0-2-1" style="opacity: 1;"> 
     <path class="path" d="M58.629679361979164,306L68.53775363498264,277.8333333333333C78.4458279079861,249.66666666666666,98.26197645399306,193.33333333333334,131.74036322699652,165.16666666666666C165.21875,137,212.359375,137,235.9296875,137L259.5,137" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead201)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead201" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-3-1" id="L-0-3-1" style="opacity: 1;"> 
     <path class="path" d="M66.72029622395833,306L75.2799343532986,293.8333333333333C83.83957248263889,281.6666666666667,100.95884874131944,257.3333333333333,134.79713270399307,245.16666666666666C168.63541666666666,233,219.19270833333334,233,244.47135416666666,233L269.75,233" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead202)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead202" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-3-1 LE-1-1" id="L-3-1-1-1" style="opacity: 1;"> 
     <path class="path" d="M384.03125,233L409.3098958333333,233C434.5885416666667,233,485.1458333333333,233,521.8478076550388,222.5C558.5497819767442,212,581.3964389534884,191,592.8197674418606,180.5L604.2430959302326,170" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead203)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead203" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-4-1" id="L-0-4-1" style="opacity: 1;"> 
     <path class="path" d="M93.078125,329L97.24479166666667,329C101.41145833333333,329,109.74479166666667,329,118.078125,329C126.41145833333333,329,134.74479166666666,329,138.91145833333334,329L143.078125,329" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead204)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead204" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-5-1" id="L-0-5-1" style="opacity: 1;"> 
     <path class="path" d="M66.72029622395833,352L75.2799343532986,364.1666666666667C83.83957248263889,376.3333333333333,100.95884874131944,400.6666666666667,125.33879937065973,412.8333333333333C149.71875,425,181.359375,425,197.1796875,425L213,425" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead205)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead205" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-6-1" id="L-0-6-1" style="opacity: 1;"> 
     <path class="path" d="M58.629679361979164,352L68.53775363498264,380.1666666666667C78.4458279079861,408.3333333333333,98.26197645399306,464.6666666666667,113.78723822699652,492.8333333333333C129.3125,521,140.546875,521,146.1640625,521L151.78125,521" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead206)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead206" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
   </g> 
   <g class="edgeLabels"> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1" class="edgeLabel L-LS-0' L-LE-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-1-2" class="edgeLabel L-LS-1' L-LE-2"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-1-1-1" class="edgeLabel L-LS-1' L-LE-1-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-1-1-2" class="edgeLabel L-LS-1' L-LE-1-2"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-2-1" class="edgeLabel L-LS-0' L-LE-2-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-3-1" class="edgeLabel L-LS-0' L-LE-3-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-3-1-1-1" class="edgeLabel L-LS-3-1' L-LE-1-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-4-1" class="edgeLabel L-LS-0' L-LE-4-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-5-1" class="edgeLabel L-LS-0' L-LE-5-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-6-1" class="edgeLabel L-LS-0' L-LE-6-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
   </g> 
   <g class="nodes"> 
    <g class="node default" id="flowchart-0-252" transform="translate(50.5390625,329)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-42.5390625" y="-23" width="85.078125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-32.5390625,-13)"> 
       <foreignobject width="65.078125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVPacket 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-253" transform="translate(326.890625,41)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-69.7890625" y="-23" width="139.578125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-59.7890625,-13)"> 
       <foreignobject width="119.578125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVBufferRef *buf 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-2-254" transform="translate(629.265625,31)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-68.5625" y="-23" width="137.125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-58.5625,-13)"> 
       <foreignobject width="117.125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVBuffer *buffer 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-1-256" transform="translate(629.265625,147)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-57.140625" y="-23" width="114.28125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-47.140625,-13)"> 
       <foreignobject width="94.28125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          uint8_t *data 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-2-258" transform="translate(629.265625,291)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-35.9140625" y="-23" width="71.828125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-25.9140625,-13)"> 
       <foreignobject width="51.828125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int size 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-2-1-260" transform="translate(326.890625,137)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-67.390625" y="-23" width="134.78125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-57.390625,-13)"> 
       <foreignobject width="114.78125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int64_t pts \ dts 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-3-1-262" transform="translate(326.890625,233)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-57.140625" y="-23" width="114.28125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-47.140625,-13)"> 
       <foreignobject width="94.28125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          uint8_t *data 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-4-1-265" transform="translate(326.890625,329)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-183.8125" y="-23" width="367.625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-173.8125,-13)"> 
       <foreignobject width="347.625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int size \ stream_index \ flags \ side_data_elems 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-5-1-267" transform="translate(326.890625,425)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-113.890625" y="-23" width="227.78125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-103.890625,-13)"> 
       <foreignobject width="207.78125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVPacketSideData *side_data 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-6-1-269" transform="translate(326.890625,521)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-175.109375" y="-23" width="350.21875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-165.109375,-13)"> 
       <foreignobject width="330.21875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int64_t duration \ pos \ convergence_duration 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </g> 
</svg> 
<p>AVCodecInternal 用于保存编解码器内部状态,<code>AVCodecInternalPool</code> 结构体中，<code>frames</code> 是一个数组，用于存储 <code>AVFrame</code> 结构体的指针，表示缓冲池中的帧。<code>count</code> 表示缓冲池中的帧数，<code>first_unused</code> 表示第一个未被使用的帧的下标。<code>alloc_count</code> 表示缓冲池中已经分配的帧数，<code>frame_size</code> 表示每帧数据的大小（字节数），<code>pool_size</code> 表示缓冲池的最大帧数，<code>refcounted</code> 表示帧是否支持多线程访问（是否使用引用计数）。</p> 
<svg id="mermaid-svg-C75v84ImNJ4qiFER" width="853.328125" xmlns="http://www.w3.org/2000/svg" height="598" viewbox="-8 -8 853.328125 598" class="mermaid-svg"> 
 <style>#mermaid-svg-C75v84ImNJ4qiFER {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#fff;}#mermaid-svg-C75v84ImNJ4qiFER .error-icon{fill:hsl(180, 0%, 26.9607843137%);}#mermaid-svg-C75v84ImNJ4qiFER .error-text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);stroke:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-C75v84ImNJ4qiFER .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-C75v84ImNJ4qiFER .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-C75v84ImNJ4qiFER .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-C75v84ImNJ4qiFER .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-C75v84ImNJ4qiFER .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-C75v84ImNJ4qiFER .marker{fill:#0b0b0b;stroke:#0b0b0b;}#mermaid-svg-C75v84ImNJ4qiFER .marker.cross{stroke:#0b0b0b;}#mermaid-svg-C75v84ImNJ4qiFER svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-C75v84ImNJ4qiFER .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#fff;}#mermaid-svg-C75v84ImNJ4qiFER .cluster-label text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-C75v84ImNJ4qiFER .cluster-label span{color:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-C75v84ImNJ4qiFER .label text,#mermaid-svg-C75v84ImNJ4qiFER span{fill:#fff;color:#fff;}#mermaid-svg-C75v84ImNJ4qiFER .node rect,#mermaid-svg-C75v84ImNJ4qiFER .node circle,#mermaid-svg-C75v84ImNJ4qiFER .node ellipse,#mermaid-svg-C75v84ImNJ4qiFER .node polygon,#mermaid-svg-C75v84ImNJ4qiFER .node path{fill:#383838;stroke:#fff;stroke-width:1px;}#mermaid-svg-C75v84ImNJ4qiFER .node .label{text-align:center;}#mermaid-svg-C75v84ImNJ4qiFER .node.clickable{cursor:pointer;}#mermaid-svg-C75v84ImNJ4qiFER .arrowheadPath{fill:undefined;}#mermaid-svg-C75v84ImNJ4qiFER .edgePath .path{stroke:#0b0b0b;stroke-width:2.0px;}#mermaid-svg-C75v84ImNJ4qiFER .flowchart-link{stroke:#0b0b0b;fill:none;}#mermaid-svg-C75v84ImNJ4qiFER .edgeLabel{background-color:hsl(-120, 0%, 21.9607843137%);text-align:center;}#mermaid-svg-C75v84ImNJ4qiFER .edgeLabel rect{opacity:0.5;background-color:hsl(-120, 0%, 21.9607843137%);fill:hsl(-120, 0%, 21.9607843137%);}#mermaid-svg-C75v84ImNJ4qiFER .cluster rect{fill:hsl(180, 0%, 26.9607843137%);stroke:hsl(180, 0%, 16.9607843137%);stroke-width:1px;}#mermaid-svg-C75v84ImNJ4qiFER .cluster text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-C75v84ImNJ4qiFER .cluster span{color:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-C75v84ImNJ4qiFER div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(180, 0%, 26.9607843137%);border:1px solid undefined;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-C75v84ImNJ4qiFER :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
 <g> 
  <g class="output"> 
   <g class="clusters"></g> 
   <g class="edgePaths"> 
    <g class="edgePath LS-0 LE-1-1" id="L-0-1-1" style="opacity: 1;"> 
     <path class="path" d="M84.23697916666667,344L98.61414930555556,299.8333333333333C112.99131944444446,255.66666666666666,141.74565972222223,167.33333333333334,165.65147569444443,123.16666666666667C189.55729166666666,79,208.61458333333334,79,218.14322916666666,79L227.671875,79" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead225)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead225" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-1-1 LE-3-1" id="L-1-1-3-1" style="opacity: 1;"> 
     <path class="path" d="M356.0891927083333,56L366.9805772569444,51.833333333333336C377.8719618055555,47.666666666666664,399.65473090277777,39.333333333333336,432.2713758680555,35.166666666666664C464.8880208333333,31,508.3385416666667,31,530.0638020833334,31L551.7890625,31" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead226)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead226" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-1-1 LE-4-1" id="L-1-1-4-1" style="opacity: 1;"> 
     <path class="path" d="M356.0891927083333,102L366.9805772569444,106.16666666666667C377.8719618055555,110.33333333333333,399.65473090277777,118.66666666666667,414.7127821180555,122.83333333333333C429.7708333333333,127,438.1041666666667,127,442.2708333333333,127L446.4375,127" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead227)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead227" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-1-1 LE-9-1" id="L-1-1-9-1" style="opacity: 1;"> 
     <path class="path" d="M316.00889756944446,102L333.5803313078704,122.16666666666667C351.1517650462963,142.33333333333334,386.2946325231481,182.66666666666666,421.7137225115741,202.83333333333334C457.1328125,223,492.828125,223,510.67578125,223L528.5234375,223" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead228)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead228" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-1-4" id="L-0-1-4" style="opacity: 1;"> 
     <path class="path" d="M87.98046875,344L101.73372395833333,315.8333333333333C115.48697916666667,287.6666666666667,142.99348958333334,231.33333333333334,165.486328125,203.16666666666666C187.97916666666666,175,205.45833333333334,175,214.19791666666666,175L222.9375,175" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead229)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead229" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-1-5" id="L-0-1-5" style="opacity: 1;"> 
     <path class="path" d="M99.2109375,344L111.09244791666667,331.8333333333333C122.97395833333333,319.6666666666667,146.73697916666666,295.3333333333333,168.14713541666666,283.1666666666667C189.55729166666666,271,208.61458333333334,271,218.14322916666666,271L227.671875,271" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead230)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead230" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-1-6" id="L-0-1-6" style="opacity: 1;"> 
     <path class="path" d="M145.5,367L149.66666666666666,367C153.83333333333334,367,162.16666666666666,367,175.69270833333334,367C189.21875,367,207.9375,367,217.296875,367L226.65625,367" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead231)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead231" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-1-7" id="L-0-1-7" style="opacity: 1;"> 
     <path class="path" d="M99.2109375,390L111.09244791666667,402.1666666666667C122.97395833333333,414.3333333333333,146.73697916666666,438.6666666666667,162.78515625,450.8333333333333C178.83333333333334,463,187.16666666666666,463,191.33333333333334,463L195.5,463" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead232)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead232" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-1-8" id="L-0-1-8" style="opacity: 1;"> 
     <path class="path" d="M87.98046875,390L101.73372395833333,418.1666666666667C115.48697916666667,446.3333333333333,142.99348958333334,502.6666666666667,174.033203125,530.8333333333334C205.07291666666666,559,239.64583333333334,559,256.9322916666667,559L274.21875,559" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead233)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead233" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
   </g> 
   <g class="edgeLabels"> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1-1" class="edgeLabel L-LS-0' L-LE-1-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-1-1-3-1" class="edgeLabel L-LS-1-1' L-LE-3-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-1-1-4-1" class="edgeLabel L-LS-1-1' L-LE-4-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-1-1-9-1" class="edgeLabel L-LS-1-1' L-LE-9-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1-4" class="edgeLabel L-LS-0' L-LE-1-4"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1-5" class="edgeLabel L-LS-0' L-LE-1-5"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1-6" class="edgeLabel L-LS-0' L-LE-1-6"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1-7" class="edgeLabel L-LS-0' L-LE-1-7"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1-8" class="edgeLabel L-LS-0' L-LE-1-8"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
   </g> 
   <g class="nodes"> 
    <g class="node default" id="flowchart-0-289" transform="translate(76.75,367)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-68.75" y="-23" width="137.5" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-58.75,-13)"> 
       <foreignobject width="117.5" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVCodecInternal 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-1-291" transform="translate(295.96875,79)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-68.296875" y="-23" width="136.59375" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-58.296875,-13)"> 
       <foreignobject width="116.59375" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          FramePool *pool 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-3-1-293" transform="translate(641.8828125,31)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-90.09375" y="-23" width="180.1875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-80.09375,-13)"> 
       <foreignobject width="160.1875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVBufferPool *pools[4] 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-4-1-295" transform="translate(641.8828125,127)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-195.4453125" y="-23" width="390.890625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-185.4453125,-13)"> 
       <foreignobject width="370.890625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int format/width/height/stride_align[8]/linesize[4] 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-9-1-297" transform="translate(641.8828125,223)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-113.359375" y="-23" width="226.71875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-103.359375,-13)"> 
       <foreignobject width="206.71875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int planes/channels/samples 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-4-299" transform="translate(295.96875,175)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-73.03125" y="-23" width="146.0625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-63.03125,-13)"> 
       <foreignobject width="126.0625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVFrame *to_free 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-5-301" transform="translate(295.96875,271)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-68.296875" y="-23" width="136.59375" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-58.296875,-13)"> 
       <foreignobject width="116.59375" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          FramePool *pool 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-6-303" transform="translate(295.96875,367)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-69.3125" y="-23" width="138.625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-59.3125,-13)"> 
       <foreignobject width="118.625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          void *thread_ctx 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-7-305" transform="translate(295.96875,463)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-100.46875" y="-23" width="200.9375" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-90.46875,-13)"> 
       <foreignobject width="180.9375" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVPacket *last_pkt_props 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-8-307" transform="translate(295.96875,559)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-21.75" y="-23" width="43.5" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-11.75,-13)"> 
       <foreignobject width="23.5" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          .... 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </g> 
</svg> 
<svg id="mermaid-svg-W1quyFw9kNVz6c62" width="703.859375" xmlns="http://www.w3.org/2000/svg" height="934" viewbox="-8 -8 703.859375 934" class="mermaid-svg"> 
 <style>#mermaid-svg-W1quyFw9kNVz6c62 {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#fff;}#mermaid-svg-W1quyFw9kNVz6c62 .error-icon{fill:hsl(180, 0%, 26.9607843137%);}#mermaid-svg-W1quyFw9kNVz6c62 .error-text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);stroke:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-W1quyFw9kNVz6c62 .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-W1quyFw9kNVz6c62 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-W1quyFw9kNVz6c62 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-W1quyFw9kNVz6c62 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-W1quyFw9kNVz6c62 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-W1quyFw9kNVz6c62 .marker{fill:#0b0b0b;stroke:#0b0b0b;}#mermaid-svg-W1quyFw9kNVz6c62 .marker.cross{stroke:#0b0b0b;}#mermaid-svg-W1quyFw9kNVz6c62 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-W1quyFw9kNVz6c62 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#fff;}#mermaid-svg-W1quyFw9kNVz6c62 .cluster-label text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-W1quyFw9kNVz6c62 .cluster-label span{color:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-W1quyFw9kNVz6c62 .label text,#mermaid-svg-W1quyFw9kNVz6c62 span{fill:#fff;color:#fff;}#mermaid-svg-W1quyFw9kNVz6c62 .node rect,#mermaid-svg-W1quyFw9kNVz6c62 .node circle,#mermaid-svg-W1quyFw9kNVz6c62 .node ellipse,#mermaid-svg-W1quyFw9kNVz6c62 .node polygon,#mermaid-svg-W1quyFw9kNVz6c62 .node path{fill:#383838;stroke:#fff;stroke-width:1px;}#mermaid-svg-W1quyFw9kNVz6c62 .node .label{text-align:center;}#mermaid-svg-W1quyFw9kNVz6c62 .node.clickable{cursor:pointer;}#mermaid-svg-W1quyFw9kNVz6c62 .arrowheadPath{fill:undefined;}#mermaid-svg-W1quyFw9kNVz6c62 .edgePath .path{stroke:#0b0b0b;stroke-width:2.0px;}#mermaid-svg-W1quyFw9kNVz6c62 .flowchart-link{stroke:#0b0b0b;fill:none;}#mermaid-svg-W1quyFw9kNVz6c62 .edgeLabel{background-color:hsl(-120, 0%, 21.9607843137%);text-align:center;}#mermaid-svg-W1quyFw9kNVz6c62 .edgeLabel rect{opacity:0.5;background-color:hsl(-120, 0%, 21.9607843137%);fill:hsl(-120, 0%, 21.9607843137%);}#mermaid-svg-W1quyFw9kNVz6c62 .cluster rect{fill:hsl(180, 0%, 26.9607843137%);stroke:hsl(180, 0%, 16.9607843137%);stroke-width:1px;}#mermaid-svg-W1quyFw9kNVz6c62 .cluster text{fill:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-W1quyFw9kNVz6c62 .cluster span{color:rgb(186.2500000001, 186.2500000001, 186.2500000001);}#mermaid-svg-W1quyFw9kNVz6c62 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(180, 0%, 26.9607843137%);border:1px solid undefined;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-W1quyFw9kNVz6c62 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style> 
 <g> 
  <g class="output"> 
   <g class="clusters"></g> 
   <g class="edgePaths"> 
    <g class="edgePath LS-0 LE-1" id="L-0-1" style="opacity: 1;"> 
     <path class="path" d="M52.7607421875,440L63.212076822916664,371.8333333333333C73.66341145833333,303.6666666666667,94.56608072916667,167.33333333333334,128.00439453125,99.16666666666667C161.44270833333334,31,207.41666666666666,31,230.40364583333334,31L253.390625,31" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead256)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead256" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-2" id="L-0-2" style="opacity: 1;"> 
     <path class="path" d="M53.768275669642854,440L64.05168805803571,387.8333333333333C74.33510044642857,335.6666666666667,94.90192522321428,231.33333333333334,129.48091052827382,179.16666666666666C164.05989583333334,127,212.65104166666666,127,236.94661458333334,127L261.2421875,127" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead257)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead257" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-3" id="L-0-3" style="opacity: 1;"> 
     <path class="path" d="M55.5818359375,440L65.56298828125,403.8333333333333C75.544140625,367.6666666666667,95.50644531249999,295.3333333333333,123.37171223958335,259.1666666666667C151.23697916666666,223,187.00520833333334,223,204.88932291666666,223L222.7734375,223" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead258)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead258" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-4" id="L-0-4" style="opacity: 1;"> 
     <path class="path" d="M59.8134765625,440L69.08935546875,419.8333333333333C78.365234375,399.6666666666667,96.9169921875,359.3333333333333,110.35953776041667,339.1666666666667C123.80208333333333,319,132.13541666666666,319,136.30208333333334,319L140.46875,319" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead259)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead259" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-5" id="L-0-5" style="opacity: 1;"> 
     <path class="path" d="M80.9716796875,440L86.72119140625,435.8333333333333C92.470703125,431.6666666666667,103.9697265625,423.3333333333333,127.74788411458333,419.1666666666667C151.52604166666666,415,187.58333333333334,415,205.61197916666666,415L223.640625,415" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead260)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead260" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-9" id="L-0-9" style="opacity: 1;"> 
     <path class="path" d="M80.9716796875,486L86.72119140625,490.1666666666667C92.470703125,494.3333333333333,103.9697265625,502.6666666666667,130.59814453125,506.8333333333333C157.2265625,511,198.984375,511,219.86328125,511L240.7421875,511" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead261)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead261" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-9 LE-91" id="L-9-91" style="opacity: 1;"> 
     <path class="path" d="M369.7479654947917,488L395.7457004123264,475.8333333333333C421.74343532986114,463.6666666666667,473.7389051649306,439.3333333333333,503.9033067491319,427.1666666666667C534.0677083333334,415,542.4010416666666,415,546.5677083333334,415L550.734375,415" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead262)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead262" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-9 LE-92" id="L-9-92" style="opacity: 1;"> 
     <path class="path" d="M400.4609375,511L421.33984375,511C442.21875,511,483.9765625,511,510.92578125,511C537.875,511,550.015625,511,556.0859375,511L562.15625,511" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead263)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead263" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-9 LE-93" id="L-9-93" style="opacity: 1;"> 
     <path class="path" d="M369.7479654947917,534L395.7457004123264,546.1666666666666C421.74343532986114,558.3333333333334,473.7389051649306,582.6666666666666,509.3447129991319,594.8333333333334C544.9505208333334,607,564.1666666666666,607,573.7747395833334,607L583.3828125,607" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead264)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead264" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-12" id="L-0-12" style="opacity: 1;"> 
     <path class="path" d="M59.8134765625,486L69.08935546875,506.1666666666667C78.365234375,526.3333333333334,96.9169921875,566.6666666666666,123.07307942708333,586.8333333333334C149.22916666666666,607,182.98958333333334,607,199.86979166666666,607L216.75,607" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead265)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead265" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-15" id="L-0-15" style="opacity: 1;"> 
     <path class="path" d="M55.5818359375,486L65.56298828125,522.1666666666666C75.544140625,558.3333333333334,95.50644531249999,630.6666666666666,123.16988932291667,666.8333333333334C150.83333333333334,703,186.19791666666666,703,203.88020833333334,703L221.5625,703" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead266)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead266" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-17" id="L-0-17" style="opacity: 1;"> 
     <path class="path" d="M53.768275669642854,486L64.05168805803571,538.1666666666666C74.33510044642857,590.3333333333334,94.90192522321428,694.6666666666666,123.54080636160715,746.8333333333334C152.1796875,799,188.890625,799,207.24609375,799L225.6015625,799" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead267)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead267" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
    <g class="edgePath LS-0 LE-18" id="L-0-18" style="opacity: 1;"> 
     <path class="path" d="M52.7607421875,486L63.212076822916664,554.1666666666666C73.66341145833333,622.3333333333334,94.56608072916667,758.6666666666666,124.09293619791667,826.8333333333334C153.61979166666666,895,191.77083333333334,895,210.84635416666666,895L229.921875,895" marker-end="url(https://editor.csdn.net/md/?articleId=129879004#arrowhead268)" style="fill:none"></path> 
     <defs> 
      <marker id="arrowhead268" viewbox="0 0 10 10" refx="9" refy="5" markerunits="strokeWidth" markerwidth="8" markerheight="6" orient="auto"> 
       <path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1px; stroke-dasharray: 1px, 0px;"></path> 
      </marker> 
     </defs> 
    </g> 
   </g> 
   <g class="edgeLabels"> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-1" class="edgeLabel L-LS-0' L-LE-1"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-2" class="edgeLabel L-LS-0' L-LE-2"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-3" class="edgeLabel L-LS-0' L-LE-3"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-4" class="edgeLabel L-LS-0' L-LE-4"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-5" class="edgeLabel L-LS-0' L-LE-5"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-9" class="edgeLabel L-LS-0' L-LE-9"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-9-91" class="edgeLabel L-LS-9' L-LE-91"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-9-92" class="edgeLabel L-LS-9' L-LE-92"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-9-93" class="edgeLabel L-LS-9' L-LE-93"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-12" class="edgeLabel L-LS-0' L-LE-12"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-15" class="edgeLabel L-LS-0' L-LE-15"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-17" class="edgeLabel L-LS-0' L-LE-17"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
    <g class="edgeLabel" transform="" style="opacity: 1;"> 
     <g transform="translate(0,0)" class="label"> 
      <rect rx="0" ry="0" width="0" height="0"></rect> 
      <foreignobject width="0" height="0"> 
       <div style="display: inline-block; white-space: nowrap;"> 
        <span id="L-L-0-18" class="edgeLabel L-LS-0' L-LE-18"></span> 
       </div> 
      </foreignobject> 
     </g> 
    </g> 
   </g> 
   <g class="nodes"> 
    <g class="node default" id="flowchart-0-334" transform="translate(49.234375,463)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-41.234375" y="-23" width="82.46875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-31.234375,-13)"> 
       <foreignobject width="62.46875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVFrame 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-1-336" transform="translate(320.6015625,31)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-67.2109375" y="-23" width="134.421875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-57.2109375,-13)"> 
       <foreignobject width="114.421875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          uint8_t *data[8] 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-2-338" transform="translate(320.6015625,127)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-59.359375" y="-23" width="118.71875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-49.359375,-13)"> 
       <foreignobject width="98.71875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int linesize[8] 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-3-340" transform="translate(320.6015625,223)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-97.828125" y="-23" width="195.65625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-87.828125,-13)"> 
       <foreignobject width="175.65625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          uint8_t **extended_data 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-4-342" transform="translate(320.6015625,319)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-180.1328125" y="-23" width="360.265625" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-170.1328125,-13)"> 
       <foreignobject width="340.265625" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int width\height\nb_samples\format\key_frame 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-5-344" transform="translate(320.6015625,415)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-96.9609375" y="-23" width="193.921875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-86.9609375,-13)"> 
       <foreignobject width="173.921875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVPictureType pict_type 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-9-346" transform="translate(320.6015625,511)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-79.859375" y="-23" width="159.71875" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-69.859375,-13)"> 
       <foreignobject width="139.71875" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVBufferRef *buf[8] 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-12-353" transform="translate(320.6015625,607)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-103.8515625" y="-23" width="207.703125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-93.8515625,-13)"> 
       <foreignobject width="187.703125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVColorRange color_range 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-15-355" transform="translate(320.6015625,703)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-99.0390625" y="-23" width="198.078125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-89.0390625,-13)"> 
       <foreignobject width="178.078125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVColorSpace colorspace 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-17-357" transform="translate(320.6015625,799)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-95" y="-23" width="190" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-85,-13)"> 
       <foreignobject width="170" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVDictionary *metadata 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-18-359" transform="translate(320.6015625,895)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-90.6796875" y="-23" width="181.359375" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-80.6796875,-13)"> 
       <foreignobject width="161.359375" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int channels \ pkt_size 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-91-347" transform="translate(619.296875,415)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-68.5625" y="-23" width="137.125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-58.5625,-13)"> 
       <foreignobject width="117.125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          AVBuffer *buffer 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-92-349" transform="translate(619.296875,511)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-57.140625" y="-23" width="114.28125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-47.140625,-13)"> 
       <foreignobject width="94.28125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          uint8_t *data 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
    <g class="node default" id="flowchart-93-351" transform="translate(619.296875,607)" style="opacity: 1;"> 
     <rect rx="5" ry="5" x="-35.9140625" y="-23" width="71.828125" height="46" class="label-container"></rect> 
     <g class="label" transform="translate(0,0)"> 
      <g transform="translate(-25.9140625,-13)"> 
       <foreignobject width="51.828125" height="26"> 
        <div style="display: inline-block; white-space: nowrap;">
          int size 
        </div> 
       </foreignobject> 
      </g> 
     </g> 
    </g> 
   </g> 
  </g> 
 </g> 
</svg> 
<h4><a id="1avformat_open_input_435"></a>1.avformat_open_input分析</h4> 
<p><code>libavformat/utils.c</code>文件函数定义:</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span><span class="token operator">*</span>ps<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span> AVInputFormat <span class="token operator">*</span>fmt<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
`ps`：指向`AVFormatContext`结构体指针的指针。`AVFormatContext`是一个媒体文件的容器，它包含了媒体文件的所有信息，如音频、视频、字幕等的流信息、文件格式信息、封装格式等。
`url`：输入文件的URL地址。
`fmt`：强制指定输入文件格式。如果设置为NULL，则该函数将自动检测输入文件的格式。
`options`：指向指向`AVDictionary`结构体指针的指针，它用于传递额外的选项。*/</span>
</code></pre> 
<ul><li>初始化<code>AVFormatContext</code>结构体、初始化<code>ID3v2ExtraMeta</code>结构体</li></ul> 
<pre><code class="prism language-c">gef➤  pt ID3v2ExtraMeta
type <span class="token operator">=</span> <span class="token keyword">struct</span> <span class="token class-name">ID3v2ExtraMeta</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>tag<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ID3v2ExtraMeta</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>调用avformat_alloc_context来开辟大小为AVFormatContext结构体的内存空间</li></ul> 
<pre><code class="prism language-c"><span class="token number">545</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>如果指定了输入文件格式（即<code>fmt</code>不为NULL），则尝试将其作为输入格式。</li></ul> 
<pre><code class="prism language-c"><span class="token number">551</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>fmt<span class="token punctuation">)</span>
<span class="token number">552</span>	         s<span class="token operator">-&gt;</span>iformat <span class="token operator">=</span> fmt<span class="token punctuation">;</span>
</code></pre> 
<ul><li>初始化字典（<code>AVDictionary</code>）选项。</li></ul> 
<pre><code class="prism language-c"><span class="token number">560</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">av_opt_set_dict</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>打开输入文件，读取并解析文件头，获取文件格式信息。</li></ul> 
<pre><code class="prism language-c"><span class="token number">573</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">init_input</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">init_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token number">420</span>	     AVProbeData pd <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> filename<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>匹配文件名字是否处于白名单,也就是该文件后缀是否可用于分析</li></ul> 
<pre><code class="prism language-c"><span class="token number">593</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>format_whitelist <span class="token operator">&amp;&amp;</span> <span class="token function">av_match_list</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>format_whitelist<span class="token punctuation">,</span> <span class="token char">','</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">594</span>	         <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Format not on whitelist \'%s\'\n"</span><span class="token punctuation">,</span> s<span class="token operator">-&gt;</span>format_whitelist<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>设置 private data</li></ul> 
<pre><code class="prism language-c"><span class="token number">613</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>priv_data <span class="token operator">=</span> <span class="token function">av_mallocz</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>priv_data_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">620</span>	        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">av_opt_set_dict</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//av_opt_set_dict用于设置输入文件的 AVFormatContext 对象的一个属性</span>
</code></pre> 
<ul><li>获取文件metadata</li></ul> 
<pre><code class="prism language-c"><span class="token number">627</span>	         <span class="token function">ff_id3v2_read_dict</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>id3v2_meta<span class="token punctuation">,</span> ID3v2_DEFAULT_MAGIC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>id3v2_extra_meta<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">631</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span><span class="token function">read_header</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>将一个 AVPacket 对象中的附加图片数据加入 AVFormatContext 结构体的 attached_pic 队列中。</li></ul> 
<blockquote> 
 <p>这个队列用于存储音视频文件中的所有附加图片数据，可以在编码时自动将这些图片数据写入文件</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token number">661</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">avformat_queue_attached_pictures</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">//avformat_queue_attached_pictures 函数是 FFmpeg 中 AVFormatContext 结构体的一个成员函数</span>
</code></pre> 
<ul><li>填充AVFormatContext结构体数据</li></ul> 
<pre><code class="prism language-c"><span class="token number">667</span>	     s<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>raw_packet_buffer_remaining_size <span class="token operator">=</span> RAW_PACKET_BUFFER_SIZE<span class="token punctuation">;</span>
</code></pre> 
<ul><li>查找并打开相应的解码器，将解码器与输入流相关联。</li></ul> 
<blockquote> 
 <p>这里的 s-&gt;nb_streams -&gt; 1音频流、0视频流、3字幕流</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token number">671</span>	     <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token number">672</span>	         s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>orig_codec_id <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">;</span>
</code></pre> 
<ul><li>初始化完成<code>AVFormatContext</code>结构体。</li></ul> 
<pre><code class="prism language-c"><span class="token number">678</span>      <span class="token operator">*</span>ps <span class="token operator">=</span> s<span class="token punctuation">;</span>
<span class="token number">679</span>	     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="2avformat_find_stream_info_547"></a>2.avformat_find_stream_info分析</h4> 
<p><code>libavformat/utils.c</code>文件函数定义:</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>ic<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span>
<span class="token comment">/*
`ic`：指向`AVFormatContext`结构体指针的指针。`AVFormatContext`是一个媒体文件的容器，它包含了媒体文件的所有信息，如音频、视频、字幕等的流信息、文件格式信息、封装格式等。
*/</span>
</code></pre> 
<p>此时<code>AVFormatContext *ic</code>结构体内存（部分重要成员）如下：</p> 
<blockquote> 
 <p>该函数以及经过avformat_open_input结构体进行初始化了，所以会有数据</p> 
</blockquote> 
<pre><code class="prism language-c">gef➤  p <span class="token operator">*</span>ic
$<span class="token number">2</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  av_class <span class="token operator">=</span> <span class="token number">0x562861024e20</span> <span class="token operator">&lt;</span>av_format_context_class<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  iformat <span class="token operator">=</span> <span class="token number">0x562861083540</span> <span class="token operator">&lt;</span>ff_mov_demuxer<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oformat <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  priv_data <span class="token operator">=</span> <span class="token number">0x5628634e7740</span><span class="token punctuation">,</span>
  pb <span class="token operator">=</span> <span class="token number">0x5628634ef750</span><span class="token punctuation">,</span>
  ctx_flags <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  nb_streams <span class="token operator">=</span> <span class="token number">0x2</span><span class="token punctuation">,</span>
  streams <span class="token operator">=</span> <span class="token number">0x5628634e7c80</span><span class="token punctuation">,</span>
  filename <span class="token operator">=</span> <span class="token string">"input.mov"</span><span class="token punctuation">,</span> <span class="token char">'\000'</span> <span class="token operator">&lt;</span>repeats <span class="token number">1014</span> times<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  url <span class="token operator">=</span> <span class="token number">0x5628634e7540</span> <span class="token string">"input.mov"</span><span class="token punctuation">,</span>
  start_time <span class="token operator">=</span> <span class="token number">0x8000000000000000</span><span class="token punctuation">,</span>
  duration <span class="token operator">=</span> <span class="token number">0x209f90</span><span class="token punctuation">,</span>
  bit_rate <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  packet_size <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  max_delay <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span>
  flags <span class="token operator">=</span> <span class="token number">0x200000</span><span class="token punctuation">,</span>
  probesize <span class="token operator">=</span> <span class="token number">0x4c4b40</span><span class="token punctuation">,</span>
  max_analyze_duration <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  video_codec_id <span class="token operator">=</span> AV_CODEC_ID_NONE<span class="token punctuation">,</span>
  audio_codec_id <span class="token operator">=</span> AV_CODEC_ID_NONE<span class="token punctuation">,</span>
  subtitle_codec_id <span class="token operator">=</span> AV_CODEC_ID_NONE<span class="token punctuation">,</span>
  max_index_size <span class="token operator">=</span> <span class="token number">0x100000</span><span class="token punctuation">,</span>
  metadata <span class="token operator">=</span> <span class="token number">0x5628634e7900</span><span class="token punctuation">,</span>
  video_codec <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  audio_codec <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  subtitle_codec <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  data_codec <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  protocol_whitelist <span class="token operator">=</span> <span class="token number">0x5628634e7720</span> <span class="token string">"file,crypto"</span><span class="token punctuation">,</span>
  io_open <span class="token operator">=</span> <span class="token number">0x5628607eee2a</span> <span class="token operator">&lt;</span>io_open_default<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  io_close <span class="token operator">=</span> <span class="token number">0x5628607eee1e</span> <span class="token operator">&lt;</span>io_close_default<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  protocol_blacklist <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>媒体文件中是否存在丢失的流，即媒体文件中定义了但未实际存在的流。如果<code>missing_streams</code>不为空，它将指向一个整型数组，其中每个元素代表一个丢失的流的索引。</li></ul> 
<blockquote> 
 <p>例如转码或合并多个媒体文件时，如果存在丢失的流，通常需要进行处理，以免影响后续的操作。</p> 
</blockquote> 
<pre><code class="prism language-c">   <span class="token number">3583</span>	     <span class="token keyword">int</span> <span class="token operator">*</span>missing_streams <span class="token operator">=</span> <span class="token function">av_opt_ptr</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>priv_class<span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">,</span> <span class="token string">"missing_streams"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>获取<code>max_analyze_duration</code>，用于设置媒体文件探测流的最大持续时间。</li></ul> 
<blockquote> 
 <p>这里的AV_TIME_BASE=1000000 也就是1秒，flv文件那么探测时间为90秒</p> 
</blockquote> 
<pre><code class="prism language-c">   <span class="token number">3591</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>max_analyze_duration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token number">3592</span>	         max_stream_analyze_duration <span class="token operator">=</span>
   <span class="token number">3593</span>	         max_analyze_duration        <span class="token operator">=</span> <span class="token number">5</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
   <span class="token number">3594</span>	         max_subtitle_analyze_duration <span class="token operator">=</span> <span class="token number">30</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
 → <span class="token number">3595</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"flv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token number">3596</span>	             max_stream_analyze_duration <span class="token operator">=</span> <span class="token number">90</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
   <span class="token number">3597</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"mpeg"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token string">"mpegts"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token number">3598</span>	             max_stream_analyze_duration <span class="token operator">=</span> <span class="token number">7</span><span class="token operator">*</span>AV_TIME_BASE<span class="token punctuation">;</span>
   <span class="token number">3599</span>	     <span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>avio_tell()</code>函数用于获取当前的读取位置，<code>ic-&gt;pb-&gt;bytes_read</code>表示已经读取的字节数，<code>ic-&gt;pb-&gt;seek_count</code>表示执行的寻址次数，<code>count</code>表示读取的帧数。记录程序运行信息</li></ul> 
<pre><code class="prism language-c">   <span class="token number">3601</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span>
   <span class="token number">3602</span>	         <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"Before avformat_find_stream_info() pos: %"</span>PRId64<span class="token string">" bytes read:%"</span>PRId64<span class="token string">" seeks:%d nb_streams:%d\n"</span><span class="token punctuation">,</span>
   <span class="token number">3603</span>	                <span class="token function">avio_tell</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>bytes_read<span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>seek_count<span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>对输入文件的每个数据流进行遍历</li></ul> 
<blockquote> 
 <p>一般来说解封装一个正常的mov文件ic-&gt;nb_streams会为3，其中:</p> 
 <ul><li>ic-&gt;nb_streams[0] 为视频流</li><li>ic-&gt;nb_streams[1] 为音频流</li><li>ic-&gt;nb_streams[2] 为字幕流</li></ul> 
 <p>我这里没有字幕流，所以ic-&gt;nb_streams:2，这里会循环2遍，第一遍视频流，第二遍音频流。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">//3605行</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>codec<span class="token punctuation">;</span>
        AVDictionary <span class="token operator">*</span>thread_opt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        st <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>					<span class="token comment">//获取该数据流</span>
        avctx <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token punctuation">;</span>	<span class="token comment">//获取数据流的上下文AVCodecContext结构体</span>
      
      <span class="token comment">/*
      比如i为0，也就是视频流，它的上下文AVCodecContext结构体内容（部分）如下：
      gef➤  p *avctx
      struct AVCodecContext * = {
        av_class = 0x56286104ddc0 &lt;av_codec_context_class&gt;,
        log_level_offset = 0x0,
        codec_type = AVMEDIA_TYPE_VIDEO,
        codec = 0x0,
        codec_id = AV_CODEC_ID_H264,
        codec_tag = 0x31637661
        }
      */</span>

        <span class="token comment">// only for the split stuff</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token operator">-&gt;</span>parser <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_NOPARSE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>request_probe <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            st<span class="token operator">-&gt;</span>parser <span class="token operator">=</span> <span class="token function">av_parser_init</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/*
          	初始化解析器。还是视频流为例子：这里的st-&gt;parser则为AV_CODEC_ID_H264 = 0x1b，那么st-&gt;parser会按照H264编码格式进行解析：
          	1. 这里是先要进行拆帧，将连续的视频帧切割成单独的帧
          	2. 拆分成编码器能够处理的数据块，以便进一步进行解码、编码、剪辑、转换等处理。那么下面同样会进行解码操作
          	3. 比如下面则初始化了ff_h264_parser解析器：
          	
          	视频流：
          	gef➤  p *st.parser
            struct AVCodecParserContext * = {
              priv_data = 0x5628634ea160,
              parser = 0x5628610b90e0 &lt;ff_h264_parser&gt;,
            }
            
            (第二次循环)音频流：
            gef➤  p *st.parser
            struct AVCodecParserContext * = {
              priv_data = 0x5628634ed2a0,
              parser = 0x5628610b3900 &lt;ff_aac_parser&gt;,
            }
          */</span>
<span class="token comment">//...</span>
          <span class="token comment">/* 分配解码器：为每个流分配解码器并初始化`AVCodecContext`结构体，以便后续进行解码操作。 */</span>
  		  ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>

  
<span class="token comment">//...</span>
        codec <span class="token operator">=</span> <span class="token function">find_probe_decoder</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> st<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/*
	          根据音视频流的编码类型（codec_id）来再注册的解码器列表中查找到对应的解码器，如果没有找到合适的解码器，它会尝试使用探测器（probe）来查找合适的解码器。
	          视频流：codec_id==AV_CODEC_ID_H264
	          gef➤  p codec
						$22 = (const AVCodec *) 0x562861099c40 &lt;ff_h264_decoder&gt;
						
						音频流：codec_id==AV_CODEC_ID_AAC
						gef➤  p codec
            $44 = (const AVCodec *) 0x5628610b3a40 &lt;ff_aac_decoder&gt;
          */</span>

        <span class="token function">av_dict_set</span><span class="token punctuation">(</span>options <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>thread_opt<span class="token punctuation">,</span> <span class="token string">"threads"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
          <span class="token comment">/*
          	av_dict_set() 函数是 FFmpeg 中用于设置字典（dictionary）元素的函数，它的作用是将一个键值对添加到字典中。字典是一种键值对的集合，它可以用于存储各种参数和配置信息，所以这里是设置threads个数为1个
          	gef➤  p *thread_opt
            struct AVDictionary * = {
              count = 0x1,
              elems = 0x5628634f7b20
            }
          */</span>

        <span class="token comment">/* 确保正确设置了SUBTITLE_HEADER,此时st-&gt;codecpar-&gt;codec_type为AVMEDIA_TYPE_VIDEO 这里跳过分析 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_SUBTITLE
            <span class="token operator">&amp;&amp;</span> codec <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//...</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 根据不同情况决定是否需要打开解码器，这是一项耗性能、耗时操作。
        		1. 该数据流不能有传入解码器参数
        		2. 该数据流没有请求探测数据
        	满足上述条件，则打开对应的解码器
        */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_codec_parameters</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>request_probe <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>codec <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>codec<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> options <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>thread_opt<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                  <span class="token comment">/*
                  	这里的st-&gt;request_probe==0，且没有传入解码器的参数,则进入打开解码器
                  */</span>
                    <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span>
                           <span class="token string">"Failed to open codec in %s\n"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">)</span>
            <span class="token function">av_dict_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//3680行</span>
</code></pre> 
<ul><li>表示在后续的解码和编码过程中需要重新计算时间戳、重新计算帧率，同样也是按照数据流来逐个遍历</li></ul> 
<pre><code class="prism language-c">   <span class="token number">3682</span>	     <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token number">3683</span>	 #<span class="token keyword">if</span> FF_API_R_FRAME_RATE
   <span class="token number">3684</span>	         ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>last_dts <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
   <span class="token number">3685</span>	 #endif
 → <span class="token number">3686</span>	         ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_first_dts <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
   <span class="token number">3687</span>	         ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>fps_last_dts  <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
   <span class="token number">3688</span>	     <span class="token punctuation">}</span>
</code></pre> 
<ul><li>控制循环读取视频信息</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//3691</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> analyzed_all_streams<span class="token punctuation">;</span>
      
      <span class="token comment">/*检查该回调函数是否被触发。如果中断回调函数被触发，表示需要中断当前操作，即停止执行后续的代码*/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ff_check_interrupt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ic<span class="token operator">-&gt;</span>interrupt_callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> AVERROR_EXIT<span class="token punctuation">;</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"interrupted\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 同样是遍历每个数据流进行处理 */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> fps_analyze_framecount <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
          <span class="token comment">/*
	          初始化，通过分析20帧来获取fps
          */</span>
            <span class="token keyword">int</span> count<span class="token punctuation">;</span>

            st <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_codec_parameters</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>     
          <span class="token comment">/*
          	按照数据的不同类别、大小、格式来确定需要分析多少帧才能得到正确的fps
          */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">av_q2d</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0005</span><span class="token punctuation">)</span>
                fps_analyze_framecount <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tb_unreliable</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
                fps_analyze_framecount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>fps_probe_size <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                fps_analyze_framecount <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>fps_probe_size<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_ATTACHED_PIC<span class="token punctuation">)</span>
                fps_analyze_framecount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
						<span class="token comment">//...</span>
        <span class="token punctuation">}</span>
      
      	<span class="token comment">//...</span>
      
        <span class="token comment">/*
        	!!!!!!!!!!!!全部信息探测完成，退出循环        	!!!!!!!!!!!!
        */</span>
        analyzed_all_streams <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>missing_streams <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">*</span>missing_streams<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            analyzed_all_streams <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">/* NOTE: If the format has no header, then we need to read some
             * packets to get most of the streams, so we cannot stop here. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>ctx_flags <span class="token operator">&amp;</span> AVFMTCTX_NOHEADER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/* If we found the info for all the codecs, we can stop. */</span>
                ret <span class="token operator">=</span> count<span class="token punctuation">;</span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"All info found\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                flush_codecs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//...</span>
      <span class="token comment">/*
        从媒体文件中读取一帧数据并将其存储到一个`AVPacket`结构体中，参数解释：
          1. `ic`是一个指向`AVFormatContext`结构体的指针，表示需要读取的媒体文件。
          2. `&amp;pkt1`表示一个`AVPacket`结构体的指针，表示读取到的一帧数据将被存储到该结构体中
      */</span>
        ret <span class="token operator">=</span> <span class="token function">read_frame_internal</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/*
          gef➤  p pkt1
          $28 = {
            buf = 0x561e8b0e3ac0,
            pts = 0x0,
            dts = 0xfffffffffffff82e,
            data = 0x561e8b118340 "",
            size = 0x17649,
            stream_index = 0x0,
            flags = 0x1,
            side_data = 0x0,
            side_data_elems = 0x0,
            duration = 0x3e9,
            pos = 0x24,
            convergence_duration = 0x0
          }
          这个`read_frame_internal()`则是一个内部函数，用于从媒体文件中读取一帧数据。它在内部会调用一些其他的函数和变量，用于解析媒体文件的数据，从而读取一帧数据。不同于`av_read_frame()`是FFmpeg中的一个公共函数，用于从`AVFormatContext`结构体中读取一帧数据。

					一般用户只能使用av_read_frame()函数来读取帧
      */</span>

      <span class="token comment">//...</span>
      
      
        pkt <span class="token operator">=</span> <span class="token operator">&amp;</span>pkt1<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_NOBUFFER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">ff_packet_list_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ic<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>ic<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>packet_buffer_end<span class="token punctuation">,</span>
                                     pkt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/*
          	将`AVPacket`结构体添加到队列中也就是上面的pkt1:
      1. ic-&gt;internal是一个指向AVFormatContextInternal结构体的指针，表示一个音视频文件或网络流的格式上下文
      2. packet_buffer是一个指向AVPacketList结构体的指针，表示存储AVPacket结构体的队列
      3. packet_buffer_end是一个指向AVPacketList结构体的指针，表示队列的尾部。
          */</span>
          
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

				<span class="token comment">//...</span>
      
      <span class="token comment">/*
        判断是否已经对视频流进行了帧率计算
				如果还没有计算过帧率，则将`AVStream`结构体中的`avg_frame_rate`设置为流的帧率
      */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_R_FRAME_RATE</span></span>
            <span class="token function">ff_rfps_add_frame</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span>
                st<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>frame_delay_evidence <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      
      
      <span class="token comment">/* 
      	判断音视频流是否已经设置了编解码器的私有数据(`extradata`) 
      */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>extradata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">extract_extradata</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/*
          	没有则将pkt中的extradata数据复制到AVStream结构体中的codecpar-&gt;extradata中，并设置AVStream结构体中的codecpar-&gt;extradata_size为pkt中extradata数据的大小。
          */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      	<span class="token comment">/*
      		如果仍然没有信息，我们尝试打开编解码器并解压缩帧。我们试图在大多数情况下避免这种情况，因为它需要更长的时间和使用更多的内存。对于MPEG4，我们需要对QuickTime进行解压缩。
      	*/</span>
	      <span class="token comment">/*
    	  	如果设置了AV_CODEC_CAP_CHANNEL_CONF，这将强制对至少一帧编解码器数据进行解码，这将确保编解码器初始化通道配置，而不仅仅信任来自容器的值。
  	    */</span>
        <span class="token function">try_decode_frame</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> st<span class="token punctuation">,</span> pkt<span class="token punctuation">,</span>
                         <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> orig_nb_streams<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">&amp;</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/*
      	我在使用input.mov 的视频流时这个函数被调用，待查原理 -&gt; TODO
      	这里并没有进行全部解码，只是为了验证探测信息正确而尝试解码几帧来确定探测信息准确性
      */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_NOBUFFER<span class="token punctuation">)</span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>

        st<span class="token operator">-&gt;</span>codec_info_nb_frames<span class="token operator">++</span><span class="token punctuation">;</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//3911</span>
</code></pre> 
<ul><li>计算给定视频流的平均帧率</li></ul> 
<pre><code class="prism language-c">   <span class="token number">3964</span>	     <span class="token function">ff_rfps_calculate</span><span class="token punctuation">(</span>ic<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>循环处理数据流的探测信息</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//3966</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        st <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        avctx <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token punctuation">;</span>
        
        <span class="token comment">// 1. 进入视频数据流</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_id <span class="token operator">==</span> AV_CODEC_ID_RAWVIDEO <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>codec_tag <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>bits_per_coded_sample<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">//处理原生数据，因为我这里用的是h264编码视频，所以不会进来该流程</span>
                <span class="token class-name">uint32_t</span> tag<span class="token operator">=</span> <span class="token function">avcodec_pix_fmt_to_codec_tag</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avpriv_find_pix_fmt</span><span class="token punctuation">(</span><span class="token function">avpriv_get_raw_pix_fmt_tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span> <span class="token operator">==</span> avctx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">)</span>
                    avctx<span class="token operator">-&gt;</span>codec_tag<span class="token operator">=</span> tag<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* estimate average framerate if not set by demuxer */</span>
   					<span class="token comment">//...</span>

          <span class="token comment">//没有读取到帧率</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token operator">-&gt;</span>r_frame_rate<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token comment">//..</span>
            <span class="token punctuation">}</span>
          
          
          <span class="token comment">//2. 进入音频数据流</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>bits_per_coded_sample<span class="token punctuation">)</span>
                avctx<span class="token operator">-&gt;</span>bits_per_coded_sample <span class="token operator">=</span>
                    <span class="token function">av_get_bits_per_sample</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">//根据音频服务类型设置流配置</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>audio_service_type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/*
                gef➤  p avctx-&gt;audio_service_type
								$69 = AV_AUDIO_SERVICE_TYPE_MAIN
                */</span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_EFFECTS<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_CLEAN_EFFECTS<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_VISUALLY_IMPAIRED<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_VISUAL_IMPAIRED<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_HEARING_IMPAIRED<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_HEARING_IMPAIRED<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_COMMENTARY<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_COMMENT<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AV_AUDIO_SERVICE_TYPE_KARAOKE<span class="token operator">:</span>
                st<span class="token operator">-&gt;</span>disposition <span class="token operator">=</span> AV_DISPOSITION_KARAOKE<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//4056</span>
</code></pre> 
<ul><li>尝试从文件中读取探测的字节数(probesize)长度的数据来探测文件的属性信息</li></ul> 
<pre><code class="prism language-c"> → <span class="token number">4058</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>probesize<span class="token punctuation">)</span>
   <span class="token number">4059</span>	         <span class="token function">estimate_timings</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> old_offset<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//分析视频流中的关键帧信息以及时间戳信息</span>
</code></pre> 
<ul><li>清除文件的元数据信息</li></ul> 
<blockquote> 
 <p>文件的元数据信息包括文件的标题、作者、注释等信息，这些信息通常嵌入在文件的头部或尾部。在某些情况下，我们可能不需要这些元数据信息，或者希望将它们清除以减少文件的大小，那么就可以使用 <code>"skip_clear"</code> 这个属性来控制是否清除这些信息。:</p> 
 <ul><li>当这个属性的值为 <code>"0"</code> 时，表示不跳过清除元数据信息的步骤，即清除文件的元数据信息；</li><li>当这个属性的值为 <code>"1"</code> 时，表示跳过清除元数据信息的步骤，即保留文件的元数据信息。</li></ul> 
</blockquote> 
<pre><code class="prism language-c"> → <span class="token number">4061</span>	     <span class="token function">av_opt_set</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> <span class="token string">"skip_clear"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">,</span> AV_OPT_SEARCH_CHILDREN<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>计算视频文件的章节结束时间</li></ul> 
<blockquote> 
 <p>一个视频文件可以分为多个章节，每个章节包含一个起始时间和一个结束时间。这个函数的主要作用是根据视频帧的时间戳信息和时间基准信息，计算出每个章节的结束时间。</p> 
 <p>我在调试的时候这个函数在进入后并没有进入判断分支，直接reutrn了</p> 
</blockquote> 
<pre><code class="prism language-c">   <span class="token number">3222</span>	 <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">compute_chapters_end</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">)</span>
</code></pre> 
<ul><li>从内部编解码器上下文更新每个数据流</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//4093</span>
    <span class="token comment">/* update the stream parameters from the internal codec contexts */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        st <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx_inited<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> orig_w <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
            <span class="token keyword">int</span> orig_h <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_from_context</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LOWRES</span></span>
            <span class="token comment">// The decoder might reduce the video size by the lowres factor.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>lowres <span class="token operator">&amp;&amp;</span> orig_w<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>width <span class="token operator">=</span> orig_w<span class="token punctuation">;</span>
                st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>height <span class="token operator">=</span> orig_h<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_LAVF_AVCTX</span></span>
FF_DISABLE_DEPRECATION_WARNINGS
        ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codec<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/*
      	将输入视频流中的 AVCodecParameters 结构体中的参数复制到 AVCodecContext 结构体中。具体来说，它将输入视频流中的编码格式、帧率、视频分辨率等参数复制到 AVCodecContext 中，以便后续的解码操作可以正确进行
      	
      	1. 视频流：
      	gef➤  p *st-&gt;codecpar
        struct AVCodecParameters * = {
          codec_type = AVMEDIA_TYPE_VIDEO,
          codec_id = AV_CODEC_ID_H264,
          codec_tag = 0x31637661,
          extradata = 0x5568c8b12120 "\001d",
          extradata_size = 0x30,
          format = 0xc,
          bit_rate = 0x34c3c6,
          bits_per_coded_sample = 0x18,
          bits_per_raw_sample = 0x8,
          profile = 0x64,
          level = 0x32,
          width = 0x5a0,
          height = 0x780,
          sample_aspect_ratio = {
            num = 0x0,
            den = 0x1
          },
          field_order = AV_FIELD_UNKNOWN,
          color_range = AVCOL_RANGE_JPEG,
          color_primaries = AVCOL_PRI_SMPTE432,
          color_trc = AVCOL_TRC_BT709,
          color_space = AVCOL_SPC_SMPTE170M,
          chroma_location = AVCHROMA_LOC_LEFT,
          ...
        }
      */</span>
      
			<span class="token comment">//...</span>
      
      <span class="token comment">/*
   	   检测视频流的编码标记是否为tcmd，即是否为QuickTime Video编码。如果是，则会跳过该流的解码，直接读取下一个数据包  
      */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>codec_tag <span class="token operator">!=</span> <span class="token function">MKTAG</span><span class="token punctuation">(</span><span class="token char">'t'</span><span class="token punctuation">,</span><span class="token char">'m'</span><span class="token punctuation">,</span><span class="token char">'c'</span><span class="token punctuation">,</span><span class="token char">'d'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">/*因为我的输入视频是iphone拍摄，所以会进入到此分支*/</span>
            st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>time_base <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>ticks_per_frame <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>ticks_per_frame<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      
      <span class="token comment">/* 更新平均帧率到AVCodecContext结构体 ,这里的st为(AVStream *)结构体
      gef➤  p st-&gt;codec-&gt;framerate
      $80 = {
        num = 0x0,
        den = 0x1
      }
      */</span>
        st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>framerate <span class="token operator">=</span> st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">;</span>
      <span class="token comment">/*
      gef➤  p st-&gt;avg_frame_rate
      $81 = {
        num = 0x7530,
        den = 0x3e9
      }
      */</span>

      <span class="token comment">/* 输入视频是否存在字幕标题 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>subtitle_header<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>subtitle_header <span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>subtitle_header_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>subtitle_header<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> find_stream_info_err<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>subtitle_header_size <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>subtitle_header_size<span class="token punctuation">;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>subtitle_header<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>subtitle_header<span class="token punctuation">,</span>
                   st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>subtitle_header_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      
      <span class="token comment">/*
      	更新输入文件所使用的编码器宽、高、属性
      */</span>
        st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>coded_width <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>coded_width<span class="token punctuation">;</span>
        st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>coded_height <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>coded_height<span class="token punctuation">;</span>
        st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>properties <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>properties<span class="token punctuation">;</span>
FF_ENABLE_DEPRECATION_WARNINGS
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

        st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx_inited <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//4152</span>
</code></pre> 
<ul><li>关闭解码器和输入流：当循环读取完毕后，关闭每个解码器并关闭输入流。</li></ul> 
<blockquote> 
 <p>这里就是关闭ff_h264_decoder、ff_aac_decoder解码器</p> 
</blockquote> 
<pre><code class="prism language-c">   <span class="token number">4154</span>	     <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token number">4155</span>	         st <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token number">4156</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>info<span class="token punctuation">)</span>
 → <span class="token number">4157</span>	             <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>st<span class="token operator">-&gt;</span>info<span class="token operator">-&gt;</span>duration_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">4158</span>	         <span class="token function">avcodec_close</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">4159</span>	         <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">4160</span>	         <span class="token function">av_bsf_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>extract_extradata<span class="token punctuation">.</span>bsf<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">4161</span>	         <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ic<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>extract_extradata<span class="token punctuation">.</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">4162</span>	     <span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>avio_tell()</code>函数用于获取当前的读取位置，<code>ic-&gt;pb-&gt;bytes_read</code>表示已经读取的字节数，<code>ic-&gt;pb-&gt;seek_count</code>表示执行的寻址次数，<code>count</code>表示读取的帧数。记录程序运行信息。这里对应着开头</li></ul> 
<pre><code class="prism language-c"><span class="token number">4165</span>	     <span class="token function">avio_tell</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>bytes_read<span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>seek_count<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4166</span>	     <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="3av_dump_format_1171"></a>3.av_dump_format分析</h4> 
<p><code>libavformat/dump.c</code>文件函数定义:</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">av_dump_format</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>ic<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span> <span class="token keyword">int</span> is_output<span class="token punctuation">)</span>
<span class="token comment">/*
ic：一个指向AVFormatContext结构体的指针，表示音视频文件的相关信息。
index：要输出的流的索引。如果为负数，则输出所有的流。
url：音视频文件的URL。这个不是很重要
is_output：指定的上下文是输入（0）还是输出（1）。如果为0，则表示该上下文是输入文件即打印输入流的文件信息；如果为1，则反之为输出流文件信息，注意如果没有输出文件那么传入1就会报错
*/</span>
</code></pre> 
<ul><li>检查传入的<code>AVformatContext</code>数据流</li></ul> 
<pre><code class="prism language-c"> →  <span class="token number">575</span>	     <span class="token class-name">uint8_t</span> <span class="token operator">*</span>printed <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>nb_streams <span class="token operator">?</span> <span class="token function">av_mallocz</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token number">576</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>nb_streams <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>printed<span class="token punctuation">)</span>
    <span class="token number">577</span>	         <span class="token keyword">return</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>根据<code>is_output</code>参数来决定输出流的信息</li></ul> 
<blockquote> 
 <p>如果为0，则表示该上下文是输入文件即打印输入流的文件信息；如果为1，则反之为输出流文件信息</p> 
</blockquote> 
<pre><code class="prism language-c">    <span class="token number">579</span>	     <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"%s #%d, %s, %s '%s':\n"</span><span class="token punctuation">,</span>
    <span class="token number">580</span>	            is_output <span class="token operator">?</span> <span class="token string">"Output"</span> <span class="token operator">:</span> <span class="token string">"Input"</span><span class="token punctuation">,</span>
    <span class="token number">581</span>	            index<span class="token punctuation">,</span>
    <span class="token number">582</span>	            is_output <span class="token operator">?</span> ic<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span>name <span class="token operator">:</span> ic<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span>
    <span class="token number">583</span>	            is_output <span class="token operator">?</span> <span class="token string">"to"</span> <span class="token operator">:</span> <span class="token string">"from"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
	注意如果没有输出文件那么传入1就会报错:
	gef➤  p ic-&gt;oformat-&gt;name
  Cannot access memory at address 0x0
  gef➤  p ic-&gt;iformat-&gt;name
  $1 = 0x55b7a4835c1b "mov,mp4,m4a,3gp,3g2,mj2"
  
  可以看到这里对url参数的处理就是直接输出，
*/</span>
</code></pre> 
<ul><li>获取视频的<code>metadata</code></li></ul> 
<pre><code class="prism language-c"> →  <span class="token number">584</span>	     <span class="token function">dump_metadata</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>metadata<span class="token punctuation">,</span> <span class="token string">"  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>打印<code>duration</code>、<code>start_time</code>、<code>bit_rate</code>信息</li></ul> 
<pre><code class="prism language-c">    <span class="token number">588</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>duration <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">589</span>	             <span class="token keyword">int</span> hours<span class="token punctuation">,</span> mins<span class="token punctuation">,</span> secs<span class="token punctuation">,</span> us<span class="token punctuation">;</span>
    <span class="token number">590</span>	             <span class="token class-name">int64_t</span> duration <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>duration <span class="token operator">+</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>duration <span class="token operator">&lt;=</span> INT64_MAX <span class="token operator">-</span> <span class="token number">5000</span> <span class="token operator">?</span> <span class="token number">5000</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">591</span>	             secs  <span class="token operator">=</span> duration <span class="token operator">/</span> AV_TIME_BASE<span class="token punctuation">;</span>
    <span class="token number">592</span>	             us    <span class="token operator">=</span> duration <span class="token operator">%</span> AV_TIME_BASE<span class="token punctuation">;</span>
 →  <span class="token number">593</span>	             mins  <span class="token operator">=</span> secs <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">;</span>
    <span class="token number">594</span>	             secs <span class="token operator">%=</span> <span class="token number">60</span><span class="token punctuation">;</span>
    <span class="token number">595</span>	             hours <span class="token operator">=</span> mins <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">;</span>
    <span class="token number">596</span>	             mins <span class="token operator">%=</span> <span class="token number">60</span><span class="token punctuation">;</span>
    <span class="token number">597</span>	             <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"%02d:%02d:%02d.%02d"</span><span class="token punctuation">,</span> hours<span class="token punctuation">,</span> mins<span class="token punctuation">,</span> secs<span class="token punctuation">,</span>
    <span class="token number">598</span>	                    <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> us<span class="token punctuation">)</span> <span class="token operator">/</span> AV_TIME_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">599</span>	         <span class="token punctuation">}</span>


    <span class="token number">602</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>start_time <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">603</span>	             <span class="token keyword">int</span> secs<span class="token punctuation">,</span> us<span class="token punctuation">;</span>
    <span class="token number">604</span>	             <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">", start: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">605</span>	             secs <span class="token operator">=</span> <span class="token function">llabs</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>start_time <span class="token operator">/</span> AV_TIME_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">606</span>	             us   <span class="token operator">=</span> <span class="token function">llabs</span><span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>start_time <span class="token operator">%</span> AV_TIME_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 →  <span class="token number">607</span>	             <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"%s%d.%06d"</span><span class="token punctuation">,</span>
    <span class="token number">608</span>	                    ic<span class="token operator">-&gt;</span>start_time <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token string">"-"</span><span class="token punctuation">,</span>
    <span class="token number">609</span>	                    secs<span class="token punctuation">,</span>
    <span class="token number">610</span>	                    <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">av_rescale</span><span class="token punctuation">(</span>us<span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">,</span> AV_TIME_BASE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">611</span>	         <span class="token punctuation">}</span>

 →  <span class="token number">613</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span>ic<span class="token operator">-&gt;</span>bit_rate<span class="token punctuation">)</span>
    <span class="token number">614</span>	             <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"%"</span>PRId64<span class="token string">" kb/s"</span><span class="token punctuation">,</span> ic<span class="token operator">-&gt;</span>bit_rate <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>进入<code>dump_stream_format</code>打印探测的数据</li></ul> 
<pre><code class="prism language-c">    <span class="token number">650</span>	     <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ic<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
 →  <span class="token number">651</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>printed<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token number">652</span>	             <span class="token function">dump_stream_format</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> i<span class="token punctuation">,</span> index<span class="token punctuation">,</span> is_output<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">//451</span>
<span class="token comment">/* "user interface" functions */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dump_stream_format</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>ic<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span>
                               <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token keyword">int</span> is_output<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*
    	获取每个流metadata中的 "language" key
    */</span>
    AVDictionaryEntry <span class="token operator">*</span>lang <span class="token operator">=</span> <span class="token function">av_dict_get</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>metadata<span class="token punctuation">,</span> <span class="token string">"language"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
  	进入到av_dict_get函数（source:libavutil/dict.c）中，此时探测到的metadad如下：
  	 53	     for (; i &lt; m-&gt;count; i++) {
 →   54	         const char *s = m-&gt;elems[i].key;
 
    gef➤  p m-&gt;count
    $33 = 0x3
    
  	gef➤  p {m-&gt;elems[0] ,m-&gt;elems[1] ,m-&gt;elems[2]}
    $29 = {<!-- -->{
        key = 0x56366293bf00 "creation_time",
        value = 0x56366293bf20 "2023-03-09T13:47:05.000000Z"
      }, {
        key = 0x56366293bfb0 "handler_name",
        value = 0x56366293bfd0 "Core Media Video"
      }, {
        key = 0x56366293bf70 "encoder",
        value = 0x56366293c0c0 "Lavc59.37.100 libx264"
      }}
      
    如果使用iphone的原始视频进行测试，那么它的metadata应该是这样的：
    gef➤  p m-&gt;count
    $14 = 0xa
    
    gef➤   p m-&gt;elems.key@20
    $9 = {
    0x5610a814c6c0 "major_brand", 
    0x5610a814c8e0 "qt  ",
    0x5610a814c940 "minor_version", 
    0x5610a814c960 "0", 
    0x5610a814c9b0 "compatible_brands",
    0x5610a814c9d0 "qt  ", 
    0x5610a814cc10 "creation_time",
    0x5610a814c980 "2023-03-09T13:47:05.000000Z", 
    0x5610a815fad0 "com.apple.quicktime.location.accuracy.horizontal", 
    0x5610a815fb10 "35.000000",
    0x5610a815fbd0 "com.apple.quicktime.location.ISO6709", 
    0x5610a815fc00 "...", 
    0x5610a815fca0 "com.apple.quicktime.make",
    0x5610a815fcd0 "Apple", 
    0x5610a815fda0 "com.apple.quicktime.model",
    0x5610a814cc80 "...",
    0x5610a815fd70 "com.apple.quicktime.software", 
    0x5610a815fe80 "16.3.1", 0x5610a815ff40 "com.apple.quicktime.creationdate", 
    0x5610a815ff70 "2023-03-09T21:47:04+0800"}
    }      
  */</span>
  
    <span class="token keyword">char</span> <span class="token operator">*</span>separator <span class="token operator">=</span> ic<span class="token operator">-&gt;</span>dump_separator<span class="token punctuation">;</span>
    AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    avctx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
  	传入NULL表示分配一个未指定编解码器的 AVCodecContext 结构体并初始化其默认值
  */</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avctx<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
  将输入视频流中的 AVCodecParameters 结构体中的参数复制到 AVCodecContext 结构体中。具体来说，它将输入视频流中的编码格式、帧率、视频分辨率等参数复制到 AVCodecContext 中
  */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// AVCodec参数中缺少的字段需要从AVCodecContext中获取</span>
    avctx<span class="token operator">-&gt;</span>properties <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>properties<span class="token punctuation">;</span>
    avctx<span class="token operator">-&gt;</span>codec      <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>codec<span class="token punctuation">;</span>
    avctx<span class="token operator">-&gt;</span>qmin       <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>qmin<span class="token punctuation">;</span>
    avctx<span class="token operator">-&gt;</span>qmax       <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>qmax<span class="token punctuation">;</span>
    avctx<span class="token operator">-&gt;</span>coded_width  <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>coded_width<span class="token punctuation">;</span>
    avctx<span class="token operator">-&gt;</span>coded_height <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>coded_height<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>separator<span class="token punctuation">)</span>
        <span class="token function">av_opt_set</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> <span class="token string">"dump_separator"</span><span class="token punctuation">,</span> separator<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avcodec_string</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> avctx<span class="token punctuation">,</span> is_output<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"    Stream #%d:%d"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* the pid is an important information, so we display it */</span>
    <span class="token comment">/* XXX: add a generic system */</span>
  <span class="token comment">//显示流的ID值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AVFMT_SHOW_IDS<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"[0x%x]"</span><span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//metadata的语言项值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lang<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"(%s)"</span><span class="token punctuation">,</span> lang<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">", %d, %d/%d"</span><span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codec_info_nb_frames<span class="token punctuation">,</span>
           st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">/*
	  视频流：buf=0x007ffd0b9823c8  →  "Video: h264 (avc1 / 0x31637661), yuvj420p(pc, smpt[...]"
	  音频流：buf=0x007ffd0b9823c8  →  "Audio: aac (mp4a / 0x6134706D), 44100 Hz, mono, fl[...]"
  */</span>
    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">": %s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//比较流的采样纵横比与编码器参数中的采样纵横比是否一致</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">.</span>num <span class="token operator">&amp;&amp;</span>
        <span class="token function">av_cmp_q</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVRational display_aspect_ratio<span class="token punctuation">;</span>
        <span class="token function">av_reduce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>display_aspect_ratio<span class="token punctuation">.</span>num<span class="token punctuation">,</span> <span class="token operator">&amp;</span>display_aspect_ratio<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
                  st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>width  <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token class-name">int64_t</span><span class="token punctuation">)</span>st<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">.</span>num<span class="token punctuation">,</span>
                  st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>height <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token class-name">int64_t</span><span class="token punctuation">)</span>st<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
                  <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">", SAR %d:%d DAR %d:%d"</span><span class="token punctuation">,</span>
               st<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">.</span>num<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">.</span>den<span class="token punctuation">,</span>
               display_aspect_ratio<span class="token punctuation">.</span>num<span class="token punctuation">,</span> display_aspect_ratio<span class="token punctuation">.</span>den<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">//当前AVCodecParameters解码器类似是否为视频解码器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> fps <span class="token operator">=</span> st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>den <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
        <span class="token keyword">int</span> tbr <span class="token operator">=</span> st<span class="token operator">-&gt;</span>r_frame_rate<span class="token punctuation">.</span>den <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>r_frame_rate<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
        <span class="token keyword">int</span> tbn <span class="token operator">=</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
        <span class="token keyword">int</span> tbc <span class="token operator">=</span> st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">;</span>
      <span class="token comment">/*
      - st-&gt;avg_frame_rate.den：视频流的平均帧率分母是否存在
			- st-&gt;avg_frame_rate.num：视频流的平均帧率分子是否存在
      */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fps <span class="token operator">||</span> tbr <span class="token operator">||</span> tbn <span class="token operator">||</span> tbc<span class="token punctuation">)</span>
            <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> separator<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fps<span class="token punctuation">)</span>
            <span class="token function">print_fps</span><span class="token punctuation">(</span><span class="token function">av_q2d</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>avg_frame_rate<span class="token punctuation">)</span><span class="token punctuation">,</span> tbr <span class="token operator">||</span> tbn <span class="token operator">||</span> tbc <span class="token operator">?</span> <span class="token string">"fps, "</span> <span class="token operator">:</span> <span class="token string">"fps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tbr<span class="token punctuation">)</span>
            <span class="token function">print_fps</span><span class="token punctuation">(</span><span class="token function">av_q2d</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>r_frame_rate<span class="token punctuation">)</span><span class="token punctuation">,</span> tbn <span class="token operator">||</span> tbc <span class="token operator">?</span> <span class="token string">"tbr, "</span> <span class="token operator">:</span> <span class="token string">"tbr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tbn<span class="token punctuation">)</span>
            <span class="token function">print_fps</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">,</span> tbc <span class="token operator">?</span> <span class="token string">"tbn, "</span> <span class="token operator">:</span> <span class="token string">"tbn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tbc<span class="token punctuation">)</span>
            <span class="token function">print_fps</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token function">av_q2d</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tbc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">/*
      	其中 fps 表示平均帧率，tbr 表示真实帧率，tbn 表示时间基分子，tbc 表示编码器的时间基分子。
      */</span>
      
    <span class="token punctuation">}</span>

  <span class="token comment">/*
	  获取音视频流的属性信息，并判断该音视频流是否具有某种特定属性。
  */</span>
  <span class="token comment">//判断音视频流是否具有默认属性。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_DEFAULT<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (default)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有双语属性。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_DUB<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (dub)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否是原始音视频流。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_ORIGINAL<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (original)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有注释属性。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_COMMENT<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (comment)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有歌词属性。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_LYRICS<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (lyrics)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否是卡拉 OK 音频流。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_KARAOKE<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (karaoke)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有强制属性。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_FORCED<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (forced)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否适合听力受损人群。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_HEARING_IMPAIRED<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (hearing impaired)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否适合视力受损人群。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_VISUAL_IMPAIRED<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (visual impaired)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有干净特效。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_CLEAN_EFFECTS<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (clean effects)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有附加图片。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_ATTACHED_PIC<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (attached pic)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有定时缩略图。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_TIMED_THUMBNAILS<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (timed thumbnails)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有字幕。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_CAPTIONS<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (captions)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有描述信息。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_DESCRIPTIONS<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (descriptions)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否具有元数据。 这里有点奇怪没有进去。。TODO</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_METADATA<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (metadata)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否依赖其他流。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_DEPENDENT<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (dependent)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断音视频流是否是静态图片流。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>disposition <span class="token operator">&amp;</span> AV_DISPOSITION_STILL_IMAGE<span class="token punctuation">)</span>
        <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">" (still image)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_log</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dump_metadata</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>metadata<span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dump_sidedata</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> st<span class="token punctuation">,</span> <span class="token string">"    "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//570</span>
</code></pre> 
<ul><li>分析<code>dump_metadata</code> (源代码文件:libavformat/dump.c)</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//132</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dump_metadata</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span>m<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>indent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/*
  	不进入分支的情况为：metadata的个数只有1个，且"language"key值为NULL
    gef➤  p m-&gt;count
    $33 = 0x3
    
  	gef➤  p {m-&gt;elems[0] ,m-&gt;elems[1] ,m-&gt;elems[2]}
    $29 = {<!-- -->{
        key = 0x56366293bf00 "creation_time",
        value = 0x56366293bf20 "2023-03-09T13:47:05.000000Z"
      }, {
        key = 0x56366293bfb0 "handler_name",
        value = 0x56366293bfd0 "Core Media Video"
      }, {
        key = 0x56366293bf70 "encoder",
        value = 0x56366293c0c0 "Lavc59.37.100 libx264"
      }}
  		
  */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">av_dict_count</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">av_dict_get</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"language"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVDictionaryEntry <span class="token operator">*</span>tag <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      
        <span class="token function">av_log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"%sMetadata:\n"</span><span class="token punctuation">,</span> indent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//不打印后缀</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tag <span class="token operator">=</span> <span class="token function">av_dict_get</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> tag<span class="token punctuation">,</span> AV_DICT_IGNORE_SUFFIX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"language"</span><span class="token punctuation">,</span> tag<span class="token operator">-&gt;</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//没有运行进来，不好分析，以后找找原因 TODO</span>
                <span class="token comment">//...</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//158</span>
</code></pre> 
<h4><a id="4avformat_close_input_1519"></a>4.avformat_close_input分析</h4> 
<p><code>libavformat/utils.c</code> 文件函数定义:</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">avformat_close_input</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span><span class="token operator">*</span>ps<span class="token punctuation">)</span>
<span class="token comment">/*
ps：一个指向AVFormatContext结构体的指针，表示音视频文件的相关信息。

在使用avformat_open_input函数打开一个输入流后，当不再需要该输入流时，应该调用avformat_close_input函数来释放资源。这可以防止内存泄漏等问题的发生。

注意：如果自己单独创建了输入流的文件描述符，调用avformat_close_input函数不会关闭与该输入流相关的文件描述符，这需要在外部单独处理
*/</span>
</code></pre> 
<ul><li>清理队列中的所有<code>AVPacket</code>数据包</li></ul> 
<pre><code class="prism language-c"> <span class="token number">4446</span>	     <span class="token function">flush_packet_queue</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>释放输入流文件内存、描述符、IO流</li></ul> 
<pre><code class="prism language-c"> → <span class="token number">4448</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token punctuation">)</span>
   <span class="token number">4449</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>read_close<span class="token punctuation">)</span>
   <span class="token number">4450</span>	             s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span><span class="token function">read_close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>释放<code>AVFormatContext</code>、释放、关闭<code>AVIOContext</code></li></ul> 
<pre><code class="prism language-c">   <span class="token number">4452</span>	     <span class="token function">avformat_free_context</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">4453</span>
   <span class="token number">4454</span>	     <span class="token operator">*</span>ps <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">//关闭野指针，防止再次利用</span>
   <span class="token number">4455</span>
 → <span class="token number">4456</span>	     <span class="token function">avio_close</span><span class="token punctuation">(</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="APIMOV_1560"></a>调用API-分离MOV文件</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INPUT_FILE</span> <span class="token string">"input.mov"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OUTPUT_VIDEO_FILE</span> <span class="token string">"divide.video"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OUTPUT_AUDIO_FILE</span> <span class="token string">"divide.audio"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OUTPUT_SUBTITLE_FILE</span> <span class="token string">"divide.srt"</span></span>

<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  AVFormatContext <span class="token operator">*</span>ps <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  string url <span class="token operator">=</span> INPUT_FILE<span class="token punctuation">;</span>

  FILE <span class="token operator">*</span>outputVideo <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>OUTPUT_VIDEO_FILE<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outputVideo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to open output video file"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  FILE <span class="token operator">*</span>outputAudio <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>OUTPUT_AUDIO_FILE<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outputAudio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to open output audio file"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  FILE <span class="token operator">*</span>outputSubtitle <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>OUTPUT_SUBTITLE_FILE<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outputSubtitle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to open output subtitle file"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 1. Open the input file</span>
  status <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ps<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"File "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">" parse failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. Retrieve stream information</span>
  status <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Stream find info failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// int index = 0;</span>
  <span class="token comment">// int is_output = 0;</span>
  <span class="token comment"> 3. Print format and stream information</span>
  <span class="token comment">// av_dump_format(ps, index, url.c_str(), is_output);</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDEO_STREAM_INDEX</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AUDIO_STREAM_INDEX</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SUBTITLE_STREAM_INDEX</span> <span class="token expression"><span class="token number">2</span></span></span>

  string video_type <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  string audio_type <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token comment">// 4. Find  the video decoder and fetch video data</span>
  <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>video_codec <span class="token operator">=</span>
      <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>ps<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>VIDEO_STREAM_INDEX<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>video_codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// video_type = video_codec-&gt;name; //Better</span>
    video_type <span class="token operator">=</span> <span class="token function">avcodec_get_name</span><span class="token punctuation">(</span>video_codec<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Debug test</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Video codec: "</span> <span class="token operator">&lt;&lt;</span> video_type <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Find video codec failed !"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>audio_codec <span class="token operator">=</span>
      <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>ps<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>AUDIO_STREAM_INDEX<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>audio_codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// audio_type = audio_codec-&gt;name;  //Better</span>
    audio_type <span class="token operator">=</span> <span class="token function">avcodec_get_name</span><span class="token punctuation">(</span>audio_codec<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Debug test</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Audio codec: "</span> <span class="token operator">&lt;&lt;</span> audio_type <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Find audio codec failed !"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  AVPacket pkt<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>stream_index <span class="token operator">==</span> VIDEO_STREAM_INDEX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Fetch video encode data</span>
      <span class="token function">fwrite</span><span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> pkt<span class="token punctuation">.</span>size<span class="token punctuation">,</span> outputVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>stream_index <span class="token operator">==</span> AUDIO_STREAM_INDEX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Fetch audio encode data</span>
      <span class="token function">fwrite</span><span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> pkt<span class="token punctuation">.</span>size<span class="token punctuation">,</span> outputAudio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>stream_index <span class="token operator">==</span> SUBTITLE_STREAM_INDEX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">fwrite</span><span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> pkt<span class="token punctuation">.</span>size<span class="token punctuation">,</span> outputSubtitle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Close data packet resource</span>
    <span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Output video file -&gt; "</span> <span class="token operator">&lt;&lt;</span> OUTPUT_VIDEO_FILE <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Output audio file -&gt; "</span> <span class="token operator">&lt;&lt;</span> OUTPUT_AUDIO_FILE <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Output subtitle file -&gt; "</span> <span class="token operator">&lt;&lt;</span> OUTPUT_SUBTITLE_FILE <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

  <span class="token function">fclose</span><span class="token punctuation">(</span>outputVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>outputAudio<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>outputSubtitle<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 4. Close the input file IO</span>
  <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里接着从第四步开始分析，也就是avcodec_find_decoder</p> 
<h4><a id="1avcodec_find_decoder_1683"></a>1.avcodec_find_decoder分析</h4> 
<p><code>libavcodec/allcodecs.c</code> 文件函数定义:</p> 
<pre><code class="prism language-c">    <span class="token number">890</span>	 AVCodec <span class="token operator">*</span><span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> id<span class="token punctuation">)</span>
 →  <span class="token number">891</span>	 <span class="token punctuation">{<!-- --></span>
    <span class="token number">892</span>	     <span class="token keyword">return</span> <span class="token function">find_codec</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> av_codec_is_decoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/* av_codec_is_decoder是一个函数定义(libavcodec/utils.c)如下：
        int av_codec_is_decoder(const AVCodec *codec) {
      		return codec &amp;&amp; (codec-&gt;decode || codec-&gt;receive_frame);
			  }
      */</span>
    <span class="token number">893</span>	 <span class="token punctuation">}</span>

<span class="token comment">//..</span>
<span class="token comment">//863</span>
<span class="token keyword">static</span> AVCodec <span class="token operator">*</span><span class="token function">find_codec</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> AVCodec <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">/*
	id : 用于存储编、解码器结构体的id标识符，是一个枚举类型结构
	(*x) : 一个函数指针，函数参数为(const AVCodec *)
*/</span>
</code></pre> 
<p>本Demo-API调用如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">const</span> AVCodec <span class="token operator">*</span>video_codec <span class="token operator">=</span><span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>ps<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>VIDEO_STREAM_INDEX<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
gef➤  p ps-&gt;streams[0]-&gt;codecpar-&gt;codec_id
$1 = AV_CODEC_ID_H264
*/</span>
</code></pre> 
<ul><li>remap_deprecated_codec_id函数是一个占位函数</li><li>迭代当前所有初始化的编、解码器</li></ul> 
<pre><code class="prism language-c">  <span class="token number">864</span> <span class="token keyword">static</span> AVCodec <span class="token operator">*</span><span class="token function">find_codec</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>x<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> AVCo      dec <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token number">865</span> <span class="token punctuation">{<!-- --></span>
  <span class="token number">866</span>     <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span>experimental <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token number">867</span>     <span class="token keyword">void</span> <span class="token operator">*</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token number">868</span>
  <span class="token number">869</span>     id <span class="token operator">=</span> <span class="token function">remap_deprecated_codec_id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">870</span>
  <span class="token number">871</span>     <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">av_codec_iterate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                       <span class="token number">872</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">x</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//x函数的作用就是判断当前AVCodec指针是否为解码器AvCodec结构体指针</span>
  <span class="token number">873</span>             <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token number">874</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token number">875</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>capabilities <span class="token operator">&amp;</span> AV_CODEC_CAP_EXPERIMENTAL <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>e      xperimental<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">/*AV_CODEC_CAP_EXPERIMENTAL是一个定义在FFmpeg库中的常量，它表示编解码器支持实验性功能*/</span>
  <span class="token number">876</span>                 experimental <span class="token operator">=</span> p<span class="token punctuation">;</span>
  <span class="token number">877</span>             <span class="token punctuation">}</span> <span class="token keyword">else</span>
  <span class="token number">878</span>                 <span class="token keyword">return</span> <span class="token punctuation">(</span>AVCodec<span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">;</span>
  <span class="token number">879</span>         <span class="token punctuation">}</span>
  <span class="token number">880</span>     <span class="token punctuation">}</span>
  <span class="token number">881</span>
  <span class="token number">882</span>     <span class="token keyword">return</span> <span class="token punctuation">(</span>AVCodec<span class="token operator">*</span><span class="token punctuation">)</span>experimental<span class="token punctuation">;</span>
  <span class="token number">883</span> <span class="token punctuation">}</span>
</code></pre> 
<ul><li>具体看看av_codec_iterate函数</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">const</span> AVCodec <span class="token operator">*</span><span class="token function">av_codec_iterate</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>opaque<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uintptr_t</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span><span class="token operator">*</span>opaque<span class="token punctuation">;</span>
    <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>c <span class="token operator">=</span> codec_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">ff_thread_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>av_codec_static_init<span class="token punctuation">,</span> av_codec_init_static<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*这个函数实际上是调用了pthread_once
   → 0x560bc2a0bda1 &lt;av_codec_iterate+39&gt; call   0x560bc28cb0c0 &lt;pthread_once@plt&gt;
   调用参数如下：
   pthread_once@plt (
     $rdi = 0x00560bc31fcfa8 → &lt;av_codec_static_init+0&gt; add al, BYTE PTR [rax],
     $rsi = 0x00560bc2a0bd50 → &lt;av_codec_init_static+0&gt; endbr64
  )
  
  它的作用是保证只有一个线程调用av_codec_init_static()函数来初始化编解码器静态数据。av_codec_static_init是一个静态变量，它的值初始化为0，用于记录是否已经调用过初始化函数。
  在第一次调用ff_thread_once()函数时，它会调用av_codec_init_static()函数，并将av_codec_static_init设置为非零值，表示已经完成初始化。在后续的调用中，ff_thread_once()函数直接返回，不再执行初始化函数。
	这种线程安全的初始化方式可以保证在多线程环境下，只有一个线程对静态数据进行初始化，避免了竞争条件的出现。
  */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token operator">*</span>opaque <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到avcodec_find_decoder函数还是比较简单的，就做了两件事：</p> 
<ol><li>获取全部解码器</li><li>在注册完成的解码器中进行迭代，找到我的<code>AV_CODEC_ID_H264</code>解码器AVCodec结构体指针</li></ol> 
<h4><a id="2avcodec_get_name_1781"></a>2.avcodec_get_name分析</h4> 
<p><code>libavcodec/utils.c+1167</code>文件函数定义：</p> 
<pre><code class="prism language-c"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">avcodec_get_name</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> id<span class="token punctuation">)</span>
  <span class="token comment">/*
	id : 用于存储编、解码器结构体的id标识符，是一个枚举类型结构
  */</span>
</code></pre> 
<p>这里传入的参数同样是<code>AV_CODEC_ID_H264</code></p> 
<ul><li>进入avcodec_descriptor_get函数。根据<code>id</code>获取填充<code>AVCodecDescriptor</code>结构体</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//函数定义：libavcodec/codec_desc.c</span>
	 <span class="token number">3257</span>	 <span class="token keyword">const</span> AVCodecDescriptor <span class="token operator">*</span><span class="token function">avcodec_descriptor_get</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> id<span class="token punctuation">)</span>
 → <span class="token number">3258</span>	 <span class="token punctuation">{<!-- --></span>
   <span class="token number">3259</span>	     <span class="token keyword">return</span> <span class="token function">bsearch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">,</span> codec_descriptors<span class="token punctuation">,</span> <span class="token function">FF_ARRAY_ELEMS</span><span class="token punctuation">(</span>codec_descriptors<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>codec_descriptors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> descriptor_compare<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">/*
     	codec_descriptors : 是所有的编解码器描述列表
     	FF_ARRAY_ELEMS(codec_descriptors) : 列表的个数
     	sizeof(codec_descriptors[0]) : 列表单个元素的大小
     	descriptor_compare : 函数指针，用于比较两个元素的大小关系。函数定义在下方
     	
     	
     	bsearch()是一个C标准库函数
      第一个参数：指向要查找的元素的指针。
      第二个参数：指向数组的指针，数组中的元素必须按照升序排序。
      第三个参数：数组中元素的个数。
      第四个参数：每个元素的大小。
      第五个参数：一个函数指针，用于比较两个元素的大小关系。
      返回值：指向查找到的元素的指针，如果没有找到，则返回NULL
     */</span>
   <span class="token number">3261</span>	 <span class="token punctuation">}</span>

<span class="token comment">//</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">descriptor_compare</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>member<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> id <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> <span class="token operator">*</span><span class="token punctuation">)</span> key<span class="token punctuation">;</span>
    <span class="token keyword">const</span> AVCodecDescriptor <span class="token operator">*</span>desc <span class="token operator">=</span> member<span class="token punctuation">;</span>
		<span class="token comment">/*
		key指向要查找的元素的指针，member指向数组中的元素
		*/</span>
    <span class="token keyword">return</span> id <span class="token operator">-</span> desc<span class="token operator">-&gt;</span>id<span class="token punctuation">;</span>
  <span class="token comment">//将两个ID值相减，返回结果。如果返回的值为0则相同</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>avcodec_get_name函数也比较简单的：</p> 
<ol><li>调用标准库函数bsearch，在注册完成的编、解码器中进行迭代，找到我的<code>AV_CODEC_ID_H264</code>解码器AVCodecDescriptor结构体指针</li></ol> 
<p>avcodec_get_name函数会在没有找到对应ID的</p> 
<p><strong>这个函数可以直接使用AVCodec结构体下面的<code>name</code>成员来获取，这里熟悉流程</strong></p> 
<h4><a id="3av_read_frame_1841"></a>3.av_read_frame分析</h4> 
<p><code>libavformat/utils.c+1769</code> 文件函数定义:</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">av_read_frame</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
  <span class="token comment">/*
    s：要读取的AVFormatContext结构体指针。
    pkt：AVPacket结构体指针，用于存储读取到的数据包。
  */</span>
</code></pre> 
<p>函数用于读取一个AVFormatContext中的下一个数据包。</p> 
<ul><li>在调用函数之前:</li></ul> 
<ol><li>需要使用avformat_open_input()函数打开一个输入文件并创建一个AVFormatContext结构体，</li><li>然后使用avformat_find_stream_info()函数获取媒体文件的相关信息，例如编解码器、码率、帧率等</li></ol> 
<ul><li>在调用函数之后:</li></ul> 
<ol><li><code>pkt</code>指向的AVPacket结构体会被填充上读取到的数据包的信息，例如数据、大小、时间戳等。</li><li>读取到的数据包可以是视频、音频或字幕等数据。读取到的数据包在使用完成后，需要调用<code>av_packet_unref()</code>函数进行释放。</li></ol> 
<p><strong>注意!!!</strong> <code>av_read_frame()</code>函数只读取一个数据包，需要多次调用才能读取完整的媒体文件，所以一般都是用在循环读取</p> 
<p>流程分析：</p> 
<ul><li>判断了是否使用了-noaccurate_seek参数（即genpts为false）</li></ul> 
<pre><code class="prism language-c">  <span class="token number">1775</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>genpts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*
    如果没有使用这个参数，那么就先从内部的packet buffer中获取一个packet
    如果packet buffer为空，则调用read_frame_internal()函数读取一个packet。
    */</span>
  <span class="token number">1776</span>         ret <span class="token operator">=</span> s<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>packet_buffer<span class="token operator">?</span> <span class="token function">ff_packet_list_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>packet_buffer<span class="token punctuation">,</span><span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>packet_buffer_end<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">read_frame_internal</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">1780</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token number">1781</span>             <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token number">1782</span>         <span class="token keyword">goto</span> return_packet<span class="token punctuation">;</span>
  <span class="token number">1783</span>     <span class="token punctuation">}</span>

<span class="token comment">/*
这个if语句的作用是为了提高音视频同步的精度。当使用-noaccurate_seek参数时，跳转到指定位置后读取的第一个packet的PTS值并不一定等于跳转到的时间点，这会导致后续的音视频同步出现误差。

为了解决这个问题：
- 如果不使用-noaccurate_seek参数时，可以通过将packet buffer中缓存的packet全部读取出来，再从指定位置开始读取，以保证第一个读取的packet的PTS值与跳转到的时间点相等。

- 如果使用了-noaccurate_seek参数，则可以通过AVStream结构体中的start_time和duration字段进行计算，直接跳转到指定的时间点进行读取。这种方式虽然可以提高读取速度，但是音视频同步的精度会受到一定的影响。
*/</span>
</code></pre> 
<ul><li><strong>分支一：进入<code>ff_packet_list_get</code>函数</strong>。从内部的AVPacketList单向链表中获取一个数据包packet</li></ul> 
<blockquote> 
 <p>这个函数在于你如何使用API，一般来说会有一些数据包存在于AVPacketList的缓存中。本例子Demo中前几次av_read_frame会调用该函数从内部缓存里读取数据包</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">//libavformat/utils.c+1553</span>
<span class="token comment">/*
		参数一：**pkt_buffer 指向链表头节点的指针
		参数二：**pkt_buffer_end 指向链表尾节点的指针
		参数三：*pkt 指向用户AVPacket对象的指针（一般是空数据的AVPacket结构体）
*/</span>
   <span class="token number">1550</span>	 <span class="token keyword">int</span> <span class="token function">ff_packet_list_get</span><span class="token punctuation">(</span>AVPacketList <span class="token operator">*</span><span class="token operator">*</span>pkt_buffer<span class="token punctuation">,</span>
   <span class="token number">1551</span>	                        AVPacketList <span class="token operator">*</span><span class="token operator">*</span>pkt_buffer_end<span class="token punctuation">,</span>
   <span class="token number">1552</span>	                        AVPacket      <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
 → <span class="token number">1553</span>	 <span class="token punctuation">{<!-- --></span>
   <span class="token number">1554</span>	     AVPacketList <span class="token operator">*</span>pktl<span class="token punctuation">;</span>
   <span class="token number">1555</span>	     <span class="token function">av_assert0</span><span class="token punctuation">(</span><span class="token operator">*</span>pkt_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//断言av_assert0(*pkt_buffer)来确保传入的pkt_buffer不为空。其实在调用该函数前就确保了函数不为空，双重判断可能其他地方也会调用该函数。</span>
   <span class="token number">1556</span>	     pktl        <span class="token operator">=</span> <span class="token operator">*</span>pkt_buffer<span class="token punctuation">;</span>
   <span class="token number">1557</span>	     <span class="token operator">*</span>pkt        <span class="token operator">=</span> pktl<span class="token operator">-&gt;</span>pkt<span class="token punctuation">;</span> <span class="token comment">//取出链表中的pkt填充当前用户传入的ptk数据包</span>
   <span class="token number">1558</span>	     <span class="token operator">*</span>pkt_buffer <span class="token operator">=</span> pktl<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span><span class="token comment">//填充完当前数据包后，在链表中卸下取出的pkt数据包。将链表中的下一个pkt包作为当前链表头。</span>
   <span class="token number">1559</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pktl<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token comment">//判断当前是否到达链表末尾</span>
   <span class="token number">1560</span>	         <span class="token operator">*</span>pkt_buffer_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
   <span class="token number">1561</span>	     <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pktl<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放当前指针和堆块</span>
   <span class="token number">1562</span>	     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token number">1563</span>	 <span class="token punctuation">}</span>

<span class="token comment">/*
	AVPacketList结构体如下：
	gef➤  pt *pktl
  type = struct AVPacketList {
      AVPacket pkt;
      struct AVPacketList *next;
  }
  
  可以看到是一个典型的单链表结构，再来看看数据：
  gef➤  p *pktl
  $21 = {
    pkt = {
      buf = 0x55cefb324b90,
      pts = 0x0,
      dts = 0xfffffffffffff82e,
      data = 0x55cefb358e00 "",
      size = 0x17649,
      stream_index = 0x0,
      flags = 0x1,
      side_data = 0x0,
      side_data_elems = 0x0,
      duration = 0x3e9,
      pos = 0x24,
      convergence_duration = 0x0
    },
    next = 0x55cefb370760
  }
  
  我这里的缓存链表如下：
  gef➤  p pktl-&gt;next
  $37 = (struct AVPacketList *) 0x55cefb370760
  gef➤  p pktl-&gt;next-&gt;next
  $38 = (struct AVPacketList *) 0x55cefb3f6930
  gef➤  p pktl-&gt;next-&gt;next-&gt;next
  $39 = (struct AVPacketList *) 0x0
  
  pts也是符合期望：
  gef➤  p (pktl)-&gt;pkt-&gt;pts
  $45 = 0x0
  gef➤  p (pktl-&gt;next)-&gt;pkt-&gt;pts
  $46 = 0xfa4
  gef➤  p (pktl-&gt;next-&gt;next)-&gt;pkt-&gt;pts
  $47 = 0xfffffffffffffc00

*/</span>
</code></pre> 
<ul><li><strong>分支二：进入<code>read_frame_internal</code>函数</strong>。从输入文件中读取数据包的功能，并将读取到的数据包添加到相应的输入流对象的缓存队列中，以供后续的处理和解码</li></ul> 
<blockquote> 
 <p>本例子Demo中后几次av_read_frame会调用该函数从输入文件里读取数据包</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">//libavformat/utils.c+1571</span>
<span class="token comment">/*
		参数一：s 指向AVFormatContext结构体的指针，表示音视频文件的相关信息。
		参数二：*pkt 指向用户AVPacket对象的指针（一般是空数据的AVPacket结构体）
*/</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">read_frame_internal</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>s<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span> 
</code></pre> 
<p>进入分析：</p> 
<ul><li>清空AVPacket结构体数据</li></ul> 
<pre><code class="prism language-c"> → <span class="token number">1575</span>	     <span class="token function">av_init_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>循环读取数据包，从内部缓存、输入文件中获取、解析数据包,确保获取到的数据的正确性</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//1577</span>
		<span class="token comment">/*
			1. got_packet变量表示是否有可用的解码数据包
			2. s-&gt;internal-&gt;parse_queue表示是否有待解析的数据包
		*/</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>got_packet <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>s<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>parse_queue<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//当没有可用的解码数据包，且解析队列中没有数据包需要处理</span>
        AVStream <span class="token operator">*</span>st<span class="token punctuation">;</span>
        AVPacket cur_pkt<span class="token punctuation">;</span>

     
        ret <span class="token operator">=</span> <span class="token function">ff_read_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cur_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 
        读取一个数据包，会从输入文件中读取,读取成功时的结构体：
        gef➤  p cur_pkt
        $54 = {
          buf = 0x55cefb3c0130,
          pts = 0x7d2,
          dts = 0x0,
          data = 0x55cefb33ff10 "",
          size = 0x2d68,
          stream_index = 0x0,
          flags = 0x0,
          side_data = 0x0,
          side_data_elems = 0x0,
          duration = 0x0,
          pos = 0x20995,
          convergence_duration = 0x0
        }
        */</span>
      

      <span class="token comment">//...</span>
        st  <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>cur_pkt<span class="token punctuation">.</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">/* 是否需要更新AVCodecContext上下文，我这里没有进入分支，不好分析。。。TODO */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>need_context_update<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_is_open</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token comment">//..</span>
            <span class="token comment">/* close parser, because it depends on the codec */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>parser <span class="token operator">&amp;&amp;</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>codec_id <span class="token operator">!=</span> st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span>
              <span class="token comment">//..</span>
            st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>need_context_update <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      
      <span class="token comment">/*
      	1.判断当前数据包的时间戳是否合法(pts、dts)
      	2. 如果时间戳合法，则判断当前数据包的pts是否小于dts，如果是，则说明时间戳不合法
      	确保后续处理的数据包时间戳正确，避免错误的解码结果。
      */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_pkt<span class="token punctuation">.</span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span>
            cur_pkt<span class="token punctuation">.</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE <span class="token operator">&amp;&amp;</span>
            cur_pkt<span class="token punctuation">.</span>pts <span class="token operator">&lt;</span> cur_pkt<span class="token punctuation">.</span>dts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_log</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> AV_LOG_WARNING<span class="token punctuation">,</span>
                   <span class="token string">"Invalid timestamps stream=%d, pts=%s, dts=%s, size=%d\n"</span><span class="token punctuation">,</span>
                   cur_pkt<span class="token punctuation">.</span>stream_index<span class="token punctuation">,</span>
                   <span class="token function">av_ts2str</span><span class="token punctuation">(</span>cur_pkt<span class="token punctuation">.</span>pts<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token function">av_ts2str</span><span class="token punctuation">(</span>cur_pkt<span class="token punctuation">.</span>dts<span class="token punctuation">)</span><span class="token punctuation">,</span>
                   cur_pkt<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token comment">//..</span>
      
      <span class="token comment">/*
      	1. 当前AVStream流需要解析
      	2. 当前流的解析器未初始化
      	3. 输入文件的标志中没有AVFMT_FLAG_NOPARSE，则需要初始化解析器
      */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>need_parsing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>st<span class="token operator">-&gt;</span>parser <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_FLAG_NOPARSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            st<span class="token operator">-&gt;</span>parser <span class="token operator">=</span> <span class="token function">av_parser_init</span><span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//..</span>
        <span class="token punctuation">}</span>

      <span class="token comment">/*
      	1. 当前AVStream流不需要解析
      	2. 当前流的解析器未初始化
      */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>st<span class="token operator">-&gt;</span>need_parsing <span class="token operator">||</span> <span class="token operator">!</span>st<span class="token operator">-&gt;</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* 不需要解析：我们只按原样输出包 */</span>
            <span class="token operator">*</span>pkt <span class="token operator">=</span> cur_pkt<span class="token punctuation">;</span>
          <span class="token comment">//到这就完成对用户的AVPacket结构体的数据填充。下面都是判断该数据是否存在其他的额外要求。</span>
          
          <span class="token comment">//计算AVPacket结构体的字段</span>
            <span class="token function">compute_pkt_fields</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pkt<span class="token punctuation">,</span> AV_NOPTS_VALUE<span class="token punctuation">,</span> AV_NOPTS_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/*
          	1. 当前输入格式是否支持通用索引
          	2. 数据包pkt是否是关键帧
          	3. 数据包的dts已经被正确赋值
          */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_GENERIC_INDEX<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_PKT_FLAG_KEY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>dts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">//生成索引的情况下，对索引进行优化，以提高索引的访问效率</span>
                <span class="token function">ff_reduce_index</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">av_add_index_entry</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pos<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">,</span>
                                   <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> AVINDEX_KEYFRAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

          <span class="token comment">//确定获取到了可用的AVPacket数据包</span>
            got_packet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          
          <span class="token comment">//AVDISCARD_ALL是表示要丢弃所有数据的标志，如果st-&gt;discard小于AVDISCARD_ALL，则表示当前流需要被保留，不需要被丢弃。</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>discard <span class="token operator">&lt;</span> AVDISCARD_ALL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">parse_packet</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cur_pkt<span class="token punctuation">,</span> cur_pkt<span class="token punctuation">.</span>stream_index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>sample_rate <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>bit_rate <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>bit_rate<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>channels <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>channels<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>channel_layout <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>channel_layout<span class="token punctuation">;</span>
            st<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id <span class="token operator">=</span> st<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>avctx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* free packet */</span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cur_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	      <span class="token comment">//数据包pkt是否是关键帧</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_PKT_FLAG_KEY<span class="token punctuation">)</span>
            st<span class="token operator">-&gt;</span>skip_to_keyframe <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token comment">//是否跳过是关键帧</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>skip_to_keyframe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cur_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>got_packet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>pkt <span class="token operator">=</span> cur_pkt<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            got_packet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//1696</span>
</code></pre> 
<ul><li>ff_read_packet 分析 TODO</li></ul> 
<pre><code>ff_read_packet
</code></pre> 
<ul><li>如果没有从输入文件中读取到数据包并且可用的数据包，则再次判断内部缓存中的链表数据包是否存在可用的数据包</li></ul> 
<pre><code class="prism language-c">  <span class="token number">1697</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>got_packet <span class="token operator">&amp;&amp;</span> s<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>parse_queue<span class="token punctuation">)</span>
  <span class="token number">1698</span>         ret <span class="token operator">=</span> <span class="token function">ff_packet_list_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>parse_queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>       internal<span class="token operator">-&gt;</span>parse_queue_end<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>得到可用的数据包后,处理样本帧 不太清楚，具体作用 TODO</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//1700</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVStream <span class="token operator">*</span>st <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> discard_padding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">/*
      1. 首个丢弃样本（first_discard_sample）不为空
      2. 当前数据包存在有效的PTS时间戳
      */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>first_discard_sample <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">!=</span> AV_NOPTS_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//..</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>start_skip_samples <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> pkt<span class="token operator">-&gt;</span>pts <span class="token operator">==</span> RELATIVE_TS_BASE<span class="token punctuation">)</span><span class="token punctuation">)</span>
            st<span class="token operator">-&gt;</span>skip_samples <span class="token operator">=</span> st<span class="token operator">-&gt;</span>start_skip_samples<span class="token punctuation">;</span>
      
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>skip_samples <span class="token operator">||</span> discard_padding<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token comment">//..</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token operator">-&gt;</span>inject_global_side_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//1743</span>
</code></pre> 
<ul><li>复制metadata数据(默认这里的metadata为空)</li></ul> 
<blockquote> 
 <p>ffmpeg默认不处理原视频中的metadata数据，需要声明保留</p> 
</blockquote> 
<pre><code class="prism language-c"> → <span class="token number">1745</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token number">1746</span>	         s<span class="token operator">-&gt;</span>event_flags <span class="token operator">|=</span> AVFMT_EVENT_FLAG_METADATA_UPDATED<span class="token punctuation">;</span>
   <span class="token number">1747</span>	         <span class="token function">av_dict_copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token operator">-&gt;</span>metadata<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">1748</span>	         <span class="token function">av_dict_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">1749</span>	         <span class="token function">av_opt_set_dict_val</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"metadata"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> AV_OPT_SEARCH_CHILDREN<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">1750</span>	     <span class="token punctuation">}</span>
</code></pre> 
<ul><li>**进入主干：**经过上面的两种不同方式获取数据后进入到return_packet后续简单处理数据包信息</li></ul> 
<pre><code class="prism language-c">  <span class="token number">1849</span> return_packet<span class="token operator">:</span>
  <span class="token number">1850</span>
						<span class="token comment">//获取读取到的packet数据流id，比如视频流、音频流、字幕流</span>
  <span class="token number">1851</span>     st <span class="token operator">=</span> s<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
						<span class="token comment">/*
						1. 判断输入文件格式是否支持通用索引(AVFMT_GENERIC_INDEX)
						2. 判断当前数据包 pkt 是否为关键帧
						*/</span>
  <span class="token number">1852</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">-&gt;</span>iformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_GENERIC_INDEX<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pkt<span class="token operator">-&gt;</span>flags        <span class="token operator">&amp;</span> AV_PKT_FLAG_KEY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    					<span class="token comment">//更新输出流对象 st 的索引(st-&gt;index)</span>
  <span class="token number">1853</span>         <span class="token function">ff_reduce_index</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    					<span class="token comment">//添加一条关键帧的索引条目(AVINDEX_KEYFRAME)</span>
  <span class="token number">1854</span>         <span class="token function">av_add_index_entry</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>pos<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> AVINDEX_KEYFRAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    					<span class="token comment">//目的是以便能够快速的定位和检索视频帧</span>
  <span class="token number">1855</span>     <span class="token punctuation">}</span>
  <span class="token number">1856</span>			<span class="token comment">/*
  						有些视频格式中，时间戳不是绝对值，而是相对于前一个时间戳的增量，需要转换成绝对值后才能正确地被处理和显示。
	  				*/</span>
  <span class="token number">1857</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_relative</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token number">1858</span>         pkt<span class="token operator">-&gt;</span>dts <span class="token operator">-=</span> RELATIVE_TS_BASE<span class="token punctuation">;</span>
  <span class="token number">1859</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_relative</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token number">1860</span>         pkt<span class="token operator">-&gt;</span>pts <span class="token operator">-=</span> RELATIVE_TS_BASE<span class="token punctuation">;</span>
  <span class="token number">1861</span>
  <span class="token number">1862</span>	     <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
→ <span class="token number">1863</span>	   <span class="token punctuation">}</span>

<span class="token comment">/*
	此时完成填充数据的AVPacket结构体:
  gef➤  p pkt
  $75 = {
    buf = 0x55cefb3c0130,
    pts = 0xbbb,
    dts = 0x7d2,
    data = 0x55cefb3472d0 "",
    size = 0x1b09,
    stream_index = 0x0,
    flags = 0x0,
    side_data = 0x0,
    side_data_elems = 0x0,
    duration = 0x3e9,
    pos = 0x2556b,
    convergence_duration = 0x0
  }
  
  注意：
- data 字段用于存储指向音视频数据缓冲区的指针，即存储数据包的音视频数据。
- buf  字段则用于存储音视频数据缓冲区的指针，是一个AVBufferRef结构体

简单点说就是buf结构体包含了data字段，如下：
gef➤  p *pkt-&gt;buf
$72 = {
  buffer = 0x55cefb3b24a0,
  data = 0x55cefb3472d0 "",
  size = 0x1b49
}
gef➤  p pkt-&gt;data
$74 = (uint8_t *) 0x55cefb3472d0 ""
所以一般在用户层读取AVPacket内的音视频数据直接读取AVPacket-&gt;data字段就可以了
*/</span>
</code></pre> 
<p>这样就完成了对用户层传入的空数据包(AVPacket结构体)的数据填充，转而用户可以进行保存数据包操作，或者再进行解码数据包操作。</p> 
<h4><a id="4av_packet_unref_2249"></a>4.av_packet_unref分析</h4> 
<p><code>libavcodec/avpacket.c+599</code> 文件函数定义:</p> 
<pre><code class="prism language-c">  <span class="token comment">/*
  	pkt : 待释放的AVPacket结构体，
  */</span>
  <span class="token number">599</span> <span class="token keyword">void</span> <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
  <span class="token number">600</span> <span class="token punctuation">{<!-- --></span>
  <span class="token number">601</span>     <span class="token function">av_packet_free_side_data</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">602</span>     <span class="token function">av_buffer_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token operator">-&gt;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">603</span>     <span class="token function">av_init_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">604</span>     pkt<span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token number">605</span>     pkt<span class="token operator">-&gt;</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token number">606</span> <span class="token punctuation">}</span>
</code></pre> 
<ul><li>释放AVPacket结构体中的side_data字段所占用的内存空间</li></ul> 
<blockquote> 
 <p>side_data字段用于存储一些额外的数据，例如H.264和H.265视频编码标准中的SEI信息、MPEG音频标准中的Audio Specific Config等</p> 
</blockquote> 
<pre><code class="prism language-c">    <span class="token number">270</span>	 <span class="token keyword">void</span> <span class="token function">av_packet_free_side_data</span><span class="token punctuation">(</span>AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
    <span class="token number">271</span>	 <span class="token punctuation">{<!-- --></span>
    <span class="token number">272</span>	     <span class="token keyword">int</span> i<span class="token punctuation">;</span>
 →  <span class="token number">273</span>	     <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pkt<span class="token operator">-&gt;</span>side_data_elems<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token number">274</span>	         <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token operator">-&gt;</span>side_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">275</span>	     <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token operator">-&gt;</span>side_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">276</span>	     pkt<span class="token operator">-&gt;</span>side_data_elems <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token number">277</span>	 <span class="token punctuation">}</span>
</code></pre> 
<ul><li>释放AVPacket结构体中的AVBufferRef结构体，也就是音视频内存数据</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//libavutil/buffer.c+126</span>
	  <span class="token number">125</span>	 <span class="token keyword">void</span> <span class="token function">av_buffer_unref</span><span class="token punctuation">(</span>AVBufferRef <span class="token operator">*</span><span class="token operator">*</span>buf<span class="token punctuation">)</span>
 →  <span class="token number">126</span>	 <span class="token punctuation">{<!-- --></span>
    <span class="token number">127</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buf <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">*</span>buf<span class="token punctuation">)</span>
    <span class="token number">128</span>	         <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token number">129</span>
    <span class="token number">130</span>	     <span class="token function">buffer_replace</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">131</span>	 <span class="token punctuation">}</span>
</code></pre> 
<ul><li>将用户层的AVBufferRef结构体数据初始化</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//libavcodec/avpacket.c+33</span>
   <span class="token number">33</span> <span class="token keyword">void</span> <span class="token function">av_init_packet</span><span class="token punctuation">(</span>AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>
   <span class="token number">34</span> <span class="token punctuation">{<!-- --></span>
   <span class="token number">35</span>     pkt<span class="token operator">-&gt;</span>pts                  <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
   <span class="token number">36</span>     pkt<span class="token operator">-&gt;</span>dts                  <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
   <span class="token number">37</span>     pkt<span class="token operator">-&gt;</span>pos                  <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token number">38</span>     pkt<span class="token operator">-&gt;</span>duration             <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token number">39</span> #<span class="token keyword">if</span> FF_API_CONVERGENCE_DURATION
   <span class="token number">40</span> FF_DISABLE_DEPRECATION_WARNINGS
   <span class="token number">41</span>     pkt<span class="token operator">-&gt;</span>convergence_duration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token number">42</span> FF_ENABLE_DEPRECATION_WARNINGS
   <span class="token number">43</span> #endif
   <span class="token number">44</span>     pkt<span class="token operator">-&gt;</span>flags                <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token number">45</span>     pkt<span class="token operator">-&gt;</span>stream_index         <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token number">46</span>     pkt<span class="token operator">-&gt;</span>buf                  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
   <span class="token number">47</span>     pkt<span class="token operator">-&gt;</span>side_data            <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
   <span class="token number">48</span>     pkt<span class="token operator">-&gt;</span>side_data_elems      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token number">49</span> <span class="token punctuation">}</span>
</code></pre> 
<ul><li>完成全部AVPacket结构体清空</li></ul> 
<pre><code class="prism language-c"><span class="token comment">/*
gef➤  p *pkt
$13 = {
  buf = 0x0,
  pts = 0x8000000000000000,
  dts = 0x8000000000000000,
  data = 0x0,
  size = 0x0,
  stream_index = 0x0,
  flags = 0x0,
  side_data = 0x0,
  side_data_elems = 0x0,
  duration = 0x0,
  pos = 0xffffffffffffffff,
  convergence_duration = 0x0
}
*/</span>
</code></pre> 
<h3><a id="APIMOV_2348"></a>调用API-解码MOV文件</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INPUT_FILE</span> <span class="token string">"input.mov"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OUTPUT_VIDEO_FILE</span> <span class="token string">"output.yuv"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OUTPUT_AUDIO_FILE</span> <span class="token string">"output.pcm"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OUTPUT_SUBTITLE_FILE</span> <span class="token string">"output.srt"</span></span>

<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

  AVFormatContext <span class="token operator">*</span>ps <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  string url <span class="token operator">=</span> INPUT_FILE<span class="token punctuation">;</span>

  FILE <span class="token operator">*</span>outputVideo <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>OUTPUT_VIDEO_FILE<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outputVideo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to open output video file"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  FILE <span class="token operator">*</span>outputAudio <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>OUTPUT_AUDIO_FILE<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outputAudio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to open output audio file"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  FILE <span class="token operator">*</span>outputSubtitle <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>OUTPUT_SUBTITLE_FILE<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outputSubtitle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to open output subtitle file"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 1. Open the input file</span>
  status <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ps<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"File "</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">" parse failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. Retrieve stream information</span>
  status <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Stream find info failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// int index = 0;</span>
  <span class="token comment">// int is_output = 0;</span>
  <span class="token comment"> 3. Print format and stream information</span>
  <span class="token comment">// av_dump_format(ps, index, url.c_str(), is_output);</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDEO_STREAM_INDEX</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AUDIO_STREAM_INDEX</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SUBTITLE_STREAM_INDEX</span> <span class="token expression"><span class="token number">2</span></span></span>

  string video_type <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  string audio_type <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token comment">// 4. Find  the video decoder and fetch video data</span>
  <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>video_codec <span class="token operator">=</span>
      <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>ps<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>VIDEO_STREAM_INDEX<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>video_codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// video_type = video_codec-&gt;name; //Better</span>
    video_type <span class="token operator">=</span> <span class="token function">avcodec_get_name</span><span class="token punctuation">(</span>video_codec<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Debug test</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Video codec: "</span> <span class="token operator">&lt;&lt;</span> video_type <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Find video codec failed !"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  AVCodecContext <span class="token operator">*</span>video_codec_ctx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>video_codec<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>
          video_codec_ctx<span class="token punctuation">,</span> ps<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>VIDEO_STREAM_INDEX<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not copy video codec parameters to context"</span>
              <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>video_codec_ctx<span class="token punctuation">,</span> video_codec<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not open video codec"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>audio_codec <span class="token operator">=</span>
      <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>ps<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>AUDIO_STREAM_INDEX<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>audio_codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// audio_type = audio_codec-&gt;name;  //Better</span>
    audio_type <span class="token operator">=</span> <span class="token function">avcodec_get_name</span><span class="token punctuation">(</span>audio_codec<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Debug test</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Audio codec: "</span> <span class="token operator">&lt;&lt;</span> audio_type <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Find audio codec failed !"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  AVCodecContext <span class="token operator">*</span>audio_codec_ctx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>audio_codec<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>
          audio_codec_ctx<span class="token punctuation">,</span> ps<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>AUDIO_STREAM_INDEX<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not copy audio codec parameters to context"</span>
              <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>audio_codec_ctx<span class="token punctuation">,</span> audio_codec<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not open audio codec"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  AVPacket pkt<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>stream_index <span class="token operator">==</span> VIDEO_STREAM_INDEX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Fetch video encode data</span>
      <span class="token comment">// fwrite(pkt.data, 1, pkt.size, outputVideo);</span>

      <span class="token comment">// Fetch video raw data</span>
      AVFrame <span class="token operator">*</span>video_frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>video_codec_ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error sending video packet to decoder: "</span> <span class="token operator">&lt;&lt;</span> ret
                  <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>video_codec_ctx<span class="token punctuation">,</span> video_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error receiving video frame from decoder: "</span> <span class="token operator">&lt;&lt;</span> ret
                    <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Video frame: "</span> <span class="token operator">&lt;&lt;</span> video_frame<span class="token operator">-&gt;</span>width <span class="token operator">&lt;&lt;</span> <span class="token string">"x"</span>
                  <span class="token operator">&lt;&lt;</span> video_frame<span class="token operator">-&gt;</span>height <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> video_frame<span class="token operator">-&gt;</span>pts
                  <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token comment">// 将帧数据写入本地文件</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>video_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
               video_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> video_codec_ctx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> outputVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>video_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
               video_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> video_codec_ctx<span class="token operator">-&gt;</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
               outputVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>video_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
               video_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> video_codec_ctx<span class="token operator">-&gt;</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
               outputVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">av_frame_unref</span><span class="token punctuation">(</span>video_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>stream_index <span class="token operator">==</span> AUDIO_STREAM_INDEX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Fetch audio encode data</span>
      <span class="token comment">// fwrite(pkt.data, 1, pkt.size, outputAudio);</span>

      <span class="token comment">// Fetch audio raw data</span>
      AVFrame <span class="token operator">*</span>audio_frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>audio_codec_ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error sending audio packet to decoder: "</span> <span class="token operator">&lt;&lt;</span> ret
                  <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>audio_codec_ctx<span class="token punctuation">,</span> audio_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error receiving audio frame from decoder: "</span> <span class="token operator">&lt;&lt;</span> ret
                    <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Audio frame: "</span> <span class="token operator">&lt;&lt;</span> audio_frame<span class="token operator">-&gt;</span>nb_samples <span class="token operator">&lt;&lt;</span> <span class="token string">" samples, "</span>
                  <span class="token operator">&lt;&lt;</span> audio_frame<span class="token operator">-&gt;</span>pts <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

        <span class="token comment">// 计算音频帧大小</span>
        <span class="token keyword">int</span> frame_size <span class="token operator">=</span> <span class="token function">av_get_bytes_per_sample</span><span class="token punctuation">(</span>audio_codec_ctx<span class="token operator">-&gt;</span>sample_fmt<span class="token punctuation">)</span> <span class="token operator">*</span>
                         audio_codec_ctx<span class="token operator">-&gt;</span>channels <span class="token operator">*</span> audio_frame<span class="token operator">-&gt;</span>nb_samples<span class="token punctuation">;</span>

        <span class="token function">fwrite</span><span class="token punctuation">(</span>audio_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> frame_size<span class="token punctuation">,</span> outputAudio<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">av_frame_unref</span><span class="token punctuation">(</span>audio_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>audio_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>stream_index <span class="token operator">==</span> SUBTITLE_STREAM_INDEX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">fwrite</span><span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> pkt<span class="token punctuation">.</span>size<span class="token punctuation">,</span> outputSubtitle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Subtitle pts "</span> <span class="token operator">&lt;&lt;</span> pkt<span class="token punctuation">.</span>pts <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Close data packet resource</span>
    <span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Output video file -&gt; "</span> <span class="token operator">&lt;&lt;</span> OUTPUT_VIDEO_FILE <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Output audio file -&gt; "</span> <span class="token operator">&lt;&lt;</span> OUTPUT_AUDIO_FILE <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Output subtitle file -&gt; "</span> <span class="token operator">&lt;&lt;</span> OUTPUT_SUBTITLE_FILE <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

  <span class="token function">fclose</span><span class="token punctuation">(</span>outputVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>outputAudio<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>outputSubtitle<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 4. Close the input file IO</span>
  <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面通过av_read_frame函数分离的视频流、音频流、字幕流并将各个流的数据包（解mov封装后的编码文件）写入到了本地，接下来进一步将视频数据包、音频数据包解码为原始数据即YUV、PCM</p> 
<blockquote> 
 <p>每次的代码都是在上一章的基础上添加新代码，可以使用对比文件工具来看具体添加的新代码</p> 
</blockquote> 
<h4><a id="1avcodec_alloc_context3_2567"></a>1.avcodec_alloc_context3分析</h4> 
<p><code>libavcodec/options.c+157</code> 文件函数定义:</p> 
<pre><code class="prism language-c">    <span class="token number">156</span>	 AVCodecContext <span class="token operator">*</span><span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span><span class="token keyword">const</span> AVCodec <span class="token operator">*</span>codec<span class="token punctuation">)</span>
    <span class="token number">157</span>	 <span class="token punctuation">{<!-- --></span>
    <span class="token number">158</span>	     AVCodecContext <span class="token operator">*</span>avctx<span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>AVCodecContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      			<span class="token comment">/*
      			av_malloc有个最大内存限制即：
      			gef➤  p (max_alloc_size - 32)
						$7 = 0x7fffffdf
						*/</span>
    <span class="token number">159</span>
    <span class="token number">160</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avctx<span class="token punctuation">)</span>
    <span class="token number">161</span>	         <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token number">162</span>
    <span class="token number">163</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">init_context_defaults</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> codec<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">164</span>	         <span class="token function">av_free</span><span class="token punctuation">(</span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
 →  <span class="token number">165</span>	         <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token number">166</span>	     <span class="token punctuation">}</span>
    <span class="token number">167</span>
    <span class="token number">168</span>	     <span class="token keyword">return</span> avctx<span class="token punctuation">;</span>
    <span class="token number">169</span>	 <span class="token punctuation">}</span>
</code></pre> 
<ul><li>初始化结构体成员为ffmpeg设置的默认值，不是NULL</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//libavcodec/options.c+96</span>
     <span class="token number">91</span>	 <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">init_context_defaults</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>codec<span class="token punctuation">)</span>
     <span class="token number">92</span>	 <span class="token punctuation">{<!-- --></span>
     <span class="token number">93</span>	     <span class="token keyword">int</span> flags<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
       			<span class="token comment">//memset清空内存大小为sizeof(AVCodecContext)也就是0x420</span>
     <span class="token number">94</span>	     <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>AVCodecContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token number">95</span>
 →   <span class="token number">96</span>	     s<span class="token operator">-&gt;</span>av_class <span class="token operator">=</span> <span class="token operator">&amp;</span>av_codec_context_class<span class="token punctuation">;</span>
     <span class="token number">97</span>
     <span class="token number">98</span>	     s<span class="token operator">-&gt;</span>codec_type <span class="token operator">=</span> codec <span class="token operator">?</span> codec<span class="token operator">-&gt;</span>type <span class="token operator">:</span> AVMEDIA_TYPE_UNKNOWN<span class="token punctuation">;</span>
       <span class="token comment">//..</span>
 →  <span class="token number">112</span>	     s<span class="token operator">-&gt;</span>time_base           <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token number">113</span>	     s<span class="token operator">-&gt;</span>framerate           <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token number">114</span>	     s<span class="token operator">-&gt;</span>pkt_timebase        <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token number">115</span>	     s<span class="token operator">-&gt;</span>get_buffer2         <span class="token operator">=</span> avcodec_default_get_buffer2<span class="token punctuation">;</span>
    <span class="token number">116</span>	     s<span class="token operator">-&gt;</span>get_format          <span class="token operator">=</span> avcodec_default_get_format<span class="token punctuation">;</span>
    <span class="token number">117</span>	     s<span class="token operator">-&gt;</span>execute             <span class="token operator">=</span> avcodec_default_execute<span class="token punctuation">;</span>
 →  <span class="token number">118</span>	     s<span class="token operator">-&gt;</span>execute2            <span class="token operator">=</span> avcodec_default_execute2<span class="token punctuation">;</span>
    <span class="token number">119</span>	     s<span class="token operator">-&gt;</span>sample_aspect_ratio <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token number">120</span>	     s<span class="token operator">-&gt;</span>pix_fmt             <span class="token operator">=</span> AV_PIX_FMT_NONE<span class="token punctuation">;</span>
    <span class="token number">121</span>	     s<span class="token operator">-&gt;</span>sw_pix_fmt          <span class="token operator">=</span> AV_PIX_FMT_NONE<span class="token punctuation">;</span>
    <span class="token number">122</span>	     s<span class="token operator">-&gt;</span>sample_fmt          <span class="token operator">=</span> AV_SAMPLE_FMT_NONE<span class="token punctuation">;</span>
       <span class="token comment">//..</span>
</code></pre> 
<p>该函数只是简单的申请了一块AVCodecContext内存，并对其进行初始化参数，并不复杂</p> 
<h4><a id="2avcodec_parameters_to_context_2625"></a>2.avcodec_parameters_to_context分析</h4> 
<pre><code class="prism language-c"><span class="token comment">//libavcodec/utils.c+2117</span>
<span class="token keyword">int</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>codec<span class="token punctuation">,</span><span class="token keyword">const</span> AVCodecParameters <span class="token operator">*</span>par<span class="token punctuation">)</span>
   <span class="token comment">/* 根据AVCodecParameters内的解码器特性参数数据来填充用户的 `AVCodecContext`结构体，以便后续进行解码操作。 */</span>
</code></pre> 
<ul><li>从AVFormatConetxt结构体下AVCodecParameters结构体中复制输入视频文件对应的解码器参数</li></ul> 
<blockquote> 
 <p>这些信息都是在之前调用avformat_find_stream_info时就已经完成了对输入文件的解析、并填充了数据到AVFormatConetxt结构体内，现在的操作跟dump_stream_format函数的处理相同</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">//列举视频流的参数复制</span>
   <span class="token number">2118</span>	     codec<span class="token operator">-&gt;</span>codec_type <span class="token operator">=</span> par<span class="token operator">-&gt;</span>codec_type<span class="token punctuation">;</span>
   <span class="token number">2119</span>	     codec<span class="token operator">-&gt;</span>codec_id   <span class="token operator">=</span> par<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">;</span>
 → <span class="token number">2120</span>	     codec<span class="token operator">-&gt;</span>codec_tag  <span class="token operator">=</span> par<span class="token operator">-&gt;</span>codec_tag<span class="token punctuation">;</span>
   <span class="token number">2121</span>
   <span class="token number">2122</span>	     codec<span class="token operator">-&gt;</span>bit_rate              <span class="token operator">=</span> par<span class="token operator">-&gt;</span>bit_rate<span class="token punctuation">;</span>
   <span class="token number">2123</span>	     codec<span class="token operator">-&gt;</span>bits_per_coded_sample <span class="token operator">=</span> par<span class="token operator">-&gt;</span>bits_per_coded_sample<span class="token punctuation">;</span>
   <span class="token number">2124</span>	     codec<span class="token operator">-&gt;</span>bits_per_raw_sample   <span class="token operator">=</span> par<span class="token operator">-&gt;</span>bits_per_raw_sample<span class="token punctuation">;</span>
   <span class="token number">2125</span>	     codec<span class="token operator">-&gt;</span>profile               <span class="token operator">=</span> par<span class="token operator">-&gt;</span>profile<span class="token punctuation">;</span>
   <span class="token number">2126</span>	     codec<span class="token operator">-&gt;</span>level                 <span class="token operator">=</span> par<span class="token operator">-&gt;</span>level<span class="token punctuation">;</span>
   <span class="token number">2127</span>
 → <span class="token number">2128</span>	     <span class="token keyword">switch</span> <span class="token punctuation">(</span>par<span class="token operator">-&gt;</span>codec_type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token number">2129</span>	     <span class="token keyword">case</span> AVMEDIA_TYPE_VIDEO<span class="token operator">:</span>
   <span class="token number">2130</span>	         codec<span class="token operator">-&gt;</span>pix_fmt                <span class="token operator">=</span> par<span class="token operator">-&gt;</span>format<span class="token punctuation">;</span>
   <span class="token number">2131</span>	         codec<span class="token operator">-&gt;</span>width                  <span class="token operator">=</span> par<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
   <span class="token number">2132</span>	         codec<span class="token operator">-&gt;</span>height                 <span class="token operator">=</span> par<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
   <span class="token number">2133</span>	         codec<span class="token operator">-&gt;</span>field_order            <span class="token operator">=</span> par<span class="token operator">-&gt;</span>field_order<span class="token punctuation">;</span>
   <span class="token number">2134</span>	         codec<span class="token operator">-&gt;</span>color_range            <span class="token operator">=</span> par<span class="token operator">-&gt;</span>color_range<span class="token punctuation">;</span>
   <span class="token number">2135</span>	         codec<span class="token operator">-&gt;</span>color_primaries        <span class="token operator">=</span> par<span class="token operator">-&gt;</span>color_primaries<span class="token punctuation">;</span>
   <span class="token number">2136</span>	         codec<span class="token operator">-&gt;</span>color_trc              <span class="token operator">=</span> par<span class="token operator">-&gt;</span>color_trc<span class="token punctuation">;</span>
   <span class="token number">2137</span>	         codec<span class="token operator">-&gt;</span>colorspace             <span class="token operator">=</span> par<span class="token operator">-&gt;</span>color_space<span class="token punctuation">;</span>
   <span class="token number">2138</span>	         codec<span class="token operator">-&gt;</span>chroma_sample_location <span class="token operator">=</span> par<span class="token operator">-&gt;</span>chroma_location<span class="token punctuation">;</span>
   <span class="token number">2139</span>	         codec<span class="token operator">-&gt;</span>sample_aspect_ratio    <span class="token operator">=</span> par<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">;</span>
   <span class="token number">2140</span>	         codec<span class="token operator">-&gt;</span>has_b_frames           <span class="token operator">=</span> par<span class="token operator">-&gt;</span>video_delay<span class="token punctuation">;</span>
   <span class="token number">2141</span>	         <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token number">2142</span>	      <span class="token keyword">case</span> AVMEDIA_TYPE_AUDIO<span class="token operator">:</span>
     <span class="token comment">//..</span>
</code></pre> 
<p>这样就完成了对用户态AVCodecContext结构体在解码文件<strong>必要的数据</strong>填充，上面可以看到现在用户态AVCodecContext结构体的其他数据都是ffmpeg初始化后的数据。</p> 
<h4><a id="3avcodec_open2_2671"></a>3.avcodec_open2分析</h4> 
<pre><code class="prism language-c"><span class="token comment">//libavcodec/utils.c+549</span>
<span class="token keyword">int</span> attribute_align_arg <span class="token function">avcodec_open2</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>codec<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span><span class="token operator">*</span>options<span class="token punctuation">)</span>
<span class="token comment">/*
	avctx ： 存储编、解码器的相关参数和状态的结构体。用户态创建的数据结构体
	codec ： 指定要打开的标准编、解码器。一个标准类型的编、解码器结构体，不带有用户态的数据
	options： 用于传递可选的编码器或解码器参数
*/</span>
</code></pre> 
<ul><li>在进入该函数后来看下此时的数据结构体</li></ul> 
<pre><code class="prism language-c">gef➤  p <span class="token operator">*</span>avctx
AVCodecContext <span class="token operator">*</span>avctx <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//部分重要数据已经被填充完毕，数据来源为之前的调用avcodec_parameters_to_context从AVFormatContext中所获取</span>
  codec_type <span class="token operator">=</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">,</span>
  codec <span class="token operator">=</span> <span class="token number">0xf68e60</span> <span class="token operator">&lt;</span>ff_h264_decoder<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  codec_id <span class="token operator">=</span> AV_CODEC_ID_H264<span class="token punctuation">,</span>
  codec_tag <span class="token operator">=</span> <span class="token number">0x31637661</span><span class="token punctuation">,</span>
  priv_data <span class="token operator">=</span> <span class="token number">0x19ef260</span><span class="token punctuation">,</span>
  internal <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  opaque <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  bit_rate <span class="token operator">=</span> <span class="token number">0x34c3c6</span><span class="token punctuation">,</span>
  pix_fmt <span class="token operator">=</span> AV_PIX_FMT_YUVJ420P<span class="token punctuation">,</span>
  color_primaries <span class="token operator">=</span> AVCOL_PRI_SMPTE432<span class="token punctuation">,</span>
  color_trc <span class="token operator">=</span> AVCOL_TRC_BT709<span class="token punctuation">,</span>
  colorspace <span class="token operator">=</span> AVCOL_SPC_SMPTE170M<span class="token punctuation">,</span>
  color_range <span class="token operator">=</span> AVCOL_RANGE_JPEG<span class="token punctuation">,</span>
  chroma_sample_location <span class="token operator">=</span> AVCHROMA_LOC_LEFT<span class="token punctuation">,</span>
  profile <span class="token operator">=</span> <span class="token number">0x64</span><span class="token punctuation">,</span>
  level <span class="token operator">=</span> <span class="token number">0x32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

gef➤  p <span class="token operator">*</span>codec <span class="token comment">//codec为ffmpeg内置的h264类型的解码结构体。此时无用户态干预数据</span>
$<span class="token number">8</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  name <span class="token operator">=</span> <span class="token number">0xb31341</span> <span class="token string">"h264"</span><span class="token punctuation">,</span>
  long_name <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  type <span class="token operator">=</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">,</span>
  id <span class="token operator">=</span> AV_CODEC_ID_H264<span class="token punctuation">,</span>
  init <span class="token operator">=</span> <span class="token number">0x414c12</span> <span class="token operator">&lt;</span>h264_decode_init<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  encode_sub <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  encode2 <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  decode <span class="token operator">=</span> <span class="token number">0x5c822f</span> <span class="token operator">&lt;</span>h264_decode_frame<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  close <span class="token operator">=</span> <span class="token number">0x414b36</span> <span class="token operator">&lt;</span>h264_decode_end<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  send_frame <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  receive_packet <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  receive_frame <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  flush <span class="token operator">=</span> <span class="token number">0x5c9753</span> <span class="token operator">&lt;</span>flush_dpb<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>检测AVCodecContext结构体</li></ul> 
<blockquote> 
 <p>ffmpeg这个有个小技巧看函数定义</p> 
</blockquote> 
<pre><code class="prism language-c"> →  <span class="token number">555</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_is_open</span><span class="token punctuation">(</span>avctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token number">556</span>	         <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">/*函数定义如下(libavcodec/utils.c+1899)：
   1898	 int avcodec_is_open(AVCodecContext *s)
 → 1899	 {
   1900	     return !!s-&gt;internal; 
   				  //这里的"!!"是为了将结果转化为bool值(1bit)，从而避免了传输一个指针(8byte)或者一个结构体（sizeof(AVCodecInternal)==0xf0 byte）
   1901	 }
*/</span>
</code></pre> 
<ul><li>锁定指定的解码器或编码器，以确保在多线程环境下对其进行安全访问</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//进入ff_lock_avcodec(avctx, codec);</span>
    <span class="token number">524</span>	 <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ff_lock_avcodec</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>log_ctx<span class="token punctuation">,</span> <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>codec<span class="token punctuation">)</span>
    <span class="token number">525</span>	 <span class="token punctuation">{<!-- --></span>
 →  <span class="token number">526</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>codec<span class="token operator">-&gt;</span>caps_internal <span class="token operator">&amp;</span> FF_CODEC_CAP_INIT_THREADSAFE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> codec<span class="token operator">-&gt;</span>init<span class="token punctuation">)</span>
					   <span class="token comment">//检查当前 AVCodec 是否支持多线程初始化</span>
    <span class="token number">527</span>	         <span class="token function">ff_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>codec_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">528</span>	 <span class="token punctuation">}</span>
<span class="token comment">//我测试时没有进入</span>
</code></pre> 
<ul><li>申请内存用于保存编解码器的内部状态信息</li></ul> 
<pre><code class="prism language-c">  <span class="token number">578</span>	    avctx<span class="token operator">-&gt;</span>internal <span class="token operator">=</span> <span class="token function">av_mallocz</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>avctx<span class="token operator">-&gt;</span>internal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">584</span>     avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>pool <span class="token operator">=</span> <span class="token function">av_mallocz</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>pool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">590</span>     avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>to_free <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">596</span>     avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>compat_decode_frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">602</span>     avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>buffer_frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">608</span>     avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>buffer_pkt <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">614</span>     avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>ds<span class="token punctuation">.</span>in_pkt <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">620</span>     avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>last_pkt_props <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token number">626</span>     avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>skip_samples_multiplier <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">/*
AVCodecInternal 结构体中保存了编解码器的内部状态信息，包括线程池、缓冲区等等。在进行多线程编码或解码时，需要为每个线程分配独立的缓冲区，以免不同线程之间发生冲突。因此，需要使用 av_mallocz() 函数为每个线程分配独立的 AVCodecInternal 结构体，并将结构体中的缓冲区全部初始化为0，以保证线程安全性。
*/</span>
</code></pre> 
<ul><li>根据新的宽高值更新其他相关字段</li></ul> 
<pre><code class="prism language-c">    <span class="token number">660</span>	    ret <span class="token operator">=</span> <span class="token function">ff_set_dimensions</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> avctx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> avctx<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
比如会更新 AVCodecContext 结构体中的以下字段：
1. coded_width 和 coded_height：表示编码后的宽高值，通常是原始宽高值的 2 的倍数；
2. width 和 height：表示原始视频的宽高值；
*/</span>
</code></pre> 
<ul><li>初始化解码器中的 bitstream filters 的函数</li></ul> 
<pre><code class="prism language-c"> →  <span class="token number">751</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">av_codec_is_decoder</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">752</span>	         ret <span class="token operator">=</span> <span class="token function">ff_decode_bsfs_init</span><span class="token punctuation">(</span>avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">753</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token number">754</span>	             <span class="token keyword">goto</span> free_and_end<span class="token punctuation">;</span>
    <span class="token number">755</span>	     <span class="token punctuation">}</span>
</code></pre> 
<ul><li>解锁指定的解码器或编码器，允许多线程环境下对其进行访问</li></ul> 
<pre><code class="prism language-c">   <span class="token number">1034</span>	 end<span class="token operator">:</span>
 → <span class="token number">1035</span>	     <span class="token function">ff_unlock_avcodec</span><span class="token punctuation">(</span>codec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//我测试时没有进入</span>
</code></pre> 
<p>该函数主要完成了对<code>AVCodecContext *avctx</code>的解码宽高指定、AVCodecInternal结构体数据内存的申请。比如：</p> 
<pre><code class="prism language-c">  coded_width <span class="token operator">=</span> <span class="token number">0x5a0</span><span class="token punctuation">,</span>
  coded_height <span class="token operator">=</span> <span class="token number">0x780</span><span class="token punctuation">,</span>
  internal <span class="token operator">=</span> <span class="token number">0x33a2a20</span><span class="token punctuation">,</span>
</code></pre> 
<h4><a id="4av_frame_alloc_2810"></a>4.av_frame_alloc分析</h4> 
<p>上面完成了对解码参数的设置、所需的内存空间申请、解码器初始化后就可以开始发送编码数据到解码器进行解码操作了。所以在这之前需要通过<code>av_frame_alloc</code>申请一块可以接受解码数据的内存块</p> 
<p><code>libavutil/frame.c+190</code>函数定义：</p> 
<pre><code class="prism language-c">    <span class="token number">189</span>	 AVFrame <span class="token operator">*</span><span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
    <span class="token number">190</span>	 <span class="token punctuation">{<!-- --></span>
    <span class="token number">191</span>	     AVFrame <span class="token operator">*</span>frame <span class="token operator">=</span> <span class="token function">av_mallocz</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>frame<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">192</span>
 →  <span class="token number">193</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token punctuation">)</span>
    <span class="token number">194</span>	         <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token number">195</span>
    <span class="token number">196</span>	     frame<span class="token operator">-&gt;</span>extended_data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token number">197</span>	     <span class="token function">get_frame_defaults</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">198</span>
    <span class="token number">199</span>	     <span class="token keyword">return</span> frame<span class="token punctuation">;</span>
    <span class="token number">200</span>	 <span class="token punctuation">}</span>
</code></pre> 
<p>该函数申请了一块AVFrame大小（<code>p sizeof(*frame) = 0x218</code>）的堆块，在赋予默认值后返回到用户态以供使用，那么很明显这块内存的使用权到达用户态后就需要用户态进行手动释放。</p> 
<h4><a id="5avcodec_send_packet_2835"></a>5.avcodec_send_packet分析</h4> 
<p>有了待接受内存块和之前解码器的准备工作，那么现在就可以通过<code>AVCodecContext</code>解码器上下文和内部的<code>AVCodecInternal</code>解码器对<code>AVPacket</code>数据内的编码数据进行解码操作了</p> 
<p><code>libavcodec/decode.c+678</code>函数定义：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> attribute_align_arg <span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> <span class="token keyword">const</span> AVPacket <span class="token operator">*</span>avpkt<span class="token punctuation">)</span>
  <span class="token comment">/*
  	avctx : 用来进行编、解码操作的AVCodecContext结构体
  	avpkt : 待解码的编码数据包
  */</span>
</code></pre> 
<ul><li>获取编解码器的内部状态信息，包括线程池、缓冲区等等</li></ul> 
<pre><code class="prism language-c">    <span class="token number">679</span>	     AVCodecInternal <span class="token operator">*</span>avci <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>internal<span class="token punctuation">;</span>
</code></pre> 
<ul><li>清除编解码器内部缓冲区中可能存在的旧的输入数据（Packet）和，以便于接收新的数据。</li></ul> 
<blockquote> 
 <p>这样可以保证输入数据的连续性和完整性，避免因为缓冲区溢出或不足导致的解码错误或丢失数据</p> 
</blockquote> 
<pre><code class="prism language-c"> →  <span class="token number">691</span>	     <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>avci<span class="token operator">-&gt;</span>buffer_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>在将 <code>AVPacket</code> 拷贝到编解码器的内部缓冲区中时，使用 <code>av_packet_ref()</code> 函数来完成拷贝</li></ul> 
<pre><code class="prism language-c"> →  <span class="token number">692</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>avpkt <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>avpkt<span class="token operator">-&gt;</span>data <span class="token operator">||</span> avpkt<span class="token operator">-&gt;</span>side_data_elems<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token number">693</span>	         ret <span class="token operator">=</span> <span class="token function">av_packet_ref</span><span class="token punctuation">(</span>avci<span class="token operator">-&gt;</span>buffer_pkt<span class="token punctuation">,</span> avpkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
1. `av_packet_ref()` 函数会将用户态的 `AVPacket` 中的data 和 side data 均进行拷贝，而不是仅仅拷贝 `AVPacket` 的指针。
2. 这是为了确保内部缓冲区的数据在后续的操作中不会被用户态进行修改或释放操作，从而避免了不必要的错误和异常。
*/</span>
</code></pre> 
<ul><li>适用位流过滤器中进行转换，将输入的数据进行处理，并将处理后的数据保存在自己的内部缓冲区中</li></ul> 
<pre><code class="prism language-c">ret <span class="token operator">=</span> <span class="token function">av_bsf_send_packet</span><span class="token punctuation">(</span>avci<span class="token operator">-&gt;</span>filter<span class="token punctuation">.</span>bsfs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> avci<span class="token operator">-&gt;</span>buffer_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
1. avci-&gt;filter.bsfs[0] 表示位流过滤器的句柄
2. avci-&gt;buffer_pkt 表示编解码器的内部缓冲区中保存的 AVPacket。即上面通过av_packet_ref保存用户态传入的AVPacket
*/</span>
</code></pre> 
<ul><li>是否该AVPackt以及完成完成解码操作，即检查内部是否保存着解码后数据</li></ul> 
<blockquote> 
 <p>这个函数就是ffmpeg内部进行编、解码的函数</p> 
</blockquote> 
<pre><code class="prism language-c">   					<span class="token comment">//代码检查 `avci-&gt;buffer_frame` 缓冲区是否已经被分配。这是为了避免对同一帧数据进行多次解码，从而提高了解码效率。</span>
		<span class="token number">704</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avci<span class="token operator">-&gt;</span>buffer_frame<span class="token operator">-&gt;</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 →  <span class="token number">705</span>	         ret <span class="token operator">=</span> <span class="token function">decode_receive_frame_internal</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> avci<span class="token operator">-&gt;</span>buffer_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>进入到 decode_receive_frame_internal</li></ul> 
<pre><code class="prism language-c">    <span class="token number">637</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">decode_receive_frame_internal</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span>        AVFrame <span class="token operator">*</span>frame<span class="token punctuation">)</span>
    <span class="token number">638</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">//...</span>
       		<span class="token comment">/*
       		检查编解码器是否提供了 receive_frame 函数。
       		1. 如果提供了，则调用编解码器的 receive_frame 函数，将解码后的帧数据保存在 AVFrame 结构体 frame 中。
       		2. 否则，将调用 decode_simple_receive_frame() 函数进行简单的帧接收处理。
       		这是一个针对特定解码器类型的解码函数的简单实现，不能满足所有解码需求。如果需要进行更为复杂的帧接收处理，需要使用 receive_frame() 函数接收处理函数。
       		*/</span>
 →  <span class="token number">644</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>receive_frame<span class="token punctuation">)</span>
    <span class="token number">645</span>	         ret <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span><span class="token function">receive_frame</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
      				<span class="token comment">/*
      				gef➤  pt avctx-&gt;codec-&gt;receive_frame
              type = int (*)(AVCodecContext *, AVFrame *)
              可以看到receive_frame为一个函数指针，在这里就是指代：
`avcodec_receive_frame(AVCodecContext *avctx, AVFrame *frame)`函数
      				*/</span>
    <span class="token number">646</span>	     <span class="token keyword">else</span>
    <span class="token number">647</span>	         ret <span class="token operator">=</span> <span class="token function">decode_simple_receive_frame</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>进入decode_simple_receive_frame函数</li></ul> 
<pre><code class="prism language-c">   <span class="token number">624</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">decode_simple_receive_frame</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> AV       Frame <span class="token operator">*</span>frame<span class="token punctuation">)</span>
   <span class="token number">625</span> <span class="token punctuation">{<!-- --></span>
   <span class="token number">626</span>     <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
   <span class="token number">627</span>
   <span class="token number">628</span>     <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token operator">-&gt;</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token number">629</span>         ret <span class="token operator">=</span> <span class="token function">decode_simple_internal</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token number">630</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token number">631</span>             <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
   <span class="token number">632</span>     <span class="token punctuation">}</span>
   <span class="token number">633</span>
   <span class="token number">634</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token number">635</span> <span class="token punctuation">}</span>
</code></pre> 
<ul><li>这里循环处理对数据包进行解码操作，每次只会解码一帧（重点！！！）</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//402</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">decode_simple_internal</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> AVFrame <span class="token operator">*</span>frame<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVCodecInternal   <span class="token operator">*</span>avci <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>internal<span class="token punctuation">;</span>
    DecodeSimpleContext <span class="token operator">*</span>ds <span class="token operator">=</span> <span class="token operator">&amp;</span>avci<span class="token operator">-&gt;</span>ds<span class="token punctuation">;</span>
    AVPacket           <span class="token operator">*</span>pkt <span class="token operator">=</span> ds<span class="token operator">-&gt;</span>in_pkt<span class="token punctuation">;</span>
    <span class="token comment">// copy to ensure we do not change pkt</span>
    <span class="token keyword">int</span> got_frame<span class="token punctuation">,</span> actual_got_frame<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkt<span class="token operator">-&gt;</span>data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>avci<span class="token operator">-&gt;</span>draining<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">ff_decode_get_packet</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/*
      	从 AVCodecInternal 结构体中的 buffer_pkt 中获取解码后的数据包，如果数据包不存在，则使用 AVCodecContext 结构体中的 get_buffer2() 函数从缓存池中获取一个新的数据包，并将其保存在 buffer_pkt 中。
      */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ret <span class="token operator">!=</span> AVERROR_EOF<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//..</span>
  
  	<span class="token comment">//初始化是否获取到可用帧标志</span>
    got_frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/*
  		HAVE_THREADS 是一个宏定义，表示当前编译器支持多线程	
  */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>HAVE_THREADS <span class="token operator">&amp;&amp;</span> avctx<span class="token operator">-&gt;</span>active_thread_type <span class="token operator">&amp;</span> FF_THREAD_FRAME<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/*
      	进行基于帧的多线程解码。该函数使用线程池并行地解码输入帧，然后将解码结果合并到输出帧中
      */</span>
        ret <span class="token operator">=</span> <span class="token function">ff_thread_decode_frame</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_frame<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/*
      	单线程解码，这里的测试Demo会进入到这里,decode是一个指针函数，可以更具不同的解码器来调用各种编码格式的的解码函数。
      	&gt;杂谈：不难看出FFmpeg的架构思想就是把面向对象的思想带入到C中，用C的特性来实现面向对象的特性&lt;
        gef➤  p avctx-&gt;codec-&gt;decode
        $4 = (int (*)(AVCodecContext *, void *, int *, AVPacket *)) 0x5c822f &lt;h264_decode_frame&gt;
      	我的编码视频为h264所以这里对应的解码函数就是h264_decode_frame(),该函数分析流程在下面👇"h264_decode_frame分析（不在显示调用API中）"
      */</span>
        ret <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span><span class="token function">decode</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_frame<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/*
      	这也就是解码的核心函数，前面的代码除去兼容、性能方面其他都是为调用这里解码做准备
      */</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>caps_internal <span class="token operator">&amp;</span> FF_CODEC_CAP_SETS_PKT_DTS<span class="token punctuation">)</span><span class="token punctuation">)</span>
            frame<span class="token operator">-&gt;</span>pkt_dts <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">;</span>
            <span class="token comment">/*
     如果当前解码器不支持设置AVPacket的DTS字段，那么就将AVFrame的PTS字段设置为DTS字段。
     因为在一些解码器中，会在解码时自动设置AVFrame的PTS，但并不会设置DTS，这时就可以使用这个语句来保证AVFrame的PTS和DTS都正确设置。
      */</span>
      
      
        <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>avctx<span class="token operator">-&gt;</span>has_b_frames<span class="token punctuation">)</span>
                frame<span class="token operator">-&gt;</span>pkt_pos <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>pos<span class="token punctuation">;</span>
          
          
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>capabilities <span class="token operator">&amp;</span> AV_CODEC_CAP_DR1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">//检查解码器是否支持DR1，也就是能否使用get_buffer2()方法进行帧内存的分配</span>
            
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">.</span>num<span class="token punctuation">)</span>  frame<span class="token operator">-&gt;</span>sample_aspect_ratio <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>sample_aspect_ratio<span class="token punctuation">;</span>
                <span class="token comment">//检查视频帧的采样宽高比是否为0</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token operator">-&gt;</span>width<span class="token punctuation">)</span>                    frame<span class="token operator">-&gt;</span>width               <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
               <span class="token comment">//检查视频帧宽</span>
              
              
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span>                   frame<span class="token operator">-&gt;</span>height              <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
              <span class="token comment">//检查视频帧高</span>
              
                <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>format <span class="token operator">==</span> AV_PIX_FMT_NONE<span class="token punctuation">)</span> frame<span class="token operator">-&gt;</span>format              <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">;</span>
              <span class="token comment">//检查视频帧的像素格式是否为AV_PIX_FMT_NONE，如果是，则尝试使用解码器的默认值。</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

      <span class="token function">emms_c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
  emms_c()是一个汇编指令，用于清空浮点寄存器并将其切换为x87 FPU控制字寄存器的初始状态。在视频解码时，可能会用到MMX、SSE等指令集，这些指令集会使用浮点寄存器。如果不使用emms_c()指令清空浮点寄存器，可能会导致之后的浮点运算产生错误。因此，emms_c()指令是非常重要的一个清空浮点寄存器的指令，也是编写优秀视频解码器的必要措施之一。
  */</span>

    actual_got_frame <span class="token operator">=</span> got_frame<span class="token punctuation">;</span>
  <span class="token comment">//正确解码的情况下此时已经或得到了解码帧，即got_frame==1</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_FRAME_FLAG_DISCARD<span class="token punctuation">)</span>
          <span class="token comment">/*该帧是否含有丢弃标记，比如：
          1.如果这一帧视频的码率太高，超出了播放设备的处理能力，就可以选择丢弃这一帧
          2.如果这一帧视频的数据出现了错误或者损坏，就可以选择丢弃这一帧。
          */</span>
            got_frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>got_frame<span class="token punctuation">)</span>
            frame<span class="token operator">-&gt;</span>best_effort_timestamp <span class="token operator">=</span> <span class="token function">guess_correct_pts</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span>
                                                             frame<span class="token operator">-&gt;</span>pts<span class="token punctuation">,</span>
                                                             frame<span class="token operator">-&gt;</span>pkt_dts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">//不怎么了解音频，以后再说 TODO</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>avci<span class="token operator">-&gt;</span>showed_multi_packet_warning <span class="token operator">&amp;&amp;</span>
        ret <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ret <span class="token operator">!=</span> pkt<span class="token operator">-&gt;</span>size <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>capabilities <span class="token operator">&amp;</span> AV_CODEC_CAP_SUBFRAMES<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">//不怎么了解音频，以后再说 TODO</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>got_frame<span class="token punctuation">)</span>
        <span class="token function">av_frame_unref</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> avctx<span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_CODEC_FLAG_TRUNCATED<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
  <span class="token comment">//设置正数返回值</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">FF_API_AVCTX_TIMEBASE</span></span>
  <span class="token comment">/*
	  计算并设置解码器上下文的时间基准。时间基准是一个非常重要的概念，它定义了视频帧的时间戳如何映射到实际时间。在 FFmpeg 中，时间戳是以时间基准为单位来表示的，时间基准的值取决于视频帧的帧率和时间轴的精度
  */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>framerate<span class="token punctuation">.</span>num <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> avctx<span class="token operator">-&gt;</span>framerate<span class="token punctuation">.</span>den <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      
        avctx<span class="token operator">-&gt;</span>time_base <span class="token operator">=</span> <span class="token function">av_inv_q</span><span class="token punctuation">(</span><span class="token function">av_mul_q</span><span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>framerate<span class="token punctuation">,</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>avctx<span class="token operator">-&gt;</span>ticks_per_frame<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*先计算每帧的时长，即 avctx-&gt;framerate / avctx-&gt;ticks_per_frame，然后将这个时长的倒数作为时间基准，即 av_inv_q()
  最后将时间基准设置为解码器上下文的 time_base。这样做的目的是保证时间基准是最小的整数倍，从而避免计算时间戳时出现精度误差。
  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/* do not stop draining when actual_got_frame != 0 or ret &lt; 0 */</span>
    <span class="token comment">/* got_frame == 0 but actual_got_frame != 0 when frame is discarded */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>internal<span class="token operator">-&gt;</span>draining <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>actual_got_frame<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          
            <span class="token comment">/* 如果解码器错误地总是在排出时返回错误，则防止无限循环 */</span>
          
            <span class="token comment">/* reasonable nb_errors_max = maximum b frames + thread count */</span>
            <span class="token keyword">int</span> nb_errors_max <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">+</span> <span class="token punctuation">(</span>HAVE_THREADS <span class="token operator">&amp;&amp;</span> avctx<span class="token operator">-&gt;</span>active_thread_type <span class="token operator">&amp;</span> FF_THREAD_FRAME <span class="token operator">?</span>
                                avctx<span class="token operator">-&gt;</span>thread_count <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>avci<span class="token operator">-&gt;</span>nb_draining_errors<span class="token operator">++</span> <span class="token operator">&gt;=</span> nb_errors_max<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">av_log</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> AV_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"Too many errors when draining, this is a bug. "</span>
                       <span class="token string">"Stop draining and force EOF.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                avci<span class="token operator">-&gt;</span>draining_done <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> AVERROR_BUG<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            avci<span class="token operator">-&gt;</span>draining_done <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    avci<span class="token operator">-&gt;</span>compat_decode_consumed <span class="token operator">+=</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> pkt<span class="token operator">-&gt;</span>size <span class="token operator">||</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//释放用户态传进来的AVCodecContext内的AVPackt数据，表示已经完成对该数据包解码。</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> consumed <span class="token operator">=</span> ret<span class="token punctuation">;</span>

        pkt<span class="token operator">-&gt;</span>data                <span class="token operator">+=</span> consumed<span class="token punctuation">;</span>
        pkt<span class="token operator">-&gt;</span>size                <span class="token operator">-=</span> consumed<span class="token punctuation">;</span>
        avci<span class="token operator">-&gt;</span>last_pkt_props<span class="token operator">-&gt;</span>size <span class="token operator">-=</span> consumed<span class="token punctuation">;</span> <span class="token comment">// See extract_packet_props() comment.</span>
        pkt<span class="token operator">-&gt;</span>pts                  <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
        pkt<span class="token operator">-&gt;</span>dts                  <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
        avci<span class="token operator">-&gt;</span>last_pkt_props<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
        avci<span class="token operator">-&gt;</span>last_pkt_props<span class="token operator">-&gt;</span>dts <span class="token operator">=</span> AV_NOPTS_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>got_frame<span class="token punctuation">)</span>
        <span class="token function">av_assert0</span><span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
  1.frame就是上面进入到avctx-&gt;codec-&gt;decode函数的"void *data"解码后的数据会放入在AVFrame-&gt;buf内  
  2. 再次断言确认解码完后的原始数据已经存放在用户态的AVFrame-&gt;buf内
  */</span>
    <span class="token keyword">return</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> ret <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//635</span>
</code></pre> 
<h4><a id="h264_decode_frameAPI_3118"></a>h264_decode_frame分析（不在显示调用API中）</h4> 
<blockquote> 
 <p>h264_decode_frame函数是 H.264 视频编码标准的解码函数，用于将 H.264 码流解码为视频帧</p> 
</blockquote> 
<p><code>libavcodec/h264dec.c+963</code>函数定义：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">h264_decode_frame</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>got_frame<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>avpkt<span class="token punctuation">)</span>
<span class="token comment">/*
avctx：参数为用户态调用avcodec_send_packet(video_codec_ctx, &amp;pkt)传进的video_codec_ctx参数。存储了当前 H.264 解码器的参数信息；

data：参数为用户态的video_codec_ctx-&gt;internal-&gt;buffer_frame。解码后的视频帧数据将会存储在这里；

got_frame：是否成功解码出一帧数据的标志

avpkt：参数为用户态调用avcodec_send_packet(video_codec_ctx, &amp;pkt)传进的pkt参数。存储了需要解码的 H.264 码流数据。
*/</span>
</code></pre> 
<ul><li>设置局部变量，为了方便理解下面使用的参数这里贴出来</li></ul> 
<pre><code class="prism language-c">    <span class="token number">964</span>	     <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf <span class="token operator">=</span> avpkt<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
						<span class="token comment">//待解码数据</span>
    <span class="token number">965</span>	     <span class="token keyword">int</span> buf_size       <span class="token operator">=</span> avpkt<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span>
						<span class="token comment">//待解码数据的大小</span>
    <span class="token number">966</span>	     H264Context <span class="token operator">*</span>h     <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">;</span>
						<span class="token comment">//获取AVCodecContext下的priv_data作为H264上下文对象</span>
    <span class="token number">967</span>	     AVFrame <span class="token operator">*</span>pict      <span class="token operator">=</span> data<span class="token punctuation">;</span>
						<span class="token comment">//待存放解码后的数据也就是一张图片，这里名为picture缩写</span>

						<span class="token comment">/*初始化H264上下文对象*/</span>
 →  <span class="token number">971</span>	     h<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> avctx<span class="token operator">-&gt;</span>flags<span class="token punctuation">;</span>
    <span class="token number">972</span>	     h<span class="token operator">-&gt;</span>setup_finished <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token number">973</span>	     h<span class="token operator">-&gt;</span>nb_slice_ctx_queued <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>释放 <code>H264Picture</code> 结构体中的资源，并进行特殊处理，以确保解码器正常运行。</li></ul> 
<blockquote> 
 <p>特殊处理: 在释放 <code>last_pic_for_ec</code> 时，会将其设置为空指针。<code>last_pic_for_ec</code> 字段是 H.264 解码器中用于存储解码出的最后一帧的 <code>H264Picture</code> 结构体。</p> 
</blockquote> 
<pre><code> ff_h264_unref_picture(h, &amp;h-&gt;last_pic_for_ec);
</code></pre> 
<ul><li>检查待解码数据包是否为h264,再判断是否存在额外的数据</li></ul> 
<pre><code class="prism language-c"> → <span class="token number">989</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>h<span class="token operator">-&gt;</span>is_avc <span class="token operator">&amp;&amp;</span> buf_size <span class="token operator">&gt;=</span> <span class="token number">9</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0xFC</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0xFC</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
   <span class="token number">990</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_extra</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buf_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token number">991</span>             <span class="token keyword">return</span> <span class="token function">ff_h264_decode_extradata</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buf_size<span class="token punctuation">,</span><span class="token operator">&amp;</span>h<span class="token operator">-&gt;</span>ps<span class="token punctuation">,</span><span class="token operator">&amp;</span>h<span class="token operator">-&gt;</span>is_avc<span class="token punctuation">,</span><span class="token operator">&amp;</span>h<span class="token operator">-&gt;</span>nal_length_size<span class="token punctuation">,</span>avctx<span class="token operator">-&gt;</span>err_recognition<span class="token punctuation">,</span> avctx<span class="token punctuation">)</span><span class="token punctuation">;</span>                                            <span class="token number">994</span>     <span class="token punctuation">}</span>
   <span class="token comment">/* 
   - AVC 格式的数据流的起始部分为一个 9 字节的特定标志。
   - 该行代码检查数据包的前 9 个字节中的特定位是否满足 AVC 格式的要求，包括:
	   1. 第 1 个字节必须为 0x01
	   2. 第 3 个字节必须为 0x00
	   3. 第 5 个字节的高 6 位必须为 0xFC
   */</span>
</code></pre> 
<ul><li>解码 NALU (Network Abstraction Layer Unit) 数据</li></ul> 
<blockquote> 
 <p>这个属于264的解码概念知识有很多需要讲，可以看我的另一篇笔记：传送门👉<a href="TODO" rel="nofollow">wwww.TODO</a></p> 
</blockquote> 
<pre><code class="prism language-c">  <span class="token number">996</span>   buf_index <span class="token operator">=</span> <span class="token function">decode_nal_units</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buf_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//解码器首先将输入的 buf 缓冲区中的数据按照 NALU 格式进行解码，解码出的结果存储在 h-&gt;nal_unit_type 和 h-&gt;nal_ref_idc 两个变量中，同时返回 NALU 数据在缓冲区中的位置。里面有很多h264\h265共用的函数体，名为xxxh2645xxx之类的都是可以共用的（FFmpeg中管h264叫h264而不是avc 、h265叫hevc而不是h265）</span>

  <span class="token number">600</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">decode_nal_units</span><span class="token punctuation">(</span>H264Context <span class="token operator">*</span>h<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buf_size<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//..</span>
     <span class="token keyword">switch</span> <span class="token punctuation">(</span>nal<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">case</span> H264_NAL_SLICE：
            <span class="token comment">//非 IDR 帧的 slice，也包含了完整的编码数据。</span>
          <span class="token keyword">case</span> H264_NAL_DPA、H264_NAL_DPB、H264_NAL_DPC：
            <span class="token comment">//用于多切片编码，分别表示当前的前一个、后一个和后两个 slice 的数据。</span>
          <span class="token keyword">case</span> H264_NAL_SEI：
            <span class="token comment">//包含了一些辅助信息，如时间戳等。</span>
          <span class="token keyword">case</span> H264_NAL_PPS、H264_NAL_SPS_EXT：
            <span class="token comment">//包含了图像参数集和序列参数集的数据。</span>
          <span class="token keyword">case</span> H264_NAL_AUD：
            <span class="token comment">//用于视频解码的同步，表示一个新的图像开始了。</span>
          <span class="token keyword">case</span> H264_NAL_END_SEQUENCE、H264_NAL_END_STREAM、H264_NAL_FILLER_DATA：
            <span class="token comment">//用于结束一个视频序列或流。</span>
          <span class="token keyword">case</span> H264_NAL_AUXILIARY_SLICE：
            <span class="token comment">//表示一个辅助的 slice，包含了一些额外的数据。</span>
       <span class="token punctuation">}</span>
    <span class="token comment">//..</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="6avcodec_receive_frame_3210"></a>6.avcodec_receive_frame分析</h4> 
<p><code>libavcodec/decode.c+741</code>函数定义：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> attribute_align_arg <span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>avctx<span class="token punctuation">,</span> AVFrame <span class="token operator">*</span>frame<span class="token punctuation">)</span>
  <span class="token comment">/*
  	avctx : 用来进行编、解码操作的AVCodecContext结构体
  	frmae : 一块空内存，前面调用av_frame_alloc()函数得到的AVFrame大小（`p sizeof(*frame) = 0x218`）的堆块
  */</span>
</code></pre> 
<ul><li>清除用户态的AVFrame结构体，即接收解码数据的内存块，以便于接收新的数据。</li></ul> 
<pre><code class="prism language-c"> →  <span class="token number">745</span>	     <span class="token function">av_frame_unref</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>将AVCodecContext-&gt;AVCodecInternal内部编码器存储的的解码数据取出</li></ul> 
<pre><code class="prism language-c">    <span class="token number">750</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>avci<span class="token operator">-&gt;</span>buffer_frame<span class="token operator">-&gt;</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 →  <span class="token number">751</span>	         <span class="token function">av_frame_move_ref</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> avci<span class="token operator">-&gt;</span>buffer_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/*
      这个函数会将AVCodecInternal的AVFrame指针到用户态的AVFrame指针，并且清空AVCodecInternal的AVFrame内存，不是释放因为这样就可以在下一帧解码时避免再次消耗性能申请大块内存，最后设置默认值
					函数定义如下：
        //libavutil/frame.c+587
            582	 void av_frame_move_ref(AVFrame *dst, AVFrame *src)
            583	 {
            584	     av_assert1(dst-&gt;width == 0 &amp;&amp; dst-&gt;height == 0);
            585	     av_assert1(dst-&gt;channels == 0);
            586
         →  587	     *dst = *src;
            588	     if (src-&gt;extended_data == src-&gt;data)
            589	         dst-&gt;extended_data = dst-&gt;data;
            590	     memset(src, 0, sizeof(*src));
            591	     get_frame_defaults(src);
            592	 }      
      
      */</span>
    <span class="token number">752</span>	     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">753</span>	         ret <span class="token operator">=</span> <span class="token function">decode_receive_frame_internal</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">754</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token number">755</span>	             <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token number">756</span>	     <span class="token punctuation">}</span>
</code></pre> 
<ul><li>通过裁剪帧来正确设置解码后帧的大小</li></ul> 
<blockquote> 
 <p>因为原始数据（比如YUV）打开的时候必须要指定正确的帧大小以及帧存储格式来识别数据的。使每一帧的大小一致是非常有必要的</p> 
</blockquote> 
<pre><code class="prism language-c">    <span class="token number">758</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">759</span>	         ret <span class="token operator">=</span> <span class="token function">apply_cropping</span><span class="token punctuation">(</span>avctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/*
      在某些情况下，编码器可能会编码比实际显示分辨率更大的帧，而此函数可以将帧的图像大小裁剪为正确的大小。

			该函数的主要作用是根据AVCodecContext中的crop_left、crop_right、crop_top和crop_bottom字段来裁剪帧。apply_cropping函数会更新帧的width、height、linesize和data字段，以反映裁剪后的图像大小。
      */</span>
                 <span class="token comment">// ret=0x0</span>
 →  <span class="token number">760</span>	         <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">761</span>	             <span class="token function">av_frame_unref</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">762</span>	             <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token number">763</span>	         <span class="token punctuation">}</span>
    <span class="token number">764</span>	     <span class="token punctuation">}</span>
</code></pre> 
<ul><li>记录取出帧数</li></ul> 
<pre><code class="prism language-c"> →  <span class="token number">766</span>	     avctx<span class="token operator">-&gt;</span>frame_number<span class="token operator">++</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>判断发生了变化的帧(这里我没进入分支不好分析)</li></ul> 
<pre><code class="prism language-c">    <span class="token keyword">if</span> <span class="token punctuation">(</span>avctx<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AV_CODEC_FLAG_DROPCHANGED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">//...</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="7av_frame_unref_3293"></a>7.av_frame_unref分析</h4> 
<p><code>libavutil/frame.c+554</code>函数定义：</p> 
<pre><code class="prism language-c"><span class="token comment">/*
	在使用AVFrame进行解码或编码时，AVFrame中会存储各种数据（如像素数据、音频数据等），当不需要这些数据时，需要使用av_frame_unref()函数将其清空重置，该函数不会销毁AVFrame本身，只会释放与其关联的数据。，以便再次利用该AVFrame。
*/</span>
    <span class="token number">553</span>	 <span class="token keyword">void</span> <span class="token function">av_frame_unref</span><span class="token punctuation">(</span>AVFrame <span class="token operator">*</span>frame<span class="token punctuation">)</span>
 →  <span class="token number">554</span>	 <span class="token punctuation">{<!-- --></span>
    <span class="token number">555</span>	     <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token number">556</span>
    <span class="token number">557</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token punctuation">)</span>
    <span class="token number">558</span>	         <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token number">559</span>
 →  <span class="token number">560</span>	     <span class="token function">wipe_side_data</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">561</span>
    <span class="token number">562</span>	     <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">FF_ARRAY_ELEMS</span><span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token number">563</span>	         <span class="token function">av_buffer_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">564</span>	     <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> frame<span class="token operator">-&gt;</span>nb_extended_buf<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token number">565</span>	         <span class="token function">av_buffer_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>extended_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">566</span>     <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>extended_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">567</span>     <span class="token function">av_dict_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">568</span> #<span class="token keyword">if</span> FF_API_FRAME_QP
    <span class="token number">569</span> FF_DISABLE_DEPRECATION_WARNINGS
    <span class="token number">570</span>     <span class="token function">av_buffer_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>qp_table_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">571</span> FF_ENABLE_DEPRECATION_WARNINGS
    <span class="token number">572</span> #endif
    <span class="token number">573</span>
    <span class="token number">574</span>	     <span class="token function">av_buffer_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>hw_frames_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">575</span>
    <span class="token number">576</span>	     <span class="token function">av_buffer_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>opaque_ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">577</span>	     <span class="token function">av_buffer_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>private_ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">578</span>
 →  <span class="token number">579</span>	     <span class="token function">get_frame_defaults</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">580</span>	 <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="8av_frame_free_3333"></a>8.av_frame_free分析</h4> 
<p><code>libavutil/frame.c+208</code>函数定义：</p> 
<pre><code class="prism language-c">    <span class="token number">202</span>	 <span class="token keyword">void</span> <span class="token function">av_frame_free</span><span class="token punctuation">(</span>AVFrame <span class="token operator">*</span><span class="token operator">*</span>frame<span class="token punctuation">)</span>
    <span class="token number">203</span>	 <span class="token punctuation">{<!-- --></span>
 →  <span class="token number">204</span>	     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">*</span>frame<span class="token punctuation">)</span>
    <span class="token number">205</span>	         <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token number">206</span>
    <span class="token number">207</span>	     <span class="token function">av_frame_unref</span><span class="token punctuation">(</span><span class="token operator">*</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清空一个AVFrame数据</span>
    <span class="token number">208</span>	     <span class="token function">av_freep</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放内存</span>
    <span class="token number">209</span>	 <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="9_3350"></a>9.最后将原始数据写入到文件</h4> 
<p>首先来看看通过avcodec_receive_frame函数接收后的video_frame结构体数据(重要数据)：</p> 
<pre><code class="prism language-c">type <span class="token operator">=</span> <span class="token keyword">struct</span> <span class="token class-name">AVFrame</span> <span class="token punctuation">{<!-- --></span>
	data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">206</span>\<span class="token number">206</span>\<span class="token number">20.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">206</span>\<span class="token number">206</span>\<span class="token number">20.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">206</span>\<span class="token number">206</span>\<span class="token number">20.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//data[0\1\2] 的数据为内存数据，这里数据过多无法展示</span>
  <span class="token comment">//这里的data[0\1\2] 就是指向着结构体成员 buf[0\1\2]-&gt;data</span>
  linesize <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x5a0</span><span class="token punctuation">,</span> <span class="token number">0x2d0</span><span class="token punctuation">,</span> <span class="token number">0x2d0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token comment">/*
  linesize[0] = 0x5a0 表示Y分量每一行所占用的字节数，换算为十进制是1440。
  linesize[1] = 0x2d0 表示U分量每一行所占用的字节数，换算为十进制是720。
  linesize[2] = 0x2d0 表示V分量每一行所占用的字节数，换算为十进制是720。
  */</span>
  extended_data <span class="token operator">=</span> <span class="token number">0x1ad5f90</span><span class="token punctuation">,</span>
  width <span class="token operator">=</span> <span class="token number">0x5a0</span><span class="token punctuation">,</span>
  height <span class="token operator">=</span> <span class="token number">0x780</span><span class="token punctuation">,</span>
  nb_samples <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">,</span>
  format <span class="token operator">=</span> <span class="token number">0xc</span><span class="token punctuation">,</span> <span class="token comment">//颜色空间格式；这里0xc为420p格式。常见的420格式是 AV_PIX_FMT_YUV420P，420格式（有时也称为YUV420）是将一幅完整的图像按照一定规则分成若干个亮度（Y）和色度（U、V）分量。例如，如果 format 的值为 AV_PIX_FMT_YUV444P，则表示图像使用 444 格式。</span>
  key_frame <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token comment">//表示关键帧</span>
  pict_type <span class="token operator">=</span> AV_PICTURE_TYPE_I<span class="token punctuation">,</span> <span class="token comment">//I帧 一个完整的视频中第一帧都是I帧</span>
  buf <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x1ad8420</span><span class="token punctuation">,</span> <span class="token number">0x1ad8440</span><span class="token punctuation">,</span> <span class="token number">0x1ad8460</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  color_range <span class="token operator">=</span> AVCOL_RANGE_JPEG<span class="token punctuation">,</span> <span class="token comment">//色彩范围。用于指定像素值的范围，比如：AVCOL_RANGE_MPEG（MPEG 色彩范围）和 AVCOL_RANGE_JPEG（JPEG 色彩范围）</span>
  color_primaries <span class="token operator">=</span> AVCOL_PRI_SMPTE432<span class="token punctuation">,</span><span class="token comment">//原色信息。用于指定视频帧的原色信息，取值包括 AVCOL_PRI_BT709（BT.709）、AVCOL_PRI_BT2020（BT.2020）、AVCOL_PRI_SMPTE431（SMPTE 431）、AVCOL_PRI_SMPTE432（SMPTE 432）。</span>
  color_trc <span class="token operator">=</span> AVCOL_TRC_BT709<span class="token punctuation">,</span> <span class="token comment">//色彩传输特性。用于指定视频帧的色彩传输特性，取值包括 AVCOL_TRC_BT709（BT.709）、AVCOL_TRC_SMPTEST2084（SMPTE ST 2084）</span>
  colorspace <span class="token operator">=</span> AVCOL_SPC_SMPTE170M<span class="token punctuation">,</span> <span class="token comment">//颜色空间。用于指定视频帧的颜色空间，取值包括 AVCOL_SPC_RGB（RGB）、AVCOL_SPC_BT709（BT.709）、AVCOL_SPC_SMPTE170M（SMPTE 170M）</span>
  chroma_location <span class="token operator">=</span> AVCHROMA_LOC_LEFT<span class="token punctuation">,</span> <span class="token comment">//色度定位信息，用于指定视频帧的色度定位信息，取值包括 AVCHROMA_LOC_UNSPECIFIED（未指定）、AVCHROMA_LOC_LEFT（左对齐）、AVCHROMA_LOC_CENTER（居中对齐）</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>将帧数据写入本地文件(按照YUV420P格式写入，也是ffmpeg默认输出的颜色空间格式)</li></ul> 
<pre><code class="prism language-c"><span class="token comment">// video_frame-&gt;data[0]为原始YUV数据中的Y，linesize[0]表示一行Y分量有多少个字节，乘上解码后帧的高度即表示该帧的所有Y分量</span>
<span class="token function">fwrite</span><span class="token punctuation">(</span>video_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
       video_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> video_codec_ctx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> 			          outputVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// video_frame-&gt;data[1]为原始YUV数据中的U，linesize[1]表示一行U分量有多少个字节，乘上解码后帧的高度 除2 即表示该帧的所有U分量</span>
<span class="token function">fwrite</span><span class="token punctuation">(</span>video_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
       video_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> video_codec_ctx<span class="token operator">-&gt;</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
       outputVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// video_frame-&gt;data[2]为原始YUV数据中的V，linesize[2]表示一行V分量有多少个字节，乘上解码后帧的高度 除2 即表示该帧的所有V分量</span>
<span class="token function">fwrite</span><span class="token punctuation">(</span>video_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
       video_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> video_codec_ctx<span class="token operator">-&gt;</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
       outputVideo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="APIYUV_3399"></a>调用API-编码YUV文件</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/imgutils.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/opt.h&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INPUT_FILE</span> <span class="token string">"input.yuv"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OUTPUT_FILE</span> <span class="token string">"output.h264"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WIDTH</span> <span class="token expression"><span class="token number">1440</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HEIGHT</span> <span class="token expression"><span class="token number">1920</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FRAME_RATE</span> <span class="token expression"><span class="token number">25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BIT_RATE</span> <span class="token expression"><span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1000</span></span></span>

<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  FILE <span class="token operator">*</span>inputFile <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>INPUT_FILE<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inputFile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not open input file"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 1. Find encoder</span>
  AVCodec <span class="token operator">*</span>codec <span class="token operator">=</span> <span class="token function">avcodec_find_encoder</span><span class="token punctuation">(</span>AV_CODEC_ID_H264<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Codec not found"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. Create encoder context</span>
  AVCodecContext <span class="token operator">*</span>codecCtx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>codec<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>codecCtx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not allocate video codec context"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3. Configure encoder parameters</span>
  codecCtx<span class="token operator">-&gt;</span>bit_rate <span class="token operator">=</span> BIT_RATE<span class="token punctuation">;</span>
  codecCtx<span class="token operator">-&gt;</span>width <span class="token operator">=</span> WIDTH<span class="token punctuation">;</span>
  codecCtx<span class="token operator">-&gt;</span>height <span class="token operator">=</span> HEIGHT<span class="token punctuation">;</span>
  codecCtx<span class="token operator">-&gt;</span>time_base <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> FRAME_RATE<span class="token punctuation">}</span><span class="token punctuation">;</span>
  codecCtx<span class="token operator">-&gt;</span>framerate <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>FRAME_RATE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  codecCtx<span class="token operator">-&gt;</span>gop_size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  codecCtx<span class="token operator">-&gt;</span>max_b_frames <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  codecCtx<span class="token operator">-&gt;</span>pix_fmt <span class="token operator">=</span> AV_PIX_FMT_YUV420P<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>codec<span class="token operator">-&gt;</span>id <span class="token operator">==</span> AV_CODEC_ID_H264<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">av_opt_set</span><span class="token punctuation">(</span>codecCtx<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">,</span> <span class="token string">"preset"</span><span class="token punctuation">,</span> <span class="token string">"slow"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 4. Open target encoder</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>codecCtx<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not open codec"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 5. Create frame and Image Buffer Zone</span>
  AVFrame <span class="token operator">*</span>frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>frame<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not allocate video frame"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  frame<span class="token operator">-&gt;</span>width <span class="token operator">=</span> WIDTH<span class="token punctuation">;</span>
  frame<span class="token operator">-&gt;</span>height <span class="token operator">=</span> HEIGHT<span class="token punctuation">;</span>
  frame<span class="token operator">-&gt;</span>format <span class="token operator">=</span> AV_PIX_FMT_YUV420P<span class="token punctuation">;</span>

  <span class="token comment">// 6. Create output file</span>
  AVFormatContext <span class="token operator">*</span>fmtCtx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avformat_alloc_output_context2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmtCtx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> OUTPUT_FILE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not create output context"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 7. Create output stream</span>
  AVStream <span class="token operator">*</span>videoStream <span class="token operator">=</span> <span class="token function">avformat_new_stream</span><span class="token punctuation">(</span>fmtCtx<span class="token punctuation">,</span> codec<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// AVStream *videoStream = avformat_new_stream(fmtCtx, NULL);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>videoStream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to allocate stream"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 8. Set output stream parameters</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avcodec_parameters_from_context</span><span class="token punctuation">(</span>videoStream<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">,</span> codecCtx<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to copy codec parameters to stream."</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 9. Open output file</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avio_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmtCtx<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> OUTPUT_FILE<span class="token punctuation">,</span> AVIO_FLAG_WRITE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not open output file"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\033[32mWriting to file heard ...\033[0m"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">avformat_write_header</span><span class="token punctuation">(</span>fmtCtx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error occurred when opening output file"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 11. Encoding each frame</span>
  <span class="token keyword">int</span> y_size <span class="token operator">=</span> codecCtx<span class="token operator">-&gt;</span>width <span class="token operator">*</span> codecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
  <span class="token keyword">uint8_t</span> <span class="token operator">*</span>inData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>y_size <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  AVPacket pkt<span class="token punctuation">;</span>
  <span class="token function">av_init_packet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

  <span class="token keyword">int</span> frameCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Read a frame of YUV image data from the input file</span>
    ret <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>inData<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> y_size <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> inputFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> y_size <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">av_image_fill_arrays</span><span class="token punctuation">(</span>frame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">,</span> inData<span class="token punctuation">,</span>
                         codecCtx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span> codecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> codecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>
                         <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set frame time-stamp</span>
    frame<span class="token operator">-&gt;</span>pts <span class="token operator">=</span>
        frameCnt <span class="token operator">*</span> videoStream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den <span class="token operator">/</span> videoStream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">;</span>

    <span class="token comment">// Encode frame</span>
    ret <span class="token operator">=</span> <span class="token function">avcodec_send_frame</span><span class="token punctuation">(</span>codecCtx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error sending a frame for encoding"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ret <span class="token operator">=</span> <span class="token function">avcodec_receive_packet</span><span class="token punctuation">(</span>codecCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error during encoding"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Write pack into the output file</span>
      pkt<span class="token punctuation">.</span>stream_index <span class="token operator">=</span> videoStream<span class="token operator">-&gt;</span>index<span class="token punctuation">;</span>
      <span class="token function">av_packet_rescale_ts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">,</span> codecCtx<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> videoStream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">av_interleaved_write_frame</span><span class="token punctuation">(</span>fmtCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error writing packet to file."</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    frameCnt<span class="token operator">++</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encoding total frame : "</span>  <span class="token operator">&lt;&lt;</span> frameCnt <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encoding the remaining frame ..."</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  ret <span class="token operator">=</span> <span class="token function">avcodec_send_frame</span><span class="token punctuation">(</span>codecCtx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error sending a frame for encoding"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    ret <span class="token operator">=</span> <span class="token function">avcodec_receive_packet</span><span class="token punctuation">(</span>codecCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error during encoding"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Write pack into the output file</span>
    pkt<span class="token punctuation">.</span>stream_index <span class="token operator">=</span> videoStream<span class="token operator">-&gt;</span>index<span class="token punctuation">;</span>
    <span class="token function">av_packet_rescale_ts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">,</span> codecCtx<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> videoStream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_interleaved_write_frame</span><span class="token punctuation">(</span>fmtCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\033[32mWriting to file tail ...\033[0m"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
  <span class="token function">av_write_trailer</span><span class="token punctuation">(</span>fmtCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Close resources</span>
  <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>codecCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">avformat_free_context</span><span class="token punctuation">(</span>fmtCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">avio_closep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmtCtx<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>inData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>TODO</p> 
<h3><a id="ffmpeg_3621"></a>ffmpeg对内存的释放处理</h3> 
<pre><code class="prism language-c"><span class="token comment">//libavutil/mem.c+231</span>
		<span class="token number">227</span>	 <span class="token keyword">void</span> <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
    <span class="token number">228</span>	 <span class="token punctuation">{<!-- --></span>
    <span class="token number">229</span>	     <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>
    <span class="token number">230</span>
 →  <span class="token number">231</span>	     <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>val<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      			 <span class="token comment">//sizeof(val) == 8  ,复制指针</span>
    <span class="token number">232</span>	     <span class="token function">memcpy</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token constant">NULL</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">233</span>	     <span class="token function">av_free</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">234</span>	 <span class="token punctuation">}</span>


    <span class="token number">218</span>	 <span class="token keyword">void</span> <span class="token function">av_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
    <span class="token number">219</span>	 <span class="token punctuation">{<!-- --></span>
    <span class="token number">220</span>	 #<span class="token keyword">if</span> HAVE_ALIGNED_MALLOC
    <span class="token number">221</span>	     <span class="token function">_aligned_free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">222</span>	 #<span class="token keyword">else</span>
 →  <span class="token number">223</span>	     <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">224</span>	 #endif
    <span class="token number">225</span>	 <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_3648"></a>添加滤镜</h2> 
<p><strong>一键添加滤镜的脚本，在ffmpeg根目录执行</strong>(linux可用，手动打开注释)</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function-name function">add_filter_demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token builtin class-name">echo</span> <span class="token string">"I2luY2x1ZGUgImxpYmF2dXRpbC9pbnRlcm5hbC5oIgojaW5jbHVkZSAibGliYXZ1dGlsL29wdC5oIgojaW5jbHVkZSAibGliYXZ1dGlsL3BpeGRlc2MuaCIKI2luY2x1ZGUgImF2ZmlsdGVyLmgiCiNpbmNsdWRlICJpbnRlcm5hbC5oIgojaW5jbHVkZSAidmlkZW8uaCIKIAp0eXBlZGVmIHN0cnVjdCBGbGlwQ29udGV4dCB7Cgljb25zdCBBVkNsYXNzICpjbGFzczsKCWludCB2c3ViOwogCn0gRmxpcENvbnRleHQ7CiAKc3RhdGljIGNvbnN0IEFWT3B0aW9uIHZsZmxpcF9vcHRpb25zW10gPSB7Cgl7IE5VTEwgfQp9OwogCkFWRklMVEVSX0RFRklORV9DTEFTUyh2bGZsaXApOwogCnN0YXRpYyBpbnQgY29uZmlnX2lucHV0KEFWRmlsdGVyTGluayAqbGluaykKewoJRmxpcENvbnRleHQgKmZsaXAgPSBsaW5rLT5kc3QtPnByaXY7Cgljb25zdCBBVlBpeEZtdERlc2NyaXB0b3IgKmRlc2MgPSBhdl9waXhfZm10X2Rlc2NfZ2V0KGxpbmstPmZvcm1hdCk7CiAKCWZsaXAtPnZzdWIgPSBkZXNjLT5sb2cyX2Nocm9tYV9oOwogCglyZXR1cm4gMDsKfQogCnN0YXRpYyBBVkZyYW1lICpnZXRfdmlkZW9fYnVmZmVyKEFWRmlsdGVyTGluayAqbGluaywgaW50IHcsIGludCBoKQp7CglGbGlwQ29udGV4dCAqZmxpcCA9IGxpbmstPmRzdC0+cHJpdjsKCUFWRnJhbWUgKmZyYW1lOwoJaW50IGk7CiAKCWZyYW1lID0gZmZfZ2V0X3ZpZGVvX2J1ZmZlcihsaW5rLT5kc3QtPm91dHB1dHNbMF0sIHcsIGgpOwoJaWYgKCFmcmFtZSkKCQlyZXR1cm4gTlVMTDsKIAoJZm9yIChpID0gMDsgaSA8IDQ7IGkrKykKCXsKCQlpbnQgdnN1YiA9IGkgPT0gMSB8fCBpID09IDIgPyBmbGlwLT52c3ViIDogMDsKCQlpbnQgaGVpZ2h0ID0gQVZfQ0VJTF9SU0hJRlQoaCwgdnN1Yik7CiAKCQlpZiAoZnJhbWUtPmRhdGFbaV0pCgkJewoJCQlmcmFtZS0+ZGF0YVtpXSArPSAoaGVpZ2h0IC0gMSkgKiBmcmFtZS0+bGluZXNpemVbaV07CgkJCWZyYW1lLT5saW5lc2l6ZVtpXSA9IC1mcmFtZS0+bGluZXNpemVbaV07CgkJfQoJfQogCglyZXR1cm4gZnJhbWU7Cn0KIApzdGF0aWMgaW50IGZpbHRlcl9mcmFtZShBVkZpbHRlckxpbmsgKmxpbmssIEFWRnJhbWUgKmZyYW1lKQp7CglGbGlwQ29udGV4dCAqZmxpcCA9IGxpbmstPmRzdC0+cHJpdjsKCWludCBpOwogCglmb3IgKGkgPSAwOyBpIDwgNDsgaSsrKQoJewoJCWludCB2c3ViID0gaSA9PSAxIHx8IGkgPT0gMiA/IGZsaXAtPnZzdWIgOiAwOwoJCWludCBoZWlnaHQgPSBBVl9DRUlMX1JTSElGVChsaW5rLT5oLCB2c3ViKTsKIAoJCWlmIChmcmFtZS0+ZGF0YVtpXSkKCQl7CgkJCWZyYW1lLT5kYXRhW2ldICs9IChoZWlnaHQgLSAxKSAqIGZyYW1lLT5saW5lc2l6ZVtpXTsKCQkJZnJhbWUtPmxpbmVzaXplW2ldID0gLWZyYW1lLT5saW5lc2l6ZVtpXTsKCQl9Cgl9CiAKCXJldHVybiBmZl9maWx0ZXJfZnJhbWUobGluay0+ZHN0LT5vdXRwdXRzWzBdLCBmcmFtZSk7Cn0KIApzdGF0aWMgY29uc3QgQVZGaWx0ZXJQYWQgYXZmaWx0ZXJfdmZfdmxmbGlwX2lucHV0c1tdID0gewoJewoJCS5uYW1lID0gImRlZmF1bHQiLAoJCS50eXBlID0gQVZNRURJQV9UWVBFX1ZJREVPLAoJCS5nZXRfdmlkZW9fYnVmZmVyID0gZ2V0X3ZpZGVvX2J1ZmZlciwKCQkuZmlsdGVyX2ZyYW1lID0gZmlsdGVyX2ZyYW1lLAoJCS5jb25maWdfcHJvcHMgPSBjb25maWdfaW5wdXQsCgl9LAoJeyBOVUxMIH0KfTsKIApzdGF0aWMgY29uc3QgQVZGaWx0ZXJQYWQgYXZmaWx0ZXJfdmZfdmxmbGlwX291dHB1dHNbXSA9IHsKCXsKCQkubmFtZSA9ICJkZWZhdWx0IiwKCQkudHlwZSA9IEFWTUVESUFfVFlQRV9WSURFTywKCX0sCgl7IE5VTEwgfQp9OwpBVkZpbHRlciBmZl92Zl92bGZsaXAgPSB7CgkubmFtZSA9ICJ2bGZsaXAiLAoJLmRlc2NyaXB0aW9uID0gTlVMTF9JRl9DT05GSUdfU01BTEwoImxpcGVpcmFuOnZlcnNpb246LT5GbGlwIHRoZSBpbnB1dCB2aWRlbyB2ZXJ0aWNhbGx5LiIpLAoJLnByaXZfc2l6ZSA9IHNpemVvZihGbGlwQ29udGV4dCksCgkucHJpdl9jbGFzcyA9ICZ2bGZsaXBfY2xhc3MsCgkuaW5wdXRzID0gYXZmaWx0ZXJfdmZfdmxmbGlwX2lucHV0cywKCS5vdXRwdXRzID0gYXZmaWx0ZXJfdmZfdmxmbGlwX291dHB1dHMsCgkuZmxhZ3MgPSBBVkZJTFRFUl9GTEFHX1NVUFBPUlRfVElNRUxJTkVfR0VORVJJQywKfTsK"</span> <span class="token operator">|</span> base64 -d <span class="token operator">&gt;</span> libavfilter/vf_vlflip.c


<span class="token function">sed</span> -i <span class="token string">'/ff_vf_zscale/a\extern AVFilter ff_vf_vlflip;'</span> libavfilter/allfilters.c

<span class="token function">sed</span> -i <span class="token string">'/vf_zscale.o/a\OBJS-$(CONFIG_VLFLIP_FILTER)                 += vf_vlflip.o'</span> libavfilter/Makefile
<span class="token punctuation">}</span>

add_filter_demo //Linux no problem , Mac can't
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dc549a0f2fa71b9e8f3ce7829aa493e4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">iframe嵌入本地视频或者http链接视频禁止自动播放</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b409b56ce425b049ef131435022c644a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python:基于Python爬虫技术的抢票程序及其实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>