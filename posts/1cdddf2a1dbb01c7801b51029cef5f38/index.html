<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Skywalking 中 Agent 自动同步配置源码解析 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Skywalking 中 Agent 自动同步配置源码解析" />
<meta property="og:description" content="文章目录 前言正文实现架构实现模型OAP 同步 ApolloConfigWatcherRegisterConfigChangeWatcher Agent 侧 前言 本文代码 OAP 基于 v9.7，Java Agent 基于 v9.1，配置中心使用 apollo。
看本文需要配合代码“食用”。
正文 Skywalking 中就使用这种模型实现了 Agent 同步Apollo 配置，本文介绍下提供的功能以及代码实现，一起学习下。
Skywalking 支持 agent 动态更新配置，使 agent 可以依据业务需求进行自定义配置；更重要的是建立起这一个通信机制，那么 agent 的可管理性、扩展性都大大提升。
目前 Skywalking 提供了以下配置项
按照文档描述，主要为以下内容：
控制采样速率
忽略指定后缀的请求，注意必须是 first span 的 opretationName 匹配到
针对 web 服务，有些静态资源是放在服务端，那么可以过滤掉这些请求
忽略某些 path 的 trace
限定每个 segment 中的 span 最大数量
是否收集执行 sql 的参数
样例配置
configurations: serviceA: trace.sample_n_per_3_secs: 1000 trace.ignore_path: /a/b/c,/a1/b1/c1 serviceB: trace.sample_n_per_3_secs: 1000 trace.ignore_path: /a/b/c,/a1/b1/c1 注意：这个是按照服务来进行逐项配置，如果不需要变动，不要添加对应 key，会使用默认值。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/1cdddf2a1dbb01c7801b51029cef5f38/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-24T22:03:37+08:00" />
<meta property="article:modified_time" content="2023-12-24T22:03:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Skywalking 中 Agent 自动同步配置源码解析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_7" rel="nofollow">正文</a></li><li><ul><li><a href="#_46" rel="nofollow">实现架构</a></li><li><a href="#_54" rel="nofollow">实现模型</a></li><li><a href="#OAP__Apollo_62" rel="nofollow">OAP 同步 Apollo</a></li><li><ul><li><a href="#ConfigWatcherRegister_66" rel="nofollow">ConfigWatcherRegister</a></li><li><a href="#ConfigChangeWatcher_236" rel="nofollow">ConfigChangeWatcher</a></li></ul> 
    </li><li><a href="#Agent__379" rel="nofollow">Agent 侧</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>前言</h3> 
<p>本文代码 OAP 基于 v9.7，Java Agent 基于 v9.1，配置中心使用 apollo。</p> 
<p>看本文需要配合代码“食用”。</p> 
<h3><a id="_7"></a>正文</h3> 
<p>Skywalking 中就使用这种模型实现了 Agent 同步Apollo 配置，本文介绍下提供的功能以及代码实现，一起学习下。</p> 
<p>Skywalking 支持 agent 动态更新配置，使 agent 可以依据业务需求进行自定义配置；更重要的是建立起这一个通信机制，那么 agent 的可管理性、扩展性都大大提升。</p> 
<p>目前 Skywalking 提供了以下配置项</p> 
<p><img src="https://images2.imgbox.com/b6/9c/MFPvRLo1_o.png" alt="在这里插入图片描述"></p> 
<p>按照文档描述，主要为以下内容：</p> 
<ul><li> <p>控制采样速率</p> </li><li> <p>忽略指定后缀的请求，注意必须是 first span 的 opretationName 匹配到</p> <p>针对 web 服务，有些静态资源是放在服务端，那么可以过滤掉这些请求</p> </li><li> <p>忽略某些 path 的 trace</p> </li><li> <p>限定每个 segment 中的 span 最大数量</p> </li><li> <p>是否收集执行 sql 的参数</p> </li></ul> 
<p>样例配置</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">configurations</span><span class="token punctuation">:</span>
  <span class="token key atrule">serviceA</span><span class="token punctuation">:</span>
    <span class="token key atrule">trace.sample_n_per_3_secs</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">trace.ignore_path</span><span class="token punctuation">:</span> /a/b/c<span class="token punctuation">,</span>/a1/b1/c1
  <span class="token key atrule">serviceB</span><span class="token punctuation">:</span>
    <span class="token key atrule">trace.sample_n_per_3_secs</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">trace.ignore_path</span><span class="token punctuation">:</span> /a/b/c<span class="token punctuation">,</span>/a1/b1/c1
</code></pre> 
<p>注意：这个是按照服务来进行逐项配置，如果不需要变动，不要添加对应 key，会使用默认值。</p> 
<h4><a id="_46"></a>实现架构</h4> 
<ul><li> <p>OAP 同步 Apollo 配置</p> </li><li> <p>Agent 同步 OAP 配置。</p> </li></ul> 
<p>每阶段的操作无关联，都是作为 Client 的一端发起的请求来同步数据。</p> 
<h4><a id="_54"></a>实现模型</h4> 
<p>配置动态变更实际上是一个订阅发布模型，简单描述就是有发布者和订阅者两种角色，之间交互一般是：有一个注册接口，方便订阅者注册自身，以及发布者可以获取到订阅者列表；一个通知接口，方便发布者发送消息给订阅者。</p> 
<p>例如需要订水，只要给订水公司留下自己的电话、地址及数量（发布者知道如何找到你），之后就有人送水上门（有水时进行派送）。</p> 
<p>这种模型理解起来很简单，实现上难度也不大，且使用场景很广泛。</p> 
<h4><a id="OAP__Apollo_62"></a>OAP 同步 Apollo</h4> 
<p>首先看下 OAP 是如何同步 apollo 数据。</p> 
<h5><a id="ConfigWatcherRegister_66"></a>ConfigWatcherRegister</h5> 
<p>这是一个抽象类，代表的是配置中心的角色，实现上有 apollo、nacos、zk 等方式。</p> 
<p><img src="https://images2.imgbox.com/87/16/O7R3ISCI_o.png" alt="在这里插入图片描述"></p> 
<p>先看下 notifySingleValue 方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">notifySingleValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ConfigChangeWatcher</span> watcher<span class="token punctuation">,</span> <span class="token class-name">ConfigTable<span class="token punctuation">.</span>ConfigItem</span> configItem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> newItemValue <span class="token operator">=</span> configItem<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newItemValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Notify watcher, the new value is null with delete event type.</span>
            <span class="token comment">// 调用 watcher 的 notify 进行处理 </span>
            watcher<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">ConfigChangeWatcher<span class="token punctuation">.</span>ConfigChangeEvent</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">ConfigChangeWatcher<span class="token punctuation">.</span>EventType</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Don't need to notify, stay in null.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newItemValue<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>watcher<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            watcher<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfigChangeWatcher<span class="token punctuation">.</span>ConfigChangeEvent</span><span class="token punctuation">(</span>
                newItemValue<span class="token punctuation">,</span>
                <span class="token class-name">ConfigChangeWatcher<span class="token punctuation">.</span>EventType</span><span class="token punctuation">.</span><span class="token constant">MODIFY</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Don't need to notify, stay in the same config value.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法的逻辑是：读取 configItem 中的值，并且与 watcher 中的值进行比较，不相等之后判定是 DELETE、还是 UPDATE 操作，并封装成一个 ConfigChangeEvent 发送给 ConfigChangeWatcher，那么可以看出 ConfigChangeWatcher 是个订阅者的角色。</p> 
<p>继续看下调用 notifySingleValue 方法的地方：</p> 
<p>FetchingConfigWatcherRegister#singleConfigsSync</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Register</span> singleConfigChangeWatcherRegister <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigTable</span><span class="token punctuation">&gt;</span></span> <span class="token function">readConfig</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">singleConfigsSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 1. 读取配置数据</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigTable</span><span class="token punctuation">&gt;</span></span> configTable <span class="token operator">=</span> <span class="token function">readConfig</span><span class="token punctuation">(</span>singleConfigChangeWatcherRegister<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Config table would be null if no change detected from the implementation.</span>
    configTable<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>config <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        config<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">// 2. 遍历获取配置中的 itemName</span>
            <span class="token class-name">String</span> itemName <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">// 3. 依据 itemName 找到 WatcherHolder</span>
            <span class="token class-name">WatcherHolder</span> holder <span class="token operator">=</span> singleConfigChangeWatcherRegister<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>itemName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">ConfigChangeWatcher</span> watcher <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">// 从 WatcherHolder 得到 ConfigChangeWatcher，发送通知</span>
            <span class="token function">notifySingleValue</span><span class="token punctuation">(</span>watcher<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法执行的逻辑就是：</p> 
<ol><li>依据 singleConfigChangeWatcherRegister.keys() 作为参数读取配置信息</li><li>遍历配置信息，依据配置中的 name（即 itemName）找到 WatcherHolder，进而获取 ConfigChangeWatcher</li><li>调用 notifySingleValue。</li></ol> 
<p>readConfig 是个抽象方法，由具体的配置中心插件实现，本例中使用的 apollo，具体实现就是 ApolloConfigWatcherRegister。</p> 
<p>读取到的内容类型 ConfigTable，并且可以知道是存储的 k-v 集合，那么 ConfigItem 就是每个配置项，itemName 就是 apollo 中配置的 key。</p> 
<p>再看看调用 singleConfigsSync 的逻辑：</p> 
<pre><code class="prism language-java"><span class="token comment">// FetchingConfigWatcherRegister.java</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    isStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>
                 <span class="token keyword">new</span> <span class="token class-name">RunnableWithExceptionProtection</span><span class="token punctuation">(</span>
                     <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">configSync</span><span class="token punctuation">,</span> <span class="token comment">// 启动定时任务来执行</span>
                     t <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Sync config center error."</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
                 <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> syncPeriod<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">configSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">singleConfigsSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">groupConfigsSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再回到 singleConfigsSync 中，读取配置时需要先获取到配置项的 key 的集合：singleConfigChangeWatcherRegister.keys()</p> 
<p>先看下 singleConfigChangeWatcherRegister 的具体实现：FetchingConfigWatcherRegister$Register 内部就是一个 Map&lt;String, WatcherHolder&gt; 来存储。</p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Register</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">WatcherHolder</span><span class="token punctuation">&gt;</span></span> register <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> register<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">WatcherHolder</span> holder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        register<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">WatcherHolder</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> register<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> register<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>有读取就有存储，看看调用 put 逻辑：</p> 
<pre><code class="prism language-java"><span class="token comment">// FetchingConfigWatcherRegister</span>
<span class="token keyword">synchronized</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerConfigChangeWatcher</span><span class="token punctuation">(</span><span class="token class-name">ConfigChangeWatcher</span> watcher<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">WatcherHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatcherHolder</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>singleConfigChangeWatcherRegister<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>
        holder<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> groupConfigChangeWatcherRegister<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWatchType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token constant">SINGLE</span><span class="token operator">:</span>
        		<span class="token comment">// put 调用</span>
            singleConfigChangeWatcherRegister<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">GROUP</span><span class="token operator">:</span>
            groupConfigChangeWatcherRegister<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>registerConfigChangeWatcher 方法，用于注册 ConfigChangeWatcher ，内部处理逻辑：先将 watcher 放入 watchHolder 中，再以 holder key 分开存储 holder（放入 FetchingConfigWatcherRegister$Register 中）。</p> 
<p>WatcherHolder 是 ConfigWatcherRegister 一个内部类，代码如下，重点是 key 生成规则：<code>String.join(".", watcher.getModule(), watcher.getProvider().name(), watcher.getItemName());</code>，每个 itemName 对应一个 watcher。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Getter</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WatcherHolder</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">ConfigChangeWatcher</span> watcher<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">WatcherHolder</span><span class="token punctuation">(</span><span class="token class-name">ConfigChangeWatcher</span> watcher<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>watcher <span class="token operator">=</span> watcher<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
            <span class="token string">"."</span><span class="token punctuation">,</span> watcher<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> watcher<span class="token punctuation">.</span><span class="token function">getProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            watcher<span class="token punctuation">.</span><span class="token function">getItemName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>总结：OAP 启动定时任务，同步 apollo 的配置数据，遍历每个配置项（configItem），找到对应的 ConfigChangerWater，将 watcher 中的值与 configItem 中的值进行比较，不相等之后继续判定是 DELETE、还是 UPDATE 操作，封装成一个 ConfigChangeEvent 发送给对应的 ConfigChangeWatcher。</p> 
<h5><a id="ConfigChangeWatcher_236"></a>ConfigChangeWatcher</h5> 
<p>抽象类，依据命名，表示的是关注配置变化的 watcher，是 OAP 中定义的用于对不同配置的具体实现；对于 Apollo 上的每个 Key 都有对应的 ConfigChangeWatcher。</p> 
<p><img src="https://images2.imgbox.com/11/5d/geJluUZ6_o.png" alt="在这里插入图片描述"></p> 
<p>具体的 ConfigChangeWatcher 获取到 ConfigChangeEvent，处理逻辑各有不同，本次具体看下 AgentConfigurationsWatcher。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">String</span> settingsString<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">AgentConfigurationsTable</span> agentConfigurationsTable<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">ConfigChangeEvent</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">EventType</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        settingsString <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>agentConfigurationsTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AgentConfigurationsTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        settingsString <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">getNewValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AgentConfigurationsReader</span> agentConfigurationsReader <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">AgentConfigurationsReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getNewValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>agentConfigurationsTable <span class="token operator">=</span> agentConfigurationsReader<span class="token punctuation">.</span><span class="token function">readAgentConfigurationsTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>方法逻辑为：config value 存储到了 agentConfigurationsTable。</p> 
<p>apollo value 是什么样子呢？</p> 
<pre><code class="prism language-yml"><span class="token key atrule">configurations</span><span class="token punctuation">:</span>
  <span class="token key atrule">serviceA</span><span class="token punctuation">:</span>
    <span class="token key atrule">trace.sample_n_per_3_secs</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">trace.ignore_path</span><span class="token punctuation">:</span> /a/b/c<span class="token punctuation">,</span>/a1/b1/c1
  <span class="token key atrule">serviceB</span><span class="token punctuation">:</span>
    <span class="token key atrule">trace.sample_n_per_3_secs</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">trace.ignore_path</span><span class="token punctuation">:</span> /a/b/c<span class="token punctuation">,</span>/a1/b1/c1
</code></pre> 
<p>AgentConfigurationsTable 如下具体实现</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentConfigurationsTable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AgentConfigurations</span><span class="token punctuation">&gt;</span></span> agentConfigurationsCache<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AgentConfigurationsTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>agentConfigurationsCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentConfigurations</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> service<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> configuration<span class="token punctuation">;</span>
    <span class="token comment">/**
     * The uuid is calculated by the dynamic configuration of the service.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">String</span> uuid<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AgentConfigurations</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> service<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> configuration<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> uuid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>service <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>uuid <span class="token operator">=</span> uuid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将 agentConfigurationsTable 转换成 json 展示更容里理解数据存储的结构：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"serviceB"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"service"</span><span class="token operator">:</span> <span class="token string">"serviceB"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"configuration"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"trace.sample_n_per_3_secs"</span><span class="token operator">:</span> <span class="token string">"1000"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"trace.ignore_path"</span><span class="token operator">:</span> <span class="token string">"/a/b/c,/a1/b1/c1"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"uuid"</span><span class="token operator">:</span> <span class="token string">"92670f1ccbdee60e14ffc0"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"serviceA"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"service"</span><span class="token operator">:</span> <span class="token string">"serviceA"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"configuration"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"trace.sample_n_per_3_secs"</span><span class="token operator">:</span> <span class="token string">"1000"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"trace.ignore_path"</span><span class="token operator">:</span> <span class="token string">"/a/b/c,/a1/b1/c1"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"uuid"</span><span class="token operator">:</span> <span class="token string">"92670f1ccbdee60e14ffc0"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>查看读取 agentConfigurationsTable 值的逻辑：</p> 
<pre><code class="prism language-java"><span class="token comment">// AgentConfigurationsWatcher#getAgentConfigurations</span>
<span class="token keyword">public</span> <span class="token class-name">AgentConfigurations</span> <span class="token function">getAgentConfigurations</span><span class="token punctuation">(</span><span class="token class-name">String</span> service<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 依据 service 获取数据</span>
    <span class="token class-name">AgentConfigurations</span> agentConfigurations <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>agentConfigurationsTable<span class="token punctuation">.</span><span class="token function">getAgentConfigurationsCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> agentConfigurations<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> emptyAgentConfigurations<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> agentConfigurations<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>继续查看调用 getAgentConfigurations 的代码，并且将 value 包装成 ConfigurationDiscoveryCommand 返回。</p> 
<pre><code class="prism language-java"><span class="token comment">// ConfigurationDiscoveryServiceHandler#fetchConfigurations</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fetchConfigurations</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ConfigurationSyncRequest</span> request<span class="token punctuation">,</span>
                                <span class="token keyword">final</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Commands</span><span class="token punctuation">&gt;</span></span> responseObserver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Commands<span class="token punctuation">.</span>Builder</span> commandsBuilder <span class="token operator">=</span> <span class="token class-name">Commands</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AgentConfigurations</span> agentConfigurations <span class="token operator">=</span> agentConfigurationsWatcher<span class="token punctuation">.</span><span class="token function">getAgentConfigurations</span><span class="token punctuation">(</span>
        request<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> agentConfigurations<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 请求时会带有 uuid，会跟现有配置的 uuid 进行比对，如果不同，则获取最新值 </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>disableMessageDigest <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>agentConfigurations<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ConfigurationDiscoveryCommand</span> configurationDiscoveryCommand <span class="token operator">=</span>
                <span class="token function">newAgentDynamicConfigCommand</span><span class="token punctuation">(</span>agentConfigurations<span class="token punctuation">)</span><span class="token punctuation">;</span>
            commandsBuilder<span class="token punctuation">.</span><span class="token function">addCommands</span><span class="token punctuation">(</span>configurationDiscoveryCommand<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    responseObserver<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>commandsBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ConfigurationDiscoveryServiceHandler 属于 GRPCHandler，类似 SpringBoot 中 Controller，暴露接口，外部就可以获取数据。</p> 
<p>ConfigurationDiscoveryCommand 这个方法中有个属性来标识 command 的具体类型，这个在 agent 端接收到 command 需要依据 command 类型找到真正的处理器。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NAME</span> <span class="token operator">=</span> <span class="token string">"ConfigurationDiscoveryCommand"</span><span class="token punctuation">;</span>
</code></pre> 
<p>总结：当 AgentConfigurationsWatcher 收到订阅的 ConfigChangeEvent 时，会将值存储至 AgentConfigurationsTable，之后通过 ConfigurationDiscoveryServiceHandler 暴露接口，以方便 agent 可以获取到相应服务的配置。</p> 
<p>至此，OAP 与 Apollo 间的配置更新逻辑以及值的处理逻辑大致理清了。</p> 
<p>接下来看看 agent 与 oap 间的交互。</p> 
<h4><a id="Agent__379"></a>Agent 侧</h4> 
<p>找到调用 ConfigurationDiscoveryServiceGrpc#fetchConfigurations 的代码，看到 ConfigurationDiscoveryService，查看具体调用逻辑：</p> 
<pre><code class="prism language-java"><span class="token comment">// ConfigurationDiscoveryService</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">getAgentDynamicConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">GRPCChannelStatus</span><span class="token punctuation">.</span><span class="token constant">CONNECTED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">// 准备参数</span>
            <span class="token class-name">ConfigurationSyncRequest<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">ConfigurationSyncRequest</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token class-name">Config<span class="token punctuation">.</span>Agent</span><span class="token punctuation">.</span><span class="token constant">SERVICE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>configurationDiscoveryServiceBlockingStub <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">Commands</span> commands <span class="token operator">=</span> configurationDiscoveryServiceBlockingStub<span class="token punctuation">.</span><span class="token function">withDeadlineAfter</span><span class="token punctuation">(</span>
                    <span class="token constant">GRPC_UPSTREAM_TIMEOUT</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fetchConfigurations</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 方法调用</span>
              	<span class="token comment">// 结果处理</span>
                <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">.</span><span class="token function">findService</span><span class="token punctuation">(</span><span class="token class-name">CommandService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">receiveCommand</span><span class="token punctuation">(</span>commands<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而 getAgentDynamicConfig 是在 ConfigurationDiscoveryService#boot 执行时 init 了一个定时任务调用。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>
    getDynamicConfigurationFuture <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">DefaultNamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"ConfigurationDiscoveryService"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">RunnableWithExceptionProtection</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getAgentDynamicConfig</span><span class="token punctuation">,</span>
            t <span class="token operator">-&gt;</span> <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Sync config from OAP error."</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Config<span class="token punctuation">.</span>Collector</span><span class="token punctuation">.</span><span class="token constant">GET_AGENT_DYNAMIC_CONFIG_INTERVAL</span><span class="token punctuation">,</span>
        <span class="token class-name">Config<span class="token punctuation">.</span>Collector</span><span class="token punctuation">.</span><span class="token constant">GET_AGENT_DYNAMIC_CONFIG_INTERVAL</span><span class="token punctuation">,</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>获取结果后的处理逻辑：CommandService 接收 Commands，先是放入到队列中，</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BaseCommand</span><span class="token punctuation">&gt;</span></span> commands <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveCommand</span><span class="token punctuation">(</span><span class="token class-name">Commands</span> commands<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Command</span> command <span class="token operator">:</span> commands<span class="token punctuation">.</span><span class="token function">getCommandsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">BaseCommand</span> baseCommand <span class="token operator">=</span> <span class="token class-name">CommandDeserializer</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">// 将结果放入队列中</span>
            <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>baseCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success <span class="token operator">&amp;&amp;</span> <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isWarnEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedCommandException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>新开线程来消费队列，commandExecutorService 处理 Commands，通过代码调用链看到，最后依据 command 的类型找到真正指令执行器。</p> 
<pre><code class="prism language-java"><span class="token comment">// CommandService#run</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">CommandExecutorService</span> commandExecutorService <span class="token operator">=</span> <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">.</span><span class="token function">findService</span><span class="token punctuation">(</span><span class="token class-name">CommandExecutorService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>isRunning<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 消费队列</span>
            <span class="token class-name">BaseCommand</span> command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">// 判断是否已经执行过了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCommandExecuted</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
						<span class="token comment">// 分发 command</span>
            commandExecutorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
            serialNumberCache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getSerialNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CommandExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// CommandExecutorService#execute</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BaseCommand</span> command<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CommandExecutionException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executorForCommand</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// CommandExecutorService#executorForCommand</span>
<span class="token keyword">private</span> <span class="token class-name">CommandExecutor</span> <span class="token function">executorForCommand</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BaseCommand</span> command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">CommandExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commandExecutorMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">NoopCommandExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>依据指令类型获取具体的指令执行器，这里为 ConfigurationDiscoveryService，发现又调用了 ConfigurationDiscoveryService#handleConfigurationDiscoveryCommand 处理。</p> 
<pre><code class="prism language-java"><span class="token comment">// ConfigurationDiscoveryService#handleConfigurationDiscoveryCommand</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleConfigurationDiscoveryCommand</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationDiscoveryCommand</span> configurationDiscoveryCommand<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> responseUuid <span class="token operator">=</span> configurationDiscoveryCommand<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeyStringValuePair</span><span class="token punctuation">&gt;</span></span> config <span class="token operator">=</span> <span class="token function">readConfig</span><span class="token punctuation">(</span>configurationDiscoveryCommand<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 遍历配置项</span>
    config<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>property <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> propertyKey <span class="token operator">=</span> property<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WatcherHolder</span><span class="token punctuation">&gt;</span></span> holderList <span class="token operator">=</span> register<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>propertyKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WatcherHolder</span> holder <span class="token operator">:</span> holderList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              	<span class="token comment">// 依据配置项找到对应的 AgentConfigChangeWatcher，封装成 ConfigChangeEvent </span>
                <span class="token class-name">AgentConfigChangeWatcher</span> watcher <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> newPropertyValue <span class="token operator">=</span> property<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>newPropertyValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// Notify watcher, the new value is null with delete event type.</span>
                        watcher<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>
                                <span class="token keyword">new</span> <span class="token class-name">AgentConfigChangeWatcher<span class="token punctuation">.</span>ConfigChangeEvent</span><span class="token punctuation">(</span>
                                        <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">AgentConfigChangeWatcher<span class="token punctuation">.</span>EventType</span><span class="token punctuation">.</span><span class="token constant">DELETE</span>
                                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newPropertyValue<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>watcher<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        watcher<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AgentConfigChangeWatcher<span class="token punctuation">.</span>ConfigChangeEvent</span><span class="token punctuation">(</span>
                                newPropertyValue<span class="token punctuation">,</span> <span class="token class-name">AgentConfigChangeWatcher<span class="token punctuation">.</span>EventType</span><span class="token punctuation">.</span><span class="token constant">MODIFY</span>
                        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uuid <span class="token operator">=</span> responseUuid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ConfigurationDiscoveryService#handleConfigurationDiscoveryCommand 进行处理，遍历配置项列表，依据 Key 找到对应的 AgentConfigChangeWatcher，进行 notify。</p> 
<p>这个过程是不是很熟悉，跟 OAP 中处理逻辑不能说是完全一样，简直一模一样。</p> 
<p>AgentConfigChangeWatcher 是个抽象类，查看其具体实现，关注其注册以及处理 value 的逻辑即可。<br> <img src="https://images2.imgbox.com/48/43/ue6TeTxM_o.png" alt="在这里插入图片描述"></p> 
<p>具体逻辑就不再展开细说了，需要自行了解下。</p> 
<p>总之，agent 可以进行动态配置，能做的事情就多了，尤其是对 agent.config 中的配置大部分就可以实现动态管理了。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e3dd615829d1598c20519764a2d4ca1c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">软件测试工程师简历项目经验怎么写?--9999个已成功入职的软件测试工程师真实简历</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/82120563b43443454fc4518d76f4eba2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">（2021|CoRR，AugCLIP，优化）FuseDream：通过改进的 CLIP&#43;GAN 空间优化实现免训练文本到图像生成</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>