<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>wangeditor支持图片和视频上传 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="wangeditor支持图片和视频上传" />
<meta property="og:description" content="最近在搞 王编辑器 ，但是却不支持视频上传。只能自己去修改源代码。将上传图片变为可支持的上传视频。
如果觉得麻烦 可以安装我的版本。如果已经安装过 请先卸载之前的版本
npm uninstall wangediror@你自己的版本 --save
再执行
npm i guoeditor 以下为修改的全部源代码。即可粘贴复制。
(function (global, factory) { typeof exports === &#39;object&#39; &amp;&amp; typeof module !== &#39;undefined&#39; ? module.exports = factory() : typeof define === &#39;function&#39; &amp;&amp; define.amd ? define(factory) : (global.wangEditor = factory()); }(this, (function () { &#39;use strict&#39;; /* poly-fill */ var polyfill = function () { // Object.assign if (typeof Object.assign != &#39;function&#39;) { Object.assign = function (target, varArgs) { // ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/c0af15f4a2a74be8392ea87f2a7b3e8c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-29T21:01:47+08:00" />
<meta property="article:modified_time" content="2020-07-29T21:01:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">wangeditor支持图片和视频上传</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>最近在搞 王编辑器 ，但是却不支持视频上传。只能自己去修改源代码。将上传图片变为可支持的上传视频。<br> 如果觉得麻烦 可以安装我的版本。如果已经安装过 请先卸载之前的版本<br> <code>npm uninstall wangediror@你自己的版本 --save</code><br> 再执行</p> 
<pre><code class="prism language-javascript">npm i guoeditor 
</code></pre> 
<p>以下为修改的全部源代码。即可粘贴复制。</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>global<span class="token punctuation">,</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
    <span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd <span class="token operator">?</span> <span class="token function">define</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span> <span class="token punctuation">:</span>
      <span class="token punctuation">(</span>global<span class="token punctuation">.</span>wangEditor <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token string">'use strict'</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    poly-fill
*/</span>

  <span class="token keyword">var</span> <span class="token function-variable function">polyfill</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// Object.assign</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Object<span class="token punctuation">.</span>assign <span class="token operator">!=</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Object<span class="token punctuation">.</span><span class="token function-variable function">assign</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> varArgs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// .length of function is 2</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// TypeError if undefined or null</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Cannot convert undefined or null to object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> to <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> nextSource <span class="token operator">=</span> arguments<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>nextSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Skip over if undefined or null</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> nextKey <span class="token keyword">in</span> nextSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// Avoid bugs when hasOwnProperty is shadowed</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>nextSource<span class="token punctuation">,</span> nextKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                to<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span> <span class="token operator">=</span> nextSource<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> to<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// IE 中兼容 Element.prototype.matches</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Element<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>matches<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Element<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>matches <span class="token operator">=</span> Element<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>matchesSelector <span class="token operator">||</span> Element<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>mozMatchesSelector <span class="token operator">||</span> Element<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>msMatchesSelector <span class="token operator">||</span> Element<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>oMatchesSelector <span class="token operator">||</span> Element<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>webkitMatchesSelector <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> matches <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>document <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ownerDocument<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span>
          i <span class="token operator">=</span> matches<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> matches<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> i <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    DOM 操作 API
*/</span>

<span class="token comment">// 根据 html 代码片段创建 dom 对象</span>
  <span class="token keyword">function</span> <span class="token function">createElemByHTML</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> div <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
    div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> html<span class="token punctuation">;</span>
    <span class="token keyword">return</span> div<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 是否是 DOM List</span>
  <span class="token keyword">function</span> <span class="token function">isDOMList</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token keyword">instanceof</span> <span class="token class-name">HTMLCollection</span> <span class="token operator">||</span> selector <span class="token keyword">instanceof</span> <span class="token class-name">NodeList</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 封装 document.querySelectorAll</span>
  <span class="token keyword">function</span> <span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDOMList</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>result<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 记录所有的事件绑定</span>
  <span class="token keyword">var</span> eventList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 创建构造函数</span>
  <span class="token keyword">function</span> <span class="token function">DomElement</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// selector 本来就是 DomElement 对象，直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token keyword">instanceof</span> <span class="token class-name">DomElement</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> selector<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> selector<span class="token punctuation">;</span>
    <span class="token keyword">var</span> nodeType <span class="token operator">=</span> selector<span class="token punctuation">.</span>nodeType<span class="token punctuation">;</span>

    <span class="token comment">// 根据 selector 得出的结果（如 DOM，DOM List）</span>
    <span class="token keyword">var</span> selectorResult <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeType <span class="token operator">===</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// document 节点</span>
      selectorResult <span class="token operator">=</span> <span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 单个 DOM 节点</span>
      selectorResult <span class="token operator">=</span> <span class="token punctuation">[</span>selector<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDOMList</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token operator">||</span> selector <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// DOM List 或者数组</span>
      selectorResult <span class="token operator">=</span> selector<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> selector <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 字符串</span>
      selector <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'/\n/mg'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>selector<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如 &lt;div&gt;</span>
        selectorResult <span class="token operator">=</span> <span class="token function">createElemByHTML</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如 #id .class</span>
        selectorResult <span class="token operator">=</span> <span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> length <span class="token operator">=</span> selectorResult<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 空数组</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 加入 DOM 节点</span>
    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> selectorResult<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 修改原型</span>
  DomElement<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> DomElement<span class="token punctuation">,</span>

    <span class="token comment">// 类数组，forEach</span>
    forEach<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">forEach</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> result <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// clone</span>
    clone<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">clone</span><span class="token punctuation">(</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> cloneList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cloneList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>deep<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>cloneList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取第几个元素</span>
    <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        index <span class="token operator">=</span> index <span class="token operator">%</span> length<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 第一个</span>
    first<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 最后一个</span>
    last<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 绑定事件</span>
    on<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">on</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// selector 不为空，证明绑定事件要加代理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        fn <span class="token operator">=</span> selector<span class="token punctuation">;</span>
        selector <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// type 是否有多个</span>
      <span class="token keyword">var</span> types <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      types <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s+/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        types<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 记录下，方便后面解绑</span>
          eventList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            elem<span class="token punctuation">:</span> elem<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> type<span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> fn
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 无代理</span>
            elem<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 有代理</span>
          elem<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 取消事件绑定</span>
    off<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">off</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        elem<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取/设置 属性</span>
    attr<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取值</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 设置值</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 添加 class</span>
    addClass<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">addClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elem<span class="token punctuation">.</span>className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 解析当前 className 转换为数组</span>
          arr <span class="token operator">=</span> elem<span class="token punctuation">.</span>className<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>item<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 添加 class</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 修改 elem.class</span>
          elem<span class="token punctuation">.</span>className <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          elem<span class="token punctuation">.</span>className <span class="token operator">=</span> className<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 删除 class</span>
    removeClass<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">removeClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elem<span class="token punctuation">.</span>className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 解析当前 className 转换为数组</span>
          arr <span class="token operator">=</span> elem<span class="token punctuation">.</span>className<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            item <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 删除 class</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item <span class="token operator">||</span> item <span class="token operator">===</span> className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 修改 elem.class</span>
          elem<span class="token punctuation">.</span>className <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 修改 css</span>
    css<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">css</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> currentStyle <span class="token operator">=</span> key <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> val <span class="token operator">+</span> <span class="token string">';'</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> style <span class="token operator">=</span> <span class="token punctuation">(</span>elem<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> styleArr <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
          resultArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 将 style 按照 ; 拆分为数组</span>
          styleArr <span class="token operator">=</span> style<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          styleArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 对每项样式，按照 : 拆分为 key 和 value</span>
            <span class="token keyword">var</span> arr <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> i<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              resultArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 替换或者新增</span>
          resultArr <span class="token operator">=</span> resultArr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> currentStyle<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> item<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>resultArr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>currentStyle<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            resultArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentStyle<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 结果</span>
          elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">,</span> resultArr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// style 无值</span>
          elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">,</span> currentStyle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 显示</span>
    show<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'display'</span><span class="token punctuation">,</span> <span class="token string">'block'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 隐藏</span>
    hide<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'display'</span><span class="token punctuation">,</span> <span class="token string">'none'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取子节点</span>
    children<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取子节点（包括文本节点）</span>
    childNodes<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">childNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 增加子节点</span>
    append<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">append</span><span class="token punctuation">(</span>$children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          elem<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 移除当前节点</span>
    remove<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elem<span class="token punctuation">.</span>remove<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          elem<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> parent <span class="token operator">=</span> elem<span class="token punctuation">.</span>parentElement<span class="token punctuation">;</span>
          parent <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 是否包含某个子节点</span>
    isContain<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">isContain</span><span class="token punctuation">(</span>$child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> child <span class="token operator">=</span> $child<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> elem<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 尺寸数据</span>
    getSizeData<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">getSizeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> elem<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可得到 bottom height left right top width 的数据</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 封装 nodeName</span>
    getNodeName<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> elem<span class="token punctuation">.</span>nodeName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 从当前元素查找</span>
    find<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">find</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取当前元素的 text</span>
    text<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">text</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取 text</span>
        <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> elem<span class="token punctuation">.</span>innerHTML<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;.*?&gt;/g</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 设置 text</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          elem<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取 html</span>
    html<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">html</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> elem<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        elem<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取 value</span>
    val<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> elem<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// focus</span>
    focus<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        elem<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// parent</span>
    parent<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>parentElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// parentUntil 找到符合 selector 的父节点</span>
    parentUntil<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">parentUntil</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> _currentElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> results <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> length <span class="token operator">=</span> results<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 传入的 selector 无效</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> elem <span class="token operator">=</span> _currentElem <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>elem<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'BODY'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> parent <span class="token operator">=</span> elem<span class="token punctuation">.</span>parentElement<span class="token punctuation">;</span>
      <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">===</span> results<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 找到，并返回</span>
          <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 继续查找</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parentUntil</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 判断两个 elem 是否相等</span>
    equal<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">equal</span><span class="token punctuation">(</span>$elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$elem<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> $elem<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> $elem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 将该元素插入到某个元素前面</span>
    insertBefore<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">insertBefore</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> $referenceNode <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> referenceNode <span class="token operator">=</span> $referenceNode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>referenceNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> parent <span class="token operator">=</span> referenceNode<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span>
        parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> referenceNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 将该元素插入到某个元素后面</span>
    insertAfter<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">insertAfter</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> $referenceNode <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> referenceNode <span class="token operator">=</span> $referenceNode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>referenceNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> parent <span class="token operator">=</span> referenceNode<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>lastChild <span class="token operator">===</span> referenceNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 最后一个元素</span>
          parent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 不是最后一个元素</span>
          parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> referenceNode<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// new 一个对象</span>
  <span class="token keyword">function</span> <span class="token function">$</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DomElement</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 解绑所有事件，用于销毁编辑器</span>
  $<span class="token punctuation">.</span><span class="token function-variable function">offAll</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    eventList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> item<span class="token punctuation">.</span>elem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> type <span class="token operator">=</span> item<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">var</span> fn <span class="token operator">=</span> item<span class="token punctuation">.</span>fn<span class="token punctuation">;</span>
      <span class="token comment">// 解绑</span>
      elem<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    配置信息
*/</span>

  <span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 默认菜单配置</span>
    menus<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'head'</span><span class="token punctuation">,</span> <span class="token string">'bold'</span><span class="token punctuation">,</span> <span class="token string">'fontSize'</span><span class="token punctuation">,</span> <span class="token string">'fontName'</span><span class="token punctuation">,</span> <span class="token string">'italic'</span><span class="token punctuation">,</span> <span class="token string">'underline'</span><span class="token punctuation">,</span> <span class="token string">'strikeThrough'</span><span class="token punctuation">,</span> <span class="token string">'foreColor'</span><span class="token punctuation">,</span> <span class="token string">'backColor'</span><span class="token punctuation">,</span> <span class="token string">'link'</span><span class="token punctuation">,</span> <span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token string">'justify'</span><span class="token punctuation">,</span> <span class="token string">'quote'</span><span class="token punctuation">,</span> <span class="token string">'emoticon'</span><span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">,</span> <span class="token string">'table'</span><span class="token punctuation">,</span> <span class="token string">'video'</span><span class="token punctuation">,</span> <span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'undo'</span><span class="token punctuation">,</span> <span class="token string">'redo'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    fontNames<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'宋体'</span><span class="token punctuation">,</span> <span class="token string">'微软雅黑'</span><span class="token punctuation">,</span> <span class="token string">'Arial'</span><span class="token punctuation">,</span> <span class="token string">'Tahoma'</span><span class="token punctuation">,</span> <span class="token string">'Verdana'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    colors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'#000000'</span><span class="token punctuation">,</span> <span class="token string">'#eeece0'</span><span class="token punctuation">,</span> <span class="token string">'#1c487f'</span><span class="token punctuation">,</span> <span class="token string">'#4d80bf'</span><span class="token punctuation">,</span> <span class="token string">'#c24f4a'</span><span class="token punctuation">,</span> <span class="token string">'#8baa4a'</span><span class="token punctuation">,</span> <span class="token string">'#7b5ba1'</span><span class="token punctuation">,</span> <span class="token string">'#46acc8'</span><span class="token punctuation">,</span> <span class="token string">'#f9963b'</span><span class="token punctuation">,</span> <span class="token string">'#ffffff'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// // 语言配置</span>
    <span class="token comment">// lang: {<!-- --></span>
    <span class="token comment">//     '设置标题': 'title',</span>
    <span class="token comment">//     '正文': 'p',</span>
    <span class="token comment">//     '链接文字': 'link text',</span>
    <span class="token comment">//     '链接': 'link',</span>
    <span class="token comment">//     '插入': 'insert',</span>
    <span class="token comment">//     '创建': 'init'</span>
    <span class="token comment">// },</span>

    <span class="token comment">// 表情</span>
    emotions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">// tab 的标题</span>
      title<span class="token punctuation">:</span> <span class="token string">'默认'</span><span class="token punctuation">,</span>
      <span class="token comment">// type -&gt; 'emoji' / 'image'</span>
      type<span class="token punctuation">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
      <span class="token comment">// content -&gt; 数组</span>
      content<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
        alt<span class="token punctuation">:</span> <span class="token string">'[坏笑]'</span><span class="token punctuation">,</span>
        src<span class="token punctuation">:</span> <span class="token string">'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/50/pcmoren_huaixiao_org.png'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        alt<span class="token punctuation">:</span> <span class="token string">'[舔屏]'</span><span class="token punctuation">,</span>
        src<span class="token punctuation">:</span> <span class="token string">'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/pcmoren_tian_org.png'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        alt<span class="token punctuation">:</span> <span class="token string">'[污]'</span><span class="token punctuation">,</span>
        src<span class="token punctuation">:</span> <span class="token string">'http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/3c/pcmoren_wu_org.png'</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// tab 的标题</span>
      title<span class="token punctuation">:</span> <span class="token string">'新浪'</span><span class="token punctuation">,</span>
      <span class="token comment">// type -&gt; 'emoji' / 'image'</span>
      type<span class="token punctuation">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span>
      <span class="token comment">// content -&gt; 数组</span>
      content<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
        src<span class="token punctuation">:</span> <span class="token string">'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/7a/shenshou_thumb.gif'</span><span class="token punctuation">,</span>
        alt<span class="token punctuation">:</span> <span class="token string">'[草泥马]'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        src<span class="token punctuation">:</span> <span class="token string">'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/60/horse2_thumb.gif'</span><span class="token punctuation">,</span>
        alt<span class="token punctuation">:</span> <span class="token string">'[神马]'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        src<span class="token punctuation">:</span> <span class="token string">'http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/bc/fuyun_thumb.gif'</span><span class="token punctuation">,</span>
        alt<span class="token punctuation">:</span> <span class="token string">'[浮云]'</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// tab 的标题</span>
      title<span class="token punctuation">:</span> <span class="token string">'emoji'</span><span class="token punctuation">,</span>
      <span class="token comment">// type -&gt; 'emoji' / 'image'</span>
      type<span class="token punctuation">:</span> <span class="token string">'emoji'</span><span class="token punctuation">,</span>
      <span class="token comment">// content -&gt; 数组</span>
      content<span class="token punctuation">:</span> <span class="token string">'😀 😃 😄 😁 😆 😅 😂 😊 😇 🙂 🙃 😉 😓 😪 😴 🙄 🤔 😬 🤐'</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex">/\s/</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// 编辑区域的 z-index</span>
    zIndex<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>

    <span class="token comment">// 是否开启 debug 模式（debug 模式下错误会 throw error 形式抛出）</span>
    debug<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

    <span class="token comment">// 插入链接时候的格式校验</span>
    linkCheck<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">linkCheck</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> link<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// text 是插入的文字</span>
      <span class="token comment">// link 是插入的链接</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 返回 true 即表示成功</span>
      <span class="token comment">// return '校验失败' // 返回字符串即表示失败的提示信息</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 插入网络图片的校验</span>
    linkImgCheck<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">linkImgCheck</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// src 即图片的地址</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 返回 true 即表示成功</span>
      <span class="token comment">// return '校验失败'  // 返回字符串即表示失败的提示信息</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 粘贴过滤样式，默认开启</span>
    pasteFilterStyle<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

    <span class="token comment">// 粘贴内容时，忽略图片。默认关闭</span>
    pasteIgnoreImg<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

    <span class="token comment">// 对粘贴的文字进行自定义处理，返回处理后的结果。编辑器会将处理后的结果粘贴到编辑区域中。</span>
    <span class="token comment">// IE 暂时不支持</span>
    pasteTextHandle<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">pasteTextHandle</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// content 即粘贴过来的内容（html 或 纯文本），可进行自定义处理然后返回</span>
      <span class="token keyword">return</span> content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// onchange 事件</span>
    <span class="token comment">// onchange: function (html) {<!-- --></span>
    <span class="token comment">//     // html 即变化之后的内容</span>
    <span class="token comment">//     console.log(html)</span>
    <span class="token comment">// },</span>

    <span class="token comment">// 是否显示添加网络图片的 tab</span>
    showLinkImg<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

    <span class="token comment">// 插入网络图片的回调</span>
    linkImgCallback<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">linkImgCallback</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// console.log(url)  // url 即插入图片的地址</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 默认上传图片 max size: 5M</span>
    uploadImgMaxSize<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>

    <span class="token comment">// 配置一次最多上传几个图片</span>
    <span class="token comment">// uploadImgMaxLength: 5,</span>

    <span class="token comment">// 上传图片，是否显示 base64 格式</span>
    uploadImgShowBase64<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

    <span class="token comment">// 上传图片，server 地址（如果有值，则 base64 格式的配置则失效）</span>
    <span class="token comment">// uploadImgServer: '/upload',</span>

    <span class="token comment">// 自定义配置 filename</span>
    uploadFileName<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>

    <span class="token comment">// 上传图片的自定义参数</span>
    uploadImgParams<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// token: 'abcdef12345'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 上传图片的自定义header</span>
    uploadImgHeaders<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 'Accept': 'text/x-json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 配置 XHR withCredentials</span>
    withCredentials<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

    <span class="token comment">// 自定义上传图片超时时间 ms</span>
    uploadImgTimeout<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>

    <span class="token comment">// 上传图片 hook</span>
    uploadImgHooks<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// customInsert: function (insertLinkImg, result, editor) {<!-- --></span>
      <span class="token comment">//     console.log('customInsert')</span>
      <span class="token comment">//     // 图片上传并返回结果，自定义插入图片的事件，而不是编辑器自动插入图片</span>
      <span class="token comment">//     const data = result.data1 || []</span>
      <span class="token comment">//     data.forEach(link =&gt; {<!-- --></span>
      <span class="token comment">//         insertLinkImg(link)</span>
      <span class="token comment">//     })</span>
      <span class="token comment">// },</span>
      before<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">before</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">,</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 图片上传之前触发</span>

        <span class="token comment">// 如果返回的结果是 {prevent: true, msg: 'xxxx'} 则表示用户放弃上传</span>
        <span class="token comment">// return {<!-- --></span>
        <span class="token comment">//     prevent: true,</span>
        <span class="token comment">//     msg: '放弃上传'</span>
        <span class="token comment">// }</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">success</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 图片上传并返回结果，图片插入成功之后触发</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      fail<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fail</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 图片上传并返回结果，但图片插入错误时触发</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      error<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">error</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 图片上传出错时触发</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      timeout<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 图片上传超时时触发</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 是否上传七牛云，默认为 false</span>
    qiniu<span class="token punctuation">:</span> <span class="token boolean">false</span>

  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    工具
*/</span>

<span class="token comment">// 和 UA 相关的属性</span>
  <span class="token keyword">var</span> <span class="token constant">UA</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    _ua<span class="token punctuation">:</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">,</span>

    <span class="token comment">// 是否 webkit</span>
    isWebkit<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">isWebkit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token regex">/webkit/i</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_ua<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 是否 IE</span>
    isIE<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">isIE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token string">'ActiveXObject'</span> <span class="token keyword">in</span> window<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 遍历对象</span>
  <span class="token keyword">function</span> <span class="token function">objForEach</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
      result <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 遍历类数组</span>
  <span class="token keyword">function</span> <span class="token function">arrForEach</span><span class="token punctuation">(</span>fakeArr<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
      item <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
      result <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> length <span class="token operator">=</span> fakeArr<span class="token punctuation">.</span>length <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      item <span class="token operator">=</span> fakeArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>fakeArr<span class="token punctuation">,</span> item<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 获取随机数</span>
  <span class="token keyword">function</span> <span class="token function">getRandom</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> prefix <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 替换 html 特殊字符</span>
  <span class="token keyword">function</span> <span class="token function">replaceHtmlSymbol</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>html <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;/gm</span><span class="token punctuation">,</span> <span class="token string">'&amp;lt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&gt;/gm</span><span class="token punctuation">,</span> <span class="token string">'&amp;gt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/"/gm</span><span class="token punctuation">,</span> <span class="token string">'&amp;quot;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/(\r\n|\r|\n)/g</span><span class="token punctuation">,</span> <span class="token string">'&lt;br/&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 返回百分比的格式</span>


<span class="token comment">// 判断是不是 function</span>
  <span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
    bold-menu
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Bold</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;\n            &lt;i class="w-e-icon-bold"&gt;&lt;/i&gt;\n        &lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'click'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Bold<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Bold<span class="token punctuation">,</span>

    <span class="token comment">// 点击事件</span>
    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 点击菜单将触发这里</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> isSeleEmpty <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">isSelectionEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSeleEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 选区是空的，插入并选中一个“空白”</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createEmptyRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 执行 bold 命令</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'bold'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSeleEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 需要将选取折叠起来</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">collapseRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 试图改变 active 状态</span>
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandState</span><span class="token punctuation">(</span><span class="token string">'bold'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    替换多语言
 */</span>

  <span class="token keyword">var</span> <span class="token function-variable function">replaceLang</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>editor<span class="token punctuation">,</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> langArgs <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">.</span>langArgs <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> str<span class="token punctuation">;</span>

    langArgs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> reg <span class="token operator">=</span> item<span class="token punctuation">.</span>reg<span class="token punctuation">;</span>
      <span class="token keyword">var</span> val <span class="token operator">=</span> item<span class="token punctuation">.</span>val<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    droplist
*/</span>
  <span class="token keyword">var</span> <span class="token function-variable function">_emptyFn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">_emptyFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">DropList</span><span class="token punctuation">(</span>menu<span class="token punctuation">,</span> opt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// droplist 所依附的菜单</span>
    <span class="token keyword">var</span> editor <span class="token operator">=</span> menu<span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>menu <span class="token operator">=</span> menu<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>opt <span class="token operator">=</span> opt<span class="token punctuation">;</span>
    <span class="token comment">// 容器</span>
    <span class="token keyword">var</span> $container <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-droplist"&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 标题</span>
    <span class="token keyword">var</span> $title <span class="token operator">=</span> opt<span class="token punctuation">.</span>$title<span class="token punctuation">;</span>
    <span class="token keyword">var</span> titleHtml <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>$title<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 替换多语言</span>
      titleHtml <span class="token operator">=</span> $title<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      titleHtml <span class="token operator">=</span> <span class="token function">replaceLang</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> titleHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>
      $title<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>titleHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>

      $title<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-dp-title'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $container<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$title<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> list <span class="token operator">=</span> opt<span class="token punctuation">.</span>list <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> type <span class="token operator">=</span> opt<span class="token punctuation">.</span>type <span class="token operator">||</span> <span class="token string">'list'</span><span class="token punctuation">;</span> <span class="token comment">// 'list' 列表形式（如“标题”菜单） / 'inline-block' 块状形式（如“颜色”菜单）</span>
    <span class="token keyword">var</span> onClick <span class="token operator">=</span> opt<span class="token punctuation">.</span>onClick <span class="token operator">||</span> _emptyFn<span class="token punctuation">;</span>

    <span class="token comment">// 加入 DOM 并绑定事件</span>
    <span class="token keyword">var</span> $list <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;ul class="'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'list'</span> <span class="token operator">?</span> <span class="token string">'w-e-list'</span> <span class="token punctuation">:</span> <span class="token string">'w-e-block'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"&gt;&lt;/ul&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $container<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> item<span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>

      <span class="token comment">// 替换多语言</span>
      <span class="token keyword">var</span> elemHtml <span class="token operator">=</span> $elem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      elemHtml <span class="token operator">=</span> <span class="token function">replaceLang</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> elemHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>
      $elem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>elemHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> value <span class="token operator">=</span> item<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $li <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;li class="w-e-item"&gt;&lt;/li&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $li<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        $list<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$li<span class="token punctuation">)</span><span class="token punctuation">;</span>
        $li<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">onClick</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 隐藏</span>
          _this<span class="token punctuation">.</span>hideTimeoutId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            _this<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 绑定隐藏事件</span>
    $container<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'mouseleave'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      _this<span class="token punctuation">.</span>hideTimeoutId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _this<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 记录属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$container <span class="token operator">=</span> $container<span class="token punctuation">;</span>

    <span class="token comment">// 基本属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_rendered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_show <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  DropList<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> DropList<span class="token punctuation">,</span>

    <span class="token comment">// 显示（插入DOM）</span>
    show<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideTimeoutId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 清除之前的定时隐藏</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideTimeoutId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> menu <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>menu<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $menuELem <span class="token operator">=</span> menu<span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $container <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$container<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_show<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rendered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 显示</span>
        $container<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 加入 DOM 之前先定位位置</span>
        <span class="token keyword">var</span> menuHeight <span class="token operator">=</span> $menuELem<span class="token punctuation">.</span><span class="token function">getSizeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>height <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opt<span class="token punctuation">.</span>width <span class="token operator">||</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// 默认为 100</span>
        $container<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'margin-top'</span><span class="token punctuation">,</span> menuHeight <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">,</span> width <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加入到 DOM</span>
        $menuELem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$container<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_rendered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 修改属性</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_show <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 隐藏（移除DOM）</span>
    hide<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>showTimeoutId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 清除之前的定时显示</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>showTimeoutId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> $container <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$container<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_show<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 隐藏并需改属性</span>
      $container<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_show <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - header
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Head</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-header"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'droplist'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化 droplist</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>droplist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DropList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      $title<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;设置标题&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token comment">// droplist 以列表形式展示</span>
      list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;h1&gt;H1&lt;/h1&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'&lt;h1&gt;'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;h2&gt;H2&lt;/h2&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'&lt;h2&gt;'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;h3&gt;H3&lt;/h3&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'&lt;h3&gt;'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;h4&gt;H4&lt;/h4&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'&lt;h4&gt;'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;h5&gt;H5&lt;/h5&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'&lt;h5&gt;'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;正文&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'&lt;p&gt;'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 注意 this 是指向当前的 Head 对象</span>
        _this<span class="token punctuation">.</span><span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Head<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Head<span class="token punctuation">,</span>

    <span class="token comment">// 执行命令</span>
    _command<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>

      <span class="token keyword">var</span> $selectionElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>$selectionElem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 不能选中多行来设置标题，否则会出现问题</span>
        <span class="token comment">// 例如选中的是 &lt;p&gt;xxx&lt;/p&gt;&lt;p&gt;yyy&lt;/p&gt; 来设置标题，设置之后会成为 &lt;h1&gt;xxx&lt;br&gt;yyy&lt;/h1&gt; 不符合预期</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'formatBlock'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 试图改变 active 状态</span>
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token regex">/^h/i</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> cmdValue <span class="token operator">=</span> editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandValue</span><span class="token punctuation">(</span><span class="token string">'formatBlock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>cmdValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - fontSize
*/</span>

<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">FontSize</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-text-heigh"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'droplist'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化 droplist</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>droplist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DropList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      width<span class="token punctuation">:</span> <span class="token number">160</span><span class="token punctuation">,</span>
      $title<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;字号&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token comment">// droplist 以列表形式展示</span>
      list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span style="font-size: x-small;"&gt;x-small&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span style="font-size: small;"&gt;small&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'2'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span&gt;normal&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'3'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span style="font-size: large;"&gt;large&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'4'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span style="font-size: x-large;"&gt;x-large&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'5'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span style="font-size: xx-large;"&gt;xx-large&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'6'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 注意 this 是指向当前的 FontSize 对象</span>
        _this<span class="token punctuation">.</span><span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  FontSize<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> FontSize<span class="token punctuation">,</span>

    <span class="token comment">// 执行命令</span>
    _command<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'fontSize'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - fontName
*/</span>

<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">FontName</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-font"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'droplist'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取配置的字体</span>
    <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
    <span class="token keyword">var</span> fontNames <span class="token operator">=</span> config<span class="token punctuation">.</span>fontNames <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化 droplist</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>droplist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DropList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      $title<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;字体&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token comment">// droplist 以列表形式展示</span>
      list<span class="token punctuation">:</span> fontNames<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>fontName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span style="font-family: '</span> <span class="token operator">+</span> fontName <span class="token operator">+</span> <span class="token string">';"&gt;'</span> <span class="token operator">+</span> fontName <span class="token operator">+</span> <span class="token string">'&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> fontName <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 注意 this 是指向当前的 FontName 对象</span>
        _this<span class="token punctuation">.</span><span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  FontName<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> FontName<span class="token punctuation">,</span>

    _command<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'fontName'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    panel
*/</span>

  <span class="token keyword">var</span> <span class="token function-variable function">emptyFn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">emptyFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 记录已经显示 panel 的菜单</span>
  <span class="token keyword">var</span> _isCreatedPanelMenus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Panel</span><span class="token punctuation">(</span>menu<span class="token punctuation">,</span> opt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>menu <span class="token operator">=</span> menu<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>opt <span class="token operator">=</span> opt<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Panel<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Panel<span class="token punctuation">,</span>

    <span class="token comment">// 显示（插入DOM）</span>
    show<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> menu <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>menu<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_isCreatedPanelMenus<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 该菜单已经创建了 panel 不能再创建</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> menu<span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $body <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textContainerElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textContainerElem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> opt <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opt<span class="token punctuation">;</span>

      <span class="token comment">// panel 的容器</span>
      <span class="token keyword">var</span> $container <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-panel-container"&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> width <span class="token operator">=</span> opt<span class="token punctuation">.</span>width <span class="token operator">||</span> <span class="token number">300</span><span class="token punctuation">;</span> <span class="token comment">// 默认 300px</span>
      $container<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">,</span> width <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'margin-left'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 添加关闭按钮</span>
      <span class="token keyword">var</span> $closeBtn <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;i class="w-e-icon-close w-e-panel-close"&gt;&lt;/i&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $container<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$closeBtn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      $closeBtn<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _this<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 准备 tabs 容器</span>
      <span class="token keyword">var</span> $tabTitleContainer <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;ul class="w-e-panel-tab-title"&gt;&lt;/ul&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $tabContentContainer <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-panel-tab-content"&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $container<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$tabTitleContainer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$tabContentContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 设置高度</span>
      <span class="token keyword">var</span> height <span class="token operator">=</span> opt<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $tabContentContainer<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">,</span> height <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'overflow-y'</span><span class="token punctuation">,</span> <span class="token string">'auto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// tabs</span>
      <span class="token keyword">var</span> tabs <span class="token operator">=</span> opt<span class="token punctuation">.</span>tabs <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> tabTitleArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> tabContentArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      tabs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>tab<span class="token punctuation">,</span> tabIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tab<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> title <span class="token operator">=</span> tab<span class="token punctuation">.</span>title <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> tpl <span class="token operator">=</span> tab<span class="token punctuation">.</span>tpl <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>

        <span class="token comment">// 替换多语言</span>
        title <span class="token operator">=</span> <span class="token function">replaceLang</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tpl <span class="token operator">=</span> <span class="token function">replaceLang</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> tpl<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加到 DOM</span>
        <span class="token keyword">var</span> $title <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;li class="w-e-item"&gt;'</span> <span class="token operator">+</span> title <span class="token operator">+</span> <span class="token string">'&lt;/li&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $tabTitleContainer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$title<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> $content <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>tpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        $tabContentContainer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$content<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 记录到内存</span>
        $title<span class="token punctuation">.</span>_index <span class="token operator">=</span> tabIndex<span class="token punctuation">;</span>
        tabTitleArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>$title<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tabContentArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>$content<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置 active 项</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tabIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          $title<span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          $title<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          $content<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 绑定 tab 的事件</span>
        $title<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>$title<span class="token punctuation">.</span>_active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 隐藏所有的 tab</span>
          tabTitleArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>$title<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            $title<span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            $title<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          tabContentArr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>$content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            $content<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 显示当前的 tab</span>
          $title<span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          $title<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          $content<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 绑定关闭事件</span>
      $container<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 点击时阻止冒泡</span>
        e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $body<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _this<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 添加到 DOM</span>
      $textContainerElem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$container<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 绑定 opt 的事件，只有添加到 DOM 之后才能绑定成功</span>
      tabs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tab<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> events <span class="token operator">=</span> tab<span class="token punctuation">.</span>events <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        events<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> selector <span class="token operator">=</span> event<span class="token punctuation">.</span>selector<span class="token punctuation">;</span>
          <span class="token keyword">var</span> type <span class="token operator">=</span> event<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
          <span class="token keyword">var</span> fn <span class="token operator">=</span> event<span class="token punctuation">.</span>fn <span class="token operator">||</span> emptyFn<span class="token punctuation">;</span>
          <span class="token keyword">var</span> $content <span class="token operator">=</span> tabContentArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
          $content<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> needToHide <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 执行完事件之后，是否要关闭 panel</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needToHide<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              _this<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// focus 第一个 elem</span>
      <span class="token keyword">var</span> $inputs <span class="token operator">=</span> $container<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'input[type=text],textarea'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$inputs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $inputs<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 添加到属性</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$container <span class="token operator">=</span> $container<span class="token punctuation">;</span>

      <span class="token comment">// 隐藏其他 panel</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_hideOtherPanels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 记录该 menu 已经创建了 panel</span>
      _isCreatedPanelMenus<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 隐藏（移除DOM）</span>
    hide<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> menu <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>menu<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $container <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$container<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$container<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $container<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 将该 menu 记录中移除</span>
      _isCreatedPanelMenus <span class="token operator">=</span> _isCreatedPanelMenus<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">===</span> menu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 一个 panel 展示时，隐藏其他 panel</span>
    _hideOtherPanels<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_hideOtherPanels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isCreatedPanelMenus<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      _isCreatedPanelMenus<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>menu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> panel <span class="token operator">=</span> menu<span class="token punctuation">.</span>panel <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>panel<span class="token punctuation">.</span>hide<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          panel<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - link
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Link</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-link"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'panel'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Link<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Link<span class="token punctuation">,</span>

    <span class="token comment">// 点击事件</span>
    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $linkelem <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前选区在链接里面</span>
        $linkelem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$linkelem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将该元素都包含在选取之内，以便后面整体替换</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createRangeByElem</span><span class="token punctuation">(</span>$linkelem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 显示 panel</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createPanel</span><span class="token punctuation">(</span>$linkelem<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $linkelem<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前选区不在链接里面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">isSelectionEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 选区是空的，未选中内容</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createPanel</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 选中内容了</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createPanel</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 创建 panel</span>
    _createPanel<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_createPanel</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> link<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token comment">// panel 中需要用到的id</span>
      <span class="token keyword">var</span> inputLinkId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'input-link'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> inputTextId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'input-text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> btnOkId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'btn-ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> btnDelId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'btn-del'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 是否显示“删除链接”</span>
      <span class="token keyword">var</span> delBtnDisplay <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">?</span> <span class="token string">'inline-block'</span> <span class="token punctuation">:</span> <span class="token string">'none'</span><span class="token punctuation">;</span>

      <span class="token comment">// 初始化并显示 panel</span>
      <span class="token keyword">var</span> panel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Panel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        width<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
        <span class="token comment">// panel 中可包含多个 tab</span>
        tabs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">// tab 的标题</span>
          title<span class="token punctuation">:</span> <span class="token string">'链接'</span><span class="token punctuation">,</span>
          <span class="token comment">// 模板</span>
          tpl<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;\n                            &lt;input id="'</span> <span class="token operator">+</span> inputTextId <span class="token operator">+</span> <span class="token string">'" type="text" class="block" value="'</span> <span class="token operator">+</span> text <span class="token operator">+</span> <span class="token string">'" placeholder="\u94FE\u63A5\u6587\u5B57"/&gt;&lt;/td&gt;\n                            &lt;input id="'</span> <span class="token operator">+</span> inputLinkId <span class="token operator">+</span> <span class="token string">'" type="text" class="block" value="'</span> <span class="token operator">+</span> link <span class="token operator">+</span> <span class="token string">'" placeholder="http://..."/&gt;&lt;/td&gt;\n                            &lt;div class="w-e-button-container"&gt;\n                                &lt;button id="'</span> <span class="token operator">+</span> btnOkId <span class="token operator">+</span> <span class="token string">'" class="right"&gt;\u63D2\u5165&lt;/button&gt;\n                                &lt;button id="'</span> <span class="token operator">+</span> btnDelId <span class="token operator">+</span> <span class="token string">'" class="gray right" style="display:'</span> <span class="token operator">+</span> delBtnDisplay <span class="token operator">+</span> <span class="token string">'"&gt;\u5220\u9664\u94FE\u63A5&lt;/button&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;'</span><span class="token punctuation">,</span>
          <span class="token comment">// 事件绑定</span>
          events<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token comment">// 插入链接</span>
            <span class="token punctuation">{<!-- --></span>
              selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> btnOkId<span class="token punctuation">,</span>
              type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
              fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 执行插入链接</span>
                <span class="token keyword">var</span> $link <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> inputLinkId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> $text <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> inputTextId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> link <span class="token operator">=</span> $link<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> text <span class="token operator">=</span> $text<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _this<span class="token punctuation">.</span><span class="token function">_insertLink</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> link<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 删除链接</span>
            <span class="token punctuation">{<!-- --></span>
              selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> btnDelId<span class="token punctuation">,</span>
              type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
              fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 执行删除链接</span>
                _this<span class="token punctuation">.</span><span class="token function">_delLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token comment">// tab end</span>
        <span class="token punctuation">]</span> <span class="token comment">// tabs end</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 显示 panel</span>
      panel<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 记录属性</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>panel <span class="token operator">=</span> panel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 删除当前链接</span>
    _delLink<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_delLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $selectionELem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionELem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> selectionText <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'&lt;span&gt;'</span> <span class="token operator">+</span> selectionText <span class="token operator">+</span> <span class="token string">'&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 插入链接</span>
    _insertLink<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_insertLink</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> link<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
      <span class="token keyword">var</span> linkCheck <span class="token operator">=</span> config<span class="token punctuation">.</span>linkCheck<span class="token punctuation">;</span>
      <span class="token keyword">var</span> checkResult <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 默认为 true</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>linkCheck <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> linkCheck <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        checkResult <span class="token operator">=</span> <span class="token function">linkCheck</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> link<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>checkResult <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'&lt;a href="'</span> <span class="token operator">+</span> link <span class="token operator">+</span> <span class="token string">'" target="_blank"&gt;'</span> <span class="token operator">+</span> text <span class="token operator">+</span> <span class="token string">'&lt;/a&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">alert</span><span class="token punctuation">(</span>checkResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 试图改变 active 状态</span>
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $selectionELem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionELem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$selectionELem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'A'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    italic-menu
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Italic</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;\n            &lt;i class="w-e-icon-italic"&gt;&lt;/i&gt;\n        &lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'click'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Italic<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Italic<span class="token punctuation">,</span>

    <span class="token comment">// 点击事件</span>
    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 点击菜单将触发这里</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> isSeleEmpty <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">isSelectionEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSeleEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 选区是空的，插入并选中一个“空白”</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createEmptyRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 执行 italic 命令</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'italic'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSeleEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 需要将选取折叠起来</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">collapseRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 试图改变 active 状态</span>
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandState</span><span class="token punctuation">(</span><span class="token string">'italic'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    redo-menu
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Redo</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;\n            &lt;i class="w-e-icon-redo"&gt;&lt;/i&gt;\n        &lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'click'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Redo<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Redo<span class="token punctuation">,</span>

    <span class="token comment">// 点击事件</span>
    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 点击菜单将触发这里</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>

      <span class="token comment">// 执行 redo 命令</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'redo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    strikeThrough-menu
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">StrikeThrough</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;\n            &lt;i class="w-e-icon-strikethrough"&gt;&lt;/i&gt;\n        &lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'click'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  StrikeThrough<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> StrikeThrough<span class="token punctuation">,</span>

    <span class="token comment">// 点击事件</span>
    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 点击菜单将触发这里</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> isSeleEmpty <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">isSelectionEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSeleEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 选区是空的，插入并选中一个“空白”</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createEmptyRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 执行 strikeThrough 命令</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'strikeThrough'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSeleEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 需要将选取折叠起来</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">collapseRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 试图改变 active 状态</span>
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandState</span><span class="token punctuation">(</span><span class="token string">'strikeThrough'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    underline-menu
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Underline</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;\n            &lt;i class="w-e-icon-underline"&gt;&lt;/i&gt;\n        &lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'click'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Underline<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Underline<span class="token punctuation">,</span>

    <span class="token comment">// 点击事件</span>
    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 点击菜单将触发这里</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> isSeleEmpty <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">isSelectionEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSeleEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 选区是空的，插入并选中一个“空白”</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createEmptyRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 执行 underline 命令</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'underline'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSeleEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 需要将选取折叠起来</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">collapseRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 试图改变 active 状态</span>
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandState</span><span class="token punctuation">(</span><span class="token string">'underline'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    undo-menu
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Undo</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;\n            &lt;i class="w-e-icon-undo"&gt;&lt;/i&gt;\n        &lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'click'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Undo<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Undo<span class="token punctuation">,</span>

    <span class="token comment">// 点击事件</span>
    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 点击菜单将触发这里</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>

      <span class="token comment">// 执行 undo 命令</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'undo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - list
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">List</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-list2"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'droplist'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化 droplist</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>droplist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DropList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      width<span class="token punctuation">:</span> <span class="token number">120</span><span class="token punctuation">,</span>
      $title<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;设置列表&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token comment">// droplist 以列表形式展示</span>
      list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span&gt;&lt;i class="w-e-icon-list-numbered"&gt;&lt;/i&gt; 有序列表&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'insertOrderedList'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span&gt;&lt;i class="w-e-icon-list2"&gt;&lt;/i&gt; 无序列表&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'insertUnorderedList'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 注意 this 是指向当前的 List 对象</span>
        _this<span class="token punctuation">.</span><span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  List<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> List<span class="token punctuation">,</span>

    <span class="token comment">// 执行命令</span>
    _command<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandState</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 验证列表是否被包裹在 &lt;p&gt; 之内</span>
      <span class="token keyword">var</span> $selectionElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$selectionElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'LI'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $selectionElem <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^ol|ul$/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>$selectionElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$selectionElem<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>$textElem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 证明是顶级标签，没有被 &lt;p&gt; 包裹</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> $parent <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$parent<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>$textElem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// $parent 是顶级标签，不能删除</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      $selectionElem<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>$parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      $parent<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 试图改变 active 状态</span>
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandState</span><span class="token punctuation">(</span><span class="token string">'insertUnOrderedList'</span><span class="token punctuation">)</span> <span class="token operator">||</span> editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandState</span><span class="token punctuation">(</span><span class="token string">'insertOrderedList'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - justify
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Justify</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-paragraph-left"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'droplist'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化 droplist</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>droplist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DropList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      width<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      $title<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;对齐方式&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token comment">// droplist 以列表形式展示</span>
      list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span&gt;&lt;i class="w-e-icon-paragraph-left"&gt;&lt;/i&gt; 靠左&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'justifyLeft'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span&gt;&lt;i class="w-e-icon-paragraph-center"&gt;&lt;/i&gt; 居中&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'justifyCenter'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;span&gt;&lt;i class="w-e-icon-paragraph-right"&gt;&lt;/i&gt; 靠右&lt;/span&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'justifyRight'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 注意 this 是指向当前的 List 对象</span>
        _this<span class="token punctuation">.</span><span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Justify<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Justify<span class="token punctuation">,</span>

    <span class="token comment">// 执行命令</span>
    _command<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - Forecolor
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">ForeColor</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-pencil2"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'droplist'</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取配置的颜色</span>
    <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
    <span class="token keyword">var</span> colors <span class="token operator">=</span> config<span class="token punctuation">.</span>colors <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化 droplist</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>droplist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DropList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      width<span class="token punctuation">:</span> <span class="token number">120</span><span class="token punctuation">,</span>
      $title<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;文字颜色&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> <span class="token string">'inline-block'</span><span class="token punctuation">,</span> <span class="token comment">// droplist 内容以 block 形式展示</span>
      list<span class="token punctuation">:</span> colors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>color<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;i style="color:'</span> <span class="token operator">+</span> color <span class="token operator">+</span> <span class="token string">';" class="w-e-icon-pencil2"&gt;&lt;/i&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> color <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 注意 this 是指向当前的 ForeColor 对象</span>
        _this<span class="token punctuation">.</span><span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  ForeColor<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> ForeColor<span class="token punctuation">,</span>

    <span class="token comment">// 执行命令</span>
    _command<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'foreColor'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - BackColor
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">BackColor</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-paint-brush"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'droplist'</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取配置的颜色</span>
    <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
    <span class="token keyword">var</span> colors <span class="token operator">=</span> config<span class="token punctuation">.</span>colors <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化 droplist</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>droplist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DropList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      width<span class="token punctuation">:</span> <span class="token number">120</span><span class="token punctuation">,</span>
      $title<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;背景色&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      type<span class="token punctuation">:</span> <span class="token string">'inline-block'</span><span class="token punctuation">,</span> <span class="token comment">// droplist 内容以 block 形式展示</span>
      list<span class="token punctuation">:</span> colors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>color<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> $elem<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;i style="color:'</span> <span class="token operator">+</span> color <span class="token operator">+</span> <span class="token string">';" class="w-e-icon-paint-brush"&gt;&lt;/i&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> color <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 注意 this 是指向当前的 BackColor 对象</span>
        _this<span class="token punctuation">.</span><span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  BackColor<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> BackColor<span class="token punctuation">,</span>

    <span class="token comment">// 执行命令</span>
    _command<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_command</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'backColor'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - quote
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Quote</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;\n            &lt;i class="w-e-icon-quotes-left"&gt;&lt;/i&gt;\n        &lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'click'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Quote<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Quote<span class="token punctuation">,</span>

    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $selectionElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> nodeName <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">UA</span><span class="token punctuation">.</span><span class="token function">isIE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeName <span class="token operator">===</span> <span class="token string">'BLOCKQUOTE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 撤销 quote</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'formatBlock'</span><span class="token punctuation">,</span> <span class="token string">'&lt;P&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 转换为 quote</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'formatBlock'</span><span class="token punctuation">,</span> <span class="token string">'&lt;BLOCKQUOTE&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// IE 中不支持 formatBlock &lt;BLOCKQUOTE&gt; ，要用其他方式兼容</span>
      <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        $targetELem <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeName <span class="token operator">===</span> <span class="token string">'P'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将 P 转换为 quote</span>
        content <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $targetELem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;blockquote&gt;'</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">'&lt;/blockquote&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $targetELem<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>$selectionElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        $selectionElem<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeName <span class="token operator">===</span> <span class="token string">'BLOCKQUOTE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 撤销 quote</span>
        content <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $targetELem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;'</span> <span class="token operator">+</span> content <span class="token operator">+</span> <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $targetELem<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>$selectionElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        $selectionElem<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token regex">/^BLOCKQUOTE$/i</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> cmdValue <span class="token operator">=</span> editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandValue</span><span class="token punctuation">(</span><span class="token string">'formatBlock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>cmdValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - code
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Code</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;\n            &lt;i class="w-e-icon-terminal"&gt;&lt;/i&gt;\n        &lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'panel'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Code<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Code<span class="token punctuation">,</span>

    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $startElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionStartElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $endElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionEndElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> isSeleEmpty <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">isSelectionEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> selectionText <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $code <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$startElem<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>$endElem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 跨元素选择，不做处理</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSeleEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 选取不是空，用 &lt;code&gt; 包裹即可</span>
        $code <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;code&gt;'</span> <span class="token operator">+</span> selectionText <span class="token operator">+</span> <span class="token string">'&lt;/code&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertElem'</span><span class="token punctuation">,</span> $code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createRangeByElem</span><span class="token punctuation">(</span>$code<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 选取是空，且没有夸元素选择，则插入 &lt;pre&gt;&lt;code&gt;&lt;/code&gt;&lt;/prev&gt;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 选中状态，将编辑内容</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createPanel</span><span class="token punctuation">(</span>$startElem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 未选中状态，将创建内容</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    _createPanel<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_createPanel</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token comment">// value - 要编辑的内容</span>
      value <span class="token operator">=</span> value <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> type <span class="token operator">=</span> <span class="token operator">!</span>value <span class="token operator">?</span> <span class="token string">'new'</span> <span class="token punctuation">:</span> <span class="token string">'edit'</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> textId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'texxt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> btnId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> panel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Panel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        width<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
        <span class="token comment">// 一个 Panel 包含多个 tab</span>
        tabs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 标题</span>
          title<span class="token punctuation">:</span> <span class="token string">'插入代码'</span><span class="token punctuation">,</span>
          <span class="token comment">// 模板</span>
          tpl<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;\n                        &lt;textarea id="'</span> <span class="token operator">+</span> textId <span class="token operator">+</span> <span class="token string">'" style="height:145px;;"&gt;'</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">'&lt;/textarea&gt;\n                        &lt;div class="w-e-button-container"&gt;\n                            &lt;button id="'</span> <span class="token operator">+</span> btnId <span class="token operator">+</span> <span class="token string">'" class="right"&gt;\u63D2\u5165&lt;/button&gt;\n                        &lt;/div&gt;\n                    &lt;div&gt;'</span><span class="token punctuation">,</span>
          <span class="token comment">// 事件绑定</span>
          events<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token comment">// 插入代码</span>
            <span class="token punctuation">{<!-- --></span>
              selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> btnId<span class="token punctuation">,</span>
              type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
              fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> $text <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> textId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> text <span class="token operator">=</span> $text<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> $text<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                text <span class="token operator">=</span> <span class="token function">replaceHtmlSymbol</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'new'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// 新插入</span>
                  _this<span class="token punctuation">.</span><span class="token function">_insertCode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// 编辑更新</span>
                  _this<span class="token punctuation">.</span><span class="token function">_updateCode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token comment">// first tab end</span>
        <span class="token punctuation">]</span> <span class="token comment">// tabs end</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// new Panel end</span>

      <span class="token comment">// 显示 panel</span>
      panel<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 记录属性</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>panel <span class="token operator">=</span> panel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 插入代码</span>
    _insertCode<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_insertCode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'&lt;pre&gt;&lt;code&gt;'</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">'&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 更新代码</span>
    _updateCode<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_updateCode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $selectionELem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionELem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      $selectionELem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 试图改变 active 状态</span>
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $selectionELem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionELem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> $parentElem <span class="token operator">=</span> $selectionELem<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$selectionELem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'CODE'</span> <span class="token operator">&amp;&amp;</span> $parentElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'PRE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - emoticon
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Emoticon</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;\n            &lt;i class="w-e-icon-happy"&gt;&lt;/i&gt;\n        &lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'panel'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Emoticon<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Emoticon<span class="token punctuation">,</span>

    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    _createPanel<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_createPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
      <span class="token comment">// 获取表情配置</span>
      <span class="token keyword">var</span> emotions <span class="token operator">=</span> config<span class="token punctuation">.</span>emotions <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建表情 dropPanel 的配置</span>
      <span class="token keyword">var</span> tabConfig <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      emotions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>emotData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> emotType <span class="token operator">=</span> emotData<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
        <span class="token keyword">var</span> content <span class="token operator">=</span> emotData<span class="token punctuation">.</span>content <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 这一组表情最终拼接出来的 html</span>
        <span class="token keyword">var</span> faceHtml <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

        <span class="token comment">// emoji 表情</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>emotType <span class="token operator">===</span> <span class="token string">'emoji'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          content<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              faceHtml <span class="token operator">+=</span> <span class="token string">'&lt;span class="w-e-item"&gt;'</span> <span class="token operator">+</span> item <span class="token operator">+</span> <span class="token string">'&lt;/span&gt;'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 图片表情</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>emotType <span class="token operator">===</span> <span class="token string">'image'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          content<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> src <span class="token operator">=</span> item<span class="token punctuation">.</span>src<span class="token punctuation">;</span>
            <span class="token keyword">var</span> alt <span class="token operator">=</span> item<span class="token punctuation">.</span>alt<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 加一个 data-w-e 属性，点击图片的时候不再提示编辑图片</span>
              faceHtml <span class="token operator">+=</span> <span class="token string">'&lt;span class="w-e-item"&gt;&lt;img src="'</span> <span class="token operator">+</span> src <span class="token operator">+</span> <span class="token string">'" alt="'</span> <span class="token operator">+</span> alt <span class="token operator">+</span> <span class="token string">'" data-w-e="1"/&gt;&lt;/span&gt;'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        tabConfig<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          title<span class="token punctuation">:</span> emotData<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
          tpl<span class="token punctuation">:</span> <span class="token string">'&lt;div class="w-e-emoticon-container"&gt;'</span> <span class="token operator">+</span> faceHtml <span class="token operator">+</span> <span class="token string">'&lt;/div&gt;'</span><span class="token punctuation">,</span>
          events<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
            selector<span class="token punctuation">:</span> <span class="token string">'span.w-e-item'</span><span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">var</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
              <span class="token keyword">var</span> $target <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">var</span> nodeName <span class="token operator">=</span> $target<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token keyword">var</span> insertHtml <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeName <span class="token operator">===</span> <span class="token string">'IMG'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 插入图片</span>
                insertHtml <span class="token operator">=</span> $target<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 插入 emoji</span>
                insertHtml <span class="token operator">=</span> <span class="token string">'&lt;span&gt;'</span> <span class="token operator">+</span> $target<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/span&gt;'</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              _this<span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>insertHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> panel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Panel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        width<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        <span class="token comment">// 一个 Panel 包含多个 tab</span>
        tabs<span class="token punctuation">:</span> tabConfig
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 显示 panel</span>
      panel<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 记录属性</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>panel <span class="token operator">=</span> panel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 插入表情</span>
    _insert<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_insert</span><span class="token punctuation">(</span>emotHtml<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> emotHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - table
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Table</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-table2"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'panel'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Table<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Table<span class="token punctuation">,</span>

    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 编辑现有表格</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createEditPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 插入新表格</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createInsertPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 创建插入新表格的 panel</span>
    _createInsertPanel<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_createInsertPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token comment">// 用到的 id</span>
      <span class="token keyword">var</span> btnInsertId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> textRowNum <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'row'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> textColNum <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'col'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> panel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Panel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        width<span class="token punctuation">:</span> <span class="token number">250</span><span class="token punctuation">,</span>
        <span class="token comment">// panel 包含多个 tab</span>
        tabs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 标题</span>
          title<span class="token punctuation">:</span> <span class="token string">'插入表格'</span><span class="token punctuation">,</span>
          <span class="token comment">// 模板</span>
          tpl<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;\n                        &lt;p style="text-align:left; padding:5px 0;"&gt;\n                            \u521B\u5EFA\n                            &lt;input id="'</span> <span class="token operator">+</span> textRowNum <span class="token operator">+</span> <span class="token string">'" type="text" value="5" style="width:40px;text-align:center;"/&gt;\n                            \u884C\n                            &lt;input id="'</span> <span class="token operator">+</span> textColNum <span class="token operator">+</span> <span class="token string">'" type="text" value="5" style="width:40px;text-align:center;"/&gt;\n                            \u5217\u7684\u8868\u683C\n                        &lt;/p&gt;\n                        &lt;div class="w-e-button-container"&gt;\n                            &lt;button id="'</span> <span class="token operator">+</span> btnInsertId <span class="token operator">+</span> <span class="token string">'" class="right"&gt;\u63D2\u5165&lt;/button&gt;\n                        &lt;/div&gt;\n                    &lt;/div&gt;'</span><span class="token punctuation">,</span>
          <span class="token comment">// 事件绑定</span>
          events<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 点击按钮，插入表格</span>
            selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> btnInsertId<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">var</span> rowNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> textRowNum<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">var</span> colNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> textColNum<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>rowNum <span class="token operator">&amp;&amp;</span> colNum <span class="token operator">&amp;&amp;</span> rowNum <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> colNum <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// form 数据有效</span>
                _this<span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>rowNum<span class="token punctuation">,</span> colNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token comment">// first tab end</span>
        <span class="token punctuation">]</span> <span class="token comment">// tabs end</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// panel end</span>

      <span class="token comment">// 展示 panel</span>
      panel<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 记录属性</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>panel <span class="token operator">=</span> panel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 插入表格</span>
    _insert<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_insert</span><span class="token punctuation">(</span>rowNum<span class="token punctuation">,</span> colNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 拼接 table 模板</span>
      <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        c <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token string">'&lt;table border="0" width="100%" cellpadding="0" cellspacing="0"&gt;'</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> rowNum<span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        html <span class="token operator">+=</span> <span class="token string">'&lt;tr&gt;'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> colNum<span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            html <span class="token operator">+=</span> <span class="token string">'&lt;th&gt;&amp;nbsp;&lt;/th&gt;'</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> colNum<span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            html <span class="token operator">+=</span> <span class="token string">'&lt;td&gt;&amp;nbsp;&lt;/td&gt;'</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        html <span class="token operator">+=</span> <span class="token string">'&lt;/tr&gt;'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      html <span class="token operator">+=</span> <span class="token string">'&lt;/table&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">;</span>

      <span class="token comment">// 执行命令</span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 防止 firefox 下出现 resize 的控制点</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'enableObjectResizing'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'enableInlineTableEditing'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 创建编辑表格的 panel</span>
    _createEditPanel<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_createEditPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token comment">// 可用的 id</span>
      <span class="token keyword">var</span> addRowBtnId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'add-row'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> addColBtnId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'add-col'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> delRowBtnId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'del-row'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> delColBtnId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'del-col'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> delTableBtnId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'del-table'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建 panel 对象</span>
      <span class="token keyword">var</span> panel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Panel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        width<span class="token punctuation">:</span> <span class="token number">320</span><span class="token punctuation">,</span>
        <span class="token comment">// panel 包含多个 tab</span>
        tabs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 标题</span>
          title<span class="token punctuation">:</span> <span class="token string">'编辑表格'</span><span class="token punctuation">,</span>
          <span class="token comment">// 模板</span>
          tpl<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;\n                        &lt;div class="w-e-button-container" style="border-bottom:1px solid #f1f1f1;padding-bottom:5px;margin-bottom:5px;"&gt;\n                            &lt;button id="'</span> <span class="token operator">+</span> addRowBtnId <span class="token operator">+</span> <span class="token string">'" class="left"&gt;\u589E\u52A0\u884C&lt;/button&gt;\n                            &lt;button id="'</span> <span class="token operator">+</span> delRowBtnId <span class="token operator">+</span> <span class="token string">'" class="red left"&gt;\u5220\u9664\u884C&lt;/button&gt;\n                            &lt;button id="'</span> <span class="token operator">+</span> addColBtnId <span class="token operator">+</span> <span class="token string">'" class="left"&gt;\u589E\u52A0\u5217&lt;/button&gt;\n                            &lt;button id="'</span> <span class="token operator">+</span> delColBtnId <span class="token operator">+</span> <span class="token string">'" class="red left"&gt;\u5220\u9664\u5217&lt;/button&gt;\n                        &lt;/div&gt;\n                        &lt;div class="w-e-button-container"&gt;\n                            &lt;button id="'</span> <span class="token operator">+</span> delTableBtnId <span class="token operator">+</span> <span class="token string">'" class="gray left"&gt;\u5220\u9664\u8868\u683C&lt;/button&gt;\n                        &lt;/dv&gt;\n                    &lt;/div&gt;'</span><span class="token punctuation">,</span>
          <span class="token comment">// 事件绑定</span>
          events<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 增加行</span>
            selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> addRowBtnId<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              _this2<span class="token punctuation">.</span><span class="token function">_addRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 增加列</span>
            selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> addColBtnId<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              _this2<span class="token punctuation">.</span><span class="token function">_addCol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 删除行</span>
            selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> delRowBtnId<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              _this2<span class="token punctuation">.</span><span class="token function">_delRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 删除列</span>
            selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> delColBtnId<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              _this2<span class="token punctuation">.</span><span class="token function">_delCol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 删除表格</span>
            selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> delTableBtnId<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              _this2<span class="token punctuation">.</span><span class="token function">_delTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 显示 panel</span>
      panel<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取选中的单元格的位置信息</span>
    _getLocationData<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_getLocationData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $selectionELem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionELem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> nodeName <span class="token operator">=</span> $selectionELem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeName <span class="token operator">!==</span> <span class="token string">'TD'</span> <span class="token operator">&amp;&amp;</span> nodeName <span class="token operator">!==</span> <span class="token string">'TH'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 获取 td index</span>
      <span class="token keyword">var</span> $tr <span class="token operator">=</span> $selectionELem<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $tds <span class="token operator">=</span> $tr<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> tdLength <span class="token operator">=</span> $tds<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      $tds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>td<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>td <span class="token operator">===</span> $selectionELem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 记录并跳出循环</span>
          result<span class="token punctuation">.</span>td <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            index<span class="token punctuation">:</span> index<span class="token punctuation">,</span>
            elem<span class="token punctuation">:</span> td<span class="token punctuation">,</span>
            length<span class="token punctuation">:</span> tdLength
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 获取 tr index</span>
      <span class="token keyword">var</span> $tbody <span class="token operator">=</span> $tr<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $trs <span class="token operator">=</span> $tbody<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> trLength <span class="token operator">=</span> $trs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      $trs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>tr<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tr <span class="token operator">===</span> $tr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 记录并跳出循环</span>
          result<span class="token punctuation">.</span>tr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            index<span class="token punctuation">:</span> index<span class="token punctuation">,</span>
            elem<span class="token punctuation">:</span> tr<span class="token punctuation">,</span>
            length<span class="token punctuation">:</span> trLength
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 返回结果</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 增加行</span>
    _addRow<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_addRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 获取当前单元格的位置信息</span>
      <span class="token keyword">var</span> locationData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getLocationData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>locationData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> trData <span class="token operator">=</span> locationData<span class="token punctuation">.</span>tr<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $currentTr <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>trData<span class="token punctuation">.</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> tdData <span class="token operator">=</span> locationData<span class="token punctuation">.</span>td<span class="token punctuation">;</span>
      <span class="token keyword">var</span> tdLength <span class="token operator">=</span> tdData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

      <span class="token comment">// 拼接即将插入的字符串</span>
      <span class="token keyword">var</span> newTr <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'tr'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> tpl <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
        i <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tdLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tpl <span class="token operator">+=</span> <span class="token string">'&lt;td&gt;&amp;nbsp;&lt;/td&gt;'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      newTr<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> tpl<span class="token punctuation">;</span>
      <span class="token comment">// 插入</span>
      <span class="token function">$</span><span class="token punctuation">(</span>newTr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>$currentTr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 增加列</span>
    _addCol<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_addCol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 获取当前单元格的位置信息</span>
      <span class="token keyword">var</span> locationData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getLocationData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>locationData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> trData <span class="token operator">=</span> locationData<span class="token punctuation">.</span>tr<span class="token punctuation">;</span>
      <span class="token keyword">var</span> tdData <span class="token operator">=</span> locationData<span class="token punctuation">.</span>td<span class="token punctuation">;</span>
      <span class="token keyword">var</span> tdIndex <span class="token operator">=</span> tdData<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $currentTr <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>trData<span class="token punctuation">.</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $trParent <span class="token operator">=</span> $currentTr<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $trs <span class="token operator">=</span> $trParent<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 遍历所有行</span>
      $trs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>tr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> $tr <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> $tds <span class="token operator">=</span> $tr<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> $currentTd <span class="token operator">=</span> $tds<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>tdIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> name <span class="token operator">=</span> $currentTd<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// new 一个 td，并插入</span>
        <span class="token keyword">var</span> newTd <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">$</span><span class="token punctuation">(</span>newTd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>$currentTd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 删除行</span>
    _delRow<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_delRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 获取当前单元格的位置信息</span>
      <span class="token keyword">var</span> locationData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getLocationData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>locationData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> trData <span class="token operator">=</span> locationData<span class="token punctuation">.</span>tr<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $currentTr <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>trData<span class="token punctuation">.</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
      $currentTr<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 删除列</span>
    _delCol<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_delCol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 获取当前单元格的位置信息</span>
      <span class="token keyword">var</span> locationData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getLocationData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>locationData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> trData <span class="token operator">=</span> locationData<span class="token punctuation">.</span>tr<span class="token punctuation">;</span>
      <span class="token keyword">var</span> tdData <span class="token operator">=</span> locationData<span class="token punctuation">.</span>td<span class="token punctuation">;</span>
      <span class="token keyword">var</span> tdIndex <span class="token operator">=</span> tdData<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $currentTr <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>trData<span class="token punctuation">.</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $trParent <span class="token operator">=</span> $currentTr<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $trs <span class="token operator">=</span> $trParent<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 遍历所有行</span>
      $trs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>tr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> $tr <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> $tds <span class="token operator">=</span> $tr<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> $currentTd <span class="token operator">=</span> $tds<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>tdIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除</span>
        $currentTd<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 删除表格</span>
    _delTable<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_delTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $selectionELem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionELem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> $table <span class="token operator">=</span> $selectionELem<span class="token punctuation">.</span><span class="token function">parentUntil</span><span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$table<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      $table<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 试图改变 active 状态</span>
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $selectionELem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionELem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> nodeName <span class="token operator">=</span> $selectionELem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeName <span class="token operator">===</span> <span class="token string">'TD'</span> <span class="token operator">||</span> nodeName <span class="token operator">===</span> <span class="token string">'TH'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - video
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Video</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu"&gt;&lt;i class="w-e-icon-play"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'panel'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Video<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Video<span class="token punctuation">,</span>

    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    _createPanel<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_createPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建 id</span>
      <span class="token keyword">var</span> textValId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'text-val'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> btnId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建 panel</span>
      <span class="token keyword">var</span> panel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Panel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        width<span class="token punctuation">:</span> <span class="token number">350</span><span class="token punctuation">,</span>
        <span class="token comment">// 一个 panel 多个 tab</span>
        tabs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 标题</span>
          title<span class="token punctuation">:</span> <span class="token string">'插入视频'</span><span class="token punctuation">,</span>
          <span class="token comment">// 模板</span>
          tpl<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;\n                        &lt;input id="'</span> <span class="token operator">+</span> textValId <span class="token operator">+</span> <span class="token string">'" type="text" class="block" placeholder="\u683C\u5F0F\u5982\uFF1A&lt;iframe src=... &gt;&lt;/iframe&gt;"/&gt;\n                        &lt;div class="w-e-button-container"&gt;\n                            &lt;button id="'</span> <span class="token operator">+</span> btnId <span class="token operator">+</span> <span class="token string">'" class="right"&gt;\u63D2\u5165&lt;/button&gt;\n                        &lt;/div&gt;\n                    &lt;/div&gt;'</span><span class="token punctuation">,</span>
          <span class="token comment">// 事件绑定</span>
          events<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
            selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> btnId<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">var</span> $text <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> textValId<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">var</span> val <span class="token operator">=</span> $text<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// 测试用视频地址</span>
              <span class="token comment">// &lt;iframe height=498 width=510 src='http://player.youku.com/embed/XMjcwMzc3MzM3Mg==' frameborder=0 'allowfullscreen'&gt;&lt;/iframe&gt;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 插入视频</span>
                _this<span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token comment">// first tab end</span>
        <span class="token punctuation">]</span> <span class="token comment">// tabs end</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// panel end</span>

      <span class="token comment">// 显示 panel</span>
      panel<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 记录属性</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>panel <span class="token operator">=</span> panel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 插入视频</span>
    _insert<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_insert</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> val <span class="token operator">+</span> <span class="token string">'&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    menu - img
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Image</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">var</span> imgMenuId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'w-e-img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-menu" id="'</span> <span class="token operator">+</span> imgMenuId <span class="token operator">+</span> <span class="token string">'"&gt;&lt;i class="w-e-icon-image"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    editor<span class="token punctuation">.</span>imgMenuId <span class="token operator">=</span> imgMenuId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'panel'</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前是否 active 状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  Image<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Image<span class="token punctuation">,</span>

    onClick<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>qiniu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_active<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createEditPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createInsertPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    _createEditPanel<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_createEditPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>

      <span class="token comment">// id</span>
      <span class="token keyword">var</span> width30 <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'width-30'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> width50 <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'width-50'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> width100 <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'width-100'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> delBtn <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'del-btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// tab 配置</span>
      <span class="token keyword">var</span> tabsConfig <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
        title<span class="token punctuation">:</span> <span class="token string">'编辑图片'</span><span class="token punctuation">,</span>
        tpl<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;\n                    &lt;div class="w-e-button-container" style="border-bottom:1px solid #f1f1f1;padding-bottom:5px;margin-bottom:5px;"&gt;\n                        &lt;span style="float:left;font-size:14px;margin:4px 5px 0 5px;color:#333;"&gt;\u6700\u5927\u5BBD\u5EA6\uFF1A&lt;/span&gt;\n                        &lt;button id="'</span> <span class="token operator">+</span> width30 <span class="token operator">+</span> <span class="token string">'" class="left"&gt;30%&lt;/button&gt;\n                        &lt;button id="'</span> <span class="token operator">+</span> width50 <span class="token operator">+</span> <span class="token string">'" class="left"&gt;50%&lt;/button&gt;\n                        &lt;button id="'</span> <span class="token operator">+</span> width100 <span class="token operator">+</span> <span class="token string">'" class="left"&gt;100%&lt;/button&gt;\n                    &lt;/div&gt;\n                    &lt;div class="w-e-button-container"&gt;\n                        &lt;button id="'</span> <span class="token operator">+</span> delBtn <span class="token operator">+</span> <span class="token string">'" class="gray left"&gt;\u5220\u9664\u56FE\u7247&lt;/button&gt;\n                    &lt;/dv&gt;\n                &lt;/div&gt;'</span><span class="token punctuation">,</span>
        events<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
          selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> width30<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
          fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> $img <span class="token operator">=</span> editor<span class="token punctuation">.</span>_selectedImg<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>$img<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              $img<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'max-width'</span><span class="token punctuation">,</span> <span class="token string">'30%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
          selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> width50<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
          fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> $img <span class="token operator">=</span> editor<span class="token punctuation">.</span>_selectedImg<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>$img<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              $img<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'max-width'</span><span class="token punctuation">,</span> <span class="token string">'50%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
          selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> width100<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
          fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> $img <span class="token operator">=</span> editor<span class="token punctuation">.</span>_selectedImg<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>$img<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              $img<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'max-width'</span><span class="token punctuation">,</span> <span class="token string">'100%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
          selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> delBtn<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
          fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> $img <span class="token operator">=</span> editor<span class="token punctuation">.</span>_selectedImg<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>$img<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              $img<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 返回 true，表示该事件执行完之后，panel 要关闭。否则 panel 不会关闭</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建 panel 并显示</span>
      <span class="token keyword">var</span> panel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Panel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        width<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
        tabs<span class="token punctuation">:</span> tabsConfig
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      panel<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 记录属性</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>panel <span class="token operator">=</span> panel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    _createInsertPanel<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_createInsertPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> uploadImg <span class="token operator">=</span> editor<span class="token punctuation">.</span>uploadImg<span class="token punctuation">;</span>
      <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

      <span class="token comment">// id</span>
      <span class="token keyword">var</span> upTriggerId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'up-trigger'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> upFileId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'up-file'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> linkUrlId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'link-url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> linkBtnId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'link-btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// tabs 的配置</span>
      <span class="token keyword">var</span> tabsConfig <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
        title<span class="token punctuation">:</span> <span class="token string">'上传图片或视频'</span><span class="token punctuation">,</span>
        tpl<span class="token punctuation">:</span> <span class="token string">'&lt;div class="w-e-up-img-container"&gt;\n                    &lt;div id="'</span> <span class="token operator">+</span> upTriggerId <span class="token operator">+</span> <span class="token string">'" class="w-e-up-btn"&gt;\n                        &lt;i class="w-e-icon-upload2"&gt;&lt;/i&gt;\n                    &lt;/div&gt;\n                    &lt;div style="display:none;"&gt;\n                        &lt;input id="'</span> <span class="token operator">+</span> upFileId <span class="token operator">+</span> <span class="token string">'" type="file" multiple="multiple" accept="image/*,video/*"/&gt;\n                    &lt;/div&gt;\n                &lt;/div&gt;'</span><span class="token punctuation">,</span>
        events<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 触发选择图片</span>
          selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> upTriggerId<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
          fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> $file <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> upFileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> fileElem <span class="token operator">=</span> $file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fileElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              fileElem<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              <span class="token operator">/</span><span class="token operator">/</span> 返回 <span class="token boolean">true</span> 可关闭 panel
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
          <span class="token operator">/</span><span class="token operator">/</span> 选择图片完毕
          selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> upFileId<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token string">'change'</span><span class="token punctuation">,</span>
          fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> $file <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> upFileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> fileElem <span class="token operator">=</span> $file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token operator">/</span><span class="token operator">/</span> 返回 <span class="token boolean">true</span> 可关闭 panel
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token operator">/</span><span class="token operator">/</span> 获取选中的 file 对象列表
            <span class="token keyword">var</span> fileList <span class="token operator">=</span> fileElem<span class="token punctuation">.</span>files<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fileList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              uploadImg<span class="token punctuation">.</span><span class="token function">uploadImg</span><span class="token punctuation">(</span>fileList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token operator">/</span><span class="token operator">/</span> 返回 <span class="token boolean">true</span> 可关闭 panel
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> first tab end
        <span class="token punctuation">{<!-- --></span>
          title<span class="token punctuation">:</span> <span class="token string">'网络图片或视频'</span><span class="token punctuation">,</span>
          tpl<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;\n                    &lt;input id="'</span> <span class="token operator">+</span> linkUrlId <span class="token operator">+</span> <span class="token string">'" type="text" class="block" placeholder="图片或视频链接"/&gt;&lt;/td&gt;\n                    &lt;div class="w-e-button-container"&gt;\n                        &lt;button id="'</span> <span class="token operator">+</span> linkBtnId <span class="token operator">+</span> <span class="token string">'" class="right"&gt;\u63D2\u5165&lt;/button&gt;\n                    &lt;/div&gt;\n                &lt;/div&gt;'</span><span class="token punctuation">,</span>
          events<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
            selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> linkBtnId<span class="token punctuation">,</span>
            type<span class="token punctuation">:</span> <span class="token string">'click'</span><span class="token punctuation">,</span>
            fn<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">var</span> $linkUrl <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> linkUrlId<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">var</span> url <span class="token operator">=</span> $linkUrl<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                uploadImg<span class="token punctuation">.</span><span class="token function">insertLinkImg</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token operator">/</span><span class="token operator">/</span> 返回 <span class="token boolean">true</span> 表示函数执行结束之后关闭 panel
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">/</span> second tab end
      <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span> tabs end

      <span class="token operator">/</span><span class="token operator">/</span> 判断 tabs 的显示
      <span class="token keyword">var</span> tabsConfigResult <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>uploadImgShowBase64 <span class="token operator">||</span> config<span class="token punctuation">.</span>uploadImgServer <span class="token operator">||</span> config<span class="token punctuation">.</span>customUploadImg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>FileReader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">/</span><span class="token operator">/</span> 显示“上传图片”
        tabsConfigResult<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tabsConfig<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>showLinkImg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">/</span><span class="token operator">/</span> 显示“网络图片”
        tabsConfigResult<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tabsConfig<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token operator">/</span><span class="token operator">/</span> 创建 panel 并显示
      <span class="token keyword">var</span> panel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Panel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        width<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span>
        tabs<span class="token punctuation">:</span> tabsConfigResult
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      panel<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token operator">/</span><span class="token operator">/</span> 记录属性
      <span class="token keyword">this</span><span class="token punctuation">.</span>panel <span class="token operator">=</span> panel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token operator">/</span><span class="token operator">/</span> 试图改变 active 状态
    tryChangeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">tryChangeActive</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>_selectedImg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        $elem<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'w-e-active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    所有菜单的汇总
*/</span>

<span class="token comment">// 存储菜单的构造函数</span>
  <span class="token keyword">var</span> MenuConstructors <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>bold <span class="token operator">=</span> Bold<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>head <span class="token operator">=</span> Head<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>fontSize <span class="token operator">=</span> FontSize<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>fontName <span class="token operator">=</span> FontName<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>link <span class="token operator">=</span> Link<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>italic <span class="token operator">=</span> Italic<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>redo <span class="token operator">=</span> Redo<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>strikeThrough <span class="token operator">=</span> StrikeThrough<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>underline <span class="token operator">=</span> Underline<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>undo <span class="token operator">=</span> Undo<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>list <span class="token operator">=</span> List<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>justify <span class="token operator">=</span> Justify<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>foreColor <span class="token operator">=</span> ForeColor<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>backColor <span class="token operator">=</span> BackColor<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>quote <span class="token operator">=</span> Quote<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>code <span class="token operator">=</span> Code<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>emoticon <span class="token operator">=</span> Emoticon<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>table <span class="token operator">=</span> Table<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>video <span class="token operator">=</span> Video<span class="token punctuation">;</span>

  MenuConstructors<span class="token punctuation">.</span>image <span class="token operator">=</span> Image<span class="token punctuation">;</span>

  <span class="token comment">/*
    菜单集合
*/</span>
<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Menus</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>menus <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 修改原型</span>
  Menus<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Menus<span class="token punctuation">,</span>

    <span class="token comment">// 初始化菜单</span>
    init<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> configMenus <span class="token operator">=</span> config<span class="token punctuation">.</span>menus <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获取配置中的菜单</span>

      <span class="token comment">// 根据配置信息，创建菜单</span>
      configMenus<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>menuKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> MenuConstructor <span class="token operator">=</span> MenuConstructors<span class="token punctuation">[</span>menuKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MenuConstructor <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> MenuConstructor <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 创建单个菜单</span>
          _this<span class="token punctuation">.</span>menus<span class="token punctuation">[</span>menuKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MenuConstructor</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 添加到菜单栏</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addToToolbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 绑定事件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 添加到菜单栏</span>
    _addToToolbar<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_addToToolbar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $toolbarElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$toolbarElem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> menus <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>menus<span class="token punctuation">;</span>
      <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
      <span class="token comment">// config.zIndex 是配置的编辑区域的 z-index，菜单的 z-index 得在其基础上 +1</span>
      <span class="token keyword">var</span> zIndex <span class="token operator">=</span> config<span class="token punctuation">.</span>zIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token function">objForEach</span><span class="token punctuation">(</span>menus<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> menu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> $elem <span class="token operator">=</span> menu<span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>$elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 设置 z-index</span>
          $elem<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'z-index'</span><span class="token punctuation">,</span> zIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
          $toolbarElem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 绑定菜单 click mouseenter 事件</span>
    _bindEvent<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> menus <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>menus<span class="token punctuation">;</span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token function">objForEach</span><span class="token punctuation">(</span>menus<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> menu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> type <span class="token operator">=</span> menu<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> $elem <span class="token operator">=</span> menu<span class="token punctuation">.</span>$elem<span class="token punctuation">;</span>
        <span class="token keyword">var</span> droplist <span class="token operator">=</span> menu<span class="token punctuation">.</span>droplist<span class="token punctuation">;</span>
        <span class="token keyword">var</span> panel <span class="token operator">=</span> menu<span class="token punctuation">.</span>panel<span class="token punctuation">;</span>

        <span class="token comment">// 点击类型，例如 bold</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'click'</span> <span class="token operator">&amp;&amp;</span> menu<span class="token punctuation">.</span>onClick<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          $elem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            menu<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 下拉框，例如 head</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'droplist'</span> <span class="token operator">&amp;&amp;</span> droplist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          $elem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'mouseenter'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 显示</span>
            droplist<span class="token punctuation">.</span>showTimeoutId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              droplist<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'mouseleave'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 隐藏</span>
            droplist<span class="token punctuation">.</span>hideTimeoutId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              droplist<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 弹框类型，例如 link</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'panel'</span> <span class="token operator">&amp;&amp;</span> menu<span class="token punctuation">.</span>onClick<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          $elem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 在自定义事件中显示 panel</span>
            menu<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 尝试修改菜单状态</span>
    changeActive<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">changeActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> menus <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>menus<span class="token punctuation">;</span>
      <span class="token function">objForEach</span><span class="token punctuation">(</span>menus<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> menu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>menu<span class="token punctuation">.</span>tryChangeActive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            menu<span class="token punctuation">.</span><span class="token function">tryChangeActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    粘贴信息的处理
*/</span>

<span class="token comment">// 获取粘贴的纯文本</span>
  <span class="token keyword">function</span> <span class="token function">getPasteText</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> clipboardData <span class="token operator">=</span> e<span class="token punctuation">.</span>clipboardData <span class="token operator">||</span> e<span class="token punctuation">.</span>originalEvent <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>originalEvent<span class="token punctuation">.</span>clipboardData<span class="token punctuation">;</span>
    <span class="token keyword">var</span> pasteText <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clipboardData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      pasteText <span class="token operator">=</span> window<span class="token punctuation">.</span>clipboardData <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      pasteText <span class="token operator">=</span> clipboardData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">replaceHtmlSymbol</span><span class="token punctuation">(</span>pasteText<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 获取粘贴的html</span>
  <span class="token keyword">function</span> <span class="token function">getPasteHtml</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> filterStyle<span class="token punctuation">,</span> ignoreImg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> clipboardData <span class="token operator">=</span> e<span class="token punctuation">.</span>clipboardData <span class="token operator">||</span> e<span class="token punctuation">.</span>originalEvent <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>originalEvent<span class="token punctuation">.</span>clipboardData<span class="token punctuation">;</span>
    <span class="token keyword">var</span> pasteText <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
      pasteHtml <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clipboardData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      pasteText <span class="token operator">=</span> window<span class="token punctuation">.</span>clipboardData <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      pasteText <span class="token operator">=</span> clipboardData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pasteHtml <span class="token operator">=</span> clipboardData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pasteHtml <span class="token operator">&amp;&amp;</span> pasteText<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      pasteHtml <span class="token operator">=</span> <span class="token string">'&lt;p&gt;'</span> <span class="token operator">+</span> <span class="token function">replaceHtmlSymbol</span><span class="token punctuation">(</span>pasteText<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pasteHtml<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 过滤word中状态过来的无用字符</span>
    <span class="token keyword">var</span> docSplitHtml <span class="token operator">=</span> pasteHtml<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'&lt;/html&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>docSplitHtml<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      pasteHtml <span class="token operator">=</span> docSplitHtml<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 过滤无用标签</span>
    pasteHtml <span class="token operator">=</span> pasteHtml<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;(meta|script|link).+?&gt;/igm</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 去掉注释</span>
    pasteHtml <span class="token operator">=</span> pasteHtml<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;!--.*?--&gt;/mg</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 过滤 data-xxx 属性</span>
    pasteHtml <span class="token operator">=</span> pasteHtml<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\s?data-.+?=('|").+?('|")/igm</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoreImg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 忽略图片</span>
      pasteHtml <span class="token operator">=</span> pasteHtml<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;img.+?&gt;/igm</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>filterStyle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 过滤样式</span>
      pasteHtml <span class="token operator">=</span> pasteHtml<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\s?(class|style)=('|").*?('|")/igm</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 保留样式</span>
      pasteHtml <span class="token operator">=</span> pasteHtml<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\s?class=('|").*?('|")/igm</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> pasteHtml<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 获取粘贴的图片文件</span>
  <span class="token keyword">function</span> <span class="token function">getPasteImgs</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> txt <span class="token operator">=</span> <span class="token function">getPasteText</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 有文字，就忽略图片</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> clipboardData <span class="token operator">=</span> e<span class="token punctuation">.</span>clipboardData <span class="token operator">||</span> e<span class="token punctuation">.</span>originalEvent <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>originalEvent<span class="token punctuation">.</span>clipboardData <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> items <span class="token operator">=</span> clipboardData<span class="token punctuation">.</span>items<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>items<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">objForEach</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> type <span class="token operator">=</span> value<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/image/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getAsFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
    编辑区域
*/</span>

<span class="token comment">// 获取一个 elem.childNodes 的 JSON 数据</span>
  <span class="token keyword">function</span> <span class="token function">getChildrenJSON</span><span class="token punctuation">(</span>$elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> $children <span class="token operator">=</span> $elem<span class="token punctuation">.</span><span class="token function">childNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 注意 childNodes() 可以获取文本节点</span>
    $children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>curElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> elemResult <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> nodeType <span class="token operator">=</span> curElem<span class="token punctuation">.</span>nodeType<span class="token punctuation">;</span>

      <span class="token comment">// 文本节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeType <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        elemResult <span class="token operator">=</span> curElem<span class="token punctuation">.</span>textContent<span class="token punctuation">;</span>
        elemResult <span class="token operator">=</span> <span class="token function">replaceHtmlSymbol</span><span class="token punctuation">(</span>elemResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 普通 DOM 节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        elemResult <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// tag</span>
        elemResult<span class="token punctuation">.</span>tag <span class="token operator">=</span> curElem<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// attr</span>
        <span class="token keyword">var</span> attrData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> attrList <span class="token operator">=</span> curElem<span class="token punctuation">.</span>attributes <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> attrListLength <span class="token operator">=</span> attrList<span class="token punctuation">.</span>length <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> attrListLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> attr <span class="token operator">=</span> attrList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          attrData<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            name<span class="token punctuation">:</span> attr<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> attr<span class="token punctuation">.</span>value
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        elemResult<span class="token punctuation">.</span>attrs <span class="token operator">=</span> attrData<span class="token punctuation">;</span>
        <span class="token comment">// children（递归）</span>
        elemResult<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">getChildrenJSON</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>curElem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>elemResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Text</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 修改原型</span>
  Text<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Text<span class="token punctuation">,</span>

    <span class="token comment">// 初始化</span>
    init<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 绑定事件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 清空内容</span>
    clear<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取 设置 html</span>
    html<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">html</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        html <span class="token operator">=</span> $textElem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 未选中任何内容的时候点击“加粗”或者“斜体”等按钮，就得需要一个空的占位符 &amp;#8203 ，这里替换掉</span>
        html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\u200b/gm</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> html<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        $textElem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化选取，将光标定位到内容尾部</span>
        editor<span class="token punctuation">.</span><span class="token function">initSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取 JSON</span>
    getJSON<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">getChildrenJSON</span><span class="token punctuation">(</span>$textElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取 设置 text</span>
    text<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">text</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> text <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        text <span class="token operator">=</span> $textElem<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 未选中任何内容的时候点击“加粗”或者“斜体”等按钮，就得需要一个空的占位符 &amp;#8203 ，这里替换掉</span>
        text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\u200b/gm</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> text<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        $textElem<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;'</span> <span class="token operator">+</span> val <span class="token operator">+</span> <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化选取，将光标定位到内容尾部</span>
        editor<span class="token punctuation">.</span><span class="token function">initSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 追加内容</span>
    append<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">append</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>
      $textElem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 初始化选取，将光标定位到内容尾部</span>
      editor<span class="token punctuation">.</span><span class="token function">initSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 绑定事件</span>
    _bindEvent<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 实时保存选取</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_saveRangeRealTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 按回车建时的特殊处理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_enterKeyHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 清空时保留 &lt;p&gt;&lt;br&gt;&lt;/p&gt;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_clearHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 粘贴事件（粘贴文字，粘贴图片）</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_pasteHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// tab 特殊处理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_tabHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// img 点击</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_imgHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 拖拽事件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_dragHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 实时保存选取</span>
    _saveRangeRealTime<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_saveRangeRealTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>

      <span class="token comment">// 保存当前的选区</span>
      <span class="token keyword">function</span> <span class="token function">saveRange</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 随时保存选区</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">saveRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新按钮 ative 状态</span>
        editor<span class="token punctuation">.</span>menus<span class="token punctuation">.</span><span class="token function">changeActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 按键后保存</span>
      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> saveRange<span class="token punctuation">)</span><span class="token punctuation">;</span>
      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// mousedown 状态下，鼠标滑动到编辑区域外面，也需要保存选区</span>
        $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'mouseleave'</span><span class="token punctuation">,</span> saveRange<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">saveRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 在编辑器区域之内完成点击，取消鼠标滑动到编辑区外面的事件</span>
        $textElem<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">'mouseleave'</span><span class="token punctuation">,</span> saveRange<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 按回车键时的特殊处理</span>
    _enterKeyHandle<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_enterKeyHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">insertEmptyP</span><span class="token punctuation">(</span>$selectionElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> $p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $p<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>$selectionElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createRangeByElem</span><span class="token punctuation">(</span>$p<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $selectionElem<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 将回车之后生成的非 &lt;p&gt; 的顶级标签，改为 &lt;p&gt;</span>
      <span class="token keyword">function</span> <span class="token function">pHandle</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> $selectionElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> $parentElem <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>$parentElem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'&lt;code&gt;&lt;br&gt;&lt;/code&gt;'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 回车之前光标所在一个 &lt;p&gt;&lt;code&gt;.....&lt;/code&gt;&lt;/p&gt; ，忽然回车生成一个空的 &lt;p&gt;&lt;code&gt;&lt;br&gt;&lt;/code&gt;&lt;/p&gt;</span>
          <span class="token comment">// 而且继续回车跳不出去，因此只能特殊处理</span>
          <span class="token function">insertEmptyP</span><span class="token punctuation">(</span>$selectionElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$parentElem<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>$textElem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 不是顶级标签</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> nodeName <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeName <span class="token operator">===</span> <span class="token string">'P'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 当前的标签是 P ，不用做处理</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>$selectionElem<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 有内容，不做处理</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 插入 &lt;p&gt; ，并将选取定位到 &lt;p&gt;，删除当前标签</span>
        <span class="token function">insertEmptyP</span><span class="token punctuation">(</span>$selectionElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>keyCode <span class="token operator">!==</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 不是回车键</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将回车之后生成的非 &lt;p&gt; 的顶级标签，改为 &lt;p&gt;</span>
        <span class="token function">pHandle</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// &lt;pre&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt; 回车时 特殊处理</span>
      <span class="token keyword">function</span> <span class="token function">codeHandle</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> $selectionElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> $parentElem <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> selectionNodeName <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> parentNodeName <span class="token operator">=</span> $parentElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectionNodeName <span class="token operator">!==</span> <span class="token string">'CODE'</span> <span class="token operator">||</span> parentNodeName <span class="token operator">!==</span> <span class="token string">'PRE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 不符合要求 忽略</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandSupported</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 必须原生支持 insertHTML 命令</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 处理：光标定位到代码末尾，联系点击两次回车，即跳出代码块</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>_willBreakCode <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 此时可以跳出代码块</span>
          <span class="token comment">// 插入 &lt;p&gt; ，并将选取定位到 &lt;p&gt;</span>
          <span class="token keyword">var</span> $p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          $p<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span>$parentElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
          editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createRangeByElem</span><span class="token punctuation">(</span>$p<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 修改状态</span>
          editor<span class="token punctuation">.</span>_willBreakCode <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

          e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> _startOffset <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startOffset<span class="token punctuation">;</span>

        <span class="token comment">// 处理：回车时，不能插入 &lt;br&gt; 而是插入 \n ，因为是在 pre 标签里面</span>
        editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">saveRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startOffset <span class="token operator">===</span> _startOffset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 没起作用，再来一遍</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> codeLength <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startOffset <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">===</span> codeLength<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 说明光标在代码最后的位置，执行了回车操作</span>
          <span class="token comment">// 记录下来，以便下次回车时候跳出 code</span>
          editor<span class="token punctuation">.</span>_willBreakCode <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 阻止默认行为</span>
        e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>keyCode <span class="token operator">!==</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 不是回车键</span>
          <span class="token comment">// 取消即将跳转代码块的记录</span>
          editor<span class="token punctuation">.</span>_willBreakCode <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &lt;pre&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt; 回车时 特殊处理</span>
        <span class="token function">codeHandle</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 清空时保留 &lt;p&gt;&lt;br&gt;&lt;/p&gt;</span>
    _clearHandle<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_clearHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>

      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>keyCode <span class="token operator">!==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> txtHtml <span class="token operator">=</span> $textElem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txtHtml <span class="token operator">===</span> <span class="token string">'&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 最后剩下一个空行，就不再删除了</span>
          e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>keyCode <span class="token operator">!==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> $p <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> txtHtml <span class="token operator">=</span> $textElem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// firefox 时用 txtHtml === '&lt;br&gt;' 判断，其他用 !txtHtml 判断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>txtHtml <span class="token operator">||</span> txtHtml <span class="token operator">===</span> <span class="token string">'&lt;br&gt;'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 内容空了</span>
          $p <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;&lt;br/&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          $textElem<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一定要先清空，否则在 firefox 下有问题</span>
          $textElem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$p<span class="token punctuation">)</span><span class="token punctuation">;</span>
          editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createRangeByElem</span><span class="token punctuation">(</span>$p<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 粘贴事件（粘贴文字 粘贴图片）</span>
    _pasteHandle<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_pasteHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
      <span class="token keyword">var</span> pasteFilterStyle <span class="token operator">=</span> config<span class="token punctuation">.</span>pasteFilterStyle<span class="token punctuation">;</span>
      <span class="token keyword">var</span> pasteTextHandle <span class="token operator">=</span> config<span class="token punctuation">.</span>pasteTextHandle<span class="token punctuation">;</span>
      <span class="token keyword">var</span> ignoreImg <span class="token operator">=</span> config<span class="token punctuation">.</span>pasteIgnoreImg<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>

      <span class="token comment">// 粘贴图片、文本的事件，每次只能执行一个</span>
      <span class="token comment">// 判断该次粘贴事件是否可以执行</span>
      <span class="token keyword">var</span> pasteTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">canDo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> pasteTime <span class="token operator">&gt;=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 间隔大于 100 ms ，可以执行</span>
          flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pasteTime <span class="token operator">=</span> now<span class="token punctuation">;</span>
        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">function</span> <span class="token function">resetTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pasteTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 粘贴文字</span>
      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'paste'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UA</span><span class="token punctuation">.</span><span class="token function">isIE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 阻止默认行为，使用 execCommand 的粘贴命令</span>
          e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 粘贴图片和文本，只能同时使用一个</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canDo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取粘贴的文字</span>
        <span class="token keyword">var</span> pasteHtml <span class="token operator">=</span> <span class="token function">getPasteHtml</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> pasteFilterStyle<span class="token punctuation">,</span> ignoreImg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> pasteText <span class="token operator">=</span> <span class="token function">getPasteText</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pasteText <span class="token operator">=</span> pasteText<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\n/gm</span><span class="token punctuation">,</span> <span class="token string">'&lt;br&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> $selectionElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> nodeName <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// code 中只能粘贴纯文本</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeName <span class="token operator">===</span> <span class="token string">'CODE'</span> <span class="token operator">||</span> nodeName <span class="token operator">===</span> <span class="token string">'PRE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pasteTextHandle <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>pasteTextHandle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 用户自定义过滤处理粘贴内容</span>
            pasteText <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">pasteTextHandle</span><span class="token punctuation">(</span>pasteText<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'&lt;p&gt;'</span> <span class="token operator">+</span> pasteText <span class="token operator">+</span> <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 先放开注释，有问题再追查 ————</span>
        <span class="token comment">// // 表格中忽略，可能会出现异常问题</span>
        <span class="token comment">// if (nodeName === 'TD' || nodeName === 'TH') {<!-- --></span>
        <span class="token comment">//     return</span>
        <span class="token comment">// }</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pasteHtml<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 没有内容，可继续执行下面的图片粘贴</span>
          <span class="token function">resetTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// firefox 中，获取的 pasteHtml 可能是没有 &lt;ul&gt; 包裹的 &lt;li&gt;</span>
          <span class="token comment">// 因此执行 insertHTML 会报错</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pasteTextHandle <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>pasteTextHandle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 用户自定义过滤处理粘贴内容</span>
            pasteHtml <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">pasteTextHandle</span><span class="token punctuation">(</span>pasteHtml<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> pasteHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ex</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 此时使用 pasteText 来兼容一下</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pasteTextHandle <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>pasteTextHandle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 用户自定义过滤处理粘贴内容</span>
            pasteText <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">pasteTextHandle</span><span class="token punctuation">(</span>pasteText<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'&lt;p&gt;'</span> <span class="token operator">+</span> pasteText <span class="token operator">+</span> <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 粘贴图片</span>
      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'paste'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UA</span><span class="token punctuation">.</span><span class="token function">isIE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 粘贴图片和文本，只能同时使用一个</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canDo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取粘贴的图片</span>
        <span class="token keyword">var</span> pasteFiles <span class="token operator">=</span> <span class="token function">getPasteImgs</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pasteFiles <span class="token operator">||</span> <span class="token operator">!</span>pasteFiles<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取当前的元素</span>
        <span class="token keyword">var</span> $selectionElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> nodeName <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// code 中粘贴忽略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeName <span class="token operator">===</span> <span class="token string">'CODE'</span> <span class="token operator">||</span> nodeName <span class="token operator">===</span> <span class="token string">'PRE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 上传图片</span>
        <span class="token keyword">var</span> uploadImg <span class="token operator">=</span> editor<span class="token punctuation">.</span>uploadImg<span class="token punctuation">;</span>
        uploadImg<span class="token punctuation">.</span><span class="token function">uploadImg</span><span class="token punctuation">(</span>pasteFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// tab 特殊处理</span>
    _tabHandle<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_tabHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>

      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>keyCode <span class="token operator">!==</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">queryCommandSupported</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 必须原生支持 insertHTML 命令</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> $selectionElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$selectionElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> $parentElem <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> selectionNodeName <span class="token operator">=</span> $selectionElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> parentNodeName <span class="token operator">=</span> $parentElem<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectionNodeName <span class="token operator">===</span> <span class="token string">'CODE'</span> <span class="token operator">&amp;&amp;</span> parentNodeName <span class="token operator">===</span> <span class="token string">'PRE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// &lt;pre&gt;&lt;code&gt; 里面</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'    '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 普通文字</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// img 点击</span>
    _imgHandle<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_imgHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>

      <span class="token comment">// 为图片增加 selected 样式</span>
      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> img <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> $img <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>$img<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'data-w-e'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 是表情图片，忽略</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 记录当前点击过的图片</span>
        editor<span class="token punctuation">.</span>_selectedImg <span class="token operator">=</span> $img<span class="token punctuation">;</span>

        <span class="token comment">// 修改选区并 restore ，防止用户此时点击退格键，会删除其他内容</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createRangeByElem</span><span class="token punctuation">(</span>$img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 去掉图片的 selected 样式</span>
      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click  keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 点击的是图片，忽略</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 删除记录</span>
        editor<span class="token punctuation">.</span>_selectedImg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 拖拽事件</span>
    _dragHandle<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_dragHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>

      <span class="token comment">// 禁用 document 拖拽事件</span>
      <span class="token keyword">var</span> $document <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
      $document<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'dragleave drop dragenter dragover'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 添加编辑区域拖拽事件</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>
      $textElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'drop'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> files <span class="token operator">=</span> e<span class="token punctuation">.</span>dataTransfer <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span>files<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files <span class="token operator">||</span> <span class="token operator">!</span>files<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 上传图片</span>
        <span class="token keyword">var</span> uploadImg <span class="token operator">=</span> editor<span class="token punctuation">.</span>uploadImg<span class="token punctuation">;</span>
        uploadImg<span class="token punctuation">.</span><span class="token function">uploadImg</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    命令，封装 document.execCommand
*/</span>

<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Command</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 修改原型</span>
  Command<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Command<span class="token punctuation">,</span>

    <span class="token comment">// 执行命令</span>
    <span class="token keyword">do</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_do</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>

      <span class="token comment">// 使用 styleWithCSS</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>editor<span class="token punctuation">.</span>_useStyleWithCSS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">'styleWithCSS'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        editor<span class="token punctuation">.</span>_useStyleWithCSS <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 如果无选区，忽略</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 恢复选取</span>
      editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 执行</span>
      <span class="token keyword">var</span> _name <span class="token operator">=</span> <span class="token string">'_'</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>_name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 有自定义事件</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>_name<span class="token punctuation">]</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 默认 command</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_execCommand</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 修改菜单状态</span>
      editor<span class="token punctuation">.</span>menus<span class="token punctuation">.</span><span class="token function">changeActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 最后，恢复选取保证光标在原来的位置闪烁</span>
      editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">saveRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 触发 onchange</span>
      editor<span class="token punctuation">.</span>change <span class="token operator">&amp;&amp;</span> editor<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 自定义 insertHTML 事件</span>
    _insertHTML<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_insertHTML</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> range <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryCommandSupported</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// W3C</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_execCommand</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>insertNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// IE</span>
        range<span class="token punctuation">.</span><span class="token function">deleteContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        range<span class="token punctuation">.</span><span class="token function">insertNode</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>pasteHTML<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// IE &lt;= 10</span>
        range<span class="token punctuation">.</span><span class="token function">pasteHTML</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 插入 elem</span>
    _insertElem<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_insertElem</span><span class="token punctuation">(</span>$elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> range <span class="token operator">=</span> editor<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>insertNode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        range<span class="token punctuation">.</span><span class="token function">deleteContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        range<span class="token punctuation">.</span><span class="token function">insertNode</span><span class="token punctuation">(</span>$elem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 封装 execCommand</span>
    _execCommand<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_execCommand</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 封装 document.queryCommandValue</span>
    queryCommandValue<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">queryCommandValue</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">queryCommandValue</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 封装 document.queryCommandState</span>
    queryCommandState<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">queryCommandState</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">queryCommandState</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 封装 document.queryCommandSupported</span>
    queryCommandSupported<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">queryCommandSupported</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">queryCommandSupported</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    selection range API
*/</span>

<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token constant">API</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 修改原型</span>
  <span class="token constant">API</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> <span class="token constant">API</span><span class="token punctuation">,</span>

    <span class="token comment">// 获取 range 对象</span>
    getRange<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 保存选区</span>
    saveRange<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">saveRange</span><span class="token punctuation">(</span>_range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 保存已有选区</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange <span class="token operator">=</span> _range<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 获取当前的选区</span>
      <span class="token keyword">var</span> selection <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>selection<span class="token punctuation">.</span>rangeCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> range <span class="token operator">=</span> selection<span class="token punctuation">.</span><span class="token function">getRangeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 判断选区内容是否在编辑内容之内</span>
      <span class="token keyword">var</span> $containerElem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$containerElem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 判断选区内容是否在不可编辑区域之内</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$containerElem<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'contenteditable'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'false'</span> <span class="token operator">||</span> $containerElem<span class="token punctuation">.</span><span class="token function">parentUntil</span><span class="token punctuation">(</span><span class="token string">'[contenteditable=false]'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$textElem<span class="token punctuation">.</span><span class="token function">isContain</span><span class="token punctuation">(</span>$containerElem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 是编辑内容之内的</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange <span class="token operator">=</span> range<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 折叠选区</span>
    collapseRange<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">collapseRange</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>toStart <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 默认为 false</span>
        toStart <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        range<span class="token punctuation">.</span><span class="token function">collapse</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 选中区域的文字</span>
    getSelectionText<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">getSelectionText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 选区的 $Elem</span>
    getSelectionContainerElem<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">getSelectionContainerElem</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      range <span class="token operator">=</span> range <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange<span class="token punctuation">;</span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        elem <span class="token operator">=</span> range<span class="token punctuation">.</span>commonAncestorContainer<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> elem <span class="token punctuation">:</span> elem<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getSelectionStartElem<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">getSelectionStartElem</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      range <span class="token operator">=</span> range <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange<span class="token punctuation">;</span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        elem <span class="token operator">=</span> range<span class="token punctuation">.</span>startContainer<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> elem <span class="token punctuation">:</span> elem<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getSelectionEndElem<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">getSelectionEndElem</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      range <span class="token operator">=</span> range <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange<span class="token punctuation">;</span>
      <span class="token keyword">var</span> elem <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        elem <span class="token operator">=</span> range<span class="token punctuation">.</span>endContainer<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> elem <span class="token punctuation">:</span> elem<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 选区是否为空</span>
    isSelectionEmpty<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">isSelectionEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">&amp;&amp;</span> range<span class="token punctuation">.</span>startContainer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>startContainer <span class="token operator">===</span> range<span class="token punctuation">.</span>endContainer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>range<span class="token punctuation">.</span>startOffset <span class="token operator">===</span> range<span class="token punctuation">.</span>endOffset<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 恢复选区</span>
    restoreSelection<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> selection <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      selection<span class="token punctuation">.</span><span class="token function">removeAllRanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      selection<span class="token punctuation">.</span><span class="token function">addRange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentRange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 创建一个空白（即 &amp;#8203 字符）选区</span>
    createEmptyRange<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">createEmptyRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> $elem <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前无 range</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isSelectionEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前选区必须没有内容才可以</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 目前只支持 webkit 内核</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UA</span><span class="token punctuation">.</span><span class="token function">isWebkit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 插入 &amp;#8203</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'&amp;#8203;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 修改 offset 位置</span>
          range<span class="token punctuation">.</span><span class="token function">setEnd</span><span class="token punctuation">(</span>range<span class="token punctuation">.</span>endContainer<span class="token punctuation">,</span> range<span class="token punctuation">.</span>endOffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 存储</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          $elem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;strong&gt;&amp;#8203;&lt;/strong&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertElem'</span><span class="token punctuation">,</span> $elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRangeByElem</span><span class="token punctuation">(</span>$elem<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ex</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 部分情况下会报错，兼容一下</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 根据 $Elem 设置选区</span>
    createRangeByElem<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">createRangeByElem</span><span class="token punctuation">(</span>$elem<span class="token punctuation">,</span> toStart<span class="token punctuation">,</span> isContent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// $elem - 经过封装的 elem</span>
      <span class="token comment">// toStart - true 开始位置，false 结束位置</span>
      <span class="token comment">// isContent - 是否选中Elem的内容</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$elem<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> elem <span class="token operator">=</span> $elem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> range <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>isContent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        range<span class="token punctuation">.</span><span class="token function">selectNodeContents</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        range<span class="token punctuation">.</span><span class="token function">selectNode</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> toStart <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        range<span class="token punctuation">.</span><span class="token function">collapse</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 存储 range</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    上传进度条
*/</span>

  <span class="token keyword">function</span> <span class="token function">Progress</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_isShow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_isRender <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_timeoutId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$textContainer <span class="token operator">=</span> editor<span class="token punctuation">.</span>$textContainerElem<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$bar <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div class="w-e-progress"&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Progress<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Progress<span class="token punctuation">,</span>

    show<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token comment">// 状态处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isShow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_isShow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token comment">// 渲染</span>
      <span class="token keyword">var</span> $bar <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$bar<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isRender<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> $textContainer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$textContainer<span class="token punctuation">;</span>
        $textContainer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$bar<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_isRender <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 改变进度（节流，100ms 渲染一次）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          $bar<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">,</span> progress <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token string">'%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 隐藏</span>
      <span class="token keyword">var</span> timeoutId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_timeoutId<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      timeoutId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _this<span class="token punctuation">.</span><span class="token function">_hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    _hide<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> $bar <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$bar<span class="token punctuation">;</span>
      $bar<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 修改状态</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_isShow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_isRender <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> _typeof <span class="token operator">=</span> <span class="token keyword">typeof</span> Symbol <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Symbol<span class="token punctuation">.</span>iterator <span class="token operator">===</span> <span class="token string">"symbol"</span> <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Symbol <span class="token operator">===</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Symbol <span class="token operator">&amp;&amp;</span> obj <span class="token operator">!==</span> Symbol<span class="token punctuation">.</span>prototype <span class="token operator">?</span> <span class="token string">"symbol"</span> <span class="token punctuation">:</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    上传图片
*/</span>

<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">UploadImg</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 原型</span>
  UploadImg<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> UploadImg<span class="token punctuation">,</span>

    <span class="token comment">// 根据 debug 弹出不同的信息</span>
    _alert<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_alert</span><span class="token punctuation">(</span>alertInfo<span class="token punctuation">,</span> debugInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> debug <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">.</span>debug<span class="token punctuation">;</span>
      <span class="token keyword">var</span> customAlert <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">.</span>customAlert<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'wangEditor: '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>debugInfo <span class="token operator">||</span> alertInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>customAlert <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> customAlert <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">customAlert</span><span class="token punctuation">(</span>alertInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">alert</span><span class="token punctuation">(</span>alertInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 根据链接插入图片</span>
    insertLinkImg<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">insertLinkImg</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>link<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

      <span class="token comment">// 校验格式</span>
      <span class="token keyword">var</span> linkImgCheck <span class="token operator">=</span> config<span class="token punctuation">.</span>linkImgCheck<span class="token punctuation">;</span>
      <span class="token keyword">var</span> checkResult <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>linkImgCheck <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> linkImgCheck <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        checkResult <span class="token operator">=</span> <span class="token function">linkImgCheck</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> checkResult <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 校验失败，提示信息</span>
          <span class="token function">alert</span><span class="token punctuation">(</span>checkResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/*jpg|jpeg|png|bmp|gif|webp|mp3|mp4*/</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> link<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> link<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.jpg'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> link<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.jpeg'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> link<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.bmp'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> link<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.gif'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'&lt;img src="'</span> <span class="token operator">+</span> link <span class="token operator">+</span> <span class="token string">'" style="max-width:100%;"/&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        editor<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token keyword">do</span><span class="token punctuation">(</span><span class="token string">'insertHTML'</span><span class="token punctuation">,</span> <span class="token string">'&lt;video src="'</span> <span class="token operator">+</span> link <span class="token operator">+</span> <span class="token string">'" style="max-width:100%;"  controls="controls"/&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>



      <span class="token comment">// 验证图片 url 是否有效，无效的话给出提示</span>
      <span class="token comment">// var img = document.createElement('img');</span>
      <span class="token comment">// img.onload = function () {<!-- --></span>
      <span class="token comment">//   var callback = config.linkImgCallback;</span>
      <span class="token comment">//   if (callback &amp;&amp; typeof callback === 'function') {<!-- --></span>
      <span class="token comment">//     callback(link);</span>
      <span class="token comment">//   }</span>
      <span class="token comment">//</span>
      <span class="token comment">//   img = null;</span>
      <span class="token comment">// };</span>
      <span class="token comment">// img.onerror = function () {<!-- --></span>
      <span class="token comment">//   img = null;</span>
      <span class="token comment">//   // 无法成功下载图片</span>
      <span class="token comment">//   _this2._alert('插入图片错误', 'wangEditor: \u63D2\u5165\u56FE\u7247\u51FA\u9519\uFF0C\u56FE\u7247\u94FE\u63A5\u662F "' + link + '"\uFF0C\u4E0B\u8F7D\u8BE5\u94FE\u63A5\u5931\u8D25');</span>
      <span class="token comment">//   return;</span>
      <span class="token comment">// };</span>
      <span class="token comment">// img.onabort = function () {<!-- --></span>
      <span class="token comment">//   img = null;</span>
      <span class="token comment">// };</span>
      <span class="token comment">//img.src = link;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 上传图片</span>
    uploadImg<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">uploadImg</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files <span class="token operator">||</span> <span class="token operator">!</span>files<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// ------------------------------ 获取配置信息 ------------------------------</span>
      <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">;</span>
      <span class="token keyword">var</span> config <span class="token operator">=</span> editor<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
      <span class="token keyword">var</span> uploadImgServer <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadImgServer<span class="token punctuation">;</span>
      <span class="token keyword">var</span> uploadImgShowBase64 <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadImgShowBase64<span class="token punctuation">;</span>

      <span class="token keyword">var</span> maxSize <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadImgMaxSize<span class="token punctuation">;</span>
      <span class="token keyword">var</span> maxSizeM <span class="token operator">=</span> maxSize <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> maxLength <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadImgMaxLength <span class="token operator">||</span> <span class="token number">10000</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> uploadFileName <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadFileName <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> uploadImgParams <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadImgParams <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> uploadImgParamsWithUrl <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadImgParamsWithUrl<span class="token punctuation">;</span>
      <span class="token keyword">var</span> uploadImgHeaders <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadImgHeaders <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> hooks <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadImgHooks <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> timeout <span class="token operator">=</span> config<span class="token punctuation">.</span>uploadImgTimeout <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> withCredentials <span class="token operator">=</span> config<span class="token punctuation">.</span>withCredentials<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>withCredentials <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        withCredentials <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> customUploadImg <span class="token operator">=</span> config<span class="token punctuation">.</span>customUploadImg<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>customUploadImg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 没有 customUploadImg 的情况下，需要如下两个配置才能继续进行图片上传</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uploadImgServer <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>uploadImgShowBase64<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// ------------------------------ 验证文件信息 ------------------------------</span>
      <span class="token keyword">var</span> resultFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> errInfo <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">arrForEach</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> name <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token keyword">var</span> size <span class="token operator">=</span> file<span class="token punctuation">.</span>size<span class="token punctuation">;</span>

        <span class="token comment">// chrome 低版本 name === undefined</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span>size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\.(jpg|jpeg|png|bmp|gif|webp|mp3|mp4)$/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 后缀名不合法，不是图片</span>
          errInfo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'\u3010'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'\u3011\u4E0D\u662F\u56FE\u7247'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxSize <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 上传图片过大</span>
          errInfo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'\u3010'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'\u3011\u5927\u4E8E '</span> <span class="token operator">+</span> maxSizeM <span class="token operator">+</span> <span class="token string">'M'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 验证通过的加入结果列表</span>
        resultFiles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 抛出验证信息</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errInfo<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_alert</span><span class="token punctuation">(</span><span class="token string">'图片验证未通过: \n'</span> <span class="token operator">+</span> errInfo<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>resultFiles<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> maxLength<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_alert</span><span class="token punctuation">(</span><span class="token string">'一次最多上传'</span> <span class="token operator">+</span> maxLength <span class="token operator">+</span> <span class="token string">'张图片'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// ------------------------------ 自定义上传 ------------------------------</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>customUploadImg <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> customUploadImg <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">customUploadImg</span><span class="token punctuation">(</span>resultFiles<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>insertLinkImg<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 阻止以下代码执行</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 添加图片数据</span>
      <span class="token keyword">var</span> formdata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">arrForEach</span><span class="token punctuation">(</span>resultFiles<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> name <span class="token operator">=</span> uploadFileName <span class="token operator">||</span> file<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        formdata<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// ------------------------------ 上传图片 ------------------------------</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadImgServer <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> uploadImgServer <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 添加参数</span>
        <span class="token keyword">var</span> uploadImgServerArr <span class="token operator">=</span> uploadImgServer<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uploadImgServer <span class="token operator">=</span> uploadImgServerArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> uploadImgServerHash <span class="token operator">=</span> uploadImgServerArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token function">objForEach</span><span class="token punctuation">(</span>uploadImgParams<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 因使用者反应，自定义参数不能默认 encode ，由 v3.1.1 版本开始注释掉</span>
          <span class="token comment">// val = encodeURIComponent(val)</span>

          <span class="token comment">// 第一，将参数拼接到 url 中</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadImgParamsWithUrl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadImgServer<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              uploadImgServer <span class="token operator">+=</span> <span class="token string">'&amp;'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              uploadImgServer <span class="token operator">+=</span> <span class="token string">'?'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            uploadImgServer <span class="token operator">=</span> uploadImgServer <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> val<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 第二，将参数添加到 formdata 中</span>
          formdata<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadImgServerHash<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          uploadImgServer <span class="token operator">+=</span> <span class="token string">'#'</span> <span class="token operator">+</span> uploadImgServerHash<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 定义 xhr</span>
        <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> uploadImgServer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置超时</span>
        xhr<span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span><span class="token function-variable function">ontimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// hook - timeout</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span>timeout <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> hooks<span class="token punctuation">.</span>timeout <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            hooks<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          _this3<span class="token punctuation">.</span><span class="token function">_alert</span><span class="token punctuation">(</span><span class="token string">'上传图片超时'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 监控 progress</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>upload<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> percent <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// 进度条</span>
            <span class="token keyword">var</span> progressBar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Progress</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              percent <span class="token operator">=</span> e<span class="token punctuation">.</span>loaded <span class="token operator">/</span> e<span class="token punctuation">.</span>total<span class="token punctuation">;</span>
              progressBar<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span>percent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 返回数据</span>
        xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">200</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// hook - error</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span>error <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> hooks<span class="token punctuation">.</span>error <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                hooks<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token comment">// xhr 返回状态错误</span>
              _this3<span class="token punctuation">.</span><span class="token function">_alert</span><span class="token punctuation">(</span><span class="token string">'上传图片发生错误'</span><span class="token punctuation">,</span> <span class="token string">'\u4E0A\u4F20\u56FE\u7247\u53D1\u751F\u9519\u8BEF\uFF0C\u670D\u52A1\u5668\u8FD4\u56DE\u72B6\u6001\u662F '</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            result <span class="token operator">=</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> <span class="token string">'undefined'</span> <span class="token punctuation">:</span> <span class="token function">_typeof</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                result <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ex</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// hook - fail</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span>fail <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> hooks<span class="token punctuation">.</span>fail <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  hooks<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                _this3<span class="token punctuation">.</span><span class="token function">_alert</span><span class="token punctuation">(</span><span class="token string">'上传图片失败'</span><span class="token punctuation">,</span> <span class="token string">'上传图片返回结果错误，返回结果是: '</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hooks<span class="token punctuation">.</span>customInsert <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>errno <span class="token operator">!=</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// hook - fail</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span>fail <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> hooks<span class="token punctuation">.</span>fail <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                hooks<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token comment">// 数据错误</span>
              _this3<span class="token punctuation">.</span><span class="token function">_alert</span><span class="token punctuation">(</span><span class="token string">'上传图片失败'</span><span class="token punctuation">,</span> <span class="token string">'上传图片返回结果错误，返回结果 errno='</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span>customInsert <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> hooks<span class="token punctuation">.</span>customInsert <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 使用者自定义插入方法</span>
                hooks<span class="token punctuation">.</span><span class="token function">customInsert</span><span class="token punctuation">(</span>_this3<span class="token punctuation">.</span>insertLinkImg<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_this3<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">,</span> editor<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 将图片插入编辑器</span>
                <span class="token keyword">var</span> data <span class="token operator">=</span> result<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  _this3<span class="token punctuation">.</span><span class="token function">insertLinkImg</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token comment">// hook - success</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span>success <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> hooks<span class="token punctuation">.</span>success <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                hooks<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// hook - before</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span>before <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> hooks<span class="token punctuation">.</span>before <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> beforeResult <span class="token operator">=</span> hooks<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>xhr<span class="token punctuation">,</span> editor<span class="token punctuation">,</span> resultFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>beforeResult <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> beforeResult <span class="token operator">===</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> <span class="token string">'undefined'</span> <span class="token punctuation">:</span> <span class="token function">_typeof</span><span class="token punctuation">(</span>beforeResult<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>beforeResult<span class="token punctuation">.</span>prevent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 如果返回的结果是 {prevent: true, msg: 'xxxx'} 则表示用户放弃上传</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_alert</span><span class="token punctuation">(</span>beforeResult<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 自定义 headers</span>
        <span class="token function">objForEach</span><span class="token punctuation">(</span>uploadImgHeaders<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 跨域传 cookie</span>
        xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> withCredentials<span class="token punctuation">;</span>

        <span class="token comment">// 发送请求</span>
        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>formdata<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注意，要 return 。不去操作接下来的 base64 显示方式</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// ------------------------------ 显示 base64 格式 ------------------------------</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadImgShowBase64<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">arrForEach</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> _this <span class="token operator">=</span> _this3<span class="token punctuation">;</span>
          <span class="token keyword">var</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
          reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            _this<span class="token punctuation">.</span><span class="token function">insertLinkImg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
    编辑器构造函数
*/</span>

<span class="token comment">// id，累加</span>
  <span class="token keyword">var</span> editorId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Editor</span><span class="token punctuation">(</span>toolbarSelector<span class="token punctuation">,</span> textSelector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toolbarSelector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 没有传入任何参数，报错</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'错误：初始化编辑器时候未传入任何参数，请查阅文档'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// id，用以区分单个页面不同的编辑器对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'wangEditor-'</span> <span class="token operator">+</span> editorId<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>toolbarSelector <span class="token operator">=</span> toolbarSelector<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>textSelector <span class="token operator">=</span> textSelector<span class="token punctuation">;</span>

    <span class="token comment">// 自定义配置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>customConfig <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 修改原型</span>
  Editor<span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    constructor<span class="token punctuation">:</span> Editor<span class="token punctuation">,</span>

    <span class="token comment">// 初始化配置</span>
    _initConfig<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_initConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// _config 是默认配置，this.customConfig 是用户自定义配置，将它们 merge 之后再赋值</span>
      <span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>customConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 将语言配置，生成正则表达式</span>
      <span class="token keyword">var</span> langConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>lang <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> langArgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">objForEach</span><span class="token punctuation">(</span>langConfig<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// key 即需要生成正则表达式的规则，如“插入链接”</span>
        <span class="token comment">// val 即需要被替换成的语言，如“insert link”</span>
        langArgs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          reg<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          val<span class="token punctuation">:</span> val

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>langArgs <span class="token operator">=</span> langArgs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 初始化 DOM</span>
    _initDom<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_initDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> toolbarSelector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>toolbarSelector<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $toolbarSelector <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>toolbarSelector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> textSelector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>textSelector<span class="token punctuation">;</span>

      <span class="token keyword">var</span> config$$<span class="token number">1</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">;</span>
      <span class="token keyword">var</span> zIndex <span class="token operator">=</span> config$$<span class="token number">1.</span>zIndex<span class="token punctuation">;</span>

      <span class="token comment">// 定义变量</span>
      <span class="token keyword">var</span> $toolbarElem <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        $textContainerElem <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        $textElem <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        $children <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>textSelector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 只传入一个参数，即是容器的选择器或元素，toolbar 和 text 的元素自行创建</span>
        $toolbarElem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $textContainerElem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将编辑器区域原有的内容，暂存起来</span>
        $children <span class="token operator">=</span> $toolbarSelector<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加到 DOM 结构中</span>
        $toolbarSelector<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$toolbarElem<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$textContainerElem<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 自行创建的，需要配置默认的样式</span>
        $toolbarElem<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'background-color'</span><span class="token punctuation">,</span> <span class="token string">'#f1f1f1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'border'</span><span class="token punctuation">,</span> <span class="token string">'1px solid #ccc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $textContainerElem<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'border'</span><span class="token punctuation">,</span> <span class="token string">'1px solid #ccc'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'border-top'</span><span class="token punctuation">,</span> <span class="token string">'none'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">,</span> <span class="token string">'300px'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// toolbar 和 text 的选择器都有值，记录属性</span>
        $toolbarElem <span class="token operator">=</span> $toolbarSelector<span class="token punctuation">;</span>
        $textContainerElem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>textSelector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将编辑器区域原有的内容，暂存起来</span>
        $children <span class="token operator">=</span> $textContainerElem<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 编辑区域</span>
      $textElem <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;div&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $textElem<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'contenteditable'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">,</span> <span class="token string">'100%'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">,</span> <span class="token string">'100%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 初始化编辑区域内容</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$children <span class="token operator">&amp;&amp;</span> $children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        $textElem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$children<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        $textElem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 编辑区域加入DOM</span>
      $textContainerElem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>$textElem<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 设置通用的 class</span>
      $toolbarElem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-toolbar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $textContainerElem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-text-container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $textContainerElem<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'z-index'</span><span class="token punctuation">,</span> zIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      $textElem<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'w-e-text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 添加 ID</span>
      <span class="token keyword">var</span> toolbarElemId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'toolbar-elem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $toolbarElem<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> toolbarElemId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> textElemId <span class="token operator">=</span> <span class="token function">getRandom</span><span class="token punctuation">(</span><span class="token string">'text-elem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $textElem<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> textElemId<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 记录属性</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$toolbarElem <span class="token operator">=</span> $toolbarElem<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$textContainerElem <span class="token operator">=</span> $textContainerElem<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$textElem <span class="token operator">=</span> $textElem<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>toolbarElemId <span class="token operator">=</span> toolbarElemId<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>textElemId <span class="token operator">=</span> textElemId<span class="token punctuation">;</span>

      <span class="token comment">// 记录输入法的开始和结束</span>
      <span class="token keyword">var</span> compositionEnd <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      $textContainerElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'compositionstart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 输入法开始输入</span>
        compositionEnd <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $textContainerElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'compositionend'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 输入法结束输入</span>
        compositionEnd <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 绑定 onchange</span>
      $textContainerElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 输入法结束才出发 onchange</span>
        compositionEnd <span class="token operator">&amp;&amp;</span> _this<span class="token punctuation">.</span>change <span class="token operator">&amp;&amp;</span> _this<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      $toolbarElem<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>change <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//绑定 onfocus 与 onblur 事件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>config$$<span class="token number">1.</span>onfocus <span class="token operator">||</span> config$$<span class="token number">1.</span>onblur<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前编辑器是否是焦点状态</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isFocus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//判断当前点击元素是否在编辑器内</span>
          <span class="token keyword">var</span> isChild <span class="token operator">=</span> $textElem<span class="token punctuation">.</span><span class="token function">isContain</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">//判断当前点击元素是否为工具栏</span>
          <span class="token keyword">var</span> isToolbar <span class="token operator">=</span> $toolbarElem<span class="token punctuation">.</span><span class="token function">isContain</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">var</span> isMenu <span class="token operator">=</span> $toolbarElem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> e<span class="token punctuation">.</span>target <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isChild<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//若为选择工具栏中的功能，则不视为成blur操作</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isToolbar <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isMenu<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>_this<span class="token punctuation">.</span>isFocus<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              _this<span class="token punctuation">.</span>onblur <span class="token operator">&amp;&amp;</span> _this<span class="token punctuation">.</span><span class="token function">onblur</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            _this<span class="token punctuation">.</span>isFocus <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_this<span class="token punctuation">.</span>isFocus<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              _this<span class="token punctuation">.</span>onfocus <span class="token operator">&amp;&amp;</span> _this<span class="token punctuation">.</span><span class="token function">onfocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            _this<span class="token punctuation">.</span>isFocus <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 封装 command</span>
    _initCommand<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_initCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Command</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 封装 selection range API</span>
    _initSelectionAPI<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_initSelectionAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>selection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">API</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 添加图片上传</span>
    _initUploadImg<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_initUploadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>uploadImg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadImg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 初始化菜单</span>
    _initMenus<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_initMenus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>menus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Menus</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>menus<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 添加 text 区域</span>
    _initText<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_initText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>txt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>txt<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 初始化选区，将光标定位到内容尾部</span>
    initSelection<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">initSelection</span><span class="token punctuation">(</span>newLine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> $textElem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$textElem<span class="token punctuation">;</span>
      <span class="token keyword">var</span> $children <span class="token operator">=</span> $textElem<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果编辑器区域无内容，添加一个空行，重新设置选区</span>
        $textElem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> $last <span class="token operator">=</span> $children<span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>newLine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 新增一个空行</span>
        <span class="token keyword">var</span> html <span class="token operator">=</span> $last<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> nodeName <span class="token operator">=</span> $last<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>html <span class="token operator">!==</span> <span class="token string">'&lt;br&gt;'</span> <span class="token operator">&amp;&amp;</span> html <span class="token operator">!==</span> <span class="token string">'&lt;br\/&gt;'</span> <span class="token operator">||</span> nodeName <span class="token operator">!==</span> <span class="token string">'P'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 最后一个元素不是 &lt;p&gt;&lt;br&gt;&lt;/p&gt;，添加一个空行，重新设置选区</span>
          $textElem<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;p&gt;&lt;br&gt;&lt;/p&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">createRangeByElem</span><span class="token punctuation">(</span>$last<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">restoreSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 绑定事件</span>
    _bindEvent<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// -------- 绑定 onchange 事件 --------</span>
      <span class="token keyword">var</span> onChangeTimeoutId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> beforeChangeHtml <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>txt<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> config$$<span class="token number">1</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">;</span>

      <span class="token comment">// onchange 触发延迟时间</span>
      <span class="token keyword">var</span> onchangeTimeout <span class="token operator">=</span> config$$<span class="token number">1.</span>onchangeTimeout<span class="token punctuation">;</span>
      onchangeTimeout <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>onchangeTimeout<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onchangeTimeout <span class="token operator">||</span> onchangeTimeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        onchangeTimeout <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">var</span> onchange <span class="token operator">=</span> config$$<span class="token number">1.</span>onchange<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onchange <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> onchange <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 触发 change 的有三个场景：</span>
        <span class="token comment">// 1. $textContainerElem.on('click keyup')</span>
        <span class="token comment">// 2. $toolbarElem.on('click')</span>
        <span class="token comment">// 3. editor.cmd.do()</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">change</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 判断是否有变化</span>
          <span class="token keyword">var</span> currentHtml <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>txt<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHtml<span class="token punctuation">.</span>length <span class="token operator">===</span> beforeChangeHtml<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 需要比较每一个字符</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHtml <span class="token operator">===</span> beforeChangeHtml<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 执行，使用节流</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>onChangeTimeoutId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>onChangeTimeoutId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          onChangeTimeoutId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 触发配置的 onchange 函数</span>
            <span class="token function">onchange</span><span class="token punctuation">(</span>currentHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beforeChangeHtml <span class="token operator">=</span> currentHtml<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> onchangeTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// -------- 绑定 onblur 事件 --------</span>
      <span class="token keyword">var</span> onblur <span class="token operator">=</span> config$$<span class="token number">1.</span>onblur<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onblur <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> onblur <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">onblur</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> currentHtml <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>txt<span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">onblur</span><span class="token punctuation">(</span>currentHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// -------- 绑定 onfocus 事件 --------</span>
      <span class="token keyword">var</span> onfocus <span class="token operator">=</span> config$$<span class="token number">1.</span>onfocus<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>onfocus <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> onfocus <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">onfocus</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">onfocus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 创建编辑器</span>
    create<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 初始化配置信息</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 初始化 DOM</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 封装 command API</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 封装 selection range API</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initSelectionAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 添加 text</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 初始化菜单</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initMenus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 添加 图片上传</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initUploadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 初始化选区，将光标定位到内容尾部</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initSelection</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 绑定事件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 解绑所有事件（暂时不对外开放）</span>
    _offAllEvent<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">_offAllEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      $<span class="token punctuation">.</span><span class="token function">offAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 检验是否浏览器环境</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    document<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ex</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'请在浏览器环境下运行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// polyfill</span>
  <span class="token function">polyfill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这里的 `inlinecss` 将被替换成 css 代码的内容，详情可去 ./gulpfile.js 中搜索 `inlinecss` 关键字</span>
  <span class="token keyword">var</span> inlinecss <span class="token operator">=</span> <span class="token string">'.w-e-toolbar,.w-e-text-container,.w-e-menu-panel {  padding: 0;  margin: 0;  box-sizing: border-box;}.w-e-toolbar *,.w-e-text-container *,.w-e-menu-panel * {  padding: 0;  margin: 0;  box-sizing: border-box;}.w-e-clear-fix:after {  content: "";  display: table;  clear: both;}.w-e-toolbar .w-e-droplist {  position: absolute;  left: 0;  top: 0;  background-color: #fff;  border: 1px solid #f1f1f1;  border-right-color: #ccc;  border-bottom-color: #ccc;}.w-e-toolbar .w-e-droplist .w-e-dp-title {  text-align: center;  color: #999;  line-height: 2;  border-bottom: 1px solid #f1f1f1;  font-size: 13px;}.w-e-toolbar .w-e-droplist ul.w-e-list {  list-style: none;  line-height: 1;}.w-e-toolbar .w-e-droplist ul.w-e-list li.w-e-item {  color: #333;  padding: 5px 0;}.w-e-toolbar .w-e-droplist ul.w-e-list li.w-e-item:hover {  background-color: #f1f1f1;}.w-e-toolbar .w-e-droplist ul.w-e-block {  list-style: none;  text-align: left;  padding: 5px;}.w-e-toolbar .w-e-droplist ul.w-e-block li.w-e-item {  display: inline-block;  *display: inline;  *zoom: 1;  padding: 3px 5px;}.w-e-toolbar .w-e-droplist ul.w-e-block li.w-e-item:hover {  background-color: #f1f1f1;}@font-face {  font-family: \'w-e-icon\';  src: url(data:application/x-font-woff;charset=utf-8;base64,d09GRgABAAAAABhQAAsAAAAAGAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABPUy8yAAABCAAAAGAAAABgDxIPBGNtYXAAAAFoAAABBAAAAQQrSf4BZ2FzcAAAAmwAAAAIAAAACAAAABBnbHlmAAACdAAAEvAAABLwfpUWUWhlYWQAABVkAAAANgAAADYQp00kaGhlYQAAFZwAAAAkAAAAJAfEA+FobXR4AAAVwAAAAIQAAACEeAcD7GxvY2EAABZEAAAARAAAAERBSEX+bWF4cAAAFogAAAAgAAAAIAAsALZuYW1lAAAWqAAAAYYAAAGGmUoJ+3Bvc3QAABgwAAAAIAAAACAAAwAAAAMD3gGQAAUAAAKZAswAAACPApkCzAAAAesAMwEJAAAAAAAAAAAAAAAAAAAAARAAAAAAAAAAAAAAAAAAAAAAQAAA8fwDwP/AAEADwABAAAAAAQAAAAAAAAAAAAAAIAAAAAAAAwAAAAMAAAAcAAEAAwAAABwAAwABAAAAHAAEAOgAAAA2ACAABAAWAAEAIOkG6Q3pEulH6Wbpd+m56bvpxunL6d/qDepc6l/qZepo6nHqefAN8BTxIPHc8fz//f//AAAAAAAg6QbpDekS6UfpZel36bnpu+nG6cvp3+oN6lzqX+pi6mjqcep38A3wFPEg8dzx/P/9//8AAf/jFv4W+Bb0FsAWoxaTFlIWURZHFkMWMBYDFbUVsxWxFa8VpxWiEA8QCQ7+DkMOJAADAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAB//8ADwABAAAAAAAAAAAAAgAANzkBAAAAAAEAAAAAAAAAAAACAAA3OQEAAAAAAQAAAAAAAAAAAAIAADc5AQAAAAACAAD/wAQAA8AABAATAAABNwEnAQMuAScTNwEjAQMlATUBBwGAgAHAQP5Anxc7MmOAAYDA/oDAAoABgP6ATgFAQAHAQP5A/p0yOxcBEU4BgP6A/YDAAYDA/oCAAAQAAAAABAADgAAQACEALQA0AAABOAExETgBMSE4ATEROAExITUhIgYVERQWMyEyNjURNCYjBxQGIyImNTQ2MzIWEyE1EwEzNwPA/IADgPyAGiYmGgOAGiYmGoA4KCg4OCgoOED9AOABAEDgA0D9AAMAQCYa/QAaJiYaAwAaJuAoODgoKDg4/biAAYD+wMAAAAIAAABABAADQAA4ADwAAAEmJy4BJyYjIgcOAQcGBwYHDgEHBhUUFx4BFxYXFhceARcWMzI3PgE3Njc2Nz4BNzY1NCcuAScmJwERDQED1TY4OXY8PT8/PTx2OTg2CwcICwMDAwMLCAcLNjg5djw9Pz89PHY5ODYLBwgLAwMDAwsIBwv9qwFA/sADIAgGBggCAgICCAYGCCkqKlktLi8vLi1ZKiopCAYGCAICAgIIBgYIKSoqWS0uLy8uLVkqKin94AGAwMAAAAAAAgDA/8ADQAPAABsAJwAAASIHDgEHBhUUFx4BFxYxMDc+ATc2NTQnLgEnJgMiJjU0NjMyFhUUBgIAQjs6VxkZMjJ4MjIyMngyMhkZVzo7QlBwcFBQcHADwBkZVzo7Qnh9fcxBQUFBzH19eEI7OlcZGf4AcFBQcHBQUHAAAAEAAAAABAADgAArAAABIgcOAQcGBycRISc+ATMyFx4BFxYVFAcOAQcGBxc2Nz4BNzY1NCcuAScmIwIANTIyXCkpI5YBgJA1i1BQRUZpHh4JCSIYGB5VKCAgLQwMKCiLXl1qA4AKCycbHCOW/oCQNDweHmlGRVArKClJICEaYCMrK2I2NjlqXV6LKCgAAQAAAAAEAAOAACoAABMUFx4BFxYXNyYnLgEnJjU0Nz4BNzYzMhYXByERByYnLgEnJiMiBw4BBwYADAwtICAoVR4YGCIJCR4eaUZFUFCLNZABgJYjKSlcMjI1al1eiygoAYA5NjZiKysjYBohIEkpKCtQRUZpHh48NJABgJYjHBsnCwooKIteXQAAAAACAAAAQAQBAwAAJgBNAAATMhceARcWFRQHDgEHBiMiJy4BJyY1JzQ3PgE3NjMVIgYHDgEHPgEhMhceARcWFRQHDgEHBiMiJy4BJyY1JzQ3PgE3NjMVIgYHDgEHPgHhLikpPRESEhE9KSkuLikpPRESASMjelJRXUB1LQkQBwgSAkkuKSk9ERISET0pKS4uKSk9ERIBIyN6UlFdQHUtCRAHCBICABIRPSkpLi4pKT0REhIRPSkpLiBdUVJ6IyOAMC4IEwoCARIRPSkpLi4pKT0REhIRPSkpLiBdUVJ6IyOAMC4IEwoCAQAABgBA/8AEAAPAAAMABwALABEAHQApAAAlIRUhESEVIREhFSEnESM1IzUTFTMVIzU3NSM1MxUVESM1MzUjNTM1IzUBgAKA/YACgP2AAoD9gMBAQECAwICAwMCAgICAgIACAIACAIDA/wDAQP3yMkCSPDJAku7+wEBAQEBAAAYAAP/ABAADwAADAAcACwAXACMALwAAASEVIREhFSERIRUhATQ2MzIWFRQGIyImETQ2MzIWFRQGIyImETQ2MzIWFRQGIyImAYACgP2AAoD9gAKA/YD+gEs1NUtLNTVLSzU1S0s1NUtLNTVLSzU1SwOAgP8AgP8AgANANUtLNTVLS/61NUtLNTVLS/61NUtLNTVLSwADAAAAAAQAA6AAAwANABQAADchFSElFSE1EyEVITUhJQkBIxEjEQAEAPwABAD8AIABAAEAAQD9YAEgASDggEBAwEBAAQCAgMABIP7g/wABAAAAAAACAB7/zAPiA7QAMwBkAAABIiYnJicmNDc2PwE+ATMyFhcWFxYUBwYPAQYiJyY0PwE2NCcuASMiBg8BBhQXFhQHDgEjAyImJyYnJjQ3Nj8BNjIXFhQPAQYUFx4BMzI2PwE2NCcmNDc2MhcWFxYUBwYPAQ4BIwG4ChMIIxISEhIjwCNZMTFZIyMSEhISI1gPLA8PD1gpKRQzHBwzFMApKQ8PCBMKuDFZIyMSEhISI1gPLA8PD1gpKRQzHBwzFMApKQ8PDysQIxISEhIjwCNZMQFECAckLS1eLS0kwCIlJSIkLS1eLS0kVxAQDysPWCl0KRQVFRTAKXQpDysQBwj+iCUiJC0tXi0tJFcQEA8rD1gpdCkUFRUUwCl0KQ8rEA8PJC0tXi0tJMAiJQAAAAAFAAD/wAQAA8AAGwA3AFMAXwBrAAAFMjc+ATc2NTQnLgEnJiMiBw4BBwYVFBceARcWEzIXHgEXFhUUBw4BBwYjIicuAScmNTQ3PgE3NhMyNz4BNzY3BgcOAQcGIyInLgEnJicWFx4BFxYnNDYzMhYVFAYjIiYlNDYzMhYVFAYjIiYCAGpdXosoKCgoi15dampdXosoKCgoi15dalZMTHEgISEgcUxMVlZMTHEgISEgcUxMVisrKlEmJiMFHBtWODc/Pzc4VhscBSMmJlEqK9UlGxslJRsbJQGAJRsbJSUbGyVAKCiLXl1qal1eiygoKCiLXl1qal1eiygoA6AhIHFMTFZWTExxICEhIHFMTFZWTExxICH+CQYGFRAQFEM6OlYYGRkYVjo6QxQQEBUGBvcoODgoKDg4KCg4OCgoODgAAAMAAP/ABAADwAAbADcAQwAAASIHDgEHBhUUFx4BFxYzMjc+ATc2NTQnLgEnJgMiJy4BJyY1NDc+ATc2MzIXHgEXFhUUBw4BBwYTBycHFwcXNxc3JzcCAGpdXosoKCgoi15dampdXosoKCgoi15dalZMTHEgISEgcUxMVlZMTHEgISEgcUxMSqCgYKCgYKCgYKCgA8AoKIteXWpqXV6LKCgoKIteXWpqXV6LKCj8YCEgcUxMVlZMTHEgISEgcUxMVlZMTHEgIQKgoKBgoKBgoKBgoKAAAQBl/8ADmwPAACkAAAEiJiMiBw4BBwYVFBYzLgE1NDY3MAcGAgcGBxUhEzM3IzceATMyNjcOAQMgRGhGcVNUbRobSUgGDWVKEBBLPDxZAT1sxizXNC1VJi5QGB09A7AQHh1hPj9BTTsLJjeZbwN9fv7Fj5AjGQIAgPYJDzdrCQcAAAAAAgAAAAAEAAOAAAkAFwAAJTMHJzMRIzcXIyURJyMRMxUhNTMRIwcRA4CAoKCAgKCggP8AQMCA/oCAwEDAwMACAMDAwP8AgP1AQEACwIABAAADAMAAAANAA4AAFgAfACgAAAE+ATU0Jy4BJyYjIREhMjc+ATc2NTQmATMyFhUUBisBEyMRMzIWFRQGAsQcIBQURi4vNf7AAYA1Ly5GFBRE/oRlKjw8KWafn58sPj4B2yJULzUvLkYUFPyAFBRGLi81RnQBRks1NUv+gAEASzU1SwAAAAACAMAAAANAA4AAHwAjAAABMxEUBw4BBwYjIicuAScmNREzERQWFx4BMzI2Nz4BNQEhFSECwIAZGVc6O0JCOzpXGRmAGxgcSSgoSRwYG/4AAoD9gAOA/mA8NDVOFhcXFk41NDwBoP5gHjgXGBsbGBc4Hv6ggAAAAAABAIAAAAOAA4AACwAAARUjATMVITUzASM1A4CA/sCA/kCAAUCAA4BA/QBAQAMAQAABAAAAAAQAA4AAPQAAARUjHgEVFAYHDgEjIiYnLgE1MxQWMzI2NTQmIyE1IS4BJy4BNTQ2Nz4BMzIWFx4BFSM0JiMiBhUUFjMyFhcEAOsVFjUwLHE+PnEsMDWAck5OcnJO/gABLAIEATA1NTAscT4+cSwwNYByTk5yck47bisBwEAdQSI1YiQhJCQhJGI1NExMNDRMQAEDASRiNTViJCEkJCEkYjU0TEw0NEwhHwAAAAcAAP/ABAADwAADAAcACwAPABMAGwAjAAATMxUjNzMVIyUzFSM3MxUjJTMVIwMTIRMzEyETAQMhAyMDIQMAgIDAwMABAICAwMDAAQCAgBAQ/QAQIBACgBD9QBADABAgEP2AEAHAQEBAQEBAQEBAAkD+QAHA/oABgPwAAYD+gAFA/sAAAAoAAAAABAADgAADAAcACwAPABMAFwAbAB8AIwAnAAATESERATUhFR0BITUBFSE1IxUhNREhFSElIRUhETUhFQEhFSEhNSEVAAQA/YABAP8AAQD/AED/AAEA/wACgAEA/wABAPyAAQD/AAKAAQADgPyAA4D9wMDAQMDAAgDAwMDA/wDAwMABAMDA/sDAwMAAAAUAAAAABAADgAADAAcACwAPABMAABMhFSEVIRUhESEVIREhFSERIRUhAAQA/AACgP2AAoD9gAQA/AAEAPwAA4CAQID/AIABQID/AIAAAAAABQAAAAAEAAOAAAMABwALAA8AEwAAEyEVIRchFSERIRUhAyEVIREhFSEABAD8AMACgP2AAoD9gMAEAPwABAD8AAOAgECA/wCAAUCA/wCAAAAFAAAAAAQAA4AAAwAHAAsADwATAAATIRUhBSEVIREhFSEBIRUhESEVIQAEAPwAAYACgP2AAoD9gP6ABAD8AAQA/AADgIBAgP8AgAFAgP8AgAAAAAABAD8APwLmAuYALAAAJRQPAQYjIi8BBwYjIi8BJjU0PwEnJjU0PwE2MzIfATc2MzIfARYVFA8BFxYVAuYQThAXFxCoqBAXFhBOEBCoqBAQThAWFxCoqBAXFxBOEBCoqBDDFhBOEBCoqBAQThAWFxCoqBAXFxBOEBCoqBAQThAXFxCoqBAXAAAABgAAAAADJQNuABQAKAA8AE0AVQCCAAABERQHBisBIicmNRE0NzY7ATIXFhUzERQHBisBIicmNRE0NzY7ATIXFhcRFAcGKwEiJyY1ETQ3NjsBMhcWExEhERQXFhcWMyEyNzY3NjUBIScmJyMGBwUVFAcGKwERFAcGIyEiJyY1ESMiJyY9ATQ3NjsBNzY3NjsBMhcWHwEzMhcWFQElBgUIJAgFBgYFCCQIBQaSBQUIJQgFBQUFCCUIBQWSBQUIJQgFBQUFCCUIBQVJ/gAEBAUEAgHbAgQEBAT+gAEAGwQGtQYEAfcGBQg3Ghsm/iUmGxs3CAUFBQUIsSgIFxYXtxcWFgkosAgFBgIS/rcIBQUFBQgBSQgFBgYFCP63CAUFBQUIAUkIBQYGBQj+twgFBQUFCAFJCAUGBgX+WwId/eMNCwoFBQUFCgsNAmZDBQICBVUkCAYF/eMwIiMhIi8CIAUGCCQIBQVgFQ8PDw8VYAUFCAACAAcASQO3Aq8AGgAuAAAJAQYjIi8BJjU0PwEnJjU0PwE2MzIXARYVFAcBFRQHBiMhIicmPQE0NzYzITIXFgFO/vYGBwgFHQYG4eEGBh0FCAcGAQoGBgJpBQUI/dsIBQUFBQgCJQgFBQGF/vYGBhwGCAcG4OEGBwcGHQUF/vUFCAcG/vslCAUFBQUIJQgFBQUFAAAAAQAjAAAD3QNuALMAACUiJyYjIgcGIyInJjU0NzY3Njc2NzY9ATQnJiMhIgcGHQEUFxYXFjMWFxYVFAcGIyInJiMiBwYjIicmNTQ3Njc2NzY3Nj0BETQ1NDU0JzQnJicmJyYnJicmIyInJjU0NzYzMhcWMzI3NjMyFxYVFAcGIwYHBgcGHQEUFxYzITI3Nj0BNCcmJyYnJjU0NzYzMhcWMzI3NjMyFxYVFAcGByIHBgcGFREUFxYXFhcyFxYVFAcGIwPBGTMyGhkyMxkNCAcJCg0MERAKEgEHFf5+FgcBFQkSEw4ODAsHBw4bNTUaGDExGA0HBwkJCwwQDwkSAQIBAgMEBAUIEhENDQoLBwcOGjU1GhgwMRgOBwcJCgwNEBAIFAEHDwGQDgcBFAoXFw8OBwcOGTMyGRkxMRkOBwcKCg0NEBEIFBQJEREODQoLBwcOAAICAgIMCw8RCQkBAQMDBQxE4AwFAwMFDNRRDQYBAgEICBIPDA0CAgICDAwOEQgJAQIDAwUNRSEB0AINDQgIDg4KCgsLBwcDBgEBCAgSDwwNAgICAg0MDxEICAECAQYMULYMBwEBBwy2UAwGAQEGBxYPDA0CAgICDQwPEQgIAQECBg1P/eZEDAYCAgEJCBEPDA0AAAIAAP+3A/8DtwATADkAAAEyFxYVFAcCBwYjIicmNTQ3ATYzARYXFh8BFgcGIyInJicmJyY1FhcWFxYXFjMyNzY3Njc2NzY3NjcDmygeHhq+TDdFSDQ0NQFtISn9+BcmJy8BAkxMe0c2NiEhEBEEExQQEBIRCRcIDxITFRUdHR4eKQO3GxooJDP+mUY0NTRJSTABSx/9sSsfHw0oek1MGhsuLzo6RAMPDgsLCgoWJRsaEREKCwQEAgABAAAAAAAA9evv618PPPUACwQAAAAAANbEBFgAAAAA1sQEWAAA/7cEAQPAAAAACAACAAAAAAAAAAEAAAPA/8AAAAQAAAD//wQBAAEAAAAAAAAAAAAAAAAAAAAhBAAAAAAAAAAAAAAAAgAAAAQAAAAEAAAABAAAAAQAAMAEAAAABAAAAAQAAAAEAABABAAAAAQAAAAEAAAeBAAAAAQAAAAEAABlBAAAAAQAAMAEAADABAAAgAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAMlAD8DJQAAA74ABwQAACMD/wAAAAAAAAAKABQAHgBMAJQA+AE2AXwBwgI2AnQCvgLoA34EHgSIBMoE8gU0BXAFiAXgBiIGagaSBroG5AcoB+AIKgkcCXgAAQAAACEAtAAKAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAA4ArgABAAAAAAABAAcAAAABAAAAAAACAAcAYAABAAAAAAADAAcANgABAAAAAAAEAAcAdQABAAAAAAAFAAsAFQABAAAAAAAGAAcASwABAAAAAAAKABoAigADAAEECQABAA4ABwADAAEECQACAA4AZwADAAEECQADAA4APQADAAEECQAEAA4AfAADAAEECQAFABYAIAADAAEECQAGAA4AUgADAAEECQAKADQApGljb21vb24AaQBjAG8AbQBvAG8AblZlcnNpb24gMS4wAFYAZQByAHMAaQBvAG4AIAAxAC4AMGljb21vb24AaQBjAG8AbQBvAG8Abmljb21vb24AaQBjAG8AbQBvAG8AblJlZ3VsYXIAUgBlAGcAdQBsAGEAcmljb21vb24AaQBjAG8AbQBvAG8AbkZvbnQgZ2VuZXJhdGVkIGJ5IEljb01vb24uAEYAbwBuAHQAIABnAGUAbgBlAHIAYQB0AGUAZAAgAGIAeQAgAEkAYwBvAE0AbwBvAG4ALgAAAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=) format(\'truetype\');  font-weight: normal;  font-style: normal;}[class^="w-e-icon-"],[class*=" w-e-icon-"] {  /* use !important to prevent issues with browser extensions that change fonts */  font-family: \'w-e-icon\' !important;  speak: none;  font-style: normal;  font-weight: normal;  font-variant: normal;  text-transform: none;  line-height: 1;  /* Better Font Rendering =========== */  -webkit-font-smoothing: antialiased;  -moz-osx-font-smoothing: grayscale;}.w-e-icon-close:before {  content: "\\f00d";}.w-e-icon-upload2:before {  content: "\\e9c6";}.w-e-icon-trash-o:before {  content: "\\f014";}.w-e-icon-header:before {  content: "\\f1dc";}.w-e-icon-pencil2:before {  content: "\\e906";}.w-e-icon-paint-brush:before {  content: "\\f1fc";}.w-e-icon-image:before {  content: "\\e90d";}.w-e-icon-play:before {  content: "\\e912";}.w-e-icon-location:before {  content: "\\e947";}.w-e-icon-undo:before {  content: "\\e965";}.w-e-icon-redo:before {  content: "\\e966";}.w-e-icon-quotes-left:before {  content: "\\e977";}.w-e-icon-list-numbered:before {  content: "\\e9b9";}.w-e-icon-list2:before {  content: "\\e9bb";}.w-e-icon-link:before {  content: "\\e9cb";}.w-e-icon-happy:before {  content: "\\e9df";}.w-e-icon-bold:before {  content: "\\ea62";}.w-e-icon-underline:before {  content: "\\ea63";}.w-e-icon-italic:before {  content: "\\ea64";}.w-e-icon-strikethrough:before {  content: "\\ea65";}.w-e-icon-table2:before {  content: "\\ea71";}.w-e-icon-paragraph-left:before {  content: "\\ea77";}.w-e-icon-paragraph-center:before {  content: "\\ea78";}.w-e-icon-paragraph-right:before {  content: "\\ea79";}.w-e-icon-terminal:before {  content: "\\f120";}.w-e-icon-page-break:before {  content: "\\ea68";}.w-e-icon-cancel-circle:before {  content: "\\ea0d";}.w-e-icon-font:before {  content: "\\ea5c";}.w-e-icon-text-heigh:before {  content: "\\ea5f";}.w-e-toolbar {  display: -webkit-box;  display: -ms-flexbox;  display: flex;  padding: 0 5px;  /* flex-wrap: wrap; */  /* 单个菜单 */}.w-e-toolbar .w-e-menu {  position: relative;  text-align: center;  padding: 5px 10px;  cursor: pointer;}.w-e-toolbar .w-e-menu i {  color: #999;}.w-e-toolbar .w-e-menu:hover i {  color: #333;}.w-e-toolbar .w-e-active i {  color: #1e88e5;}.w-e-toolbar .w-e-active:hover i {  color: #1e88e5;}.w-e-text-container .w-e-panel-container {  position: absolute;  top: 0;  left: 50%;  border: 1px solid #ccc;  border-top: 0;  box-shadow: 1px 1px 2px #ccc;  color: #333;  background-color: #fff;  /* 为 emotion panel 定制的样式 */  /* 上传图片的 panel 定制样式 */}.w-e-text-container .w-e-panel-container .w-e-panel-close {  position: absolute;  right: 0;  top: 0;  padding: 5px;  margin: 2px 5px 0 0;  cursor: pointer;  color: #999;}.w-e-text-container .w-e-panel-container .w-e-panel-close:hover {  color: #333;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-title {  list-style: none;  display: -webkit-box;  display: -ms-flexbox;  display: flex;  font-size: 14px;  margin: 2px 10px 0 10px;  border-bottom: 1px solid #f1f1f1;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-title .w-e-item {  padding: 3px 5px;  color: #999;  cursor: pointer;  margin: 0 3px;  position: relative;  top: 1px;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-title .w-e-active {  color: #333;  border-bottom: 1px solid #333;  cursor: default;  font-weight: 700;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content {  padding: 10px 15px 10px 15px;  font-size: 16px;  /* 输入框的样式 */  /* 按钮的样式 */}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content input:focus,.w-e-text-container .w-e-panel-container .w-e-panel-tab-content textarea:focus,.w-e-text-container .w-e-panel-container .w-e-panel-tab-content button:focus {  outline: none;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content textarea {  width: 100%;  border: 1px solid #ccc;  padding: 5px;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content textarea:focus {  border-color: #1e88e5;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content input[type=text] {  border: none;  border-bottom: 1px solid #ccc;  font-size: 14px;  height: 20px;  color: #333;  text-align: left;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content input[type=text].small {  width: 30px;  text-align: center;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content input[type=text].block {  display: block;  width: 100%;  margin: 10px 0;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content input[type=text]:focus {  border-bottom: 2px solid #1e88e5;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content .w-e-button-container button {  font-size: 14px;  color: #1e88e5;  border: none;  padding: 5px 10px;  background-color: #fff;  cursor: pointer;  border-radius: 3px;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content .w-e-button-container button.left {  float: left;  margin-right: 10px;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content .w-e-button-container button.right {  float: right;  margin-left: 10px;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content .w-e-button-container button.gray {  color: #999;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content .w-e-button-container button.red {  color: #c24f4a;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content .w-e-button-container button:hover {  background-color: #f1f1f1;}.w-e-text-container .w-e-panel-container .w-e-panel-tab-content .w-e-button-container:after {  content: "";  display: table;  clear: both;}.w-e-text-container .w-e-panel-container .w-e-emoticon-container .w-e-item {  cursor: pointer;  font-size: 18px;  padding: 0 3px;  display: inline-block;  *display: inline;  *zoom: 1;}.w-e-text-container .w-e-panel-container .w-e-up-img-container {  text-align: center;}.w-e-text-container .w-e-panel-container .w-e-up-img-container .w-e-up-btn {  display: inline-block;  *display: inline;  *zoom: 1;  color: #999;  cursor: pointer;  font-size: 60px;  line-height: 1;}.w-e-text-container .w-e-panel-container .w-e-up-img-container .w-e-up-btn:hover {  color: #333;}.w-e-text-container {  position: relative;}.w-e-text-container .w-e-progress {  position: absolute;  background-color: #1e88e5;  bottom: 0;  left: 0;  height: 1px;}.w-e-text {  padding: 0 10px;  overflow-y: scroll;}.w-e-text p,.w-e-text h1,.w-e-text h2,.w-e-text h3,.w-e-text h4,.w-e-text h5,.w-e-text table,.w-e-text pre {  margin: 10px 0;  line-height: 1.5;}.w-e-text ul,.w-e-text ol {  margin: 10px 0 10px 20px;}.w-e-text blockquote {  display: block;  border-left: 8px solid #d0e5f2;  padding: 5px 10px;  margin: 10px 0;  line-height: 1.4;  font-size: 100%;  background-color: #f1f1f1;}.w-e-text code {  display: inline-block;  *display: inline;  *zoom: 1;  background-color: #f1f1f1;  border-radius: 3px;  padding: 3px 5px;  margin: 0 3px;}.w-e-text pre code {  display: block;}.w-e-text table {  border-top: 1px solid #ccc;  border-left: 1px solid #ccc;}.w-e-text table td,.w-e-text table th {  border-bottom: 1px solid #ccc;  border-right: 1px solid #ccc;  padding: 3px 5px;}.w-e-text table th {  border-bottom: 2px solid #ccc;  text-align: center;}.w-e-text:focus {  outline: none;}.w-e-text img {  cursor: pointer;}.w-e-text img:hover {  box-shadow: 0 0 5px #333;}'</span><span class="token punctuation">;</span>

<span class="token comment">// 将 css 代码添加到 &lt;style&gt; 中</span>
  <span class="token keyword">var</span> style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  style<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/css'</span><span class="token punctuation">;</span>
  style<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> inlinecss<span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'HEAD'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回</span>
  <span class="token keyword">var</span> index <span class="token operator">=</span> window<span class="token punctuation">.</span>wangEditor <span class="token operator">||</span> Editor<span class="token punctuation">;</span>

  <span class="token keyword">return</span> index<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/021fdc423004dc54b388aea2fc4c7a3f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">maven配置时报错NB: JAVA_HOME should point to a JDK not a JRE**解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f24bb58b63b057a789890bc8d7050d13/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mysql高级之Mysql各个组件介绍（总结）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>