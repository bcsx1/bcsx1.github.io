<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenCV数字图像处理——基于目标边缘适用于目标部分遮挡或不同光照模板匹配 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="OpenCV数字图像处理——基于目标边缘适用于目标部分遮挡或不同光照模板匹配" />
<meta property="og:description" content="简介 模板匹配是一种常见的计算机视觉问题，通常用于在一张图像中查找特定的模板图像。在处理模板匹配时，经常会面临对象的姿态未知的情况，其中姿态包括位置（X，Y坐标）和旋转角度（θ）。
模板匹配的步骤包括：
获取图像： 从图像中获取源图像和模板图像。
特征提取： 对源图像和模板图像进行特征提取，常常使用边缘检测等方法，以捕捉图像中的关键特征。
模板匹配： 在源图像中滑动模板图像，计算源图像中每个位置与模板的相似度。这通常涉及使用相关性或其他相似性度量。
位置识别： 通过找到相似度最高的位置，确定对象在源图像中的位置。
姿态估计： 如果需要，进行进一步的姿态估计，包括位置和旋转角度。
一、模型匹配 1.模板匹配API OpenCV库提供了模板匹配API，适合应用在比较简单的场景下：
#include &lt;opencv2/opencv.hpp&gt; int main() { // 读取源图像和模板图像 cv::Mat sourceImage = cv::imread(&#34;source_image.jpg&#34;, cv::IMREAD_GRAYSCALE); cv::Mat templateImage = cv::imread(&#34;template_image.jpg&#34;, cv::IMREAD_GRAYSCALE); // 边缘检测 cv::Mat edgesSource, edgesTemplate; cv::Canny(sourceImage, edgesSource, 50, 150); cv::Canny(templateImage, edgesTemplate, 50, 150); // 模板匹配 cv::Mat result; cv::matchTemplate(edgesSource, edgesTemplate, result, cv::TM_CCOEFF_NORMED); // 获取最大匹配值和位置 double minVal, maxVal; cv::Point minLoc, maxLoc; cv::minMaxLoc(result, &amp;minVal, &amp;maxVal, &amp;minLoc, &amp;maxLoc); // 绘制矩形框标记匹配位置 cv::rectangle(sourceImage, maxLoc, cv::Point(maxLoc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/ee419f8479c2a937fa735ad8e7819362/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-26T17:25:29+08:00" />
<meta property="article:modified_time" content="2023-12-26T17:25:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenCV数字图像处理——基于目标边缘适用于目标部分遮挡或不同光照模板匹配</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>简介</h3> 
<p>模板匹配是一种常见的计算机视觉问题，通常用于在一张图像中查找特定的模板图像。在处理模板匹配时，经常会面临对象的姿态未知的情况，其中姿态包括位置（X，Y坐标）和旋转角度（θ）。</p> 
<p>模板匹配的步骤包括：</p> 
<ol><li> <p><strong>获取图像：</strong> 从图像中获取源图像和模板图像。</p> </li><li> <p><strong>特征提取：</strong> 对源图像和模板图像进行特征提取，常常使用边缘检测等方法，以捕捉图像中的关键特征。</p> </li><li> <p><strong>模板匹配：</strong> 在源图像中滑动模板图像，计算源图像中每个位置与模板的相似度。这通常涉及使用相关性或其他相似性度量。</p> </li><li> <p><strong>位置识别：</strong> 通过找到相似度最高的位置，确定对象在源图像中的位置。</p> </li><li> <p><strong>姿态估计：</strong> 如果需要，进行进一步的姿态估计，包括位置和旋转角度。</p> </li></ol> 
<h3><a id="_15"></a>一、模型匹配</h3> 
<h4><a id="1API_16"></a>1.模板匹配API</h4> 
<p>OpenCV库提供了模板匹配API，适合应用在比较简单的场景下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 读取源图像和模板图像</span>
    cv<span class="token double-colon punctuation">::</span>Mat sourceImage <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"source_image.jpg"</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMREAD_GRAYSCALE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Mat templateImage <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"template_image.jpg"</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>IMREAD_GRAYSCALE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 边缘检测</span>
    cv<span class="token double-colon punctuation">::</span>Mat edgesSource<span class="token punctuation">,</span> edgesTemplate<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">Canny</span><span class="token punctuation">(</span>sourceImage<span class="token punctuation">,</span> edgesSource<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">Canny</span><span class="token punctuation">(</span>templateImage<span class="token punctuation">,</span> edgesTemplate<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 模板匹配</span>
    cv<span class="token double-colon punctuation">::</span>Mat result<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">matchTemplate</span><span class="token punctuation">(</span>edgesSource<span class="token punctuation">,</span> edgesTemplate<span class="token punctuation">,</span> result<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>TM_CCOEFF_NORMED<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取最大匹配值和位置</span>
    <span class="token keyword">double</span> minVal<span class="token punctuation">,</span> maxVal<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span>Point minLoc<span class="token punctuation">,</span> maxLoc<span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">minMaxLoc</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token operator">&amp;</span>minVal<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxVal<span class="token punctuation">,</span> <span class="token operator">&amp;</span>minLoc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 绘制矩形框标记匹配位置</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">rectangle</span><span class="token punctuation">(</span>sourceImage<span class="token punctuation">,</span> maxLoc<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span>maxLoc<span class="token punctuation">.</span>x <span class="token operator">+</span> edgesTemplate<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> maxLoc<span class="token punctuation">.</span>y <span class="token operator">+</span> edgesTemplate<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 显示结果</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Matched Image"</span><span class="token punctuation">,</span> sourceImage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">destroyAllWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里使用了OpenCV的<code>cv::Canny</code>函数进行边缘检测，然后使用<code>cv::matchTemplate</code>函数进行模板匹配。最后，通过<code>cv::rectangle</code>函数在源图像中标记匹配位置。</p> 
<h4><a id="2__55"></a>2. 模板匹配的局限性与解决方法</h4> 
<p>模板匹配是一项具有挑战性的任务，主要受到其速度和可靠性的限制。当对象只有部分可见或与其他对象混合在一起时，解决方案必须具备鲁棒性，特别是对亮度变化要有稳健的适应能力。在此问题中，算法的计算效率也至关重要。为解决这一问题，存在两种主要方法：基于灰度值的匹配（或基于区域的匹配）和基于特征的匹配（非基于区域的匹配）。</p> 
<p><strong>基于灰度值的模板匹配：</strong><br> 基于灰度值的匹配方法使用归一化互相关（NCC）算法，这一算法在过去已经得到广泛应用。在该方法中，每一步的操作包括对模板 t(x, y) 和子图像 f(x, y) 进行互相关计算。公式如下：</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         N 
        
       
         C 
        
       
         C 
        
       
         = 
        
        
        
          1 
         
         
         
           n 
          
         
           − 
          
         
           1 
          
         
        
        
        
          ∑ 
         
         
         
           x 
          
         
           ⋅ 
          
         
           v 
          
         
        
        
         
         
           ( 
          
         
           f 
          
         
           ( 
          
         
           x 
          
         
           , 
          
         
           y 
          
         
           ) 
          
         
           − 
          
         
           μ 
          
         
           f 
          
         
           ) 
          
         
           ( 
          
         
           t 
          
         
           ( 
          
         
           x 
          
         
           , 
          
         
           y 
          
         
           ) 
          
         
           − 
          
         
           μ 
          
         
           t 
          
         
           ) 
          
         
         
         
           σ 
          
         
           f 
          
         
           . 
          
         
           σ 
          
         
           t 
          
         
        
       
      
        N C C={\frac{1}{n-1}}\sum_{x\cdot v}{\frac{(f(x,y)-\mu f)(t(x,y)-\mu t)}{\sigma f.\sigma t}} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">NCC</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.4911em; vertical-align: -0.4811em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4033em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position: relative; top: 0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.0114em;"><span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mbin mtight">⋅</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2997em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.01em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">σ</span><span class="mord mathnormal mtight" style="margin-right: 0.1076em;">f</span><span class="mord mtight">.</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">σ</span><span class="mord mathnormal mtight">t</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.485em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right: 0.1076em;">f</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span><span class="mclose mtight">)</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">μ</span><span class="mord mathnormal mtight" style="margin-right: 0.1076em;">f</span><span class="mclose mtight">)</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span><span class="mclose mtight">)</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">μ</span><span class="mord mathnormal mtight">t</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4811em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>该互相关计算通常在每一步中通过减去平均值并除以标准偏差来完成。这种匹配方法的目标是提高对亮度变化的鲁棒性，确保在对象部分可见或混合的情况下仍能有效工作。</p> 
<p><strong>基于特征的方法：</strong><br> 基于特征的模板匹配方法在图像处理领域中有多种应用。与基于边缘的物体识别相似，这些方法利用物体的特征来进行匹配。在广义霍夫变换等技术中，物体的几何特征被用于匹配过程。</p> 
<h3><a id="_69"></a>二、基于边缘特征的模板匹配</h3> 
<p>边缘是数字图像中亮度急剧变化或具有不连续性的点，通常通过计算图像强度函数的梯度近似值来定义。<br> 边缘检测方法主要分为两类：基于搜索和基于过零。基于搜索的方法首先计算边缘强度，通常使用一阶导数表达式（如梯度幅度），然后通过估计的局部方向搜索梯度幅度的局部最大值，该方向通常是梯度方向。可以使用 Sobel 算子实现了一种基于搜索的方法，它计算每个点的图像强度梯度，提供从明到暗的最大可能增加方向以及该方向的变化率。</p> 
<h4><a id="1__73"></a>1. 模板边缘检测</h4> 
<p>对于模板图像，为了获模板的特征属性，首先是要确定目标的位置边缘，这里采用了 Canny 边缘检测方法的一种变体来寻找目标边缘。</p> 
<p>Canny 边缘检测方法检测算法步骤如下：</p> 
<ol><li><strong>获取图像的亮度梯度</strong></li></ol> 
<p>对模板图像应用 Sobel 过滤器，该过滤器返回 X（Gx）和 Y（Gy）方向的梯度。基于这些梯度，将使用以下公式计算边缘的大小和方向：</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         M 
        
       
         a 
        
       
         g 
        
       
         n 
        
       
         i 
        
       
         t 
        
       
         u 
        
       
         d 
        
       
         e 
        
       
         = 
        
        
         
         
           G 
          
          
          
            x 
           
          
            2 
           
          
         
           + 
          
         
           G 
          
          
          
            y 
           
          
            2 
           
          
         
        
       
      
        M a g n i t u d e={\sqrt{G x^{2}+G y^{2}}} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">ni</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.24em; vertical-align: -0.2822em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9578em;"><span class="svg-align" style="top: -3.2em;"><span class="pstrut" style="height: 3.2em;"></span><span class="mord" style="padding-left: 1em;"><span class="mord mathnormal">G</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal">G</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.9178em;"><span class="pstrut" style="height: 3.2em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.28em;"> 
            <svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
             <path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"></path> 
            </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2822em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         D 
        
       
         i 
        
       
         r 
        
       
         e 
        
       
         c 
        
       
         t 
        
       
         i 
        
       
         o 
        
       
         n 
        
       
         = 
        
       
         i 
        
       
         n 
        
       
         v 
        
       
         t 
        
       
         a 
        
       
         n 
        
       
         ( 
        
        
         
         
           G 
          
         
           y 
          
         
         
         
           G 
          
         
           x 
          
         
        
       
         ) 
        
       
      
        D i r e c t i o n=i n v t a n(\frac{G y}{G x}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">D</span><span class="mord mathnormal">i</span><span class="mord mathnormal">rec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.2694em; vertical-align: -0.345em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="mord mathnormal">t</span><span class="mord mathnormal">an</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9244em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">G</span><span class="mord mathnormal mtight">x</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.4461em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">G</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></p> 
<p>一旦确定了边缘的方向，接下来的步骤是将可追踪的边缘方向与图像中的相邻像素关联。有四个可能的方向来描述周围像素的位置：0 度、45 度、90 度和 135 度。就可以将将所有方向映射到这些角度之一。</p> 
<ol start="2"><li><strong>应用非极大值抑制</strong></li></ol> 
<p>在确定了边缘方向后，执行非极大值抑制算法。该算法沿边缘方向追踪左右像素，如果当前像素的幅度小于左右像素的幅度，则抑制当前像素的幅度。这一步导致图像中边缘部分的细化。</p> 
<ol start="3"><li> <p><strong>滞后阈值</strong><br> 这里使用两个阈值：高阈值和低阈值。使用高阈值来标记那些相当确定是真实边缘的像素。然后，利用先前导出的方向信息，可以通过图像追踪其他边缘。在跟踪边缘时，应用较低的阈值，这样只要找到一个起点，就能够追踪边缘的较弱部分。</p> </li><li> <p><strong>保存特征数据</strong><br> 提取边缘后，将所选边缘的 X 和 Y 导数与坐标信息一起保存为模板模型。这些坐标将重新排列以反映作为重心的起点。</p> </li></ol> 
<p>使用OpenCV 4.5实现的代码如下:</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token class-name">GeoMatch</span><span class="token double-colon punctuation">::</span><span class="token function">create_match_model</span><span class="token punctuation">(</span>Mat <span class="token operator">&amp;</span>cv_template<span class="token punctuation">,</span><span class="token keyword">double</span> maxContrast<span class="token punctuation">,</span><span class="token keyword">double</span> minContrast<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

	Mat gx<span class="token punctuation">;</span>		<span class="token comment">//Matrix to store X derivative</span>
	Mat gy<span class="token punctuation">;</span>		<span class="token comment">//Matrix to store Y derivative</span>
	Mat nmsEdges<span class="token punctuation">;</span>		<span class="token comment">//Matrix to store temp restult</span>
	Size Ssize<span class="token punctuation">;</span>

	Mat <span class="token function">src</span><span class="token punctuation">(</span>cv_template<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//Above step replicated</span>
	<span class="token comment">// set width and height</span>
	Ssize<span class="token punctuation">.</span>width <span class="token operator">=</span> src<span class="token punctuation">.</span>cols<span class="token punctuation">;</span>  <span class="token comment">//src-&gt;width;</span>
	Ssize<span class="token punctuation">.</span>height <span class="token operator">=</span> src<span class="token punctuation">.</span>rows<span class="token punctuation">;</span> <span class="token comment">//src-&gt;height;</span>
	modelHeight <span class="token operator">=</span> src<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>  <span class="token comment">//src-&gt;height;		//Save Template height</span>
	modelWidth <span class="token operator">=</span> src<span class="token punctuation">.</span>cols<span class="token punctuation">;</span>   <span class="token comment">//src-&gt;width;		//Save Template width</span>

	cordinates <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Point<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>modelWidth <span class="token operator">*</span> modelHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Allocate memory for coorinates of selected points in template image</span>

	edge_magnitude <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>modelWidth <span class="token operator">*</span> modelHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Allocate memory for edge magnitude for selected points</span>
	edge_derivativeX <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>modelWidth <span class="token operator">*</span> modelHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//Allocate memory for edge X derivative for selected points</span>
	edge_derivativeY <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>modelWidth <span class="token operator">*</span> modelHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">Allocate memory for edge Y derivative for selected points</span>


	<span class="token comment">// Calculate gradient of Template</span>
	gx <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span> Ssize<span class="token punctuation">.</span>height<span class="token punctuation">,</span> Ssize<span class="token punctuation">.</span>width<span class="token punctuation">,</span> CV_16SC1 <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//create Matrix to store X derivative</span>
	gy <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span> Ssize<span class="token punctuation">.</span>height<span class="token punctuation">,</span> Ssize<span class="token punctuation">.</span>width<span class="token punctuation">,</span> CV_16SC1 <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//create Matrix to store Y derivative</span>
	
	
	<span class="token function">Sobel</span><span class="token punctuation">(</span> src<span class="token punctuation">,</span> gx<span class="token punctuation">,</span> CV_16S<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//gradient in X direction			</span>
	<span class="token function">Sobel</span><span class="token punctuation">(</span> src<span class="token punctuation">,</span> gy<span class="token punctuation">,</span> CV_16S<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//gradient in Y direction</span>

	nmsEdges <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span>Ssize<span class="token punctuation">.</span>height<span class="token punctuation">,</span> Ssize<span class="token punctuation">.</span>width<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//create Matrix to store Final nmsEdges</span>
	<span class="token keyword">const</span> <span class="token keyword">short</span><span class="token operator">*</span> _sdx<span class="token punctuation">;</span> 
	<span class="token keyword">const</span> <span class="token keyword">short</span><span class="token operator">*</span> _sdy<span class="token punctuation">;</span> 
	<span class="token keyword">double</span> fdx<span class="token punctuation">,</span>fdy<span class="token punctuation">;</span>	
    <span class="token keyword">double</span> MagG<span class="token punctuation">,</span> DirG<span class="token punctuation">;</span>
	<span class="token keyword">double</span> MaxGradient <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">99999.99</span><span class="token punctuation">;</span>
	<span class="token keyword">double</span> direction<span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>orients <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>Ssize<span class="token punctuation">.</span>height <span class="token operator">*</span> Ssize<span class="token punctuation">.</span>width<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// count variable;</span>
	<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>j<span class="token punctuation">;</span> 
	
	<span class="token comment">//double **magMat;</span>
	std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span> magMat<span class="token punctuation">;</span>
	<span class="token function">create_double_matrix</span><span class="token punctuation">(</span>magMat <span class="token punctuation">,</span>Ssize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">for</span><span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>       
			fdx <span class="token operator">=</span> gx<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
			fdy <span class="token operator">=</span> gy<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
			

			MagG <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fdx <span class="token operator">*</span> fdx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fdy <span class="token operator">*</span> fdy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Magnitude = Sqrt(gx^2 +gy^2)</span>
			direction <span class="token operator">=</span> <span class="token function">atan2f</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>fdy<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>fdx<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//cvFastArctan((float)fdy,(float)fdx);	 //Direction = invtan (Gy / Gx)</span>
			magMat<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> MagG<span class="token punctuation">;</span>
				
			<span class="token keyword">if</span><span class="token punctuation">(</span>MagG <span class="token operator">&gt;</span> MaxGradient<span class="token punctuation">)</span>
				MaxGradient <span class="token operator">=</span> MagG<span class="token punctuation">;</span> <span class="token comment">// get maximum gradient value for normalizing.</span>

			<span class="token comment">// get closest angle from 0, 45, 90, 135 set</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>direction <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> direction <span class="token operator">&lt;</span> <span class="token number">22.5</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>direction <span class="token operator">&gt;</span> <span class="token number">157.5</span> <span class="token operator">&amp;&amp;</span> direction <span class="token operator">&lt;</span> <span class="token number">202.5</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>direction <span class="token operator">&gt;</span> <span class="token number">337.5</span> <span class="token operator">&amp;&amp;</span> direction <span class="token operator">&lt;</span> <span class="token number">360</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span>
                direction <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>direction <span class="token operator">&gt;</span> <span class="token number">22.5</span> <span class="token operator">&amp;&amp;</span> direction <span class="token operator">&lt;</span> <span class="token number">67.5</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>direction <span class="token operator">&gt;</span> <span class="token number">202.5</span> <span class="token operator">&amp;&amp;</span> direction <span class="token operator">&lt;</span> <span class="token number">247.5</span><span class="token punctuation">)</span>  <span class="token punctuation">)</span>
                direction <span class="token operator">=</span> <span class="token number">45</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>direction <span class="token operator">&gt;</span> <span class="token number">67.5</span> <span class="token operator">&amp;&amp;</span> direction <span class="token operator">&lt;</span> <span class="token number">112.5</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>direction <span class="token operator">&gt;</span> <span class="token number">247.5</span> <span class="token operator">&amp;&amp;</span> direction <span class="token operator">&lt;</span> <span class="token number">292.5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                direction <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>direction <span class="token operator">&gt;</span> <span class="token number">112.5</span> <span class="token operator">&amp;&amp;</span> direction <span class="token operator">&lt;</span> <span class="token number">157.5</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>direction <span class="token operator">&gt;</span> <span class="token number">292.5</span> <span class="token operator">&amp;&amp;</span> direction <span class="token operator">&lt;</span> <span class="token number">337.5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
                direction <span class="token operator">=</span> <span class="token number">135</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> 
				direction <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				
			orients<span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>direction<span class="token punctuation">;</span>
			count<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// init count</span>
	<span class="token comment">// non maximum suppression</span>
	<span class="token keyword">double</span> leftPixel<span class="token punctuation">,</span> rightPixel<span class="token punctuation">;</span>
	
	<span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">switch</span> <span class="token punctuation">(</span> orients<span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                   <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                        leftPixel  <span class="token operator">=</span> magMat<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        rightPixel <span class="token operator">=</span> magMat<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token number">45</span><span class="token operator">:</span>
                        leftPixel  <span class="token operator">=</span> magMat<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
						rightPixel <span class="token operator">=</span> magMat<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token number">90</span><span class="token operator">:</span>
                        leftPixel  <span class="token operator">=</span> magMat<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        rightPixel <span class="token operator">=</span> magMat<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token number">135</span><span class="token operator">:</span>
                        leftPixel  <span class="token operator">=</span> magMat<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        rightPixel <span class="token operator">=</span> magMat<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
				 <span class="token punctuation">}</span>
				<span class="token comment">// compare current pixels value with adjacent pixels</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>magMat<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> leftPixel<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>magMat<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> rightPixel<span class="token punctuation">)</span><span class="token punctuation">)</span>
					nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span><span class="token comment">//(nmsEdges-&gt;data.ptr + nmsEdges-&gt;step*i)[j]=0;</span>
                <span class="token keyword">else</span>
					nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>uchar<span class="token punctuation">)</span><span class="token punctuation">(</span>magMat<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/</span> MaxGradient <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//(nmsEdges-&gt;data.ptr + nmsEdges-&gt;step*i)[j]=(uchar)(magMat[i][j]/MaxGradient*255);</span>
			
				count<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>


	<span class="token keyword">int</span> RSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>CSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> curX<span class="token punctuation">,</span> curY<span class="token punctuation">;</span>
	<span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token comment">//Hysterisis threshold</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>width<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

			fdx <span class="token operator">=</span> gx<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
			fdy <span class="token operator">=</span> gy<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>


			MagG <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>fdx <span class="token operator">*</span> fdx <span class="token operator">+</span> fdy <span class="token operator">*</span> fdy<span class="token punctuation">)</span><span class="token punctuation">;</span> 
			DirG <span class="token operator">=</span> <span class="token function">atan2f</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>fdy<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>fdx<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		
			flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token keyword">double</span> val <span class="token operator">=</span> nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
			<span class="token keyword">if</span><span class="token punctuation">(</span> val <span class="token operator">&lt;</span> maxContrast<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>

				<span class="token keyword">if</span><span class="token punctuation">(</span>val <span class="token operator">&lt;</span> minContrast<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// remove from edge</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{<!-- --></span>   
					<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxContrast<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
						 <span class="token punctuation">(</span>nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxContrast<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
						 <span class="token punctuation">(</span>nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxContrast<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
						 <span class="token punctuation">(</span>nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxContrast<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
						 <span class="token punctuation">(</span>nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxContrast<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
						 <span class="token punctuation">(</span>nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxContrast<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
						 <span class="token punctuation">(</span>nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxContrast<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
						 <span class="token punctuation">(</span>nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxContrast<span class="token punctuation">)</span>
						<span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						nmsEdges<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
						flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				
			<span class="token punctuation">}</span>
			
			<span class="token comment">// save selected edge information</span>
			curX <span class="token operator">=</span> i<span class="token punctuation">;</span>	curY <span class="token operator">=</span> j<span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>fdx <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> fdy <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>		
					<span class="token comment">// Row sum and column sum for center of gravity</span>
					RSum <span class="token operator">=</span> RSum <span class="token operator">+</span> curX<span class="token punctuation">;</span>	
					CSum <span class="token operator">=</span> CSum <span class="token operator">+</span> curY<span class="token punctuation">;</span> 
					
					cordinates<span class="token punctuation">[</span>cordinates_num<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> curX<span class="token punctuation">;</span>
					cordinates<span class="token punctuation">[</span>cordinates_num<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> curY<span class="token punctuation">;</span>
					edge_derivativeX<span class="token punctuation">[</span>cordinates_num<span class="token punctuation">]</span> <span class="token operator">=</span> fdx<span class="token punctuation">;</span>
					edge_derivativeY<span class="token punctuation">[</span>cordinates_num<span class="token punctuation">]</span> <span class="token operator">=</span> fdy<span class="token punctuation">;</span>
					
					<span class="token comment">//handle divide by zero</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>MagG <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
						edge_magnitude<span class="token punctuation">[</span>cordinates_num<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span>MagG<span class="token punctuation">;</span>  <span class="token comment">// gradient magnitude </span>
					<span class="token keyword">else</span>
						edge_magnitude<span class="token punctuation">[</span>cordinates_num<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
															
					cordinates_num<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	center_gravity<span class="token punctuation">.</span>x <span class="token operator">=</span> RSum <span class="token operator">/</span> cordinates_num<span class="token punctuation">;</span> <span class="token comment">// center of gravity</span>
	center_gravity<span class="token punctuation">.</span>y <span class="token operator">=</span> CSum <span class="token operator">/</span> cordinates_num<span class="token punctuation">;</span>	<span class="token comment">// center of gravity</span>
		
	<span class="token comment">// change coordinates to reflect center of gravity</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> m <span class="token operator">&lt;</span> cordinates_num<span class="token punctuation">;</span> m<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> temp<span class="token punctuation">;</span>

		temp <span class="token operator">=</span> cordinates<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
		cordinates<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> temp <span class="token operator">-</span> center_gravity<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
		temp <span class="token operator">=</span> cordinates<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
		cordinates<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> temp <span class="token operator">-</span> center_gravity<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	
	modelDefined <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2__308"></a>2. 查找模板</h4> 
<p>要在图像中查找指定的模板对象。先要从包含一组点的模板图像创建的模型：</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          P 
         
        
          i 
         
        
          τ 
         
        
       
         = 
        
       
         ( 
        
        
        
          X 
         
        
          i 
         
        
          τ 
         
        
       
         , 
        
        
        
          Y 
         
        
          i 
         
        
          τ 
         
        
       
         ) 
         
       
      
        P_{i}^{\tau}=(X_{i}^{\tau},Y_{i}^{\tau})\, 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.942em; vertical-align: -0.2587em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4413em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1132em;">τ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.0087em; vertical-align: -0.2587em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0785em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4413em; margin-left: -0.0785em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1132em;">τ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.2222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -2.4413em; margin-left: -0.2222em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1132em;">τ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.1667em;"></span></span></span></span></span></p> 
<p>获取它在 X 和 Y 方向上的梯度 ：</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          G 
         
        
          i 
         
        
          T 
         
        
       
         = 
        
       
         ( 
        
       
         G 
        
        
        
          x 
         
        
          i 
         
        
          T 
         
        
       
         , 
        
       
         G 
        
        
        
          y 
         
        
          i 
         
        
          T 
         
        
       
         ) 
        
       
      
        G_{i}^{T}=(G x_{i}^{T},G y_{i}^{T}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1em; vertical-align: -0.2587em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1em; vertical-align: -0.2587em;"></span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">G</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -2.4413em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p> 
<p>当i = 1…n，n是模板 (T) 数据集中的元素数。还可以在搜索图像 (S) 中找到梯度：</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          G 
         
         
          
          
            a 
           
          
            ˉ 
           
          
         
           , 
          
         
           ν 
          
         
        
          S 
         
        
       
         = 
        
       
         ( 
        
       
         G 
        
        
        
          x 
         
         
         
           a 
          
         
           , 
          
         
           ν 
          
         
        
          S 
         
        
       
         , 
        
       
         G 
        
        
        
          y 
         
         
         
           a 
          
         
           , 
          
         
           ν 
          
         
        
          S 
         
        
       
         ) 
         
       
      
        G_{\bar{a},\nu}^{S}=(G x_{a,\nu}^{S},G y_{a,\nu}^{S})\, 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.2244em; vertical-align: -0.3831em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.5678em;"><span class="" style="top: -2.7em;"><span class="pstrut" style="height: 2.7em;"></span><span class="mord mathnormal mtight">a</span></span><span class="" style="top: -2.7em;"><span class="pstrut" style="height: 2.7em;"></span><span class="accent-body" style="left: -0.25em;"><span class="mord mtight">ˉ</span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0637em;">ν</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0576em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3831em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.2244em; vertical-align: -0.3831em;"></span><span class="mopen">(</span><span class="mord mathnormal">G</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0637em;">ν</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0576em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3831em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">G</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -2.453em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0637em;">ν</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0576em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3831em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.1667em;"></span></span></span></span></span></p> 
<p>当u = 1…搜索图像中的行数，v = 1…搜索图像中的列数。</p> 
<p>在匹配过程中，应使用相似性度量将模板模型与所有位置的搜索图像进行比较。相似性度量背后的思想是取模板图像梯度向量的所有归一化点积之和，并在模型数据集中的所有点上搜索图像。这会导致搜索图像中每个点的分数。</p> 
<p>公式为：</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          S 
         
         
         
           u 
          
         
           , 
          
         
           v 
          
         
        
       
         = 
        
        
        
          1 
         
        
          n 
         
        
        
        
          ∑ 
         
         
         
           i 
          
         
           = 
          
         
           1 
          
         
        
          n 
         
        
        
         
         
           ( 
          
         
           G 
          
          
          
            x 
           
          
            i 
           
          
            T 
           
          
         
           . 
          
         
           G 
          
          
          
            x 
           
           
           
             ( 
            
           
             u 
            
           
             + 
            
           
             X 
            
           
             i 
            
           
             , 
            
           
             v 
            
           
             + 
            
           
             Y 
            
           
             i 
            
           
             ) 
            
           
          
            S 
           
          
         
           ) 
          
         
           + 
          
         
           ( 
          
         
           G 
          
          
          
            y 
           
          
            i 
           
          
            T 
           
          
         
           . 
          
         
           G 
          
          
          
            y 
           
           
           
             ( 
            
           
             u 
            
           
             + 
            
           
             X 
            
           
             i 
            
           
             , 
            
           
             v 
            
           
             + 
            
           
             Y 
            
           
             i 
            
           
             ) 
            
           
          
            S 
           
          
         
           ) 
          
         
         
          
          
            G 
           
           
           
             x 
            
           
             i 
            
           
             T 
            
           
          
            + 
           
          
            G 
           
           
           
             y 
            
           
             i 
            
           
             T 
            
           
          
            . 
           
           
            
            
              G 
             
             
             
               x 
              
              
              
                ( 
               
              
                u 
               
              
                + 
               
              
                X 
               
              
                i 
               
              
                , 
               
              
                v 
               
              
                + 
               
              
                Y 
               
              
                i 
               
              
                ) 
               
              
             
               T 
              
             
            
           
          
            + 
           
          
            G 
           
           
           
             y 
            
            
            
              ( 
             
            
              u 
             
            
              + 
             
            
              X 
             
            
              i 
             
            
              , 
             
            
              v 
             
            
              + 
             
            
              Y 
             
            
              i 
             
            
              ) 
             
            
           
             T 
            
           
          
         
        
       
      
        S_{u,v}=\frac{1}{n}\sum_{i=1}^{n}\frac{(G x_{i}^{T}.G x_{(u+X i,v+Y i)}^{S})+(G y_{i}^{T}.G y_{(u+X i,v+Y i)}^{S})}{\sqrt{G x_{i}^{T}+G y_{i}^{T}.\sqrt{G x_{(u+X i,v+Y i)}^{T}}+G y_{(u+X i,v+Y i)}^{T}}} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.9185em; vertical-align: -1.6296em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8451em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position: relative; top: 0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8043em;"><span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.2029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2997em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.2889em;"><span class="" style="top: -2.19em;"><span class="pstrut" style="height: 3.0855em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.5507em;"><span class="svg-align" style="top: -4.5714em;"><span class="pstrut" style="height: 4.5714em;"></span><span class="mord mtight" style="padding-left: 1.4286em;"><span class="mord mathnormal mtight">G</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8329em;"><span class="" style="top: -2.1777em; margin-left: 0em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -2.8448em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3223em;"><span class=""></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">G</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8329em;"><span class="" style="top: -2.1777em; margin-left: -0.0359em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -2.8448em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3223em;"><span class=""></span></span></span></span></span></span><span class="mord mtight">.</span><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0635em;"><span class="svg-align" style="top: -3.7143em;"><span class="pstrut" style="height: 3.7143em;"></span><span class="mord mtight" style="padding-left: 1.4286em;"><span class="mord mathnormal mtight">G</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8329em;"><span class="" style="top: -2.1488em; margin-left: 0em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">u</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right: 0.0785em;">X</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">v</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">Yi</span><span class="mclose mtight">)</span></span></span></span><span class="" style="top: -2.8805em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.5655em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.0355em;"><span class="pstrut" style="height: 3.7143em;"></span><span class="hide-tail mtight" style="min-width: 1.02em; height: 1.8286em;"> 
                         <svg width="400em" height="1.8286em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
                          <path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"></path> 
                         </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.6788em;"><span class=""></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">G</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8329em;"><span class="" style="top: -2.1488em; margin-left: -0.0359em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">u</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right: 0.0785em;">X</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">v</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">Yi</span><span class="mclose mtight">)</span></span></span></span><span class="" style="top: -2.8805em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.5655em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.5227em;"><span class="pstrut" style="height: 4.5714em;"></span><span class="hide-tail mtight" style="min-width: 1.02em; height: 2.6857em;"> 
                   <svg width="400em" height="2.6857em" viewbox="0 0 400000 1944" preserveaspectratio="xMinYMin slice"> 
                    <path d="M983 90
l0 -0
c4,-6.7,10,-10,18,-10 H400000v40
H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7
s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744
c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30
c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722
c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5
c53.7,-170.3,84.5,-266.8,92.5,-289.5z
M1001 80h400000v40h-400000z"></path> 
                   </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.0488em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.3155em;"><span class="pstrut" style="height: 3.0855em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.731em;"><span class="pstrut" style="height: 3.0855em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">G</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9191em;"><span class="" style="top: -2.214em; margin-left: 0em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286em;"><span class=""></span></span></span></span></span></span><span class="mord mtight">.</span><span class="mord mathnormal mtight">G</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9191em;"><span class="" style="top: -2.235em; margin-left: 0em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">u</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right: 0.0785em;">X</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">v</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">Yi</span><span class="mclose mtight">)</span></span></span></span><span class="" style="top: -2.9667em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0576em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4793em;"><span class=""></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mbin mtight">+</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">G</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9191em;"><span class="" style="top: -2.214em; margin-left: -0.0359em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286em;"><span class=""></span></span></span></span></span></span><span class="mord mtight">.</span><span class="mord mathnormal mtight">G</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9191em;"><span class="" style="top: -2.235em; margin-left: -0.0359em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">u</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right: 0.0785em;">X</span><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">v</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">Yi</span><span class="mclose mtight">)</span></span></span></span><span class="" style="top: -2.9667em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0576em;">S</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4793em;"><span class=""></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.6296em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p> 
<p>如果模板模型和搜索图像之间存在完美匹配，则相似性度量函数将返回分数 1。该分数对应于搜索图像中可见的对象部分与模板模型的匹配程度。如果搜索图像中不存在对象或对象不可见，则分数将为 0。分数的范围在 0 到 1 之间，可用于衡量匹配的相似程度。</p> 
<p>在实际情况下，处理的时候需要加快搜索过程。这可以使用各种方法来实现。第一种方法是使用平均的属性。在寻找相似性度量时，如果可以为相似性度量设置一个最小分数（S min），就不需要评估模板模型中的所有点。为了检查特定点 J 处的部分分数 S u,v，必须找到部分总和 Sm。点 m 处的 Sm 可以定义如下：<br> <img src="https://images2.imgbox.com/b5/83/FOQxPuvO_o.png" alt="在这里插入图片描述"><br> 当剩余项小于或等于 1，可以停止评估 ，另一个标准可以是任何点的部分分数应大于最低分数。<br> 使用硬标准和安全停止标准结合的方法是为了提高匹配的效率。这种方法允许在匹配的早期阶段更快速地排除那些不太可能是匹配项的位置，从而加速整个匹配过程。<br> 在这个过程中，贪婪参数 (g) 起着关键的作用。通过调整 (g) 的值，用户可以灵活地控制使用硬标准检查的模板模型的部分。当 (g = 1) 时，模板模型中的所有点都用硬标准检查，这意味着在整个匹配过程中都使用硬标准。而当 (g = 0) 时，所有点只用安全标准检查，这意味着整个匹配过程都使用安全停止标准。</p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          S 
         
        
          m 
         
        
       
           
        
       
         &lt; 
        
       
         M 
        
       
         I 
        
       
         N 
        
       
         ( 
        
       
         ( 
        
        
        
          S 
         
         
         
           m 
          
         
           i 
          
         
           n 
          
         
        
       
         − 
        
       
         1 
        
       
         + 
        
        
         
         
           1 
          
         
           − 
          
         
           g 
           
          
          
            S 
           
           
           
             m 
            
           
             i 
            
           
             n 
            
           
          
         
         
         
           1 
          
         
           − 
          
         
           g 
          
         
        ⁣ 
       
         ⋅ 
        ⁣ 
        
        
          m 
         
        
          n 
         
        
       
         ) 
        
       
         , 
        
       
         ( 
        
        
        
          S 
         
         
         
           m 
          
         
           i 
          
         
           n 
          
         
        ⁣ 
       
         ⋅ 
        ⁣ 
        
        
          m 
         
        
          n 
         
        
       
         ) 
        
       
         ) 
        
       
      
        S_{m}\ \lt M I N\bigg(\Big(S^{m i n}-1+{\frac{1-g\,S^{m i n}}{1-g}}\!\cdot\!{\frac{m}{n}}\Big),(S^{m i n}\!\cdot\!{\frac{m}{n}})\bigg) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace"> </span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span><span class="mord mathnormal" style="margin-right: 0.0785em;">I</span><span class="mord mathnormal" style="margin-right: 0.109em;">N</span><span class="mord"><span class="delimsizing size3">(</span></span><span class="mord"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8247em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.5587em; vertical-align: -0.4811em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0776em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.4461em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">g</span><span class="mspace mtight" style="margin-right: 0.1952em;"></span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9021em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4811em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right: -0.1667em;"></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: -0.1667em;"></span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.8em; vertical-align: -0.65em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6954em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mord"><span class="delimsizing size2">)</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8247em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: -0.1667em;"></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: -0.1667em;"></span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.4em; vertical-align: -0.95em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6954em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mclose">)</span><span class="mord"><span class="delimsizing size3">)</span></span></span></span></span></span></p> 
<p>这种方法的优势在于可以根据具体情况调整 (g) 的值，以在保持一定匹配准确性的同时实现更高的匹配速度。</p> 
<p>模板查找代码：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">double</span> <span class="token class-name">GeoMatch</span><span class="token double-colon punctuation">::</span><span class="token function">find_match_model</span><span class="token punctuation">(</span>Mat <span class="token operator">&amp;</span>cv_src<span class="token punctuation">,</span> <span class="token keyword">double</span> minScore<span class="token punctuation">,</span> <span class="token keyword">double</span> greediness<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>Point <span class="token operator">&amp;</span>result_point<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	Mat Sdx<span class="token punctuation">,</span> Sdy<span class="token punctuation">;</span>
	
	<span class="token keyword">double</span> resultScore <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">double</span> partialSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">double</span> sumOfCoords <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">double</span> partialScore<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">short</span><span class="token operator">*</span> _Sdx<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">short</span><span class="token operator">*</span> _Sdy<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>m <span class="token punctuation">;</span>			<span class="token comment">// count variables</span>
	<span class="token keyword">double</span> iTx<span class="token punctuation">,</span> iTy<span class="token punctuation">,</span> iSx<span class="token punctuation">,</span> iSy<span class="token punctuation">;</span>
	<span class="token keyword">double</span> gradMag<span class="token punctuation">;</span>    
	<span class="token keyword">int</span> curX<span class="token punctuation">,</span>curY<span class="token punctuation">;</span>

	std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span> matGradMag<span class="token punctuation">;</span>
	
	Mat src <span class="token operator">=</span> cv_src<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// source image size</span>
	Size Ssize<span class="token punctuation">;</span>
	Ssize<span class="token punctuation">.</span>width <span class="token operator">=</span>  src<span class="token punctuation">.</span>cols<span class="token punctuation">;</span>
	Ssize<span class="token punctuation">.</span>height<span class="token operator">=</span> src<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>
	
	<span class="token function">create_double_matrix</span><span class="token punctuation">(</span>matGradMag<span class="token punctuation">,</span> Ssize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建图像以保存梯度大小值</span>
		
	Sdx <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span> Ssize<span class="token punctuation">.</span>height<span class="token punctuation">,</span> Ssize<span class="token punctuation">.</span>width<span class="token punctuation">,</span> CV_16SC1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// X derivatives</span>
	Sdy <span class="token operator">=</span> <span class="token function">Mat</span><span class="token punctuation">(</span> Ssize<span class="token punctuation">.</span>height<span class="token punctuation">,</span> Ssize<span class="token punctuation">.</span>width<span class="token punctuation">,</span> CV_16SC1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// y derivatives</span>
	
	<span class="token function">Sobel</span><span class="token punctuation">(</span> src<span class="token punctuation">,</span> Sdx<span class="token punctuation">,</span> CV_16S<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// find X derivatives</span>
	<span class="token function">Sobel</span><span class="token punctuation">(</span> src<span class="token punctuation">,</span> Sdy<span class="token punctuation">,</span> CV_16S<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// find Y derivatives</span>
		
	<span class="token comment">// stoping criterias to search for model</span>
	<span class="token keyword">double</span> normMinScore <span class="token operator">=</span> minScore <span class="token operator">/</span> cordinates_num<span class="token punctuation">;</span> <span class="token comment">// precompute minumum score </span>
	<span class="token keyword">double</span> normGreediness <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> greediness <span class="token operator">*</span> minScore<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> greediness<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> cordinates_num<span class="token punctuation">;</span> <span class="token comment">// precompute greedniness </span>

	<span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>height<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>width<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>

			iSx <span class="token operator">=</span> Sdx<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
			iSy <span class="token operator">=</span> Sdy<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>

				gradMag <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>iSx <span class="token operator">*</span> iSx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>iSy <span class="token operator">*</span> iSy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Magnitude = Sqrt(dx^2 +dy^2)</span>
							
				<span class="token keyword">if</span><span class="token punctuation">(</span>gradMag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// hande divide by zero</span>
					matGradMag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> gradMag<span class="token punctuation">;</span>   <span class="token comment">// 1/Sqrt(dx^2 +dy^2)</span>
				<span class="token keyword">else</span>
					matGradMag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>height<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> Ssize<span class="token punctuation">.</span>width<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span> 
				partialSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// initilize partialSum measure</span>
				<span class="token keyword">for</span><span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> m <span class="token operator">&lt;</span> cordinates_num<span class="token punctuation">;</span> m<span class="token operator">++</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					curX	<span class="token operator">=</span> i <span class="token operator">+</span> cordinates<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token punctuation">;</span>	<span class="token comment">// template X coordinate</span>
					curY	<span class="token operator">=</span> j <span class="token operator">+</span> cordinates<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token punctuation">;</span> <span class="token comment">// template Y coordinate</span>
					iTx	<span class="token operator">=</span> edge_derivativeX<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// template X derivative</span>
					iTy	<span class="token operator">=</span> edge_derivativeY<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// template Y derivative</span>

					<span class="token keyword">if</span><span class="token punctuation">(</span>curX <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> curY <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> curX <span class="token operator">&gt;</span> Ssize<span class="token punctuation">.</span>height <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">||</span> curY <span class="token operator">&gt;</span> Ssize<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
						<span class="token keyword">continue</span><span class="token punctuation">;</span>
					

					iSx <span class="token operator">=</span> Sdx<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>curX<span class="token punctuation">,</span> curY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//CHECK IF curX AND curY NEED TO BE SWITCHED</span>
					iSy <span class="token operator">=</span> Sdy<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">short</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>curX<span class="token punctuation">,</span> curY<span class="token punctuation">)</span><span class="token punctuation">;</span>
					 	
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>iSx <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> iSy <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>iTx <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> iTy <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">//partial Sum  = Sum of(((Source X derivative* Template X drivative) + Source Y derivative * Template Y derivative)) / Edge magnitude of(Template)* edge magnitude of(Source))</span>
					partialSum <span class="token operator">=</span> partialSum <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>iSx <span class="token operator">*</span> iTx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>iSy <span class="token operator">*</span> iTy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>edge_magnitude<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">*</span> matGradMag<span class="token punctuation">[</span>curX<span class="token punctuation">]</span><span class="token punctuation">[</span>curY<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			
				<span class="token punctuation">}</span>

				sumOfCoords <span class="token operator">=</span> m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
				partialScore <span class="token operator">=</span> partialSum <span class="token operator">/</span> sumOfCoords <span class="token punctuation">;</span>
				<span class="token comment">// check termination criteria</span>
				<span class="token comment">// if partial score score is less than the score than needed to make the required score at that position</span>
				<span class="token comment">// break serching at that coordinate.</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> partialScore <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token function">MIN</span><span class="token punctuation">(</span><span class="token punctuation">(</span>minScore <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> normGreediness <span class="token operator">*</span> sumOfCoords<span class="token punctuation">,</span> normMinScore <span class="token operator">*</span> sumOfCoords<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
									
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>partialScore <span class="token operator">&gt;</span> resultScore<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				resultScore <span class="token operator">=</span> partialScore<span class="token punctuation">;</span> <span class="token comment">//  Match score</span>
				result_point<span class="token punctuation">.</span>x <span class="token operator">=</span> i<span class="token punctuation">;</span>
				result_point<span class="token punctuation">.</span>y <span class="token operator">=</span> j<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> 
	<span class="token punctuation">}</span>
	
	Sdx<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Sdy<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> resultScore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>测试效果如下：</p> 
<p><img src="https://images2.imgbox.com/98/0f/0yJVDKTc_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ff08a06b799be243473af0e4e86132fa/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">（四） ClickHouse 中使用 `MaterializedMySQL` 引擎单独同步 MySQL 数据库中的特定表（例如 `aaa` 和 `bbb`）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b519d6269196ad42731d0164b110fe48/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Xcode 编译速度慢是什么原因？如何提高编译速度？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>