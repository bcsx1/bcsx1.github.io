<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>权限管理系统项目文档——SpringBoot后端 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="权限管理系统项目文档——SpringBoot后端" />
<meta property="og:description" content="文章目录 关键技术第一篇 后端实现篇1. 搭建开发环境2. 集成Swagger文档3. 集成MyBatis框架4. 集成Druid数据源5. 跨域解决方案6. 业务功能实现6.1 工程结构规划6.1.1 mango-admin6.1.2 mango-common6.1.3 mango-core6.1.4 mango-pom6.1.5 打包测试 6.2 业务代码封装6.2.1 通用CURD接口6.2.2 分页请求封装6.2.3 分页结果封装6.2.4 分页助手封装6.2.5 HTTP结果封装 6.3 MyBatis分页查询6.3.1 添加依赖6.3.2 添加配置6.3.3 分页代码6.3.4 接口测试 6.4 业务功能开发6.4.1 编写DAO接口6.4.2 编写映射文件6.4.3 编写服务接口6.4.4 编写服务实现6.4.5 编写控制器 6.5 业务接口汇总6.6 导出Excel报表6.6.1 添加依赖6.6.2 编写服务接口6.6.3 编写服务实现6.6.4 编写控制器6.6.5 工具类代码6.6.6 接口测试 7. 登录流程实现7.1 登录验证码7.2 Spring Security7.2.1 添加依赖7.2.2 添加配置7.2.3 登录认证过滤器7.2.4 身份验证组件7.2.5 认证信息查询7.2.6 添加权限注解7.2.7 Swagger添加令牌函数 7.3 登录接口实现7.4 Spring Security执行流程剖析 8. 数据备份还原8.1 新建工程8.2 添加依赖8.3 添加配置8.4 自定义Banner8.5 启动类8.6 跨域配置8.7 Swagger配置8.8 数据源属性8." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2b8d0502b2cee05cd11d6c40f5339189/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-12T02:51:43+08:00" />
<meta property="article:modified_time" content="2022-02-12T02:51:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">权限管理系统项目文档——SpringBoot后端</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_10" rel="nofollow">关键技术</a></li><li><a href="#__44" rel="nofollow">第一篇 后端实现篇</a></li><li><ul><li><a href="#1__46" rel="nofollow">1. 搭建开发环境</a></li><li><a href="#2_Swagger_99" rel="nofollow">2. 集成Swagger文档</a></li><li><a href="#3_MyBatis_160" rel="nofollow">3. 集成MyBatis框架</a></li><li><a href="#4_Druid_391" rel="nofollow">4. 集成Druid数据源</a></li><li><a href="#5__646" rel="nofollow">5. 跨域解决方案</a></li><li><a href="#6__734" rel="nofollow">6. 业务功能实现</a></li><li><ul><li><a href="#61__738" rel="nofollow">6.1 工程结构规划</a></li><li><ul><li><a href="#611_mangoadmin_749" rel="nofollow">6.1.1 mango-admin</a></li><li><a href="#612_mangocommon_761" rel="nofollow">6.1.2 mango-common</a></li><li><a href="#613_mangocore_765" rel="nofollow">6.1.3 mango-core</a></li><li><a href="#614_mangopom_769" rel="nofollow">6.1.4 mango-pom</a></li><li><a href="#615__773" rel="nofollow">6.1.5 打包测试</a></li></ul> 
    </li><li><a href="#62__816" rel="nofollow">6.2 业务代码封装</a></li><li><ul><li><a href="#621_CURD_823" rel="nofollow">6.2.1 通用CURD接口</a></li><li><a href="#622__872" rel="nofollow">6.2.2 分页请求封装</a></li><li><a href="#623__917" rel="nofollow">6.2.3 分页结果封装</a></li><li><a href="#624__978" rel="nofollow">6.2.4 分页助手封装</a></li><li><a href="#625_HTTP_1037" rel="nofollow">6.2.5 HTTP结果封装</a></li></ul> 
    </li><li><a href="#63_MyBatis_1107" rel="nofollow">6.3 MyBatis分页查询</a></li><li><ul><li><a href="#631__1111" rel="nofollow">6.3.1 添加依赖</a></li><li><a href="#632__1124" rel="nofollow">6.3.2 添加配置</a></li><li><a href="#633__1138" rel="nofollow">6.3.3 分页代码</a></li><li><a href="#634__1205" rel="nofollow">6.3.4 接口测试</a></li></ul> 
    </li><li><a href="#64__1215" rel="nofollow">6.4 业务功能开发</a></li><li><ul><li><a href="#641_DAO_1221" rel="nofollow">6.4.1 编写DAO接口</a></li><li><a href="#642__1237" rel="nofollow">6.4.2 编写映射文件</a></li><li><a href="#643__1264" rel="nofollow">6.4.3 编写服务接口</a></li><li><a href="#644__1282" rel="nofollow">6.4.4 编写服务实现</a></li><li><a href="#645__1338" rel="nofollow">6.4.5 编写控制器</a></li></ul> 
    </li><li><a href="#65__1376" rel="nofollow">6.5 业务接口汇总</a></li><li><a href="#66_Excel_1378" rel="nofollow">6.6 导出Excel报表</a></li><li><ul><li><a href="#661__1386" rel="nofollow">6.6.1 添加依赖</a></li><li><a href="#662__1399" rel="nofollow">6.6.2 编写服务接口</a></li><li><a href="#663__1414" rel="nofollow">6.6.3 编写服务实现</a></li><li><a href="#664__1474" rel="nofollow">6.6.4 编写控制器</a></li><li><a href="#665__1488" rel="nofollow">6.6.5 工具类代码</a></li><li><a href="#666__1560" rel="nofollow">6.6.6 接口测试</a></li></ul> 
   </li></ul> 
   </li><li><a href="#7__1571" rel="nofollow">7. 登录流程实现</a></li><li><ul><li><a href="#71__1575" rel="nofollow">7.1 登录验证码</a></li><li><a href="#72_Spring_Security_1695" rel="nofollow">7.2 Spring Security</a></li><li><ul><li><a href="#721__1703" rel="nofollow">7.2.1 添加依赖</a></li><li><a href="#722__1721" rel="nofollow">7.2.2 添加配置</a></li><li><a href="#723__1782" rel="nofollow">7.2.3 登录认证过滤器</a></li><li><a href="#724__1897" rel="nofollow">7.2.4 身份验证组件</a></li><li><a href="#725__1930" rel="nofollow">7.2.5 认证信息查询</a></li><li><a href="#726__2052" rel="nofollow">7.2.6 添加权限注解</a></li><li><a href="#727_Swagger_2094" rel="nofollow">7.2.7 Swagger添加令牌函数</a></li></ul> 
    </li><li><a href="#73__2136" rel="nofollow">7.3 登录接口实现</a></li><li><a href="#74_Spring_Security_2313" rel="nofollow">7.4 Spring Security执行流程剖析</a></li></ul> 
   </li><li><a href="#8__2319" rel="nofollow">8. 数据备份还原</a></li><li><ul><li><a href="#81__2323" rel="nofollow">8.1 新建工程</a></li><li><a href="#82__2327" rel="nofollow">8.2 添加依赖</a></li><li><a href="#83__2357" rel="nofollow">8.3 添加配置</a></li><li><a href="#84_Banner_2378" rel="nofollow">8.4 自定义Banner</a></li><li><a href="#85__2380" rel="nofollow">8.5 启动类</a></li><li><a href="#86__2396" rel="nofollow">8.6 跨域配置</a></li><li><a href="#87_Swagger_2418" rel="nofollow">8.7 Swagger配置</a></li><li><a href="#88__2438" rel="nofollow">8.8 数据源属性</a></li><li><a href="#89__2490" rel="nofollow">8.9 备份还原接口</a></li><li><a href="#810__2526" rel="nofollow">8.10 备份还原实现</a></li><li><a href="#811__2550" rel="nofollow">8.11 备份还原逻辑</a></li><li><a href="#812__2675" rel="nofollow">8.12 备份还原控制器</a></li><li><ul><li><a href="#8121__2679" rel="nofollow">8.12.1 数据备份接口</a></li><li><a href="#8122__2709" rel="nofollow">8.12.2 数据还原接口</a></li><li><a href="#8123__2730" rel="nofollow">8.12.3 查找备份接口</a></li><li><a href="#8124__2761" rel="nofollow">8.12.4 删除备份接口</a></li></ul> 
   </li></ul> 
   </li><li><a href="#9__2781" rel="nofollow">9. 系统服务监控</a></li><li><ul><li><a href="#91__2785" rel="nofollow">9.1 新建工程</a></li><li><a href="#92__2789" rel="nofollow">9.2 添加依赖</a></li><li><a href="#93__2814" rel="nofollow">9.3 添加配置</a></li><li><a href="#94_Banner_2826" rel="nofollow">9.4 自定义Banner</a></li><li><a href="#95__2828" rel="nofollow">9.5 启动类</a></li><li><a href="#96__2843" rel="nofollow">9.6 监控客户端</a></li><li><a href="#97__2899" rel="nofollow">9.7 启动服务端</a></li></ul> 
   </li><li><a href="#10_Consul_2906" rel="nofollow">10. 注册中心(Consul)</a></li><li><ul><li><a href="#101_Consul_2908" rel="nofollow">10.1 什么是Consul</a></li><li><a href="#102_Consul_2912" rel="nofollow">10.2 Consul安装</a></li><li><a href="#103_monitor_2930" rel="nofollow">10.3 monitor改造</a></li><li><ul><li><a href="#1031__2934" rel="nofollow">10.3.1 添加依赖</a></li><li><a href="#1032__2963" rel="nofollow">10.3.2 配置文件</a></li><li><a href="#1033__2983" rel="nofollow">10.3.3 启动类</a></li><li><a href="#1034__2987" rel="nofollow">10.3.4 测试效果</a></li></ul> 
    </li><li><a href="#104_backup_2999" rel="nofollow">10.4 backup改造</a></li><li><ul><li><a href="#1041__3003" rel="nofollow">10.4.1 添加依赖</a></li><li><a href="#1042__3007" rel="nofollow">10.4.2 配置文件</a></li><li><a href="#1043__3049" rel="nofollow">10.4.3 启动类</a></li><li><a href="#1044__3053" rel="nofollow">10.4.4 测试效果</a></li></ul> 
    </li><li><a href="#105_admin_3057" rel="nofollow">10.5 admin改造</a></li><li><ul><li><a href="#1051__3061" rel="nofollow">10.5.1 添加依赖</a></li><li><a href="#1052__3065" rel="nofollow">10.5.2 配置文件</a></li><li><a href="#1053__3120" rel="nofollow">10.5.3 启动类</a></li><li><a href="#1054__3124" rel="nofollow">10.5.4 测试效果</a></li></ul> 
   </li></ul> 
   </li><li><a href="#11_RibbonFeign_3128" rel="nofollow">11. 服务消费(Ribbon、Feign)</a></li><li><ul><li><a href="#111__3130" rel="nofollow">11.1 技术背景</a></li><li><a href="#112__3141" rel="nofollow">11.2 服务提供者</a></li><li><ul><li><a href="#1121__3143" rel="nofollow">11.2.1 新建项目</a></li><li><a href="#1122__3189" rel="nofollow">11.2.2 配置文件</a></li><li><a href="#1123__3222" rel="nofollow">11.2.3 启动类</a></li><li><a href="#1124_Banner_3226" rel="nofollow">11.2.4 自定义Banner</a></li><li><a href="#1125__3230" rel="nofollow">11.2.5 添加控制器</a></li></ul> 
    </li><li><a href="#113__3269" rel="nofollow">11.3 服务消费者</a></li><li><ul><li><a href="#1131__3271" rel="nofollow">11.3.1 新建项目</a></li><li><a href="#1132__3281" rel="nofollow">11.3.2 添加配置</a></li><li><a href="#1133__3312" rel="nofollow">11.3.3 启动类、</a></li><li><a href="#1134_Banner_3316" rel="nofollow">11.3.4 自定义Banner</a></li><li><a href="#1135__3320" rel="nofollow">11.3.5 服务消费</a></li><li><a href="#1136_Ribbon_3400" rel="nofollow">11.3.6 负载均衡器(Ribbon)</a></li><li><a href="#1137__3424" rel="nofollow">11.3.7 修改启动类</a></li><li><a href="#1138__3446" rel="nofollow">11.3.8 添加服务</a></li><li><a href="#1139__3466" rel="nofollow">11.3.9 页面测试</a></li><li><a href="#11310__3472" rel="nofollow">11.3.10 负载策略</a></li></ul> 
    </li><li><a href="#114_Feign_3476" rel="nofollow">11.4 服务消费(Feign)</a></li><li><ul><li><a href="#1141__3480" rel="nofollow">11.4.1 添加依赖</a></li><li><a href="#1142__3492" rel="nofollow">11.4.2 启动类</a></li><li><a href="#1143_Feign_3496" rel="nofollow">11.4.3 添加Feign接口</a></li><li><a href="#1144__3510" rel="nofollow">11.4.4 添加控制器</a></li><li><a href="#1145__3530" rel="nofollow">11.4.5 页面测试</a></li></ul> 
   </li></ul> 
   </li><li><a href="#12_HystrixTurbine_3536" rel="nofollow">12. 服务熔断(Hystrix、Turbine)</a></li><li><ul><li><a href="#121__3538" rel="nofollow">12.1 雪崩效应</a></li><li><a href="#122_CircuitBreaker_3544" rel="nofollow">12.2 熔断器(CircuitBreaker)</a></li><li><a href="#123_Hystrix_3548" rel="nofollow">12.3 Hystrix特性</a></li><li><ul><li><a href="#1231__3550" rel="nofollow">12.3.1 断路器机制%</a></li><li><a href="#1232_fallback_3554" rel="nofollow">12.3.2 fallback</a></li><li><a href="#1233__3558" rel="nofollow">12.3.3 资源隔离</a></li></ul> 
    </li><li><a href="#124_Feign_Hystrix_3562" rel="nofollow">12.4 Feign Hystrix</a></li><li><ul><li><a href="#1241__3566" rel="nofollow">12.4.1 修改配置</a></li><li><a href="#1242__3579" rel="nofollow">12.4.2 创建回调类</a></li><li><a href="#1243__3612" rel="nofollow">12.4.3 页面测试</a></li></ul> 
    </li><li><a href="#125_Hystrix_Dashboard_3626" rel="nofollow">12.5 Hystrix Dashboard</a></li><li><ul><li><a href="#1251__3630" rel="nofollow">12.5.1 添加依赖</a></li><li><a href="#1252__3682" rel="nofollow">12.5.2 启动类</a></li><li><a href="#1253_Banner_3686" rel="nofollow">12.5.3 自定义Banner</a></li><li><a href="#1254__3690" rel="nofollow">12.5.4 配置文件</a></li><li><a href="#1255__3715" rel="nofollow">12.5.5 配置监控路径</a></li><li><a href="#1256__3753" rel="nofollow">12.5.6 页面测试</a></li></ul> 
    </li><li><a href="#126_Spring_Cloud_Turbine_3782" rel="nofollow">12.6 Spring Cloud Turbine</a></li><li><ul><li><a href="#1261__3786" rel="nofollow">12.6.1 添加依赖</a></li><li><a href="#1262__3806" rel="nofollow">12.6.2 启动类</a></li><li><a href="#1263__3810" rel="nofollow">12.6.3 配置文件</a></li><li><a href="#1264__3835" rel="nofollow">12.6.4 测试效果</a></li></ul> 
   </li></ul> 
   </li><li><a href="#13_Zuul_3842" rel="nofollow">13. 服务网关(Zuul)</a></li><li><ul><li><a href="#131__3844" rel="nofollow">13.1 技术背景</a></li><li><a href="#132_Spring_Cloud_Zuul_3866" rel="nofollow">13.2 Spring Cloud Zuul</a></li><li><a href="#133_Zuul_3874" rel="nofollow">13.3 Zuul工作机制</a></li><li><ul><li><a href="#1331__3876" rel="nofollow">13.3.1 过滤器机制</a></li><li><a href="#1332__3883" rel="nofollow">13.3.2 过滤器的生命周期</a></li><li><a href="#1333_Filter_3969" rel="nofollow">13.3.3 禁用指定的Filter</a></li></ul> 
   </li></ul> 
   </li><li><a href="#134__4007" rel="nofollow">13.4 实现案例</a></li><li><ul><li><ul><li><a href="#1341__4009" rel="nofollow">13.4.1 新建工程</a></li><li><a href="#1342__4013" rel="nofollow">13.4.2 添加依赖</a></li><li><a href="#1343__4044" rel="nofollow">13.4.3 启动类</a></li><li><a href="#1344__4048" rel="nofollow">13.4.4 配置文件</a></li><li><a href="#1345__4076" rel="nofollow">13.4.5 页面测试</a></li><li><a href="#1346__4088" rel="nofollow">13.4.6 配置接口前缀</a></li><li><a href="#1347__4104" rel="nofollow">13.4.7 默认路由规则</a></li><li><a href="#1348__4112" rel="nofollow">13.4.8 路由熔断</a></li><li><a href="#1349_Filter_4174" rel="nofollow">13.4.9 自定义Filter</a></li></ul> 
   </li></ul> 
   </li><li><a href="#14_SleuthZipkin_4237" rel="nofollow">14. 链路追踪(Sleuth、Zipkin)</a></li><li><ul><li><a href="#141__4239" rel="nofollow">14.1 技术背景</a></li><li><a href="#142_ZipKin_4243" rel="nofollow">14.2 ZipKin</a></li><li><a href="#143_Spring_Cloud_Sleuth_4251" rel="nofollow">14.3 Spring Cloud Sleuth</a></li><li><a href="#144__4263" rel="nofollow">14.4 实现案例</a></li><li><ul><li><a href="#1441__4267" rel="nofollow">14.4.1 下载镜像</a></li><li><a href="#1442__4294" rel="nofollow">14.4.2 编写启动文件</a></li></ul> 
   </li></ul> 
   </li><li><a href="#14_4298" rel="nofollow">14参考</a></li><li><a href="#15_ConfigBus_4306" rel="nofollow">15. 配置中心(Config、Bus)</a></li><li><ul><li><a href="#151__4308" rel="nofollow">15.1 技术背景</a></li><li><a href="#152_Spring_Cloud_Config_4314" rel="nofollow">15.2 Spring Cloud Config</a></li><li><a href="#153__4320" rel="nofollow">15.3 实现案例</a></li><li><ul><li><a href="#1531__4322" rel="nofollow">15.3.1 准备配置文件</a></li><li><a href="#1532__4330" rel="nofollow">15.3.2 服务端实现</a></li><li><a href="#1533__4413" rel="nofollow">15.3.3 客户端实现</a></li><li><a href="#1534_Refresh_4522" rel="nofollow">15.3.4 Refresh机制</a></li><li><a href="#1535_Spring_Cloud_Bus_4582" rel="nofollow">15.3.5 Spring Cloud Bus</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<blockquote> 
 <p>前后端源码以及markdown笔记及转化的pdf文件均已上传网盘：<br> 链接：<a href="https://pan.baidu.com/s/1BVXTBAJfAYGS01n8fP2GvA" rel="nofollow">https://pan.baidu.com/s/1BVXTBAJfAYGS01n8fP2GvA</a> 提取码：ziyi</p> 
</blockquote> 
<h2><a id="_10"></a>关键技术</h2> 
<ol><li> <p>Spring Boot</p> <p>官方教程：<a href="https://spring.io/projects/spring-boot/" rel="nofollow">https://spring.io/projects/spring-boot/</a></p> </li><li> <p>Spring Cloud</p> <p>官方教程：<a href="https://spring.io/projects/spring-cloud" rel="nofollow">https://spring.io/projects/spring-cloud</a></p> <p>博客教程：<a href="https://www.cnblogs.com/xifengxiaoma/" rel="nofollow">https://www.cnblogs.com/xifengxiaoma/</a></p> </li><li> <p>Spring Security</p> <p>官方教程：<a href="https://spring.io/projects/spring-security" rel="nofollow">https://spring.io/projects/spring-security</a></p> <p>博客教程：<a href="https://www.cnblogs.com/xifengxiaoma/" rel="nofollow">https://www.cnblogs.com/xifengxiaoma/</a></p> </li><li> <p>MaBatis</p> <p>官方教程：<a href="http://www.mybatis.org/mybatis-3/zh/" rel="nofollow">http://www.mybatis.org/mybatis-3/zh/</a></p> <p>博客教程：<a href="https://www.w3cschool.cn/mybatis/" rel="nofollow">https://www.w3cschool.cn/mybatis/</a></p> </li><li> <p>Vue.js</p> <p>官方教程：<a href="https://cn.vuejs.org/v2/guide/" rel="nofollow">https://cn.vuejs.org/v2/guide/</a></p> <p>博客教程：<a href="https://www.runoob.com/vue2/vue-tutorial.html" rel="nofollow">https://www.runoob.com/vue2/vue-tutorial.html</a></p> </li><li> <p>Element</p> <p>官网教程：<a href="http://element.eleme.io/#/zh-CN" rel="nofollow">http://element.eleme.io/#/zh-CN</a></p> </li></ol> 
<h2><a id="__44"></a>第一篇 后端实现篇</h2> 
<h3><a id="1__46"></a>1. 搭建开发环境</h3> 
<ol><li> <p>登录spring initializer生成spring boot项目模板，保存到本地，网站地址为<a href="https://start.spring.io/" rel="nofollow">https://start.spring.io/</a>。</p> </li><li> <p>将maven项目导入到eclipse，修改application配置文件为yml后缀，清理掉不需要的mvnw、mvnw.cmd和test目录下的测试文件。</p> </li><li> <p>编译打包运行，右击pom.xml，选择run as→maven install。</p> </li><li> <p>启动应用，右击DemoApplication，选择run as→Java application。</p> </li><li> <p>修改启动端口。(默认为8080)，在application.yml可修改启动端口：(下例修改为8001，注意port前不能使用tab，否则会报错)</p> <pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8001</span>
</code></pre> </li><li> <p>自定义Banner</p> <p>spring boot启动后会在控制台输出banner信息，默认是显示spring字样，如下：</p> </li></ol> 
<p><img src="https://images2.imgbox.com/e6/1a/eaVCvfT7_o.png" alt="在这里插入图片描述"></p> 
<p>如果要定制自己的Banner只需要在resources下放置一个banner.txt文件，输入自己的banner字符即可。</p> 
<p>Banner字符可通过类似以下网站生成：</p> 
<ul><li><a href="http://patorjk.com/software/taag" rel="nofollow">http://patorjk.com/software/taag</a></li><li><a href="http://www.network-science.de/ascii/" rel="nofollow">http://www.network-science.de/ascii/</a></li></ul> 
<p><img src="https://images2.imgbox.com/67/ed/6hqd87TH_o.png" alt="在这里插入图片描述"></p> 
<p>复制字符到banner.txt并附上应用和版本信息，重启应用，如下：</p> 
<p><img src="https://images2.imgbox.com/3a/5d/yOLvD0IM_o.png" alt="在这里插入图片描述"></p> 
<ol start="7"><li> <p>接口测试</p> <p>新建一个controller包，并在其下创建一个hellocontroller类，添加一个hello接口：</p> </li></ol> 
<p><img src="https://images2.imgbox.com/d4/3e/kSO4Few8_o.png" alt="在这里插入图片描述"></p> 
<p>在浏览器中访问，如下：</p> 
<p><img src="https://images2.imgbox.com/11/f9/hDcwXvhS_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_Swagger_99"></a>2. 集成Swagger文档</h3> 
<p>使用Swagger集成文档有以下几个优势：</p> 
<ul><li>功能丰富：支持多种注解，自动生成接口文档界面，支持在界面中测试API接口功能。</li><li>及时更新：开发过程中花一点写注释的时间，就可以及时更新API文档、</li><li>整合简单：通过添加pom依赖和简单配置，内嵌于应用中就可以同时发布API接口文档界面，不需要部署独立服务。</li></ul> 
<p>官网：<a href="https://swagger.io/" rel="nofollow">https://swagger.io/</a></p> 
<p>官方文档：<a href="https://swagger.io/docs/" rel="nofollow">https://swagger.io/docs/</a></p> 
<ol><li> <p>添加依赖</p> <pre><code class="prism language-xml"><span class="token comment">&lt;!--swagger--&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springfox-swagger2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springfox-swagger-ui<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>配置类</p> <p>添加config包，并在其下添加Swagger配置类SwaggerConfig.java：</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerConfig</span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">Docket</span> <span class="token function">createRestApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Docket</span><span class="token punctuation">(</span><span class="token class-name">DocumentationType</span><span class="token punctuation">.</span>SWAGGER_2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        		<span class="token punctuation">.</span><span class="token function">apis</span><span class="token punctuation">(</span><span class="token class-name">RequestHandlerSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token class-name">PathSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
	<span class="token keyword">private</span> <span class="token class-name">ApiInfo</span> <span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApiInfoBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>页面测试</p> <p>启动应用，在浏览器中访问<a href="http://localhost:8001/swagger-ui.html#/" rel="nofollow">http://localhost:8001/swagger-ui.html#/</a>，就可以看到Swagger的接口文档页面了：</p> </li></ol> 
<p><img src="https://images2.imgbox.com/9a/58/Wb6316mR_o.png" alt="在这里插入图片描述"></p> 
<p>还可以选择接口进行测试，单击右侧的try it out→execute，发现接口成功返回“hello mango！”：</p> 
<p><img src="https://images2.imgbox.com/4e/42/Ia9NjH0S_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_MyBatis_160"></a>3. 集成MyBatis框架</h3> 
<p>MyBatis是一款优秀的持久层框架，支持定制化SQL、存储过程以及高级映射。MyBatis可以使用简单的XML或注解来配置和映射原生信息，并将接口和Java的POJOs映射成数据库中的记录。</p> 
<p>中文官网：<a href="http://www.mybatis.cn/" rel="nofollow">http://www.mybatis.cn/</a></p> 
<p>参考教程：<a href="https://www.w3cschool.cn/mybatis/" rel="nofollow">https://www.w3cschool.cn/mybatis/</a></p> 
<ol><li> <p>添加依赖</p> <pre><code class="prism language-xml"><span class="token comment">&lt;!-- mybatis --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- mysql --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>添加配置</p> 
  <ol><li> <p>添加MyBatis配置</p> <p>添加MyBatis配置类，配置相关扫描路径，包括DAO、Model、XML映射文件的扫描，在config包下新建一个MyBatis配置类MybatisConfig.java：</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.louis.mango.**.dao"</span><span class="token punctuation">)</span>    <span class="token comment">// 扫描DAO</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisConfig</span> <span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">sqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">SqlSessionFactoryBean</span> sessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionFactory<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionFactory<span class="token punctuation">.</span><span class="token function">setTypeAliasesPackage</span><span class="token punctuation">(</span><span class="token string">"com.louis.mango.**.model"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 扫描Model</span>
    
    <span class="token class-name">PathMatchingResourcePatternResolver</span> resolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sessionFactory<span class="token punctuation">.</span><span class="token function">setMapperLocations</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token string">"classpath*:**/sqlmap/*.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 扫描映射文件</span>
    
    <span class="token keyword">return</span> sessionFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>添加数据源配置</p> <p>打开应用配置文件，添加MySQL数据源连接信息。</p> <p>application.yml：</p> <pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driverClassName</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/mango<span class="token punctuation">?</span>serverTimezone=GMT%2B8<span class="token important">&amp;characterEncoding=utf-</span><span class="token number">8</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin123
</code></pre> </li><li> <p>修改启动类</p> <p>给启动类的@SpringBootApplication注解配置包扫描，表示在应用启动时自动扫描com.louis.mango包下的内容，当然Spring Boot默认会扫描启动类包及子包的组件，所以如果启动类就是放在com.louis.mango下，那么默认配置其实就是com.louis.mango了。</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>scanBasePackages<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"com.louis.mango"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MangoApplication</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MangoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> </li><li> <p>生成MyBatis模块</p> <p>手动编写MyBatis的Model、DAO、XML映射文件比较繁琐，通常都会通过一些生成工具来生成。MyBatis官方也提供了生成工具(MyBatis Generator)，另外还有一些基于官方基础改进的第三方工具，比如MyBatis Plus就是国内提供的一款非常优秀的开源工具。</p> 
  <ul><li>MyBatis Generator官网：<a href="http://www.mybatis.org/generator/index.html" rel="nofollow">http://www.mybatis.org/generator/index.html</a></li><li>MyBatis Generator教程：<a href="https://blog.csdn.net/testcs_dn/article/details/77881776">https://blog.csdn.net/testcs_dn/article/details/77881776</a></li><li>MyBatis Plus官网：<a href="http://mp.baomidou.com/#/" rel="nofollow">http://mp.baomidou.com/#/</a></li><li>MyBatis Plus教程：<a href="http://mp.baomidou.com/#/quick-start" rel="nofollow">http://mp.baomidou.com/#/quick-start</a></li></ul> <p>生成好代码之后，分别将Domain、DAO、XML映射文件复制到相应的包里。</p> <p>打开生成的Mapper，我们可以看到默认生成的一些增删改查方法。</p> </li><li> <p>编写服务接口</p> <p>在Mapper中新增一个findAll方法，用于查询所有的用户信息：</p> <p>SysUserMapper.java：</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysUserMapper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> <span class="token function">deleteByPrimaryKey</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">insertSelective</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SysUser</span> <span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 查询全部
     * @return
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>在映射文件中添加一个查询方法，编写findAll的查询语句：</p> <p>SysUserMapper.xml：</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findAll<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    select 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Base_Column_List<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    from sys_user
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> <p>然后编写用户管理接口，包含一个findAll方法：</p> <p>SysUserService.java</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysUserService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 查找所有用户
     * @return
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <p>接着编写用户管理实现类，调用SysUserMapper方法完成查询操作：</p> <p>SysUserServiceImpl.java：</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SysUserService</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserMapper</span> sysUserMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> sysUserMapper<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>然后编写用户管理RESTful接口，返回JSON数据格式，提供外部调用。被@RestController注解的接口控制器默认使用JSON格式交互，返回JSON结果：</p> <p>SysUserController.java：</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserService</span> sysUserService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/findAll"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> sysUserService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>配置打包资源</p> <p>虽然代码编写已经完成，但是此时启动运行还是会有问题的，因为在编译打包的时候，我们的XML映射文件是不在默认打包范围内的，所以需要修改打包资源配置。</p> <p>修改pom.xml，在build标签加入形式如下的resource标签的打包配置，这样打包时就会把MyBatis映射文件也复制过去了：</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 打包时拷贝MyBatis的映射文件 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">&gt;</span></span>src/main/java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>**/sqlmap/*.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filtering</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filtering</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">&gt;</span></span>  
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">&gt;</span></span>src/main/resources<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">&gt;</span></span>  
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">&gt;</span></span> 
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">&gt;</span></span>**/*.*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>  
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">&gt;</span></span> 
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filtering</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filtering</span><span class="token punctuation">&gt;</span></span>  
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>编译运行测试</p> <p>编译并启动应用，访问<a href="http://localhost:8001/user/findAll" rel="nofollow">http://localhost:8001/user/findAll</a>，可以看到查询接口成功返回了所有的用户信息，如下：</p> </li></ol> 
<p><img src="https://images2.imgbox.com/a9/50/Envzvmyb_o.png" alt="在这里插入图片描述"></p> 
<p>也可以用Swagger进行测试：</p> 
<p><img src="https://images2.imgbox.com/0f/be/d7krg1LD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_Druid_391"></a>4. 集成Druid数据源</h3> 
<p>数据库连接池负责分配、管理和释放数据库连接，它允许应用程序重复使用一个现有的数据库连接，而不是重新再建立一个，释放空闲时间超过最大空闲时间的数据库连接来避免因为没有释放数据库连接而引起的数据库连接遗漏。通过数据库连接池能明显提高对数据库操作的性能。</p> 
<ol><li> <p>Druid介绍</p> <p>Druid是阿里开源的一个JDBC应用组件，其主要包括三个部分：</p> 
  <ul><li>DruidDriver：代理Driver，能够提供基于Filter-Chain模式的插件体系。</li><li>DruidDataSource：高效可管理的数据库连接池。</li><li>SQLParser：实用的SQL语法分析。</li></ul> <p>通过Druid连接池中间件，我们可以实现：</p> 
  <ul><li>监控数据库访问性能。Druid内置了一个功能强大的StatFilter插件，能够详细统计SQL的执行性能，对于线上分析数据库访问性能有所帮助。</li><li>替换传统的DBCP和C3P0连接池中间件。Druid提供了一个高效、功能强大、可扩展性好的数据库连接池。</li><li>数据库密码加密。直接把数据库密码写在配置文件中，容易导致安全问题。DruidDriver和DruidDataSource都支持PasswordCallback。</li><li>SQL执行日志。Druid提供了不同的LogFilter，能够支持Common-Logging、Log4j和JdkLog，可以按需选取相应的LogFilter，监控你应用的数据库访问情况。</li><li>扩展JDBC。如果对JDBC层有编程的需求，可以通过Druid提供的Filter-Chain机制很方便地编写JDBC层的扩展插件。</li></ul> <p>更多详细信息可参考官方文档，<a href="https://github.com/alibaba/druid/wiki">https://github.com/alibaba/druid/wiki</a>。</p> </li><li> <p>添加依赖</p> <p>在pom文件中添加Druid相关的maven依赖：</p> <pre><code class="prism language-xml"><span class="token comment">&lt;!-- druid --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <p>druid-spring-boot-starter是阿里官方提供的Spring Boot插件，用于帮助在Spring Boot项目中轻松集成Druid数据库连接池和监控。</p> <p>更多资料可以参考：</p> 
  <ul><li>Druid：<a href="https://github.com/alibaba/druid">https://github.com/alibaba/druid</a>。</li><li>Druid Sping Starter: <a href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter">https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</a>。</li></ul> </li><li> <p>添加配置</p> <p>修改配置文件，把原有的数据源配置替换成Druid数据源并配置数据源相关参数。</p> <p>application.yml：</p> <pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> druidDataSource
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
    <span class="token key atrule">druid</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
      <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/mango<span class="token punctuation">?</span>serverTimezone=GMT%2B8<span class="token important">&amp;characterEncoding=utf-</span><span class="token number">8</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> root
      <span class="token key atrule">password</span><span class="token punctuation">:</span> admin123
      <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat<span class="token punctuation">,</span>wall<span class="token punctuation">,</span>log4j<span class="token punctuation">,</span>config
      <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token key atrule">initial-size</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
      <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">time-between-eviction-runs-millis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
      <span class="token key atrule">min-evictable-idle-time-millis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
      <span class="token key atrule">validation-query</span><span class="token punctuation">:</span> select 'x'
      <span class="token key atrule">test-while-idle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">test-on-borrow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">test-on-return</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">pool-prepared-statements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">max-open-prepared-statements</span><span class="token punctuation">:</span> <span class="token number">50</span>
      <span class="token key atrule">max-pool-prepared-statement-per-connection-size</span><span class="token punctuation">:</span> <span class="token number">20</span>
</code></pre> <p>参数说明：</p> 
  <ul><li>max-active:最大连接数。</li><li>initial-size:初始化大小。</li><li>min-idle:最小连接数。</li><li>max-wait:获取连接等待超时时间。</li><li>time-between-eviction-runs-millis:间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒。</li><li>min-evictable-idle-time-millis:一个连接在池中最小生存的时间，单位是毫秒。</li><li>filters: stat,wall,log4j,config:配置监控统计拦截的filters，去掉后监控界面SQL无法进行统计，wall用于防火墙。</li></ul> <p>Druid Spring Starter简化了很多配置，如果默认配置不能满足需求，可以自定义配置，更多配置参考如下：</p> <p>Druid Spring Starter:<a href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter">https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</a>。</p> </li><li> <p>配置Servlet和Filter</p> <p>在config包下新建一个DruidConfig配置类，主要是注入属性和配置连接池相关的配置，如黑白名单、监控管理后台登录账户密码等，内容如下：</p> <p>DruidConfig.java：</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">DruidDataSourceProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DruidConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DruidDataSourceProperties</span> properties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">druidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DruidDataSource</span> druidDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getDriverClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setInitialSize</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getInitialSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getMinIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setMaxActive</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getMaxActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setMaxWait</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getMaxWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setTimeBetweenEvictionRunsMillis</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getTimeBetweenEvictionRunsMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setMinEvictableIdleTimeMillis</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getMinEvictableIdleTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setValidationQuery</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getValidationQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setTestWhileIdle</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">isTestWhileIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setTestOnBorrow</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">isTestOnBorrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setTestOnReturn</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">isTestOnReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setPoolPreparedStatements</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">isPoolPreparedStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidDataSource<span class="token punctuation">.</span><span class="token function">setMaxPoolPreparedStatementPerConnectionSize</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getMaxPoolPreparedStatementPerConnectionSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            druidDataSource<span class="token punctuation">.</span><span class="token function">setFilters</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            druidDataSource<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> druidDataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 注册Servlet信息， 配置监控视图
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">ServletRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Servlet</span><span class="token punctuation">&gt;</span></span> <span class="token function">druidServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServletRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Servlet</span><span class="token punctuation">&gt;</span></span> servletRegistrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Servlet</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StatViewServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/druid/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//白名单：</span>
<span class="token comment">//        servletRegistrationBean.addInitParameter("allow","127.0.0.1,139.196.87.48");</span>
        <span class="token comment">//IP黑名单 (存在共同时，deny优先于allow) : 如果满足deny的话提示:Sorry, you are not permitted to view this page.</span>
        servletRegistrationBean<span class="token punctuation">.</span><span class="token function">addInitParameter</span><span class="token punctuation">(</span><span class="token string">"deny"</span><span class="token punctuation">,</span><span class="token string">"192.168.1.119"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//登录查看信息的账号密码, 用于登录Druid监控后台</span>
        servletRegistrationBean<span class="token punctuation">.</span><span class="token function">addInitParameter</span><span class="token punctuation">(</span><span class="token string">"loginUsername"</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        servletRegistrationBean<span class="token punctuation">.</span><span class="token function">addInitParameter</span><span class="token punctuation">(</span><span class="token string">"loginPassword"</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//是否能够重置数据.</span>
        servletRegistrationBean<span class="token punctuation">.</span><span class="token function">addInitParameter</span><span class="token punctuation">(</span><span class="token string">"resetEnable"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> servletRegistrationBean<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 注册Filter信息, 监控拦截器
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">FilterRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> <span class="token function">filterRegistrationBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FilterRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span> filterRegistrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Filter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterRegistrationBean<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebStatFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterRegistrationBean<span class="token punctuation">.</span><span class="token function">addUrlPatterns</span><span class="token punctuation">(</span><span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterRegistrationBean<span class="token punctuation">.</span><span class="token function">addInitParameter</span><span class="token punctuation">(</span><span class="token string">"exclusions"</span><span class="token punctuation">,</span> <span class="token string">"*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> filterRegistrationBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>代码说明：</p> 
  <ul><li>@EnableConfigurationProperties注解用于导入上一步Druid的配置信息。</li><li>public ServletRegistrationBean druidServlet()相当于Web Servlet配置。</li><li>public FilterRegistrationBean filterRegistrationBean()相当于Web Filter配置。</li></ul> </li><li> <p>编译运行</p> <p>添加log4j依赖：</p> <pre><code class="prism language-xml"><span class="token comment">&lt;!-- log4j --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <p>添加log4j配置：在resources目录下，新建一个log4j参数配置文件：</p> <p>log4j.properties：</p> <pre><code class="prism language-yml"><span class="token comment">### set log levels ###    </span>
log4j.rootLogger = INFO<span class="token punctuation">,</span>DEBUG<span class="token punctuation">,</span> console<span class="token punctuation">,</span> infoFile<span class="token punctuation">,</span> errorFile <span class="token punctuation">,</span>debugfile<span class="token punctuation">,</span>mail 
LocationInfo=true    

log4j.appender.console = org.apache.log4j.ConsoleAppender  
log4j.appender.console.Target = System.out  
log4j.appender.console.layout = org.apache.log4j.PatternLayout 

log4j.appender.console.layout.ConversionPattern =<span class="token punctuation">[</span>%d<span class="token punctuation">{<!-- --></span>yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss<span class="token punctuation">,</span>SSS<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">-</span><span class="token punctuation">[</span>%p<span class="token punctuation">]</span><span class="token punctuation">:</span>%m   %x %n 

log4j.appender.infoFile = org.apache.log4j.DailyRollingFileAppender  
log4j.appender.infoFile.Threshold = INFO  
log4j.appender.infoFile.File = C<span class="token punctuation">:</span>/logs/log
log4j.appender.infoFile.DatePattern = '.'yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd'.log'  
log4j.appender.infoFile.Append=true
log4j.appender.infoFile.layout = org.apache.log4j.PatternLayout  
log4j.appender.infoFile.layout.ConversionPattern =<span class="token punctuation">[</span>%d<span class="token punctuation">{<!-- --></span>yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss<span class="token punctuation">,</span>SSS<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">-</span><span class="token punctuation">[</span>%p<span class="token punctuation">]</span><span class="token punctuation">:</span>%m  %x %n 

log4j.appender.errorFile = org.apache.log4j.DailyRollingFileAppender  
log4j.appender.errorFile.Threshold = ERROR  
log4j.appender.errorFile.File = C<span class="token punctuation">:</span>/logs/error  
log4j.appender.errorFile.DatePattern = '.'yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd'.log'  
log4j.appender.errorFile.Append=true  
log4j.appender.errorFile.layout = org.apache.log4j.PatternLayout  
log4j.appender.errorFile.layout.ConversionPattern =<span class="token punctuation">[</span>%d<span class="token punctuation">{<!-- --></span>yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss<span class="token punctuation">,</span>SSS<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">-</span><span class="token punctuation">[</span>%p<span class="token punctuation">]</span><span class="token punctuation">:</span>%m  %x %n

log4j.appender.debugfile = org.apache.log4j.DailyRollingFileAppender  
log4j.appender.debugfile.Threshold = DEBUG  
log4j.appender.debugfile.File = C<span class="token punctuation">:</span>/logs/debug  
log4j.appender.debugfile.DatePattern = '.'yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd'.log'  
log4j.appender.debugfile.Append=true  
log4j.appender.debugfile.layout = org.apache.log4j.PatternLayout  
log4j.appender.debugfile.layout.ConversionPattern =<span class="token punctuation">[</span>%d<span class="token punctuation">{<!-- --></span>yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss<span class="token punctuation">,</span>SSS<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">-</span><span class="token punctuation">[</span>%p<span class="token punctuation">]</span><span class="token punctuation">:</span>%m  %x %n
</code></pre> <p>配置完成后，编译启动。</p> </li><li> <p>查看监控</p> <p>启动应用，访问<a href="http://localhost:8001/druid/login.html" rel="nofollow">http://localhost:8001/druid/login.html</a>，进入Druid监控后台页面：</p> </li></ol> 
<p><img src="https://images2.imgbox.com/eb/3f/vaHuLiNy_o.png" alt="在这里插入图片描述"></p> 
<p>登录之后，Druid后台的管理首页如下所示：</p> 
<p><img src="https://images2.imgbox.com/ed/c5/JhthZmk7_o.png" alt="在这里插入图片描述"></p> 
<p>数据源页显示连接数据源的相关信息：</p> 
<p><img src="https://images2.imgbox.com/bd/98/jX3YB6qw_o.png" alt="在这里插入图片描述"></p> 
<p>访问<a href="http://localhost:8001/user/findAll" rel="nofollow">http://localhost:8001/user/findAll</a>。接口调用成功之后可以看到SQL监控的执行记录，可以查看和分析执行的SQL性能，方便进行数据库性能优化：</p> 
<p><img src="https://images2.imgbox.com/a3/49/4SQftufh_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5__646"></a>5. 跨域解决方案</h3> 
<p>如果一个请求地址里面的协议、域名和端口号都相同，就属于同源。</p> 
<p>依据浏览器同源策略，非同源脚本不可操作其他源下面的对象，想要操作其他源下的对象就需要跨域。在同源策略的限制下，非同源的网站之间不能发生AJAX请求。如果需要，可通过降域或其他技术实现。</p> 
<ol><li> <p>CORS技术</p> <p>CORS可以在不破坏既有规则的基础下，通过后端服务器实现CORS接口，从而实现跨域通信。CORS将请求分为两类：简单请求和非简单请求，分别对跨域通信提供了支持。</p> 
  <ul><li> <p>简单请求</p> <p>在CORS出现前，发生HTTP请求时在头信息中不能包含任何自定义字段，且HTTP信息不超过以下几个字段：</p> 
    <ul><li>Accept</li><li>Accept-Language</li><li>Content-Language</li><li>Last-Event-ID</li><li>Content-Type。</li></ul> <p>一个简单请求的例子：</p> <pre><code>GET /test HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate, sdch, br
Origin: http://www.test.com
Host: www.test.com
</code></pre> <p>对于简单请求，CORS的策略是请求时在请求头中增加一个Origin字段，服务器收到请求后根据该字段判断是否允许该请求访问。如果允许，就在HTTP头信息中增加Access-Control-Allow-Origin字段，并返回正确的结果。如果不允许，就不在HTTP头信息中添加Access-Control-Allow-Origin字段。</p> <p>除了上面提到的Access-Control-Allow-Origin，还有几个字段用于描述CORS返回结果。Access-Control-Allow-Credentials：可选，用户是否可以发送、处理cookie。Access-Control-Expose-Headers：可选，可以让用户拿到的字段。有几个字段无论设置与否都可以拿到的，包括Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma。</p> </li><li> <p>非简单请求</p> <p>对于非简单请求的跨源请求，浏览器会在真实请求发出前增加一次OPTION请求，称为预检请求(preflight request)。预检请求将真实请求的信息，包括请求方法、自定义头字段、源信息添加到HTTP头信息字段中，询问服务器是否允许这样的操作。</p> <p>例如一个GET请求：</p> <pre><code>OPTIONS /test HTTP/1.1
Origin: http://www.test.com
Access-Control-Request-Method: GET
Access-Control-Request-Headers: X-Custom-Header
Host: www.test.com
</code></pre> <p>与CORS相关的字段有：请求使用的HTTP方法Access-Control-Request-Method；请求中包含的自定义头字段Access-Control-Request-Headers。</p> <p>服务器收到请求时，需要分别对Origin、Access-Control-Request-Method、Access-Control-Request-Headers进行验证，验证通过后会在返回HTTP头信息中添加：</p> <pre><code>Access-Control-Allow-Origin: http://www.test.com
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: X-Custom-Header
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 1728000
</code></pre> <p>它们的含义分别是：Access-Control-Allow-Methods(真实请求允许的方法)、Access-Control-Allow-Headers(服务器允许使用的字段)、Access-Control-Allow-Credentials(是否允许用户发送、处理cookie)、Access-Control-Max-Age(预检请求的有效期，单位为秒。有效期内，不会重复发送预检请求)。</p> <p>当预检请求通过后，浏览器才会发送真实请求到服务器。这样就实现了跨域资源的请求访问。</p> </li></ul> </li><li> <p>CORS实现</p> <p>CORS的代码实现比较简单，主要是要理解CORS实现跨域的原理和方式。在config包下新建一个CORS配置类，实现WebMvcConfigurer接口。</p> <p>CorsConfig.java：</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CorsConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCorsMappings</span><span class="token punctuation">(</span><span class="token class-name">CorsRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        registry<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span>	<span class="token comment">// 允许跨域访问的路径</span>
        <span class="token punctuation">.</span><span class="token function">allowedOrigins</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span>	<span class="token comment">// 允许跨域访问的源</span>
        <span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span> <span class="token string">"OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">)</span>	<span class="token comment">// 允许请求方法</span>
        <span class="token punctuation">.</span><span class="token function">maxAge</span><span class="token punctuation">(</span><span class="token number">168000</span><span class="token punctuation">)</span>	<span class="token comment">// 预检间隔时间</span>
        <span class="token punctuation">.</span><span class="token function">allowedHeaders</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span>  <span class="token comment">// 允许头部设置</span>
        <span class="token punctuation">.</span><span class="token function">allowCredentials</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 是否发送cookie</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>这样每当客户端发送请求的时候，都会在头部附上跨域信息，就可以支持跨域访问了。</p> </li></ol> 
<h3><a id="6__734"></a>6. 业务功能实现</h3> 
<p>这一章节开始实现各个业务功能接口，包括用户管理、机构管理、角色管理、菜单管理、字典管理、系统配置、操作日志、登录日志等业务功能的实现。</p> 
<h4><a id="61__738"></a>6.1 工程结构规划</h4> 
<p>我们要采用的是微服务架构，虽然我们现在只有一个工程，但随着项目越来越大，代码的可重用性和可维护性就会变得越来越难，所以尽早对工程结构进行合理的规划，对项目于的前期开发、后期的扩展和维护都是非常重要的。</p> 
<p>经过重新规划，我们的工程结构如下：</p> 
<ul><li>mango-common：公共代码模块，主要放置一些工具类。</li><li>mango-core：核心业务代码模块，主要封装公共业务模块。</li><li>mango-admin：后台管理模块，包含用户、角色、菜单管理等。</li><li>mango-pom：聚合模块，仅为简化打包，一键执行打包所有模块。</li></ul> 
<h5><a id="611_mangoadmin_749"></a>6.1.1 mango-admin</h5> 
<p>将原先mango工程更名为mango-admin，遵循以下步骤进行工程重构：</p> 
<ol><li>关闭应用，在Eclipse上选择删除mango工程，注意不要勾选删除磁盘。</li><li>找到工程所在位置，修改mango工程名为mango-admin。</li><li>编辑pom.xml，将需要替换的mango字符替换为mango-admin。</li><li>右击Eclipse导航栏，选择import→exist maven project重新导入maven工程。</li><li>重构包结构，将基础包重构为com.louis.mango.admin，以区分不同工程的包。</li><li>由于重构了包路径，但是XML映射文件的内容无法同步更新，要将所有的MyBatis的XML映射文件出现的Mapper和Model的包路径修改为正确的路径。可以通过将"com.louis.mango"全部替换为"com.louis.mango.admin"进行统一修改。</li><li>将MangoApplication改名为MangoAdminApplication，编译启动应用，服务访问正常就启动成功了。</li></ol> 
<h5><a id="612_mangocommon_761"></a>6.1.2 mango-common</h5> 
<p>新建一个空的maven工程，除了一个pom.xml没有其他内容，后续放置一些工具方法和常量。</p> 
<h5><a id="613_mangocore_765"></a>6.1.3 mango-core</h5> 
<p>新建一个空的maven工程，后续放置一些公共核心业务代码封装，如HTTP交互格式封装、业务基类封装和分页工具封装等。</p> 
<h5><a id="614_mangopom_769"></a>6.1.4 mango-pom</h5> 
<p>为了方便统一打包，新建一个mango-pom工程。这个工程依赖所有模块，负责统一进行打包(不然编译的时候需要逐个编译，工程一多很是麻烦)，但因我们采用的是微服务架构，每个工程模块使用的依赖版本可能都是不一样的，所以这里的mango-pom与所有模块不存在实质性的父子模块关系，也不由mango-pom进行统一版本和依赖管理，只是为了便利打包。</p> 
<h5><a id="615__773"></a>6.1.5 打包测试</h5> 
<p>下面进行统一打包测试，我们最终所要的效果是：只要在mango-pom下的pom.xml运行打包就可以编译打包所有模块。现在各个子模块都没有编译过，模块间的依赖也还没有加，所以第一次还需要遵循以下步骤进行操作：</p> 
<ul><li> <p>右击mango-common下的pom.xml，执行Maven Install编译打包。</p> </li><li> <p>在mango-core下的pom.xml内添加mango-common为dependency依赖，然后执行编译打包命令。</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.louis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mango-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>在mango-admin下的pom.xml内添加，mango-core为dependency依赖，然后执行编译打包命令。</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.louis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mango-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>在mango-pom下的pom.xml内添加以上所有模块的modules依赖，然后执行编译打包命令。</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>../mango-admin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>../mango-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>../mango-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li></ul> 
<p>注：如果工程出现红叉，可以尝试右击工程Maven→Update Project进行解决。</p> 
<p>以后只要对mango-pom下的pom.xml执行命令，就可以统一打包所有模块了。如果控制台输出信息如下所示的打包信息，就表示打包成功了。</p> 
<p><img src="https://images2.imgbox.com/19/f0/Olf92UHA_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="62__816"></a>6.2 业务代码封装</h4> 
<p>为了统一业务代码接口、保持代码整洁、提升代码性能，这里对一些通用的代码进行了统一封装，封装内容如下所示：</p> 
<p><img src="https://images2.imgbox.com/97/ba/IN4TC3cJ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="621_CURD_823"></a>6.2.1 通用CURD接口</h5> 
<p>CurdService是对通用增删改查接口的封装，统一定义了包含保存、删除、批量删除、根据ID查询和分页查询方法，一般的业务Service接口会继承此接口，提供基础增删改查服务，这几个接口能满足大部分基础CRUD业务的需求，封装详情参见代码注释。</p> 
<p>CurdService.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CurdService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token comment">/**
	 * 保存操作
	 * @param record
	 * @return
	 */</span>
	<span class="token keyword">int</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">T</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/**
	 * 删除操作
	 * @param record
	 * @return
	 */</span>
	<span class="token keyword">int</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">T</span> <span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/**
	 * 批量删除操作
	 * @param entities
	 */</span>
	<span class="token keyword">int</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/**
	 * 根据ID查询
	 * @param id
	 * @return
	 */</span>
	<span class="token class-name">T</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token comment">/**
     * 分页查询
	 * 这里统一封装了分页请求和结果，避免直接引入具体框架的分页对象, 如MyBatis或JPA的分页对象
	 * 从而避免因为替换ORM框架而导致服务层、控制层的分页接口也需要变动的情况，替换ORM框架也不会
	 * 影响服务层以上的分页接口，起到了解耦的作用
	 * @param pageRequest 自定义，统一分页查询请求
	 * @return PageResult 自定义，统一分页查询结果
     */</span>
	<span class="token class-name">PageResult</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="622__872"></a>6.2.2 分页请求封装</h5> 
<p>对分页请求的参数做了统一封装，传入分页查询的页码和数量即可。</p> 
<p>PageRequest.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageRequest</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 * 当前页码
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">int</span> pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">/**
	 * 每页数量
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token comment">/**
	 * 查询参数
	 */</span>
	<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> pageNum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPageNum</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>pageNum <span class="token operator">=</span> pageNum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> pageSize<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPageSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> params<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setParams</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>params <span class="token operator">=</span> params<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getParam</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="623__917"></a>6.2.3 分页结果封装</h5> 
<p>对分页查询的结果进行了统一封装，结果返回业务数据和分页数据。</p> 
<p>PageResult.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageResult</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 * 当前页码
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">int</span> pageNum<span class="token punctuation">;</span>
	<span class="token comment">/**
	 * 每页数量
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">;</span>
	<span class="token comment">/**
	 * 记录总数
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">long</span> totalSize<span class="token punctuation">;</span>
	<span class="token comment">/**
	 * 页码总数
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">int</span> totalPages<span class="token punctuation">;</span>
	<span class="token comment">/**
	 * 分页数据
	 */</span>
	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> content<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> pageNum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPageNum</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>pageNum <span class="token operator">=</span> pageNum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> pageSize<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPageSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> totalSize<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTotalSize</span><span class="token punctuation">(</span><span class="token keyword">long</span> totalSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>totalSize <span class="token operator">=</span> totalSize<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTotalPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> totalPages<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTotalPages</span><span class="token punctuation">(</span><span class="token keyword">int</span> totalPages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>totalPages <span class="token operator">=</span> totalPages<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> content<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="624__978"></a>6.2.4 分页助手封装</h5> 
<p>对MyBatis的分页查询业务代码进行统一的封装，通过分页助手可以极大简化Service查询业务的编写。</p> 
<p>MybatisPageHelper.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisPageHelper</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> findPage <span class="token operator">=</span> <span class="token string">"findPage"</span><span class="token punctuation">;</span>
	
	<span class="token comment">/**
	 * 分页查询, 约定查询方法名为 “findPage” 
	 * @param pageRequest 分页请求
	 * @param mapper Dao对象，MyBatis的 Mapper	
	 * @param args 方法参数
	 * @return
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PageResult</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">,</span> <span class="token class-name">Object</span> mapper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">findPage</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">,</span> mapper<span class="token punctuation">,</span> findPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/**
	 * 调用分页插件进行分页查询
	 * @param pageRequest 分页请求
	 * @param mapper Dao对象，MyBatis的 Mapper	
	 * @param queryMethodName 要分页的查询方法名
	 * @param args 方法参数
	 * @return
	 */</span>
	<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token string">"unchecked"</span><span class="token punctuation">,</span> <span class="token string">"rawtypes"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PageResult</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">,</span> <span class="token class-name">Object</span> mapper<span class="token punctuation">,</span> <span class="token class-name">String</span> queryMethodName<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 设置分页参数</span>
		<span class="token keyword">int</span> pageNum <span class="token operator">=</span> pageRequest<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> pageSize <span class="token operator">=</span> pageRequest<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">PageHelper</span><span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 利用反射调用查询方法</span>
		<span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>mapper<span class="token punctuation">,</span> queryMethodName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">getPageResult</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">)</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 将分页信息封装到统一的接口
	 * @param pageRequest 
	 * @param page
	 * @return
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">PageResult</span> <span class="token function">getPageResult</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">,</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> pageInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>pageInfo<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setPageSize</span><span class="token punctuation">(</span>pageInfo<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setTotalSize</span><span class="token punctuation">(</span>pageInfo<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setTotalPages</span><span class="token punctuation">(</span>pageInfo<span class="token punctuation">.</span><span class="token function">getPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>pageInfo<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="625_HTTP_1037"></a>6.2.5 HTTP结果封装</h5> 
<p>对接口调用返回结果进行了统一的封装，方便前端或者移动端对返回结果进行统一的处理。</p> 
<p>HttpResult.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpResult</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token keyword">int</span> code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">Object</span> data<span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResult</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>SC_INTERNAL_SERVER_ERROR<span class="token punctuation">,</span> <span class="token string">"未知异常，请联系管理员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResult</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>SC_INTERNAL_SERVER_ERROR<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResult</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">HttpResult</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		r<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
		r<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> r<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResult</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">HttpResult</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		r<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> r<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResult</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Object</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">HttpResult</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		r<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> r<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HttpResult</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> code<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> msg<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">Object</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="63_MyBatis_1107"></a>6.3 MyBatis分页查询</h4> 
<p>使用MyBatis时，最头疼的就是分页，需要先写一个查询count的select语句，再写一个真正分页查询的语句，当查询条件多了之后，就会发现真不想花双倍的时间写count和select。幸好我们有pagehelper分页插件。pagehelper是一个强大实用的MyBatis分页插件，可以帮助我们快速实现分页功能。</p> 
<h5><a id="631__1111"></a>6.3.1 添加依赖</h5> 
<p>在mango-core下的pom.xml文件内添加分页插件依赖包，因为mango-admin依赖mango-core模块，所以mango-admin模块也能获取分页插件依赖。</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- pagehelper --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.pagehelper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>pagehelper-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="632__1124"></a>6.3.2 添加配置</h5> 
<p>在mango-admin配置文件内添加分页插件配置</p> 
<p>application.yml：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">pagehelper</span><span class="token punctuation">:</span>
  <span class="token key atrule">helper-dialect</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">reasonable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">support-methods-arguments</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">params</span><span class="token punctuation">:</span> count=countSql
</code></pre> 
<h5><a id="633__1138"></a>6.3.3 分页代码</h5> 
<p>首先我们在DAO层添加一个分页查询方法：</p> 
<p>SysUserMapper.java:</p> 
<pre><code class="prism language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>给SysUserMapper.xml添加查询方法，这是一个普通的查找全部记录的查询语句，并不需要写分页SQL，分页插件会拦截查询请求，并读取前台传来的分页查询参数重新生成分页查询语句。</p> 
<p>SysUserMapper.xml:</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findPage<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    select u.*, (select d.name from sys_dept d where d.id = u.dept_id) deptName from sys_user u
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>服务层调用DAO层完成分页查询，让SysUserService继承CurdService接口。</p> 
<p>SysUserService.java:</p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 查找所有用户
	 * @return
	 */</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在实现类中编写分页查询业务类实现，我们可以看到，经过对分页查询业务的封装，普通分页查询非常简单，只需调用MyBatisPageHelper.findPage(pageRequest,sysUserMapper)一行代码即可完成分页查询功能.</p> 
<p>SysUserServiceImpl.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserServiceImpl</span>  <span class="token keyword">implements</span> <span class="token class-name">SysUserService</span> <span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">SysUserMapper</span> sysUserMapper<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">return</span> <span class="token class-name">MyBatisPageHelper</span><span class="token punctuation">.</span><span class="token function">findPage</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">,</span>sysUserMapper<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编写分页查询接口，简单调用Service的查询接口。</p> 
<p>SysUserController.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">SysUserService</span> sysUserService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/findPage"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysUserService<span class="token punctuation">.</span><span class="token function">findPage</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="634__1205"></a>6.3.4 接口测试</h5> 
<p>通过swagger接口测试，结果如下：</p> 
<p><img src="https://images2.imgbox.com/a4/1b/vCjulbbH_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/09/16/vzevRNAm_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="64__1215"></a>6.4 业务功能开发</h4> 
<p>业务功能的开发基本都是各种增删改查业务的编写，大多数是重复性工作，业务编写也没有多少技术要点，这里就拿机构管理的开发作为基础CURD的开发范例。</p> 
<p>首先需要事先规划一下，根据需求设计好需要的接口，比如字典管理除了通用的保存、删除、分页查询接口外，还需要一个根据标签名称查询记录的查询方法。</p> 
<h5><a id="641_DAO_1221"></a>6.4.1 编写DAO接口</h5> 
<p>打开DAO接口，添加findPage、findPageByLabel和findByLable三个接口：</p> 
<p>SysDictMapper.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysDictMapper</span> <span class="token punctuation">{<!-- --></span>
     <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDict</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDict</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPageByLabel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"label"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDict</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByLable</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"label"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="642__1237"></a>6.4.2 编写映射文件</h5> 
<p>打开映射文件，编写三个查询方法：findPage、findPageByLabel和findByLable。</p> 
<p>SysDictMapper.xml:</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findPage<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    select 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Base_Column_List<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    from sys_dict
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findPageByLabel<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bind</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pattern<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">'</span>%<span class="token punctuation">'</span> + _parameter.label + <span class="token punctuation">'</span>%<span class="token punctuation">'</span><span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
  	select 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Base_Column_List<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    from sys_dict
    where label like #{pattern}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findByLable<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    select 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Base_Column_List<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    from sys_dict
    where label = #{label,jdbcType=VARCHAR}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="643__1264"></a>6.4.3 编写服务接口</h5> 
<p>新建一个字典接口并继承通用业务接口CurdService，额外添加一个findByLable接口。</p> 
<p>SysDictService.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysDictService</span> <span class="token keyword">extends</span> <span class="token class-name">CurdService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDict</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 根据名称查询
	 * @param lable
	 * @return
	 */</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDict</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByLable</span><span class="token punctuation">(</span><span class="token class-name">String</span> lable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="644__1282"></a>6.4.4 编写服务实现</h5> 
<p>新建一个实现类并实现SysDictService，调用DAO实现相应的业务功能。</p> 
<p>SysDictServiceImpl.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysDictServiceImpl</span>  <span class="token keyword">implements</span> <span class="token class-name">SysDictService</span> <span class="token punctuation">{<!-- --></span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">SysDictMapper</span> sysDictMapper<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">SysDict</span> <span class="token keyword">record</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> sysDictMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> sysDictMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">SysDict</span> <span class="token keyword">record</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> sysDictMapper<span class="token punctuation">.</span><span class="token function">deleteByPrimaryKey</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDict</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">SysDict</span> <span class="token keyword">record</span><span class="token operator">:</span>records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">SysDict</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> sysDictMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Object</span> label <span class="token operator">=</span> pageRequest<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"label"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>label <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">MybatisPageHelper</span><span class="token punctuation">.</span><span class="token function">findPage</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">,</span> sysDictMapper<span class="token punctuation">,</span> <span class="token string">"findPageByLabel"</span><span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token class-name">MybatisPageHelper</span><span class="token punctuation">.</span><span class="token function">findPage</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">,</span> sysDictMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDict</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByLable</span><span class="token punctuation">(</span><span class="token class-name">String</span> lable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> sysDictMapper<span class="token punctuation">.</span><span class="token function">findByLable</span><span class="token punctuation">(</span>lable<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="645__1338"></a>6.4.5 编写控制器</h5> 
<p>新建一个字典管理控制器，注入Service并调用Service方法实现接口：</p> 
<p>SysDictController.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"dict"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysDictController</span> <span class="token punctuation">{<!-- --></span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">SysDictService</span> sysDictService<span class="token punctuation">;</span>
	
	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/save"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SysDict</span> <span class="token keyword">record</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysDictService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/delete"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDict</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysDictService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/findPage"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysDictService<span class="token punctuation">.</span><span class="token function">findPage</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/findByLable"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">findByLable</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> lable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysDictService<span class="token punctuation">.</span><span class="token function">findByLable</span><span class="token punctuation">(</span>lable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其他业务功能还有诸如用户管理、角色管理、机构管理、菜单管理、系统日志等业务同理。</p> 
<h4><a id="65__1376"></a>6.5 业务接口汇总</h4> 
<p>略。看源码吧，太多了。</p> 
<h4><a id="66_Excel_1378"></a>6.6 导出Excel报表</h4> 
<p>在实际项目中，报表导出是非常普遍的需求，特别是Excel报表，对数据的汇总和传递都是非常便利，Apache POI是Apache软件基金会的开放源码函式库，POI提供API给Java程序对Microsoft Office格式档案读写的功能。这里我们将使用POI实现用户信息的Excel报表作为范例进行讲解。</p> 
<p>官网地址：<a href="http://poi.apache.org/" rel="nofollow">http://poi.apache.org/</a></p> 
<p>相关教程：<a href="https://www.yiibai.com/apache_poi/" rel="nofollow">https://www.yiibai.com/apache_poi/</a></p> 
<h5><a id="661__1386"></a>6.6.1 添加依赖</h5> 
<p>在mango0common下的pom文件中添加POI的相关依赖包：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- poi --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.poi<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>poi-ooxml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="662__1399"></a>6.6.2 编写服务接口</h5> 
<p>在用户管理接口中添加一个导出用户信息Excel报表的方法，采用分页查询的方式，可以传入要导出数据的范围，如需导出全部，把页数调至很大即可，同时因为调用的是分页查询方法查询数据，所以同样支持传入过滤字段进行数据过滤。</p> 
<p>SysUserService.java:</p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 生成用户信息Excel文件
	 * @param pageRequest 要导出的分页查询参数
	 * @return
	 */</span>
	<span class="token class-name">File</span> <span class="token function">createUserExcelFile</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="663__1414"></a>6.6.3 编写服务实现</h5> 
<p>在用户管理服务实现类中编写实现代码，生成Excel文件。</p> 
<p>SysUserServiceImpl.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">createUserExcelFile</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">PageResult</span> pageResult <span class="token operator">=</span> <span class="token function">findPage</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">createUserExcelFile</span><span class="token punctuation">(</span>pageResult<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">File</span> <span class="token function">createUserExcelFile</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>records <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			records <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">Workbook</span> workbook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XSSFWorkbook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Sheet</span> sheet <span class="token operator">=</span> workbook<span class="token punctuation">.</span><span class="token function">createSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Row</span> row0 <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">createRow</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> columnIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"No"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"用户名"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"昵称"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"机构"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"角色"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"邮箱"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"手机号"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"状态"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"头像"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"创建人"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"创建时间"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"最后更新人"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		row0<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token string">"最后更新时间"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> records<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">SysUser</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SysUser</span><span class="token punctuation">)</span> records<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Row</span> row <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">createRow</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> columnIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				row<span class="token punctuation">.</span><span class="token function">createCell</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			columnIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getDeptName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRoleNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getCreateBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token class-name">DateTimeUtils</span><span class="token punctuation">.</span><span class="token function">getDateTime</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getLastUpdateBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			row<span class="token punctuation">.</span><span class="token function">getCell</span><span class="token punctuation">(</span><span class="token operator">++</span>columnIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCellValue</span><span class="token punctuation">(</span><span class="token class-name">DateTimeUtils</span><span class="token punctuation">.</span><span class="token function">getDateTime</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getLastUpdateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token class-name">PoiUtils</span><span class="token punctuation">.</span><span class="token function">createExcelFile</span><span class="token punctuation">(</span>workbook<span class="token punctuation">,</span> <span class="token string">"download_user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="664__1474"></a>6.6.4 编写控制器</h5> 
<p>在用户管理控制器类中添加一个接口，并调用Service获取File，最终通过文件操作工具类将File下载到本地。</p> 
<p>SysUserController.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/exportExcelUser"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exportExcelUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">File</span> file <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">createUserExcelFile</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">downloadFile</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> file<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="665__1488"></a>6.6.5 工具类代码</h5> 
<p>为了简化代码，前面代码的实现封装了一些工具类。</p> 
<ol><li> <p>PoiUtils</p> <p>在编写服务实现的时候我们通过PoiUtils中的createUserExcelFile方法生成Excel文件：</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PoiUtils</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 生成Excel文件
	 * @param workbook
	 * @param fileName
	 * @return
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">File</span> <span class="token function">createExcelFile</span><span class="token punctuation">(</span><span class="token class-name">Workbook</span> workbook<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">OutputStream</span> stream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token string">".xlsx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAbsoluteFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			workbook<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>workbook<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> file<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>FileUtils</p> <p>在编写导出接口时我们通过FileUtils中的downloadFile将Excel文件下载到本地：</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUtils</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 下载文件
	 * @param response
	 * @param file
	 * @param newFileName
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">downloadFile</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">File</span> file<span class="token punctuation">,</span> <span class="token class-name">String</span> newFileName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition"</span><span class="token punctuation">,</span> <span class="token string">"attachment; filename="</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>newFileName<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">BufferedOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">BufferedInputStream</span> bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> bis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				bos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			bos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			bis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			bos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			is<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h5><a id="666__1560"></a>6.6.6 接口测试</h5> 
<p>编译启动应用，访问<a href="http://localhost:8001/swagger-ui.html#/" rel="nofollow">http://localhost:8001/swagger-ui.html#/</a>，进入Swagger接口测试页。</p> 
<p>输入分页查询信息，指定要导出的用户数据范围，单击Execute按钮发送请求。</p> 
<p><img src="https://images2.imgbox.com/8c/13/8MXzISkX_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a2/fd/x437hDdK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/74/6c/K8mzB65r_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="7__1571"></a>7. 登录流程实现</h3> 
<p>用户登录流程是后台管理系统必备的功能，接下来我们将实现用户登录流程。在这个过程中我们将利用kaptcha实现登录验证码，利用Spring Security进行安全控制。</p> 
<h4><a id="71__1575"></a>7.1 登录验证码</h4> 
<ol><li> <p>添加依赖</p> <p>在mango-admin下的pom文件添加kaptcha依赖包：</p> <pre><code class="prism language-xml"><span class="token comment">&lt;!-- kaptcha --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.axet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kaptcha<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>添加配置</p> <p>在config包下创建一个kaptcha配置类，配置验证码的一些生成属性：</p> <p>KaptchaConfig.java:</p> <pre><code class="prism language-java"><span class="token comment">/**
 * 验证码配置
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KaptchaConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DefaultKaptcha</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.border"</span><span class="token punctuation">,</span> <span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.color"</span><span class="token punctuation">,</span> <span class="token string">"black"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.char.space"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DefaultKaptcha</span> defaultKaptcha <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defaultKaptcha<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> defaultKaptcha<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>生成代码</p> <p>新建一个控制器，提供系统登录相关的API，在其中添加验证码生成接口。</p> <p>SysLoginController.java:</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysLoginController</span> <span class="token punctuation">{<!-- --></span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">Producer</span> producer<span class="token punctuation">;</span>
	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">SysUserService</span> sysUserService<span class="token punctuation">;</span>
	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"captcha.jpg"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">captcha</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span> <span class="token string">"no-store, no-cache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"image/jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 生成文字验证码</span>
		<span class="token class-name">String</span> text <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">createText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 生成图片验证码</span>
		<span class="token class-name">BufferedImage</span> image <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 保存到验证码到 session</span>
		request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>KAPTCHA_SESSION_KEY<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">ServletOutputStream</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token string">"jpg"</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 登录接口
	 */</span>
	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/login"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">LoginBean</span> loginBean<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> username <span class="token operator">=</span> loginBean<span class="token punctuation">.</span><span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> password <span class="token operator">=</span> loginBean<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> captcha <span class="token operator">=</span> loginBean<span class="token punctuation">.</span><span class="token function">getCaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 从session中获取之前保存的验证码跟前台传来的验证码进行匹配</span>
		<span class="token class-name">Object</span> kaptcha <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>KAPTCHA_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>kaptcha <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"验证码已失效"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>captcha<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>kaptcha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"验证码不正确"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 用户信息</span>
		<span class="token class-name">SysUser</span> user <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 账号不存在、密码错误</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">PasswordUtils</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"密码不正确"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 账号锁定</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"账号已被锁定,请联系管理员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 系统登录认证</span>
		<span class="token class-name">JwtAuthenticatioToken</span> token <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> </li><li> <p>接口测试</p> <p>编译启动应用在Swagger测试页进行测试：</p> </li></ol> 
<p><img src="https://images2.imgbox.com/8c/91/7XOu3UP9_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="72_Spring_Security_1695"></a>7.2 Spring Security</h4> 
<p>在Web应用开发中，安全一直是非常重要的一个方面。Spring Security基于Spring框架，提供了一套Web应用安全性的完整解决方案。JWT(JSON Web Token)是当前比较主流的Token令牌生成方案，非常适合作为登录和授权认证的凭证。这里我们使用Spring Security并结合JWT实现用户认证(Authentication)和用户授权(Authorization)两个主要部分的安全内容。</p> 
<ul><li>JWT官网:<a href="https://jwt.io/introduction/" rel="nofollow">https://jwt.io/introduction/</a></li><li>Spring Security官网:<a href="https://spring.io/projects/spring-security" rel="nofollow">https://spring.io/projects/spring-security</a></li><li>Spring Security教程:<a href="https://www.w3cschool.cn/springsecurity/" rel="nofollow">https://www.w3cschool.cn/springsecurity/</a></li></ul> 
<h5><a id="721__1703"></a>7.2.1 添加依赖</h5> 
<p>在mango-admin下的pom文件中添加Spring Security和JWT依赖包。</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- spring security --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- jwt --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="722__1721"></a>7.2.2 添加配置</h5> 
<p>在config包下新建一个Spring Security的配置类WebSecurityConfig，主要是进行一些安全相关的配置，比如权限URL匹配策略、认证过滤器配置、定制身份验证组件、开启权限认证注解等。</p> 
<p>WebSecurityConfig.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>	<span class="token comment">// 开启Spring Security </span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>	<span class="token comment">// 开启权限注解，如：@PreAuthorize注解</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用自定义身份验证组件</span>
        auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JwtAuthenticationProvider</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 禁用 csrf, 由于使用的是JWT，我们这里不需要csrf</span>
        http<span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    		<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    		<span class="token comment">// 跨域预检请求</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>OPTIONS<span class="token punctuation">,</span> <span class="token string">"/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// web jars</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/webjars/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 查看SQL监控（druid）</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/druid/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 首页和登录页面</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// swagger</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/swagger-ui.html"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/swagger-resources/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/v2/api-docs"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/webjars/springfox-swagger-ui/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 验证码</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/captcha.jpg**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 服务监控</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/actuator/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// 其他所有请求需要身份认证</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 退出登录处理器</span>
        http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpStatusReturningLogoutSuccessHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// token验证过滤器</span>
        http<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JwtAuthenticationFilter</span><span class="token punctuation">(</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="723__1782"></a>7.2.3 登录认证过滤器</h5> 
<p>登录认证过滤器负责登录认证时检查并生产令牌保存到上下文，接口权限认证过程时，系统从上下文获取令牌校验接口访问权限，新建一个security包，在其下创建JwtAuthenticationFilter并继承BasicAuthenticationFilter，覆写其中的doFilterInternal方法进行Token校验。</p> 
<p>JwtAuthenticationFilter.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">BasicAuthenticationFilter</span> <span class="token punctuation">{<!-- --></span>

	
	<span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 获取token, 并检查登录状态</span>
        <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">checkAuthentication</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>这里我们把验证逻辑抽取到了SecurityUtils的checkAuthentication方法中，checkAuthentication通过JwtTokenUtils的方法获取认证信息并保存到Spring Security上下文。</p> 
<p>SecurityUtils.java:</p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 获取令牌进行认证
	 * @param request
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 获取令牌并根据令牌获取登录认证信息</span>
		<span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">JwtTokenUtils</span><span class="token punctuation">.</span><span class="token function">getAuthenticationeFromToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 设置登录认证信息到上下文</span>
		<span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>JwtTokenUtils的getAuthenticationeFromToken方法获取并校验请求携带的令牌。</p> 
<p>JwtTokenUtils.java:</p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 根据请求令牌获取登录认证信息
	 * @param token 令牌
	 * @return 用户名
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Authentication</span> <span class="token function">getAuthenticationeFromToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token comment">// 获取请求携带的令牌</span>
		<span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">JwtTokenUtils</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 请求令牌不能为空</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 上下文中Authentication为空</span>
				<span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token function">getClaimsFromToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>claims <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">String</span> username <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isTokenExpired</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token class-name">Object</span> authors <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>AUTHORITIES<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>authors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> authors <span class="token keyword">instanceof</span> <span class="token class-name">List</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> object <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">)</span> authors<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						authorities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GrantedAuthorityImpl</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"authority"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				authentication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAuthenticatioToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> authorities<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">validateToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// 如果上下文中Authentication非空，且请求令牌合法，直接返回当前登录认证信息</span>
					authentication <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>JwtTokenUtils的getToken尝试从请求头中获取请求携带的令牌，默认从请求头中的"Authorization"参数以"Bearer"开头的信息为令牌信息，若为空则尝试从"Token"参数获取。</p> 
<p>JwtTokenUtils.java:</p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 获取请求token
     * @param request
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> tokenHead <span class="token operator">=</span> <span class="token string">"Bearer "</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tokenHead<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        	token <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>tokenHead<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	token <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="724__1897"></a>7.2.4 身份验证组件</h5> 
<p>Spring Security的登录验证是由ProviderManager负责的，ProviderManager在实际验证的适合又会通过调用AuthenticationProvider的authenticate方法进行认证。数据库类型的默认实现方案是DaoAuthenticationProvider。我们这里通过继承DaoAuthenticationProvider定制默认的登录认证逻辑，在Security包下新建验证器JwtAuthenticationProvider并继承DaoAuthenticationProvider，覆盖实现additionalAuthenticationChecks方法进行密码匹配，我们这里没有使用默认的密码认证器(我们使用盐salt来对密码进行加密，默认密码验证其没有加盐)，所以在这里定制了自己的密码校验逻辑。也可以直接覆写authenticate方法来完成更大范围的登录认证需求定制。</p> 
<p>JwtAuthenticationProvider.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationProvider</span> <span class="token keyword">extends</span> <span class="token class-name">DaoAuthenticationProvider</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token class-name">JwtAuthenticationProvider</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setUserDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Authentication failed: no credentials provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="token punctuation">,</span> <span class="token string">"Bad credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token class-name">String</span> presentedPassword <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> salt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JwtUserDetails</span><span class="token punctuation">)</span> userDetails<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 覆写密码验证逻辑</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">new</span> <span class="token class-name">PasswordEncoder</span><span class="token punctuation">(</span>salt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> presentedPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Authentication failed: password does not match stored value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="token punctuation">,</span> <span class="token string">"Bad credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="725__1930"></a>7.2.5 认证信息查询</h5> 
<p>我们上面提到的登录认证默认是通过DaoAuthenticationProvider来完成登录认证的，而我们知道登录验证器在进行时肯定要从数据库获取用户信息进行匹配的，而这个获取用户信息的任务是通过Spring Security的UserDetailsService组件完成的。</p> 
<p>在security包下新建一个UserDetailsServiceImpl并实现UserDetailsService接口，覆写其中的方法loadUserByUsername，查询用户的密码信息和权限信息并封装在UserDetails的实现类对象，作为结果JwtUserDetails返回给DaoAuthenticationProvider做进一步处理。</p> 
<p>UserDetailsServiceImpl.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserService</span> sysUserService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SysUser</span> user <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"该用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 用户权限列表，根据用户拥有的权限标识与如 @PreAuthorize("hasAuthority('sys:menu:view')") 标注的接口对比，决定是否可以调用接口</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">findPermissions</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> grantedAuthorities <span class="token operator">=</span> permissions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">GrantedAuthorityImpl</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtUserDetails</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> grantedAuthorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>JwtUserDetails是对认证信息的封装，实现Spring Security，提供UserDetails接口，主要包含用户名、密码、加密盐和权限等信息。</p> 
<p>JwtUserDetails.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUserDetails</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
	
	<span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> salt<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">;</span>

    <span class="token class-name">JwtUserDetails</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> salt<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>salt <span class="token operator">=</span> salt<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authorities <span class="token operator">=</span> authorities<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> username<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> salt<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> authorities<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>GrantedAuthorityImpl实现Spring Security的GrantedAuthority接口，是对权限的封装，内部包含一个字符串类型的权限标识authority，对应菜单表的perms字段的权限字符串，比如用户管理的增删改查权限标志sys:user:view、sys:user:add、sys:user:edit、sys:user:delete。</p> 
<p>GrantedAuthorityImpl.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GrantedAuthorityImpl</span> <span class="token keyword">implements</span> <span class="token class-name">GrantedAuthority</span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> authority<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">GrantedAuthorityImpl</span><span class="token punctuation">(</span><span class="token class-name">String</span> authority<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authority <span class="token operator">=</span> authority<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthority</span><span class="token punctuation">(</span><span class="token class-name">String</span> authority<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authority <span class="token operator">=</span> authority<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authority<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="726__2052"></a>7.2.6 添加权限注解</h5> 
<p>在用户拥有某个后台访问权限才能访问，这叫做接口保护。我们这里通过Spring Security提供的权限注解来保护后台接口免受非法访问，这里以字典管理模块为例。</p> 
<p>在SysDictController的接口上添加类似@PreAuthorize(“hasAuthority(‘sys:dict:view’)”)的注解，表示只有当前登录用户拥有sys:dict:view权限标识才能访问此接口，这里的权限标识需对应菜单表中的perms权限信息，所以可通过配置菜单表的权限来灵活控制接口的访问权限。</p> 
<p>SysDictController.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"dict"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysDictController</span> <span class="token punctuation">{<!-- --></span>

	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">SysDictService</span> sysDictService<span class="token punctuation">;</span>
	
	<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('sys:dict:add') AND hasAuthority('sys:dict:edit')"</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/save"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SysDict</span> <span class="token keyword">record</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysDictService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">record</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('sys:dict:delete')"</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/delete"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDict</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysDictService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('sys:dict:view')"</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/findPage"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">PageRequest</span> pageRequest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysDictService<span class="token punctuation">.</span><span class="token function">findPage</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('sys:dict:view')"</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"/findByLable"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">findByLable</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> lable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysDictService<span class="token punctuation">.</span><span class="token function">findByLable</span><span class="token punctuation">(</span>lable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="727_Swagger_2094"></a>7.2.7 Swagger添加令牌函数</h5> 
<p>由于我们引入Spring Security安全框架，接口受到保护，需要携带合法的token令牌(一般是登录成功之后由后台返回)才能正常访问，但是Swagger本身的接口测试页面默认没有提供传送token参数的地方，因此需要简单定制一下，修改SwaggerConfig配置类即可。</p> 
<p>SwaggerConfig.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Docket</span> <span class="token function">createRestApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 添加请求参数，我们这里把token作为请求头部参数传入后端</span>
		<span class="token class-name">ParameterBuilder</span> parameterBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParameterBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Parameter</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Parameter</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		parameterBuilder<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">"令牌"</span><span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">modelRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ModelRef</span><span class="token punctuation">(</span><span class="token string">"string"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parameterType</span><span class="token punctuation">(</span><span class="token string">"header"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		parameters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>parameterBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Docket</span><span class="token punctuation">(</span><span class="token class-name">DocumentationType</span><span class="token punctuation">.</span>SWAGGER_2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">apis</span><span class="token punctuation">(</span><span class="token class-name">RequestHandlerSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token class-name">PathSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">globalOperationParameters</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        return new Docket(DocumentationType.SWAGGER_2).apiInfo(apiInfo()).select()</span>
<span class="token comment">//        		.apis(RequestHandlerSelectors.any()).paths(PathSelectors.any()).build();</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ApiInfo</span> <span class="token function">apiInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApiInfoBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>配置之后重新启动就可以进行传参了，测试接口时先将登录接口返回的token复制到此处即可.</p> 
<p><img src="https://images2.imgbox.com/46/bc/C69A7DPw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f1/5c/anpRqPgh_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/48/cb/uMiAVd6I_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bb/41/DTYQNFaZ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c6/30/Am6wpQKQ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="73__2136"></a>7.3 登录接口实现</h4> 
<p>在登录控制器中添加一个登录接口login，在其中验证验证码、用户名、密码信息。匹配成功之后，执行Spring Security的登录认证机制。登录成功之后返回Token令牌凭证。</p> 
<p>SysLoginController.java:</p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 登录接口
	 */</span>
	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/login"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">LoginBean</span> loginBean<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> username <span class="token operator">=</span> loginBean<span class="token punctuation">.</span><span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> password <span class="token operator">=</span> loginBean<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> captcha <span class="token operator">=</span> loginBean<span class="token punctuation">.</span><span class="token function">getCaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 从session中获取之前保存的验证码跟前台传来的验证码进行匹配</span>
		<span class="token class-name">Object</span> kaptcha <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>KAPTCHA_SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>kaptcha <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"验证码已失效"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>captcha<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>kaptcha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"验证码不正确"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 用户信息</span>
		<span class="token class-name">SysUser</span> user <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 账号不存在、密码错误</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">PasswordUtils</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"密码不正确"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 账号锁定</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"账号已被锁定,请联系管理员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 系统登录认证</span>
		<span class="token class-name">JwtAuthenticatioToken</span> token <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>这里将Spring Security的登录认证逻辑封装到了工具类SecurityUtils的login方法中，认证流程大致分为以下四步：</p> 
<ul><li>将用户名密码的认证信息封装到JwtAuthenticatioToken对象。</li><li>通过调用authenticationManager.authenticate(token)执行认证流程。</li><li>通过SecurityContextHolder将认证信息保存到上下文。</li><li>通过JwtTokenUtils.generateToken(authentication)生成token并返回。</li></ul> 
<p>SecurityUtils.java:</p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 系统登录认证
	 * @param request
	 * @param username
	 * @param password
	 * @param authenticationManager
	 * @return
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JwtAuthenticatioToken</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">JwtAuthenticatioToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAuthenticatioToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
		token<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 执行登录认证过程</span>
	    <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token comment">// 认证成功存储认证信息到上下文</span>
	    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 生成令牌并返回给客户端</span>
	    token<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span><span class="token class-name">JwtTokenUtils</span><span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> token<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>关于JwtTokenUtils如何生成Token的逻辑参见以下两个方法：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
	 * 生成令牌
	 *
	 * @param userDetails 用户
	 * @return 令牌
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    claims<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>USERNAME<span class="token punctuation">,</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    claims<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>CREATED<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    claims<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>AUTHORITIES<span class="token punctuation">,</span> authentication<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">return</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
     * 从数据声明生成令牌
     *
     * @param claims 数据声明
     * @return 令牌
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Date</span> expirationDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> EXPIRE_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setClaims</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>expirationDate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span>HS512<span class="token punctuation">,</span> SECRET<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>LoginBean是对登录认证信息的简单封装，包含账号密码和验证码信息：</p> 
<p>LoginBean.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginBean</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token class-name">String</span> account<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> captcha<span class="token punctuation">;</span>
	
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> account<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccount</span><span class="token punctuation">(</span><span class="token class-name">String</span> account<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>account <span class="token operator">=</span> account<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> password<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> captcha<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCaptcha</span><span class="token punctuation">(</span><span class="token class-name">String</span> captcha<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>captcha <span class="token operator">=</span> captcha<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<p>JwtAuthenticatioToken继承UsernamePasswordAuthenticationToken，是对令牌信息的简单封装，用来作为认证和授权的信任凭证，其中的token信息由JWT负责生成：</p> 
<p>JwtAuthenticatioToken.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticatioToken</span> <span class="token keyword">extends</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
	
	<span class="token keyword">private</span> <span class="token class-name">String</span> token<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">JwtAuthenticatioToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> credentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">JwtAuthenticatioToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">,</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">super</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> credentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span>token <span class="token operator">=</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JwtAuthenticatioToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">,</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">super</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> credentials<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span>token <span class="token operator">=</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> token<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>token <span class="token operator">=</span> token<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getSerialversionuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> serialVersionUID<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>接口测试见上节图片。</p> 
<h4><a id="74_Spring_Security_2313"></a>7.4 Spring Security执行流程剖析</h4> 
<p>Spring Security功能强大，使用也稍显复杂，因为涉及的内容比较多，所以入门门槛比较高，很多从业人员深受其烦，不少人就算跟着网上的教程会使用项目案例了，但是遇到问题还是摸不着头脑，这都是对其执行流程不熟悉造成的。(焯！你再骂！)</p> 
<p>作者大大是个好人，为我这种菜鸡附上了他博客的一篇剖析文章，通过追踪与解读源码的方式为读者详细剖析Spring Security的执行流程。在熟悉整个流程之后，许多问题就迎刃而解了。<a href="https://www.cnblogs.com/xifengxiaoma/p/10020960.html" rel="nofollow">https://www.cnblogs.com/xifengxiaoma/p/10020960.html</a>。(哼！在我收藏夹吃灰去吧)</p> 
<h3><a id="8__2319"></a>8. 数据备份还原</h3> 
<p>很多时候，我们需要对系统数据进行备份和还原。当然，实际生产环境的数据备份和还原通常是由专业数据库维护人员在数据库端通过命令执行的。这里提供的是通过代码进行数据备份，主要是方便一些日常的数据恢复，比如说想把数据恢复到某一时间节点的数据。这一章节讲解如何通过代码调用MySQL的备份还原命令实现系统备份还原的功能。</p> 
<h4><a id="81__2323"></a>8.1 新建工程</h4> 
<p>新建mango-backup工程，这是一个独立运行于admin的服务模块，可以分开独立部署。</p> 
<h4><a id="82__2327"></a>8.2 添加依赖</h4> 
<p>在pom.xml中添加以下相关依赖，主要包含Web、Swagger和common依赖包：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- spring boot --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- swagger --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springfox-swagger2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springfox-swagger-ui<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.louis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mango-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="83__2357"></a>8.3 添加配置</h4> 
<p>在配置文件中添加以下配置，定义启动端口为8002，应用名称是mango-backup，定义系统数据备份还原的数据库连接信息：</p> 
<pre><code class="prism language-yml"><span class="token comment"># tomcat</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8002</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>backup
<span class="token comment"># backup datasource</span>
<span class="token key atrule">mango</span><span class="token punctuation">:</span>
  <span class="token key atrule">backup</span><span class="token punctuation">:</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">userName</span><span class="token punctuation">:</span> root
      <span class="token key atrule">password</span><span class="token punctuation">:</span> admin123
      <span class="token key atrule">database</span><span class="token punctuation">:</span> mango
</code></pre> 
<h4><a id="84_Banner_2378"></a>8.4 自定义Banner</h4> 
<h4><a id="85__2380"></a>8.5 启动类</h4> 
<p>修改启动类MangoBackupApplication，指定包扫描路径为com.louis.mango。</p> 
<p>MangoBackupApplication.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>scanBasePackages<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"com.louis.mango"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MangoBackupApplication</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MangoBackupApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="86__2396"></a>8.6 跨域配置</h4> 
<p>在config包下添加跨域配置类。</p> 
<p>CorsConfig.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CorsConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCorsMappings</span><span class="token punctuation">(</span><span class="token class-name">CorsRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        registry<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span>	<span class="token comment">// 允许跨域访问的路径</span>
        <span class="token punctuation">.</span><span class="token function">allowedOrigins</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span>	<span class="token comment">// 允许跨域访问的源</span>
        <span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">,</span> <span class="token string">"OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"DELETE"</span><span class="token punctuation">)</span>	<span class="token comment">// 允许请求方法</span>
        <span class="token punctuation">.</span><span class="token function">maxAge</span><span class="token punctuation">(</span><span class="token number">168000</span><span class="token punctuation">)</span>	<span class="token comment">// 预检间隔时间</span>
        <span class="token punctuation">.</span><span class="token function">allowedHeaders</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span>  <span class="token comment">// 允许头部设置</span>
        <span class="token punctuation">.</span><span class="token function">allowCredentials</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 是否发送cookie</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="87_Swagger_2418"></a>8.7 Swagger配置</h4> 
<p>在config包下添加Swagger配置类。</p> 
<p>SwaggerConfig.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerConfig</span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">Docket</span> <span class="token function">createRestApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Docket</span><span class="token punctuation">(</span><span class="token class-name">DocumentationType</span><span class="token punctuation">.</span>SWAGGER_2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">apis</span><span class="token punctuation">(</span><span class="token class-name">RequestHandlerSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token class-name">PathSelectors</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="88__2438"></a>8.8 数据源属性</h4> 
<p>添加一个数据源属性配置类，配置@ConfigurationProperties(prefix = “mango.backup.datasource”) 注解，这样就可以通过注入BackupDataSourceProperties读取数据源属性了。</p> 
<p>BackupDataSourceProperties.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>  
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"mango.backup.datasource"</span><span class="token punctuation">)</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BackupDataSourceProperties</span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> database<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> host<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHost</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> host<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> userName<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> password<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> database<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDatabase</span><span class="token punctuation">(</span><span class="token class-name">String</span> database<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>database <span class="token operator">=</span> database<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre> 
<p>遇到springboot configuration annotation precessor not configured情况时在pom.xml中添加依赖：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-configuration-processor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="89__2490"></a>8.9 备份还原接口</h4> 
<p>在service包下添加一个MysqlBackupService接口，包含backup和restore两个接口，分别对应备份和还原两个接口。</p> 
<p>MysqlBackupService.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MysqlBackupService</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 备份数据库
	 * @param host host地址，可以是本机也可以是远程
	 * @param userName 数据库的用户名
	 * @param password 数据库的密码
	 * @param savePath 备份的路径
	 * @param fileName 备份的文件名
	 * @param databaseName 需要备份的数据库的名称
	 * @return
	 * @throws IOException 
	 */</span>
	<span class="token keyword">boolean</span> <span class="token function">backup</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token class-name">String</span> userName<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> backupFolderPath<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">String</span> database<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 恢复数据库
     * @param restoreFilePath 数据库备份的脚本路径
     * @param host IP地址
     * @param database 数据库名称
     * @param userName 用户名
     * @param password 密码
     * @return
     */</span>
	<span class="token keyword">boolean</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token class-name">String</span> restoreFilePath<span class="token punctuation">,</span> <span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token class-name">String</span> userName<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> database<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="810__2526"></a>8.10 备份还原实现</h4> 
<p>在service.impl下添加MysqlBackupServiceImpl，实现backup和restore两个接口。</p> 
<p>MysqlBackupServiceImpl.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlBackupServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MysqlBackupService</span> <span class="token punctuation">{<!-- --></span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">backup</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token class-name">String</span> userName<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> backupFolderPath<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>
			<span class="token class-name">String</span> database<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">MySqlBackupRestoreUtils</span><span class="token punctuation">.</span><span class="token function">backup</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">,</span> backupFolderPath<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token class-name">String</span> restoreFilePath<span class="token punctuation">,</span> <span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token class-name">String</span> userName<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> database<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">MySqlBackupRestoreUtils</span><span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span>restoreFilePath<span class="token punctuation">,</span> host<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="811__2550"></a>8.11 备份还原逻辑</h4> 
<p>为了方便复用，我们将系统数据备份和还原逻辑封装到了MySqlBackupRestoreUtils工具类，主要是通过代码调用MySQL的数据库备份和还原命令实现。</p> 
<p>MySqlBackupRestoreUtils.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>louis<span class="token punctuation">.</span>mango<span class="token punctuation">.</span>backup<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * MySQL备份还原工具类
 * @author Louis
 * @date Jan 15, 2019
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySqlBackupRestoreUtils</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 备份数据库
	 * @param host host地址，可以是本机也可以是远程
	 * @param userName 数据库的用户名
	 * @param password 数据库的密码
	 * @param savePath 备份的路径
	 * @param fileName 备份的文件名
	 * @param databaseName 需要备份的数据库的名称
	 * @return
	 * @throws IOException 
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">backup</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token class-name">String</span> userName<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> backupFolderPath<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>
			<span class="token class-name">String</span> database<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">File</span> backupFolderFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>backupFolderPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>backupFolderFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 如果目录不存在则创建</span>
			backupFolderFile<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>backupFolderPath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token class-name">File</span><span class="token punctuation">.</span>separator<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>backupFolderPath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			backupFolderPath <span class="token operator">=</span> backupFolderPath <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 拼接命令行的命令</span>
		<span class="token class-name">String</span> backupFilePath <span class="token operator">=</span> backupFolderPath <span class="token operator">+</span> fileName<span class="token punctuation">;</span>
		<span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"mysqldump --opt "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" --add-drop-database "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" --add-drop-table "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" -h"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" -u"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" -p"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
		stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" --result-file="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>backupFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" --default-character-set=utf8 "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 调用外部执行 exe 文件的 Java API</span>
		<span class="token class-name">Process</span> process <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token function">getCommand</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 0 表示线程正常终止</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据已经备份到 "</span> <span class="token operator">+</span> backupFilePath <span class="token operator">+</span> <span class="token string">" 文件中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">/**
     * 还原数据库
     * @param restoreFilePath 数据库备份的脚本路径
     * @param host IP地址
     * @param database 数据库名称
     * @param userName 用户名
     * @param password 密码
     * @return
     */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token class-name">String</span> restoreFilePath<span class="token punctuation">,</span> <span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token class-name">String</span> userName<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> database<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">File</span> restoreFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>restoreFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>restoreFile<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> restoreFile<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".sql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					restoreFilePath <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"mysql -h"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" -u"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" -p"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
		stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" &lt; "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>restoreFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Process</span> process <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token function">getCommand</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据已从 "</span> <span class="token operator">+</span> restoreFilePath <span class="token operator">+</span> <span class="token string">" 导入到数据库中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getCommand</span><span class="token punctuation">(</span><span class="token class-name">String</span> command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> os <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"os.name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token class-name">String</span> shell <span class="token operator">=</span> <span class="token string">"/bin/bash"</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> c <span class="token operator">=</span> <span class="token string">"-c"</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"win"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
			shell <span class="token operator">=</span> <span class="token string">"cmd"</span><span class="token punctuation">;</span>
			c <span class="token operator">=</span> <span class="token string">"/c"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>  
		<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmd <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> shell<span class="token punctuation">,</span> c<span class="token punctuation">,</span> command <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> cmd<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token string">"localhost"</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> userName <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">"admin123"</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> database <span class="token operator">=</span> <span class="token string">"mango"</span><span class="token punctuation">;</span>
		
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"开始备份"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> backupFolderPath <span class="token operator">=</span> <span class="token string">"c:/dev/"</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token string">"mango.sql"</span><span class="token punctuation">;</span>
		<span class="token function">backup</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">,</span> backupFolderPath<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"备份成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"开始还原"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> restoreFilePath <span class="token operator">=</span> <span class="token string">"c:/dev/mango.sql"</span><span class="token punctuation">;</span>
		<span class="token function">restore</span><span class="token punctuation">(</span>restoreFilePath<span class="token punctuation">,</span> host<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"还原成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="812__2675"></a>8.12 备份还原控制器</h4> 
<p>在controller包下新建一个控制器，备份还原控制器对外提供数据备份还原的服务。包含以下几个接口。</p> 
<h5><a id="8121__2679"></a>8.12.1 数据备份接口</h5> 
<p>backup是数据备份接口，读取数据源信息及备份信息生成数据备份。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/backup"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">backup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token class-name">String</span> backupFodlerName <span class="token operator">=</span> <span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>DEFAULT_BACKUP_NAME <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>DATE_FORMAT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token function">backup</span><span class="token punctuation">(</span>backupFodlerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">HttpResult</span> <span class="token function">backup</span><span class="token punctuation">(</span><span class="token class-name">String</span> backupFodlerName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token class-name">String</span> host <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> userName <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> password <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> database <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> backupFolderPath <span class="token operator">=</span> <span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>BACKUP_FOLDER <span class="token operator">+</span> backupFodlerName <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator<span class="token punctuation">;</span>
   <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>BACKUP_FILE_NAME<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">boolean</span> success <span class="token operator">=</span> mysqlBackupService<span class="token punctuation">.</span><span class="token function">backup</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">,</span> backupFolderPath<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"数据备份失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="8122__2709"></a>8.12.2 数据还原接口</h5> 
<p>restore是数据还原接口，读取数据源信息和还原版本进行数据还原。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/restore"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
   <span class="token class-name">String</span> host <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> userName <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> password <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> database <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> restoreFilePath <span class="token operator">=</span> <span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>RESTORE_FOLDER <span class="token operator">+</span> name<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      mysqlBackupService<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span>restoreFilePath<span class="token punctuation">,</span> host<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="8123__2730"></a>8.12.3 查找备份接口</h5> 
<p>findRecords是备份查找接口，用于查找和向用户展示数据备份版本。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/findRecords"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">findBackupRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>DEFAULT_RESTORE_FILE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 初始默认备份文件</span>
      <span class="token function">backup</span><span class="token punctuation">(</span><span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>DEFAULT_BACKUP_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> backupRecords <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">File</span> restoreFolderFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>RESTORE_FOLDER<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>restoreFolderFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token operator">:</span>restoreFolderFile<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> backup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         backup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         backup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>DEFAULT_BACKUP_NAME<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            backup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"系统默认备份"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         backupRecords<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>backup<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 排序，默认备份最前，然后按时间戳排序，新备份在前面</span>
   backupRecords<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>DEFAULT_BACKUP_NAME<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>o1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span>
         <span class="token operator">:</span> <span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>DEFAULT_BACKUP_NAME<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> o2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>o1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>backupRecords<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="8124__2761"></a>8.12.4 删除备份接口</h5> 
<p>delete是备份删除接口，通过备份还原管理界面删除数据备份版本。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/delete"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">HttpResult</span> <span class="token function">deleteBackupRecord</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>DEFAULT_BACKUP_NAME<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>     
      <span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"系统默认备份无法删除!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">String</span> restoreFilePath <span class="token operator">=</span> <span class="token class-name">BackupConstants</span><span class="token punctuation">.</span>BACKUP_FOLDER <span class="token operator">+</span> name<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">deleteFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>restoreFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token class-name">HttpResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="9__2781"></a>9. 系统服务监控</h3> 
<p>Spring Boot Admin是一个管理和监控Spring Boot应用程序的开源监控软件，针对spring-boot的actuator接口进行UI美化并封装，可以在管理界面中浏览所有被监控的spring-boot项目的基本信息，详细的Health信息、内存信息、JVM信息、垃圾回收信息、各种配置信息(比如数据源、缓存列表和命中率)等，还可以直接修改logger的level，Spring Boot Admin提供的丰富详细的监控信息给Spring Boot应用的监控、维护和优化都带来了极大的便利。</p> 
<h4><a id="91__2785"></a>9.1 新建工程</h4> 
<p>新建一个mango-monitor项目，作为服务监控服务端。</p> 
<h4><a id="92__2789"></a>9.2 添加依赖</h4> 
<p>在pom.xml中添加依赖包，主要是Spring Boot和Spring Boot Admin依赖。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- spring boot --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--spring-boot-admin--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-server-ui<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="93__2814"></a>9.3 添加配置</h4> 
<p>在配置文件中添加配置，指定启动端口为8000、应用名称为mango-monitor。</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>monitor
</code></pre> 
<h4><a id="94_Banner_2826"></a>9.4 自定义Banner</h4> 
<h4><a id="95__2828"></a>9.5 启动类</h4> 
<p>修改启动类MangoMonitorApplication并在头部添加EnableAdminServer注解，开启监控服务。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableAdminServer</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MangoMonitorApplication</span> <span class="token punctuation">{<!-- --></span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MangoMonitorApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="96__2843"></a>9.6 监控客户端</h4> 
<p>把后台服务mango-admin和数据备份还原服务mango-backup注册到监控服务。</p> 
<p>分别在mango-admin和mango-backup的pom文件中添加监控客户端依赖：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--spring-boot-admin-client--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-starter-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
</code></pre> 
<p>分别在mango-admin和mango-backup的配置文件中配置服务监控信息。主要是指定监控的服务器地址，另外endpoints是开放监控接口，因为处于安全的考虑，Spring Boot默认是没有开放健康检查接口的，可以通过endpoints设置开放特定的接口，" * "表示全部开放。</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8001</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>admin
  <span class="token key atrule">boot</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"http://localhost:8000"</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> druidDataSource
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
    <span class="token key atrule">druid</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
      <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/mango<span class="token punctuation">?</span>serverTimezone=GMT%2B8<span class="token important">&amp;characterEncoding=utf-</span><span class="token number">8</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> root
      <span class="token key atrule">password</span><span class="token punctuation">:</span> admin123
      <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat<span class="token punctuation">,</span>wall<span class="token punctuation">,</span>log4j<span class="token punctuation">,</span>config
      <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token key atrule">initial-size</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
      <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">time-between-eviction-runs-millis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
      <span class="token key atrule">min-evictable-idle-time-millis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
      <span class="token key atrule">validation-query</span><span class="token punctuation">:</span> select 'x'
      <span class="token key atrule">test-while-idle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">test-on-borrow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">test-on-return</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">pool-prepared-statements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">max-open-prepared-statements</span><span class="token punctuation">:</span> <span class="token number">50</span>
      <span class="token key atrule">max-pool-prepared-statement-per-connection-size</span><span class="token punctuation">:</span> <span class="token number">20</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
</code></pre> 
<h4><a id="97__2899"></a>9.7 启动服务端</h4> 
<p>编译启动MangoMonitorApplication，访问<a href="http://localhost:8000/#/applications" rel="nofollow">http://localhost:8000/#/applications</a>，进入应用监控界面，如下：</p> 
<p><img src="https://images2.imgbox.com/0a/af/rKP43KPK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="10_Consul_2906"></a>10. 注册中心(Consul)</h3> 
<h4><a id="101_Consul_2908"></a>10.1 什么是Consul</h4> 
<p>Consul是HashiCorp公司推出的开源工具，用于实现分布式系统的服务发现与配置。与其他分布式服务注册与发现的方案相比，Consul的方案更"一站式"，内置了服务注册与发现框架、分布一致性协议实现、健康检查，Key/Value存储、多数据中心方案，不再需要依赖其他工具(比如ZooKeeper等)。使用起来也较为简单。Consul使用Go语言编写，因此具有天然可移植性(支持Linux、Windows和Max OS X)；安装包仅包含一个可执行文件，方便部署，与Docker等轻量级容器可无缝配合。</p> 
<h4><a id="102_Consul_2912"></a>10.2 Consul安装</h4> 
<p>访问Consul官网，根据操作系统类型，选择下载Consul最新版本。下载下是一个zip压缩包，解压之后是一个exe可执行文件。打开CMD终端进入consul.exe所在目录，执行如下命令启动Consul服务：</p> 
<pre><code>consul agent -dev
</code></pre> 
<p>启动过程信息如下：</p> 
<p><img src="https://images2.imgbox.com/2a/fb/IptELmBf_o.png" alt="在这里插入图片描述"></p> 
<p>启动成功后，访问<a href="http://localhost:8500" rel="nofollow">http://localhost:8500</a>，可以看到如下所示的Consul服务管理界面。</p> 
<p><img src="https://images2.imgbox.com/ec/97/9tdTICxi_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="103_monitor_2930"></a>10.3 monitor改造</h4> 
<p>改造mango-monitor工程，作为服务注册到注册中心。</p> 
<h5><a id="1031__2934"></a>10.3.1 添加依赖</h5> 
<p>在pom.xml中添加Spring Cloud和Consul注册中心依赖。</p> 
<p><strong><u>注意</u></strong>：Spring Boot2.1后的版本会出现Consul服务注册上的问题，可能是因为配置变更或者支持方式改变，由于版本太新，网上也没有找到相关解决方案，所以这里把Spring Boot版本调整为2.0.4，Spring Cloud版本使用最新的稳定发布版。(解决方案参考<a href="https://blog.csdn.net/weixin_46041797/article/details/119006411">https://blog.csdn.net/weixin_46041797/article/details/119006411</a>)</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--consul--&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--srping cloud--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Finchley.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="1032__2963"></a>10.3.2 配置文件</h5> 
<p>修改配置文件，添加服务注册配置。</p> 
<p>application.yml：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>monitor
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>	<span class="token comment"># 注册到consul的服务名称</span>
</code></pre> 
<h5><a id="1033__2983"></a>10.3.3 启动类</h5> 
<p>修改启动类，添加@EnableDiscoveryClient注解，开启服务发现支持.</p> 
<h5><a id="1034__2987"></a>10.3.4 测试效果</h5> 
<p>启动服务监控服务器，访问<a href="http://localhost:8500" rel="nofollow">http://localhost:8500</a>，发现服务已经成功注册到注册中心，如下：</p> 
<p><img src="https://images2.imgbox.com/b5/d2/AFXDLAuA_o.png" alt="在这里插入图片描述"></p> 
<p>访问<a href="http://localhost:8000" rel="nofollow">http://localhost:8000</a>，查看服务监控管理界面，看到如下所示界面就没问题了：</p> 
<p><img src="https://images2.imgbox.com/7d/cc/PNVm5mYr_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="104_backup_2999"></a>10.4 backup改造</h4> 
<p>改造mango-backup工程，作为服务注册到注册中心。</p> 
<h5><a id="1041__3003"></a>10.4.1 添加依赖</h5> 
<p>同上。</p> 
<h5><a id="1042__3007"></a>10.4.2 配置文件</h5> 
<p>修改配置文件，添加服务注册配置。</p> 
<p>application.yml：</p> 
<pre><code class="prism language-yml"><span class="token comment"># tomcat</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8002</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>backup
  <span class="token key atrule">boot</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"http://localhost:8000"</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
<span class="token comment"># 开放健康检查接口</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">show-details</span><span class="token punctuation">:</span> ALWAYS
<span class="token comment"># backup datasource</span>
<span class="token key atrule">mango</span><span class="token punctuation">:</span>
  <span class="token key atrule">backup</span><span class="token punctuation">:</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">userName</span><span class="token punctuation">:</span> root
      <span class="token key atrule">password</span><span class="token punctuation">:</span> admin123
      <span class="token key atrule">database</span><span class="token punctuation">:</span> mango
</code></pre> 
<h5><a id="1043__3049"></a>10.4.3 启动类</h5> 
<p>修改启动类，添加@EnableDiscoveryClient注解，开启服务发现支持。</p> 
<h5><a id="1044__3053"></a>10.4.4 测试效果</h5> 
<p>测试效果同上差不多。</p> 
<h4><a id="105_admin_3057"></a>10.5 admin改造</h4> 
<p>改造mango-admin工程，作为服务注册到服务中心。</p> 
<h5><a id="1051__3061"></a>10.5.1 添加依赖</h5> 
<p>同上。</p> 
<h5><a id="1052__3065"></a>10.5.2 配置文件</h5> 
<p>修改配置文件，添加服务注册配置。</p> 
<p>application.yml:</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8001</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>admin
  <span class="token key atrule">boot</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"http://localhost:8000"</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> druidDataSource
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource
    <span class="token key atrule">druid</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
      <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/mango<span class="token punctuation">?</span>serverTimezone=GMT%2B8<span class="token important">&amp;characterEncoding=utf-</span><span class="token number">8</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> root
      <span class="token key atrule">password</span><span class="token punctuation">:</span> admin123
      <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat<span class="token punctuation">,</span>wall<span class="token punctuation">,</span>log4j<span class="token punctuation">,</span>config
      <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token key atrule">initial-size</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">60000</span>
      <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">time-between-eviction-runs-millis</span><span class="token punctuation">:</span> <span class="token number">60000</span>
      <span class="token key atrule">min-evictable-idle-time-millis</span><span class="token punctuation">:</span> <span class="token number">300000</span>
      <span class="token key atrule">validation-query</span><span class="token punctuation">:</span> select 'x'
      <span class="token key atrule">test-while-idle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">test-on-borrow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">test-on-return</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">pool-prepared-statements</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">max-open-prepared-statements</span><span class="token punctuation">:</span> <span class="token number">50</span>
      <span class="token key atrule">max-pool-prepared-statement-per-connection-size</span><span class="token punctuation">:</span> <span class="token number">20</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
<span class="token comment"># 开放健康检查接口</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">show-details</span><span class="token punctuation">:</span> ALWAYS
</code></pre> 
<h5><a id="1053__3120"></a>10.5.3 启动类</h5> 
<p>同上。</p> 
<h5><a id="1054__3124"></a>10.5.4 测试效果</h5> 
<p>同上差不多。</p> 
<h3><a id="11_RibbonFeign_3128"></a>11. 服务消费(Ribbon、Feign)</h3> 
<h4><a id="111__3130"></a>11.1 技术背景</h4> 
<p>在上一章中，我们利用Consul注册中心实现了服务的注册和发现功能。在单体应用中，代码可以直接依赖，在代码中直接调用即可；但是微服务架构(分布式架构)中服务都运行在各自的进程之中，甚至部署在不同的主机和不同的地区，就需要相关的远程调用技术了。</p> 
<p>Spring Cloud体系里应用比较广泛的服务调用方式有两种：</p> 
<ul><li>使用RestTemplate进行服务调用，可以通过Ribbon注解RestTemplate模板，使其拥有负载均衡的功能。</li><li>使用Feign进行声明式服务调用，声明之后就像调用本地方法一样，Feign默认使用Ribbon实现负载均衡。</li></ul> 
<p>两种方式都可以实现服务之间的调用，可根据情况选择使用，下面我们分别用实现案例进行详解。</p> 
<h4><a id="112__3141"></a>11.2 服务提供者</h4> 
<h5><a id="1121__3143"></a>11.2.1 新建项目</h5> 
<p>新建一个mango-producer，添加以下依赖：</p> 
<ul><li>Swagger：API文档</li><li>Consul：注册中心</li><li>Spring Boot Admin：服务监控</li></ul> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- web --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!-- swagger --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springfox-swagger2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${swagger.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.springfox<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springfox-swagger-ui<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${swagger.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--spring-boot-admin--&gt;</span>
       	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-starter-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.boot.admin.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!--consul--&gt;</span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	    <span class="token comment">&lt;!--test--&gt;</span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
	    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="1122__3189"></a>11.2.2 配置文件</h5> 
<p>在配置文件添加内容如下，将服务注册到注册中心并添加服务监控相关配置。</p> 
<p>application.yml:</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8003</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>producer
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
  <span class="token key atrule">boot</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"http://localhost:8000"</span>
<span class="token comment"># 开放健康检查接口</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">show-details</span><span class="token punctuation">:</span> ALWAYS
</code></pre> 
<h5><a id="1123__3222"></a>11.2.3 启动类</h5> 
<p>修改启动器类，添加@EnableDiscoveryClient注解，开启服务发现支持。</p> 
<h5><a id="1124_Banner_3226"></a>11.2.4 自定义Banner</h5> 
<p>同之前。</p> 
<h5><a id="1125__3230"></a>11.2.5 添加控制器</h5> 
<p>新建一个控制器，提供一个hello接口，返回字符串信息。</p> 
<p>HelloController.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"hello Mango !"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>为了模拟均衡负载，复制一份上面的项目，重命名为mango-producer2，修改对应的端口为8004，修改hello方法的返回值为"hello Mango 2!"</p> 
<p>依次启动注册中心、服务监控和两个服务提供者，启动成功之后刷新Consul管理界面，发现我们注册的mango-producer服务以及有两个节点实例。</p> 
<p>访问<a href="http://localhost:8500" rel="nofollow">http://localhost:8500</a>，查看两个服务提供者已经注册到注册中心，如下：</p> 
<p><img src="https://images2.imgbox.com/a2/2f/lK7XZczv_o.png" alt="在这里插入图片描述"></p> 
<p>访问<a href="http://localhost:8000" rel="nofollow">http://localhost:8000</a>，查看两个服务提供者已经成功显示在监控列表中，如下：</p> 
<p><img src="https://images2.imgbox.com/12/a9/3GPlsrmp_o.png" alt="在这里插入图片描述"></p> 
<p>访问<a href="http://localhost:8003/hello" rel="nofollow">http://localhost:8003/hello</a>，输出"hello Mango !"。</p> 
<p>访问<a href="http://localhost:8004/hello" rel="nofollow">http://localhost:8004/hello</a>，输出"hello Mango 2!"。</p> 
<p><img src="https://images2.imgbox.com/6c/84/ZzODje09_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e0/7d/5Hu2EPbj_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="113__3269"></a>11.3 服务消费者</h4> 
<h5><a id="1131__3271"></a>11.3.1 新建项目</h5> 
<p>新建一个项目mango-consumer，添加以下依赖：</p> 
<ul><li>Swagger</li><li>Consul</li><li>Spring Boot Admin</li></ul> 
<p>代码同上</p> 
<h5><a id="1132__3281"></a>11.3.2 添加配置</h5> 
<p>修改配置如下：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8005</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>consumer
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
  <span class="token key atrule">boot</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"http://localhost:8000"</span>
<span class="token comment"># 开放健康检查接口</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">show-details</span><span class="token punctuation">:</span> ALWAYS
</code></pre> 
<h5><a id="1133__3312"></a>11.3.3 启动类、</h5> 
<p>修改启动类，添加@EnableDiscoveryClient注解，开启服务发现支持</p> 
<h5><a id="1134_Banner_3316"></a>11.3.4 自定义Banner</h5> 
<p>同上。</p> 
<h5><a id="1135__3320"></a>11.3.5 服务消费</h5> 
<p>添加消费服务测试类，添加两个接口，一个查询我们注册的服务，另一个从我们注册的服务中选取一个服务，采用轮询的方式。</p> 
<p>ServiceController.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadBalancerClient</span> loadBalancerClient<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>

   <span class="token comment">/**
     * 获取所有服务
     */</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/services"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">"mango-producer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从所有服务中选择一个服务（轮询）
     */</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/discover"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">discover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> loadBalancerClient<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">"mango-producer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>添加完成之后启动项目，访问<a href="http://localhost:8500/" rel="nofollow">http://localhost:8500/</a>，服务消费者已经成功注册到注册中心：</p> 
<p><img src="https://images2.imgbox.com/4d/a1/6VUJ0dBe_o.png" alt="在这里插入图片描述"></p> 
<p>访问<a href="http://localhost:8000/" rel="nofollow">http://localhost:8000/</a>，服务消费者已经成功显示到监控列表中，如下：</p> 
<p><img src="https://images2.imgbox.com/1a/89/oCCtLeEb_o.png" alt="在这里插入图片描述"></p> 
<p>反复访问<a href="http://localhost:8005/discover" rel="nofollow">http://localhost:8005/discover</a>，结果交替返回服务8003和8004，因为默认负载均衡器采用轮询方式，如下所示。8003和8004两个服务交替出现，从而实现了获取服务端地址的均衡负载：</p> 
<p><img src="https://images2.imgbox.com/65/f3/rUDtaAkJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7c/be/x7B8QcXv_o.png" alt="在这里插入图片描述"></p> 
<p>大多数情况下我们希望使用均衡负载的形式去获取服务端提供的服务，因此使用第二种方法来模拟调用服务端提供的hello方法，创建一个控制器CallHelloController。</p> 
<p>CallHelloController.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CallHelloController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadBalancerClient</span> loadBalancer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/call"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> loadBalancer<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">"mango-producer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务地址："</span> <span class="token operator">+</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"服务名称："</span> <span class="token operator">+</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> callServiceResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/hello"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>callServiceResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> callServiceResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>使用RestTemplate进行远程调用。添加完之后重启项目。在浏览器访问<a href="http://localhost:8005/call" rel="nofollow">http://localhost:8005/call</a>。依次往复返回的结果如下所示：</p> 
<p><img src="https://images2.imgbox.com/bb/b5/4GWNJoYV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2b/d2/BcpgL2u3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="1136_Ribbon_3400"></a>11.3.6 负载均衡器(Ribbon)</h5> 
<p>上面教程中，我们是这样调用服务的，先通过LoadBalancerClient选取出对应的服务，然后使用RestTemplate进行远程调用。</p> 
<p>LoadBalancerClient就是负载均衡器，RibbonLoadBalancerClient是Ribbon默认使用的负载均衡器，采用的负载均衡策略是轮询。</p> 
<ol><li> <p>查找服务，通过LoadBalancer查询服务</p> <pre><code class="prism language-java"><span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> loadBalancer<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">"mango-producer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>调用服务，通过RestTemplate远程调用服务</p> <pre><code class="prism language-java"><span class="token class-name">String</span> callServiceResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/hello"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li></ol> 
<p>这样就完成了一个简单的服务调用和负载均衡。接下来说说Ribbon。</p> 
<p>Ribbon是Netflix发布的负载均衡器，它有助于控制HTTP和TCP客户端的行为。为Ribbon配置服务提供者地址后，Ribbon就可基于某种负载均衡算法自动帮助服务消费者去请求。Ribbon默认为我们提供了很多负载均衡算法，例如轮询、随机等。当然我们也可为Ribbon实现自定义的负载均衡算法。</p> 
<p>Ribbon内置负载均衡策略可参考<a href="https://blog.csdn.net/weixin_30408309/article/details/94870464">https://blog.csdn.net/weixin_30408309/article/details/94870464</a>。</p> 
<h5><a id="1137__3424"></a>11.3.7 修改启动类</h5> 
<p>我们修改一个启动器类，注入RestTemplate，并添加@LoadBalanced注解(用于拦截请求)，以使用ribbon来进行负载均衡。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableFeignClients</span> 
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MangoConsumerApplication</span> <span class="token punctuation">{<!-- --></span>
   
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">MangoConsumerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1138__3446"></a>11.3.8 添加服务</h5> 
<p>新建一个控制器类注入RestTemplate并调用服务提供者的hello服务。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonHelloController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/ribbon/call"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 调用服务, service-producer为注册的服务名称，LoadBalancerInterceptor会拦截调用并根据服务名找到对应的服务</span>
        <span class="token class-name">String</span> callServiceResult <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://mango-producer/hello"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> callServiceResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1139__3466"></a>11.3.9 页面测试</h5> 
<p>启动消费者服务，访问<a href="http://localhost:8005/ribbon/call" rel="nofollow">http://localhost:8005/ribbon/call</a>，依次返回的结果同11.3.6.</p> 
<p>说明ribbon的负载均衡已经成功启动了。</p> 
<h5><a id="11310__3472"></a>11.3.10 负载策略</h5> 
<p>修改负载均衡策略很简单，只需要在配置文件指定对应的负载均衡器即可。</p> 
<h4><a id="114_Feign_3476"></a>11.4 服务消费(Feign)</h4> 
<p>Spring Cloud Feign是一套基于Netflix Feign实现的声明式服务调用客户端，使编写Web服务客户端变得更加简单。我们只需要通过创建接口并用注解来配置它即可完成对Web服务接口的绑定。它具有可插拔的注解支持，包括Feign注解、JAX-RS注解。它也支持可插拔的编码器和解码器。Spring Cloud Feign还扩展了对Spring MVC注解的支持，同时还整合了Ribbon来提供负载均衡的HTTP客户端实现。</p> 
<h5><a id="1141__3480"></a>11.4.1 添加依赖</h5> 
<p>修改mango-consumer的pom文件，添加feign依赖。</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--feign --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="1142__3492"></a>11.4.2 启动类</h5> 
<p>修改启动器类，添加@EnableFeignClients 注解，开启扫描Spring Cloud Feign客户端的功能。</p> 
<h5><a id="1143_Feign_3496"></a>11.4.3 添加Feign接口</h5> 
<p>添加MangoProducerService接口，在类头添加注解@FeignClient(name = “mango-producer”)，mango-producer是调用的服务名。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"mango-producer"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MangoProducerService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1144__3510"></a>11.4.4 添加控制器</h5> 
<p>添加FeignHelloController控制器，注入MangoProducerService，就可以像使用本地方法一样进行调用了。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignHelloController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MangoProducerService</span> mangoProducerService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/feign/call"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 像调用本地服务一样</span>
        <span class="token keyword">return</span> mangoProducerService<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1145__3530"></a>11.4.5 页面测试</h5> 
<p>启动成功之后访问<a href="http://localhost:8005/feign/call" rel="nofollow">http://localhost:8005/feign/call</a>，发现调用成功，且依次往复返回的结果同上。</p> 
<p>Feign是声明式调用，会产生一些相关的Feign定义接口，所以建议将Feign定义的接口都统一放置管理，以区别内部服务。</p> 
<h3><a id="12_HystrixTurbine_3536"></a>12. 服务熔断(Hystrix、Turbine)</h3> 
<h4><a id="121__3538"></a>12.1 雪崩效应</h4> 
<p>在微服务架构中，服务众多，通常会涉及多个服务层级的调用，一旦基础服务发生故障，很可能会导致级联故障，进而造成整个系统不可用，这种现象被称为服务雪崩效应。服务雪崩效应是一种因"服务提供者"的不可用导致"服务消费者"的不可用并将这种不可用逐渐放大的过程。</p> 
<p>比如在一个系统中，A是服务提供者，B是A的服务消费者，C和D又是B的服务消费者。如果此时A发生故障，则会引起B的不可用，而B的不可用又将导致C和D的不可用，当这种不可用像滚雪球一样逐渐放大的时候，雪崩效应就形成了。(感觉和数据库的多米诺效应一个道理)</p> 
<h4><a id="122_CircuitBreaker_3544"></a>12.2 熔断器(CircuitBreaker)</h4> 
<p>熔断器的原理非常简单，如同电力过载保护器。它可以实现快速失败，如果它在一段时间内侦测到许多类似的错误，就会强迫其以后的多个调用快速失败，不再访问远程服务器，从而防止应用程序不断地尝试执行可能会失败的操作，使得应用程序继续执行而不用等待修正错误，或者浪费CPU时间去等到长时间的超时产生。熔断器也可以使应用程序能够诊断错误是否已经修正，如果已经修正，应用程序会再次尝试调用操作。熔断器模式就像是那些容易导致错误操作的一种代理。这种代理能够记录最近调用发生错误的次数，然后决定使用允许操作继续，或者立即返回错误。熔断器是保护服务高可用的最后一道防线。</p> 
<h4><a id="123_Hystrix_3548"></a>12.3 Hystrix特性</h4> 
<h5><a id="1231__3550"></a>12.3.1 断路器机制%</h5> 
<p>断路器很好理解，当Hystrix Command请求后端服务失败数量超过一定比例(默认为50%)。断路器会切换到开路状态(open)。这时所有请求会直接失败而不会发送到后端服务。断路器保持在开路状态一段时间后(默认为5s)，自动切换到半开路状态(HALF-OPEN).这时会判断下一次请求的返回情况，如果请求成功，断路器切回闭路状态(CLOSED)，否则重新切换为开路状态(OPEN)。Hystrix的断路器就像我们家庭电路中的保险丝，一旦后端服务不可用，断路器就会直接切断请求链，避免发送大量无效请求，从而影响系统吞吐量，并且断路器有自我检测并恢复的能力。</p> 
<h5><a id="1232_fallback_3554"></a>12.3.2 fallback</h5> 
<p>fallback相当于降级操作。对于查询操作，我们可以实现一个fallback方法，当请求后端服务出现异常的时候，可以使用fallback方法返回的值。fallback返回的值一般是设置的默认值或来自缓存。</p> 
<h5><a id="1233__3558"></a>12.3.3 资源隔离</h5> 
<p>在Hystrix中，主要通过线程池来实现资源隔离。通常在使用的时候我们会根据调用的远程服务划分出多个线程池。例如，调用产品服务的Command放入A线程池，调用账户服务的Command放入B线程池。这样做的优点是运行环境被隔离开了。这样就算调用服务的代码存在bug或者由于其他原因导致自己所在线程池被耗尽，也不会对系统的其他服务造成影响，但是带来的代价是维护多个线程池会对系统带来额外的性能开销。如果是对性能有严格要求且确信自己调用服务的客户端代码不会出问题，就可以使用Hystrix的信号模式(Semaphores)来隔离资源。</p> 
<h4><a id="124_Feign_Hystrix_3562"></a>12.4 Feign Hystrix</h4> 
<p>因为Feign中已经依赖了Hystrix，所以在maven配置上不用做任何改动就可以使用了，我们可以在mango-consumer项目中直接改造。</p> 
<h5><a id="1241__3566"></a>12.4.1 修改配置</h5> 
<p>在配置文件中添加配置，开启Hystrix熔断器。</p> 
<p>application.yml:</p> 
<pre><code class="prism language-yml"><span class="token comment">#开启熔断器</span>
<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<h5><a id="1242__3579"></a>12.4.2 创建回调类</h5> 
<p>创建一个回调类MangoProducerHystrix，实现MangoProducerService接口，并实现对应的方法，返回调用失败后的信息。</p> 
<p>MangoProducerHystrix.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MangoProducerHystrix</span> <span class="token keyword">implements</span> <span class="token class-name">MangoProducerService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> <span class="token string">"sorry, hello service call failed."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>添加fallback属性。修改MangoProducerService，在@FeignClient注解中加入fallback属性，绑定我们创建的失败回调处理类。</p> 
<p>MangoProducerService.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"mango-producer"</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">MangoProducerHystrix</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MangoProducerService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>到此，所有改动代码就完成了。</p> 
<h5><a id="1243__3612"></a>12.4.3 页面测试</h5> 
<p>启动成功之后，多次访问<a href="http://localhost:8005/feign/call" rel="nofollow">http://localhost:8005/feign/call</a>，结果如同之前一样交替返回"hello mango!“和"hello mango 2!”，说明熔断器的启动不会影响正常服务访问。</p> 
<p>把mango-producer服务停掉，再次访问，返回我们提供的熔断回调信息，熔断成功，mango-producer2服务正常.</p> 
<p><img src="https://images2.imgbox.com/6a/b2/Sf2tyepJ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b6/5e/A4mT6zpQ_o.png" alt="在这里插入图片描述"></p> 
<p>重启mango-producer服务，再次访问发现服务又可以访问了，说明熔断器有自我诊断修复的功能。</p> 
<p>注：在重启成功之后可能需要一些时间，等待熔断器进行自我诊断和修复完成之后，方可正常提供服务。</p> 
<h4><a id="125_Hystrix_Dashboard_3626"></a>12.5 Hystrix Dashboard</h4> 
<p>Hystrix-Dashboard是一款针对Hystrix进行实时监控的工具，通过Hystrix Dashboard我们可以直观地看到各Hystrix Command的请求响应时间、请求成功率等数据。</p> 
<h5><a id="1251__3630"></a>12.5.1 添加依赖</h5> 
<p>新建一个mango-hystrix工程，修改pom文件，添加相关依赖。</p> 
<p>pom.xml:</p> 
<pre><code class="prism language-xml"> <span class="token comment">&lt;!-- spring boot --&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--consul--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--actuator--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--spring-boot-admin--&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.codecentric<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-admin-starter-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.boot.admin.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--hystrix-dashboard--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>Spring Cloud依赖:</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--srping cloud--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="1252__3682"></a>12.5.2 启动类</h5> 
<p>在启动类中添加注解@EnableHystrixDashboard，开启熔断监控支持。</p> 
<h5><a id="1253_Banner_3686"></a>12.5.3 自定义Banner</h5> 
<p>同上。</p> 
<h5><a id="1254__3690"></a>12.5.4 配置文件</h5> 
<p>修改配置文件，把服务注册到注册中心。</p> 
<p>application.yml:</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8501</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>hystrix
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
<span class="token key atrule">turbine</span><span class="token punctuation">:</span>
  <span class="token key atrule">instanceUrlSuffix</span><span class="token punctuation">:</span> hystrix.stream    <span class="token comment"># 指定收集路径</span>
  <span class="token key atrule">appConfig</span><span class="token punctuation">:</span> kitty<span class="token punctuation">-</span>consumer    <span class="token comment"># 指定了需要收集监控信息的服务名，多个以“,”进行区分</span>
  <span class="token key atrule">clusterNameExpression</span><span class="token punctuation">:</span> <span class="token string">"'default'"</span>    <span class="token comment"># 指定集群名称,若为default则为默认集群，多个集群则通过此配置区分</span>
  <span class="token key atrule">combine-host-port</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># 此配置默认为false，则服务是以host进行区分，若设置为true则以host+port进行区分</span>
</code></pre> 
<h5><a id="1255__3715"></a>12.5.5 配置监控路径</h5> 
<p>注意，如果使用的是2.x等版本，就需要在Hystrix的消费端配置监控路径。打开消费端mango-consumer工程添加依赖。</p> 
<p>pom.xml:</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--actuator--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--hystrix-dashboard--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>修改启动类，添加服务监控路径配置。</p> 
<p>MangoConsumerApplication.java:</p> 
<pre><code class="prism language-java"><span class="token comment">// 此配置是为了服务监控而配置，与服务容错本身无关，</span>
<span class="token comment">// ServletRegistrationBean因为springboot的默认路径不是"/hystrix.stream"，</span>
<span class="token comment">// 只要在自己的项目里配置上下面的servlet就可以了</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ServletRegistrationBean</span> <span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token class-name">HystrixMetricsStreamServlet</span> streamServlet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixMetricsStreamServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">ServletRegistrationBean</span> registrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token punctuation">(</span>streamServlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
   registrationBean<span class="token punctuation">.</span><span class="token function">setLoadOnStartup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   registrationBean<span class="token punctuation">.</span><span class="token function">addUrlMappings</span><span class="token punctuation">(</span><span class="token string">"/hystrix.stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   registrationBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"HystrixMetricsStreamServlet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> registrationBean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="1256__3753"></a>12.5.6 页面测试</h5> 
<p>先后启动monitor、producer、consumer、hystrix等服务，访问<a href="http://localhost:8501/hystrix" rel="nofollow">http://localhost:8501/hystrix</a>会看到如下界面：</p> 
<p><img src="https://images2.imgbox.com/16/ea/6eQG6YiM_o.png" alt="在这里插入图片描述"></p> 
<p>此时没有任何具体的监控信息，需要输入要监控的消费者地址及监控信息的轮询时间和标题。</p> 
<p>Hystrix Dashboard共支持以下三种不同的监控方式：</p> 
<ul><li>单体Hystrix消费者:通过URL http://hystrix-app:port/hystrix.stream开启，实现对具体某个服务实例的监控。</li><li>默认集群监控:通过URL http://turbine-hostname:port/turbine.stream开启，实现对默认集群的监控。</li><li>自定集群监控:通过URL http://turbine-hostname:port/turbine.stream?cluster=[clusterName]开启，实现对clusterName集群的监控。</li></ul> 
<p>这里先介绍对单体Hystrix消费者的监控，后面整个Turbine集群的时候再说明后两种监控方式。</p> 
<p>首先访问<a href="http://localhost:8005/feign/call" rel="nofollow">http://localhost:8005/feign/call</a>，查看要监控的服务是否可以正常访问。</p> 
<p>确认服务可以正常访问之后，在监控地址内输入<a href="http://localhost:8005/hystrix.stream" rel="nofollow">http://localhost:8005/hystrix.stream</a>，然后单击Monitor Stream开始监控，如下所示：</p> 
<p><img src="https://images2.imgbox.com/19/e6/CW2cWVhg_o.png" alt="在这里插入图片描述"></p> 
<p>刚进去页面先显示loading…信息，在多次间断访问<a href="http://localhost:8005/hystrix.stream" rel="nofollow">http://localhost:8005/hystrix.stream</a>之后统计图表信息如下：</p> 
<p><img src="https://images2.imgbox.com/0d/0b/rXRNSNVX_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="126_Spring_Cloud_Turbine_3782"></a>12.6 Spring Cloud Turbine</h4> 
<p>上面我们集成了Hystrix Dashboard，使用Hystrix Dashboard可以看到单个应用内的服务信息。显然这是不够的，我们还需要一个工具能让我们汇总系统内多个服务的数据并显示到Hystrix Dashboard上，这个工具就是Turbine。</p> 
<h5><a id="1261__3786"></a>12.6.1 添加依赖</h5> 
<p>修改mango-hystrix的pom文件，添加turbine依赖包(因为我们使用的注册中心是consul，所以需要排除默认的euraka包，不然会出现冲突，导致启动过程出错)</p> 
<p>pom.xml:</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--turbine--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-turbine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>  
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>     
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>  
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="1262__3806"></a>12.6.2 启动类</h5> 
<p>为启动类添加@EnableTurbine注解，开启Turbine支持。</p> 
<h5><a id="1263__3810"></a>12.6.3 配置文件</h5> 
<p>修改配置文件，添加Turbine的配置信息。</p> 
<p>application.yml:</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8501</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>hystrix
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
<span class="token key atrule">turbine</span><span class="token punctuation">:</span>
  <span class="token key atrule">instanceUrlSuffix</span><span class="token punctuation">:</span> hystrix.stream    <span class="token comment"># 指定收集路径</span>
  <span class="token key atrule">appConfig</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>consumer    <span class="token comment"># 指定了需要收集监控信息的服务名，多个以“,”进行区分</span>
  <span class="token key atrule">clusterNameExpression</span><span class="token punctuation">:</span> <span class="token string">"'default'"</span>    <span class="token comment"># 指定集群名称,若为default则为默认集群，多个集群则通过此配置区分</span>
  <span class="token key atrule">combine-host-port</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># 此配置默认为false，则服务是以host进行区分，若设置为true则以host+port进行区分</span>
</code></pre> 
<h5><a id="1264__3835"></a>12.6.4 测试效果</h5> 
<p>依次启动monitor、producer、consumer、hystrix等服务，确认服务启动无误后访问http://localhost:8501/hystrix/，输入<a href="http://localhost:8501/turbine.stream" rel="nofollow">http://localhost:8501/turbine.stream</a>，查看熔断监控图表信息，下图就是利用Turbine集合多个Hystrix消费者的熔断监控信息结果：</p> 
<p><img src="https://images2.imgbox.com/b3/41/rnmKWEep_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="13_Zuul_3842"></a>13. 服务网关(Zuul)</h3> 
<h4><a id="131__3844"></a>13.1 技术背景</h4> 
<p>前面我们通过Ribbon或Feign实现了微服务之间的调用和负载均衡，那我们的各种微服务又要如何提供给外部应用调用呢？</p> 
<p>因为是REST API接口，所以外部客户端直接调用各个微服务是没有问题的，但是出于种种原因，这并不是一个好的选择。</p> 
<p>让客户端直接与各个微服务通信，会有以下几个问题：</p> 
<ul><li>客户端会多次请求不同的微服务，增加客户端的复杂性。</li><li>存在跨域请求，在一定场景下处理会变得相对比较复杂。</li><li>实现认证复杂，每个微服务都需要独立认证。</li><li>难以重构，项目迭代可能导致微服务重新划分。如果客户端直接与微服务通信，那么重构将会很难实施。</li><li>如果某些微服务使用的防火墙/浏览器不友好的协议，直接访问会有一定困难。</li><li>面对类似上面的问题，解决方案就是服务网关。</li></ul> 
<p>使用服务网关有以下几个优点：</p> 
<ul><li>易于监控。可在微服务网关收集监控数据并将其推送到外部系统进行分析。</li><li>易于认证。可在服务网关上进行认证，然后转发请求到微服务，无须在每个微服务中进行认证。</li><li>客户端只和服务网关打交道，减少了客户端与各个微服务之间的交互次数。</li><li>多渠道支持。可根据不同客户端(Web端、移动端、桌面端)提供不同的API服务网关。</li></ul> 
<h4><a id="132_Spring_Cloud_Zuul_3866"></a>13.2 Spring Cloud Zuul</h4> 
<p>服务网关是微服务架构中一个不可或缺的部分。在通过服务网关统一向外系统提供REST API的过程中，除了具备服务路由、均衡负载功能之外，它还具备了权限控制等功能。</p> 
<p>Spring Cloud Netflix中的Zuul就担任了这一角色，为微服务架构提供了前门保护的作用，同时将权限控制这些较重的非业务逻辑内容迁移到服务路由层面，使得服务集群主题能够具备更高的可复用性和可测试性。</p> 
<p>在Spring Cloud体系中，Spring Cloud Zuul封装了Zuul组件，作为一个API网关，负责提供负载均衡、反向代理和权限认证。</p> 
<h4><a id="133_Zuul_3874"></a>13.3 Zuul工作机制</h4> 
<h5><a id="1331__3876"></a>13.3.1 过滤器机制</h5> 
<p>Zuul的核心是一系列的filters，其作用类似Servlet框架中的Filter，Zuul把客户端请求路由到业务处理逻辑的过程中，这些filter在路由的特定时期参与了一些过滤处理，比如实现鉴权、流量转发、请求统计等功能。Zuul的整个运行机制如下：</p> 
<p><img src="https://images2.imgbox.com/11/63/7vlV1qcw_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="1332__3883"></a>13.3.2 过滤器的生命周期</h5> 
<p>Filter的生命周期有四个，分别是"PRE" “ROUTING” “POST” “ERROR”，整个声明周期可以用下图形容：</p> 
<p><img src="https://images2.imgbox.com/a1/82/ejCrZkUG_o.png" alt="在这里插入图片描述"></p> 
<p>基于Zuul的这些过滤器可以实现各种丰富的功能，而这些过滤器类型则对应于请求的典型生命周期。</p> 
<ul><li>PRE：这种过滤器在请求被路由之前调用。我们可利用这种过滤器实现身份验证、在集群中选择请求的微服务、记录调试信息等。</li><li>ROUTING：这种过滤器将请求路由到微服务。这种过滤器用于构建发送给微服务的请求，并使用Apache HttpClient或Netflix Ribbon请求微服务。</li><li>POST：这种过滤器在路由到微服务以后执行。这种过滤器可用来为响应添加标准的HTTP Header、收集统计信息和指标、将响应从微服务发送给客户端等。</li><li>ERROR：在其他阶段发送错误时执行该过滤器。</li></ul> 
<p>除了默认的过滤器类型，Zuul还允许我们创建自定义的过滤器类型。例如我们可以定制一种STATIC类型的过滤器，直接在Zuul中生成响应，而不将请求转发到后端的微服务。</p> 
<p>Zuul默认实现了很多的Filter，如下表：</p> 
<table><thead><tr><th>类型</th><th>顺序</th><th>过滤器</th><th>功能</th></tr></thead><tbody><tr><td>pre</td><td>-3</td><td>ServletDetectionFilter</td><td>标记处理Servlet的类型</td></tr><tr><td>pre</td><td>-2</td><td>Servlet30WrapperFilter</td><td>包装HttpServletRequest请求</td></tr><tr><td>pre</td><td>-1</td><td>FormBodyWrapperFilter</td><td>包装请求体</td></tr><tr><td>route</td><td>1</td><td>DebugFilter</td><td>标记调试标志</td></tr><tr><td>route</td><td>5</td><td>PreDecorationFilter</td><td>处理请求上下文供后续使用</td></tr><tr><td>route</td><td>10</td><td>RibbonRoutingFilter</td><td>serviceId请求转发</td></tr><tr><td>route</td><td>100</td><td>SimpleHostRoutingFilter</td><td>url请求转发</td></tr><tr><td>route</td><td>500</td><td>SendForwardFilter</td><td>forward请求转发</td></tr><tr><td>post</td><td>0</td><td>SendErrorFilter</td><td>处理有错误的请求响应</td></tr><tr><td>post</td><td>1000</td><td>SendResponseFilter</td><td>处理正常的请求响应</td></tr></tbody></table> 
<h5><a id="1333_Filter_3969"></a>13.3.3 禁用指定的Filter</h5> 
<p>可以在application.yml中配置需要禁用的filter，格式为 zuul.&lt; SimpleClassName &gt;.&lt; filterType &gt;.disable=true。比如要禁用org.springframework.cloud.netflix.zuul.filters.post.SendResponseFilter，进行如下设置即可：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
	<span class="token key atrule">SendResponseFilter</span><span class="token punctuation">:</span>
		<span class="token key atrule">post</span><span class="token punctuation">:</span>
			<span class="token key atrule">disable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p>自定义filter。实现自定义过滤器需要继承ZuulFilter，并实现ZuulFilter中的抽象方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulFilter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"pre"</span><span class="token punctuation">;</span> <span class="token comment">// 定义filter的类型，有pre、route、post、error四种</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 定义filter的顺序，数字越小表示顺序越高，越先执行</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>	 <span class="token comment">// 表示是否需要执行该filter，true表示执行，false表示不执行</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>	<span class="token comment">//filter需要执行的具体操作</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="134__4007"></a>13.4 实现案例</h3> 
<h5><a id="1341__4009"></a>13.4.1 新建工程</h5> 
<p>新建一个项目mango-zuul作为服务网关</p> 
<h5><a id="1342__4013"></a>13.4.2 添加依赖</h5> 
<p>添加consul、zuul相关依赖。</p> 
<p>pom.xml:</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-zuul<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="1343__4044"></a>13.4.3 启动类</h5> 
<p>为启动类添加@EnableZuulProxy注解，开启服务网关支持。</p> 
<h5><a id="1344__4048"></a>13.4.4 配置文件</h5> 
<p>配置启动端口为8010，注册服务到注册中心，配置Zuul转发规则。这里配置在返回<a href="http://localhost:8010/feign/call" rel="nofollow">http://localhost:8010/feign/call</a>和<a href="http://localhost:8010/ribbon/call" rel="nofollow">http://localhost:8010/ribbon/call</a>时调用消费者相关接口。</p> 
<p>application.yml：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8010</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>zuul
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
<span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /ribbon/<span class="token important">**</span>
      <span class="token key atrule">serviceId</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>consumer  <span class="token comment"># 转发到消费者 /ribbon/</span>
    <span class="token key atrule">feign</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /feign/<span class="token important">**</span>
      <span class="token key atrule">serviceId</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>consumer  <span class="token comment"># 转发到消费者 /feign/</span>
</code></pre> 
<h5><a id="1345__4076"></a>13.4.5 页面测试</h5> 
<p>依次启动注册中心、监控、服务提供者、服务消费者、服务网关等项目。</p> 
<p>访问<a href="http://localhost:8010/feign/call" rel="nofollow">http://localhost:8010/feign/call</a>和<a href="http://localhost:8010/ribbon/call" rel="nofollow">http://localhost:8010/ribbon/call</a>，效果如下：</p> 
<p><img src="https://images2.imgbox.com/5d/4e/CibyCN05_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9f/b8/QOc5jU40_o.png" alt="在这里插入图片描述"></p> 
<p>说明Zuul已经成功转发请求，并成功调用后端服务。</p> 
<h5><a id="1346__4088"></a>13.4.6 配置接口前缀</h5> 
<p>如果想给每个服务的API接口加上一个前缀，可使用zuul.prefix进行配置。例如<a href="http://localhost:8010/v1/feign/call" rel="nofollow">http://localhost:8010/v1/feign/call</a>,即在所有的API接口上加一个v1作为版本号。</p> 
<pre><code class="prism language-yml"><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /v1
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /ribbon/<span class="token important">**</span>
      <span class="token key atrule">serviceId</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>consumer  <span class="token comment"># 转发到消费者 /ribbon/</span>
    <span class="token key atrule">feign</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /feign/<span class="token important">**</span>
      <span class="token key atrule">serviceId</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>consumer  <span class="token comment"># 转发到消费者 /feign/</span>
</code></pre> 
<h5><a id="1347__4104"></a>13.4.7 默认路由规则</h5> 
<p>上面我们通过添加路由配置进行请求转发。</p> 
<p>但是如果后端服务非常多，每一个都这样配置挺麻烦的。Spring Cloud Zuul已经帮我们做了默认配置。默认情况下，Zuul会代理所有注册到注册中心的微服务，并且Zuul的默认路由规则如下:http://ZUUL_HOST:ZUUL_PORT/微服务注册中心的serviceId/**会被转发到serviceId对应的微服务。如果遵循默认路由规则，基本上就没什么配置了。</p> 
<p>比如我们直接通过serviceId/feign/call的方式访问也是可以正常访问的。访问<a href="http://localhost:8010/mango-consumer/feign/call" rel="nofollow">http://localhost:8010/mango-consumer/feign/call</a>,结果也是一样的。</p> 
<h5><a id="1348__4112"></a>13.4.8 路由熔断</h5> 
<p>Zuul作为Netflix的组件，可以与Ribbon、Eureka和Hystrix等组件相结合，实现负载均衡、熔断器的功能。默认情况下Zuul和Ribbon相结合，实现了负载均衡。实现熔断器功能需求实现FallbackProvider接口。实现该接口有两个方法，一个是getRoute()，用于指定熔断器功能应用于哪些路由的服务；另一个方法是fallbackResponse()，为进入熔断器功能时执行的逻辑。</p> 
<p>创建MyFallbackProvider类，getRoute()方法返回"mango-consumer"，只针对consumer服务进行熔断。如果需要所有的路由服务都加熔断功能，需要在getRoute()上返回"*“匹配符。getBody()方法返回发送熔断时的反馈信息，这里在发送熔断时返回信息"Sorry, the service is unavailable now.”。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFallbackProvider</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackProvider</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"mango-consumer"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">fallbackResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> route<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"route:"</span><span class="token operator">+</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"exception:"</span><span class="token operator">+</span>cause<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClientHttpResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">HttpStatus</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token number">200</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getStatusText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">InputStream</span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span><span class="token string">"Sorry, the service is unavailable now."</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">HttpHeaders</span> <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                headers<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> headers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>重新启动，访问<a href="http://localhost:8010/mango-consumer/feign/call" rel="nofollow">http://localhost:8010/mango-consumer/feign/call</a>，可以正常访问。停掉mango-consumer服务，f昂问<a href="http://localhost:8010/mango-consumer/feign/call" rel="nofollow">http://localhost:8010/mango-consumer/feign/call</a>，返回效果如下：</p> 
<p><img src="https://images2.imgbox.com/0d/83/Ca3xhHf7_o.png" alt="在这里插入图片描述"></p> 
<p>结果返回了我们自定义的信息，说明我们自定义的熔断器起作用了。</p> 
<h5><a id="1349_Filter_4174"></a>13.4.9 自定义Filter</h5> 
<p>创建一个MyFilter，继承ZuulFilter类，覆写run()逻辑，在转发请求之前进行token认证，如果请求没有携带token，返回"there is no request token"提示。</p> 
<p>MyFilter.java:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulFilter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> log<span class="token operator">=</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MyFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"pre"</span><span class="token punctuation">;</span> <span class="token comment">// 定义filter的类型，有pre、route、post、error四种</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 定义filter的顺序，数字越小表示顺序越高，越先执行</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 表示是否需要执行该filter，true表示执行，false表示不执行</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// filter需要执行的具体操作</span>
        <span class="token class-name">RequestContext</span> ctx <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>token<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"there is no request token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">setSendZuulResponse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">setResponseStatusCode</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                ctx<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"there is no request token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样，Zuul就会自动加载Filter执行过滤了。重新启动Zuul项目，访问<a href="http://localhost:8010/mango-consumer/feign/call" rel="nofollow">http://localhost:8010/mango-consumer/feign/call</a>，结果如下所示：</p> 
<p><img src="https://images2.imgbox.com/87/9b/wciEm8tn_o.png" alt="在这里插入图片描述"></p> 
<p>请求时带上token，访问<a href="http://localhost:8010/mango-consumer/feign/call?token=115" rel="nofollow">http://localhost:8010/mango-consumer/feign/call?token=115</a>，接口返回正确结果，如下所示：</p> 
<p><img src="https://images2.imgbox.com/c4/7b/xaugnYIY_o.png" alt="在这里插入图片描述"></p> 
<p>Zuul作为API服务网关，不同的客户端使用不同的负载将请求统一分发到后端的Zuul，再由Zuul转发到后端服务。为了保证Zuul的高可用性，前端可以同时开启多个Zuul实例进行负载均衡。另外，在Zuul的前端还可以使用Nginx或者F5再进进行负载转发，从而保证Zuul的高可用性。</p> 
<h3><a id="14_SleuthZipkin_4237"></a>14. 链路追踪(Sleuth、Zipkin)</h3> 
<h4><a id="141__4239"></a>14.1 技术背景</h4> 
<p>在微服务架构中，随着业务发展，系统拆分导致系统调用链路愈发复杂，一个看似简单的前端请求可能最终需要调用很多次后端服务才能完成，那么当整个请求出现问题时，我们很难得知到底是哪个服务出了问题导致的，这时就需要解决一个问题，即如何快速定位服务故障点，分布式系统调用链追踪技术就此诞生了。</p> 
<h4><a id="142_ZipKin_4243"></a>14.2 ZipKin</h4> 
<p>ZipKin是一个由Twitter公司提供并开放源代码分布式的跟踪系统。，它可以帮助收集服务的时间数据，以解决微服务架构中的延迟问题，包括数据的收集、存储、查找和展现。</p> 
<p>每个服务向ZipKin报告定时数据，ZipKin会根据调用关系通过ZipKin UI生成依赖关系图，展示多少追踪请求经过了哪些服务，该系统让开发者可通过一个Web前端轻轻松松收集和分析数据，例如用户每次请求服务的处理时间等，可非常方便地监测系统中存在的瓶颈。</p> 
<p>ZipKin提供了可插拔数据存储方式:In-Memory、MySQL、Cassandra、以及Elasticsearch。我们可以根据需求选择不同的存储方式，生成环境一般都需要持久化。我们这里采用Elasticsearch作为ZipKin的数据存储器。</p> 
<h4><a id="143_Spring_Cloud_Sleuth_4251"></a>14.3 Spring Cloud Sleuth</h4> 
<p>一般而言，一个分布式服务追踪系统，主要由三部分组成：数据收集、数据存储和数据展示。</p> 
<p>Spring Cloud Sleuth为服务之间的调用提供链路追踪，通过Sleuth可以很清楚地了解到一个服务请求经过了哪些服务，每个服务处理花费了多少时间，从而让我们可以很方便地理清各微服务之间的调用关系，此外，Sleuth还可以帮助我们:</p> 
<ul><li>耗时分析：通过Sleuth可以很方便地了解到每个采样请求的耗时，从而分析出哪些服务调用比较耗时。</li><li>可视化错误：对于程序未捕捉的异常，可以通过集成ZipKin服务在界面上看到。</li><li>链路优化：对于调用比较频繁的服务，可以针对这些服务实施一些优化措施。</li></ul> 
<p>Spring Cloud Sleuth可以结合ZipKin，将信息发送到ZipKin，利用ZipKin的存储来存储信息，利用ZipKin UI来展示数据。</p> 
<h4><a id="144__4263"></a>14.4 实现案例</h4> 
<p>在早前的Spring Cloud版本里是需要自建ZipKin服务端的，但是从Spring Cloud 2.0以后，官方已经不支持自建Server了，改成提供编译好的jar包供用户使用。这里我们使用Docker方式部署ZipKin服务，并采用Elasticsearch作为ZipKin的数据存储器。</p> 
<h5><a id="1441__4267"></a>14.4.1 下载镜像</h5> 
<p>此前先安装好Dockers环境(安装环境用了小半天，一直出问题一直出问题)。</p> 
<ul><li>首先在阿里云镜像下载Docker Desktop Installer：<a href="http://mirrors.aliyun.com/docker-toolbox/windows/docker-for-windows/stable/" rel="nofollow">http://mirrors.aliyun.com/docker-toolbox/windows/docker-for-windows/stable/</a></li><li>下载后参考该篇<a href="https://blog.csdn.net/lanxingxing666666/article/details/111354089">https://blog.csdn.net/lanxingxing666666/article/details/111354089</a>，在Win10中添加Hyper-v(本来就有的话跳过)</li><li>这样完了下载好Docker Desktop后打开应该是会报错的，此时再参考该篇<a href="https://blog.csdn.net/xiewensui8810/article/details/115679237">https://blog.csdn.net/xiewensui8810/article/details/115679237</a>。</li></ul> 
<p>(我不李姐，为什么，现在看好像就这几步就行的事，我怎么搞了那么久，甚至创建了虚拟机想在Linux系统上试试，结果试试就逝世，白浪费了时间。都是题外话了)</p> 
<p>使用以下命令分别拉取ZipKin和Elasticsearch镜像。</p> 
<pre><code>docker pull openzipkin/zipkin
docker pull docker.elastic.co/elasticsearch/elasticsearch:6.3.0
</code></pre> 
<p>拉取镜像的过程及其十分非常缓慢，甚至还可能报错，再下载一次应该可能大概就行吧。</p> 
<p><img src="https://images2.imgbox.com/c7/95/oT5P906y_o.png" alt="在这里插入图片描述"></p> 
<p>通过docker images查看下载镜像，如下所示：</p> 
<p><img src="https://images2.imgbox.com/0f/d0/PNjXncgD_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="1442__4294"></a>14.4.2 编写启动文件</h5> 
<p>到这里就失败了，多次尝试未果，遂放弃。</p> 
<h3><a id="14_4298"></a>14参考</h3> 
<p><u><strong>对于链路追踪参考<a href="https://blog.csdn.net/qq_40587263/article/details/117338097">https://blog.csdn.net/qq_40587263/article/details/117338097</a>。</strong></u></p> 
<p>经测试发现可行。</p> 
<h3><a id="15_ConfigBus_4306"></a>15. 配置中心(Config、Bus)</h3> 
<h4><a id="151__4308"></a>15.1 技术背景</h4> 
<p>如今微服务架构盛行，在分布式系统中，项目日益庞大，子项目日益增多，每个项目都散落着各种配置文件，且随着服务的增加而不断增多。此时，往往某一个基础服务信息变更都会导致一系列服务的更新与重启，运维也是苦不堪言，而且很容易出错。配置中心便由此应运而生。</p> 
<p>目前市面上开源的配置中心很多，像Spring家族的Spring Cloud Config、Apache的Apache Commons Configuration、淘宝的diamond、百度的disconf、360的QConf等，都是为了解决这类问题。</p> 
<h4><a id="152_Spring_Cloud_Config_4314"></a>15.2 Spring Cloud Config</h4> 
<p>Spring Cloud Config 是一套为分布式系统中的基础设施和微服务应用提供集中化配置的管理方案，分为服务端和客户端两个部分。服务端也称为分布式配置中心，是一个独立的微服务应用，用来连接配置仓库并为客户端提供获取配置信息。客户端是微服务架构中的各个微服务应用或基础设施，它们通过指定的配置中心来管理服务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息。</p> 
<p>Spring Cloud Config对服务端和客户端中的环境变量和属性配置实现了抽象映射，所以除了适用于Spring应用，也是可以在任何其他语言应用中使用的。Spring Cloud Config实现的配置中心默认采用Git来存储配置信息，所以使用Spring Cloud Config构建的配置服务器天然就支持对微服务应用配置信息的版本管理，并且可以通过Git客户端工具非常方便地管理和访问配置内容。当然它也提供了对其他存储方式的支持，比如SVN仓库、本地化文件系统等。</p> 
<h4><a id="153__4320"></a>15.3 实现案例</h4> 
<h5><a id="1531__4322"></a>15.3.1 准备配置文件</h5> 
<p>首先在Git下新建一个config-repo目录，用来存放配置文件，如下所示，这里分别模拟了三个环境的配置文件，分别编辑三个文件，配置hello属性的值为"consumer.hello=hello, xx configurations"。</p> 
<p><img src="https://images2.imgbox.com/11/57/YTmTQQZA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4c/57/kjdc5wwf_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="1532__4330"></a>15.3.2 服务端实现</h5> 
<ol><li> <p>新建工程</p> <p>新建mango-config工程，作为配置中心的服务端，负责把git仓库的配置文件发布为RESTFul接口。</p> </li><li> <p>添加依赖</p> <p>除了Spring Cloud依赖外，另需添加配置中心依赖包。</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>启动类</p> <p>启动类添加注解@EnableConfigServer。</p> </li><li> <p>配置文件</p> <p>修改配置文件，添加如下内容。如果是私有仓库，需要填写用户名、密码，如果是公有仓库可以不配置密码。</p> <pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8020</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>config
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master  <span class="token comment"># git仓库分支</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//gitee.com/lhtyw/config<span class="token punctuation">-</span>repo.git  <span class="token comment"># 配置git仓库的地址</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span> src/config<span class="token punctuation">-</span>repo  <span class="token comment"># git仓库地址下的相对地址，可以配置多个，用,分割。</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
</code></pre> <p>Spring Cloud Config也提供本地存储配置方式，只需设置属性spring.profiles.active=native，Config Server会默认从应用的src/main/resource目录下检索配置文件。另外也可以通过spring.cloud.config.server.native.searchLocations=file:D:/properties/属性来指定配置文件的位置。虽然Spring Cloud Config提供了这样的功能，但是为了更好的支持内容管理和版本控制，还是推荐使用GIT的方式。</p> </li><li> <p>页面测试</p> <p>启动注册中心，配置中心服务，访问<a href="http://localhost:8020/consumer/dev" rel="nofollow">http://localhost:8020/consumer/dev</a>，返回dev配置文件的信息：</p> </li></ol> 
<p><img src="https://images2.imgbox.com/a0/84/4XUL6vaF_o.png" alt="在这里插入图片描述"></p> 
<p>访问<a href="http://localhost:8020/consumer/pro" rel="nofollow">http://localhost:8020/consumer/pro</a>，返回pro配置文件的信息：</p> 
<p><img src="https://images2.imgbox.com/87/53/H2qGTxzu_o.png" alt="在这里插入图片描述"></p> 
<p>上述的返回信息包含了配置文件的位置、版本、配置文件的名称一以及配置文件的具体内容，说明server端已经成功获取了GIT仓库的配置信息。</p> 
<p>访问<a href="http://localhost:8020/consumer-dev.properties" rel="nofollow">http://localhost:8020/consumer-dev.properties</a>返回结果如下所示：</p> 
<p><img src="https://images2.imgbox.com/40/f3/FpPWhe1J_o.png" alt="在这里插入图片描述"></p> 
<p>将dev配置文件中的内容修改为"<strong>hello</strong>=hello, dev configurations2."重新访问<a href="http://localhost:8020/consumer-dev.properties" rel="nofollow">http://localhost:8020/consumer-dev.properties</a>，发现读取的是修改后提交的东西，说明服务端是会自动读取最新提交的数据。</p> 
<p>仓库中的配置文件会被转换成相应的Web接口，访问可参照以下规则：</p> 
<ul><li>/{application}/{profile}[/{label}]</li><li>/{application}-{profile}.yml</li><li>/{label}/{application}-{profile}.yml</li><li>/{application}-{profile}.properties</li><li>/{label}/{application}-{profile}.properties</li></ul> 
<p>以consumer-dev.properties为例，它的application是consumer、profile是dev。客户端会根据填写的参数来选择读取对应的配置。</p> 
<h5><a id="1533__4413"></a>15.3.3 客户端实现</h5> 
<ol><li> <p>添加依赖</p> <p>打开mango-consumer工程，添加相关依赖。</p> <pre><code class="prism language-xml"><span class="token comment">&lt;!-- spring-cloud-config --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li><li> <p>配置文件</p> <p>添加一个叫bookstrap.yml的配置文件，添加配置中心，并把注册中心的配置移到这里，因为在通过配置中心查找配置时需要通过注册中心的发现服务。</p> <p>bookstrap.yml：</p> <pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 开启服务发现</span>
        <span class="token key atrule">serviceId</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>config <span class="token comment"># 配置中心服务名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> consumer  <span class="token comment"># 对应{application}部分</span>
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev  <span class="token comment"># 对应{profile}部分</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master  <span class="token comment"># 对应git的分支，如果配置中心使用的是本地存储，则该参数无用</span>
</code></pre> <p>配置说明：</p> 
  <ul><li>spring.cloud.config.uri：配置中心的具体地址。</li><li>spring.cloud.config.name：对应{application}部分。</li><li>spring.cloud.config.profile：对应{profile}部分。</li><li>spring.cloud.config.label：对应git的分支。如果配置中心使用的是本地存储，则该参数无用。</li><li>spring.cloud.config.discovery.serviceId：指定配置中心的service-id,便于扩展为高可用的配置集群。</li></ul> <p>(上面这些与spring cloud有关的属性必须配置在bookstrap.yml中，这样config部分内容才能被正确加载，因为config的相关配置会先于application.yml，而bookstrap.yml的加载也是先于application.yml的)</p> <p>application.yml：</p> <pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8005</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>consumer
  <span class="token key atrule">boot</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">instance</span><span class="token punctuation">:</span>
          <span class="token key atrule">instance.service-base-url</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
  <span class="token key atrule">zipkin</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9411/
  <span class="token key atrule">sleuth</span><span class="token punctuation">:</span>
    <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
      <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#样本采集量，默认为0.1，为了测试这里修改为1，正式环境一般使用默认值</span>
<span class="token comment"># 开放健康检查接口</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">show-details</span><span class="token punctuation">:</span> ALWAYS
<span class="token comment">#开启熔断器</span>
<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> </li><li> <p>控制器</p> <p>添加一个SpringConfigController控制器，添加注解@Value("${hello}")，声明hello属性从配置文件中读取。</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">class</span> <span class="token class-name">SpringConfigController</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${hello}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> hello<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hello<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>页面测试</p> <p>启动注册中心、配置中心和服务消费者，访问<a href="http://localhost:8005/hello" rel="nofollow">http://localhost:8005/hello</a>，返回结果如下图：</p> </li></ol> 
<p><img src="https://images2.imgbox.com/74/45/EadvEo9t_o.png" alt="在这里插入图片描述"></p> 
<p>说明客户端已经成功从服务端获取了配置信息。</p> 
<p>手动修改一下仓库配置文件的内容，修改完成并提交。再次访问<a href="http://localhost:8005/hello" rel="nofollow">http://localhost:8005/hello</a>发现返回结果并没有读取最新提交的内容，这是因为springboot项目只有在启动的时候才会获取配置文件的内容，虽然GIT配置信息被修改了，但是客户端并未重新去获取，所以导致读取的信息仍然是旧配置。</p> 
<h5><a id="1534_Refresh_4522"></a>15.3.4 Refresh机制</h5> 
<p>Refresh机制是Spring Cloud Config提供的一种刷新机制，它允许客户端通过POST方法触发各自的/refresh，只要依赖spring-boot-starter-actuator包就拥有了/refresh的功能。下面我们为客户端添加刷新功能，以支持更新配置的获取。</p> 
<ol><li> <p>添加依赖</p> <p>添加actuator依赖。actuator是健康检查依赖包，依赖包里携带了/refresh功能。</p> <pre><code class="prism language-xml"><span class="token comment">&lt;!--actuator--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <p>在使用配置属性的类型中加上@RefreshScopezh蟹，这样在客户端执行/refresh的时候就会刷新此类下面的配置属性了。</p> </li><li> <p>修改配置</p> <p>健康检查接口开放需要在配置文件添加如下内容，开放Refresh的相关接口，因为之前已经配置过，所以无需添加。</p> <pre><code class="prism language-yml"><span class="token comment"># 开放健康检查接口</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">show-details</span><span class="token punctuation">:</span> ALWAYS
</code></pre> <p>通过上面的接口开放配置，以后以post请求的方式访问<a href="http://localhost:8005/actuator/refresh" rel="nofollow">http://localhost:8005/actuator/refresh</a>时就会更新修改后的配置文件了。</p> <pre><code>这里存在版本大坑，1.x和2.x的配置不太一样，我们用的是2.0+版本，务必注意：
	安全配置变更：新版本为management.endpoints.web.exposure.include="*"
	访问地址变更：新版本为http://localhost:8005/actuator/refresh，老版本为http://localhost:8005/refresh
</code></pre> <p>这里解释一下上面这个配置起到什么作用。actuator是一个健康检查包，提供了一些健康检查数据接口。Refresh功能是其中的一个接口，为了安全起见，默认只开放了health和info接口.而上面的配置就是设置要开放哪些接口，我们设置成"*"是开放所有接口。也可以指定开放几个，比如health、info、refresh，而这里因为我们需要用的是Refresh功能，所以需要把Refresh接口开放出来。</p> </li><li> <p>页面测试</p> <p>重新启动服务，访问<a href="http://localhost:8005/hello" rel="nofollow">http://localhost:8005/hello</a>，返回结果同上。</p> <p>修改仓库配置内容再次访问结果也没有更新。因为我们没有调用refresh方法，通过工具或自写代码发生post请求<a href="http://localhost:8005/actuator/refresh" rel="nofollow">http://localhost:8005/actuator/refresh</a>，刷新配置。<br> <img src="https://images2.imgbox.com/a0/80/SK7IcTew_o.png" alt="在这里插入图片描述"></p> <p>刷新后再次访问<a href="http://localhost:8005/hello" rel="nofollow">http://localhost:8005/hello</a>返回结果更新：</p> <p><img src="https://images2.imgbox.com/00/e9/at0D6sfI_o.png" alt="在这里插入图片描述"></p> <p>查看返回结果，刷新之后已经可以获取最新提交的配置内容，但是每次都需要手动刷新客户端还是很麻烦，如果客户端数量一多就简直难以忍受，一个好的解决方法就是Spring Cloud Bus。</p> </li></ol> 
<h5><a id="1535_Spring_Cloud_Bus_4582"></a>15.3.5 Spring Cloud Bus</h5> 
<p>Spring Cloud Bus称为消息总线，通过轻量级的消息代理来连接各个分布的节点，可以利用像消息队列的广播机制在分布式系统中进行消息传播。通过消息总线可以实现很多业务功能，其中对于配置中心客户端刷新就是一个非常典型的使用场景。</p> 
<p>消息总线作用流程如下：(图源：<a href="https://www.cnblogs.com/xifengxiaoma/p/9857110.html" rel="nofollow">https://www.cnblogs.com/xifengxiaoma/p/9857110.html</a>).</p> 
<p><img src="https://images2.imgbox.com/5c/7d/s9euUkCp_o.png" alt="在这里插入图片描述"></p> 
<p>Spring Cloud Bus进行配置更新的步骤如下：</p> 
<ul><li>提交代码触发post请求给/actuator/bus-refresh。</li><li>Server端接收到请求并发送给Spring Cloud Bus。</li><li>Spring Cloud Bus接到消息并通知给其他客户端。</li><li>其他客户端接收到通知，请求Server端获取最新配置。</li><li>全部客户端均获取到最新的配置。</li></ul> 
<ol><li> <p>安装RabbitMQ</p> <p>参考<a href="https://developer.aliyun.com/article/769883%20and%20https://blog.csdn.net/weixin_40822435/article/details/105738375">https://developer.aliyun.com/article/769883</a> and <a href="https://blog.csdn.net/weixin_40822435/article/details/105738375">https://blog.csdn.net/weixin_40822435/article/details/105738375</a>。</p> <p>用系统提供的默认账号登录后管理界面如下：(用户名密码皆为guest)</p> </li></ol> 
<p><img src="https://images2.imgbox.com/4d/6c/QZXYFusM_o.png" alt="在这里插入图片描述"></p> 
<ol start="2"><li> <p>客户端实现</p> <p>添加依赖，打开客户端mango-consumer添加消息总线相关依赖：</p> <pre><code class="prism language-xml"><span class="token comment">&lt;!-- bus-amqp --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <p>修改配置，添加RabbitMQ的相关配置，这样客户端代码就改造完成了。</p> <p>bookstrap.yml:</p> <pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 开启服务发现</span>
        <span class="token key atrule">serviceId</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>config <span class="token comment"># 配置中心服务名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> consumer  <span class="token comment"># 对应{application}部分</span>
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev  <span class="token comment"># 对应{profile}部分</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master  <span class="token comment"># 对应git的分支，如果配置中心使用的是本地存储，则该参数无用</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
</code></pre> </li><li> <p>服务端实现</p> <p>添加依赖，修改mango-config，添加相关依赖：</p> <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <p>修改配置，添加RabbitMQ和接口开放相关的配置，这样服务端代码就改造完成了。</p> <p>application.yml:</p> <pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8020</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mango<span class="token punctuation">-</span>config
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>    <span class="token comment"># 注册到consul的服务名称</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master  <span class="token comment"># git仓库分支</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//gitee.com/lhtyw/config<span class="token punctuation">-</span>repo.git  <span class="token comment"># 配置git仓库的地址</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span> src/config<span class="token punctuation">-</span>repo  <span class="token comment"># git仓库地址下的相对地址，可以配置多个，用,分割。</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">"*"</span>
</code></pre> </li><li> <p>页面测试</p> <p>启动服务端，成功集成消息总线后，启动信息可以看到如下所示信息：</p> </li></ol> 
<p><img src="https://images2.imgbox.com/50/6c/ozrJbYYM_o.png" alt="在这里插入图片描述"></p> 
<p>启动客户端。会报错，启动追踪代码发现下图中对应位置找不到相应的Bean.<br> <img src="https://images2.imgbox.com/6e/7c/YYfjnnqF_o.png" alt="在这里插入图片描述"></p> 
<p>在刷新的时候缺少一个拦截器，可以自己设置一个。加一个配置类，并在resources下新建一个META-INF目录和一个spring.factories文件，如下：</p> 
<p><img src="https://images2.imgbox.com/52/1e/RFOt3jLx_o.png" alt="在这里插入图片描述"></p> 
<p>RetryConfiguration.java:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RetryConfiguration</span> <span class="token punctuation">{<!-- --></span>
   
   <span class="token annotation punctuation">@Bean</span>
   <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"configServerRetryInterceptor"</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">RetryOperationsInterceptor</span> <span class="token function">configServerRetryInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token class-name">RetryInterceptorBuilder</span><span class="token punctuation">.</span><span class="token function">stateless</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">backOffOptions</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maxAttempts</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
<span class="token punctuation">}</span>
</code></pre> 
<p>spring.factories:</p> 
<pre><code class="prism language-factories">org.springframework.cloud.bootstrap.BootstrapConfiguration=com.louis.mango.consumer.RetryConfiguration
</code></pre> 
<p>指定新建的拦截器，这样系统初始化时就会加载这个Bean。然后重新启动就没有报错了。</p> 
<p><a href="http://localhost:8005/hello" rel="nofollow">http://localhost:8005/hello</a>，界面打印"hello, dev configurations."。</p> 
<p>修改仓库配置文件，修改完成提交。</p> 
<p><img src="https://images2.imgbox.com/c6/ba/qV64YLpp_o.png" alt="在这里插入图片描述"></p> 
<p>再次访问发现还是旧信息。</p> 
<p>用工具发送post请求：<a href="http://localhost:8020/actuator/bus-refresh" rel="nofollow">http://localhost:8020/actuator/bus-refresh</a>.</p> 
<p>这次是向注册中心服务端发送请求，发送成功之后服务端会通过消息总线通知所有的客户端进行刷新。另外，开启消息总线后的请求地址是/actuator/bus-refresh，不再是refresh了。</p> 
<p><img src="https://images2.imgbox.com/20/eb/pvmXlNWo_o.png" alt="在这里插入图片描述"></p> 
<p>给服务端发送刷新请求后，再次访问<a href="http://localhost:8005/hello" rel="nofollow">http://localhost:8005/hello</a>，结果如下：</p> 
<p><img src="https://images2.imgbox.com/4e/a7/VB8fYD7p_o.png" alt="在这里插入图片描述"></p> 
<p>最终，我们愉快地发现客户端已经能够通过消息总线获取最新配置了。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a6d3353feaed8d94e16939f3149e8d56/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【JQuery Mobile移动应用开发实战】JQuery Mobile基础——JQuery Mobile界面综合实战</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7e70ad003ec82907b592dfc07ed64ba7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Eclipse 调试 PHP 配置教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>