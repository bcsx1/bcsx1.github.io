<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ubuntu18.04 NX下用ZED2 双目立体相机进行SLAM - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ubuntu18.04 NX下用ZED2 双目立体相机进行SLAM" />
<meta property="og:description" content="NX下的ZED2开发 安装流程问题开始了看效果安装ZED2 ROS工具 新故事篇章-zed2测距开始实现 安装流程 了解zed参数
因为网上的安装流程还是不太完整，我补充一下,希望对其他人也有帮助
部分流程参考这位：博主
自己的安装流程:
因为NX本来就自带cuda,所以无需安装cuda,所以首先你要知道自己cuda
nvcc -V 可以看到我的版本是10.2
现在去下载 SDK
查看自己的jetpack 版本
jtop 可以看到我用的是jetpack 4.4.1版本
所以下载的是jetson jetpack 4.4 cuda10.2 的版本，也就是下图第二个
下载完成后，打开终端，进入文件目录
chmod &#43;x ZED_SDK_Ubuntu16_v2.7.1.run ./ZED_SDK_Ubuntu16_v2.7.1.run 全部Ｙ就行
问题开始了 给电脑插上zed相机，注意要USB3.0的接口。
安装成功后，软件会在/usr/local/zed文件夹下。 打开终端：
cd &#34;/usr/local/zed/sample/positional tracking&#34; 编译
mkdir build cd build cmake .. make 此时没有生成可执行文件./ZED_Positional_Tracking
解决方法:去cpp文件下新建build 再编译
cmake失败，报错:Could NOT find GLEW (missing: GLEW_INCLUDE_DIR GLEW_LIBRARY)
解决方法:安装libglew-dev软件包就可以解决这个问题了 sudo apt install libglew-dev cmake解决之后，make的时候失败了，报了类似这样的没有定义指向的错误
解决方法：使用camke选项来解决 cmake -DCMAKE_LIBRARY_PATH=/usr/local/cuda/lib64/stubs -DCMAKE_CXX_FLAGS=&#34;-Wl,--allow-shlib-undefined&#34; .. 链接路径需要指向 CUDA 存根文件夹，由于nvcuvid在编译时可能不可用，我们告诉编译器忽略未定义的符号。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/871a479c34bdfa10ad35faabf08a9a92/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-09T19:29:21+08:00" />
<meta property="article:modified_time" content="2022-06-09T19:29:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ubuntu18.04 NX下用ZED2 双目立体相机进行SLAM</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>NX下的ZED2开发</h4> 
 <ul><li><a href="#_1" rel="nofollow">安装流程</a></li><li><ul><li><a href="#_42" rel="nofollow">问题开始了</a></li><li><ul><li><a href="#_141" rel="nofollow">看效果</a></li><li><a href="#ZED2_ROS_144" rel="nofollow">安装ZED2 ROS工具</a></li></ul> 
   </li><li><a href="#zed2_230" rel="nofollow">新故事篇章-zed2测距</a></li><li><ul><li><a href="#_278" rel="nofollow">开始实现</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>安装流程</h2> 
<p>了解zed参数<br> <img src="https://images2.imgbox.com/8d/ff/kSvLIGPc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/94/43/Hi4nHOwy_o.png" alt="在这里插入图片描述"></p> 
<p>因为网上的安装流程还是不太完整，我补充一下,希望对其他人也有帮助<br> 部分流程参考这位：<a href="https://blog.csdn.net/sinat_39416814/article/details/88172968">博主</a></p> 
<p>自己的安装流程:<br> 因为NX本来就自带cuda,所以无需安装cuda,所以首先你要知道自己cuda</p> 
<pre><code class="prism language-cpp">nvcc <span class="token operator">-</span>V
</code></pre> 
<p><img src="https://images2.imgbox.com/91/16/tS34dT4g_o.png" alt="在这里插入图片描述"><br> 可以看到我的版本是10.2</p> 
<p>现在去下载 <a href="https://www.stereolabs.com/developers/release/" rel="nofollow">SDK</a></p> 
<p>查看自己的jetpack 版本</p> 
<pre><code class="prism language-cpp">jtop
</code></pre> 
<p><img src="https://images2.imgbox.com/a4/27/TMrCPrKF_o.png" alt="在这里插入图片描述"><br> 可以看到我用的是jetpack 4.4.1版本<br> <strong>所以下载的是jetson jetpack 4.4 cuda10.2 的版本，也就是下图第二个</strong><br> <img src="https://images2.imgbox.com/6a/8f/KjQMBanq_o.png" alt="在这里插入图片描述"></p> 
<p>下载完成后，打开终端，进入文件目录</p> 
<pre><code class="prism language-cpp"> chmod <span class="token operator">+</span>x ZED_SDK_Ubuntu16_v2<span class="token punctuation">.</span><span class="token number">7.1</span><span class="token punctuation">.</span>run
 <span class="token punctuation">.</span><span class="token operator">/</span>ZED_SDK_Ubuntu16_v2<span class="token punctuation">.</span><span class="token number">7.1</span><span class="token punctuation">.</span>run
</code></pre> 
<p>全部Ｙ就行</p> 
<h3><a id="_42"></a>问题开始了</h3> 
<ol><li>给电脑插上zed相机，注意要USB3.0的接口。<br> 安装成功后，软件会在/usr/local/zed文件夹下。</li></ol> 
<p>打开终端：</p> 
<pre><code class="prism language-cpp">cd <span class="token string">"/usr/local/zed/sample/positional tracking"</span>
</code></pre> 
<p>编译</p> 
<pre><code class="prism language-cpp">mkdir build
cd build
cmake <span class="token punctuation">.</span><span class="token punctuation">.</span>
make
</code></pre> 
<p>此时没有生成可执行文件./ZED_Positional_Tracking</p> 
<p><strong>解决方法:去cpp文件下新建build 再编译</strong></p> 
<ol start="2"><li>cmake失败，报错:<em>Could NOT find GLEW (missing: GLEW_INCLUDE_DIR GLEW_LIBRARY)</em><br> <img src="https://images2.imgbox.com/40/11/Ultt2VWq_o.png" alt="在这里插入图片描述"><br> <strong>解决方法:安装libglew-dev软件包就可以解决这个问题了</strong></li></ol> 
<pre><code class="prism language-cpp">sudo apt install libglew<span class="token operator">-</span>dev
</code></pre> 
<ol start="3"><li>cmake解决之后，make的时候失败了，报了类似这样的没有定义指向的错误<br> <img src="https://images2.imgbox.com/b2/75/q9vpkDt5_o.png" alt="在这里插入图片描述"><br> <strong>解决方法：使用camke选项来解决</strong></li></ol> 
<pre><code class="prism language-cpp">cmake <span class="token operator">-</span>DCMAKE_LIBRARY_PATH<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda<span class="token operator">/</span>lib64<span class="token operator">/</span>stubs <span class="token operator">-</span>DCMAKE_CXX_FLAGS<span class="token operator">=</span><span class="token string">"-Wl,--allow-shlib-undefined"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>链接路径需要指向 CUDA 存根文件夹，由于nvcuvid在编译时可能不可用，我们告诉编译器忽略未定义的符号。</p> 
<ol start="4"><li>make编译成功了，可是执行./ZED_Positional_Tracking却找不到libturbojpeg.so.0(其实在执行/usr/local/zed/tools里面的部分程序时候也是出现这个错误)</li></ol> 
<p><img src="https://images2.imgbox.com/d1/7d/OXCI9Un0_o.png" alt="在这里插入图片描述"><br> <strong>解决方法：安装libjpeg-turbo 2.0版本</strong><br> <a href="https://blog.csdn.net/weixin_42118374/article/details/100579004">转载这位博主</a></p> 
<ul><li> <p>第一步</p> <p>进入下载官网页面，网址<a href="https://sourceforge.net/projects/libjpeg-turbo/files/" rel="nofollow">链接</a></p> <p>下载2.0.x版本的libjpeg-turbo-2.0.2.tar.gz</p> </li><li> <p>第二步</p> <p>使用tar -zxvf libjpeg-turbo-2.0.2.tar.gz 将压缩包解压到当前目录中, 接着执行以下命令:</p> </li></ul> 
<pre><code class="prism language-cpp">   cd libjpeg<span class="token operator">-</span>turbo<span class="token operator">-</span><span class="token number">2.0</span><span class="token punctuation">.</span><span class="token number">2</span>
   
   mkdir build 
   
   cmake <span class="token operator">-</span>G<span class="token string">"Unix Makefiles"</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>
   
   make
</code></pre> 
<p>到这里, libjpeg-turbo就已经编译安装好了, 如果你是以root身份执行的,那么编译好后的文件在/usr/local/lib64 里面</p> 
<ul><li> <p>第三步(这一步做法和转载的博主不一样)</p> <p>参考<a href="https://blog.csdn.net/qc530167365/article/details/91491851">这位博主教程</a>我是修改共享库配置文件/etc/ld.so.conf．</p> </li><li> <p>1、设置：</p> </li></ul> 
<pre><code class="prism language-cpp">sudo gedit <span class="token operator">/</span>etc<span class="token operator">/</span>ld<span class="token punctuation">.</span>so<span class="token punctuation">.</span>conf
</code></pre> 
<ul><li>2、添加库路径：</li></ul> 
<pre><code class="prism language-cpp">include <span class="token operator">/</span>etc<span class="token operator">/</span>ld<span class="token punctuation">.</span>so<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>d<span class="token comment">/*.conf
/home/xxx/Downloads/libjpeg-turbo-2.0.90
</span></code></pre> 
<p>保存退出；</p> 
<ul><li>3、使配置立即生效</li></ul> 
<pre><code class="prism language-cpp">sudo ldconfig
</code></pre> 
<p><strong>现在执行./ZED_Positional_Tracking成功了，tools里面的程序全部都可以执行成功．</strong></p> 
<h4><a id="_141"></a>看效果</h4> 
<p><img src="https://images2.imgbox.com/81/e5/24rzNnRp_o.png" alt="在这里插入图片描述"><br> 对了，记得相机标定时候，下面和右边的圆圈要在中间才能标定成功．</p> 
<h4><a id="ZED2_ROS_144"></a>安装ZED2 ROS工具</h4> 
<pre><code class="prism language-cpp">$ cd <span class="token operator">~</span><span class="token operator">/</span>ZED_WS<span class="token operator">/</span>src
$ git clone https<span class="token operator">:</span><span class="token comment">//github.com/stereolabs/zed-ros-wrapper.git</span>
$ cd <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>
$ rosdep install <span class="token operator">--</span>from<span class="token operator">-</span>paths src <span class="token operator">--</span>ignore<span class="token operator">-</span>src <span class="token operator">-</span>r <span class="token operator">-</span>y
$ catkin_make <span class="token operator">-</span>DCMAKE_BUILD_TYPE<span class="token operator">=</span>Release
$ source <span class="token punctuation">.</span><span class="token operator">/</span>devel<span class="token operator">/</span>setup<span class="token punctuation">.</span>bash

</code></pre> 
<p>如果zed-ros-interfaces缺失，那么</p> 
<pre><code class="prism language-cpp">git clone https<span class="token operator">:</span><span class="token comment">//github.com/stereolabs/zed-ros-interfaces</span>
</code></pre> 
<p>git clone 太慢，可以参考下列方式：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//这是我们要clone的</span>
git clone https<span class="token operator">:</span><span class="token comment">//github.com/Hackergeek/architecture-samples</span>
 
<span class="token comment">//使用镜像</span>
git clone https<span class="token operator">:</span><span class="token comment">//github.com.cnpmjs.org/Hackergeek/architecture-samples</span>
 
<span class="token comment">//或者</span>
 
<span class="token comment">//其他镜像</span>
git clone https<span class="token operator">:</span><span class="token comment">//git.sdut.me/Hackergeek/architecture-samples</span>
git clone https<span class="token operator">:</span><span class="token comment">//hub.fastgit.org/stereolabs/zed-ros-wrapper.git</span>
git clone https<span class="token operator">:</span><span class="token comment">//github.91chi.fun//https://github.com/stereolabs/zed-ros-wrapper.git</span>
</code></pre> 
<p>编译安装包顺序是:</p> 
<p>zed_interfaces:<code>catkin_make -DCMAKE_BUILD_TYPE=Release</code><br> zed_wrapper:<code>catkin_make -DCATKIN_WHITELIST_PACKAGES="zed_wrapper"</code><br> zed_nodelets:<code>catkin_make -DCATKIN_WHITELIST_PACKAGES="zed_nodelets" </code></p> 
<p>节点详情描述可以查看官方文档<a href="http://wiki.ros.org/zed-ros-wrapper" rel="nofollow">http://wiki.ros.org/zed-ros-wrapper</a>，里面列举了该package中可以发布的话题：<br> <img src="https://images2.imgbox.com/12/76/3YRapqc7_o.png" alt="在这里插入图片描述"><br> 相机自带的工具查看视频流</p> 
<pre><code class="prism language-cpp">cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>zed<span class="token operator">/</span>tools
</code></pre> 
<p>执行命令<code>./ZED_Depth_Viewer</code><br> <img src="https://images2.imgbox.com/2b/ac/M6PrCVe2_o.png" alt="在这里插入图片描述"><br> 如果不能看到720和1080和2k，lsusb查看是不是用了usb2.0，也可以用zed2自带工具检测是否用了usb2.0，<strong>2.0会导致只能用VGA视频流</strong></p> 
<p>启动zed节点</p> 
<pre><code class="prism language-cpp">roslaunch zed_wrapper zed2<span class="token punctuation">.</span>launch
</code></pre> 
<p>查看画面</p> 
<pre><code class="prism language-cpp">rosrun image_view image_view image<span class="token operator">:</span><span class="token operator">=</span><span class="token operator">/</span>zed2<span class="token operator">/</span>zed_node<span class="token operator">/</span>rgb_raw<span class="token operator">/</span>image_raw_color 
</code></pre> 
<p>用rviz看看点云</p> 
<pre><code class="prism language-cpp">roscore
rosrun rviz rviz
</code></pre> 
<p><img src="https://images2.imgbox.com/0b/27/4ifgPV9L_o.png" alt="在这里插入图片描述"><br> 查看视差图(相同颜色表示到相机距离相同)</p> 
<pre><code class="prism language-cpp">rosrun image_view disparity_view image<span class="token operator">:</span><span class="token operator">=</span><span class="token operator">/</span>zed2<span class="token operator">/</span>zed_node<span class="token operator">/</span>disparity<span class="token operator">/</span>disparity_image
</code></pre> 
<p><img src="https://images2.imgbox.com/9e/a2/ccEYXfsF_o.png" alt="在这里插入图片描述"><br> 查看rgb(立体纠正的图像)+深度图(左相机为原点)+视差图<br> <img src="https://images2.imgbox.com/e3/b8/7kwkA7CZ_o.png" alt="在这里插入图片描述"></p> 
<p>ros下命令行打开.pcd文件</p> 
<pre><code class="prism language-cpp">sudo apt install pcl<span class="token operator">-</span>tools 
pcl_viewer camera_test<span class="token punctuation">.</span>pcd 
</code></pre> 
<h3><a id="zed2_230"></a>新故事篇章-zed2测距</h3> 
<p><strong>故事到这里，我才开始慢慢了解双目摄像头</strong><br> <a href="https://ic-item.jd.com/71696587453.html#product-detaila" rel="nofollow">zed2</a>、<br> <a href="https://baijiahao.baidu.com/s?id=1633338470330287516&amp;wfr=spider&amp;for=pc" rel="nofollow">深度相机—TOF、双相机立体视觉、结构光立体视觉原理及优势对比</a>、<br> <a href="https://blog.csdn.net/hongju_tang/article/details/85008888?spm=1001.2014.3001.5501">点云的概念</a>、<br> <a href="https://www.cnblogs.com/yhlx125/p/4952522.html" rel="nofollow">三维计算视觉研究</a>、<br> <a href="https://blog.csdn.net/suswulongyuan/article/details/90488396">双目原理</a>、<br> <a href="https://baijiahao.baidu.com/s?id=1694533038223938039&amp;wfr=spider&amp;for=pc" rel="nofollow">聚类算法</a>、<br> <a href="https://xueshu.baidu.com/usercenter/paper/show?paperid=1v3x0rb0ak1s0a207u4e06n0rq756638" rel="nofollow">激光点云与图像融合的车辆检测方法</a>、<br> <a href="https://blog.csdn.net/hhaowang/article/details/115563694">双目立体视觉（4）- ZED2双目视觉开发理论与实践 with examples 0.1 object detection（这位博主很强啊）</a>、<br> <a href="https://blog.csdn.net/qq_40700822/article/details/118523941">YOLO v5与双目测距结合，实现目标的识别和定位测距</a>、<br> <a href="https://blog.csdn.net/Armergg/article/details/106802236">ORB-SLAM2系统的实时点云地图构建</a>、</p> 
<p><strong>然后选择查看这两篇文章开始了三维建模的实践</strong><br> <a href="https://www.cnblogs.com/QiQi-Robotics/p/13569508.html" rel="nofollow">基于ZED 2和ORB_SLAM2的SLAM实践</a><br> <a href="https://www.cnblogs.com/leexiaoming/p/6576274.html" rel="nofollow">ZED 相机 &amp;&amp; ORB-SLAM2安装环境配置与ROS下的调试</a></p> 
<p><strong>ROS Topic更改</strong></p> 
<pre><code>  在完成以步骤后我们仍需要更改ROS或ZED ROS Wrapper中topic的名称才能使得ORB-SLAM2 ROS与ZED相机相配合。

  根据ZED ROS Wrapper官网（http://www.stereolabs.com/blog/index.php/2015/09/07/use-your-zed-camera-with-ros/）中的信息，我们可以查询到ZED ROS Wrapper所发布的topic名称。我们可以选择更改ZED的相关文件使得其匹配ORB-SLAM2 ROS的topic名字，也可以反过来更改更改ORB-SLAM2的topic名字。我选择的是更改ORB-SLAM2 ROS所接收的Topic名称。

  ORB-SLAM2 ROS相关的Topic名称在路径/home/xxx/catkin_zed/src/orb_slam_2_ros/ros/src/StereoNode.cc中的相关文件中    
</code></pre> 
<p>运行流程：开启zed2-&gt;打开slam2-&gt;rviz可视化</p> 
<pre><code class="prism language-cpp">roslaunch zed_wrapper zed2<span class="token punctuation">.</span>launch
roslaunch orb_slam2_ros orb_slam2_zed2_stereo<span class="token punctuation">.</span>launch
rviz rviz
</code></pre> 
<p><img src="https://images2.imgbox.com/e9/4a/ejX7SG1i_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dc/3a/ES8uodp8_o.png" alt="在这里插入图片描述"><br> 运行这两个节点后就可以看到物体特征点以及相机的姿态以及点云。貌似这个特征点如果缺失就会导致slam2的点云和姿态都停下。</p> 
<br> 突然项目要求居然从实时检测测距变成离线二维图测距，所以以上的东西又要放一放了。 
<br> 题外话：项目要求是物外双目拍摄，然后回来再二维图上取点测距，这个和realsense深度摄像头很像，只是realsense测距只有10m，而这个zed2可以达到40米。好了，之后的内容就是直接拿zed2的深度图和rgb，然后三维映射到二维，然后opencv取点显示距离。搞好之后我再回来弄实时建图，融合图像识别加双目来测量每个聚类物的距离。但感觉户外用双目的点云测距肯定不如雷达，为什么不用雷达啊，因为穷。另外ZED2相机标定及运行VINS-mono、VINS-FUSION建模我也想跑一下，图像标定的话我想自己搞一下，那些都是后话。。。。 
<p><a href="https://blog.csdn.net/weixin_44401286/article/details/109641268">ZED2相机标定及运行VINS-mono</a><br> <a href="https://zhuanlan.zhihu.com/p/62988961" rel="nofollow">VINS-FUSION</a></p> 
<br> 
<h4><a id="_278"></a>开始实现</h4> 
<p><a href="https://www.stereolabs.com/docs/ros/depth-sensing/#depth-subscribing-in-c" rel="nofollow">zed-ros的中心测距</a><br> 中心测距是直接拿深度图，图像中心的深度值是通过图像像素中心的坐标然后转成深度图下的坐标来得到的。代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token comment">///</span>
<span class="token comment">//</span>
<span class="token comment">// Copyright (c) 2018, STEREOLABS.</span>
<span class="token comment">//</span>
<span class="token comment">// All rights reserved.</span>
<span class="token comment">//</span>
<span class="token comment">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="token comment">// "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="token comment">// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="token comment">// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="token comment">// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="token comment">// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="token comment">// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="token comment">// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="token comment">// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="token comment">// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="token comment">// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="token comment">//</span>
<span class="token comment">///</span>

<span class="token comment">/**
 * This tutorial demonstrates simple receipt of ZED depth messages over the ROS system.
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ros/ros.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sensor_msgs/Image.h&gt;</span></span>

<span class="token comment">/**
 * Subscriber callback
 */</span>

<span class="token keyword">void</span> <span class="token function">depthCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> sensor_msgs<span class="token double-colon punctuation">::</span>Image<span class="token double-colon punctuation">::</span>ConstPtr<span class="token operator">&amp;</span> msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Get a pointer to the depth values casting the data</span>
  <span class="token comment">// pointer to floating point</span>
  <span class="token keyword">float</span><span class="token operator">*</span> depths <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Image coordinates of the center pixel</span>
  <span class="token keyword">int</span> u <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> v <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token comment">// Linear index of the center pixel</span>
  <span class="token keyword">int</span> centerIdx <span class="token operator">=</span> u <span class="token operator">+</span> msg<span class="token operator">-&gt;</span>width <span class="token operator">*</span> v<span class="token punctuation">;</span>

  <span class="token comment">// Output the measure</span>
  <span class="token function">ROS_INFO</span><span class="token punctuation">(</span><span class="token string">"Center distance : %g m"</span><span class="token punctuation">,</span> depths<span class="token punctuation">[</span>centerIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Node main function
 */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
   * The ros::init() function needs to see argc and argv so that it can perform
   * any ROS arguments and name remapping that were provided at the command line.
   * For programmatic remappings you can use a different version of init() which takes
   * remappings directly, but for most command-line programs, passing argc and argv is
   * the easiest way to do it.  The third argument to init() is the name of the node.
   *
   * You must call one of the versions of ros::init() before using any other
   * part of the ROS system.
   */</span>
  ros<span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"zed_video_subscriber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * NodeHandle is the main access point to communications with the ROS system.
   * The first NodeHandle constructed will fully initialize this node, and the last
   * NodeHandle destructed will close down the node.
   */</span>
  ros<span class="token double-colon punctuation">::</span>NodeHandle n<span class="token punctuation">;</span>

  <span class="token comment">/**
   * The subscribe() call is how you tell ROS that you want to receive messages
   * on a given topic.  This invokes a call to the ROS
   * master node, which keeps a registry of who is publishing and who
   * is subscribing.  Messages are passed to a callback function, here
   * called imageCallback.  subscribe() returns a Subscriber object that you
   * must hold on to until you want to unsubscribe.  When all copies of the Subscriber
   * object go out of scope, this callback will automatically be unsubscribed from
   * this topic.
   *
   * The second parameter to the subscribe() function is the size of the message
   * queue.  If messages are arriving faster than they are being processed, this
   * is the number of messages that will be buffered up before beginning to throw
   * away the oldest ones.
   */</span>
  ros<span class="token double-colon punctuation">::</span>Subscriber subDepth <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"depth"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> depthCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * ros::spin() will enter a loop, pumping callbacks.  With this version, all
   * callbacks will be called from within this thread (the main one).  ros::spin()
   * will exit when Ctrl-C is pressed, or the node is shutdown by the master.
   */</span>
  ros<span class="token double-colon punctuation">::</span><span class="token function">spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>改为自己的</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ros/ros.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"image_transport/image_transport.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/highgui/highgui.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"cv_bridge/cv_bridge.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sensor_msgs/image_encodings.h"</span></span>

image_transport<span class="token double-colon punctuation">::</span>Subscriber rgbsub<span class="token punctuation">;</span>
image_transport<span class="token double-colon punctuation">::</span>Subscriber depthsub<span class="token punctuation">;</span>
image_transport<span class="token double-colon punctuation">::</span>Publisher  image_pub<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">cvtColor_src</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Mat <span class="token operator">&amp;</span>src<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span>Mat <span class="token operator">&amp;</span>src_gray<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//  转换单通道</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src_gray<span class="token punctuation">,</span> CV_BGRA2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src_gray<span class="token punctuation">,</span> CV_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cv<span class="token double-colon punctuation">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src_gray<span class="token punctuation">,</span> CV_BGR5652GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 单通道的图片直接就不需要处理</span>
        src_gray <span class="token operator">=</span> src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 负数,说明图有问题 直接返回   </span>
        src_gray <span class="token operator">=</span> src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">showColorGrayView</span><span class="token punctuation">(</span><span class="token keyword">const</span> sensor_msgs<span class="token double-colon punctuation">::</span>ImageConstPtr<span class="token operator">&amp;</span> msgImg<span class="token punctuation">)</span> <span class="token comment">//672 x 376</span>
<span class="token punctuation">{<!-- --></span>	
	cv_bridge<span class="token double-colon punctuation">::</span>CvImagePtr cvImgPtr<span class="token punctuation">;</span>
	<span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
		cvImgPtr<span class="token operator">=</span>cv_bridge<span class="token double-colon punctuation">::</span><span class="token function">toCvCopy</span><span class="token punctuation">(</span>msgImg<span class="token punctuation">,</span>sensor_msgs<span class="token double-colon punctuation">::</span>image_encodings<span class="token double-colon punctuation">::</span>BGR8<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span><span class="token punctuation">(</span>cv_bridge<span class="token double-colon punctuation">::</span>Exception e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">ROS_ERROR_STREAM</span><span class="token punctuation">(</span><span class="token string">"Cv_bridge Exception:"</span><span class="token operator">&lt;&lt;</span>e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	cv<span class="token double-colon punctuation">::</span>Mat cvColorImgMat<span class="token operator">=</span>cvImgPtr<span class="token operator">-&gt;</span>image<span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span>Mat cvGrayImgMat<span class="token punctuation">;</span>
 
	<span class="token comment">// Draw an example circle on the video stream</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cvColorImgMat<span class="token punctuation">.</span>rows <span class="token operator">&gt;</span> <span class="token number">60</span> <span class="token operator">&amp;&amp;</span> cvColorImgMat<span class="token punctuation">.</span>cols <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token punctuation">)</span>
    cv<span class="token double-colon punctuation">::</span><span class="token function">circle</span><span class="token punctuation">(</span>cvColorImgMat<span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token function">CV_RGB</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	cv<span class="token double-colon punctuation">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"colorview"</span><span class="token punctuation">,</span>cvColorImgMat<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//imshow函数只支持8位灰度图像、8位彩色图像和32位灰度图像（像素值范围0-1）</span>
	<span class="token function">cvtColor_src</span><span class="token punctuation">(</span>cvColorImgMat<span class="token punctuation">,</span>cvGrayImgMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
	image_pub<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>cvImgPtr<span class="token operator">-&gt;</span><span class="token function">toImageMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//OpenCV图像转换为ROS图像</span>
	
	cv<span class="token double-colon punctuation">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"grayview"</span><span class="token punctuation">,</span>cvGrayImgMat<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>  

<span class="token keyword">void</span> <span class="token function">showDepthView</span><span class="token punctuation">(</span><span class="token keyword">const</span> sensor_msgs<span class="token double-colon punctuation">::</span>ImageConstPtr<span class="token operator">&amp;</span> msgImg<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>	
	cv<span class="token double-colon punctuation">::</span>Mat image<span class="token punctuation">;</span> 
	<span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
		image<span class="token operator">=</span>cv_bridge<span class="token double-colon punctuation">::</span><span class="token function">toCvCopy</span><span class="token punctuation">(</span>msgImg<span class="token punctuation">,</span> sensor_msgs<span class="token double-colon punctuation">::</span>image_encodings<span class="token double-colon punctuation">::</span>TYPE_32FC1<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> image<span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span><span class="token punctuation">(</span>cv_bridge<span class="token double-colon punctuation">::</span>Exception e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">ROS_ERROR_STREAM</span><span class="token punctuation">(</span><span class="token string">"Cv_bridge Exception:"</span><span class="token operator">&lt;&lt;</span>e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">ROS_INFO</span><span class="token punctuation">(</span><span class="token string">"center dis:%f m "</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>rows <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span>cols <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"depth_view"</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	ros<span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"grayview"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ros<span class="token double-colon punctuation">::</span>NodeHandle nh<span class="token punctuation">;</span>
	image_transport<span class="token double-colon punctuation">::</span>ImageTransport <span class="token function">it</span><span class="token punctuation">(</span>nh<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span><span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"colorview"</span><span class="token punctuation">,</span>cv<span class="token double-colon punctuation">::</span>WINDOW_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span><span class="token function">moveWindow</span><span class="token punctuation">(</span><span class="token string">"colorview"</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span><span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"grayview"</span><span class="token punctuation">,</span>cv<span class="token double-colon punctuation">::</span>WINDOW_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span><span class="token function">moveWindow</span><span class="token punctuation">(</span><span class="token string">"grayview"</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span><span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"depth_view"</span><span class="token punctuation">,</span>cv<span class="token double-colon punctuation">::</span>WINDOW_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cv<span class="token double-colon punctuation">::</span><span class="token function">moveWindow</span><span class="token punctuation">(</span><span class="token string">"depth_view"</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	rgbsub        <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"/zed2/zed_node/rgb/image_rect_color"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> showColorGrayView<span class="token punctuation">)</span><span class="token punctuation">;</span>
	depthsub      <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"/zed2/zed_node/depth/depth_registered"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> showDepthView<span class="token punctuation">)</span><span class="token punctuation">;</span>
	image_pub     <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">advertise</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ros<span class="token double-colon punctuation">::</span><span class="token function">spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>cmakelist</p> 
<pre><code class="prism language-cpp"><span class="token function">cmake_minimum_required</span><span class="token punctuation">(</span>VERSION <span class="token number">3.0</span><span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">project</span><span class="token punctuation">(</span>pcl_detection<span class="token punctuation">)</span>

## Compile as C<span class="token operator">++</span><span class="token number">11</span><span class="token punctuation">,</span> supported in ROS Kinetic <span class="token operator">and</span> newer
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">add</span><span class="token expression"><span class="token function">_compile_options</span><span class="token punctuation">(</span><span class="token operator">-</span>std<span class="token operator">=</span>c<span class="token operator">++</span><span class="token number">11</span><span class="token punctuation">)</span></span></span>

## Find catkin macros <span class="token operator">and</span> libraries
## <span class="token keyword">if</span> COMPONENTS list like <span class="token function">find_package</span><span class="token punctuation">(</span>catkin REQUIRED COMPONENTS xyz<span class="token punctuation">)</span>
## is used<span class="token punctuation">,</span> also find other catkin packages
<span class="token function">find_package</span><span class="token punctuation">(</span>catkin REQUIRED COMPONENTS
  roscpp
  rospy
  std_msgs
  zed_interfaces
  pcl_ros

  cv_bridge
  image_transport
<span class="token punctuation">)</span>
  
## Find opencv lib
<span class="token function">find_package</span><span class="token punctuation">(</span>OpenCV REQUIRED<span class="token punctuation">)</span>


## System dependencies are found with CMake<span class="token number">'</span>s conventions
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">find</span><span class="token expression"><span class="token function">_package</span><span class="token punctuation">(</span>Boost REQUIRED COMPONENTS system<span class="token punctuation">)</span></span></span>


## Uncomment <span class="token keyword">this</span> <span class="token keyword">if</span> the package has a setup<span class="token punctuation">.</span>py<span class="token punctuation">.</span> This macro ensures
## modules <span class="token operator">and</span> global scripts declared therein get installed
## See http<span class="token operator">:</span><span class="token comment">//ros.org/doc/api/catkin/html/user_guide/setup_dot_py.html</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">catkin</span><span class="token expression"><span class="token function">_python_setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>

################################################
## Declare ROS messages<span class="token punctuation">,</span> services <span class="token operator">and</span> actions ##
################################################

## To declare <span class="token operator">and</span> build messages<span class="token punctuation">,</span> services <span class="token operator">or</span> actions from within <span class="token keyword">this</span>
## package<span class="token punctuation">,</span> follow these steps<span class="token operator">:</span>
## <span class="token operator">*</span> Let MSG_DEP_SET be the set of packages whose message types you use in
##   your messages<span class="token operator">/</span>services<span class="token operator">/</span><span class="token function">actions</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> std_msgs<span class="token punctuation">,</span> actionlib_msgs<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
## <span class="token operator">*</span> In the file package<span class="token punctuation">.</span>xml<span class="token operator">:</span>
##   <span class="token operator">*</span> add a build_depend tag <span class="token keyword">for</span> <span class="token string">"message_generation"</span>
##   <span class="token operator">*</span> add a build_depend <span class="token operator">and</span> a exec_depend tag <span class="token keyword">for</span> each package in MSG_DEP_SET
##   <span class="token operator">*</span> If MSG_DEP_SET isn<span class="token number">'</span>t empty the following dependency has been pulled in
##     but can be declared <span class="token keyword">for</span> certainty nonetheless<span class="token operator">:</span>
##     <span class="token operator">*</span> add a exec_depend tag <span class="token keyword">for</span> <span class="token string">"message_runtime"</span>
## <span class="token operator">*</span> In <span class="token keyword">this</span> <span class="token function">file</span> <span class="token punctuation">(</span>CMakeLists<span class="token punctuation">.</span>txt<span class="token punctuation">)</span><span class="token operator">:</span>
##   <span class="token operator">*</span> add <span class="token string">"message_generation"</span> <span class="token operator">and</span> every package in MSG_DEP_SET to
##     <span class="token function">find_package</span><span class="token punctuation">(</span>catkin REQUIRED COMPONENTS <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
##   <span class="token operator">*</span> add <span class="token string">"message_runtime"</span> <span class="token operator">and</span> every package in MSG_DEP_SET to
##     <span class="token function">catkin_package</span><span class="token punctuation">(</span>CATKIN_DEPENDS <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
##   <span class="token operator">*</span> uncomment the add_<span class="token operator">*</span>_files sections below as needed
##     <span class="token operator">and</span> list every <span class="token punctuation">.</span>msg<span class="token operator">/</span><span class="token punctuation">.</span>srv<span class="token operator">/</span><span class="token punctuation">.</span>action file to be processed
##   <span class="token operator">*</span> uncomment the generate_messages entry below
##   <span class="token operator">*</span> add every package in MSG_DEP_SET to <span class="token function">generate_messages</span><span class="token punctuation">(</span>DEPENDENCIES <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>

## Generate messages in the <span class="token char">'msg'</span> folder
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">add</span><span class="token expression"><span class="token function">_message_files</span><span class="token punctuation">(</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">FILES</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">Message1<span class="token punctuation">.</span>msg</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">Message2<span class="token punctuation">.</span>msg</span></span>
# <span class="token punctuation">)</span>

## Generate services in the <span class="token char">'srv'</span> folder
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">add</span><span class="token expression"><span class="token function">_service_files</span><span class="token punctuation">(</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">FILES</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">Service1<span class="token punctuation">.</span>srv</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">Service2<span class="token punctuation">.</span>srv</span></span>
# <span class="token punctuation">)</span>

## Generate actions in the <span class="token char">'action'</span> folder
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">add</span><span class="token expression"><span class="token function">_action_files</span><span class="token punctuation">(</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">FILES</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">Action1<span class="token punctuation">.</span>action</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">Action2<span class="token punctuation">.</span>action</span></span>
# <span class="token punctuation">)</span>

## Generate added messages <span class="token operator">and</span> services with any dependencies listed here
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">generate</span><span class="token expression"><span class="token function">_messages</span><span class="token punctuation">(</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">DEPENDENCIES</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token directive keyword">std</span><span class="token expression">_msgs</span></span>
# <span class="token punctuation">)</span>

################################################
## Declare ROS dynamic reconfigure parameters ##
################################################

## To declare <span class="token operator">and</span> build dynamic reconfigure parameters within <span class="token keyword">this</span>
## package<span class="token punctuation">,</span> follow these steps<span class="token operator">:</span>
## <span class="token operator">*</span> In the file package<span class="token punctuation">.</span>xml<span class="token operator">:</span>
##   <span class="token operator">*</span> add a build_depend <span class="token operator">and</span> a exec_depend tag <span class="token keyword">for</span> <span class="token string">"dynamic_reconfigure"</span>
## <span class="token operator">*</span> In <span class="token keyword">this</span> <span class="token function">file</span> <span class="token punctuation">(</span>CMakeLists<span class="token punctuation">.</span>txt<span class="token punctuation">)</span><span class="token operator">:</span>
##   <span class="token operator">*</span> add <span class="token string">"dynamic_reconfigure"</span> to
##     <span class="token function">find_package</span><span class="token punctuation">(</span>catkin REQUIRED COMPONENTS <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
##   <span class="token operator">*</span> uncomment the <span class="token string">"generate_dynamic_reconfigure_options"</span> section below
##     <span class="token operator">and</span> list every <span class="token punctuation">.</span>cfg file to be processed

## Generate dynamic reconfigure parameters in the <span class="token char">'cfg'</span> folder
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">generate</span><span class="token expression"><span class="token function">_dynamic_reconfigure_options</span><span class="token punctuation">(</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token directive keyword">cfg</span><span class="token expression"><span class="token operator">/</span>DynReconf1<span class="token punctuation">.</span>cfg</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token directive keyword">cfg</span><span class="token expression"><span class="token operator">/</span>DynReconf2<span class="token punctuation">.</span>cfg</span></span>
# <span class="token punctuation">)</span>

###################################
## catkin specific configuration ##
###################################
## The catkin_package macro generates cmake config files <span class="token keyword">for</span> your package
## Declare things to be passed to dependent projects
## INCLUDE_DIRS<span class="token operator">:</span> uncomment <span class="token keyword">this</span> <span class="token keyword">if</span> your package contains header files
## LIBRARIES<span class="token operator">:</span> libraries you create in <span class="token keyword">this</span> project that dependent projects also need
## CATKIN_DEPENDS<span class="token operator">:</span> catkin_packages dependent projects also need
## DEPENDS<span class="token operator">:</span> system dependencies of <span class="token keyword">this</span> project that dependent projects also need
<span class="token function">catkin_package</span><span class="token punctuation">(</span>
  INCLUDE_DIRS include
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token expression">LIBRARIES pcl_detection</span></span>
  CATKIN_DEPENDS roscpp rospy std_msgs
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token expression">DEPENDS system_lib</span></span>
<span class="token punctuation">)</span>

###########
## Build ##
###########

## Specify additional locations of header files
## Your package locations should be listed before other locations
<span class="token function">include_directories</span><span class="token punctuation">(</span>
 include
  $<span class="token punctuation">{<!-- --></span>catkin_INCLUDE_DIRS<span class="token punctuation">}</span>
  $<span class="token punctuation">{<!-- --></span>PCL_INCLUDE_DIRS<span class="token punctuation">}</span>
  $<span class="token punctuation">{<!-- --></span>OpenCV_LIBRARIES<span class="token punctuation">}</span>
<span class="token punctuation">)</span> 

<span class="token function">FILE</span><span class="token punctuation">(</span>GLOB SOURCE_FILES src<span class="token comment">/*/*.c src/*/</span><span class="token operator">*</span><span class="token punctuation">.</span>cpp src<span class="token operator">/</span>object_detection<span class="token punctuation">.</span>cpp<span class="token punctuation">)</span>
<span class="token function">add_library</span><span class="token punctuation">(</span>zed_pcl_src $<span class="token punctuation">{<!-- --></span>SOURCE_FILES<span class="token punctuation">}</span><span class="token punctuation">)</span>  
<span class="token function">link_libraries</span><span class="token punctuation">(</span>zed_pcl_src<span class="token punctuation">)</span>
<span class="token function">add_subdirectory</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>

## Declare a C<span class="token operator">++</span> library
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">add</span><span class="token expression"><span class="token function">_library</span><span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token directive keyword">src</span><span class="token expression"><span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span><span class="token operator">/</span>pcl_detection<span class="token punctuation">.</span>cpp</span></span>
# <span class="token punctuation">)</span>

## Add cmake target dependencies of the library
## as an example<span class="token punctuation">,</span> code may need to be generated before libraries
## either from message generation <span class="token operator">or</span> dynamic reconfigure
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">add</span><span class="token expression"><span class="token function">_dependencies</span><span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span>_EXPORTED_TARGETS<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>catkin_EXPORTED_TARGETS<span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>

## Declare a C<span class="token operator">++</span> executable
## With catkin_make all packages are built within a single CMake context
## The recommended prefix ensures that target names across packages don<span class="token number">'</span>t collide
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">add</span><span class="token expression"><span class="token function">_executable</span><span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span>_node src<span class="token operator">/</span>pcl_detection_node<span class="token punctuation">.</span>cpp<span class="token punctuation">)</span></span></span>

## Rename C<span class="token operator">++</span> executable without prefix
## The above recommended prefix causes <span class="token keyword">long</span> target names<span class="token punctuation">,</span> the following renames the
## target back to the shorter version <span class="token keyword">for</span> ease of user use
## e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> <span class="token string">"rosrun someones_pkg node"</span> instead of <span class="token string">"rosrun someones_pkg someones_pkg_node"</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">set</span><span class="token expression"><span class="token function">_target_properties</span><span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span>_node PROPERTIES OUTPUT_NAME node PREFIX </span><span class="token string">""</span><span class="token expression"><span class="token punctuation">)</span></span></span>

## Add cmake target dependencies of the executable
## same as <span class="token keyword">for</span> the library above
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">add</span><span class="token expression"><span class="token function">_dependencies</span><span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span>_node $<span class="token punctuation">{<!-- --></span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span>_EXPORTED_TARGETS<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>catkin_EXPORTED_TARGETS<span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>

## Specify libraries to link a library <span class="token operator">or</span> executable target against
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">target</span><span class="token expression"><span class="token function">_link_libraries</span><span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span>_node</span></span>
#   $<span class="token punctuation">{<!-- --></span>catkin_LIBRARIES<span class="token punctuation">}</span>
# <span class="token punctuation">)</span>

#############
## Install ##
#############

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">all</span> <span class="token expression">install targets should use catkin DESTINATION variables</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">See http<span class="token operator">:</span></span><span class="token comment">//ros.org/doc/api/catkin/html/adv_user_guide/variables.html</span></span>

## Mark executable <span class="token function">scripts</span> <span class="token punctuation">(</span>Python etc<span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">for</span> installation
## in contrast to setup<span class="token punctuation">.</span>py<span class="token punctuation">,</span> you can choose the destination
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">catkin</span><span class="token expression"><span class="token function">_install_python</span><span class="token punctuation">(</span>PROGRAMS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token directive keyword">scripts</span><span class="token expression"><span class="token operator">/</span>my_python_script</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">DESTINATION $<span class="token punctuation">{<!-- --></span>CATKIN_PACKAGE_BIN_DESTINATION<span class="token punctuation">}</span></span></span>
# <span class="token punctuation">)</span>

## Mark executables <span class="token keyword">for</span> installation 
## See http<span class="token operator">:</span><span class="token comment">//docs.ros.org/melodic/api/catkin/html/howto/format1/building_executables.html</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">install</span><span class="token expression"><span class="token punctuation">(</span>TARGETS $<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span>_node</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">RUNTIME DESTINATION $<span class="token punctuation">{<!-- --></span>CATKIN_PACKAGE_BIN_DESTINATION<span class="token punctuation">}</span></span></span>
# <span class="token punctuation">)</span>

## Mark libraries <span class="token keyword">for</span> installation
## See http<span class="token operator">:</span><span class="token comment">//docs.ros.org/melodic/api/catkin/html/howto/format1/building_libraries.html</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">install</span><span class="token expression"><span class="token punctuation">(</span>TARGETS $<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">ARCHIVE DESTINATION $<span class="token punctuation">{<!-- --></span>CATKIN_PACKAGE_LIB_DESTINATION<span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">LIBRARY DESTINATION $<span class="token punctuation">{<!-- --></span>CATKIN_PACKAGE_LIB_DESTINATION<span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">RUNTIME DESTINATION $<span class="token punctuation">{<!-- --></span>CATKIN_GLOBAL_BIN_DESTINATION<span class="token punctuation">}</span></span></span>
# <span class="token punctuation">)</span>

## Mark cpp header files <span class="token keyword">for</span> installation
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">install</span><span class="token expression"><span class="token punctuation">(</span>DIRECTORY include<span class="token operator">/</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span><span class="token operator">/</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">DESTINATION $<span class="token punctuation">{<!-- --></span>CATKIN_PACKAGE_INCLUDE_DESTINATION<span class="token punctuation">}</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">FILES_MATCHING PATTERN </span><span class="token string">"*.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">PATTERN </span><span class="token string">".svn"</span> <span class="token expression">EXCLUDE</span></span>
# <span class="token punctuation">)</span>

## Mark other files <span class="token keyword">for</span> <span class="token function">installation</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> launch <span class="token operator">and</span> bag files<span class="token punctuation">,</span> etc<span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">install</span><span class="token expression"><span class="token punctuation">(</span>FILES</span></span>
#   # myfile1
#   # myfile2
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token expression">DESTINATION $<span class="token punctuation">{<!-- --></span>CATKIN_PACKAGE_SHARE_DESTINATION<span class="token punctuation">}</span></span></span>
# <span class="token punctuation">)</span>

#############
## Testing ##
#############

## Add gtest based cpp test target <span class="token operator">and</span> link libraries
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">catkin</span><span class="token expression"><span class="token function">_add_gtest</span><span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span><span class="token operator">-</span>test test<span class="token operator">/</span>test_pcl_detection<span class="token punctuation">.</span>cpp<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">if</span><span class="token expression"><span class="token punctuation">(</span>TARGET $<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span><span class="token operator">-</span>test<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>   <span class="token directive keyword">target</span><span class="token expression"><span class="token function">_link_libraries</span><span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span><span class="token operator">-</span>test $<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>

## Add folders to be run by python nosetests
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">catkin</span><span class="token expression"><span class="token function">_add_nosetests</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span></span></span>


<span class="token function">add_executable</span><span class="token punctuation">(</span>wh_vehicle_node wh_vehicle_node<span class="token punctuation">.</span>cpp<span class="token punctuation">)</span>
<span class="token function">add_dependencies</span><span class="token punctuation">(</span>wh_vehicle_node $<span class="token punctuation">{<!-- --></span>$<span class="token punctuation">{<!-- --></span>PROJECT_NAME<span class="token punctuation">}</span>_EXPORTED_TARGETS<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>catkin_EXPORTED_TARGETS<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">target_link_libraries</span><span class="token punctuation">(</span>wh_vehicle_node $<span class="token punctuation">{<!-- --></span>catkin_LIBRARIES<span class="token punctuation">}</span> $<span class="token punctuation">{<!-- --></span>OpenCV_LIBRARIES<span class="token punctuation">}</span> jsoncpp<span class="token punctuation">)</span>
</code></pre> 
<p>运行后可以看到zed2的rgb，但不知道为什么不能显示灰度图和深度图，我opencv用的4.1.，python2来编译，实在是太奇怪了，编译和运行节点报分别报以下警告和错误：</p> 
<p><img src="https://images2.imgbox.com/f5/83/GxwgKq8x_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp">OpenCV Error<span class="token operator">:</span> Assertion <span class="token function">failed</span> <span class="token punctuation">(</span>scn <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">||</span> scn <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> in cvtColor<span class="token punctuation">,</span> file <span class="token operator">/</span>build<span class="token operator">/</span>opencv<span class="token operator">-</span>XDqSFW<span class="token operator">/</span>opencv<span class="token operator">-</span><span class="token number">3.2</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">+</span>dfsg<span class="token operator">/</span>modules<span class="token operator">/</span>imgproc<span class="token operator">/</span>src<span class="token operator">/</span>color<span class="token punctuation">.</span>cpp<span class="token punctuation">,</span> line <span class="token number">9716</span>
terminate called after throwing an instance of <span class="token char">'cv::Exception'</span>
  <span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>  <span class="token operator">/</span>build<span class="token operator">/</span>opencv<span class="token operator">-</span>XDqSFW<span class="token operator">/</span>opencv<span class="token operator">-</span><span class="token number">3.2</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">+</span>dfsg<span class="token operator">/</span>modules<span class="token operator">/</span>imgproc<span class="token operator">/</span>src<span class="token operator">/</span>color<span class="token punctuation">.</span>cpp<span class="token operator">:</span><span class="token number">9716</span><span class="token operator">:</span> error<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">215</span><span class="token punctuation">)</span> scn <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">||</span> scn <span class="token operator">==</span> <span class="token number">4</span> in function cvtColor

</code></pre> 
<p>找了一天，找到解决方法了，<strong>ROS自带的opencv版本为3.2.0，在安装opencv4后导致使用不同版本的opencv报错，需要给ROS指定统一版本的opencv，解决方法是修改cv_bridge配置文件，使ROS去调用自己安装的opencv版本。</strong>（<a href="https://blog.csdn.net/PrideQ/article/details/115304494">详细操作看这篇文章</a>）</p> 
<p>记得Cmakelist.txt里面OpenCV改为4.1</p> 
<pre><code class="prism language-cpp">## Find opencv lib
<span class="token function">find_package</span><span class="token punctuation">(</span>OpenCV <span class="token number">4.1</span> REQUIRED<span class="token punctuation">)</span>
</code></pre> 
<p>代码没修改，最后显示rgb+灰度图+深度图+rviz显示ROS发布画圈后的图。<br> <img src="https://images2.imgbox.com/ff/50/MkFADhJU_o.png" alt="在这里插入图片描述"></p> 
<p>上面的操作虽然一时可以，但治标不治本，会导致roscore从2.7切换到3.6启动节点失败，而且启动zed2.launch也会失败。之后再想想怎么解决。要解决roscore和zed2.launch的问题，那还是要切回原来的python2.7，操着如下：</p> 
<pre><code class="prism language-cpp">sudo update<span class="token operator">-</span>alternatives <span class="token operator">--</span>config python
</code></pre> 
<p><img src="https://images2.imgbox.com/37/02/taGxDGaW_o.png" alt="在这里插入图片描述"></p> 
<p>参考：<br> <a href="https://blog.csdn.net/fb_help/article/details/105293211">渲染深度图</a><br> <a href="https://blog.csdn.net/qq_29797957/article/details/99648511">单通道深度图像转化为彩色图发布</a><br> <a href="https://blog.csdn.net/qq_43145072/article/details/102602602">ros_多消息同步回调</a><br> <a href="https://www.cnblogs.com/chrislzy/p/14934328.html#approximatetime-policy" rel="nofollow">近似时间算法</a><br> <a href="https://blog.csdn.net/weixin_40863346/article/details/82216462">cv_bridge</a></p> 
<p>录制多个话题，查看zed2深度和rgb的发布速率，这是为了等一下利用时间戳同步数据。录制过程会出现空间不够情况，我也没做压缩或者扩容等处理，简单验证一下自己问题就好。</p> 
<pre><code class="prism language-cpp">rosbag record <span class="token operator">-</span>o subset1 <span class="token operator">/</span>zed2<span class="token operator">/</span>zed_node<span class="token operator">/</span>rgb<span class="token operator">/</span>image_rect_colo   <span class="token operator">/</span>zed2<span class="token operator">/</span>zed_node<span class="token operator">/</span>depth<span class="token operator">/</span>depth_registered
</code></pre> 
<p>rqt_bag查看数据</p> 
<pre><code class="prism language-cpp">rqt_bag subset_2021<span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">27</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">33</span><span class="token operator">-</span><span class="token number">27.</span>bag subset_2021<span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">27</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">33</span><span class="token operator">-</span><span class="token number">27.</span>bag
</code></pre> 
<p><img src="https://images2.imgbox.com/bf/5d/pPqefuTj_o.png" alt="在这里插入图片描述"><br> rgb显示是有的，但显示似乎有点问题。但我们可以看到1s内深度和rgb每一帧发布的时间都差不多，1s20帧。<br> 所以之后可以利用ExactTime Policy或者ApproximateTime Policy来进行消息匹配（详情看：<a href="https://blog.csdn.net/qq_43145072/article/details/102602602">ros_多消息同步回调</a>）</p> 
<p><strong>对于这个zed2摄像头，通过/zed2/zed_node/depth/depth_registered 获取的像素值不是直接深度值，而是0-255像素的间接深度值，这个是通过image_transport将[0-255]的像素深度值、相机内参发布出去。<br> 我们可以通过cv_bridge::toCvCopy()来得到深度值，里面转换公式是通过z=f.b/d 来得到深度值的。（详情请看<a href="https://blog.csdn.net/deffand/article/details/100165687">双目模型及深度值计算</a>以及<a href="https://wiki.ros.org/image_pipeline/CameraInfo" rel="nofollow">zed2通过相机内参对图像的纠正</a>）</strong></p> 
<pre><code class="prism language-cpp">`cv<span class="token double-colon punctuation">::</span>Mat depthImage <span class="token operator">=</span> cv_bridge<span class="token double-colon punctuation">::</span><span class="token function">toCvCopy</span><span class="token punctuation">(</span>depth_image<span class="token punctuation">,</span> sensor_msgs<span class="token double-colon punctuation">::</span>image_encodings<span class="token double-colon punctuation">::</span>TYPE_32FC1<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> image<span class="token punctuation">;</span>`
</code></pre> 
<p>之后我用cv::imwrite保存深度图depthImage ，但这样会导致深度图数据缺失，因为它会全部转成8UC1**(cv::imwrite对于深度图是只能保存为8UC1，16UC1)**<br> 所以我保存depthImage数据为.xml，但是这样输出会出现inf、inf、Nan（如下图所示），<strong>这个应该是点双目匹配时候失败导致的。也就是说不是每个像素点你都有深度值的。</strong></p> 
<p>题外话：cv::imwrite保存png是可以保存16位的，数据是无损的（也可以设置压缩等级），保存jpg只能8位且数据有损的。<br> <img src="https://images2.imgbox.com/c9/d8/PZVA1uy9_o.png" alt="在这里插入图片描述"><br> 其实这个是深度值， 你要需要相机内参才能将深度值转成三维坐标。待更.</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a800dc9639d14c02479a80fc05005627/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">redis五种数据结构及应用场景</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/79d86f323d314cf25cb9dddbe3b9e8db/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基变换和线性变换的两种看待方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>