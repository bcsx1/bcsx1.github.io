<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Google的S2算法原理以及使用Java版本--部分参考自《高效的多维空间点索引算法》 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Google的S2算法原理以及使用Java版本--部分参考自《高效的多维空间点索引算法》" />
<meta property="og:description" content="文章目录 相关资料1.S2算法是什么？2.为什么要使用S2算法？3.S2的原理是什么？1）球面坐标变换2）球面坐标转平面坐标（降维）remark: 3）球面矩形投影修正4）点与坐标轴点相互转换5）坐标轴点与CellId相互转换1.生成希尔伯特曲线1.解释变量。2.r[0] &gt;&gt; 1和r[0] &amp; 13.orientation^posToOrientation[0] 2.pos 和 i，j 的转换关系3.S2 Cell ID 数据结构 6）源码7）举例 4.S2如何使用？1）经纬度 转 CellId2）CellId 转 经纬度3）S2计算距离4）经纬度构建S2矩形5）经纬度构建S2多边形6）经纬度构建圆形7）获取任意形状内所有S2块8）判断点是否在任意形状内9）不同等级S2块包含的S2子块10）判断当前cellId的level 5.S2与GeoHash的区别是什么？6.S2使用工具类1）WGS84Point类，存经纬度2）Tuple2自定义元组，存经纬度3）S2Util，部分API示例4）TestS2Util测试类 7.S2精度表 相关资料 halfrost 的 git 仓库，包含空间搜索系列文章：https://github.com/halfrost/Halfrost-Field
s2 官网：https://s2geometry.io
s2 地图/可视化工具（功能强大，强烈推荐）： http://s2.sidewalklabs.com/regioncoverer/
经纬度画圆/画矩形 地图/可视化工具 ：https://www.mapdevelopers.com/draw-circle-tool.php
经纬度画多边形 地图/可视化工具 ：http://apps.headwallphotonics.com
csdn参考文章：Google S2 常用操作 ：https://blog.csdn.net/deng0515001/article/details/88031153
S2官方PPT:https://docs.google.com/presentation/d/1Hl4KapfAENAOf4gv-pSngKwvS_jwNVHRPZTTDzXXn6Q/view#slide=id.i0
S2jar:使用Maven工具
&lt;!--google的S2包--&gt; &lt;dependency&gt; &lt;groupId&gt;io.sgr&lt;/groupId&gt; &lt;artifactId&gt;s2-geometry-library-java&lt;/artifactId&gt; &lt;version&gt;1.0.0&lt;/version&gt; &lt;/dependency&gt; &lt;!--附带的google common组件包--&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.guava&lt;/groupId&gt; &lt;artifactId&gt;guava&lt;/artifactId&gt; &lt;version&gt;21.0&lt;/version&gt; &lt;/dependency&gt; ​
直接下载源码，自己打jar,地址：https://github.com/google/s2-geometry-library-java
​
1.S2算法是什么？ ​ S2其实是来自几何数学中的一个数学符号 S²，它表示的是单位球。S2 这个库其实是被设计用来解决球面上各种几何问题的。
2.为什么要使用S2算法？ S2 来解决多维空间点索引的问题的
s2有30级，geohash只有12级。s2的层级变化较平缓，方便选择。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/4145e24ed89b36c129ca340f9fd8b7a7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-14T19:16:02+08:00" />
<meta property="article:modified_time" content="2021-05-14T19:16:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Google的S2算法原理以及使用Java版本--部分参考自《高效的多维空间点索引算法》</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">相关资料</a></li><li><a href="#1S2_37" rel="nofollow">1.S2算法是什么？</a></li><li><a href="#2S2_41" rel="nofollow">2.为什么要使用S2算法？</a></li><li><a href="#3S2_69" rel="nofollow">3.S2的原理是什么？</a></li><li><ul><li><a href="#1_71" rel="nofollow">1）球面坐标变换</a></li><li><a href="#2_105" rel="nofollow">2）球面坐标转平面坐标（降维）</a></li><li><ul><li><a href="#remark_148" rel="nofollow">remark:</a></li></ul> 
    </li><li><a href="#3_158" rel="nofollow">3）球面矩形投影修正</a></li><li><a href="#4_239" rel="nofollow">4）点与坐标轴点相互转换</a></li><li><a href="#5CellId_266" rel="nofollow">5）坐标轴点与CellId相互转换</a></li><li><ul><li><a href="#1_279" rel="nofollow">1.生成希尔伯特曲线</a></li><li><ul><li><a href="#1_310" rel="nofollow">1.解释变量。</a></li><li><a href="#2r0__1r0__1_371" rel="nofollow">2.r[0] &gt;&gt; 1和r[0] &amp; 1</a></li><li><a href="#3orientationposToOrientation0_377" rel="nofollow">3.orientation^posToOrientation[0]</a></li></ul> 
     </li><li><a href="#2pos__ij__443" rel="nofollow">2.pos 和 i，j 的转换关系</a></li><li><a href="#3S2_Cell_ID__457" rel="nofollow">3.S2 Cell ID 数据结构</a></li></ul> 
    </li><li><a href="#6_470" rel="nofollow">6）源码</a></li><li><a href="#7_519" rel="nofollow">7）举例</a></li></ul> 
   </li><li><a href="#4S2_578" rel="nofollow">4.S2如何使用？</a></li><li><ul><li><a href="#1__CellId_580" rel="nofollow">1）经纬度 转 CellId</a></li><li><a href="#2CellId___602" rel="nofollow">2）CellId 转 经纬度</a></li><li><a href="#3S2_627" rel="nofollow">3）S2计算距离</a></li><li><a href="#4S2_636" rel="nofollow">4）经纬度构建S2矩形</a></li><li><a href="#5S2_644" rel="nofollow">5）经纬度构建S2多边形</a></li><li><a href="#6_658" rel="nofollow">6）经纬度构建圆形</a></li><li><a href="#7S2_667" rel="nofollow">7）获取任意形状内所有S2块</a></li><li><a href="#8_686" rel="nofollow">8）判断点是否在任意形状内</a></li><li><a href="#9S2S2_695" rel="nofollow">9）不同等级S2块包含的S2子块</a></li><li><a href="#10cellIdlevel_719" rel="nofollow">10）判断当前cellId的level</a></li></ul> 
   </li><li><a href="#5S2GeoHash_741" rel="nofollow">5.S2与GeoHash的区别是什么？</a></li><li><a href="#6S2_753" rel="nofollow">6.S2使用工具类</a></li><li><ul><li><a href="#1WGS84Point_764" rel="nofollow">1）WGS84Point类，存经纬度</a></li><li><a href="#2Tuple2_793" rel="nofollow">2）Tuple2自定义元组，存经纬度</a></li><li><a href="#3S2UtilAPI_827" rel="nofollow">3）S2Util，部分API示例</a></li><li><a href="#4TestS2Util_1039" rel="nofollow">4）TestS2Util测试类</a></li></ul> 
   </li><li><a href="#7S2_1109" rel="nofollow">7.S2精度表</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>相关资料</h3> 
<ol><li> <p>halfrost 的 git 仓库，包含空间搜索系列文章：https://github.com/halfrost/Halfrost-Field</p> </li><li> <p>s2 官网：https://s2geometry.io</p> </li><li> <p>s2 地图/可视化工具（功能强大，强烈推荐）： http://s2.sidewalklabs.com/regioncoverer/</p> </li><li> <p>经纬度画圆/画矩形 地图/可视化工具 ：https://www.mapdevelopers.com/draw-circle-tool.php</p> </li><li> <p>经纬度画多边形 地图/可视化工具 ：http://apps.headwallphotonics.com</p> </li><li> <p>csdn参考文章：Google S2 常用操作 ：https://blog.csdn.net/deng0515001/article/details/88031153</p> </li><li> <p>S2官方PPT:https://docs.google.com/presentation/d/1Hl4KapfAENAOf4gv-pSngKwvS_jwNVHRPZTTDzXXn6Q/view#slide=id.i0</p> </li><li> <p>S2jar:使用Maven工具</p> <pre><code class="prism language-java">		<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>google的S2包<span class="token operator">--</span><span class="token operator">&gt;</span>
		<span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
			<span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>io<span class="token punctuation">.</span>sgr<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
			<span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>s2<span class="token operator">-</span>geometry<span class="token operator">-</span>library<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
			<span class="token generics function"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

		<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>附带的google common组件包<span class="token operator">--</span><span class="token operator">&gt;</span>
		<span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
			<span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>guava<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
			<span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>guava<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
			<span class="token generics function"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">21.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> <p>​<br> 直接下载源码，自己打jar,地址：https://github.com/google/s2-geometry-library-java<br> ​</p> </li></ol> 
<h3><a id="1S2_37"></a>1.S2算法是什么？</h3> 
<p>​ S2其实是来自几何数学中的一个数学符号 S²，它表示的是单位球。S2 这个库其实是被设计用来解决球面上各种几何问题的。</p> 
<h3><a id="2S2_41"></a>2.为什么要使用S2算法？</h3> 
<p>S2 来解决多维空间点索引的问题的</p> 
<ol><li> <p>s2有30级，geohash只有12级。s2的层级变化较平缓，方便选择。</p> </li><li> <p>s2功能强大，解决了向量计算，面积计算，多边形覆盖，距离计算等问题，减少了开发工作量。</p> </li><li> <p><strong>s2解决了多边形覆盖问题</strong>。</p> <p>​ 这是其与geohash功能上最本质的不同。给定不规则范围，s2可以计算出一个多边形近似覆盖这个范围。其覆盖用的格子数量根据精确度可控。geohash在这方面十分不友好，划定一个大一点的区域，其格子数可能达到数千，若减少格子数则丢失精度，查询区域过大。<br> 如下，在min level和max level不变的情况下，只需设置可接受的max cells数值，即可控制覆盖精度。而且其cell的region大小自动适配。geohash要在如此大范围实现高精度覆盖则会产生极为庞大的网格数。<br> 另外需要注意的是,在minLevel,maxLevel,maxCells这3个参数中,不一定能完全满足.一般而言是优先满足maxLevel即最精细的网格大小,再尽可能控制cell数量在maxCells里面.而minLevel由于会合并网格,所以很难满足(在查询大区域的时候可能会出现一个大网格和很多个小网格,导致木桶效应.这个时候可能将大网格划分为指定等级的小网格,即最终效果为,<strong>严格遵循minLevel和maxLevel,为此牺牲maxCells</strong>)</p> <p>​</p> <p>eg：9个格子，maxcells为：10</p> <p><img src="https://images2.imgbox.com/aa/94/CvLytF4P_o.png" alt="在这里插入图片描述"></p> <p>​</p> <p>eg：34个格子，maxcells为：45</p> <p><img src="https://images2.imgbox.com/fb/7d/d6Ksy59p_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="3S2_69"></a>3.S2的原理是什么？</h3> 
<h4><a id="1_71"></a>1）球面坐标变换</h4> 
<pre><code class="prism language-java"><span class="token comment">//经纬度转弧度计算球面坐标</span>
S2LatLng ll <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span><span class="token number">36.683</span><span class="token punctuation">,</span> <span class="token number">117.1412</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//弧度转角度乘以 π / 180°</span>
<span class="token comment">//角度转弧度乘以 180°/π</span>

S2Point point <span class="token operator">=</span> ll<span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>​ 球面上的一个点，在直角坐标系中，可以这样表示：</p> 
<p><img src="https://images2.imgbox.com/99/0d/dHR1BlTg_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">x <span class="token operator">=</span> r <span class="token operator">*</span> sin θ <span class="token operator">*</span> cos φ
y <span class="token operator">=</span> r <span class="token operator">*</span> sin θ <span class="token operator">*</span> sin φ 
z <span class="token operator">=</span> r <span class="token operator">*</span> cos θ
</code></pre> 
<p><img src="https://images2.imgbox.com/db/55/4wsDRqZq_o.png" alt="在这里插入图片描述"></p> 
<p>​ 再进一步，我们可以和球面上的经纬度联系起来。不过这里需要注意的是，纬度的角度 α 和直角坐标系下的球面坐标 θ 加起来等于 90°。所以三角函数要注意转换。</p> 
<p>​ 于是地球上任意的一个经纬度的点，就可以转换成 f(x,y,z)。</p> 
<p>​ 在 S2 中，地球半径被当成单位 1 了。所以半径不用考虑。x，y，z的值域都被限定在了[-1,1] x [-1,1] x [-1,1]这个区间之内了。</p> 
<h4><a id="2_105"></a>2）球面坐标转平面坐标（降维）</h4> 
<pre><code class="prism language-java"><span class="token comment">//投影</span>
<span class="token keyword">int</span> face <span class="token operator">=</span> S2Projections<span class="token punctuation">.</span><span class="token function">xyzToFace</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
R2Vector vector <span class="token operator">=</span> S2Projections<span class="token punctuation">.</span><span class="token function">validFaceXyzToUv</span><span class="token punctuation">(</span>face<span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>​ 首先在地球外面套了一个外切的正方体，如下图:</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-FiBcpuxp-1620986757996)(C:\Users\余祥超\Desktop\notes\googleS2Img\球面外切正方形.png)]</p> 
<p>​ 从球心向外切正方体6个面分别投影。S2 是把球面上所有的点都投影到外切正方体的6个面上。</p> 
<p><img src="https://images2.imgbox.com/15/8b/NlGKs4jr_o.png" alt="在这里插入图片描述"></p> 
<p>​ 这里简单的画了一个投影图，上图左边的是投影到正方体一个面的示意图，实际上影响到的球面是右边那张图。</p> 
<p><img src="https://images2.imgbox.com/dc/10/C5ar8oMC_o.png" alt="在这里插入图片描述"></p> 
<p>​ 从侧面看，其中一个球面投影到正方体其中一个面上，边缘与圆心的连线相互之间的夹角为90°，但是和x，y，z轴的角度是45°。我们可以在球的6个方向上，把45°的辅助圆画出来，见下图左边。</p> 
<p><img src="https://images2.imgbox.com/34/76/UtntSiHH_o.png" alt="在这里插入图片描述"></p> 
<p>​ 上图左边的图画了6个辅助线，蓝线是前后一对，红线是左右一对，绿线是上下一对。分别都是45°的地方和圆心连线与球面相交的点的轨迹。这样我们就可以把投影到外切正方体6个面上的球面画出来，见上图右边。</p> 
<p>​ 投影到正方体以后，我们就可以把这个正方体展开了。</p> 
<p><img src="https://images2.imgbox.com/27/e2/7RL5hD7l_o.png" alt="在这里插入图片描述"></p> 
<p>​ 在 Google S2 中，它是把地球展开成如下的样子：</p> 
<p><img src="https://images2.imgbox.com/a3/dc/6OkVvFeP_o.jpg" alt="在这里插入图片描述"></p> 
<p>​ 这样第一步的球面坐标进一步的被转换成 f(x,y,z) -&gt; g(face,u,v)，face是正方形的六个面，u，v对应的是六个面中的一个面上的x，y坐标。</p> 
<h5><a id="remark_148"></a>remark:</h5> 
<p>​ 1.默认定义 x 轴为0，y轴为1，z轴为2 。</p> 
<p>​ 2.最后 face 的值就是三个轴里面最长的轴，注意这里限定了他们三者都在 [0,5] 之间，所以如果是负轴就需要 + 3 进行修正。</p> 
<p>​ 3.主轴为 x 正半轴，face = 0；主轴为 y 正半轴，face = 1；主轴为 z 正半轴，face = 2；主轴为 x 负半轴，face = 3；主轴为 y 负半轴，face = 4；主轴为 z 负半轴，face = 5 。</p> 
<p>​ 4.如果直观的对应一个外切立方体的哪6个面，那就是 face = 0 对应的是前面，face = 1 对应的是右面，face = 2 对应的是上面，face = 3 对应的是后面，face = 4 对应的是左面，face = 5 对应的是下面。</p> 
<h4><a id="3_158"></a>3）球面矩形投影修正</h4> 
<pre><code class="prism language-java"><span class="token comment">//face是不变的，修正</span>
<span class="token keyword">double</span> s <span class="token operator">=</span> S2Projections<span class="token punctuation">.</span><span class="token function">uvToST</span><span class="token punctuation">(</span>vector<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> t <span class="token operator">=</span> S2Projections<span class="token punctuation">.</span><span class="token function">uvToST</span><span class="token punctuation">(</span>vector<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>​ 上一步我们把球面上的球面矩形投影到正方形的某个面上，形成的形状类似于矩形，但是由于球面上角度的不同，最终会导致即使是投影到同一个面上，每个矩形的面积也不大相同。</p> 
<p><img src="https://images2.imgbox.com/92/68/qxKbWNU0_o.png" alt="在这里插入图片描述"></p> 
<p>​ 上图就表示出了球面上个一个球面矩形投影到正方形一个面上的情况。</p> 
<p><img src="https://images2.imgbox.com/76/be/P9moP1v0_o.png" alt="在这里插入图片描述"></p> 
<p>​ 经过实际计算发现，最大的面积和最小的面积相差5.2倍。见上图左边。相同的弧度区间，在不同的纬度上投影到正方形上的面积不同。</p> 
<p>​ 现在就需要修正各个投影出来形状的面积。如何选取合适的映射修正函数就成了关键。目标是能达到上图右边的样子，让各个矩形的面积尽量相同。</p> 
<p><img src="https://images2.imgbox.com/d0/40/npfFQVmG_o.png" alt="在这里插入图片描述"></p> 
<p>​ 线性变换是最快的变换，但是变换比最小。tan() 变换可以使每个投影以后的矩形的面积更加一致，最大和最小的矩形比例仅仅只差0.414。可以说非常接近了。但是 tan() 函数的调用时间非常长。如果把所有点都按照这种方式计算的话，性能将会降低3倍。</p> 
<p>​ 最后谷歌选择的是二次变换，这是一个近似切线的投影曲线。它的计算速度远远快于 tan() ，大概是 tan() 计算的3倍速度。生成的投影以后的矩形大小也类似。不过最大的矩形和最小的矩形相比依旧有2.082的比率。</p> 
<p>​ 上表中，ToPoint 和 FromPoint 分别是把单位向量转换到 Cell ID 所需要的毫秒数、把 Cell ID 转换回单位向量所需的毫秒数（Cell ID 就是投影到正方体六个面，某个面上矩形的 ID，矩形称为 Cell，它对应的 ID 称为 Cell ID）。ToPointRaw 是某种目的下，把 Cell ID 转换为非单位向量所需的毫秒数。</p> 
<p><strong>S2的矩形面积修正源码</strong></p> 
<pre><code class="prism language-java">	<span class="token comment">//S2_LINEAR_PROJECTION 线性变换，未实现</span>
	<span class="token comment">//sttoUV    return 2 * s - 1</span>
    <span class="token comment">//uvToST    return 0.5 * (u + 1);</span>
	<span class="token comment">//S2_TAN_PROJECTION tan()变换</span>
	<span class="token comment">//S2_QUADRATIC_PROJECTION 二次变换</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">strictfp</span> <span class="token keyword">double</span> <span class="token function">stToUV</span><span class="token punctuation">(</span><span class="token keyword">double</span> s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>S2_PROJECTION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> S2_LINEAR_PROJECTION<span class="token operator">:</span>
            <span class="token keyword">return</span> s<span class="token punctuation">;</span>
        <span class="token keyword">case</span> S2_TAN_PROJECTION<span class="token operator">:</span>
            s <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">tan</span><span class="token punctuation">(</span><span class="token number">0.7853981633974483D</span> <span class="token operator">*</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> s <span class="token operator">+</span> <span class="token number">1.1102230246251565E-16D</span> <span class="token operator">*</span> s<span class="token punctuation">;</span>
        <span class="token keyword">case</span> S2_QUADRATIC_PROJECTION<span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token number">0.0D</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token number">0.3333333333333333D</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1.0D</span> <span class="token operator">+</span> s<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0D</span> <span class="token operator">+</span> s<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token number">0.3333333333333333D</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0D</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1.0D</span> <span class="token operator">-</span> s<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0D</span> <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Invalid value for S2_PROJECTION"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">strictfp</span> <span class="token keyword">double</span> <span class="token function">uvToST</span><span class="token punctuation">(</span><span class="token keyword">double</span> u<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>S2_PROJECTION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> S2_LINEAR_PROJECTION<span class="token operator">:</span>
            <span class="token keyword">return</span> u<span class="token punctuation">;</span>
        <span class="token keyword">case</span> S2_TAN_PROJECTION<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token number">1.2732395447351628D</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">atan</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> S2_QUADRATIC_PROJECTION<span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">&gt;=</span> <span class="token number">0.0D</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">1.0D</span> <span class="token operator">+</span> <span class="token number">3.0D</span> <span class="token operator">*</span> u<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0D</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token number">1.0D</span> <span class="token operator">-</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">1.0D</span> <span class="token operator">-</span> <span class="token number">3.0D</span> <span class="token operator">*</span> u<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Invalid value for S2_PROJECTION"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>​ 经过修正变换以后，u，v都变换成了s，t。值域也发生了变化。u，v的值域是[-1,1]，变换以后，使s，t的值域是[0,1]。</p> 
<p>​ 至此，小结一下，球面上的点S(lat,lng) -&gt; f(x,y,z) -&gt; g(face,u,v) -&gt; h(face,s,t)。目前总共转换了4步，球面经纬度坐标转换成球面xyz坐标，再转换成外切正方体投影面上的坐标，最后变换成修正后的坐标。</p> 
<h4><a id="4_239"></a>4）点与坐标轴点相互转换</h4> 
<pre><code class="prism language-java"><span class="token keyword">int</span> i <span class="token operator">=</span> S2CellId<span class="token punctuation">.</span><span class="token function">stToIJ</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> j <span class="token operator">=</span> S2CellId<span class="token punctuation">.</span><span class="token function">stToIJ</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>​ 在 S2 算法中，默认划分 Cell 的等级是30，也就是说把一个正方形划分为 2^30 * 2^30个小的正方形。</p> 
<p>那么上一步的s，t映射到这个正方形上面来，对应该如何转换呢？</p> 
<p><img src="https://images2.imgbox.com/99/73/WSFMGBLB_o.png" alt="在这里插入图片描述"></p> 
<p>​ s，t的值域是[0,1]，现在值域要扩大到[0,2<sup>30</sup>-1]。</p> 
<p><strong>S2源码</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">strictfp</span> <span class="token keyword">int</span> <span class="token function">stToIJ</span><span class="token punctuation">(</span><span class="token keyword">double</span> s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">536870912</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span>L<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1073741823</span>L<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">5.36870912E8D</span> <span class="token operator">*</span> s <span class="token operator">+</span> <span class="token number">5.368709115E8D</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>​ 到这一步，是h(face,s,t) -&gt; H(face,i,j)。</p> 
<h4><a id="5CellId_266"></a>5）坐标轴点与CellId相互转换</h4> 
<pre><code class="prism language-java">S2CellId cellid <span class="token operator">=</span> S2CellId<span class="token punctuation">.</span><span class="token function">fromFaceIJ</span><span class="token punctuation">(</span>face<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>

S2LatLng lan <span class="token operator">=</span> cellid<span class="token punctuation">.</span><span class="token function">toLatLng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/6f/e4/gKUgRNxJ_o.gif" alt="在这里插入图片描述"></p> 
<h5><a id="1_279"></a>1.生成希尔伯特曲线</h5> 
<pre><code class="prism language-java">    <span class="token keyword">static</span> <span class="token keyword">int</span> lookupBits <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> swapMask <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> invertMask <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>

	<span class="token comment">//在整个库中，没有使用</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> ijToPos<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//  标准顺序</span>
                    <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 轴旋转	</span>
                    <span class="token punctuation">{<!-- --></span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 上下倒置</span>
                    <span class="token punctuation">{<!-- --></span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 轴旋转左右倒置</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">//数组存的值是ij组合的二进制的数值，表示方向</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> posToIJ<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 标准顺序:    (0,0), (0,1), (1,1), (1,0)</span>
            <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 轴旋转:       (0,0), (1,0), (1,1), (0,1)</span>
            <span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 上下倒置:      (1,1), (1,0), (0,0), (0,1)</span>
            <span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 轴旋转左右倒置: (1,1), (0,1), (0,0), (1,0)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">//posToOrientation 数组里面装了4个数字，分别是1,0,0,3，表示子格子的方向</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> posToOrientation<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>swapMask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> invertMask <span class="token operator">|</span> swapMask<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//1 | 2=3</span>
    <span class="token comment">//希尔伯特曲线 ID 转换成坐标轴 IJ 的转换表</span>
	<span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lookupIJ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> lookupBits <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//1&lt;&lt;10=2^10=1024</span>
    <span class="token comment">//坐标轴 IJ 转换成希尔伯特曲线 ID 的转换表</span>
	<span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lookupPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> lookupBits <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="1_310"></a>1.解释变量。</h6> 
<p>posToIJ 代表的是一个矩阵，里面记录了一些单元希尔伯特曲线的位置信息。</p> 
<p><strong>注意在下面一阶曲线中：横着的是i,竖着的是j</strong></p> 
<p>把 posToIJ 数组里面的信息用图表示出来，如下图：</p> 
<p><img src="https://images2.imgbox.com/c5/58/m7TU1SyC_o.png" alt="在这里插入图片描述"></p> 
<p>从上面这四张图我们可以看出：<br> <strong>posToIJ 的四张图其实是“ U ” 字形逆时针分别旋转90°得到的。这里我们只能看出四张图相互之间的联系，即兄弟之间的联系，但是看不到父子图相互之间的联系。</strong></p> 
<p>同理，把 ijToPos 数组里面的信息用图表示出来，如下图：</p> 
<p><img src="https://images2.imgbox.com/30/42/yYPQs1sT_o.png" alt="在这里插入图片描述"></p> 
<p>​ 这里是初始化的递归函数，在希尔伯特曲线的标准顺序中可以看到是有4个格子，并且格子都有顺序的，所以初始化要遍历满所有顺序。入参的第4个参数origOrientation，就是从0 - 3 。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">initLookupCell</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initLookupCell</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> swapMask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> swapMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initLookupCell</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> invertMask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> invertMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initLookupCell</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> swapMask <span class="token operator">|</span> invertMask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> swapMask <span class="token operator">|</span> invertMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 下面这个函数是生成希尔伯特曲线的。我们可以看到有一处对 <code>pos &lt;&lt; 2</code>的操作，这里是把位置变换到第一个4个小格子中，所以位置乘以了4。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initLookupCell</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">,</span> <span class="token keyword">int</span> origOrientation<span class="token punctuation">,</span> <span class="token keyword">int</span> pos<span class="token punctuation">,</span> <span class="token keyword">int</span> orientation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">==</span> lookupBits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> ij <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;&lt;</span> lookupBits<span class="token punctuation">)</span> <span class="token operator">+</span> j<span class="token punctuation">;</span>
        lookupPos<span class="token punctuation">[</span><span class="token punctuation">(</span>ij <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> origOrientation<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> orientation<span class="token punctuation">;</span>
        lookupIJ<span class="token punctuation">[</span><span class="token punctuation">(</span>pos <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> origOrientation<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ij <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> orientation<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    level<span class="token operator">++</span><span class="token punctuation">;</span>
    i <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    j <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    pos <span class="token operator">&lt;&lt;=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> r<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> posToIJ<span class="token punctuation">[</span>orientation<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">initLookupCell</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> origOrientation<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> orientation <span class="token operator">^</span> posToOrientation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initLookupCell</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> origOrientation<span class="token punctuation">,</span> pos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> orientation <span class="token operator">^</span> posToOrientation<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initLookupCell</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> origOrientation<span class="token punctuation">,</span> pos <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> orientation <span class="token operator">^</span> posToOrientation<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initLookupCell</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> origOrientation<span class="token punctuation">,</span> pos <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> orientation <span class="token operator">^</span> posToOrientation<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>

</code></pre> 
<h6><a id="2r0__1r0__1_371"></a>2.r[0] &gt;&gt; 1和r[0] &amp; 1</h6> 
<p>​ r 数组来自于 posToIJ 数组。posToIJ 数组上面说过了，它里面装的其实是4个不同方向的“ U ”字。相当于表示了当前四个小方格兄弟相互之间的方向。r[0]、r[1]、r[2]、r[3] 取出的其实就是 00，01，10，11 这4个数。</p> 
<p>​ 那么 r[0]&gt;&gt;1 操作就是取出二位二进制位的前一位，即 i 位。r[0]&amp;1 操作就是取出二位二进制位的后一位，即 j 位。r[1]、r[2]、r[3] 同理。</p> 
<h6><a id="3orientationposToOrientation0_377"></a>3.orientation^posToOrientation[0]</h6> 
<pre><code class="prism language-java">posToOrientation<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>swapMask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> invertMask <span class="token operator">|</span> swapMask<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//数值代入：</span>
posToOrientation <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token keyword">int</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>

<span class="token comment">//根据上一次的原始的方向推算出当前的 pos 所在的方向。即计算父子之间关系。</span>
orientation<span class="token operator">^</span>posToOrientation<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token comment">//举个例子，假设 orientation = 0，即图0，那么：</span>

<span class="token number">00</span> <span class="token operator">^</span> <span class="token number">01</span> <span class="token operator">=</span> <span class="token number">01</span>
<span class="token number">00</span> <span class="token operator">^</span> <span class="token number">00</span> <span class="token operator">=</span> <span class="token number">00</span>
<span class="token number">00</span> <span class="token operator">^</span> <span class="token number">00</span> <span class="token operator">=</span> <span class="token number">00</span>
<span class="token number">00</span> <span class="token operator">^</span> <span class="token number">11</span> <span class="token operator">=</span> <span class="token number">11</span>

<span class="token comment">//图0 的四个孩子的方向就被我们算出来了，01，00，00，11，1003 。和上面图片中图0展示的是一致的。</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/01/4d/Blp0Vfeq_o.png" alt="在这里插入图片描述"></p> 
<p>其实这个对应的就是 图0 中4个小方块接下来再划分的方向。</p> 
<p>​ 图0 中0号的位置下一个图的方向应该是图1，即01；</p> 
<p>​ 图0 中1号的位置下一个图的方向应该是图0，即00；</p> 
<p>​ 图0 中2号的位置下一个图的方向应该是图0，即00；</p> 
<p>​ 图0 中3号的位置下一个图的方向应该是图3，即11 。</p> 
<p>​ 这就是初始化 posToOrientation 数组里面的玄机了。</p> 
<p>​ <strong>posToIJ 的四张图我们只能看出兄弟之间的关系，那么 posToOrientation 的四张图让我们知道了父子之间的关系。</strong></p> 
<p>eg:</p> 
<pre><code class="prism language-java">
<span class="token comment">//orientation = 1，orientation = 2，orientation = 3，都是同理的：</span>

<span class="token number">01</span> <span class="token operator">^</span> <span class="token number">01</span> <span class="token operator">=</span> <span class="token number">00</span>
<span class="token number">01</span> <span class="token operator">^</span> <span class="token number">00</span> <span class="token operator">=</span> <span class="token number">01</span>
<span class="token number">01</span> <span class="token operator">^</span> <span class="token number">00</span> <span class="token operator">=</span> <span class="token number">01</span>
<span class="token number">01</span> <span class="token operator">^</span> <span class="token number">11</span> <span class="token operator">=</span> <span class="token number">10</span>

<span class="token number">10</span> <span class="token operator">^</span> <span class="token number">01</span> <span class="token operator">=</span> <span class="token number">11</span>
<span class="token number">10</span> <span class="token operator">^</span> <span class="token number">00</span> <span class="token operator">=</span> <span class="token number">10</span>
<span class="token number">10</span> <span class="token operator">^</span> <span class="token number">00</span> <span class="token operator">=</span> <span class="token number">10</span>
<span class="token number">10</span> <span class="token operator">^</span> <span class="token number">11</span> <span class="token operator">=</span> <span class="token number">01</span>

<span class="token number">11</span> <span class="token operator">^</span> <span class="token number">01</span> <span class="token operator">=</span> <span class="token number">10</span>
<span class="token number">11</span> <span class="token operator">^</span> <span class="token number">00</span> <span class="token operator">=</span> <span class="token number">11</span>
<span class="token number">11</span> <span class="token operator">^</span> <span class="token number">00</span> <span class="token operator">=</span> <span class="token number">11</span>
<span class="token number">11</span> <span class="token operator">^</span> <span class="token number">11</span> <span class="token operator">=</span> <span class="token number">00</span>

<span class="token comment">//图1孩子的方向是0，1，1，2 。图2孩子的方向是3，2，2，1 。图3孩子的方向是2，3，3，0 。和图上画的是完全一致的。</span>
</code></pre> 
<p><strong>注意：</strong><br> <strong>i，j 并不是直接对应的 希尔伯特曲线 坐标系上的坐标。因为初始化需要生成的是五阶希尔伯特曲线</strong></p> 
<p>​ pos 参数对应的就是希尔伯特曲线坐标系上的坐标。一旦一个希尔伯特曲线的起始点和阶数确定以后，四个小方块组成的一个大方块的 pos 位置确定以后，那么它的坐标其实就已经确定了。希尔伯特曲线上的坐标并不依赖 i，j，完全是由曲线的性质和 pos 位置决定的。</p> 
<h5><a id="2pos__ij__443"></a>2.pos 和 i，j 的转换关系</h5> 
<p>​ 初始化计算 lookupPos 数组和 lookupIJ 数组有什么用呢？这两个数组就是把 i，j 和 pos 联系起来的数组。知道 pos 以后可以立即找到对应的 i，j。知道 i，j 以后可以立即找到对应的 pos。</p> 
<p>​ 将 i，j 分别4位4位的取出来，i 的4位二进制位放前面，j 的4位二进制位放后面。最后再加上希尔伯特曲线的方向位 orientation 的2位。组成 iiii jjjj oo 类似这样的10位二进制位。通过 lookupPos 数组这个桥梁，找到对应的 pos 的值。pos 的值就是对应希尔伯特曲线上的位置。然后依次类推，再取出 i 的4位，j 的4位进行这样的转换，直到所有的 i 和 j 的二进制都取完了，最后把这些生成的 pos 值安全先生成的放在高位，后生成的放在低位的方式拼接成最终的 CellID。</p> 
<p>​ 在 Google S2 中，i，j 每次转换都是4位，所以 i，j 的有效值取值是 0 - 15，所以 iiii jjjj oo 是一个十位的二进制的数，能表示的范围是 2^10 = 1024 。那么 pos 初始化值也需要计算到 1024 。由于 pos 是4个小方块组成的大方块，它本身就是一个一阶的希尔伯特曲线。所以初始化需要生成一个五阶的希尔伯特曲线。</p> 
<p><img src="https://images2.imgbox.com/7e/4b/BKyMpIlf_o.png" alt="在这里插入图片描述"></p> 
<p><strong>remark:</strong></p> 
<p>​ 为何要 iiii jjjj oo 这样设计，为何是4位4位的，谷歌开发者在注释里面这样写道：“我们曾经考虑过一次组合 16 位，14位的 position + 2位的 orientation，但是代码实际运行起来发现小数组拥有更好的性能，2KB 更加适合存储到主 cache 中。</p> 
<h5><a id="3S2_Cell_ID__457"></a>3.S2 Cell ID 数据结构</h5> 
<p><img src="https://images2.imgbox.com/a8/6b/hQdygKOt_o.png" alt="在这里插入图片描述"></p> 
<p>上图左图中对应的是 Level 30 的情况，右图对应的是 Level 24 的情况。(2的多少次方，角标对应的也就是 Level 的值)</p> 
<p>在 S2 中，每个 CellID 是由64位的组成的。可以用一个 uint64 存储。开头的3位表示正方体6个面中的一个，取值范围[0,5]。3位可以表示0-7，但是6，7是无效值。</p> 
<p>64位的最后一位是1，这一位是特意留出来的。用来快速查找中间有多少位。从末尾最后一位向前查找，找到第一个不为0的位置，即找到第一个1。这一位的前一位到开头的第4位（因为前3位被占用）都是可用数字。</p> 
<p>绿色格子有多少个就能表示划分多少格。上图左图，绿色的有60个格子，于是可以表示[0,2<sup>30</sup> -1] * [0,2<sup>30</sup> -1]这么多个格子。上图右图中，绿色格子只有48个，那么就只能表示[0,2<sup>24</sup> -1]*[0,2<sup>24</sup> -1]这么多个格子。</p> 
<h4><a id="6_470"></a>6）源码</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">strictfp</span> S2CellId <span class="token function">fromLatLng</span><span class="token punctuation">(</span>S2LatLng ll<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">fromPoint</span><span class="token punctuation">(</span>ll<span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">strictfp</span> S2CellId <span class="token function">fromPoint</span><span class="token punctuation">(</span>S2Point p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> face <span class="token operator">=</span> S2Projections<span class="token punctuation">.</span><span class="token function">xyzToFace</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        R2Vector uv <span class="token operator">=</span> S2Projections<span class="token punctuation">.</span><span class="token function">validFaceXyzToUv</span><span class="token punctuation">(</span>face<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">stToIJ</span><span class="token punctuation">(</span>S2Projections<span class="token punctuation">.</span><span class="token function">uvToST</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token function">stToIJ</span><span class="token punctuation">(</span>S2Projections<span class="token punctuation">.</span><span class="token function">uvToST</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">fromFaceIJ</span><span class="token punctuation">(</span>face<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">strictfp</span> S2CellId <span class="token function">fromFaceIJ</span><span class="token punctuation">(</span><span class="token keyword">int</span> face<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> n <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span>L<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>face <span class="token operator">&lt;&lt;</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> bits <span class="token operator">=</span> face <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> k <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            bits <span class="token operator">=</span> <span class="token function">getBits</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        S2CellId s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2CellId</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体步骤如下：</p> 
<ol><li> <p>将 face 左移 60 位。</p> </li><li> <p>计算初始的 origOrientation。初始的 origOrientation 是 face 转换得来的，face &amp; 01 以后的结果是为了使每个面都有一个右手坐标系。</p> </li><li> <p>循环，从头开始依次取出 i ，j 的4位二进制位，计算出 ij&lt;&lt;2 + origOrientation，然后查 lookupPos 数组找到对应的 pos&lt;&lt;2 + orientation 。</p> </li><li> <p>拼接 CellID，右移 pos&lt;&lt;2 + orientation 2位，只留下 pos ，把pos 继续拼接到 上次循环的 CellID 后面。</p> </li><li> <p>计算下一个循环的 origOrientation。&amp;= (swapMask | invertMask) 即 &amp; 11，也就是取出末尾的2位二进制位。</p> </li><li> <p>最后拼接上最后一个标志位 1 .</p> </li></ol> 
<p>注意：由于 CellID 是64位的，头三位是 face ，末尾一位是标志位，所以中间有 60 位。i,j 转换成二进制是30位的。7个4位二进制位和1个2位二进制位。4*7 + 2 = 30 。iijjoo ，即 i 的头2个二进制位和 j 的头2个二进制位加上 origOrientation，这样组成的是6位二进制位，最多能表示 2<sup>6</sup> = 32，转换出来的 pos + orientation 最多也是32位的。即转换出来最多也是6位的二进制位，除去末尾2位 orientation ，所以 pos 在这种情况下最多是 4位。iiiijjjjpppp，即 i 的4个二进制位和 j 的4个二进制位加上 origOrientation，这样组成的是10位二进制位，最多能表示 2<sup>10</sup> = 1024，转换出来的 pos + orientation 最多也是10位的。即转换出来最多也是10位的二进制位，除去末尾2位 orientation ，所以 pos 在这种情况下最多是 8位。</p> 
<p>​ 由于最后 CellID 只拼接 pos ，所以 4 + 7 * 8 = 60 位。拼接完成以后，中间的60位都由 pos 组成的。最后拼上头3位，末尾的1位标志位，64位的 CellID 就这样生成了。</p> 
<h4><a id="7_519"></a>7）举例</h4> 
<p>最后举个具体的完整的例子：</p> 
<table><thead><tr><th></th><th>纬度</th><th></th><th>经度</th></tr></thead><tbody><tr><td>直角坐标系</td><td>-0.209923466239598816018841</td><td>0.834295703289209877873134</td><td>0.509787031803590306999752</td></tr><tr><td>(face,u,v)</td><td>1</td><td>0.25161758044776666</td><td>0.6110387837235114</td></tr><tr><td>(face,s,t)</td><td>1</td><td>0.6623542747924445</td><td>0.8415931842598497</td></tr><tr><td>(face,i,j)</td><td>1</td><td>711197487</td><td>903653800</td></tr></tbody></table> 
<p>用表展示出每一步（表比较长，请右滑）：</p> 
<table><thead><tr><th></th><th>i</th><th>j</th><th>orientation</th><th>ij&lt;&lt;2 + origOrientation</th><th>pos&lt;&lt;2 + orientation</th><th>CellID</th></tr></thead><tbody><tr><td></td><td>711197487</td><td>903653800</td><td>1</td><td></td><td></td><td></td></tr><tr><td>对应二 进制</td><td>101010011001000000001100101111</td><td>110101110111001010100110101000</td><td>01</td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>进行转换</td><td>i 左移6位，给 j 的4位和方向位 orientation 2位留出位置</td><td>j 左移2位，给方向位 orientation 留出位置</td><td>orientation 初始值是 face 的值</td><td>[iiii jjjj oo] i的四位，j的四位，o的两位依次排在一起组成10位二进制位</td><td>从前面一列转换过来是通过查 lookupPos 数组查出来的</td><td>初始值：face 左移 60 位，接着以后每次循环都拼接 pos ，注意不带orientation ，即前一列需要右移2位去掉末尾的 orientation</td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>取 i , j 的首两位</td><td>10 000000</td><td>11 00</td><td>01</td><td>(00)10001101</td><td>101110</td><td>1101100000000000000000000000000000000000000000000000000000000</td></tr><tr><td>再取 i , j 的3，4，5，6位</td><td>1010 000000</td><td>0101 00</td><td>10</td><td>1010010110</td><td>111011110</td><td>1101101110111000000000000000000000000000000000000000000000000</td></tr><tr><td>再取 i , j 的7，8，9，10位</td><td>0110 000000</td><td>1101 00</td><td>10</td><td>(0)110110110</td><td>1110011110</td><td>1101101110111111001110000000000000000000000000000000000000000</td></tr><tr><td>再取 i , j 的11，12，13，14位</td><td>0100 000000</td><td>1100 00</td><td>10</td><td>(0)100110010</td><td>1110000001</td><td>1101101110111111001111110000000000000000000000000000000000000</td></tr><tr><td>再取 i , j 的15，16，17，18位</td><td>0000 000000</td><td>1010 00</td><td>01</td><td>(0000)101001</td><td>1110110000</td><td>1101101110111111001111110000011101100000000000000000000000000</td></tr><tr><td>再取 i , j 的19，20，21，22位</td><td>0011 000000</td><td>1001 00</td><td>00</td><td>(00)11100100</td><td>100011001</td><td>1101101110111111001111110000011101100010001100000000000000000</td></tr><tr><td>再取 i , j 的23，24，25，26位</td><td>0010 000000</td><td>1010 00</td><td>01</td><td>(00)10101001</td><td>1110001011</td><td>1101101110111111001111110000011101100010001101110001000000000</td></tr><tr><td>再取 i , j 的27，28，29，30位</td><td>1111 000000</td><td>1000 00</td><td>11</td><td>1111100011</td><td>1010110</td><td>1101101110111111001111110000011101100010001101110001000010101</td></tr><tr><td>最终结果</td><td></td><td></td><td></td><td></td><td></td><td>11011011101111110011111100000111011000100011011100010000101011(拼接上末尾的标志位1)</td></tr></tbody></table> 
<pre><code class="prism language-java"><span class="token comment">//eg后面一部转换过程推算</span>
pos<span class="token operator">&lt;&lt;</span><span class="token number">2</span> <span class="token operator">+</span> orientation   CellID
<span class="token number">0000101110</span> 	<span class="token number">1101100000000000000000000000000000000000000000000000000000000</span>
<span class="token number">0111011110</span> 	<span class="token number">1101101110111000000000000000000000000000000000000000000000000</span>
<span class="token number">1110011110</span> 	<span class="token number">1101101110111111001110000000000000000000000000000000000000000</span>

<span class="token comment">//去掉方向位，首位+  face</span>
<span class="token number">00001011</span> 	<span class="token number">1101100000000000000000000000000000000000000000000000000000000</span>
<span class="token number">01110111</span> 	<span class="token number">1101101110111000000000000000000000000000000000000000000000000</span>
<span class="token number">11100111</span> 	<span class="token number">1101101110111111001110000000000000000000000000000000000000000</span>

<span class="token comment">//反推，cellid,去掉首位face,</span>
<span class="token number">1011</span> <span class="token number">00000000000000000000000000000000000000000000000000000000</span>
<span class="token number">1011</span> <span class="token number">01110111</span> <span class="token number">000000000000000000000000000000000000000000000000</span>
<span class="token number">1011</span> <span class="token number">01110111</span> <span class="token number">11100111</span> <span class="token number">0000000000000000000000000000000000000000</span>

eg：
origOrientation初始值：<span class="token number">01</span> <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token operator">=</span><span class="token number">01</span>    face <span class="token operator">&amp;</span> <span class="token number">1</span>
后续计算：<span class="token number">01</span> <span class="token operator">^</span> <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">11</span>     与数组posToOrientation的值异或运算
<span class="token number">01</span>   <span class="token number">10</span>  <span class="token number">10</span>   <span class="token number">10</span>   <span class="token number">01</span>  <span class="token number">00</span>
<span class="token operator">^</span>    <span class="token operator">^</span>   <span class="token operator">^</span>    <span class="token operator">^</span>    <span class="token operator">^</span>   <span class="token operator">^</span>
<span class="token number">01</span>   <span class="token number">00</span>  <span class="token number">00</span>   <span class="token number">11</span>   <span class="token number">01</span>  <span class="token number">00</span>
<span class="token number">10</span>   <span class="token number">10</span>  <span class="token number">10</span>   <span class="token number">01</span>   <span class="token number">00</span>  <span class="token number">00</span>
</code></pre> 
<h3><a id="4S2_578"></a>4.S2如何使用？</h3> 
<h4><a id="1__CellId_580"></a>1）经纬度 转 CellId</h4> 
<pre><code class="prism language-java"><span class="token comment">//注意使用的是WGS84坐标（GPS导航坐标）</span>
<span class="token comment">//parent()可以指定等级，默认是30级</span>
<span class="token keyword">double</span> lat <span class="token operator">=</span> <span class="token number">36.683</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> lng <span class="token operator">=</span> <span class="token number">117.1412</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> currentlevel <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
S2LatLng s2LatLng <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span><span class="token punctuation">;</span>
S2CellId cellId <span class="token operator">=</span> S2CellId<span class="token punctuation">.</span><span class="token function">fromLatLng</span><span class="token punctuation">(</span>s2LatLng <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span>currentlevel<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//CellID(face=1, pos=15d0000000000000, level=4)</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CellID"</span> <span class="token operator">+</span> cellid<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token comment">//CellID.pos:1571756269952303104</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CellID.pos:"</span> <span class="token operator">+</span> cellid<span class="token punctuation">.</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">//CellID.id: 3877599279165997056,level:4</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CellID.id: "</span> <span class="token operator">+</span> cellid<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",level:"</span> <span class="token operator">+</span> cellid<span class="token punctuation">.</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h4><a id="2CellId___602"></a>2）CellId 转 经纬度</h4> 
<pre><code class="prism language-java">S2LatLng s2LatLng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2CellId</span><span class="token punctuation">(</span>cellId<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLatLng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Double lat <span class="token operator">=</span> s2LatLng<span class="token punctuation">.</span><span class="token function">latDegrees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Double lng <span class="token operator">=</span> s2LatLng<span class="token punctuation">.</span><span class="token function">lngDegrees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">//经纬度转S2LatLng</span>
S2LatLng s2LatLng <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//S2LatLng转S2CellId</span>
S2CellId cellId <span class="token operator">=</span> S2CellId<span class="token punctuation">.</span><span class="token function">fromLatLng</span><span class="token punctuation">(</span>s2LatLng<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//S2CellId转token</span>
String token<span class="token operator">=</span>s2CellId<span class="token punctuation">.</span><span class="token function">toToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//任意形状的所有S2块的token集合，可以借用工具在地图上显示</span>
<span class="token comment">//token转S2CellId</span>
S2CellId s2CellId <span class="token operator">=</span> S2CellId<span class="token punctuation">.</span><span class="token function">fromToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//S2LatLng转point</span>
S2Point point <span class="token operator">=</span> s2LatLng<span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//point转S2LatLng</span>
S2LatLng latLng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2LatLng</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="3S2_627"></a>3）S2计算距离</h4> 
<pre><code class="prism language-java">S2LatLng startS2 <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span><span class="token number">55.8241</span><span class="token punctuation">,</span> <span class="token number">137.8347</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
S2LatLng endS2 <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span><span class="token number">55.8271</span><span class="token punctuation">,</span> <span class="token number">137.8347</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> distance <span class="token operator">=</span> startS2<span class="token punctuation">.</span><span class="token function">getEarthDistance</span><span class="token punctuation">(</span>endS2<span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"距离为："</span><span class="token operator">+</span>distance<span class="token operator">+</span><span class="token string">" m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="4S2_636"></a>4）经纬度构建S2矩形</h4> 
<pre><code class="prism language-java">S2LatLng startS2 <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span><span class="token number">0.8293</span><span class="token punctuation">,</span> <span class="token number">72.004</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//左下角</span>
S2LatLng endS2 <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span><span class="token number">55.8271</span><span class="token punctuation">,</span> <span class="token number">137.8347</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//右上角</span>
S2LatLngRect rect  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2LatLngRect</span><span class="token punctuation">(</span>startS2<span class="token punctuation">,</span> endS2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="5S2_644"></a>5）经纬度构建S2多边形</h4> 
<pre><code class="prism language-java"><span class="token comment">//注意，一般需要多边形内侧，此处需要按照逆时针顺序添加。</span>
<span class="token comment">//多边形经纬度可借用工具获取</span>
List<span class="token generics function"><span class="token punctuation">&lt;</span>S2Point<span class="token punctuation">&gt;</span></span> pointList <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pointList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pointList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pointList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pointList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
S2Loop s2Loop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2Loop</span><span class="token punctuation">(</span>pointList<span class="token punctuation">)</span><span class="token punctuation">;</span>
S2Polygon s2Polygon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2Polygon</span><span class="token punctuation">(</span>s2Loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="6_658"></a>6）经纬度构建圆形</h4> 
<pre><code class="prism language-java"><span class="token keyword">double</span> radius <span class="token operator">=</span> <span class="token number">600.5</span><span class="token punctuation">;</span> <span class="token comment">//半径</span>
Double capHeight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> S2<span class="token punctuation">.</span>M_PI<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>radius <span class="token operator">/</span> <span class="token number">40075017</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//40075017为地球周长</span>
S2LatLng s2LatLng<span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span><span class="token punctuation">;</span>
S2Cap cap <span class="token operator">=</span> S2Cap<span class="token punctuation">.</span><span class="token function">fromAxisHeight</span><span class="token punctuation">(</span>s2LatLng<span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>capHeight <span class="token operator">*</span> capHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="7S2_667"></a>7）获取任意形状内所有S2块</h4> 
<pre><code class="prism language-java"><span class="token comment">//S2Region cap 任意区域</span>
S2RegionCoverer coverer  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2RegionCoverer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//最小格子和最大格子，总格子数量</span>
coverer<span class="token punctuation">.</span><span class="token function">setMaxLevel</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
coverer<span class="token punctuation">.</span><span class="token function">setMinLevel</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
coverer<span class="token punctuation">.</span><span class="token function">setMaxCells</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> coverer<span class="token punctuation">.</span><span class="token function">getCovering</span><span class="token punctuation">(</span>cap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cellIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>S2CellId s<span class="token operator">:</span>list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//可以用于区域内目标检索，根据cellid建立索引,查询区域内cellid in （list）的餐馆、出租车</span>


</code></pre> 
<h4><a id="8_686"></a>8）判断点是否在任意形状内</h4> 
<pre><code class="prism language-java"><span class="token comment">//S2Region cap 任意区域</span>
S2LatLng s2LatLng <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> contains <span class="token operator">=</span> cap<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>s2LatLng<span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>contains<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="9S2S2_695"></a>9）不同等级S2块包含的S2子块</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> <span class="token function">childrenCellId</span><span class="token punctuation">(</span>S2CellId s2CellId<span class="token punctuation">,</span> Integer desLevel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">childrenCellId</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">,</span> s2CellId<span class="token punctuation">.</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> desLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">//递归调用，每个格子一分为四</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> <span class="token function">childrenCellId</span><span class="token punctuation">(</span>S2CellId s2CellId<span class="token punctuation">,</span> Integer curLevel<span class="token punctuation">,</span> Integer desLevel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>curLevel <span class="token operator">&lt;</span> desLevel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//计算当前格子每个格子的差值</span>
            <span class="token keyword">long</span> interval <span class="token operator">=</span> <span class="token punctuation">(</span>s2CellId<span class="token punctuation">.</span><span class="token function">childEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s2CellId<span class="token punctuation">.</span><span class="token function">childBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span>
            List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> s2CellIds <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">long</span> id <span class="token operator">=</span> s2CellId<span class="token punctuation">.</span><span class="token function">childBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> interval <span class="token operator">*</span> i<span class="token punctuation">;</span>
                s2CellIds<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">childrenCellId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">S2CellId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> curLevel <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> desLevel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> s2CellIds<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="10cellIdlevel_719"></a>10）判断当前cellId的level</h4> 
<pre><code class="prism language-java"><span class="token function">getLevel</span><span class="token punctuation">(</span>cellId<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//判断当前cellId的level</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token keyword">long</span> input<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>input <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        input <span class="token operator">=</span> input <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
        n<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">30</span> <span class="token operator">-</span> n <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5S2GeoHash_741"></a>5.S2与GeoHash的区别是什么？</h3> 
<p>​ Geohash 有12级，从5000km 到 3.7cm。中间每一级的变化比较大。有时候可能选择上一级会大很多，选择下一级又会小一些。比如选择字符串长度为4，它对应的 cell 宽度是39.1km，需求可能是50km，那么选择字符串长度为5，对应的 cell 宽度就变成了156km，瞬间又大了3倍了。这种情况选择多长的 Geohash 字符串就比较难选。选择不好，每次判断可能就还需要取出周围的8个格子再次进行判断。Geohash 需要 12 bytes 存储（精度为12时）。</p> 
<p>​ S2 有30级，从 0.7cm² 到 85,000,000km² 。中间每一级的变化都比较平缓，接近于4次方的曲线。所以选择精度不会出现 Geohash 选择困难的问题。S2 的存储只需要一个 8个bytes 即可存下。</p> 
<p>​ S2 库里面不仅仅有地理编码，还有其他很多几何计算相关的库。地理编码只是其中的一小部分。本文没有介绍到的 S2 的实现还有很多很多，各种向量计算，面积计算，多边形覆盖，距离问题，球面球体上的问题，它都有实现。</p> 
<p>​ S2 还能解决多边形覆盖的问题。比如给定一个城市，求一个多边形刚刚好覆盖住这个城市。</p> 
<h3><a id="6S2_753"></a>6.S2使用工具类</h3> 
<p>主要包含3类方法：</p> 
<ol><li>getS2RegionByXXX<br> 获取给定经纬度坐标对应的S2Region,该region可用于获取cellId,或用于判断包含关系</li><li>getCellIdList<br> 获取给定region的cellId,并通过childrenCellId方法控制其严格遵守minLevel</li><li>contains<br> 对于指定S2Region,判断经纬度或CellToken是否在其范围内</li></ol> 
<h4><a id="1WGS84Point_764"></a>1）WGS84Point类，存经纬度</h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>leo<span class="token punctuation">.</span>test<span class="token punctuation">.</span>sd<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WGS84Point</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span>  Double latitude<span class="token punctuation">;</span>
    <span class="token keyword">private</span>  Double longitude<span class="token punctuation">;</span>

    <span class="token keyword">public</span> Double <span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> latitude<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> WGS84Point <span class="token function">setLatitude</span><span class="token punctuation">(</span>Double latitude<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>latitude <span class="token operator">=</span> latitude<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Double <span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> longitude<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> WGS84Point <span class="token function">setLongitude</span><span class="token punctuation">(</span>Double longitude<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>longitude <span class="token operator">=</span> longitude<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="2Tuple2_793"></a>2）Tuple2自定义元组，存经纬度</h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>leo<span class="token punctuation">.</span>test<span class="token punctuation">.</span>sd<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tuple2</span><span class="token generics function"><span class="token punctuation">&lt;</span>A<span class="token punctuation">,</span> B<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> A a<span class="token punctuation">;</span>
    <span class="token keyword">private</span> B b<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Tuple2<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token punctuation">&gt;</span></span> <span class="token function">tuple</span><span class="token punctuation">(</span>Double a<span class="token punctuation">,</span> Double b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Tuple2 tuple2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tuple2<span class="token punctuation">.</span><span class="token function">setA</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tuple2<span class="token punctuation">.</span><span class="token function">setB</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tuple2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setA</span><span class="token punctuation">(</span>A a<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setB</span><span class="token punctuation">(</span>B b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> A <span class="token function">getVal1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> B <span class="token function">getVal2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3S2UtilAPI_827"></a>3）S2Util，部分API示例</h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>leo<span class="token punctuation">.</span>test<span class="token punctuation">.</span>sd<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span>Lists<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> S2Util <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 实例
     */</span>
    INSTANCE<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> minLevel <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> maxLevel <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> maxCells <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> S2RegionCoverer COVERER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2RegionCoverer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        COVERER<span class="token punctuation">.</span><span class="token function">setMinLevel</span><span class="token punctuation">(</span>minLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        COVERER<span class="token punctuation">.</span><span class="token function">setMaxLevel</span><span class="token punctuation">(</span>maxLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        COVERER<span class="token punctuation">.</span><span class="token function">setMaxCells</span><span class="token punctuation">(</span>maxCells<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将单个cellId转换为多个指定level的cellId
     * @param s2CellId
     * @param desLevel
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> <span class="token function">childrenCellId</span><span class="token punctuation">(</span>S2CellId s2CellId<span class="token punctuation">,</span> Integer desLevel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">childrenCellId</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">,</span> s2CellId<span class="token punctuation">.</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> desLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> <span class="token function">childrenCellId</span><span class="token punctuation">(</span>S2CellId s2CellId<span class="token punctuation">,</span> Integer curLevel<span class="token punctuation">,</span> Integer desLevel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>curLevel <span class="token operator">&lt;</span> desLevel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> interval <span class="token operator">=</span> <span class="token punctuation">(</span>s2CellId<span class="token punctuation">.</span><span class="token function">childEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s2CellId<span class="token punctuation">.</span><span class="token function">childBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span>
            List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> s2CellIds <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">long</span> id <span class="token operator">=</span> s2CellId<span class="token punctuation">.</span><span class="token function">childBegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> interval <span class="token operator">*</span> i<span class="token punctuation">;</span>
                s2CellIds<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token function">childrenCellId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">S2CellId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> curLevel <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> desLevel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> s2CellIds<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将cellToken转换为经纬度
     * @param token
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Tuple2<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token punctuation">&gt;</span></span> <span class="token function">toLatLon</span><span class="token punctuation">(</span>String token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        S2LatLng latLng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2LatLng</span><span class="token punctuation">(</span>S2CellId<span class="token punctuation">.</span><span class="token function">fromToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span>latLng<span class="token punctuation">.</span><span class="token function">latDegrees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> latLng<span class="token punctuation">.</span><span class="token function">lngDegrees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将经纬度转换为cellId
     * @param lat
     * @param lon
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> S2CellId <span class="token function">toCellId</span><span class="token punctuation">(</span><span class="token keyword">double</span> lat<span class="token punctuation">,</span> <span class="token keyword">double</span> lon<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> S2CellId<span class="token punctuation">.</span><span class="token function">fromLatLng</span><span class="token punctuation">(</span>S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lon<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断region是否包含指定cellToken
     * @param region
     * @param cellToken
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">contains</span><span class="token punctuation">(</span>S2Region region<span class="token punctuation">,</span> String cellToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> region<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">S2Cell</span><span class="token punctuation">(</span>S2CellId<span class="token punctuation">.</span><span class="token function">fromToken</span><span class="token punctuation">(</span>cellToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断region是否包含指定经纬度坐标
     * @param region
     * @param lat
     * @param lon
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">contains</span><span class="token punctuation">(</span>S2Region region<span class="token punctuation">,</span> <span class="token keyword">double</span> lat<span class="token punctuation">,</span> <span class="token keyword">double</span> lon<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        S2LatLng s2LatLng <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> contains <span class="token operator">=</span> region<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">S2Cell</span><span class="token punctuation">(</span>s2LatLng<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> contains<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NullPointerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 根据region获取cellId列表
     * @param region
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> <span class="token function">getCellIdList</span><span class="token punctuation">(</span>S2Region region<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> primeS2CellIdList <span class="token operator">=</span> COVERER<span class="token punctuation">.</span><span class="token function">getCovering</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cellIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> primeS2CellIdList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>s2CellId <span class="token operator">-</span><span class="token operator">&gt;</span> S2Util<span class="token punctuation">.</span><span class="token function">childrenCellId</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">,</span> S2Util<span class="token punctuation">.</span>minLevel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据region获取合并后的cellId列表
     * @param region
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> <span class="token function">getCompactCellIdList</span><span class="token punctuation">(</span>S2Region region<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> primeS2CellIdList <span class="token operator">=</span> COVERER<span class="token punctuation">.</span><span class="token function">getCovering</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cellIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> primeS2CellIdList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取圆形region</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> S2Region <span class="token function">getS2RegionByCircle</span><span class="token punctuation">(</span><span class="token keyword">double</span> lat<span class="token punctuation">,</span> <span class="token keyword">double</span> lon<span class="token punctuation">,</span> <span class="token keyword">double</span> radius<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> capHeight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> S2<span class="token punctuation">.</span>M_PI<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>radius <span class="token operator">/</span> <span class="token number">40075017</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        S2Cap cap <span class="token operator">=</span> S2Cap<span class="token punctuation">.</span><span class="token function">fromAxisHeight</span><span class="token punctuation">(</span>S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lon<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> capHeight <span class="token operator">*</span> capHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        S2CellUnion s2CellUnion <span class="token operator">=</span> COVERER<span class="token punctuation">.</span><span class="token function">getCovering</span><span class="token punctuation">(</span>cap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> S2Region <span class="token function">getS2RegionByCircle</span><span class="token punctuation">(</span>WGS84Point point<span class="token punctuation">,</span> <span class="token keyword">double</span> radius<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getS2RegionByCircle</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> point<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取矩形region</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> S2Region <span class="token function">geS2RegionByRect</span><span class="token punctuation">(</span>WGS84Point point1<span class="token punctuation">,</span> WGS84Point point2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getS2RegionByRect</span><span class="token punctuation">(</span>point1<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> point1<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> point2<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> point2<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> S2Region <span class="token function">getS2RegionByRect</span><span class="token punctuation">(</span>Tuple2<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token punctuation">&gt;</span></span> point1<span class="token punctuation">,</span> Tuple2<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token punctuation">&gt;</span></span> point2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getS2RegionByRect</span><span class="token punctuation">(</span>point1<span class="token punctuation">.</span><span class="token function">getVal1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> point1<span class="token punctuation">.</span><span class="token function">getVal2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> point2<span class="token punctuation">.</span><span class="token function">getVal1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> point2<span class="token punctuation">.</span><span class="token function">getVal2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> S2Region <span class="token function">getS2RegionByRect</span><span class="token punctuation">(</span><span class="token keyword">double</span> lat1<span class="token punctuation">,</span> <span class="token keyword">double</span> lon1<span class="token punctuation">,</span> <span class="token keyword">double</span> lat2<span class="token punctuation">,</span> <span class="token keyword">double</span> lon2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        List<span class="token operator">&lt;</span>Tuple2<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> latLonTuple2List <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span>lat1<span class="token punctuation">,</span> lon1<span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span>lat1<span class="token punctuation">,</span> lon2<span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span>lat2<span class="token punctuation">,</span> lon2<span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span>lat2<span class="token punctuation">,</span> lon1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getS2RegionByPolygon</span><span class="token punctuation">(</span>latLonTuple2List<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取多边形region</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> S2Region <span class="token function">getS2RegionByPolygon</span><span class="token punctuation">(</span>WGS84Point<span class="token punctuation">[</span><span class="token punctuation">]</span> pointArray<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        List<span class="token operator">&lt;</span>Tuple2<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> latLonTuple2List <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayListWithExpectedSize</span><span class="token punctuation">(</span>pointArray<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pointArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            latLonTuple2List<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span>pointArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pointArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">getS2RegionByPolygon</span><span class="token punctuation">(</span>latLonTuple2List<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> S2Region <span class="token function">getS2RegionByPolygon</span><span class="token punctuation">(</span>Tuple2<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tuple2Array<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getS2RegionByPolygon</span><span class="token punctuation">(</span>Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>tuple2Array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 注意需要以逆时针方向添加坐标点,多边形内部区域
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> S2Region <span class="token function">getS2RegionByPolygon</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Tuple2<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> latLonTuple2List<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>S2Point<span class="token punctuation">&gt;</span></span> pointList <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Tuple2<span class="token generics function"><span class="token punctuation">&lt;</span>Double<span class="token punctuation">,</span> Double<span class="token punctuation">&gt;</span></span> latlonTuple2 <span class="token operator">:</span> latLonTuple2List<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pointList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span>latlonTuple2<span class="token punctuation">.</span><span class="token function">getVal1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> latlonTuple2<span class="token punctuation">.</span><span class="token function">getVal2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        S2Loop s2Loop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2Loop</span><span class="token punctuation">(</span>pointList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        S2Polygon s2Polygon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2Polygon</span><span class="token punctuation">(</span>s2Loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s2Polygon<span class="token punctuation">;</span>

        <span class="token comment">/*
        S2PolygonBuilder builder = new S2PolygonBuilder(S2PolygonBuilder.Options.DIRECTED_XOR);
        builder.addLoop(s2Loop);
        return builder.assemblePolygon();
        * */</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//配置coverer参数</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getMinLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> minLevel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setMinLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> minLevel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        S2Util<span class="token punctuation">.</span>minLevel <span class="token operator">=</span> minLevel<span class="token punctuation">;</span>
        COVERER<span class="token punctuation">.</span><span class="token function">setMinLevel</span><span class="token punctuation">(</span>minLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getMaxLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> maxLevel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setMaxLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxLevel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        S2Util<span class="token punctuation">.</span>maxLevel <span class="token operator">=</span> maxLevel<span class="token punctuation">;</span>
        COVERER<span class="token punctuation">.</span><span class="token function">setMaxLevel</span><span class="token punctuation">(</span>maxLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getMaxCells</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> maxCells<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setMaxCells</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxCells<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        S2Util<span class="token punctuation">.</span>maxCells <span class="token operator">=</span> maxCells<span class="token punctuation">;</span>
        COVERER<span class="token punctuation">.</span><span class="token function">setMaxCells</span><span class="token punctuation">(</span>maxCells<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="4TestS2Util_1039"></a>4）TestS2Util测试类</h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>leo<span class="token punctuation">.</span>test<span class="token punctuation">.</span>sd<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span>Lists<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span>Maps<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>S2CellId<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>S2LatLng<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>S2LatLngRect<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span>S2Region<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestS2Util</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">getCellIdListByPolygon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        getCellIdListByCircle();</span>
        <span class="token comment">//构造一个矩形区域,判断该点是否在区域内</span>
        S2LatLng startS2 <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span><span class="token number">0.8293</span><span class="token punctuation">,</span> <span class="token number">72.004</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//左下角</span>
        S2LatLng endS2 <span class="token operator">=</span> S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span><span class="token number">55.8271</span><span class="token punctuation">,</span> <span class="token number">137.8347</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//右上角</span>
        S2LatLngRect rect  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S2LatLngRect</span><span class="token punctuation">(</span>startS2<span class="token punctuation">,</span> endS2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> contains <span class="token operator">=</span> rect<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>S2LatLng<span class="token punctuation">.</span><span class="token function">fromDegrees</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>contains<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getCellIdListByCircle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span>Integer<span class="token punctuation">&gt;</span></span> sizeCountMap<span class="token operator">=</span> Maps<span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        StringBuilder sb3<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        S2Region s2Region <span class="token operator">=</span> S2Util<span class="token punctuation">.</span><span class="token function">getS2RegionByCircle</span><span class="token punctuation">(</span><span class="token number">23.753954</span><span class="token punctuation">,</span><span class="token number">120.749615</span><span class="token punctuation">,</span><span class="token number">193511.10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> cellIdListByPolygon <span class="token operator">=</span> S2Util<span class="token punctuation">.</span><span class="token function">getCompactCellIdList</span><span class="token punctuation">(</span>s2Region<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cellIdListByPolygon<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s2CellId <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Level:"</span> <span class="token operator">+</span> s2CellId<span class="token punctuation">.</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",ID:"</span> <span class="token operator">+</span> s2CellId<span class="token punctuation">.</span><span class="token function">toToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",Min:"</span> <span class="token operator">+</span> s2CellId<span class="token punctuation">.</span><span class="token function">rangeMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",Max:"</span> <span class="token operator">+</span> s2CellId<span class="token punctuation">.</span><span class="token function">rangeMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb3<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">.</span><span class="token function">toToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sizeCountMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">.</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sizeCountMap<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">.</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb3<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"totalSize:"</span><span class="token operator">+</span>cellIdListByPolygon<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sizeCountMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>integerIntegerEntry <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"level:%d,size:%d\n"</span><span class="token punctuation">,</span>integerIntegerEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>integerIntegerEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getCellIdListByPolygon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span>Integer<span class="token punctuation">&gt;</span></span> sizeCountMap<span class="token operator">=</span> Maps<span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        StringBuilder sb3<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        S2Region s2Region <span class="token operator">=</span> S2Util<span class="token punctuation">.</span><span class="token function">getS2RegionByPolygon</span><span class="token punctuation">(</span>Lists<span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span><span class="token number">23.851458634747043</span><span class="token punctuation">,</span> <span class="token number">113.66432546548037</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span><span class="token number">21.60205563594303</span><span class="token punctuation">,</span> <span class="token number">114.82887624673037</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span><span class="token number">23.771049234941454</span><span class="token punctuation">,</span> <span class="token number">116.18019460610537</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Tuple2<span class="token punctuation">.</span><span class="token function">tuple</span><span class="token punctuation">(</span><span class="token number">23.16640234327511</span><span class="token punctuation">,</span> <span class="token number">114.94423269204286</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//大小相同的格子</span>
<span class="token comment">//                List&lt;S2CellId&gt; cellIdListByPolygon = S2Util.getCellIdList(s2Region);</span>
        <span class="token comment">//如果调用的是getCompactCellIdList,则结果如下,其cell数从1000多压缩到200多，按照设置的精度合并</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>S2CellId<span class="token punctuation">&gt;</span></span> cellIdListByPolygon <span class="token operator">=</span> S2Util<span class="token punctuation">.</span><span class="token function">getCompactCellIdList</span><span class="token punctuation">(</span>s2Region<span class="token punctuation">)</span><span class="token punctuation">;</span>

        cellIdListByPolygon<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s2CellId <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Level:"</span> <span class="token operator">+</span> s2CellId<span class="token punctuation">.</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",ID:"</span> <span class="token operator">+</span> s2CellId<span class="token punctuation">.</span><span class="token function">toToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",Min:"</span> <span class="token operator">+</span> s2CellId<span class="token punctuation">.</span><span class="token function">rangeMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">",Max:"</span> <span class="token operator">+</span> s2CellId<span class="token punctuation">.</span><span class="token function">rangeMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb3<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">.</span><span class="token function">toToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sizeCountMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">.</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>sizeCountMap<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>s2CellId<span class="token punctuation">.</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb3<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"totalSize:"</span><span class="token operator">+</span>cellIdListByPolygon<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sizeCountMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>integerIntegerEntry <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"level:%d,size:%d\n"</span><span class="token punctuation">,</span>integerIntegerEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>integerIntegerEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="7S2_1109"></a>7.S2精度表</h3> 
<table><thead><tr><th>level</th><th>min area</th><th>max area</th><th>average area</th><th>units</th><th>Random cell 1 (UK) min edge length</th><th>Random cell 1 (UK) max edge length</th><th>Random cell 2 (US) min edge length</th><th>Random cell 2 (US) max edge length</th><th>Number of cells</th></tr></thead><tbody><tr><td>00</td><td>85011012.19</td><td>85011012.19</td><td>85011012.19</td><td>km2</td><td>7842 km</td><td>7842 km</td><td>7842 km</td><td>7842 km</td><td>6</td></tr><tr><td>01</td><td>21252753.05</td><td>21252753.05</td><td>21252753.05</td><td>km2</td><td>3921 km</td><td>5004 km</td><td>3921 km</td><td>5004 km</td><td>24</td></tr><tr><td>02</td><td>4919708.23</td><td>6026521.16</td><td>5313188.26</td><td>km2</td><td>1825 km</td><td>2489 km</td><td>1825 km</td><td>2489 km</td><td>96</td></tr><tr><td>03</td><td>1055377.48</td><td>1646455.50</td><td>1328297.07</td><td>km2</td><td>840 km</td><td>1167 km</td><td>1130 km</td><td>1310 km</td><td>384</td></tr><tr><td>04</td><td>231564.06</td><td>413918.15</td><td>332074.27</td><td>km2</td><td>432 km</td><td>609 km</td><td>579 km</td><td>636 km</td><td>1536</td></tr><tr><td>05</td><td>53798.67</td><td>104297.91</td><td>83018.57</td><td>km2</td><td>210 km</td><td>298 km</td><td>287 km</td><td>315 km</td><td>6K</td></tr><tr><td>06</td><td>12948.81</td><td>26113.30</td><td>20754.64</td><td>km2</td><td>108 km</td><td>151 km</td><td>143 km</td><td>156 km</td><td>24K</td></tr><tr><td>07</td><td>3175.44</td><td>6529.09</td><td>5188.66</td><td>km2</td><td>54 km</td><td>76 km</td><td>72 km</td><td>78 km</td><td>98K</td></tr><tr><td>08</td><td>786.20</td><td>1632.45</td><td>1297.17</td><td>km2</td><td>27 km</td><td>38 km</td><td>36 km</td><td>39 km</td><td>393K</td></tr><tr><td>09</td><td>195.59</td><td>408.12</td><td>324.29</td><td>km2</td><td>14 km</td><td>19 km</td><td>18 km</td><td>20 km</td><td>1573K</td></tr><tr><td>10</td><td>48.78</td><td>102.03</td><td>81.07</td><td>km2</td><td>7 km</td><td>9 km</td><td>9 km</td><td>10 km</td><td>6M</td></tr><tr><td>11</td><td>12.18</td><td>25.51</td><td>20.27</td><td>km2</td><td>3 km</td><td>5 km</td><td>4 km</td><td>5 km</td><td>25M</td></tr><tr><td>12</td><td>3.04</td><td>6.38</td><td>5.07</td><td>km2</td><td>1699 m</td><td>2 km</td><td>2 km</td><td>2 km</td><td>100M</td></tr><tr><td>13</td><td>0.76</td><td>1.59</td><td>1.27</td><td>km2</td><td>850 m</td><td>1185 m</td><td>1123 m</td><td>1225 m</td><td>402M</td></tr><tr><td>14</td><td>0.19</td><td>0.40</td><td>0.32</td><td>km2</td><td>425 m</td><td>593 m</td><td>562 m</td><td>613 m</td><td>1610M</td></tr><tr><td>15</td><td>47520.30</td><td>99638.93</td><td>79172.67</td><td>m2</td><td>212 m</td><td>296 m</td><td>281 m</td><td>306 m</td><td>6B</td></tr><tr><td>16</td><td>11880.08</td><td>24909.73</td><td>19793.17</td><td>m2</td><td>106 m</td><td>148 m</td><td>140 m</td><td>153 m</td><td>25B</td></tr><tr><td>17</td><td>2970.02</td><td>6227.43</td><td>4948.29</td><td>m2</td><td>53 m</td><td>74 m</td><td>70 m</td><td>77 m</td><td>103B</td></tr><tr><td>18</td><td>742.50</td><td>1556.86</td><td>1237.07</td><td>m2</td><td>27 m</td><td>37 m</td><td>35 m</td><td>38 m</td><td>412B</td></tr><tr><td>19</td><td>185.63</td><td>389.21</td><td>309.27</td><td>m2</td><td>13 m</td><td>19 m</td><td>18 m</td><td>19 m</td><td>1649B</td></tr><tr><td>20</td><td>46.41</td><td>97.30</td><td>77.32</td><td>m2</td><td>7 m</td><td>9 m</td><td>9 m</td><td>10 m</td><td>7T</td></tr><tr><td>21</td><td>11.60</td><td>24.33</td><td>19.33</td><td>m2</td><td>3 m</td><td>5 m</td><td>4 m</td><td>5 m</td><td>26T</td></tr><tr><td>22</td><td>2.90</td><td>6.08</td><td>4.83</td><td>m2</td><td>166 cm</td><td>2 m</td><td>2 m</td><td>2 m</td><td>105T</td></tr><tr><td>23</td><td>0.73</td><td>1.52</td><td>1.21</td><td>m2</td><td>83 cm</td><td>116 cm</td><td>110 cm</td><td>120 cm</td><td>422T</td></tr><tr><td>24</td><td>0.18</td><td>0.38</td><td>0.30</td><td>m2</td><td>41 cm</td><td>58 cm</td><td>55 cm</td><td>60 cm</td><td>1689T</td></tr><tr><td>25</td><td>453.19</td><td>950.23</td><td>755.05</td><td>cm2</td><td>21 cm</td><td>29 cm</td><td>27 cm</td><td>30 cm</td><td>7e15</td></tr><tr><td>26</td><td>113.30</td><td>237.56</td><td>188.76</td><td>cm2</td><td>10 cm</td><td>14 cm</td><td>14 cm</td><td>15 cm</td><td>27e15</td></tr><tr><td>27</td><td>28.32</td><td>59.39</td><td>47.19</td><td>cm2</td><td>5 cm</td><td>7 cm</td><td>7 cm</td><td>7 cm</td><td>108e15</td></tr><tr><td>28</td><td>7.08</td><td>14.85</td><td>11.80</td><td>cm2</td><td>2 cm</td><td>4 cm</td><td>3 cm</td><td>4 cm</td><td>432e15</td></tr><tr><td>29</td><td>1.77</td><td>3.71</td><td>2.95</td><td>cm2</td><td>12 mm</td><td>18 mm</td><td>17 mm</td><td>18 mm</td><td>1729e15</td></tr><tr><td>30</td><td>0.44</td><td>0.93</td><td>0.74</td><td>cm2</td><td>6 mm</td><td>9 mm</td><td>8 mm</td><td>9 mm</td><td>7e18</td></tr></tbody></table> 
<p><img src="https://images2.imgbox.com/17/e1/uJhK9zBI_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4114509c7b19866d46513afbce47c12b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ant design pro v5去掉水印</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/819425c588f56a0cfed1923107640500/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在微擎开发这么多年的感觉</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>