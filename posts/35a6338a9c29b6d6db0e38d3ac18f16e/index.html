<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>仅轨迹生成和跟踪 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="仅轨迹生成和跟踪" />
<meta property="og:description" content="本文是想在第一次实现后重新规范一下代码，然后整体重新实现并记录一下过程，完整代码见github https://github.com/USE-jx/Robomaster-uav-competition。
先将任务简化为轨迹生成和轨迹跟踪，不考虑障碍环在一定范围内移动的问题，根据大致的圆环中心生成minimum jerk轨迹，轨迹跟踪采用Geometric controller。（写这篇时已经识别出圆心了，就差轨迹重规划一下了，但是还是想先把之前记录一下，修改一下代码整体结构）。
分析一波 整体分成轨迹规划和轨迹跟踪两个模块。
规划模块输入几个圆心waypoints，生成一条轨迹，发布轨迹上每一时刻的状态给控制模块作为期望状态，odom在发布状态，停止以及以后的重规划会用到，尤其时间戳很有用。所以规划模块订阅里程计消息，发布期望状态消息。
控制模块接收规划模块发来的期望状态和里程计的真实状态，发布控制器输出命令给飞控。所以控制模块订阅里程计消息和期望状态消息，发布控制命令消息。
综上，需要的模块之间通信的消息类型有里程计消息，期望状态消息和控制命令消息。
创建工作空间 第一步肯定是创建一个工作空间了，然后才是创建各种功能包。
mkdir -p uav_ws/src cd uav_ws catkin_make cd src //在src中创建各种功能包 自定义消息 里程计消息直接用ros官方消息，所以自定义一个角速率推力消息和一个期望状态消息，期望状态根据控制器需要什么状态来定义，几何控制需要位置速度加速度和偏航,其他控制器需要什么再加上就好。
//创建功能包和依赖 catkin_create_pkg uav_msgs std_msgs geometry_msgs roscpp cd uav_msgs/ mkdir msg cd msg touch AngleRateThrottle.msg touch DesiredStates.msg DesiredStates.msg中填入下面语句
std_msgs/Header header geometry_msgs/Vector3 position geometry_msgs/Vector3 velocity geometry_msgs/Vector3 acceleration float64 yaw AngleRateThrottle.msg中填入下面语句
float64 rollRate float64 pitchRate float64 yawRate float64 throttle 在package.xml中填入下面两行
&lt;build_depend&gt;message_generation&lt;/build_depend&gt; &lt;exec_depend&gt;message_runtime&lt;/exec_depend&gt; 在CmakeLists中做如下修改
//添加message_generation find_package(catkin REQUIRED COMPONENTS ... message_generation ) //添加message_runtime catkin_package( ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/35a6338a9c29b6d6db0e38d3ac18f16e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-19T16:10:49+08:00" />
<meta property="article:modified_time" content="2023-02-19T16:10:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">仅轨迹生成和跟踪</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本文是想在第一次实现后重新规范一下代码，然后整体重新实现并记录一下过程，完整代码见github <a href="https://github.com/USE-jx/Robomaster-uav-competition">https://github.com/USE-jx/Robomaster-uav-competition</a>。<br> 先将任务简化为轨迹生成和轨迹跟踪，不考虑障碍环在一定范围内移动的问题，根据大致的圆环中心生成minimum jerk轨迹，轨迹跟踪采用Geometric controller。（写这篇时已经识别出圆心了，就差轨迹重规划一下了，但是还是想先把之前记录一下，修改一下代码整体结构）。</p> 
<h2><a id="_2"></a>分析一波</h2> 
<p>整体分成轨迹规划和轨迹跟踪两个模块。<br> 规划模块输入几个圆心waypoints，生成一条轨迹，发布轨迹上每一时刻的状态给控制模块作为期望状态，odom在发布状态，停止以及以后的重规划会用到，尤其时间戳很有用。所以规划模块订阅里程计消息，发布期望状态消息。<br> 控制模块接收规划模块发来的期望状态和里程计的真实状态，发布控制器输出命令给飞控。所以控制模块订阅里程计消息和期望状态消息，发布控制命令消息。<br> 综上，需要的模块之间通信的消息类型有里程计消息，期望状态消息和控制命令消息。</p> 
<h2><a id="_7"></a>创建工作空间</h2> 
<p>第一步肯定是创建一个工作空间了，然后才是创建各种功能包。</p> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> uav_ws/src
<span class="token builtin class-name">cd</span> uav_ws
catkin_make
<span class="token builtin class-name">cd</span> src  //在src中创建各种功能包
</code></pre> 
<h2><a id="_15"></a>自定义消息</h2> 
<p>里程计消息直接用ros官方消息，所以自定义一个角速率推力消息和一个期望状态消息，期望状态根据控制器需要什么状态来定义，几何控制需要位置速度加速度和偏航,其他控制器需要什么再加上就好。</p> 
<pre><code class="prism language-bash">//创建功能包和依赖
catkin_create_pkg uav_msgs std_msgs geometry_msgs roscpp
<span class="token builtin class-name">cd</span> uav_msgs/
<span class="token function">mkdir</span> msg
<span class="token builtin class-name">cd</span> msg
<span class="token function">touch</span> AngleRateThrottle.msg
<span class="token function">touch</span> DesiredStates.msg
</code></pre> 
<p>DesiredStates.msg中填入下面语句</p> 
<pre><code class="prism language-bash">std_msgs/Header header

geometry_msgs/Vector3 position
geometry_msgs/Vector3 velocity
geometry_msgs/Vector3 acceleration

float64 yaw
</code></pre> 
<p>AngleRateThrottle.msg中填入下面语句</p> 
<pre><code class="prism language-bash">float64 rollRate
float64 pitchRate
float64 yawRate
float64 throttle
</code></pre> 
<p>在package.xml中填入下面两行</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>build_depend<span class="token operator">&gt;</span>message_generation<span class="token operator">&lt;</span>/build_depend<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>exec_depend<span class="token operator">&gt;</span>message_runtime<span class="token operator">&lt;</span>/exec_depend<span class="token operator">&gt;</span>
</code></pre> 
<p>在CmakeLists中做如下修改</p> 
<pre><code class="prism language-bash">//添加message_generation
find_package<span class="token punctuation">(</span>catkin REQUIRED COMPONENTS
	<span class="token punctuation">..</span>.
  message_generation  
<span class="token punctuation">)</span>
//添加message_runtime
catkin_package<span class="token punctuation">(</span>
  <span class="token punctuation">..</span>.
  CATKIN_DEPENDS message_runtime <span class="token punctuation">..</span>.
  <span class="token punctuation">..</span>.<span class="token punctuation">)</span>
//添加新建的msg
add_message_files<span class="token punctuation">(</span>
  FILES
  AngleRateThrottle.msg
  DesiredStates.msg
<span class="token punctuation">)</span>
//解注释生成消息函数
generate_messages<span class="token punctuation">(</span>
  DEPENDENCIES
	geometry_msgs
  std_msgs
<span class="token punctuation">)</span>
</code></pre> 
<p>接下来回到工作空间编译，会在devel文件夹中生成对应的头文件，source后即可查看消息结构<br> <img src="https://images2.imgbox.com/5d/b2/mY7FDCUY_o.png" alt="image.png"><br> 后面需要用到消息时引入头文件即可使用。<br> 由于轨迹跟踪控制器需要轨迹才能调参，所以先完成规划模块，再完成控制模块。<br> 本次整体框架采用库的思想，把轨迹生成和几何控制器写成一个库，然后轨迹发布节点和控制命令发布节点调用那两个库得到轨迹和控制命令。一个库中可以实现几种算法，如果需要验证多种规划和控制算法只需用节点调用库中的不同算法即可。参考fast_planner。</p> 
<h2><a id="MinimumJerk_78"></a>MinimumJerk轨迹生成</h2> 
<p>新建一个功能包trajectory_generator，依赖roscpp, rospy, nav_msgs, std_msgs,随便写几个依赖后便可以再加。</p> 
<pre><code class="prism language-bash">catkin_create_pkg trajectory_generator roscpp rospy std_msgs nav_msgs
</code></pre> 
<p>在include和src文件夹中分别新建mini_jerk_traj.h和mini_jerk_traj.cpp,代码如下</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">MINI_JERK_TRAJ_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MINI_JERK_TRAJ_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Eigen/Eigen&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TrajectoryGeneratorWaypoints</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">TrajectoryGeneratorWaypoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">TrajectoryGeneratorWaypoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token function">miniJerkTrajGenerate</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>waypoints<span class="token punctuation">,</span>  <span class="token comment">//3d waypoints coordinates</span>
        <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>vel<span class="token punctuation">,</span>   <span class="token comment">//boundary velocity</span>
        <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>acc<span class="token punctuation">,</span>   <span class="token comment">//boundary acceleration</span>
        <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>VectorXd <span class="token operator">&amp;</span>time   <span class="token comment">//time allocation in each segment</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//get position,velocity,acceleration in kth segment at t</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token function">getPosition</span><span class="token punctuation">(</span>Eigen<span class="token double-colon punctuation">::</span>MatrixXd coeff_matrix<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">double</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token function">getVelocity</span><span class="token punctuation">(</span>Eigen<span class="token double-colon punctuation">::</span>MatrixXd coeff_matrix<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">double</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token function">getAcceleration</span><span class="token punctuation">(</span>Eigen<span class="token double-colon punctuation">::</span>MatrixXd coeff_matrix<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">double</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"trajectory_generator/mini_jerk_traj.h"</span></span>

<span class="token class-name">TrajectoryGeneratorWaypoints</span><span class="token double-colon punctuation">::</span><span class="token function">TrajectoryGeneratorWaypoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token class-name">TrajectoryGeneratorWaypoints</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">TrajectoryGeneratorWaypoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>


Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token class-name">TrajectoryGeneratorWaypoints</span><span class="token double-colon punctuation">::</span><span class="token function">miniJerkTrajGenerate</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>waypoints<span class="token punctuation">,</span>  <span class="token comment">//3d waypoints coordinates nx3</span>
        <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>vel<span class="token punctuation">,</span>   <span class="token comment">//boundary velocity 2x3</span>
        <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>acc<span class="token punctuation">,</span>   <span class="token comment">//boundary acceleration 2x3</span>
        <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>VectorXd <span class="token operator">&amp;</span>time <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//time allocation in each segment</span>
    <span class="token comment">//固定求jerk可以不写，用qp求不确定是jerk和snap时候可以写</span>
    <span class="token comment">//int p_order = 2 * d_order -1;  //the order of polynomial  (5)</span>
    <span class="token comment">//int p_num1d = p_order + 1;   //the number of coeff in each segment  (c0 ~ c5)</span>
    <span class="token keyword">int</span> segments <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//the number of segments</span>

    <span class="token comment">// M * coeffMatrix = b  就能解出系数矩阵</span>
    Eigen<span class="token double-colon punctuation">::</span>MatrixXd coeffMatrix<span class="token punctuation">;</span> 
    Eigen<span class="token double-colon punctuation">::</span>MatrixXd M <span class="token operator">=</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments<span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>MatrixXd b <span class="token operator">=</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 构造M和b矩阵
     * 1 起始pva 和 末尾pva约束
     * 2 中间点p v a jerk snap 连续约束，即第一段T = 第二段0
     * 这两个约束正好填满M矩阵
     */</span>
    <span class="token comment">//中间点连续需要用到T到T^5</span>
    Eigen<span class="token double-colon punctuation">::</span>VectorXd T1 <span class="token operator">=</span> time<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>VectorXd T2 <span class="token operator">=</span> T1<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>T1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>VectorXd T3 <span class="token operator">=</span> T2<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>T1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>VectorXd T4 <span class="token operator">=</span> T3<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>T1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>VectorXd T5 <span class="token operator">=</span> T4<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>T1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//initial pva</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    b<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> waypoints<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> vel<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//p v a jerk snap 连续</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token comment">//由前一段的时间得到下一点的开始位置</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T2</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T3</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T4</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T5</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

        b<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> waypoints<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//位置连续，前一段T时刻与后一段0时刻</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T2</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T3</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T4</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T5</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">//速度连续</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token function">T1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token function">T2</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token function">T3</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token function">T4</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>     

        <span class="token comment">//加速度连续</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token function">T1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token function">T2</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token function">T3</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>    

        <span class="token comment">//jerk连续</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token function">T1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token function">T2</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">;</span>    

        <span class="token comment">//snap连续</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">120</span> <span class="token operator">*</span> <span class="token function">T1</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">24</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token comment">//末端pva</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T1</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T2</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T3</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T4</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">T5</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token function">T1</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token function">T2</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token function">T3</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token function">T4</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token punctuation">;</span> 
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token function">T1</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token function">T2</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token function">T3</span><span class="token punctuation">(</span>segments<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    b<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> waypoints<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span>segments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> vel<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> segments <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> acc<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    coeffMatrix <span class="token operator">=</span> M<span class="token punctuation">.</span><span class="token function">fullPivLu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">solve</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">//transfrom to segments x (6*3) size 每行是一段x,y,z的系数</span>
    Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token function">coeffMatrix_t</span><span class="token punctuation">(</span>segments<span class="token punctuation">,</span> <span class="token number">6</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> segments<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        coeffMatrix_t<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> coeffMatrix<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">segment</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span>i<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        coeffMatrix_t<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> coeffMatrix<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">segment</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span>i<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        coeffMatrix_t<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> coeffMatrix<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">segment</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span>i<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> coeffMatrix_t<span class="token punctuation">;</span>

<span class="token punctuation">}</span>     

    
<span class="token comment">//get position,velocity,acceleration in kth segment at t</span>
<span class="token comment">//p = c0 + c1*t + c2*t^2 + c3*t^3 + c4*t^4 + c5*t^5</span>
Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token class-name">TrajectoryGeneratorWaypoints</span><span class="token double-colon punctuation">::</span><span class="token function">getPosition</span><span class="token punctuation">(</span>Eigen<span class="token double-colon punctuation">::</span>MatrixXd coeff_matrix<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">double</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token function">position</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> dim <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> dim <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>dim<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> tn <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">position</span><span class="token punctuation">(</span>dim<span class="token punctuation">)</span> <span class="token operator">+=</span> coeff_matrix<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">segment</span><span class="token punctuation">(</span>dim<span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> tn<span class="token punctuation">;</span>
            tn <span class="token operator">*=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token comment">//这样写不太好，可能写成矩阵运算更快</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> position<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//v = c1 + 2*c2*t + 3c3*t^2 + 4c4*t^3 + 5c5*t^4</span>
Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token class-name">TrajectoryGeneratorWaypoints</span><span class="token double-colon punctuation">::</span><span class="token function">getVelocity</span><span class="token punctuation">(</span>Eigen<span class="token double-colon punctuation">::</span>MatrixXd coeff_matrix<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">double</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token function">velocity</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> dim <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> dim <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>dim<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> tn <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">velocity</span><span class="token punctuation">(</span>dim<span class="token punctuation">)</span> <span class="token operator">+=</span> coeff_matrix<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">segment</span><span class="token punctuation">(</span>dim<span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> i <span class="token operator">*</span> tn<span class="token punctuation">;</span>
            tn <span class="token operator">*=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> velocity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//a = 2c2 + 6c3*t + 12c4*t^2 + 20c5*t^3</span>
Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token class-name">TrajectoryGeneratorWaypoints</span><span class="token double-colon punctuation">::</span><span class="token function">getAcceleration</span><span class="token punctuation">(</span>Eigen<span class="token double-colon punctuation">::</span>MatrixXd coeff_matrix<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">double</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token function">acceleration</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> dim <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> dim <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>dim<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> tn <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">acceleration</span><span class="token punctuation">(</span>dim<span class="token punctuation">)</span> <span class="token operator">+=</span> coeff_matrix<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">segment</span><span class="token punctuation">(</span>dim<span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">*</span> i <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> tn<span class="token punctuation">;</span>
            tn <span class="token operator">*=</span> t<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> acceleration<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>CmakeLists.txt内容如下：</p> 
<pre><code class="prism language-cmake">cmake_minimum_required(VERSION 3.0.2)
project(trajectory_generator)

add_compile_options(-std=c++11)

find_package(catkin REQUIRED COMPONENTS
  nav_msgs
  roscpp
  rospy
  std_msgs
)

catkin_package(
  INCLUDE_DIRS include
  #LIBRARIES trajectory_generator
  CATKIN_DEPENDS nav_msgs roscpp rospy std_msgs
  #DEPENDS system_lib
)

include_directories(
  include
  ${catkin_INCLUDE_DIRS}
)

 add_library(trajectory_generator
   src/mini_jerk_traj.cpp
 )

 target_link_libraries(trajectory_generator
   ${catkin_LIBRARIES}
 )



</code></pre> 
<h2><a id="Geometric_Controller_325"></a>Geometric Controller</h2> 
<p>新建一个功能包tracking_controller，依赖roscpp, rospy, std_msgs,随便写几个依赖后便可以再加。</p> 
<pre><code class="prism language-bash">catkin_create_pkg tracking_controller roscpp rospy std_msgs 
</code></pre> 
<p>在include和src文件夹中分别新建geometric_controller.h和geometric_controller.cpp,代码如下:</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">GEOMETRIC_CONTROLLER_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GEOMETRIC_CONTROLLER_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Eigen/Eigen&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">GeometricController</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d odom_pos_<span class="token punctuation">,</span> odom_vel_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Quaterniond odom_orient_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_pos_<span class="token punctuation">,</span> desired_vel_<span class="token punctuation">,</span> desired_acc_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> desired_yaw_<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">double</span> gravity_ <span class="token operator">=</span> <span class="token number">9.8</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">//parameters sever get params</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d position_gain_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d velocity_gain_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d attitude_gain_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> vehicle_mass_<span class="token punctuation">;</span>
     
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">GeometricController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">GeometricController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//类内默认内联函数</span>
    <span class="token keyword">void</span> <span class="token function">setOdometry</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>odom_pos<span class="token punctuation">,</span>
                     <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>odom_vel<span class="token punctuation">,</span>
                     <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Quaterniond <span class="token operator">&amp;</span>odom_orient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        odom_pos_ <span class="token operator">=</span> odom_pos<span class="token punctuation">;</span>
        odom_vel_ <span class="token operator">=</span> odom_vel<span class="token punctuation">;</span>
        odom_orient_ <span class="token operator">=</span> odom_orient<span class="token punctuation">;</span>                 
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">setDesiredStates</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>desired_pos<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>desired_vel<span class="token punctuation">,</span>
                          <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>desired_acc<span class="token punctuation">,</span>
                          <span class="token keyword">double</span> desired_yaw <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        desired_pos_ <span class="token operator">=</span> desired_pos<span class="token punctuation">;</span>
        desired_vel_ <span class="token operator">=</span> desired_vel<span class="token punctuation">;</span>
        desired_acc_ <span class="token operator">=</span> desired_acc<span class="token punctuation">;</span>
        desired_yaw_ <span class="token operator">=</span> desired_yaw<span class="token punctuation">;</span>                          
    <span class="token punctuation">}</span>
  
    <span class="token keyword">void</span> <span class="token function">computeDesiredAcc</span><span class="token punctuation">(</span>Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>new_acc<span class="token punctuation">,</span> 
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d odom_pos<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d odom_vel<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Quaterniond odom_orient<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_pos<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_vel<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_acc
                           <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">computeAttitudeError</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d new_acc<span class="token punctuation">,</span>
                              Eigen<span class="token double-colon punctuation">::</span>Quaterniond odom_orient<span class="token punctuation">,</span>
                              <span class="token keyword">double</span> yaw<span class="token punctuation">,</span>
                              Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span> attitudeError_v
                             <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">computeControlCmd</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>thrust<span class="token punctuation">,</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>angularVel<span class="token punctuation">)</span><span class="token punctuation">;</span>                         


<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tracking_controller/geometric_controller.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token class-name">GeometricController</span><span class="token double-colon punctuation">::</span><span class="token function">GeometricController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token class-name">GeometricController</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">GeometricController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">//angularRate and Throttle command</span>
<span class="token keyword">void</span> <span class="token class-name">GeometricController</span><span class="token double-colon punctuation">::</span><span class="token function">computeControlCmd</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">&amp;</span>thrust<span class="token punctuation">,</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>angularVel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d new_acc<span class="token punctuation">;</span>
    <span class="token function">computeDesiredAcc</span><span class="token punctuation">(</span>new_acc<span class="token punctuation">,</span> odom_pos_<span class="token punctuation">,</span> odom_vel_<span class="token punctuation">,</span> odom_orient_<span class="token punctuation">,</span> desired_pos_<span class="token punctuation">,</span> desired_vel_<span class="token punctuation">,</span> desired_acc_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d attitudeError_v<span class="token punctuation">;</span>
    <span class="token function">computeAttitudeError</span><span class="token punctuation">(</span>new_acc<span class="token punctuation">,</span> odom_orient_<span class="token punctuation">,</span> desired_yaw_<span class="token punctuation">,</span> attitudeError_v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    thrust <span class="token operator">=</span>  <span class="token operator">-</span>vehicle_mass_ <span class="token operator">*</span> new_acc<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>odom_orient_<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    angularVel <span class="token operator">=</span> <span class="token operator">-</span>attitude_gain_<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>attitudeError_v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                                  
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">GeometricController</span><span class="token double-colon punctuation">::</span><span class="token function">computeDesiredAcc</span><span class="token punctuation">(</span>Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>new_acc<span class="token punctuation">,</span> 
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d odom_pos<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d odom_vel<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Quaterniond odom_orient<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_pos<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_vel<span class="token punctuation">,</span>
                           Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_acc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//std::cout &lt;&lt; "current position:" &lt;&lt; odom_pos &lt;&lt; std::endl;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d position_error <span class="token operator">=</span> odom_pos <span class="token operator">-</span> desired_pos<span class="token punctuation">;</span>
    <span class="token comment">//std::cout &lt;&lt; "position error:" &lt;&lt; position_error.transpose() &lt;&lt; std::endl;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d velocity_error <span class="token operator">=</span> odom_vel <span class="token operator">-</span> desired_vel<span class="token punctuation">;</span>
    <span class="token comment">//std::cout &lt;&lt; "velocity error:" &lt;&lt; velocity_error.transpose() &lt;&lt; std::endl;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token function">e3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token function">e_3</span><span class="token punctuation">(</span>Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Vector3d</span><span class="token double-colon punctuation">::</span><span class="token function">UnitZ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//std::cout &lt;&lt; "e_3:" &lt;&lt; e_3.transpose() &lt;&lt; std::endl;</span>

    new_acc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>position_error<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>position_gain_<span class="token punctuation">)</span> <span class="token operator">-</span> velocity_error<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>velocity_gain_<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">/</span> vehicle_mass_ <span class="token operator">-</span> gravity_ <span class="token operator">*</span> e3 <span class="token operator">+</span> desired_acc<span class="token punctuation">;</span>
    <span class="token comment">//std::cout &lt;&lt; "desirede acc:" &lt;&lt; new_acc.transpose() &lt;&lt; std::endl; </span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">GeometricController</span><span class="token double-colon punctuation">::</span><span class="token function">computeAttitudeError</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d new_acc<span class="token punctuation">,</span>
                                               Eigen<span class="token double-colon punctuation">::</span>Quaterniond odom_orient<span class="token punctuation">,</span>
                                               <span class="token keyword">double</span> yaw<span class="token punctuation">,</span>
                                               Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span> attitudeError_v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//get current attitude by matrix</span>
    Eigen<span class="token double-colon punctuation">::</span>Matrix3d currentAttitude <span class="token operator">=</span> odom_orient<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//get desired attitude</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_b3 <span class="token operator">=</span>  <span class="token operator">-</span>new_acc <span class="token operator">/</span> new_acc<span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token function">desired_b1_p</span> <span class="token punctuation">(</span><span class="token function">cos</span><span class="token punctuation">(</span>yaw<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sin</span><span class="token punctuation">(</span>yaw<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_b2 <span class="token operator">=</span> desired_b3<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>desired_b1_p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    desired_b2<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_b1 <span class="token operator">=</span> desired_b2<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>desired_b3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Matrix3d attitude_matrix<span class="token punctuation">;</span>
    attitude_matrix<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> desired_b1<span class="token punctuation">;</span>
    attitude_matrix<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> desired_b2<span class="token punctuation">;</span>
    attitude_matrix<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> desired_b3<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d yaw_pitch_roll <span class="token operator">=</span> attitude_matrix<span class="token punctuation">.</span><span class="token function">eulerAngles</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ned frame </span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d desiredAttitude<span class="token punctuation">;</span>
    <span class="token function">desiredAttitude</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token function">yaw_pitch_roll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">desiredAttitude</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token function">yaw_pitch_roll</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">desiredAttitude</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token function">yaw_pitch_roll</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"desiredYaw:"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">desiredAttitude</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token comment">//get attitude error and from matrix to vector</span>
    Eigen<span class="token double-colon punctuation">::</span>Matrix3d attitudeError_m <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>attitude_matrix<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> currentAttitude <span class="token operator">-</span> currentAttitude<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> attitude_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    attitudeError_v <span class="token operator">&lt;&lt;</span> <span class="token function">attitudeError_m</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">attitudeError_m</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">attitudeError_m</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"attitudeError:"</span> <span class="token operator">&lt;&lt;</span> attitudeError_v<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>CmakeLists.txt内容如下：</p> 
<pre><code class="prism language-bash">cmake_minimum_required<span class="token punctuation">(</span>VERSION <span class="token number">3.0</span>.2<span class="token punctuation">)</span>
project<span class="token punctuation">(</span>tracking_controller<span class="token punctuation">)</span>

 add_compile_options<span class="token punctuation">(</span>-std<span class="token operator">=</span>c++11<span class="token punctuation">)</span>

find_package<span class="token punctuation">(</span>catkin REQUIRED COMPONENTS
  roscpp
  rospy
  std_msgs
<span class="token punctuation">)</span>


catkin_package<span class="token punctuation">(</span>
  INCLUDE_DIRS include
<span class="token comment">#  LIBRARIES tracking_controller</span>
  CATKIN_DEPENDS roscpp rospy std_msgs
<span class="token comment">#  DEPENDS system_lib</span>
<span class="token punctuation">)</span>


include_directories<span class="token punctuation">(</span>
 include
  <span class="token variable">${catkin_INCLUDE_DIRS}</span>
<span class="token punctuation">)</span>

<span class="token comment">## Declare a C++ library</span>
 add_library<span class="token punctuation">(</span>tracking_controller
   src/geometric_controller.cpp
 <span class="token punctuation">)</span>

<span class="token comment">## Specify libraries to link a library or executable target against</span>
 target_link_libraries<span class="token punctuation">(</span>tracking_controller
   <span class="token variable">${catkin_LIBRARIES}</span>
 <span class="token punctuation">)</span>


</code></pre> 
<h2><a id="_501"></a>创建规划和控制节点</h2> 
<p>首先新建一个功能包plan_and_control，依赖roscpp rospy std_msgs geometry_msgs nav_msgs visualization_msgs uav_msgs，命令如下：</p> 
<pre><code class="prism language-cpp">catkin_create_pkg plan_and_control roscpp rospy std_msgs geometry_msgs nav_msgs visualization_msgs uav_msgs
</code></pre> 
<h3><a id="_506"></a>创建轨迹发布节点</h3> 
<p>轨迹发布节点输入几个waypoints，订阅里程计话题，发布期望状态消息。waypoints比较多，放在参数服务器里，在构造函数中获取，这样修改waypoints时也不用重新编译。<br> 在功能包plan_and_control中的include和src中分别创建trajectory_publisher_node.h和trajectory_publisher_node.cpp,代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">TRAJECTORY_PUBLISHER_NODE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TRAJECTORY_PUBLISHER_NODE_H</span></span>

<span class="token comment">//ros and related msg</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ros/ros.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;uav_msgs/DesiredStates.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;visualization_msgs/Marker.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;nav_msgs/Odometry.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;geometry_msgs/PoseStamped.h&gt;</span></span>

<span class="token comment">//other utils</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Eigen/Eigen&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"trajectory_generator/mini_jerk_traj.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TrajectoryPublisherNode</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">//ros related</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle nh_<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle nh_private_<span class="token punctuation">;</span>

    ros<span class="token double-colon punctuation">::</span>Publisher desiredStates_pub_<span class="token punctuation">,</span> traj_vis_pub_<span class="token punctuation">,</span> cmd_vis_pub_<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>Publisher desiredPose_pub_<span class="token punctuation">,</span> currentPose_pub_<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>Subscriber odom_sub_<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>ServiceClient takeoff_client_<span class="token punctuation">;</span>
    uav_msgs<span class="token double-colon punctuation">::</span>DesiredStates cmd_<span class="token punctuation">;</span>
    nav_msgs<span class="token double-colon punctuation">::</span>OdometryConstPtr odom_<span class="token punctuation">;</span>
    geometry_msgs<span class="token double-colon punctuation">::</span>PoseStamped desiredPose_<span class="token punctuation">,</span> currentPose_<span class="token punctuation">;</span>

    <span class="token comment">//parameters for planner</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d odom_pos_<span class="token punctuation">,</span> odom_vel_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Quaterniond odom_orient_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d desiredPos_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d dir_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>VectorXd times_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>MatrixXd coeffMatrix_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>MatrixXd waypoints_<span class="token punctuation">;</span>
    <span class="token keyword">int</span> waypoint_num_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> max_vel_<span class="token punctuation">,</span> max_acc_<span class="token punctuation">,</span> max_jerk_<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>Time startTime_ <span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>Time finalTime_ <span class="token punctuation">;</span>
    <span class="token keyword">int</span> segment_num_<span class="token punctuation">;</span>
    <span class="token keyword">double</span> trajDuration_<span class="token punctuation">;</span>

    <span class="token keyword">double</span> startYaw_<span class="token punctuation">,</span> finalYaw_<span class="token punctuation">;</span>

    shared_ptr<span class="token operator">&lt;</span>TrajectoryGeneratorWaypoints<span class="token operator">&gt;</span> trajPlanWaypoints_ <span class="token operator">=</span> <span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TrajectoryGeneratorWaypoints<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>

    <span class="token function">TrajectoryPublisherNode</span><span class="token punctuation">(</span><span class="token keyword">const</span> ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token operator">&amp;</span>nh<span class="token punctuation">,</span> <span class="token keyword">const</span> ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token operator">&amp;</span>nh_private<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">TrajectoryPublisherNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">odomCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> nav_msgs<span class="token double-colon punctuation">::</span>OdometryConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>VectorXd <span class="token function">timeAllocation</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>waypoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">trajectoryGenerate</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>waypoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">desiredStatesPub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">displayTrajWithColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">drawCmd</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d<span class="token operator">&amp;</span> pos<span class="token punctuation">,</span> <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d<span class="token operator">&amp;</span> vec<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">&amp;</span> id<span class="token punctuation">,</span>
                 <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector4d<span class="token operator">&amp;</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"plan_and_control/trajectory_publisher_node.h"</span></span>


<span class="token class-name">TrajectoryPublisherNode</span><span class="token double-colon punctuation">::</span><span class="token function">TrajectoryPublisherNode</span><span class="token punctuation">(</span><span class="token keyword">const</span> ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token operator">&amp;</span>nh<span class="token punctuation">,</span> <span class="token keyword">const</span> ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token operator">&amp;</span>nh_private<span class="token punctuation">)</span>
<span class="token operator">:</span><span class="token function">nh_</span><span class="token punctuation">(</span>nh<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">nh_private_</span><span class="token punctuation">(</span>nh_private<span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span>
    
    odom_sub_ <span class="token operator">=</span>
        nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">subscribe</span><span class="token generic class-name"><span class="token operator">&lt;</span>nav_msgs<span class="token double-colon punctuation">::</span>Odometry<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/airsim_node/drone_1/odom_local_ned"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>TrajectoryPublisherNode<span class="token double-colon punctuation">::</span>odomCallback<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    desiredStates_pub_ <span class="token operator">=</span> 
        nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">advertise</span><span class="token generic class-name"><span class="token operator">&lt;</span>uav_msgs<span class="token double-colon punctuation">::</span>DesiredStates<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/reference/desiredStates"</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    traj_vis_pub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">advertise</span><span class="token generic class-name"><span class="token operator">&lt;</span>visualization_msgs<span class="token double-colon punctuation">::</span>Marker<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/trajectory_vis"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cmd_vis_pub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">advertise</span><span class="token generic class-name"><span class="token operator">&lt;</span>visualization_msgs<span class="token double-colon punctuation">::</span>Marker<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/cmd_vis"</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    desiredPose_pub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">advertise</span><span class="token generic class-name"><span class="token operator">&lt;</span>geometry_msgs<span class="token double-colon punctuation">::</span>PoseStamped<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/desiredPose"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentPose_pub_ <span class="token operator">=</span> nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">advertise</span><span class="token generic class-name"><span class="token operator">&lt;</span>geometry_msgs<span class="token double-colon punctuation">::</span>PoseStamped<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/currentPose"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">//cout &lt;&lt; "waypoint init failed!" &lt;&lt; endl;</span>
    <span class="token comment">//get params from sever</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"max_vel"</span><span class="token punctuation">,</span> max_vel_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"max_acc"</span><span class="token punctuation">,</span> max_acc_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"waypoint_num"</span><span class="token punctuation">,</span> waypoint_num_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    waypoints_<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>waypoint_num_<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"waypoint number:"</span> <span class="token operator">&lt;&lt;</span> waypoint_num_ <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> waypoint_num_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"waypoint"</span> <span class="token operator">+</span> <span class="token function">to_string</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/x"</span><span class="token punctuation">,</span> <span class="token function">waypoints_</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"waypoint"</span> <span class="token operator">+</span> <span class="token function">to_string</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/y"</span><span class="token punctuation">,</span> <span class="token function">waypoints_</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"waypoint"</span> <span class="token operator">+</span> <span class="token function">to_string</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/z"</span><span class="token punctuation">,</span> <span class="token function">waypoints_</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"waypoints:"</span> <span class="token operator">&lt;&lt;</span> waypoints_ <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token function">trajectoryGenerate</span><span class="token punctuation">(</span>waypoints_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token class-name">TrajectoryPublisherNode</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">TrajectoryPublisherNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TrajectoryPublisherNode</span><span class="token double-colon punctuation">::</span><span class="token function">trajectoryGenerate</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>waypoints<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">//start final vel and acc </span>
    Eigen<span class="token double-colon punctuation">::</span>MatrixXd vel <span class="token operator">=</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  vel(1,0) = 1.3;</span>
    <span class="token comment">//  vel(1,1) = -4.67;</span>
    <span class="token comment">//  vel(1,2) = 0;</span>
    <span class="token comment">//  vel(1,0) = max_vel_ * cos(-75.0 / 180.0 * M_PI);</span>
    <span class="token comment">//  vel(1,1) = max_vel_ * sin(-75.0 / 180.0 * M_PI);</span>
    <span class="token comment">//  vel(1,2) = 0;</span>

    Eigen<span class="token double-colon punctuation">::</span>MatrixXd acc <span class="token operator">=</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"compute time !"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    times_ <span class="token operator">=</span> <span class="token function">timeAllocation</span><span class="token punctuation">(</span>waypoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"time vector:"</span> <span class="token operator">&lt;&lt;</span> times_<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    coeffMatrix_ <span class="token operator">=</span> trajPlanWaypoints_<span class="token operator">-&gt;</span><span class="token function">miniJerkTrajGenerate</span><span class="token punctuation">(</span>waypoints<span class="token punctuation">,</span> vel<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> times_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"trajectory generate finish!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"coeff Matrix:"</span> <span class="token operator">&lt;&lt;</span> coeffMatrix_ <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    finalTime_ <span class="token operator">=</span> startTime_ <span class="token operator">=</span> ros<span class="token double-colon punctuation">::</span><span class="token class-name">Time</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    segment_num_ <span class="token operator">=</span> times_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> segment_num_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        finalTime_ <span class="token operator">+=</span> ros<span class="token double-colon punctuation">::</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token function">times_</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * compute current pos,vel,acc,yaw to controller
 */</span>
<span class="token keyword">void</span> <span class="token class-name">TrajectoryPublisherNode</span><span class="token double-colon punctuation">::</span><span class="token function">desiredStatesPub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cmd_<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> odom_<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>frame_id<span class="token punctuation">;</span>
    cmd_<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> odom_<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>stamp<span class="token punctuation">;</span>

    trajDuration_ <span class="token operator">=</span> <span class="token punctuation">(</span>finalTime_ <span class="token operator">-</span> startTime_<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ROS_WARN("timesum:%f:",trajDuration_);</span>
    <span class="token comment">//cout &lt;&lt; "time sum:" &lt;&lt; trajDuration_ &lt;&lt; endl;</span>
    <span class="token keyword">double</span> t <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>odom_<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>stamp <span class="token operator">-</span> startTime_<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//cout &lt;&lt;odom_-&gt;header.stamp &lt;&lt; startTime_ &lt;&lt; endl;</span>
    <span class="token comment">//cout &lt;&lt; "current:" &lt;&lt; t &lt;&lt; endl;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&gt;</span> trajDuration_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cmd_<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> odom_<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        cmd_<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> odom_<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        cmd_<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">=</span> odom_<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>

        cmd_<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        cmd_<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        cmd_<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        cmd_<span class="token punctuation">.</span>acceleration<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        cmd_<span class="token punctuation">.</span>acceleration<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        cmd_<span class="token punctuation">.</span>acceleration<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> segment_num_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&gt;</span> <span class="token function">times_</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                t <span class="token operator">-=</span> <span class="token function">times_</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                Eigen<span class="token double-colon punctuation">::</span>Vector3d desiredPos <span class="token operator">=</span> trajPlanWaypoints_<span class="token operator">-&gt;</span><span class="token function">getPosition</span><span class="token punctuation">(</span>coeffMatrix_<span class="token punctuation">,</span> i<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//cout &lt;&lt; "desiredPos:" &lt;&lt; desiredPos.transpose() &lt;&lt; endl;</span>
                <span class="token comment">//cout &lt;&lt; "odom_Pos:" &lt;&lt; odom_pos_.transpose() &lt;&lt; endl;</span>

                Eigen<span class="token double-colon punctuation">::</span>Vector3d desiredVel <span class="token operator">=</span> trajPlanWaypoints_<span class="token operator">-&gt;</span><span class="token function">getVelocity</span><span class="token punctuation">(</span>coeffMatrix_<span class="token punctuation">,</span> i<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//cout &lt;&lt; "desiredVel:" &lt;&lt; desiredVel.transpose() &lt;&lt; endl;</span>
                <span class="token comment">//cout &lt;&lt; "odom_vel:" &lt;&lt; odom_vel_.transpose() &lt;&lt; endl;</span>
                Eigen<span class="token double-colon punctuation">::</span>Vector3d desiredAcc <span class="token operator">=</span> trajPlanWaypoints_<span class="token operator">-&gt;</span><span class="token function">getAcceleration</span><span class="token punctuation">(</span>coeffMatrix_<span class="token punctuation">,</span> i<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                desiredPos_ <span class="token operator">=</span> desiredPos<span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> desiredPos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> desiredPos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">=</span> desiredPos<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>x <span class="token operator">=</span> desiredVel<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>y <span class="token operator">=</span> desiredVel<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>z <span class="token operator">=</span> desiredVel<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>acceleration<span class="token punctuation">.</span>x <span class="token operator">=</span> desiredAcc<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>acceleration<span class="token punctuation">.</span>y <span class="token operator">=</span> desiredAcc<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>acceleration<span class="token punctuation">.</span>z <span class="token operator">=</span> desiredAcc<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cmd_<span class="token punctuation">.</span>yaw <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span>cmd_<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>y<span class="token punctuation">,</span> cmd_<span class="token punctuation">.</span>velocity<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//cmd_.yaw = 0.0;</span>
                <span class="token comment">//cout &lt;&lt; "desiredyaw:" &lt;&lt; cmd_.yaw &lt;&lt; endl;</span>
                Eigen<span class="token double-colon punctuation">::</span>Matrix3d currentAttitude <span class="token operator">=</span> odom_orient_<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Eigen<span class="token double-colon punctuation">::</span>Vector3d RPY <span class="token operator">=</span> currentAttitude<span class="token punctuation">.</span><span class="token function">eulerAngles</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//cout &lt;&lt; "currentyaw:" &lt;&lt; RPY(0) &lt;&lt; endl;</span>
                desiredPose_<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">"map"</span><span class="token punctuation">;</span>
                desiredPose_<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> odom_<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>stamp<span class="token punctuation">;</span>
                desiredPose_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x <span class="token operator">=</span> desiredPos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                desiredPose_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> desiredPos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                desiredPose_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">=</span> desiredPos<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    desiredStates_pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>cmd_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    desiredPose_pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>desiredPose_<span class="token punctuation">)</span><span class="token punctuation">;</span>

    dir_ <span class="token operator">&lt;&lt;</span> <span class="token function">cos</span><span class="token punctuation">(</span>cmd_<span class="token punctuation">.</span>yaw<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sin</span><span class="token punctuation">(</span>cmd_<span class="token punctuation">.</span>yaw<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">drawCmd</span><span class="token punctuation">(</span>desiredPos_<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> dir_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector4d</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TrajectoryPublisherNode</span><span class="token double-colon punctuation">::</span><span class="token function">odomCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> nav_msgs<span class="token double-colon punctuation">::</span>OdometryConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    odom_ <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    <span class="token function">odom_pos_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token function">odom_pos_</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token function">odom_pos_</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>

    <span class="token function">odom_vel_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>twist<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token function">odom_vel_</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>twist<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token function">odom_vel_</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>twist<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>z<span class="token punctuation">;</span>

    odom_orient_<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
    odom_orient_<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    odom_orient_<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    odom_orient_<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
    currentPose_<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">"map"</span><span class="token punctuation">;</span>
    currentPose_<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>header<span class="token punctuation">.</span>stamp<span class="token punctuation">;</span>
    currentPose_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
    currentPose_<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">;</span>
    currentPose_pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>currentPose_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">desiredStatesPub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">displayTrajWithColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Eigen<span class="token double-colon punctuation">::</span>VectorXd <span class="token class-name">TrajectoryPublisherNode</span><span class="token double-colon punctuation">::</span><span class="token function">timeAllocation</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>MatrixXd <span class="token operator">&amp;</span>waypoints<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Eigen<span class="token double-colon punctuation">::</span>VectorXd <span class="token function">time</span><span class="token punctuation">(</span>waypoints<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> waypoints<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">double</span> distance <span class="token operator">=</span> <span class="token punctuation">(</span>waypoints<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> waypoints<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> t <span class="token operator">=</span> max_vel_ <span class="token operator">/</span> max_acc_<span class="token punctuation">;</span>
        <span class="token keyword">double</span> d <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> max_acc_ <span class="token operator">*</span> t <span class="token operator">*</span> t<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> d<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">time</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>distance <span class="token operator">/</span> max_acc_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">time</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> t <span class="token operator">+</span> <span class="token punctuation">(</span>distance <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> d<span class="token punctuation">)</span> <span class="token operator">/</span> max_vel_<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> time<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token class-name">TrajectoryPublisherNode</span><span class="token double-colon punctuation">::</span><span class="token function">displayTrajWithColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  visualization_msgs<span class="token double-colon punctuation">::</span>Marker points<span class="token punctuation">,</span> line_strip<span class="token punctuation">;</span>
  points<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> line_strip<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">"map"</span><span class="token punctuation">;</span>
  points<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> line_strip<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> ros<span class="token double-colon punctuation">::</span><span class="token class-name">Time</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  points<span class="token punctuation">.</span>ns <span class="token operator">=</span> line_strip<span class="token punctuation">.</span>ns <span class="token operator">=</span> <span class="token string">"traj"</span><span class="token punctuation">;</span>
  points<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  line_strip<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  points<span class="token punctuation">.</span>action <span class="token operator">=</span> line_strip<span class="token punctuation">.</span>action <span class="token operator">=</span> visualization_msgs<span class="token double-colon punctuation">::</span>Marker<span class="token double-colon punctuation">::</span>ADD<span class="token punctuation">;</span>

  points<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span>line_strip<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>

  points<span class="token punctuation">.</span>type <span class="token operator">=</span> visualization_msgs<span class="token double-colon punctuation">::</span>Marker<span class="token double-colon punctuation">::</span>POINTS<span class="token punctuation">;</span>
  line_strip<span class="token punctuation">.</span>type <span class="token operator">=</span> visualization_msgs<span class="token double-colon punctuation">::</span>Marker<span class="token double-colon punctuation">::</span>LINE_STRIP<span class="token punctuation">;</span>

  points<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
  points<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>

  line_strip<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">;</span>

  points<span class="token punctuation">.</span>color<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
  points<span class="token punctuation">.</span>color<span class="token punctuation">.</span>g <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
  line_strip<span class="token punctuation">.</span>color<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
  line_strip<span class="token punctuation">.</span>color<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
  line_strip<span class="token punctuation">.</span>color<span class="token punctuation">.</span>g <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>

  geometry_msgs<span class="token double-colon punctuation">::</span>Point pt<span class="token punctuation">;</span>
  Eigen<span class="token double-colon punctuation">::</span>Vector3d pos<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> segment_num_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">double</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> t <span class="token operator">&lt;</span> <span class="token function">times_</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> t <span class="token operator">+=</span> <span class="token number">0.01</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          pos <span class="token operator">=</span> trajPlanWaypoints_<span class="token operator">-&gt;</span><span class="token function">getPosition</span><span class="token punctuation">(</span>coeffMatrix_<span class="token punctuation">,</span> i<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
          pt<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          pt<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          pt<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          line_strip<span class="token punctuation">.</span>points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> waypoint_num_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      pt<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">waypoints_</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pt<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">waypoints_</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pt<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token function">waypoints_</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      points<span class="token punctuation">.</span>points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  traj_vis_pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span>
  traj_vis_pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>line_strip<span class="token punctuation">)</span><span class="token punctuation">;</span>

  ros<span class="token double-colon punctuation">::</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">TrajectoryPublisherNode</span><span class="token double-colon punctuation">::</span><span class="token function">drawCmd</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d<span class="token operator">&amp;</span> pos<span class="token punctuation">,</span> <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d<span class="token operator">&amp;</span> vec<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span><span class="token operator">&amp;</span> id<span class="token punctuation">,</span>
             <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector4d<span class="token operator">&amp;</span> color<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  visualization_msgs<span class="token double-colon punctuation">::</span>Marker mk_state<span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>header<span class="token punctuation">.</span>frame_id <span class="token operator">=</span> <span class="token string">"map"</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>header<span class="token punctuation">.</span>stamp <span class="token operator">=</span> ros<span class="token double-colon punctuation">::</span><span class="token class-name">Time</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>type <span class="token operator">=</span> visualization_msgs<span class="token double-colon punctuation">::</span>Marker<span class="token double-colon punctuation">::</span>ARROW<span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>action <span class="token operator">=</span> visualization_msgs<span class="token double-colon punctuation">::</span>Marker<span class="token double-colon punctuation">::</span>ADD<span class="token punctuation">;</span>

  mk_state<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">;</span>

  geometry_msgs<span class="token double-colon punctuation">::</span>Point pt<span class="token punctuation">;</span>
  pt<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pt<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pt<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>

  pt<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">vec</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pt<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">vec</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pt<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">vec</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>points<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>

  mk_state<span class="token punctuation">.</span>color<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token function">color</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>color<span class="token punctuation">.</span>g <span class="token operator">=</span> <span class="token function">color</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>color<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token function">color</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mk_state<span class="token punctuation">.</span>color<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token function">color</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  cmd_vis_pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>mk_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ros<span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"trajectory_publisher_node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle nh<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token function">nh_p</span><span class="token punctuation">(</span><span class="token string">"~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    TrajectoryPublisherNode <span class="token function">trajectoryPublisherNode</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> nh_p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ros<span class="token double-colon punctuation">::</span><span class="token function">spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_852"></a>创建轨迹跟踪节点</h3> 
<p>轨迹跟踪节点订阅轨迹发布节点以100Hz发布的期望状态，订阅里程计话题，发布三轴角速率和油门的控制命令。<br> 在功能包plan_and_control中的include和src中分别创建trajectory_tracking_node.h和trajectory_tracking_node.cpp,代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">TRAJECTORY_TRACKING_NODE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TRAJECTORY_TRACKING_NODE_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ros/ros.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;uav_msgs/AngleRateThrottle.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;uav_msgs/DesiredStates.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;nav_msgs/Odometry.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Eigen/Dense&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tracking_controller/geometric_controller.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">GeometricControllerNode</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">//ros related</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle nh_<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle nh_private_<span class="token punctuation">;</span>

    ros<span class="token double-colon punctuation">::</span>Publisher control_cmd_pub_<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>Subscriber odom_sub_<span class="token punctuation">,</span> desired_states_sub_<span class="token punctuation">;</span>

    ros<span class="token double-colon punctuation">::</span>Timer cmd_pub_timer_<span class="token punctuation">;</span>

    <span class="token comment">//parameters for controller</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d odom_pos_<span class="token punctuation">,</span> odom_vel_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Quaterniond odom_orient_<span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>Vector3d desired_pos_<span class="token punctuation">,</span> desired_vel_<span class="token punctuation">,</span> desired_acc_<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Quaterniond desired_orient_<span class="token punctuation">;</span> 
    <span class="token keyword">double</span> desired_yaw_<span class="token punctuation">;</span>

    GeometricController geometricController_<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> states_cmd_updated_<span class="token punctuation">,</span> states_cmd_init_<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">GeometricControllerNode</span><span class="token punctuation">(</span><span class="token keyword">const</span> ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token operator">&amp;</span>nh<span class="token punctuation">,</span> <span class="token keyword">const</span> ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token operator">&amp;</span>nh_private<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">GeometricControllerNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">odomCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> nav_msgs<span class="token double-colon punctuation">::</span>OdometryConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">desiredStatesCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> uav_msgs<span class="token double-colon punctuation">::</span>DesiredStatesConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">pubRrPrYrTCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"plan_and_control/trajectory_tracking_node.h"</span></span>

<span class="token class-name">GeometricControllerNode</span><span class="token double-colon punctuation">::</span><span class="token function">GeometricControllerNode</span><span class="token punctuation">(</span><span class="token keyword">const</span> ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token operator">&amp;</span>nh<span class="token punctuation">,</span> <span class="token keyword">const</span> ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token operator">&amp;</span>nh_private<span class="token punctuation">)</span> 
    <span class="token operator">:</span> <span class="token function">nh_</span><span class="token punctuation">(</span>nh<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">nh_private_</span><span class="token punctuation">(</span>nh_private<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">states_cmd_updated_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">states_cmd_init_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    control_cmd_pub_ <span class="token operator">=</span> 
        nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">advertise</span><span class="token generic class-name"><span class="token operator">&lt;</span>uav_msgs<span class="token double-colon punctuation">::</span>AngleRateThrottle<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/airsim_node/drone_1/angle_rate_throttle_frame"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    odom_sub_ <span class="token operator">=</span>
        nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">subscribe</span><span class="token generic class-name"><span class="token operator">&lt;</span>nav_msgs<span class="token double-colon punctuation">::</span>Odometry<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/airsim_node/drone_1/odom_local_ned"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>GeometricControllerNode<span class="token double-colon punctuation">::</span>odomCallback<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    desired_states_sub_ <span class="token operator">=</span>
        nh_<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">subscribe</span><span class="token generic class-name"><span class="token operator">&lt;</span>uav_msgs<span class="token double-colon punctuation">::</span>DesiredStates<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/reference/desiredStates"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>GeometricControllerNode<span class="token double-colon punctuation">::</span>desiredStatesCallback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//get parameters from parameters sever</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"position_gain/x"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>position_gain_<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"position_gain/y"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>position_gain_<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"position_gain/z"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>position_gain_<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"velocity_gain/x"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>velocity_gain_<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"velocity_gain/y"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>velocity_gain_<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"velocity_gain/z"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>velocity_gain_<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"attitude_gain/x"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>attitude_gain_<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"attitude_gain/y"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>attitude_gain_<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"attitude_gain/z"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>attitude_gain_<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nh_private_<span class="token punctuation">.</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string">"vehicle_mass"</span><span class="token punctuation">,</span> geometricController_<span class="token punctuation">.</span>vehicle_mass_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>

<span class="token class-name">GeometricControllerNode</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">GeometricControllerNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">GeometricControllerNode</span><span class="token double-colon punctuation">::</span><span class="token function">odomCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> nav_msgs<span class="token double-colon punctuation">::</span>OdometryConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    odom_pos_ <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3d</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
                                msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                                msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

    odom_vel_ <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3d</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>twist<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
                                msg<span class="token operator">-&gt;</span>twist<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                                msg<span class="token operator">-&gt;</span>twist<span class="token punctuation">.</span>twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

    odom_orient_<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
    odom_orient_<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    odom_orient_<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    odom_orient_<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>pose<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>orientation<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
    <span class="token comment">// Eigen::Matrix3d odom_matrix (odom_orient_);</span>
    <span class="token comment">// Eigen::Vector3d currentYPR = odom_matrix.eulerAngles(2,1,0);</span>
    
    geometricController_<span class="token punctuation">.</span><span class="token function">setOdometry</span><span class="token punctuation">(</span>odom_pos_<span class="token punctuation">,</span> odom_vel_<span class="token punctuation">,</span> odom_orient_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//当期望状态发送停止后也一直发送命令使飞机维持在最后的期望状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>states_cmd_init_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>states_cmd_init_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//pubRPYTCmd();</span>
            <span class="token function">pubRrPrYrTCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        states_cmd_updated_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">GeometricControllerNode</span><span class="token double-colon punctuation">::</span><span class="token function">desiredStatesCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> uav_msgs<span class="token double-colon punctuation">::</span>DesiredStatesConstPtr <span class="token operator">&amp;</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    desired_pos_ <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3d</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>position<span class="token punctuation">.</span>x<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>position<span class="token punctuation">.</span>y<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>position<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    desired_vel_ <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3d</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>velocity<span class="token punctuation">.</span>x<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>velocity<span class="token punctuation">.</span>y<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>velocity<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    desired_acc_ <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3d</span><span class="token punctuation">(</span>msg<span class="token operator">-&gt;</span>acceleration<span class="token punctuation">.</span>x<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>acceleration<span class="token punctuation">.</span>y<span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>acceleration<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    desired_yaw_ <span class="token operator">=</span> msg<span class="token operator">-&gt;</span>yaw<span class="token punctuation">;</span>
    geometricController_<span class="token punctuation">.</span><span class="token function">setDesiredStates</span><span class="token punctuation">(</span>desired_pos_<span class="token punctuation">,</span> desired_vel_<span class="token punctuation">,</span>desired_acc_<span class="token punctuation">,</span>desired_yaw_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">pubRrPrYrTCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    states_cmd_init_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    states_cmd_updated_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">GeometricControllerNode</span><span class="token double-colon punctuation">::</span><span class="token function">pubRrPrYrTCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    uav_msgs<span class="token double-colon punctuation">::</span>AngleRateThrottle cmd<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3d angular_vel<span class="token punctuation">;</span>
    <span class="token keyword">double</span> thrust<span class="token punctuation">;</span>
    geometricController_<span class="token punctuation">.</span><span class="token function">computeControlCmd</span><span class="token punctuation">(</span>thrust<span class="token punctuation">,</span> angular_vel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    cmd<span class="token punctuation">.</span>rollRate <span class="token operator">=</span> <span class="token function">angular_vel</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cmd<span class="token punctuation">.</span>pitchRate <span class="token operator">=</span> <span class="token function">angular_vel</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cmd<span class="token punctuation">.</span>yawRate <span class="token operator">=</span> <span class="token function">angular_vel</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cmd<span class="token punctuation">.</span>throttle <span class="token operator">=</span> thrust <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">;</span>
    control_cmd_pub_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ros<span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"geometric_controller_node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle nh<span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span>NodeHandle <span class="token function">nh_p</span><span class="token punctuation">(</span><span class="token string">"~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GeometricControllerNode <span class="token function">geometricControllerNode</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> nh_p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ros<span class="token double-colon punctuation">::</span><span class="token function">spin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="rviz_998"></a>新建rviz文件夹</h3> 
<p>在功能包中新建rviz文件夹用于保存rviz的设置，然后可以用launch启动，要不每次自己add，自己run rviz很费劲。<br> 这个第一次需要自己运行，add完想可视化的消息后保存到rviz文件夹即可。rviz保存完是下面这样的，开始我还天真的以为是人自己写的呢，</p> 
<pre><code>Panels:
  - Class: rviz/Displays
    Help Height: 138
    Name: Displays
    Property Tree Widget:
      Expanded:
        - /Global Options1
        - /Status1
        - /Marker1
        - /Marker2
        - /Pose1
        - /Pose2
      Splitter Ratio: 0.5
    Tree Height: 924
  - Class: rviz/Selection
    Name: Selection
  - Class: rviz/Tool Properties
    Expanded:
      - /2D Pose Estimate1
      - /2D Nav Goal1
      - /Publish Point1
    Name: Tool Properties
    Splitter Ratio: 0.5886790156364441
  - Class: rviz/Views
    Expanded:
      - /Current View1
    Name: Views
    Splitter Ratio: 0.5
  - Class: rviz/Time
    Name: Time
    SyncMode: 0
    SyncSource: ""
Preferences:
  PromptSaveOnExit: true
Toolbars:
  toolButtonStyle: 2
Visualization Manager:
  Class: ""
  Displays:
    - Alpha: 0.5
      Cell Size: 1
      Class: rviz/Grid
      Color: 160; 160; 164
      Enabled: true
      Line Style:
        Line Width: 0.029999999329447746
        Value: Lines
      Name: Grid
      Normal Cell Count: 0
      Offset:
        X: 0
        Y: 0
        Z: 0
      Plane: XY
      Plane Cell Count: 10
      Reference Frame: &lt;Fixed Frame&gt;
      Value: true
    - Class: rviz/Marker
      Enabled: true
      Marker Topic: /trajectory_vis
      Name: Marker
      Namespaces:
        traj: true
      Queue Size: 100
      Value: true
    - Class: rviz/Marker
      Enabled: true
      Marker Topic: /cmd_vis
      Name: Marker
      Namespaces:
        "": true
      Queue Size: 100
      Value: true
    - Alpha: 1
      Axes Length: 1
      Axes Radius: 0.10000000149011612
      Class: rviz/Pose
      Color: 255; 25; 0
      Enabled: true
      Head Length: 0.30000001192092896
      Head Radius: 0.10000000149011612
      Name: Pose
      Queue Size: 10
      Shaft Length: 1
      Shaft Radius: 0.05000000074505806
      Shape: Axes
      Topic: /desiredPose
      Unreliable: false
      Value: true
    - Alpha: 1
      Axes Length: 0.5
      Axes Radius: 0.10000000149011612
      Class: rviz/Pose
      Color: 255; 25; 0
      Enabled: true
      Head Length: 0.30000001192092896
      Head Radius: 0.10000000149011612
      Name: Pose
      Queue Size: 10
      Shaft Length: 1
      Shaft Radius: 0.05000000074505806
      Shape: Axes
      Topic: /currentPose
      Unreliable: false
      Value: true
  Enabled: true
  Global Options:
    Background Color: 48; 48; 48
    Default Light: true
    Fixed Frame: map
    Frame Rate: 30
  Name: root
  Tools:
    - Class: rviz/Interact
      Hide Inactive Objects: true
    - Class: rviz/MoveCamera
    - Class: rviz/Select
    - Class: rviz/FocusCamera
    - Class: rviz/Measure
    - Class: rviz/SetInitialPose
      Theta std deviation: 0.2617993950843811
      Topic: /initialpose
      X std deviation: 0.5
      Y std deviation: 0.5
    - Class: rviz/SetGoal
      Topic: /move_base_simple/goal
    - Class: rviz/PublishPoint
      Single click: true
      Topic: /clicked_point
  Value: true
  Views:
    Current:
      Class: rviz/Orbit
      Distance: 35.1982536315918
      Enable Stereo Rendering:
        Stereo Eye Separation: 0.05999999865889549
        Stereo Focal Distance: 1
        Swap Stereo Eyes: false
        Value: false
      Field of View: 0.7853981852531433
      Focal Point:
        X: 0
        Y: 0
        Z: 0
      Focal Shape Fixed Size: true
      Focal Shape Size: 0.05000000074505806
      Invert Z Axis: false
      Name: Current View
      Near Clip Distance: 0.009999999776482582
      Pitch: -0.14960156381130219
      Target Frame: &lt;Fixed Frame&gt;
      Yaw: 1.3203967809677124
    Saved: ~
Window Geometry:
  Displays:
    collapsed: false
  Height: 1434
  Hide Left Dock: false
  Hide Right Dock: false
  QMainWindow State: 000000ff00000000fd0000000400000000000001f700000494fc0200000008fb0000001200530065006c0065006300740069006f006e00000001e10000009b000000b000fffffffb0000001e0054006f006f006c002000500072006f007000650072007400690065007302000001ed000001df00000185000000b0fb000000120056006900650077007300200054006f006f02000001df000002110000018500000122fb000000200054006f006f006c002000500072006f0070006500720074006900650073003203000002880000011d000002210000017afb000000100044006900730070006c006100790073010000006e000004940000018200fffffffb0000002000730065006c0065006300740069006f006e00200062007500660066006500720200000138000000aa0000023a00000294fb00000014005700690064006500530074006500720065006f02000000e6000000d2000003ee0000030bfb0000000c004b0069006e0065006300740200000186000001060000030c00000261000000010000015f00000494fc0200000003fb0000001e0054006f006f006c002000500072006f00700065007200740069006500730100000041000000780000000000000000fb0000000a00560069006500770073010000006e000004940000013200fffffffb0000001200530065006c0065006300740069006f006e010000025a000000b200000000000000000000000200000490000000a9fc0100000001fb0000000a00560069006500770073030000004e00000080000002e100000197000000030000077e0000005efc0100000002fb0000000800540069006d006501000000000000077e000006dc00fffffffb0000000800540069006d00650100000000000004500000000000000000000004100000049400000004000000040000000800000008fc0000000100000002000000010000000a0054006f006f006c00730100000000ffffffff0000000000000000
  Selection:
    collapsed: false
  Time:
    collapsed: false
  Tool Properties:
    collapsed: false
  Views:
    collapsed: false
  Width: 1918
  X: 60
  Y: 30

</code></pre> 
<h3><a id="configlaunch_1175"></a>新建config和launch文件夹</h3> 
<p>在功能包中新建launch文件夹用于保存launch文件，luanch文件一起启动两个节点和rviz。因为轨迹生成的waypoints和控制gain数量太大直接写在launch文件中不合适，可以用放在yaml文件中，在launch文件中find一下即可，这个yaml文件放在config文件夹中。两个yaml和一个launch内容如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">waypoint_num</span><span class="token punctuation">:</span> <span class="token number">8</span>
<span class="token key atrule">waypoint0</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">-0.02</span><span class="token punctuation">}</span>
<span class="token key atrule">waypoint1</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">6.87</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">-0.79</span> <span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">-2.74</span><span class="token punctuation">}</span> <span class="token comment">#14.87</span>
<span class="token key atrule">waypoint2</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">37.68</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">-12.27</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">-1.03</span><span class="token punctuation">}</span>
<span class="token key atrule">waypoint3</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">67.52</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">-12.94</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">-0.3</span><span class="token punctuation">}</span>
<span class="token key atrule">waypoint4</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">94.3</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">-8.1</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">0.02</span><span class="token punctuation">}</span>
<span class="token comment">#waypoint5: {x: 104.44, y: -15.05, z: -0.02}</span>
<span class="token key atrule">waypoint5</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">113.95</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">-35.70</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">-0.34</span><span class="token punctuation">}</span>
<span class="token key atrule">waypoint6</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">121.6</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">-67.73</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">-3.83</span><span class="token punctuation">}</span>
<span class="token key atrule">waypoint7</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">121.80</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">-96.1</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">-7.39</span><span class="token punctuation">}</span>


<span class="token key atrule">max_vel</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">max_acc</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre> 
<pre><code class="prism language-yaml"><span class="token key atrule">position_gain</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">}</span>
<span class="token key atrule">velocity_gain</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">3.8</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">3.8</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">3.8</span><span class="token punctuation">}</span>
<span class="token key atrule">attitude_gain</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">x</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token key atrule">y</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token key atrule">z</span><span class="token punctuation">:</span> <span class="token number">1.2</span><span class="token punctuation">}</span>
<span class="token key atrule">vehicle_mass</span><span class="token punctuation">:</span> <span class="token number">0.606</span>
</code></pre> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>launch</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">pkg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>plan_and_control<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>trajectory_tracking_node<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>geometric_controller_node<span class="token punctuation">"</span></span> <span class="token attr-name">output</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>screen<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rosparam</span> <span class="token attr-name">command</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>load<span class="token punctuation">"</span></span> <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$(find plan_and_control)/config/controller_gains.yaml<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>      

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">pkg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>plan_and_control<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>trajectory_publisher_node<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>trajectory_publisher_node<span class="token punctuation">"</span></span> <span class="token attr-name">output</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>screen<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--waypoints for trajectory generating--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rosparam</span> <span class="token attr-name">command</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>load<span class="token punctuation">"</span></span> <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$(find plan_and_control)/config/waypoints.yaml<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">pkg</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rviz<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rviz<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rviz<span class="token punctuation">"</span></span> <span class="token attr-name">output</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>screen<span class="token punctuation">"</span></span>
    <span class="token attr-name">args</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>-d $(find plan_and_control)/rviz/traj.rviz<span class="token punctuation">"</span></span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>launch</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="CmakeListstxt_1216"></a>CmakeLists.txt</h3> 
<pre><code class="prism language-cmake">cmake_minimum_required(VERSION 3.0.2)
project(plan_and_control)

add_compile_options(-std=c++11)

find_package(Eigen3 REQUIRED)
find_package(catkin REQUIRED COMPONENTS
  geometry_msgs
  nav_msgs
  roscpp
  rospy
  std_msgs
  uav_msgs
  visualization_msgs
  tracking_controller
  trajectory_generator
)

catkin_package(
  INCLUDE_DIRS include
#  LIBRARIES plan_and_control
  CATKIN_DEPENDS geometry_msgs nav_msgs roscpp rospy std_msgs uav_msgs visualization_msgs
#  DEPENDS system_lib
)

include_directories(
 include
  ${catkin_INCLUDE_DIRS}
)


add_executable(trajectory_publisher_node src/trajectory_publisher_node.cpp)

target_link_libraries(trajectory_publisher_node
   ${catkin_LIBRARIES}
   trajectory_generator
)

add_executable(trajectory_tracking_node src/trajectory_tracking_node.cpp)

target_link_libraries(trajectory_tracking_node
   ${catkin_LIBRARIES}
   tracking_controller
)

</code></pre> 
<h3><a id="_1264"></a>运行</h3> 
<pre><code class="prism language-cmake">catkin_make
source devel/setup.bash
roslaunch plan_and_control trajectory_tracking.launch
</code></pre> 
<p>结果如下<br> <a href="https://player.bilibili.com/player.html?bvid=BV1vG4y1D7JG" rel="nofollow">点击查看【bilibili】</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cb47b9ddadf9d92d2f963d79217d461a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一篇刷题所需的查找表-Java(未完)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0ddcb843a8403edf7480b41b54e5c64b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">平衡二叉搜索树（Balanced Binary Tree）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>