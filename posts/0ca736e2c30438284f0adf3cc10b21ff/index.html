<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>卷积神经网络中的分类与回归 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="卷积神经网络中的分类与回归" />
<meta property="og:description" content="文章目录 数据增强卷积神经网络的发展LeNetAlexNetVGGNetReseNet 分类网络的实现模型训练损失函数优化器学习率训练与验证 模型展示多标签分类验证码生成模型搭建模型训练验证码识别 数据增强 数据增强是一种在训练模型过程中用于提高样本多样性，增强模型泛化能力的手段。在对图像进行数据增强时，必须保留图像中与标签对应的关键信息。使用了两种数据增强手段：随机裁剪和随机翻转。其中随机裁剪是先在图片外围补存4个像素，然后在图片中随机裁剪32×32图片的方法：随机翻转是按一定概率选择是否对图片进行翻转处理的方法。这两种手段都不会改变图片原有的信息（随机裁剪后保留的信息占原图的比例足够大，所以信息会得以保留）。
#coding=utf-8 import cv2 import torch import torch.nn as nn import torch.optim as optim import torch.nn.functional as F from torchvision import datasets, transforms import matplotlib.pyplot as plt import numpy as np from PIL import Image from sklearn.datasets import make_blobs from torchvision.models import resnet18 from torchvision import transforms from PIL import Image #定义设备 device=( torch.device(&#34;cuda&#34;) if torch.cuda.is_available() else torch.device(&#34;cpu&#34;) ) #数据目录 data_folder=&#34;/data/cifar10&#34; #模型存储目录 checkpoint_folder=&#34;/data/chapter_one&#34; #每一个批次图片的数量 batch_size=64 #随着训练的次数增加，逐步缩小学习率 epochs=[(30,0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/0ca736e2c30438284f0adf3cc10b21ff/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-30T10:02:08+08:00" />
<meta property="article:modified_time" content="2022-11-30T10:02:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">卷积神经网络中的分类与回归</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">数据增强</a></li><li><a href="#_153" rel="nofollow">卷积神经网络的发展</a></li><li><ul><li><a href="#LeNet_154" rel="nofollow">LeNet</a></li><li><a href="#AlexNet_189" rel="nofollow">AlexNet</a></li><li><a href="#VGGNet_215" rel="nofollow">VGGNet</a></li><li><a href="#ReseNet_303" rel="nofollow">ReseNet</a></li></ul> 
  </li><li><a href="#_308" rel="nofollow">分类网络的实现</a></li><li><a href="#_454" rel="nofollow">模型训练</a></li><li><ul><li><a href="#_455" rel="nofollow">损失函数</a></li><li><a href="#_457" rel="nofollow">优化器</a></li><li><a href="#_459" rel="nofollow">学习率</a></li><li><a href="#_461" rel="nofollow">训练与验证</a></li></ul> 
  </li><li><a href="#_642" rel="nofollow">模型展示</a></li><li><a href="#_682" rel="nofollow">多标签分类</a></li><li><ul><li><a href="#_683" rel="nofollow">验证码生成</a></li><li><a href="#_803" rel="nofollow">模型搭建</a></li><li><a href="#_878" rel="nofollow">模型训练</a></li><li><a href="#_974" rel="nofollow">验证码识别</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>数据增强</h2> 
<p>数据增强是一种在训练模型过程中用于提高样本多样性，增强模型泛化能力的手段。在对图像进行数据增强时，必须保留图像中与标签对应的关键信息。使用了两种数据增强手段：随机裁剪和随机翻转。其中随机裁剪是先在图片外围补存4个像素，然后在图片中随机裁剪32×32图片的方法：随机翻转是按一定概率选择是否对图片进行翻转处理的方法。这两种手段都不会改变图片原有的信息（随机裁剪后保留的信息占原图的比例足够大，所以信息会得以保留）。</p> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets<span class="token punctuation">,</span> transforms
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> make_blobs
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">import</span> resnet18
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

<span class="token comment">#定义设备</span>
device<span class="token operator">=</span><span class="token punctuation">(</span>
    torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">#数据目录</span>
data_folder<span class="token operator">=</span><span class="token string">"/data/cifar10"</span>
<span class="token comment">#模型存储目录</span>
checkpoint_folder<span class="token operator">=</span><span class="token string">"/data/chapter_one"</span>
<span class="token comment">#每一个批次图片的数量</span>
batch_size<span class="token operator">=</span><span class="token number">64</span>
<span class="token comment">#随着训练的次数增加，逐步缩小学习率</span>
epochs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0.0001</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment">#标签列表</span>
label_list<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token string">"airplane"</span> <span class="token punctuation">,</span> <span class="token string">"automobile"</span> <span class="token punctuation">,</span> <span class="token string">"bird"</span> <span class="token punctuation">,</span><span class="token string">"cat"</span> <span class="token punctuation">,</span><span class="token string">"deer"</span> <span class="token punctuation">,</span><span class="token string">"dog"</span> <span class="token punctuation">,</span>
    <span class="token string">"frog"</span>     <span class="token punctuation">,</span> <span class="token string">"horse"</span>      <span class="token punctuation">,</span> <span class="token string">"ship"</span> <span class="token punctuation">,</span><span class="token string">"truck"</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token keyword">import</span> torchvision
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>utils <span class="token keyword">import</span> make_grid
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> config <span class="token keyword">import</span> data_folder

<span class="token comment">#将上级目录加入系统目录</span>
sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">show_batch</span><span class="token punctuation">(</span>display_transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#重新定义一个不带Normalize的DataLoader，因为归一化处理后的图片很难辨认</span>
    <span class="token keyword">if</span> display_transform<span class="token operator">==</span><span class="token boolean">None</span><span class="token punctuation">:</span>
        display_transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#解压数据</span>
    display_set<span class="token operator">=</span>torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>CIFAR10<span class="token punctuation">(</span>
        root<span class="token operator">=</span>data_folder<span class="token punctuation">,</span>train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>transform<span class="token operator">=</span>display_transform
    <span class="token punctuation">)</span>
    <span class="token comment">#训练集加载器,自动分割成batch</span>
    display_loader<span class="token operator">=</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>display_set<span class="token punctuation">,</span>batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token comment">#将数据转换为图片</span>
    topil<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToPILImage<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#获取图片</span>
    <span class="token keyword">for</span> batch_img<span class="token punctuation">,</span>batch_label <span class="token keyword">in</span> display_loader<span class="token punctuation">:</span>
        <span class="token comment">#将图片拼接</span>
        grid<span class="token operator">=</span>make_grid<span class="token punctuation">(</span>batch_img<span class="token punctuation">,</span>nrow<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token comment">#将图片转换</span>
        grid_img<span class="token operator">=</span>topil<span class="token punctuation">(</span>grid<span class="token punctuation">)</span>
        <span class="token comment">#显示图片</span>
        plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>grid_img<span class="token punctuation">)</span>
        grid_img<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"./img/trans_cifar10.png"</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span> 
        


<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    transform_train<span class="token operator">=</span>transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>RandomCrop<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    show_batch<span class="token punctuation">(</span>transform_train<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/57/88/AEUjqTmI_o.png" alt="在这里插入图片描述"><br> 可以看到，处理之后的图片虽然与原图片稍有不同，出现了有一些黑色边框，但是图片中的主要内容保持不变，也就是保证了数据增强之后标签的真实性。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torchvision
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">import</span> torch

<span class="token keyword">from</span> config <span class="token keyword">import</span> data_folder<span class="token punctuation">,</span>batch_size
<span class="token comment">#创建数据集</span>
<span class="token keyword">def</span> <span class="token function">create_datasets</span><span class="token punctuation">(</span>data_folder<span class="token punctuation">,</span>transform_train<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>transform_test<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#训练过程中的图像增强与数据转换</span>
    <span class="token keyword">if</span> transform_train <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        transform_train<span class="token operator">=</span>transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>
            <span class="token comment">#扩张之后再随机裁剪</span>
            transforms<span class="token punctuation">.</span>RandomCrop<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">#随机翻转</span>
            transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">#将图片转换成Tensor()</span>
            transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">#根据CIFAR-10数据集的各个通道上的像素均值和方差进行归一化处理，使模型更易拟合</span>
            transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token number">0.4914</span><span class="token punctuation">,</span><span class="token number">0.4822</span><span class="token punctuation">,</span><span class="token number">0.4465</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.2023</span><span class="token punctuation">,</span><span class="token number">0.1994</span><span class="token punctuation">,</span><span class="token number">0.2010</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token comment">#测试过程中的数据转换</span>
    <span class="token keyword">if</span> transform_test <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        transform_test<span class="token operator">=</span>transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>
                <span class="token comment">#测试过程中的数据转换</span>
                transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token number">0.4914</span><span class="token punctuation">,</span><span class="token number">0.4822</span><span class="token punctuation">,</span><span class="token number">0.4465</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0.2023</span><span class="token punctuation">,</span><span class="token number">0.1994</span><span class="token punctuation">,</span><span class="token number">0.2010</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        <span class="token comment">#训练集</span>
        trainset<span class="token operator">=</span>torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>CIFAR10<span class="token punctuation">(</span>
            root<span class="token operator">=</span>data_folder<span class="token punctuation">,</span>train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>transform<span class="token operator">=</span>transform_train
        <span class="token punctuation">)</span>
        <span class="token comment">#训练集Loader</span>
        trainLoader<span class="token operator">=</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
            trainset<span class="token punctuation">,</span>
            batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
            shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            num_workers<span class="token operator">=</span><span class="token number">2</span>
        <span class="token punctuation">)</span>
        <span class="token comment">#测试集</span>
        testset <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>CIFAR10<span class="token punctuation">(</span>
            root<span class="token operator">=</span>data_folder<span class="token punctuation">,</span>
            train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            transform<span class="token operator">=</span>transform_test
        <span class="token punctuation">)</span>
        <span class="token comment">#测试集Loader</span>
        testLoader<span class="token operator">=</span>torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
            testset<span class="token punctuation">,</span>
            batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
            shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            num_workers<span class="token operator">=</span><span class="token number">2</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> trainLoader<span class="token punctuation">,</span>testLoader
        
</code></pre> 
<p>两个数据集经过DataLoader封装成批次数据，便可以输入模型中进行并行训练了。</p> 
<h2><a id="_153"></a>卷积神经网络的发展</h2> 
<h3><a id="LeNet_154"></a>LeNet</h3> 
<p>LeNet-5是一个较简单的卷积神经网络。下图显示了其结构：输入的二维图像，先经过两次卷积层到池化层，再经过全连接层，最后使用softmax分类作为输出层。<br> <img src="https://images2.imgbox.com/96/81/shS4lrAL_o.png" alt="在这里插入图片描述"><br> 1、INPUT层-输入层<br> 首先是数据 INPUT 层，输入图像的尺寸统一归一化为32*32。 注意：本层不算LeNet-5的网络结构，传统上，不将输入层视为网络层次结构之一。</p> 
<p>2、C1层-卷积层<br> 详细说明：对输入图像进行第一次卷积运算（使用 6 个大小 为 5<em>5 的卷积核），得到6个C1特征图（6个大小为28</em>28的 feature maps, 32-5+1=28）。我们再来看看需要多少个参数，卷积核的大小为5<em>5，总共就有6</em>（5<em>5+1）=156个参数，其中+1是表示一个核有一个bias。对于卷积层C1，C1内的每个像素都与输入图像中的5</em>5个像素和1个bias有连接，所以总共有156<em>28</em>28=122304个连接（connection）。有122304个连接，但是我们只需要学习156个参数，主要是通过权值共享实现的。</p> 
<p>3、S2层-池化层（下采样层）<br> 详细说明：第一次卷积之后紧接着就是池化运算，使用 2<em>2核 进行池化，于是得到了S2，6个14</em>14的 特征图（28/2=14）。S2这个pooling层是对C1中的2*2区域内的像素求和乘以一个权值系数再加上一个偏置，然后将这个结果再做一次映射。于是每个池化核有两个训练参数，所以共有2x6=12个训练参数，但是有5x14x14x6=5880个连接。</p> 
<p>4、C3层-卷积层<br> 详细说明：第一次池化之后是第二次卷积，第二次卷积的输出是C3，16个10x10的特征图，卷积核大小是 5<em>5. 我们知道S2 有6个 14</em>14 的特征图，怎么从6 个特征图得到 16个特征图了？ 这里是通过对S2 的特征图特殊组合计算得到的16个特征图。<br> <img src="https://images2.imgbox.com/50/b8/PPx71yQn_o.png" alt="在这里插入图片描述"><br> C3的前6个feature map（对应上图第一个红框的6列）与S2层相连的3个feature map相连接（上图第一个红框），后面6个feature map与S2层相连的4个feature map相连接（上图第二个红框），后面3个feature map与S2层部分不相连的4个feature map相连接，最后一个与S2层的所有feature map相连。卷积核大小依然为5<em>5，所以总共有6</em>(3<em>5</em>5+1)+6*(4<em>5</em>5+1)+3*(4<em>5</em>5+1)+1*(6<em>5</em>5+1)=1516个参数。而图像大小为10*10，所以共有151600个连接。</p> 
<p>5、S4层-池化层（下采样层）<br> 详细说明：S4是pooling层，窗口大小仍然是2*2，共计16个feature map，C3层的16个10x10的图分别进行以2x2为单位的池化得到16个5x5的特征图。这一层有2x16共32个训练参数，5x5x5x16=2000个连接。连接的方式与S2层类似。</p> 
<p>6、C5层-卷积层<br> 详细说明：C5层是一个卷积层。由于S4层的16个图的大小为5x5，与卷积核的大小相同，所以卷积后形成的图的大小为1x1。这里形成120个卷积结果。每个都与上一层的16个图相连。所以共有(5x5x16+1)x120 = 48120个参数，同样有48120个连接。C5层的网络结构如下：<br> <img src="https://images2.imgbox.com/d2/70/c1MTZ0fS_o.png" alt="在这里插入图片描述"></p> 
<p>7、F6层-全连接层<br> 详细说明：6层是全连接层。F6层有84个节点，对应于一个7x12的比特图，-1表示白色，1表示黑色，这样每个符号的比特图的黑白色就对应于一个编码。该层的训练参数和连接数是(120 + 1)x84=10164。ASCII编码图如下：<br> <img src="https://images2.imgbox.com/db/28/l5fHYjUr_o.png" alt="在这里插入图片描述"></p> 
<p>8、Output层-全连接层<br> Output层也是全连接层，共有10个节点，分别代表数字0到9，且如果节点i的值为0，则网络识别的结果是数字i。采用的是径向基函数（RBF）的网络连接方式。假设x是上一层的输入，y是RBF的输出，则RBF输出的计算方式是：<br> <img src="https://images2.imgbox.com/df/a8/BEGTwHM6_o.png" alt="在这里插入图片描述"><br> 上式w_ij 的值由i的比特图编码确定，i从0到9，j取值从0到7*12-1。RBF输出的值越接近于0，则越接近于i，即越接近于i的ASCII编码图，表示当前网络输入的识别结果是字符i。该层有84x10=840个参数和连接。<br> <img src="https://images2.imgbox.com/b4/ca/zPHEVsDR_o.png" alt="在这里插入图片描述"><br> 原文来自：<a href="https://www.csdn.net/">https://www.cnblogs.com/duanhx/articles/9655228.html</a></p> 
<h3><a id="AlexNet_189"></a>AlexNet</h3> 
<p>AlexNet中主要提出了ReLU激活函数和Dropout方法，同时还引入了数据增强操作，使用模型的泛化能力得到进一步提高。<br> AlexNet中包含了5个卷积层和3个全连接层，层数比LeNet多，但是卷积、池化这样的总体流程没有改变。AlexNet中用到的3个训练技巧对最终的结果起到了积极作用。整个AlexNet前5层为卷积层，后3个为全连接层，其中最后一层是1000类输出的Softmax分类输出层。LRN层在第1个及第2个卷积层之后，Max pooling层在两个LRN层之后和最后一个卷积层之后。ReLU激活函数跟在5个卷积层和2个全连接层后面（最后输出层没有）。因为AlexNet训练时使用了两块GPU，因此这个结构图中不少组件都被拆为了两部分。现在我们GPU的显存足够大可以放下全部模型参数，因此只考虑一块GPU的情况。</p> 
<pre><code class="prism language-python">Input：图片尺寸<span class="token number">224</span><span class="token operator">*</span><span class="token number">224</span>
Conv1：卷积核<span class="token number">11</span><span class="token operator">*</span><span class="token number">11</span>，步长<span class="token number">4</span>，<span class="token number">96</span>个<span class="token builtin">filter</span>（卷积核尺寸较大）
ReLU
LRN1
Max pooling1：<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>，步长<span class="token number">2</span>
Conv2：卷积核<span class="token number">5</span><span class="token operator">*</span><span class="token number">5</span>，步长<span class="token number">1</span>，<span class="token number">256</span>个<span class="token builtin">filter</span>
ReLU
LRN2
Max pooling2：<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>，步长<span class="token number">2</span>
Conv3：卷积核<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>，步长<span class="token number">1</span>，<span class="token number">384</span>个<span class="token builtin">filter</span>
ReLU
Conv4：卷积核<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>，步长<span class="token number">1</span>，<span class="token number">384</span>个<span class="token builtin">filter</span>
ReLU
Conv5：卷积核<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>，步长<span class="token number">1</span>，<span class="token number">256</span>个<span class="token builtin">filter</span>
ReLU
Max pooling3：<span class="token number">3</span><span class="token operator">*</span><span class="token number">3</span>，步长<span class="token number">2</span>
FC1：<span class="token number">4096</span>
ReLU
FC2：<span class="token number">4096</span>
ReLU
FC3（Output）：<span class="token number">100</span>
</code></pre> 
<h3><a id="VGGNet_215"></a>VGGNet</h3> 
<pre><code class="prism language-python">VGG16 各层的结构和参数如下：
C1<span class="token operator">-</span><span class="token number">1</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">224</span> x <span class="token number">224</span> x <span class="token number">3</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">3</span>   滤波器个数：<span class="token number">64</span>
输出： <span class="token number">224</span> x <span class="token number">224</span> x <span class="token number">64</span>

C1<span class="token operator">-</span><span class="token number">2</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">224</span> x <span class="token number">224</span> x <span class="token number">3</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">3</span>   滤波器个数：<span class="token number">64</span>
输出： <span class="token number">224</span> x <span class="token number">224</span> x <span class="token number">64</span>

P1层是C1<span class="token operator">-</span><span class="token number">2</span>后面的池化层，其输入输出结构如下：
输入： <span class="token number">224</span> x <span class="token number">224</span> x <span class="token number">64</span>  滤波器大小： <span class="token number">2</span> x <span class="token number">2</span>   滤波器个数：<span class="token number">64</span>
输出： <span class="token number">112</span> x <span class="token number">112</span> x <span class="token number">64</span>

C2<span class="token operator">-</span><span class="token number">1</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">112</span> x <span class="token number">112</span> x <span class="token number">64</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">64</span>  滤波器个数：<span class="token number">128</span>
输出： <span class="token number">112</span> x <span class="token number">112</span> x <span class="token number">128</span>

C2<span class="token operator">-</span><span class="token number">2</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">112</span> x <span class="token number">112</span> x <span class="token number">64</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">64</span>  滤波器个数：<span class="token number">128</span>
输出： <span class="token number">112</span> x <span class="token number">112</span> x <span class="token number">128</span>

P2层是C2<span class="token operator">-</span><span class="token number">2</span>后面的池化层，其输入输出结构如下：
输入： <span class="token number">112</span> x <span class="token number">112</span> x <span class="token number">128</span> 滤波器大小： <span class="token number">2</span> x <span class="token number">2</span>   滤波器个数：<span class="token number">128</span>
输出： <span class="token number">56</span> x <span class="token number">56</span> x <span class="token number">128</span>

C3<span class="token operator">-</span><span class="token number">1</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">56</span> x <span class="token number">56</span> x <span class="token number">128</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">128</span>  滤波器个数：<span class="token number">256</span>
输出： <span class="token number">56</span> x <span class="token number">56</span> x <span class="token number">256</span>

C3<span class="token operator">-</span><span class="token number">2</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">56</span> x <span class="token number">56</span> x <span class="token number">256</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">256</span>  滤波器个数：<span class="token number">256</span>
输出： <span class="token number">56</span> x <span class="token number">56</span> x <span class="token number">256</span>

C3<span class="token operator">-</span><span class="token number">3</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">56</span> x <span class="token number">56</span> x <span class="token number">256</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">256</span>  滤波器个数：<span class="token number">256</span>
输出： <span class="token number">56</span> x <span class="token number">56</span> x <span class="token number">256</span>

P3层是C3<span class="token operator">-</span><span class="token number">3</span>后面的池化层，其输入输出结构如下：
输入： <span class="token number">56</span> x <span class="token number">56</span> x <span class="token number">256</span>  滤波器大小： <span class="token number">2</span> x <span class="token number">2</span>    滤波器个数：<span class="token number">256</span>
输出： <span class="token number">28</span> x <span class="token number">28</span> x <span class="token number">256</span>

C4<span class="token operator">-</span><span class="token number">1</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">28</span> x <span class="token number">28</span> x <span class="token number">256</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">256</span>  滤波器个数：<span class="token number">512</span>
输出： <span class="token number">28</span> x <span class="token number">28</span> x <span class="token number">512</span>

C4<span class="token operator">-</span><span class="token number">2</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">28</span> x <span class="token number">28</span> x <span class="token number">512</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">256</span>  滤波器个数：<span class="token number">512</span>
输出： <span class="token number">28</span> x <span class="token number">28</span> x <span class="token number">512</span>

C4<span class="token operator">-</span><span class="token number">3</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">28</span> x <span class="token number">28</span> x <span class="token number">512</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">256</span>  滤波器个数：<span class="token number">512</span>
输出： <span class="token number">28</span> x <span class="token number">28</span> x <span class="token number">512</span>

P4层是C4<span class="token operator">-</span><span class="token number">3</span>后面的池化层，其输入输出结构如下：
输入： <span class="token number">28</span> x <span class="token number">28</span> x <span class="token number">512</span> 滤波器大小： <span class="token number">2</span> x <span class="token number">2</span>    滤波器个数：<span class="token number">512</span>
输出： <span class="token number">14</span> x <span class="token number">14</span> x <span class="token number">512</span>

C5<span class="token operator">-</span><span class="token number">1</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">14</span> x <span class="token number">14</span> x <span class="token number">512</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">512</span>  滤波器个数：<span class="token number">512</span>
输出： <span class="token number">14</span> x <span class="token number">14</span> x <span class="token number">512</span>

C5<span class="token operator">-</span><span class="token number">2</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">14</span> x <span class="token number">14</span> x <span class="token number">512</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">512</span>  滤波器个数：<span class="token number">512</span>
输出： <span class="token number">14</span> x <span class="token number">14</span> x <span class="token number">512</span>

C5<span class="token operator">-</span><span class="token number">3</span>层是个卷积层，其输入输出结构如下：
输入： <span class="token number">14</span> x <span class="token number">14</span> x <span class="token number">512</span>  滤波器大小： <span class="token number">3</span> x <span class="token number">3</span> x <span class="token number">512</span>  滤波器个数：<span class="token number">512</span>
输出： <span class="token number">14</span> x <span class="token number">14</span> x <span class="token number">512</span>

P5层是C5<span class="token operator">-</span><span class="token number">3</span>后面的池化层，其输入输出结构如下：
输入： <span class="token number">14</span> x <span class="token number">14</span> x <span class="token number">512</span> 滤波器大小： <span class="token number">2</span> x <span class="token number">2</span>    滤波器个数：<span class="token number">512</span>
输出： <span class="token number">7</span> x <span class="token number">7</span> x <span class="token number">512</span>

F6层是个全连接层，其输入输出结构如下：
输入：<span class="token number">4096</span>
输出：<span class="token number">4096</span>

F7层是个全连接层，其输入输出结构如下：
输入：<span class="token number">4096</span>
输出：<span class="token number">4096</span>

F8层也是个全连接层，即输出层，其输入输出结构如下：
输入：<span class="token number">4096</span>
输出：<span class="token number">1000</span> 作者：自兴人工智能教育 https<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>bilibili<span class="token punctuation">.</span>com<span class="token operator">/</span>read<span class="token operator">/</span>cv2686620<span class="token operator">/</span> 出处：bilibili
</code></pre> 
<p><img src="https://images2.imgbox.com/de/ae/mKJ6UiNe_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="ReseNet_303"></a>ReseNet</h3> 
<p>我们知道，网络越深，咱们能获取的信息越多，而且特征也越丰富。但是根据实验表明，随着网络的加深，优化效果反而越差，测试数据和训练数据的准确率反而降低了。这是由于网络的加深会造成梯度爆炸和梯度消失的问题。<br> <img src="https://images2.imgbox.com/f4/36/0FGioACV_o.png" alt="在这里插入图片描述"><br> 残差：观测值与输入值之间的差。这里H(x)就是观测值，x就是输入值（也就是上一层ResNet输出的特征映射）。我们一般称x为identity Function，它是一个跳跃连接；称F(x)为残差映射ResNet Function。那么咱们要求解的问题变成了H(x) = F(x)+x。<br> 原文链接: <a href="https://www.csdn.net/">https://www.xr686.com/71210.html</a></p> 
<h2><a id="_308"></a>分类网络的实现</h2> 
<p>本节将展示如何搭建适用于CIFAR-10分类的VGG和ResNet网络，因为PyTroch中提供的预训练好的VGGNet和ResNet都是在ImageNet上训练的，不适合CIFAR-10。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F

<span class="token keyword">class</span> <span class="token class-name">VGG</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cfg<span class="token punctuation">,</span>num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>VGG<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>features<span class="token operator">=</span>self<span class="token punctuation">.</span>_make_layers<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
        <span class="token comment">#512样本特征数，个人认为这种可能和经验有关</span>
        self<span class="token punctuation">.</span>classifier<span class="token operator">=</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span>num_classes<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_make_layers</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        layers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">#输入通道数,rgb =3</span>
        in_channels<span class="token operator">=</span><span class="token number">3</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> cfg<span class="token punctuation">:</span>
            <span class="token keyword">if</span> x<span class="token operator">==</span><span class="token string">"M"</span><span class="token punctuation">:</span>
                layers<span class="token operator">+=</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                layers<span class="token operator">+=</span><span class="token punctuation">[</span>
                    nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span>x<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">]</span>
                in_channels<span class="token operator">=</span>x
        <span class="token comment">#加入平均池化</span>
        <span class="token comment">#nn.AvgPool2d(2,2)和nn.MaxPool2d(2, 2)</span>
        <span class="token comment"># 一样是图像长宽缩小为原来的一半，即图像大小为原来的1/4。</span>
        <span class="token comment">#该接口用于构建 AvgPool2D 类的一个可调用对象，</span>
        <span class="token comment"># 其将构建一个二维平均池化层，根据输入参数 kernel_size, stride, padding 等参数对输入做平均池化操作。</span>
        layers<span class="token operator">+=</span><span class="token punctuation">[</span>nn<span class="token punctuation">.</span>AvgPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>layers<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#计算特征网络</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>features<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment">#view(out.size(0), -1)</span>
        <span class="token comment">#目的是将多维的的数据如（none，36，2，2）平铺为一维如（none，144）。</span>
        out<span class="token operator">=</span>out<span class="token punctuation">.</span>view<span class="token punctuation">(</span>out<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">#计算分类网络</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
    
<span class="token keyword">class</span> <span class="token class-name">BasicBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>in_channels<span class="token punctuation">,</span>mid_channels<span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv1<span class="token operator">=</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            in_channels<span class="token operator">=</span>in_channels<span class="token punctuation">,</span>
            out_channels<span class="token operator">=</span>mid_channels<span class="token punctuation">,</span>
            kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
            stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
            padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1<span class="token operator">=</span>nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>mid_channels<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2<span class="token operator">=</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            mid_channels<span class="token punctuation">,</span>
            mid_channels<span class="token punctuation">,</span>
            kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
            stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
            bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn2<span class="token operator">=</span>nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>mid_channels<span class="token punctuation">)</span>
        <span class="token comment">#定义短接网络，如果不需要调整维度，shortcut就是一个空的nn.Sequential</span>
        self<span class="token punctuation">.</span>shortcut<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#因为shortcut后需要将两个分支累加，所以要求两个分支的维度匹配</span>
        <span class="token comment">#所以input_channels与最终的channels不匹配时，需要通过1x1卷积进行升维</span>
        <span class="token keyword">if</span> stride <span class="token operator">!=</span><span class="token number">1</span> <span class="token keyword">or</span> in_channels <span class="token operator">!=</span>mid_channels<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>shortcut<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
                nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
                    in_channels<span class="token punctuation">,</span>
                    mid_channels<span class="token punctuation">,</span>
                    kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                    stride<span class="token operator">=</span>stride<span class="token punctuation">,</span>
                    bias<span class="token operator">=</span><span class="token boolean">False</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>mid_channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        out<span class="token operator">=</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>bn2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span>
        out<span class="token operator">+=</span>self<span class="token punctuation">.</span>shortcut<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        out<span class="token operator">=</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out

<span class="token keyword">class</span> <span class="token class-name">ResNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>block<span class="token punctuation">,</span>num_blocks<span class="token punctuation">,</span>num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ResNet<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>in_channels<span class="token operator">=</span><span class="token number">64</span>
        self<span class="token punctuation">.</span>conv1<span class="token operator">=</span>nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>
            <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>bias<span class="token operator">=</span><span class="token boolean">False</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn1<span class="token operator">=</span>nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>
        <span class="token comment">#搭建</span>
        self<span class="token punctuation">.</span>layer1<span class="token operator">=</span>self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>block<span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">,</span>num_blocks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer2<span class="token operator">=</span>self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>block<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>num_blocks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer3<span class="token operator">=</span>self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>block<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span>num_blocks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer4<span class="token operator">=</span>self<span class="token punctuation">.</span>_make_layer<span class="token punctuation">(</span>block<span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">,</span>num_blocks<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment">#最后的线性层</span>
        self<span class="token punctuation">.</span>linear<span class="token operator">=</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span>num_classes<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">_make_layer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>block<span class="token punctuation">,</span>mid_channels<span class="token punctuation">,</span>num_blocks<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">:</span>
        strides<span class="token operator">=</span><span class="token punctuation">[</span>stride<span class="token punctuation">]</span> <span class="token operator">+</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>
            num_blocks<span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">)</span><span class="token comment">#stride仅指定第一个block的stride，后面的stride都是1</span>
        layers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> stride <span class="token keyword">in</span> strides<span class="token punctuation">:</span>
            layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>block<span class="token punctuation">(</span>self<span class="token punctuation">.</span>in_channels<span class="token punctuation">,</span>mid_channels<span class="token punctuation">,</span>stride<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>in_channels<span class="token operator">=</span>mid_channels
        <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>layers<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        out<span class="token operator">=</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bn1<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer1<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer3<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer4<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out<span class="token operator">=</span>F<span class="token punctuation">.</span>avg_pool2d<span class="token punctuation">(</span>out<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
        out<span class="token operator">=</span>out<span class="token punctuation">.</span>view<span class="token punctuation">(</span>out<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out

<span class="token comment">#构建ResNet-18模型</span>
<span class="token keyword">def</span> <span class="token function">resnet18</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> ResNet<span class="token punctuation">(</span>BasicBlock<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token comment">#构建VGG-11模型</span>
<span class="token keyword">def</span> <span class="token function">vgg11</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    cfg<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token string">"M"</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token string">"M"</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token string">"M"</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token string">"M"</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token string">"M"</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> VGG<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> torchsummary <span class="token keyword">import</span> summary
    vggnet<span class="token operator">=</span>vgg11<span class="token punctuation">(</span><span class="token punctuation">)</span>
    resnet<span class="token operator">=</span>resnet18<span class="token punctuation">(</span><span class="token punctuation">)</span>

    summary<span class="token punctuation">(</span>vggnet<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#打印网状线</span>
    summary<span class="token punctuation">(</span>resnet<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/f8/ae/mxYTQx0W_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_454"></a>模型训练</h2> 
<h3><a id="_455"></a>损失函数</h3> 
<p>损失函数用于衡量预测值与实际值之间的误差，而模型的训练目标就是让损失函数越来越小。损失函数的选择根据模型不同会有所不同。</p> 
<h3><a id="_457"></a>优化器</h3> 
<p>优化器是预先制定好的优化模型参数的策略，是求损失函数极小值的方法。在神经网络中，因为模型和数据非常复杂，无法直接求得损失函数的极小值，所以通常采用迭代的方式求解。</p> 
<h3><a id="_459"></a>学习率</h3> 
<p>学习率的选择在神经网络训练任务中至关重要，对大部分神经网络模型来说，学习率是训练过程中需要调节的最主要参数，调节学习率需要一定的经验。</p> 
<h3><a id="_461"></a>训练与验证</h3> 
<p>在训练的过程中，可以进行实时验证，以便及时发现模型的过拟合现象，调整策略。<br> 模型训练过程中的注意现象：<br> 1.在对损失进行前向传播前，需要清空模型中的变量的梯度，避免上次的backward的梯度对这次参数更新造成影响，可以使用net.zero_grad或者optimizer.zero_grad<br> 2.需要进行损失累加或者其他保存损失的操作时，需要取loss.item,否则会造成模型中的梯度不断积累，使显存（或内存)占用越来越高，直至溢出。</p> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">from</span> torch <span class="token keyword">import</span> optim<span class="token punctuation">,</span>nn
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path <span class="token keyword">as</span> osp
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>tensorboard <span class="token keyword">import</span> SummaryWriter


<span class="token keyword">from</span> config <span class="token keyword">import</span> epochs <span class="token punctuation">,</span>device <span class="token punctuation">,</span>data_folder<span class="token punctuation">,</span>epochs<span class="token punctuation">,</span>checkpoint_folder
<span class="token keyword">from</span> data <span class="token keyword">import</span> create_datasets
<span class="token keyword">from</span> model <span class="token keyword">import</span> vgg11

<span class="token comment">#这里为后续的回归问题预留了一些代码</span>
<span class="token keyword">def</span> <span class="token function">train_val</span><span class="token punctuation">(</span>
    net<span class="token punctuation">,</span>trainloader<span class="token punctuation">,</span>valloder<span class="token punctuation">,</span>criteron<span class="token punctuation">,</span>epochs<span class="token punctuation">,</span>device<span class="token punctuation">,</span>model_name<span class="token operator">=</span><span class="token string">"cls"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    best_acc <span class="token operator">=</span> <span class="token number">0.0</span>
    best_loss<span class="token operator">=</span><span class="token number">1e9</span>
    writer<span class="token operator">=</span>SummaryWriter<span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">)</span>
    <span class="token comment">#如果模型文件已经存在，先加载模型文件在再此基础上训练</span>
    <span class="token comment">#join(path1,path2)，将path1和path2各部分组合成一个路径</span>
    <span class="token comment">#exists(path)判断指定路径（目录或文件）是否存在</span>
    <span class="token keyword">if</span> osp<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>checkpoint_folder<span class="token punctuation">,</span>model_name<span class="token operator">+</span><span class="token string">".pth"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>
            torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>checkpoint_folder<span class="token punctuation">,</span> model_name <span class="token operator">+</span> <span class="token string">".pth"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"model finish"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> n<span class="token punctuation">,</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">,</span>lr<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#params：要训练的参数，一般我们传入的都是model.parameters()。</span>
        <span class="token comment"># lr：learning_rate学习率，会梯度下降的应该都知道学习率吧，也就是步长。</span>
        <span class="token comment"># weight_decay（权重衰退）和learning_rate（学习率）的区别</span>
        <span class="token comment"># learning_rate就是我们熟知的更新权重的方式</span>
        optimizer<span class="token operator">=</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>
            net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lr<span class="token operator">=</span>lr<span class="token punctuation">,</span>weight_decay<span class="token operator">=</span><span class="token number">5e-4</span><span class="token punctuation">,</span>momentum<span class="token operator">=</span><span class="token number">0.9</span>
        <span class="token punctuation">)</span>
        <span class="token comment">#循环次数</span>
        <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
            epoch_loss<span class="token operator">=</span><span class="token number">0.0</span>
            epoch_acc<span class="token operator">=</span><span class="token number">0.0</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>label<span class="token punctuation">)</span> <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>
                <span class="token builtin">enumerate</span><span class="token punctuation">(</span>trainloader<span class="token punctuation">)</span><span class="token punctuation">,</span> total<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>trainloader<span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment">#将照片和标签</span>
                <span class="token comment"># 这段代码的意思就是将所有最开始读取数据时的tensor</span>
                <span class="token comment"># 变量copy一份到device所指定的GPU上去，之后的运算都在GPU上进行。</span>
                img<span class="token punctuation">,</span>label<span class="token operator">=</span>img<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span> <span class="token punctuation">,</span>label<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                output<span class="token operator">=</span>net<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
                <span class="token comment">#清空梯度</span>
                optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">#计算损失</span>
                loss<span class="token operator">=</span>criteron<span class="token punctuation">(</span>output<span class="token punctuation">,</span>label<span class="token punctuation">)</span>
                <span class="token comment">#反向传播</span>
                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">#更新参数</span>
                optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">#分类问题容易使用准确率来衡量模型效果</span>
                <span class="token keyword">if</span> model_name<span class="token operator">==</span><span class="token string">"cls"</span><span class="token punctuation">:</span>
                    <span class="token comment">#将输入input张量，无论有几维，</span>
                    <span class="token comment"># 首先将其reshape排列成一个一维向量，然后找出这个一维向量里面最大值的索引。</span>
                    pred<span class="token operator">=</span>torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>output<span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                    acc<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>pred<span class="token operator">==</span>label<span class="token punctuation">)</span>
                    <span class="token comment">#累加计算准确率</span>
                    epoch_acc<span class="token operator">+=</span>acc<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    epoch_loss<span class="token operator">+=</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                <span class="token comment">#计算平均损失</span>
                epoch_loss<span class="token operator">=</span>epoch_loss<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>trainloader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
                <span class="token keyword">if</span> model_name<span class="token operator">==</span><span class="token string">"cls"</span><span class="token punctuation">:</span>

                    epoch_acc <span class="token operator">=</span> epoch_acc <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>trainloader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>
                        <span class="token string">"epoch loss:{:.8f} epoch accuary : {:.8f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                            epoch_loss<span class="token punctuation">,</span>epoch_acc
                        <span class="token punctuation">)</span>
                     <span class="token punctuation">)</span>
                    <span class="token comment">#将损失添加到TensorBoard中</span>
                    writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span>
                        <span class="token string">"epoch_loss_{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>model_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        epoch_loss<span class="token punctuation">,</span>
                        <span class="token builtin">sum</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> epochs<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span>epoch<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span>
                    <span class="token comment">#将准确率添加到TensorBoard中</span>
                    writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span>
                       <span class="token string">"epoch_acc_{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>model_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        epoch_acc<span class="token punctuation">,</span>
                        <span class="token builtin">sum</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> epochs<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> epoch<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch loss:{:.8f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span>
                        <span class="token string">"epoch_loss_{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>model_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        epoch_loss<span class="token punctuation">,</span>
                        <span class="token builtin">sum</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> epochs<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> epoch<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span>
                <span class="token comment">#无梯度模式下快速验证</span>
                <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token comment">#将net设置为验证模式</span>
                    <span class="token comment"># train训练模式，eval测试/评估模式</span>
                    <span class="token comment"># net.eval()</span>
                    val_loss<span class="token operator">=</span><span class="token number">0.0</span>
                    val_acc<span class="token operator">=</span><span class="token number">0.0</span>
                    <span class="token keyword">for</span> i<span class="token punctuation">,</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>label<span class="token punctuation">)</span> <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span>valloder<span class="token punctuation">)</span><span class="token punctuation">,</span> total<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>valloder<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">:</span>
                        img<span class="token punctuation">,</span> label <span class="token operator">=</span> img<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> label<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                        output <span class="token operator">=</span> net<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
                        <span class="token comment">#计算损失</span>
                        loss <span class="token operator">=</span> criteron<span class="token punctuation">(</span>output<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> model_name<span class="token operator">==</span><span class="token string">"cls"</span><span class="token punctuation">:</span>
                            <span class="token comment">#将输入input张量，无论有几维，</span>
                            <span class="token comment"># 首先将其reshape排列成一个一维向量，然后找出这个一维向量里面最大值的索引。</span>
                            pred<span class="token operator">=</span>torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>output<span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                            acc<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>pred<span class="token operator">==</span>label<span class="token punctuation">)</span>
                            val_acc<span class="token operator">+=</span>acc<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        val_loss<span class="token operator">+=</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    val_loss <span class="token operator">/=</span><span class="token builtin">len</span><span class="token punctuation">(</span>valloder<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
                    val_acc <span class="token operator">/=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>valloder<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> model_name<span class="token operator">==</span><span class="token string">"cls"</span><span class="token punctuation">:</span>
                        <span class="token comment">#如果验证之后的模型超过了目前最好的模型</span>
                        <span class="token keyword">if</span> val_acc <span class="token operator">&gt;</span>best_acc<span class="token punctuation">:</span>
                            <span class="token comment">#更新</span>
                            best_acc<span class="token operator">=</span>val_acc
                            <span class="token comment">#保存模型</span>
                            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>
                                net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>checkpoint_folder<span class="token punctuation">,</span>model_name<span class="token operator">+</span><span class="token string">".pth"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">)</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span>
                        <span class="token string">"validation loss:{:.8f} epoch accuary : {:.8f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                            val_loss<span class="token punctuation">,</span>val_acc
                        <span class="token punctuation">)</span>
                        <span class="token punctuation">)</span>
                        <span class="token comment">#加入TensorBoard</span>
                        <span class="token comment">#将损失添加到TensorBoard中</span>
                        writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span>
                         <span class="token string">"validation_loss_{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>model_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          val_loss<span class="token punctuation">,</span>
                          <span class="token builtin">sum</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> epochs<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> epoch<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                        <span class="token comment">#将准确率添加到TensorBoard中</span>
                        writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span>
                            <span class="token string">"validation_acc_{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>model_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            val_acc<span class="token punctuation">,</span>
                            <span class="token builtin">sum</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> epochs<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> epoch<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token comment">#如果得到的损失比当前最好的损失还好</span>
                        <span class="token keyword">if</span> val_loss <span class="token operator">&lt;</span>best_loss<span class="token punctuation">:</span>
                            <span class="token comment">#更新best_loss</span>
                            best_loss<span class="token operator">=</span>val_loss
                            <span class="token comment">#保存模型</span>
                            torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>
                                net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>checkpoint_folder<span class="token punctuation">,</span>model_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">)</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"validation loss: {:.8}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>val_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        writer<span class="token punctuation">.</span>add_scalar<span class="token punctuation">(</span>
                            <span class="token string">"epoch_loss_{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>model_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                             val_loss<span class="token punctuation">,</span>
                             <span class="token builtin">sum</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> epochs<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> epoch<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
    writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    trainloader<span class="token punctuation">,</span>valloader <span class="token operator">=</span> create_datasets<span class="token punctuation">(</span>data_folder<span class="token punctuation">)</span>
    net<span class="token operator">=</span>vgg11<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    criteron<span class="token operator">=</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    train_val<span class="token punctuation">(</span>net<span class="token punctuation">,</span>trainloader<span class="token punctuation">,</span>valloader<span class="token punctuation">,</span>criteron<span class="token punctuation">,</span>epochs<span class="token punctuation">,</span>device<span class="token punctuation">)</span>

</code></pre> 
<p>上述代码定义了分类模型和回归模型的训练过程，分为如下几个步骤：<br> 1）开始训练前，查看有没有预训练过的模型，如果有，先把模型就加载进来再在此基础上训练。这项操作可以方便在调整了参数之后继续之前的训练。<br> 2）定义模型，优化器，损失函数和数据。<br> 3）遍历数据，将数据输入模型进行前向传播，计算结果用于计算模型损失。<br> 4）根据损失进行反向传播，更新模型参数。<br> 5）每次遍历完训练数据集后，再遍历验证数据集，进行模型效果验证。验证的作用是观察模型是否过拟合，所以不一定每次训练之后都需要验证。</p> 
<h2><a id="_642"></a>模型展示</h2> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path <span class="token keyword">as</span> osp
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">from</span> model <span class="token keyword">import</span> vgg11
<span class="token keyword">from</span> config <span class="token keyword">import</span> checkpoint_folder <span class="token punctuation">,</span> label_list
<span class="token keyword">from</span> data <span class="token keyword">import</span> create_datasets

<span class="token keyword">def</span> <span class="token function">demo</span><span class="token punctuation">(</span>img_patch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    totensor<span class="token operator">=</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#输入前需要调整尺寸</span>
    img<span class="token operator">=</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_patch<span class="token punctuation">)</span><span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#添加一个维度，以适应(N,C,H,W)格式</span>
    img_tensor<span class="token operator">=</span>totensor<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    net<span class="token operator">=</span>vgg11<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#加载模型</span>
    net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>osp<span class="token punctuation">.</span>join<span class="token punctuation">(</span>checkpoint_folder<span class="token punctuation">,</span><span class="token string">"cls.pth"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#验证模型</span>
    net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    output<span class="token operator">=</span>net<span class="token punctuation">(</span>img_tensor<span class="token punctuation">)</span>
    <span class="token comment">#跳圈概率最大的预测标签</span>
    label<span class="token operator">=</span>torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>output<span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>label_list<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"./cat.jpg"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    demo<span class="token punctuation">(</span><span class="token string">"./cat.jpg"</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b1/1b/KuvnUw8l_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_682"></a>多标签分类</h2> 
<h3><a id="_683"></a>验证码生成</h3> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">from</span> captcha<span class="token punctuation">.</span>image <span class="token keyword">import</span> ImageCaptcha
<span class="token keyword">from</span> random <span class="token keyword">import</span> randint<span class="token punctuation">,</span>seed
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token comment">#字符列表</span>
char_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'0'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'9'</span><span class="token punctuation">,</span>
           <span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'e'</span><span class="token punctuation">,</span><span class="token string">'f'</span><span class="token punctuation">,</span><span class="token string">'g'</span><span class="token punctuation">,</span><span class="token string">'h'</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">,</span><span class="token string">'j'</span><span class="token punctuation">,</span><span class="token string">'k'</span><span class="token punctuation">,</span>
           <span class="token string">'l'</span><span class="token punctuation">,</span><span class="token string">'m'</span><span class="token punctuation">,</span><span class="token string">'n'</span><span class="token punctuation">,</span><span class="token string">'o'</span><span class="token punctuation">,</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token string">'q'</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token string">'s'</span><span class="token punctuation">,</span><span class="token string">'t'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">,</span><span class="token string">'v'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>
            <span class="token string">'x'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">,</span><span class="token string">'z'</span><span class="token punctuation">,</span>
         <span class="token punctuation">]</span>

<span class="token comment">#创建空字符，用于记录验证码标签</span>
chars<span class="token operator">=</span><span class="token string">''</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Return random integer in range [a, b], including both end points.</span>
    <span class="token comment"># range(5) 相当于 range(0,5) 01234，range(a,b) ，即取值个数是b-a，不包含b</span>
    chars<span class="token operator">+=</span>char_list<span class="token punctuation">[</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment">#生成验证码</span>
image<span class="token operator">=</span>ImageCaptcha<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generate_image<span class="token punctuation">(</span>chars<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/78/47/6howjgwR_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">from</span> captcha<span class="token punctuation">.</span>image <span class="token keyword">import</span> ImageCaptcha
<span class="token keyword">from</span> random <span class="token keyword">import</span> randint<span class="token punctuation">,</span> seed
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span>DataLoader
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

char_list<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token string">"0"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">,</span><span class="token string">"4"</span><span class="token punctuation">,</span><span class="token string">"5"</span><span class="token punctuation">,</span><span class="token string">"6"</span><span class="token punctuation">,</span><span class="token string">"7"</span><span class="token punctuation">,</span><span class="token string">"8"</span><span class="token punctuation">,</span><span class="token string">"9"</span><span class="token punctuation">,</span>
    <span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token string">"d"</span><span class="token punctuation">,</span><span class="token string">"e"</span><span class="token punctuation">,</span><span class="token string">"f"</span><span class="token punctuation">,</span><span class="token string">"g"</span><span class="token punctuation">,</span><span class="token string">"h"</span><span class="token punctuation">,</span><span class="token string">"i"</span><span class="token punctuation">,</span>
    <span class="token string">"j"</span><span class="token punctuation">,</span><span class="token string">"k"</span><span class="token punctuation">,</span><span class="token string">"l"</span><span class="token punctuation">,</span><span class="token string">"m"</span><span class="token punctuation">,</span><span class="token string">"n"</span><span class="token punctuation">,</span><span class="token string">"o"</span><span class="token punctuation">,</span><span class="token string">"p"</span><span class="token punctuation">,</span><span class="token string">"q"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">,</span><span class="token string">"s"</span><span class="token punctuation">,</span>
    <span class="token string">"t"</span><span class="token punctuation">,</span><span class="token string">"u"</span><span class="token punctuation">,</span><span class="token string">"v"</span><span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">,</span><span class="token string">"x"</span><span class="token punctuation">,</span><span class="token string">"y"</span><span class="token punctuation">,</span><span class="token string">"z"</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">CaptchaData</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>char_list<span class="token punctuation">,</span>num<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#字符列表</span>
        self<span class="token punctuation">.</span>char_list<span class="token operator">=</span>char_list
        <span class="token comment">#字符转ID</span>
        self<span class="token punctuation">.</span>char2index<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            self<span class="token punctuation">.</span>char_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">:</span> i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>char_list<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">#标签列表</span>
        self<span class="token punctuation">.</span>label_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">#图片列表</span>
        self<span class="token punctuation">.</span>img_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">#生成验证码数量</span>
        self<span class="token punctuation">.</span>num<span class="token operator">=</span>num
        <span class="token keyword">for</span> i <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            chars<span class="token operator">=</span><span class="token string">""</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># Return random integer in range [a, b], including both end points.</span>
                <span class="token comment"># range(5) 相当于 range(0,5) 01234，range(a,b) ，即取值个数是b-a，不包含b</span>
                chars<span class="token operator">+=</span>self<span class="token punctuation">.</span>char_list<span class="token punctuation">[</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token comment">#生成验证码</span>
            image<span class="token operator">=</span>ImageCaptcha<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>generate_image<span class="token punctuation">(</span>chars<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>img_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
            <span class="token comment">#不区分大小写</span>
            self<span class="token punctuation">.</span>label_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>chars<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#通过index去除验证码和对应标签</span>
        chars<span class="token operator">=</span>self<span class="token punctuation">.</span>label_list<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        image<span class="token operator">=</span>self<span class="token punctuation">.</span>img_list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">"L"</span><span class="token punctuation">)</span>
        <span class="token comment">#将字符转成Tensor</span>
        chars_tensor<span class="token operator">=</span>self<span class="token punctuation">.</span>_numerical<span class="token punctuation">(</span>chars<span class="token punctuation">)</span>
        iamge_tensor<span class="token operator">=</span>self<span class="token punctuation">.</span>_totensor<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        <span class="token comment">#把标签转换为One-Hot编码</span>
        label<span class="token operator">=</span>chars_tensor<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        label_onehot<span class="token operator">=</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span>
        label_onehot<span class="token punctuation">.</span>scatter_<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>label<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
        label<span class="token operator">=</span>label_onehot<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> iamge_tensor<span class="token punctuation">,</span>label

    <span class="token keyword">def</span> <span class="token function">_numerical</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>chars<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#标签字符转id</span>
        chars_tensor<span class="token operator">=</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            chars_tensor<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>self<span class="token punctuation">.</span>char2index<span class="token punctuation">[</span>chars<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> chars_tensor

    <span class="token keyword">def</span> <span class="token function">_totensor</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#图片转tensor</span>
        <span class="token keyword">return</span> transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#必须指定Dataset的长度</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>num

<span class="token comment">#实例化一个Dataset</span>
data<span class="token operator">=</span>CaptchaData<span class="token punctuation">(</span>char_list<span class="token punctuation">,</span>num<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span>
<span class="token comment">#多进程加载</span>
dataloader<span class="token operator">=</span>DataLoader<span class="token punctuation">(</span>data<span class="token punctuation">,</span>batch_size<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
val_data <span class="token operator">=</span> CaptchaData<span class="token punctuation">(</span>char_list<span class="token punctuation">,</span> num<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">)</span>
val_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>val_data<span class="token punctuation">,</span>batch_size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment">#可以通过如下的方式从数据集中获取图片和标签</span>
    img<span class="token punctuation">,</span>label<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>
    predict<span class="token operator">=</span>torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>label<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>char_list<span class="token punctuation">[</span>lab<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> lab <span class="token keyword">in</span> predict<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>transforms<span class="token punctuation">.</span>ToPILImage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/71/72/AsUNLimP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_803"></a>模型搭建</h3> 
<p>鉴于验证图片背景和文字信息都比较简单，不需要用到太复杂的网络。在这个多标签分类任务中，共有4个标签，每个标签有36个分类，所以模型最终的输出节点4X36个，分别对应着每个标签中的每个分类。</p> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">import</span> resnet18
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token punctuation">,</span>optim

<span class="token keyword">class</span> <span class="token class-name">CNN</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CNN<span class="token punctuation">,</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#使用nn.Sequentioal搭建子模块</span>
        <span class="token comment"># 利用nn.Sequential()搭建好模型架构，</span>
        <span class="token comment"># 模型前向传播时调用forward()方法，模型接收的输入首先被传入nn.Sequential()包含的第一个网络模块中。</span>
        self<span class="token punctuation">.</span>layer1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">#在训练期间，</span>
            <span class="token comment"># 使用来自伯努利分布的样本以概率 p</span>
            <span class="token comment"># 将输入张量的一些元素随机归零。每个通道将在每次前转调用时独立归零。</span>
            <span class="token comment"># Dropout说的简单一点就是：我们在前向传播的时候，让某个神经元的激活值以一定的概率p（伯努利分布）停止工作</span>
            <span class="token comment"># ，这样可以使模型泛化性更强，因为它不会太依赖某些局部的特征，如下图所示。</span>
            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>layer1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">#在训练期间，</span>
            <span class="token comment"># 使用来自伯努利分布的样本以概率 p</span>
            <span class="token comment"># 将输入张量的一些元素随机归零。每个通道将在每次前转调用时独立归零。</span>
            <span class="token comment"># Dropout说的简单一点就是：我们在前向传播的时候，让某个神经元的激活值以一定的概率p（伯努利分布）停止工作</span>
            <span class="token comment"># ，这样可以使模型泛化性更强，因为它不会太依赖某些局部的特征，如下图所示。</span>
            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>layer2<span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layer3<span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
       <span class="token comment">#全连接层</span>
        self<span class="token punctuation">.</span>fc<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">20</span><span class="token operator">*</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token comment">#输出层</span>
        self<span class="token punctuation">.</span>rfc<span class="token operator">=</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">36</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>layer3<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out<span class="token operator">=</span>out<span class="token punctuation">.</span>view<span class="token punctuation">(</span>out<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        out<span class="token operator">=</span>self<span class="token punctuation">.</span>rfc<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
    
net<span class="token operator">=</span>CNN<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_878"></a>模型训练</h3> 
<p>训练模型之前，可以先预设好学习率的变化规则，这种小型任务训练时间较短。</p> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token punctuation">,</span>optim
<span class="token keyword">from</span> chaptcha_model <span class="token keyword">import</span> net
<span class="token keyword">from</span> captcha_data <span class="token keyword">import</span> dataloader<span class="token punctuation">,</span>val_loader
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

<span class="token comment">#分段的平台式学习率衰减方法</span>
epoch_lr<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">0.0001</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">#将device设置为cpu</span>
<span class="token comment">#定义设备</span>
device <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#多标签分类损失函数</span>
criteron<span class="token operator">=</span>nn<span class="token punctuation">.</span>MultiLabelSoftMarginLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    accuracies<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    losses<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    val_accuracies<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    val_losses<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> n<span class="token punctuation">,</span><span class="token punctuation">(</span>num_epoch<span class="token punctuation">,</span>lr<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>epoch_lr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#优化器</span>
        optimizer<span class="token operator">=</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>
            net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lr<span class="token operator">=</span>lr<span class="token punctuation">,</span>momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>weight_decay<span class="token operator">=</span><span class="token number">5e-4</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#验证</span>
            net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
            epoch_loss<span class="token operator">=</span><span class="token number">0.0</span>
            epoch_acc<span class="token operator">=</span><span class="token number">0.0</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>label<span class="token punctuation">)</span> <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                out<span class="token operator">=</span>net<span class="token punctuation">(</span>img<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
                label<span class="token operator">=</span>label<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                <span class="token comment">#清空梯度</span>
                optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">#计算loss</span>
                loss<span class="token operator">=</span>criteron<span class="token punctuation">(</span>out<span class="token punctuation">,</span>label<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">#更新参数</span>
                optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">#整理输出，方便与标签进行比对</span>
                predict    <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>out<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                true_label <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>label<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                epoch_acc  <span class="token operator">+=</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>predict<span class="token operator">==</span>true_label<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                epoch_loss <span class="token operator">+=</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> epoch <span class="token operator">%</span> <span class="token number">3</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token comment">#no_grad()模式不计算梯度,可以运行得快一点</span>
                <span class="token keyword">with</span>  torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    val_loss<span class="token operator">=</span><span class="token number">0.0</span>
                    val_acc<span class="token operator">=</span><span class="token number">0.0</span>
                    <span class="token keyword">for</span> i<span class="token punctuation">,</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>label<span class="token punctuation">)</span> <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span>val_loader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        out <span class="token operator">=</span> net<span class="token punctuation">(</span>img<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        label <span class="token operator">=</span> label<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                        loss<span class="token operator">=</span>criteron<span class="token punctuation">(</span>out<span class="token punctuation">,</span>label<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        predict    <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>out<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                        true_label <span class="token operator">=</span> torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>label<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                        val_acc  <span class="token operator">+=</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>predict<span class="token operator">==</span>true_label<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        val_loss <span class="token operator">+=</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                val_acc<span class="token operator">/=</span><span class="token builtin">len</span><span class="token punctuation">(</span>val_loader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span>
                val_loss<span class="token operator">/=</span><span class="token builtin">len</span><span class="token punctuation">(</span>val_loader<span class="token punctuation">)</span>
            epoch_acc<span class="token operator">/=</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">.</span>dataset<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span>
            epoch_loss<span class="token operator">/=</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>
                <span class="token string">"epoch:{},epoch loss:{},epoch accuracy:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                    epoch<span class="token operator">+</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> epoch_lr<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>epoch_loss<span class="token punctuation">,</span>epoch_acc
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">if</span> epoch<span class="token operator">%</span><span class="token number">3</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch:{},val loss:{},val accuracy:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                    epoch <span class="token operator">+</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> e <span class="token keyword">in</span> epoch_lr<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  val_loss<span class="token punctuation">,</span>
                    val_acc<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    val_accuracies<span class="token punctuation">.</span>append<span class="token punctuation">(</span>val_acc<span class="token punctuation">)</span>
                    val_losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>val_losses<span class="token punctuation">)</span>
            accuracies<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_acc<span class="token punctuation">)</span>
            losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>epoch_loss<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    train<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="_974"></a>验证码识别</h3> 
<p>模型训练完毕之后，就可以加载模型，用来识别验证码了，这里直接选择使用验证集中得验证码进行识别。</p> 
<pre><code class="prism language-python"><span class="token comment">#coding=utf-8</span>
<span class="token keyword">from</span> chaptcha_model <span class="token keyword">import</span> net
<span class="token keyword">from</span> captcha_data <span class="token keyword">import</span> val_data<span class="token punctuation">,</span>char_list
<span class="token keyword">from</span> chaptcha_train <span class="token keyword">import</span> device
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">import</span> torch

<span class="token comment">#验证模式</span>

net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#训练集</span>
img<span class="token punctuation">,</span>label<span class="token operator">=</span>val_data<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span>
prediction<span class="token operator">=</span>net<span class="token punctuation">(</span>img<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span>
predict<span class="token operator">=</span>torch<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>prediction<span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">#打印预测结果</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>
    <span class="token string">"Predict Label:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
        <span class="token string">"-"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>char_list<span class="token punctuation">[</span>lab<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> lab <span class="token keyword">in</span> predict<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>transforms<span class="token punctuation">.</span>ToPILImage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/89/08/d2go6R8W_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/842cb465be84547a183ec5a2cee6480e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">项目使用smart-doc&#43;Torna自动化创建api文档</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9be6ac7ba87611e26b66f68fdb23f22a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python：对程序做性能分析及计时统计</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>