<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>开发者营地 | Glide: 源码详解 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="开发者营地 | Glide: 源码详解" />
<meta property="og:description" content="本文聚焦于Glide的源码，基于Glide4.11.0
一、简介 Glide的GitHub
Glide是一个快速高效的Android图片加载库，注重于平滑的滚动。Glide提供了易用的API，高性能、可扩展的图片解码管道（decode pipeline），以及自动的资源池技术。
1. 简单使用 1、添加依赖：
repositories { google() jcenter() } dependencies { implementation &#39;com.github.bumptech.glide:glide:4.11.0&#39; annotationProcessor &#39;com.github.bumptech.glide:compiler:4.11.0&#39; } 2、添加网络权限
&lt;uses-permission android:name=&#34;android.permission.INTERNET&#34; /&gt; 3、一句代码加载图片到ImageView
Glide.with(fragment).load(url).into(imageView); 稍微进阶一点的用法，参数设置
RequestOptions options = new RequestOptions() .placeholder(R.drawable.ic_launcher_background) .error(R.mipmap.ic_launcher) .diskCacheStrategy(DiskCacheStrategy.NONE) .override(200, 100); Glide.with(this).load(url).apply(options).into(imageView); 2. 对比 Glide：
多种图片格式的缓存，适用于更多的内容表现形式（如Gif、WebP、缩略图、Video）生命周期集成（根据Activity或者Fragment的生命周期管理图片加载请求）高效处理Bitmap（bitmap的复用和主动回收，减少系统回收压力）高效的缓存策略，灵活（Picasso只会缓存原始尺寸的图片，Glide缓存的是多种规格），加载速度快且内存开销小（默认Bitmap格式的不同，使得内存开销是Picasso的一半） Fresco：
最大的优势在于5.0以下(最低2.3)的bitmap加载。在5.0以下系统，Fresco将图片放到一个特别的内存区域(Ashmem区)大大减少OOM（在更底层的Native层对OOM进行处理，图片将不再占用App的内存）适用于需要高性能加载大量图片的场景 3. 进阶使用 关于Glide的详细使用请查看这个官方 中文文档，这里就不赘述了。
4. 源码详解综述 本文着重分析Glide的核心流程源码：
第二章分析Glide的核心流程：包括with()、load()和into()
Glide的其他部分源码后续在其他同系列文章中进行分析。
二、核心流程 Glide 默认是配置了内存与磁盘缓存的，所以这里我们先假设禁用内存和磁盘缓存，来分析核心流程。缓存相关的放到后面分析。
代码表示如下：
Glide.with(this) .load(url) .skipMemoryCache(true) // 禁用内存缓存 .diskCacheStrategy(DiskCacheStrategy.NONE) // 禁用磁盘缓存 .into(imageView); 1. with() with()有6个重载方法，均返回RequestManager，如下" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/152528c6c15d80d1eed6b1e07189e501/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-15T10:25:50+08:00" />
<meta property="article:modified_time" content="2020-12-15T10:25:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">开发者营地 | Glide: 源码详解</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>本文聚焦于Glide的源码，基于Glide4.11.0</p> 
</blockquote> 
<h3><a id="_5"></a>一、简介</h3> 
<p><a href="https://muyangmin.github.io/glide-docs-cn/" rel="nofollow">Glide的GitHub</a></p> 
<p>Glide是一个快速高效的Android图片加载库，注重于平滑的滚动。Glide提供了易用的API，高性能、可扩展的图片解码管道（decode pipeline），以及自动的资源池技术。</p> 
<h4><a id="1__11"></a>1. 简单使用</h4> 
<p>1、添加依赖：</p> 
<pre><code class="prism language-groovy">repositories <span class="token punctuation">{<!-- --></span>
  <span class="token function">google</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">jcenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{<!-- --></span>
  implementation <span class="token string">'com.github.bumptech.glide:glide:4.11.0'</span>
  annotationProcessor <span class="token string">'com.github.bumptech.glide:compiler:4.11.0'</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2、添加网络权限</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p>3、一句代码加载图片到ImageView</p> 
<pre><code class="prism language-java">Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>稍微进阶一点的用法，参数设置</p> 
<pre><code class="prism language-java">RequestOptions options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">placeholder</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ic_launcher_background<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>mipmap<span class="token punctuation">.</span>ic_launcher<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">diskCacheStrategy</span><span class="token punctuation">(</span>DiskCacheStrategy<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
    		<span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="2__51"></a>2. 对比</h4> 
<p><strong>Glide：</strong></p> 
<ul><li>多种图片格式的缓存，适用于更多的内容表现形式（如Gif、WebP、缩略图、Video）</li><li>生命周期集成（根据Activity或者Fragment的生命周期管理图片加载请求）</li><li>高效处理Bitmap（bitmap的复用和主动回收，减少系统回收压力）</li><li>高效的缓存策略，灵活（Picasso只会缓存原始尺寸的图片，Glide缓存的是多种规格），加载速度快且内存开销小（默认Bitmap格式的不同，使得内存开销是Picasso的一半）</li></ul> 
<p><strong>Fresco：</strong></p> 
<ul><li>最大的优势在于5.0以下(最低2.3)的bitmap加载。在5.0以下系统，Fresco将图片放到一个特别的内存区域(Ashmem区)</li><li>大大减少OOM（在更底层的Native层对OOM进行处理，图片将不再占用App的内存）</li><li>适用于需要高性能加载大量图片的场景</li></ul> 
<h4><a id="3__66"></a>3. 进阶使用</h4> 
<p>关于Glide的详细使用请查看这个官方 <a href="https://muyangmin.github.io/glide-docs-cn/" rel="nofollow">中文文档</a>，这里就不赘述了。</p> 
<h4><a id="4__70"></a>4. 源码详解综述</h4> 
<p>本文着重分析Glide的核心流程源码：</p> 
<p>第二章分析Glide的核心流程：包括<code>with()</code>、<code>load()</code>和<code>into()</code></p> 
<p>Glide的其他部分源码后续在其他同系列文章中进行分析。</p> 
<h3><a id="_78"></a>二、核心流程</h3> 
<p>Glide 默认是配置了内存与磁盘缓存的，所以这里我们先假设禁用内存和磁盘缓存，来分析核心流程。缓存相关的放到后面分析。</p> 
<p>代码表示如下：</p> 
<pre><code class="prism language-java">Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">skipMemoryCache</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 禁用内存缓存</span>
        <span class="token punctuation">.</span><span class="token function">diskCacheStrategy</span><span class="token punctuation">(</span>DiskCacheStrategy<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token comment">// 禁用磁盘缓存</span>
        <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="1_with_92"></a>1. with()</h4> 
<p>with()有6个重载方法，均返回RequestManager，如下</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> RequestManager <span class="token function">with</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">getRetriever</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> RequestManager <span class="token function">with</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Activity activity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">getRetriever</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> RequestManager <span class="token function">with</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> FragmentActivity activity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">getRetriever</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> RequestManager <span class="token function">with</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Fragment fragment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">getRetriever</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"deprecation"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@Deprecated</span>
  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> RequestManager <span class="token function">with</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Fragment fragment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">getRetriever</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> RequestManager <span class="token function">with</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> View view<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">getRetriever</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这些重载方法可以分成两种情况，即 Application（Context）类型与非 Application，具体有Activity、Fragment、View 或 Fragment类型，这些参数的作用是和图片加载的生命周期相关的。</p> 
<p>最终都会调用 <code>getRetriever().get()</code>方法，我们分为两部分看。</p> 
<h5><a id="11_GildegetRetriever_134"></a>1.1 Gilde#getRetriever()</h5> 
<p>getRetriever() 定义如下：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> RequestManagerRetriever <span class="token function">getRetriever</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Glide<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestManagerRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>做一个非NULL的判断，然后调用<code>Glide.get(context).getRequestManagerRetriever()</code>返回一个<code>RequestManagerRetriever</code>。这里我们同样分为2部分来看。</p> 
<h6><a id="111_Glidegetcontext_148"></a>1.1.1 Glide#get(context)</h6> 
<p>先看下 <code>Glide#get(context)</code>：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"Glide.class"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> Glide glide<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> Glide <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//使用了双重校验锁的单例模式来获取 Glide 的实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>glide <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//该方法用来实例化我们用 @GlideModule 注解标识的自定义模块</span>
      GeneratedAppGlideModule annotationGeneratedModule <span class="token operator">=</span>
          <span class="token function">getAnnotationGeneratedGlideModules</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Glide<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>glide <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//检查和初始化</span>
          <span class="token function">checkAndInitializeGlide</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> annotationGeneratedModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> glide<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里使用了标准的DCL单例模式来获取 Glide 的实例。</p> 
<p>先看<code>getAnnotationGeneratedGlideModules</code>方法。</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">static</span> GeneratedAppGlideModule <span class="token function">getAnnotationGeneratedGlideModules</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    GeneratedAppGlideModule result <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      Class<span class="token generics function"><span class="token punctuation">&lt;</span>GeneratedAppGlideModule<span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span>
          <span class="token punctuation">(</span>Class<span class="token generics function"><span class="token punctuation">&lt;</span>GeneratedAppGlideModule<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
              Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.bumptech.glide.GeneratedAppGlideModuleImpl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span>
          clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token comment">// These exceptions can't be squashed across all versions of Android.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">throwIncorrectGlideModule</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">throwIncorrectGlideModule</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">throwIncorrectGlideModule</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">throwIncorrectGlideModule</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>该方法用来实例化我们用 <code>@GlideModule</code> 注解标识的自定义模块，自定义模块的用法请参考官方 <a href="https://muyangmin.github.io/glide-docs-cn/" rel="nofollow">中文文档</a>。</p> 
<p>我们在来看<code>checkAndInitializeGlide</code>方法，从名称上看是用来检查和初始化的，如下：</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> isInitializing<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"Glide.class"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkAndInitializeGlide</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 不能重复初始化</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitializing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
          <span class="token string">"You cannot call Glide.get() in registerComponents(),"</span>
              <span class="token operator">+</span> <span class="token string">" use the provided Glide instance instead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    isInitializing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化</span>
    <span class="token function">initializeGlide</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> generatedAppGlideModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    isInitializing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里使用了一个volatile类型的<code>isInitializing</code>变量，来防止重复初始化。</p> 
<p>接下来<code>initializeGlide</code>方法，从名字上可以看出是进行初始化的方法，如下：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"Glide.class"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initializeGlide</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//注意new了一个GlideBuilder对象传进去。</span>
    <span class="token function">initializeGlide</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GlideBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> generatedAppGlideModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"Glide.class"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"deprecation"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initializeGlide</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> GlideBuilder builder<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> GeneratedAppGlideModule annotationGeneratedModule<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Context applicationContext <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>module<span class="token punctuation">.</span>GlideModule<span class="token operator">&gt;</span> manifestModules <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotationGeneratedModule <span class="token operator">==</span> null <span class="token operator">||</span> annotationGeneratedModule<span class="token punctuation">.</span><span class="token function">isManifestParsingEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//将 AndroidManifest.xml 中所有值为 GlideModule 的 meta-data 配置读取出来，并将相应的自定义模块实例化</span>
      manifestModules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ManifestParser</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 从注解生成的 GeneratedAppGlideModule 中获取 RequestManagerFactory</span>
    RequestManagerRetriever<span class="token punctuation">.</span>RequestManagerFactory factory <span class="token operator">=</span>
        annotationGeneratedModule <span class="token operator">!=</span> null
            <span class="token operator">?</span> annotationGeneratedModule<span class="token punctuation">.</span><span class="token function">getRequestManagerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> null<span class="token punctuation">;</span>
    <span class="token comment">// 将 RequestManagerFactory 设置到 GlideBuilder</span>
    builder<span class="token punctuation">.</span><span class="token function">setRequestManagerFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.x版本的自定义模块中更改 Glide 的配置</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>module<span class="token punctuation">.</span>GlideModule module <span class="token operator">:</span> manifestModules<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      module<span class="token punctuation">.</span><span class="token function">applyOptions</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.x版本的自定义模块中更改 Glide 的配置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotationGeneratedModule <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      annotationGeneratedModule<span class="token punctuation">.</span><span class="token function">applyOptions</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//真正初始化的地方，使用建造者模式创建 Glide</span>
    Glide glide <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>module<span class="token punctuation">.</span>GlideModule module <span class="token operator">:</span> manifestModules<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//3.x自定义模块中替换 Glide 组件</span>
        module<span class="token punctuation">.</span><span class="token function">registerComponents</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> glide<span class="token punctuation">,</span> glide<span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AbstractMethodError</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
            <span class="token string">"Attempting to register a Glide v3 module. If you see this, you or one of your"</span>
                <span class="token operator">+</span> <span class="token string">" dependencies may be including Glide v3 even though you're using Glide v4."</span>
                <span class="token operator">+</span> <span class="token string">" You'll need to find and remove (or update) the offending dependency."</span>
                <span class="token operator">+</span> <span class="token string">" The v3 module name is: "</span>
                <span class="token operator">+</span> module<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//4.x自定义模块中替换 Glide 组件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotationGeneratedModule <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      annotationGeneratedModule<span class="token punctuation">.</span><span class="token function">registerComponents</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> glide<span class="token punctuation">,</span> glide<span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    applicationContext<span class="token punctuation">.</span><span class="token function">registerComponentCallbacks</span><span class="token punctuation">(</span>glide<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将创建的 Glide 赋值给 Glide 的静态变量</span>
    Glide<span class="token punctuation">.</span>glide <span class="token operator">=</span> glide<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p><code>initializeGlide</code>方法调用了重载方法，增加了一个<code>GlideBuilder</code>对象，使用到了建造者模式，主要是完成自定义模块的相关功能和真正进行初始化。在最后通过<code>Glide.glide = glide;</code>将创建好的 Glide 赋值给 Glide 的静态全家变量。</p> 
<p>我们需要重点关注的是<code>Glide glide = builder.build(applicationContext);</code>这里是真正的初始化。</p> 
<p>实现在<code>GlideBuilder#build</code>如下：</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@NonNull</span>
  Glide <span class="token function">build</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 创建网络请求线程池</span>
      sourceExecutor <span class="token operator">=</span> GlideExecutor<span class="token punctuation">.</span><span class="token function">newSourceExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>diskCacheExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 创建磁盘缓存线程池</span>
      diskCacheExecutor <span class="token operator">=</span> GlideExecutor<span class="token punctuation">.</span><span class="token function">newDiskCacheExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>animationExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 创建动画线程池</span>
      animationExecutor <span class="token operator">=</span> GlideExecutor<span class="token punctuation">.</span><span class="token function">newAnimationExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>memorySizeCalculator <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 创建内存大小计算器</span>
      memorySizeCalculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemorySizeCalculator<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectivityMonitorFactory <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 创建默认网络连接监视器工厂</span>
      connectivityMonitorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConnectivityMonitorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建 Bitmap 池</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapPool <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">int</span> size <span class="token operator">=</span> memorySizeCalculator<span class="token punctuation">.</span><span class="token function">getBitmapPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bitmapPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LruBitmapPool</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        bitmapPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BitmapPoolAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>arrayPool <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 创建固定大小的数组池（4MB），使用 LRU 策略来保持数组池在最大字节数以下</span>
      arrayPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LruArrayPool</span><span class="token punctuation">(</span>memorySizeCalculator<span class="token punctuation">.</span><span class="token function">getArrayPoolSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>memoryCache <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 创建内存缓存</span>
      memoryCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LruResourceCache</span><span class="token punctuation">(</span>memorySizeCalculator<span class="token punctuation">.</span><span class="token function">getMemoryCacheSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>diskCacheFactory <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 创建磁盘缓存工厂</span>
      diskCacheFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternalCacheDiskCacheFactory</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建加载以及管理活动资源和缓存资源的引擎</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>engine <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      engine <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">Engine</span><span class="token punctuation">(</span>
              memoryCache<span class="token punctuation">,</span>
              diskCacheFactory<span class="token punctuation">,</span>
              diskCacheExecutor<span class="token punctuation">,</span>
              sourceExecutor<span class="token punctuation">,</span>
              GlideExecutor<span class="token punctuation">.</span><span class="token function">newUnlimitedSourceExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              animationExecutor<span class="token punctuation">,</span>
              isActiveResourceRetentionAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultRequestListeners <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      defaultRequestListeners <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      defaultRequestListeners <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>defaultRequestListeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建请求管理类，这里的 requestManagerFactory 就是前面 GlideBuilder#setRequestManagerFactory() 设置进来的</span>
    <span class="token comment">// 也就是 @GlideModule 注解中获取的</span>
    GlideExperiments experiments <span class="token operator">=</span> glideExperimentsBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RequestManagerRetriever requestManagerRetriever <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">RequestManagerRetriever</span><span class="token punctuation">(</span>requestManagerFactory<span class="token punctuation">,</span> experiments<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 Glide</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Glide</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        engine<span class="token punctuation">,</span>
        memoryCache<span class="token punctuation">,</span>
        bitmapPool<span class="token punctuation">,</span>
        arrayPool<span class="token punctuation">,</span>
        requestManagerRetriever<span class="token punctuation">,</span>
        connectivityMonitorFactory<span class="token punctuation">,</span>
        logLevel<span class="token punctuation">,</span>
        defaultRequestOptionsFactory<span class="token punctuation">,</span>
        defaultTransitionOptions<span class="token punctuation">,</span>
        defaultRequestListeners<span class="token punctuation">,</span>
        experiments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>build() 方法主要是创建一些线程池、Bitmap 池、缓存策略、Engine 等，然后利用这些来创建具体的 Glide。</p> 
<p>继续看下 Glide 的构造函数：</p> 
<pre><code class="prism language-java">  <span class="token function">Glide</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Engine engine<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> MemoryCache memoryCache<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> BitmapPool bitmapPool<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> ArrayPool arrayPool<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> RequestManagerRetriever requestManagerRetriever<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> ConnectivityMonitorFactory connectivityMonitorFactory<span class="token punctuation">,</span>
      <span class="token keyword">int</span> logLevel<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> RequestOptionsFactory defaultRequestOptionsFactory<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> TransitionOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;&gt;</span> defaultTransitionOptions<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> List<span class="token operator">&lt;</span>RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> defaultRequestListeners<span class="token punctuation">,</span>
      GlideExperiments experiments<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 将传进来的参数赋值给 Glide 类中的一些常量，方便后续使用</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>engine <span class="token operator">=</span> engine<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bitmapPool <span class="token operator">=</span> bitmapPool<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>arrayPool <span class="token operator">=</span> arrayPool<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>memoryCache <span class="token operator">=</span> memoryCache<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestManagerRetriever <span class="token operator">=</span> requestManagerRetriever<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectivityMonitorFactory <span class="token operator">=</span> connectivityMonitorFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultRequestOptionsFactory <span class="token operator">=</span> defaultRequestOptionsFactory<span class="token punctuation">;</span>

    <span class="token keyword">final</span> Resources resources <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 Registry，Registry 的作用是管理组件注册，用来扩展或替换 Glide 的默认加载、解码和编码逻辑</span>
    registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Registry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultImageHeaderParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Right now we're only using this parser for HEIF images, which are only supported on OMR1+.</span>
    <span class="token comment">// If we need this for other file types, we should consider removing this restriction.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O_MR1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExifInterfaceImageHeaderParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//后续的流程是创建一些处理图片的解析器、解码器、转码器等，然后将他们添加到 Registry 中</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 创建 ImageViewTargetFactory，用来给 View 获取正确类型的 ViewTarget（BitmapImageViewTarget 或 DrawableImageViewTarget）</span>
    ImageViewTargetFactory imageViewTargetFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageViewTargetFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构建一个 Glide 专属的上下文</span>
    glideContext <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">GlideContext</span><span class="token punctuation">(</span>
            context<span class="token punctuation">,</span>
            arrayPool<span class="token punctuation">,</span>
            registry<span class="token punctuation">,</span>
            imageViewTargetFactory<span class="token punctuation">,</span>
            defaultRequestOptionsFactory<span class="token punctuation">,</span>
            defaultTransitionOptions<span class="token punctuation">,</span>
            defaultRequestListeners<span class="token punctuation">,</span>
            engine<span class="token punctuation">,</span>
            experiments<span class="token punctuation">,</span>
            logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>我们看一下 GlideContext 的构造方法</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">final</span> GlideContext glideContext<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token function">GlideContext</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> ArrayPool arrayPool<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Registry registry<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> ImageViewTargetFactory imageViewTargetFactory<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> RequestOptionsFactory defaultRequestOptionsFactory<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> TransitionOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;&gt;</span> defaultTransitionOptions<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> List<span class="token operator">&lt;</span>RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> defaultRequestListeners<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Engine engine<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> GlideExperiments experiments<span class="token punctuation">,</span>
      <span class="token keyword">int</span> logLevel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>arrayPool <span class="token operator">=</span> arrayPool<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>imageViewTargetFactory <span class="token operator">=</span> imageViewTargetFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultRequestOptionsFactory <span class="token operator">=</span> defaultRequestOptionsFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultRequestListeners <span class="token operator">=</span> defaultRequestListeners<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultTransitionOptions <span class="token operator">=</span> defaultTransitionOptions<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>engine <span class="token operator">=</span> engine<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>experiments <span class="token operator">=</span> experiments<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logLevel <span class="token operator">=</span> logLevel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>存储了一些上下文数据的索引。</p> 
<p>至此，Glide 真正创建成功。</p> 
<h6><a id="112_GlidegetRequestManagerRetriever_484"></a>1.1.2 Glide#getRequestManagerRetriever()</h6> 
<p>接下来我们看一下<code>getRequestManagerRetriever()</code>方法</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">final</span> RequestManagerRetriever requestManagerRetriever<span class="token punctuation">;</span>

  <span class="token keyword">public</span> RequestManagerRetriever <span class="token function">getRequestManagerRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> requestManagerRetriever<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>返回一个<code>RequestManagerRetriever</code>对象。从名字上理解为请求管理者检索器，我们往回翻一下，看一下其相关实现。</p> 
<pre><code class="prism language-java">  <span class="token function">Glide</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Engine engine<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> MemoryCache memoryCache<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> BitmapPool bitmapPool<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> ArrayPool arrayPool<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> RequestManagerRetriever requestManagerRetriever<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> ConnectivityMonitorFactory connectivityMonitorFactory<span class="token punctuation">,</span>
      <span class="token keyword">int</span> logLevel<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> RequestOptionsFactory defaultRequestOptionsFactory<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> TransitionOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;&gt;</span> defaultTransitionOptions<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> List<span class="token operator">&lt;</span>RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> defaultRequestListeners<span class="token punctuation">,</span>
      GlideExperiments experiments<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	  <span class="token keyword">this</span><span class="token punctuation">.</span>requestManagerRetriever <span class="token operator">=</span> requestManagerRetriever<span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>         
</code></pre> 
<p>在Glide的初始化中，可以看到是通过初始化赋值的。初始化又是通过build函数构建的，回到build函数。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@NonNull</span>
  Glide <span class="token function">build</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// 创建请求管理类，这里的 requestManagerFactory 就是前面 GlideBuilder#setRequestManagerFactory() 设置进来的</span>
    <span class="token comment">// 也就是 @GlideModule 注解中获取的</span>
    GlideExperiments experiments <span class="token operator">=</span> glideExperimentsBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RequestManagerRetriever requestManagerRetriever <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">RequestManagerRetriever</span><span class="token punctuation">(</span>requestManagerFactory<span class="token punctuation">,</span> experiments<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 Glide</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Glide</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        engine<span class="token punctuation">,</span>
        memoryCache<span class="token punctuation">,</span>
        bitmapPool<span class="token punctuation">,</span>
        arrayPool<span class="token punctuation">,</span>
        requestManagerRetriever<span class="token punctuation">,</span>
        connectivityMonitorFactory<span class="token punctuation">,</span>
        logLevel<span class="token punctuation">,</span>
        defaultRequestOptionsFactory<span class="token punctuation">,</span>
        defaultTransitionOptions<span class="token punctuation">,</span>
        defaultRequestListeners<span class="token punctuation">,</span>
        experiments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里我们可以看到 new 了一个 RequestManagerRetriever 对象。</p> 
<p>这里的 requestManagerFactory 是前面 <code>GlideBuilder#setRequestManagerFactory()</code> 设置进来的</p> 
<pre><code class="prism language-java">RequestManagerRetriever requestManagerRetriever <span class="token operator">=</span> 
<span class="token keyword">new</span> <span class="token class-name">RequestManagerRetriever</span><span class="token punctuation">(</span>requestManagerFactory<span class="token punctuation">,</span> experiments<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>看一下其构造方法。</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">final</span> RequestManagerFactory factory<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token function">RequestManagerRetriever</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@Nullable</span> RequestManagerFactory factory<span class="token punctuation">,</span> GlideExperiments experiments<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>factory <span class="token operator">=</span> factory <span class="token operator">!=</span> null <span class="token operator">?</span> factory <span class="token operator">:</span> DEFAULT_FACTORY<span class="token punctuation">;</span>
    handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span> <span class="token comment">/* Callback */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    frameWaiter <span class="token operator">=</span> <span class="token function">buildFrameWaiter</span><span class="token punctuation">(</span>experiments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RequestManagerFactory</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@NonNull</span>
    RequestManager <span class="token function">build</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@NonNull</span> Glide glide<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@NonNull</span> Lifecycle lifecycle<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@NonNull</span> RequestManagerTreeNode requestManagerTreeNode<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> RequestManagerFactory DEFAULT_FACTORY <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">RequestManagerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> RequestManager <span class="token function">build</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@NonNull</span> Glide glide<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> Lifecycle lifecycle<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> RequestManagerTreeNode requestManagerTreeNode<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestManager</span><span class="token punctuation">(</span>glide<span class="token punctuation">,</span> lifecycle<span class="token punctuation">,</span> requestManagerTreeNode<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>初始化方法中保存了 RequestManagerFactory 的索引，如果没有的话使用默认的工厂<code>DEFAULT_FACTORY</code>。RequestManagerFactory 是一个接口，只有一个方法<code>build</code>，返回一个 RequestManager 对象。可以看到工厂主要使用了生成 RequestManager 对象的。</p> 
<p>初始化方法中还获取并保存了主线程的Handler的索引。</p> 
<p>接下来回到<code>getRetriever().get()</code>方法的<code>get()</code>方法。</p> 
<h5><a id="12_RequestManagerRetrieverget_600"></a>1.2 RequestManagerRetriever#get()</h5> 
<p>RequestManagerRetriever#get() 的重载方法同样有 6 个：</p> 
<pre><code class="prism language-java">RequestManagerRetriever#<span class="token function">get</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span>
RequestManagerRetriever#<span class="token function">get</span><span class="token punctuation">(</span>Activity activity<span class="token punctuation">)</span>
RequestManagerRetriever#<span class="token function">get</span><span class="token punctuation">(</span>FragmentActivity activity<span class="token punctuation">)</span>
RequestManagerRetriever#<span class="token function">get</span><span class="token punctuation">(</span>Fragment fragment<span class="token punctuation">)</span>
RequestManagerRetriever#<span class="token function">get</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Fragment fragment<span class="token punctuation">)</span>
RequestManagerRetriever#<span class="token function">get</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span>
</code></pre> 
<p>分成两种情况，即 Application 与非 Application 类型。</p> 
<p>先看下 Application 类型的情况：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> RequestManager <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"You cannot start a load on a null Context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//判断如果当前线程是在主线程</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isOnMainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">Application</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//传入非Application类型的参数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">FragmentActivity</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span>FragmentActivity<span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">Activity</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Activity<span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">ContextWrapper</span>
          <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ContextWrapper<span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ContextWrapper<span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//即传入Application类型的参数</span>
    <span class="token keyword">return</span> <span class="token function">getApplicationManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>如果当前线程是在主线程，并且 context 不属于 Application 类型，那么会走对应重载方法。属于 Application 类型，就会调用 getApplicationManager(context) 方法。</p> 
<h6><a id="121_ApplicationContext_641"></a>1.2.1 ApplicationContext</h6> 
<p>实现如下：</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">private</span> RequestManager <span class="token function">getApplicationManager</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 使用了DCL单例模式来获取 RequestManager</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 用 Application 类型的 Context 来获取 Glide 的实例</span>
          <span class="token comment">// 这里并没有专门做生命周期的处理</span>
          <span class="token comment">// 因为 Application 对象的生命周期即为应用程序的生命周期</span>
          <span class="token comment">// 所以在这里图片请求的生命周期是和应用程序同步的</span>
          Glide glide <span class="token operator">=</span> Glide<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          applicationManager <span class="token operator">=</span>
              factory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
                  glide<span class="token punctuation">,</span>
                  <span class="token keyword">new</span> <span class="token class-name">ApplicationLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token keyword">new</span> <span class="token class-name">EmptyRequestManagerTreeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> applicationManager<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>使用DCL单例模式来获取 RequestManager，里面重新用 Application 类型的 Context 来获取 Glide 的实例。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ApplicationLifecycle</span> <span class="token keyword">implements</span> <span class="token class-name">Lifecycle</span> <span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> LifecycleListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    listener<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> LifecycleListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Do nothing.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ApplicationLifecycle 为空实现，这里没有专门做生命周期的处理， 因为 Application 对象的生命周期即为应用程序的生命周期，所以在这里图片请求的生命周期是和应用程序同步的。</p> 
<h6><a id="122_ApplicationContext_689"></a>1.2.2 非ApplicationContext</h6> 
<p>接下来看非 Application 类型的情况，以FragmentActivity 为例：</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> RequestManager <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> FragmentActivity activity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 是否在非UI线程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isOnBackgroundThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 检查 Activity 是否销毁</span>
      <span class="token function">assertNotDestroyed</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      frameWaiter<span class="token punctuation">.</span><span class="token function">registerSelf</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取当前 Activity 的 FragmentManager</span>
      FragmentManager fm <span class="token operator">=</span> activity<span class="token punctuation">.</span><span class="token function">getSupportFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">supportFragmentGet</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> fm<span class="token punctuation">,</span> <span class="token comment">/*parentHint=*/</span> null<span class="token punctuation">,</span> <span class="token function">isActivityVisible</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>如果是Activity，调用 <code>supportFragmentGet()</code> 方法来获取 RequestManager。</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> RequestManager <span class="token function">supportFragmentGet</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> FragmentManager fm<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> Fragment parentHint<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isParentVisible<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取了一个隐藏的 Fragment</span>
    SupportRequestManagerFragment current <span class="token operator">=</span> <span class="token function">getSupportRequestManagerFragment</span><span class="token punctuation">(</span>fm<span class="token punctuation">,</span> parentHint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    RequestManager requestManager <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">getRequestManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 实际是将 SupportRequestManagerFragment、RequestManager、ActivityFragmentLifecycle 都关联在一起了</span>
    <span class="token comment">// 又因为 Fragment 的生命周期和 Activity 是同步的，</span>
    <span class="token comment">// 所以 Activity 生命周期发生变化的时候，隐藏的 Fragment 的生命周期是同步变化的，</span>
    <span class="token comment">// 这样 Glide 就可以根据这个 Fragment 的生命周期进行请求管理了。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Glide glide <span class="token operator">=</span> Glide<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 这里的 current.getGlideLifecycle() 就是</span>
      <span class="token comment">// getSupportRequestManagerFragment 中实例化的 ActivityFragmentLifecycle</span>
      <span class="token comment">// 这样 RequestManager 就与 ActivityFragmentLifecycle 进行了关联。</span>
      requestManager <span class="token operator">=</span>
          factory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
              glide<span class="token punctuation">,</span> current<span class="token punctuation">.</span><span class="token function">getGlideLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span><span class="token function">getRequestManagerTreeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isParentVisible<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        requestManager<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 将 RequestManager 设置到 SupportRequestManagerFragment 中</span>
      current<span class="token punctuation">.</span><span class="token function">setRequestManager</span><span class="token punctuation">(</span>requestManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> requestManager<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>首先获取了一个隐藏的 Fragment。</p> 
<p>之后的 <code>current.getGlideLifecycle()</code> 就是实例化的 ActivityFragmentLifecycle，这样 RequestManager 就与 ActivityFragmentLifecycle 进行了关联。</p> 
<p>最后将 RequestManager 设置到 SupportRequestManagerFragment 中。</p> 
<p>我们详细看一下<code>getSupportRequestManagerFragment(fm, parentHint)</code>相关的代码。</p> 
<pre><code class="prism language-java">  <span class="token comment">//RequestManagerRetriever#getSupportRequestManagerFragment()</span>
  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">private</span> SupportRequestManagerFragment <span class="token function">getSupportRequestManagerFragment</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> FragmentManager fm<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Fragment parentHint<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    SupportRequestManagerFragment current <span class="token operator">=</span>
        <span class="token punctuation">(</span>SupportRequestManagerFragment<span class="token punctuation">)</span> fm<span class="token punctuation">.</span><span class="token function">findFragmentByTag</span><span class="token punctuation">(</span>FRAGMENT_TAG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      current <span class="token operator">=</span> pendingSupportRequestManagerFragments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//实例化了 SupportRequestManagerFragment</span>
        current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SupportRequestManagerFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        current<span class="token punctuation">.</span><span class="token function">setParentFragmentHint</span><span class="token punctuation">(</span>parentHint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pendingSupportRequestManagerFragments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>fm<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fm<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> FRAGMENT_TAG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitAllowingStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>ID_REMOVE_SUPPORT_FRAGMENT_MANAGER<span class="token punctuation">,</span> fm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> current<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token comment">//SupportRequestManagerFragment#SupportRequestManagerFragment()</span>
 <span class="token keyword">public</span> <span class="token function">SupportRequestManagerFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 实例化了 ActivityFragmentLifecycle</span>
    <span class="token comment">// ActivityFragmentLifecycle 实现了 Lifecycle</span>
    <span class="token comment">// 主要用来监听 Activity 与 Fragment 的生命周期。</span>
    <span class="token comment">// ActivityFragmentLifecycle 与 SupportRequestManagerFragment 的生命周期关联起来了</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActivityFragmentLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@VisibleForTesting</span>
  <span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"ValidFragment"</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token function">SupportRequestManagerFragment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> ActivityFragmentLifecycle lifecycle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lifecycle <span class="token operator">=</span> lifecycle<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">//ActivityFragmentLifecycle</span>
<span class="token keyword">class</span> <span class="token class-name">ActivityFragmentLifecycle</span> <span class="token keyword">implements</span> <span class="token class-name">Lifecycle</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>LifecycleListener<span class="token punctuation">&gt;</span></span> lifecycleListeners <span class="token operator">=</span>
      Collections<span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>LifecycleListener<span class="token punctuation">,</span> Boolean<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> isStarted<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> isDestroyed<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addListener</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> LifecycleListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    lifecycleListeners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      listener<span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isStarted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      listener<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      listener<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> LifecycleListener listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    lifecycleListeners<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    isStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>LifecycleListener lifecycleListener <span class="token operator">:</span> Util<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>lifecycleListeners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      lifecycleListener<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    isStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>LifecycleListener lifecycleListener <span class="token operator">:</span> Util<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>lifecycleListeners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      lifecycleListener<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    isDestroyed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>LifecycleListener lifecycleListener <span class="token operator">:</span> Util<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>lifecycleListeners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      lifecycleListener<span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>在实例化 SupportRequestManagerFragment 的时候又实例化了 ActivityFragmentLifecycle，ActivityFragmentLifecycle 实现了 Lifecycle，主要用来监听 Activity 与 Fragment 的生命周期。</p> 
<p>实际是将 SupportRequestManagerFragment、RequestManager、ActivityFragmentLifecycle 都关联在一起了，又因为 Fragment 的生命周期和 Activity 是同步的， 所以 Activity 生命周期发生变化的时候，隐藏的 Fragment 的生命周期是同步变化的，这样 Glide 就可以根据这个 Fragment 的生命周期进行请求管理了。</p> 
<h5><a id="13__839"></a>1.3 总结</h5> 
<p>with() 方法主要功能如下：</p> 
<ul><li>获取 AndroidManifest.xml 文件中配置的自定义模块与 @GlideModule 注解标识的自定义模块，然后进行 Glide 配置的更改与组件的替换。</li><li>初始化构建 Glide 实例需要的各种配置信息，例如线程池、Bitmap 池、缓存策略、Engine 等，然后利用这些来创建具体的 Glide。</li><li>将 Glide 的请求与 Application 或者隐藏的 Fragment 的生命周期进行绑定。</li></ul> 
<h4><a id="2_load_847"></a>2. load()</h4> 
<p>load() 的重载方法有 9 个，均返回<code>RequestBuilder&lt;Drawable&gt;</code>：</p> 
<pre><code class="prism language-java">RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span>#<span class="token function">load</span><span class="token punctuation">(</span>Bitmap bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span>#<span class="token function">load</span><span class="token punctuation">(</span>Drawable drawable<span class="token punctuation">)</span><span class="token punctuation">;</span>
RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span>#<span class="token function">load</span><span class="token punctuation">(</span>String string<span class="token punctuation">)</span><span class="token punctuation">;</span>
RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span>#<span class="token function">load</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span>#<span class="token function">load</span><span class="token punctuation">(</span>File file<span class="token punctuation">)</span><span class="token punctuation">;</span>
RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span>#<span class="token function">load</span><span class="token punctuation">(</span>Integer resourceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span>#<span class="token function">load</span><span class="token punctuation">(</span>URL url<span class="token punctuation">)</span><span class="token punctuation">;</span>
RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span>#<span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span>#<span class="token function">load</span><span class="token punctuation">(</span>Object model<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这些重载方法最终都会调用 <code>asDrawable().load()</code>。这里只拿参数为图片链接字符串的来分析。</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> String string<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">asDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>分为<code>asDrawable()</code>和<code>load(string)</code>2个部分。我们分别来分析</p> 
<h5><a id="21_RequestManagerasDrawable_873"></a>2.1 RequestManager#asDrawable()</h5> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>Drawable<span class="token punctuation">&gt;</span></span> <span class="token function">asDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">as</span><span class="token punctuation">(</span>Drawable<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> <span class="token function">as</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Class<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> resourceClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建一个 RequestBuilder 的实例</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestBuilder</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>glide<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> resourceClass<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p><code>asDrawable()</code>方法最终创建了 RequestBuilder 的实例并返回，查看RequestBuilder的构造函数：</p> 
<pre><code class="prism language-java">  <span class="token keyword">protected</span> <span class="token function">RequestBuilder</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Glide glide<span class="token punctuation">,</span>
      RequestManager requestManager<span class="token punctuation">,</span>
      Class<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> transcodeClass<span class="token punctuation">,</span>
      Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 给 RequestBuilder 中的一些常量进行赋值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>glide <span class="token operator">=</span> glide<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestManager <span class="token operator">=</span> requestManager<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>transcodeClass <span class="token operator">=</span> transcodeClass<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>transitionOptions <span class="token operator">=</span> requestManager<span class="token punctuation">.</span><span class="token function">getDefaultTransitionOptions</span><span class="token punctuation">(</span>transcodeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>glideContext <span class="token operator">=</span> glide<span class="token punctuation">.</span><span class="token function">getGlideContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化请求监听</span>
    <span class="token function">initRequestListeners</span><span class="token punctuation">(</span>requestManager<span class="token punctuation">.</span><span class="token function">getDefaultRequestListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将默认选项应用于请求</span>
    <span class="token function">apply</span><span class="token punctuation">(</span>requestManager<span class="token punctuation">.</span><span class="token function">getDefaultRequestOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>apply是将默认选项应用于请求，实现如下：</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> requestOptions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>requestOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用了父类的 apply() 方法</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>requestOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>调用了父类BaseRequestOptions的 apply 方法：</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> T <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> o<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 配置选项有很多，包括磁盘缓存策略，加载中的占位图，加载失败的占位图等</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAutoCloneEnabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> other <span class="token operator">=</span> o<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> SIZE_MULTIPLIER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      sizeMultiplier <span class="token operator">=</span> other<span class="token punctuation">.</span>sizeMultiplier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> USE_UNLIMITED_SOURCE_GENERATORS_POOL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      useUnlimitedSourceGeneratorsPool <span class="token operator">=</span> other<span class="token punctuation">.</span>useUnlimitedSourceGeneratorsPool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> USE_ANIMATION_POOL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      useAnimationPool <span class="token operator">=</span> other<span class="token punctuation">.</span>useAnimationPool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> DISK_CACHE_STRATEGY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      diskCacheStrategy <span class="token operator">=</span> other<span class="token punctuation">.</span>diskCacheStrategy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> PRIORITY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      priority <span class="token operator">=</span> other<span class="token punctuation">.</span>priority<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> ERROR_PLACEHOLDER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      errorPlaceholder <span class="token operator">=</span> other<span class="token punctuation">.</span>errorPlaceholder<span class="token punctuation">;</span>
      errorId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>ERROR_ID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> ERROR_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      errorId <span class="token operator">=</span> other<span class="token punctuation">.</span>errorId<span class="token punctuation">;</span>
      errorPlaceholder <span class="token operator">=</span> null<span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>ERROR_PLACEHOLDER<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> PLACEHOLDER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      placeholderDrawable <span class="token operator">=</span> other<span class="token punctuation">.</span>placeholderDrawable<span class="token punctuation">;</span>
      placeholderId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>PLACEHOLDER_ID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> PLACEHOLDER_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      placeholderId <span class="token operator">=</span> other<span class="token punctuation">.</span>placeholderId<span class="token punctuation">;</span>
      placeholderDrawable <span class="token operator">=</span> null<span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>PLACEHOLDER<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> IS_CACHEABLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      isCacheable <span class="token operator">=</span> other<span class="token punctuation">.</span>isCacheable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> OVERRIDE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      overrideWidth <span class="token operator">=</span> other<span class="token punctuation">.</span>overrideWidth<span class="token punctuation">;</span>
      overrideHeight <span class="token operator">=</span> other<span class="token punctuation">.</span>overrideHeight<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> SIGNATURE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      signature <span class="token operator">=</span> other<span class="token punctuation">.</span>signature<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> RESOURCE_CLASS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      resourceClass <span class="token operator">=</span> other<span class="token punctuation">.</span>resourceClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> FALLBACK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      fallbackDrawable <span class="token operator">=</span> other<span class="token punctuation">.</span>fallbackDrawable<span class="token punctuation">;</span>
      fallbackId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>FALLBACK_ID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> FALLBACK_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      fallbackId <span class="token operator">=</span> other<span class="token punctuation">.</span>fallbackId<span class="token punctuation">;</span>
      fallbackDrawable <span class="token operator">=</span> null<span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>FALLBACK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> THEME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      theme <span class="token operator">=</span> other<span class="token punctuation">.</span>theme<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> TRANSFORMATION_ALLOWED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      isTransformationAllowed <span class="token operator">=</span> other<span class="token punctuation">.</span>isTransformationAllowed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> TRANSFORMATION_REQUIRED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      isTransformationRequired <span class="token operator">=</span> other<span class="token punctuation">.</span>isTransformationRequired<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> TRANSFORMATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      transformations<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>transformations<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isScaleOnlyOrNoTransform <span class="token operator">=</span> other<span class="token punctuation">.</span>isScaleOnlyOrNoTransform<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> ONLY_RETRIEVE_FROM_CACHE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      onlyRetrieveFromCache <span class="token operator">=</span> other<span class="token punctuation">.</span>onlyRetrieveFromCache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Applying options with dontTransform() is expected to clear our transformations.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isTransformationAllowed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      transformations<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>TRANSFORMATION<span class="token punctuation">;</span>
      isTransformationRequired <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>TRANSFORMATION_REQUIRED<span class="token punctuation">;</span>
      isScaleOnlyOrNoTransform <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fields <span class="token operator">|=</span> other<span class="token punctuation">.</span>fields<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">selfOrThrowIfLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>配置选项有很多，包括磁盘缓存策略，加载中的占位图，加载失败的占位图等。 到这里 asDrawable() 方法完成了。接下来查看load部分。</p> 
<h5><a id="22_RequestBuilderload_1023"></a>2.2 RequestBuilder#load()</h5> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">private</span> Object model<span class="token punctuation">;</span>

  <span class="token keyword">public</span> RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> String string<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//调用了 loadGeneric() 方法</span>
    <span class="token keyword">return</span> <span class="token function">loadGeneric</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">private</span> RequestBuilder<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> <span class="token function">loadGeneric</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Object model<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 将传进来的图片资源赋值给了变量 model</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>model <span class="token operator">=</span> model<span class="token punctuation">;</span>
    <span class="token comment">// isModelSet 标记已经调用过 load() 方法</span>
    isModelSet <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>个方法非常简单，首先调用了 loadGeneric() 方法，然后 loadGeneric() 方法中将传进来的图片资源赋值给了变量 model，最后用 isModelSet 标记已经调用过 load() 方法了。</p> 
<h5><a id="23__1045"></a>2.3 总结</h5> 
<p>load() 方法比较简单了，主要是通过前面实例化的 Glide 与 RequestManager 来创建 RequestBuilder，然后将传进来的参数赋值给 model。</p> 
<h4><a id="3_into_1049"></a>3. into()</h4> 
<p>前两个方法都没有涉及到图片的请求、缓存、解码等逻辑，其实都在 <code>into()</code> 方法中，这个方法也是最复杂的。</p> 
<p>首先查看<code>into()</code>函数，<code>RequestBuilder#into()</code>如下：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> <span class="token operator">&lt;</span>Y <span class="token keyword">extends</span> <span class="token class-name">Target</span><span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> Y <span class="token function">into</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Y target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">into</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token comment">/*targetListener=*/</span> null<span class="token punctuation">,</span> Executors<span class="token punctuation">.</span><span class="token function">mainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@NonNull</span>
  <span class="token annotation punctuation">@Synthetic</span>
  <span class="token operator">&lt;</span>Y <span class="token keyword">extends</span> <span class="token class-name">Target</span><span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> Y <span class="token function">into</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Y target<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> targetListener<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">into</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetListener<span class="token punctuation">,</span> <span class="token comment">/*options=*/</span> <span class="token keyword">this</span><span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token operator">&lt;</span>Y <span class="token keyword">extends</span> <span class="token class-name">Target</span><span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> Y <span class="token function">into</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Y target<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> targetListener<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> options<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isModelSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"You must call #load() before calling #into()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//创建一个Request</span>
    Request request <span class="token operator">=</span> <span class="token function">buildRequest</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetListener<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Request previous <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isEquivalentTo</span><span class="token punctuation">(</span>previous<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSkipMemoryCacheWithCompletePreviousRequest</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> previous<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>previous<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        previous<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    requestManager<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    target<span class="token punctuation">.</span><span class="token function">setRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//请求，注意Request是一个接口</span>
    requestManager<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，调用了重载方法。在最终的方法中进行了真正的处理逻辑。</p> 
<p>我们需要关注的点包括包含2个：<code>RequestBuilder#buildRequest()</code>和<code>RequestManager#track()</code>。</p> 
<h5><a id="31_RequestBuilderbuildRequest_1105"></a>3.1 RequestBuilder#buildRequest()</h5> 
<p>通过函数名可以猜测是生成一个Request对象，该函数最终返回是一个Request对象，这里我们先看一下Request对象。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Request</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">void</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> <span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> <span class="token function">isComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> <span class="token function">isCleared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> <span class="token function">isAnyResourceSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> <span class="token function">isEquivalentTo</span><span class="token punctuation">(</span>Request other<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Request 是一个接口，包含了8个方法。这里我们先留意一下即可。</p> 
<p>我们查看 <code>buildRequest()</code>方法：</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> Request <span class="token function">buildRequest</span><span class="token punctuation">(</span>
      Target<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> target<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> targetListener<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> requestOptions<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">buildRequestRecursive</span><span class="token punctuation">(</span>
        <span class="token comment">/*requestLock=*/</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        target<span class="token punctuation">,</span>
        targetListener<span class="token punctuation">,</span>
        <span class="token comment">/*parentCoordinator=*/</span> null<span class="token punctuation">,</span>
        transitionOptions<span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">.</span><span class="token function">getOverrideWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">.</span><span class="token function">getOverrideHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">,</span>
        callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里调用了<code>buildRequestRecursive()</code>方法：</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> Request <span class="token function">buildRequestRecursive</span><span class="token punctuation">(</span>
      Object requestLock<span class="token punctuation">,</span>
      Target<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> target<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> targetListener<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestCoordinator parentCoordinator<span class="token punctuation">,</span>
      TransitionOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> TranscodeType<span class="token operator">&gt;</span> transitionOptions<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideWidth<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideHeight<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> requestOptions<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    ErrorRequestCoordinator errorRequestCoordinator <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token comment">// errorBuilder 不为空，即我们设置了在主请求失败时开始新的请求（如下设置） 才会去递归构建错误请求</span>
    <span class="token comment">// 设置在主请求失败时开始新的请求 Glide.with(this).load(url).error(Glide.with(this).load(fallbackUrl)).into(imageView);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorBuilder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      errorRequestCoordinator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorRequestCoordinator</span><span class="token punctuation">(</span>requestLock<span class="token punctuation">,</span> parentCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parentCoordinator <span class="token operator">=</span> errorRequestCoordinator<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 递归构建缩略图请求</span>
    Request mainRequest <span class="token operator">=</span>
        <span class="token function">buildThumbnailRequestRecursive</span><span class="token punctuation">(</span>
            requestLock<span class="token punctuation">,</span>
            target<span class="token punctuation">,</span>
            targetListener<span class="token punctuation">,</span>
            parentCoordinator<span class="token punctuation">,</span>
            transitionOptions<span class="token punctuation">,</span>
            priority<span class="token punctuation">,</span>
            overrideWidth<span class="token punctuation">,</span>
            overrideHeight<span class="token punctuation">,</span>
            requestOptions<span class="token punctuation">,</span>
            callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorRequestCoordinator <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> mainRequest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> errorOverrideWidth <span class="token operator">=</span> errorBuilder<span class="token punctuation">.</span><span class="token function">getOverrideWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> errorOverrideHeight <span class="token operator">=</span> errorBuilder<span class="token punctuation">.</span><span class="token function">getOverrideHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isValidDimensions</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errorBuilder<span class="token punctuation">.</span><span class="token function">isValidOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      errorOverrideWidth <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">getOverrideWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      errorOverrideHeight <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">getOverrideHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 递归构建错误请求</span>
    Request errorRequest <span class="token operator">=</span>
        errorBuilder<span class="token punctuation">.</span><span class="token function">buildRequestRecursive</span><span class="token punctuation">(</span>
            requestLock<span class="token punctuation">,</span>
            target<span class="token punctuation">,</span>
            targetListener<span class="token punctuation">,</span>
            errorRequestCoordinator<span class="token punctuation">,</span>
            errorBuilder<span class="token punctuation">.</span>transitionOptions<span class="token punctuation">,</span>
            errorBuilder<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            errorOverrideWidth<span class="token punctuation">,</span>
            errorOverrideHeight<span class="token punctuation">,</span>
            errorBuilder<span class="token punctuation">,</span>
            callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    errorRequestCoordinator<span class="token punctuation">.</span><span class="token function">setRequests</span><span class="token punctuation">(</span>mainRequest<span class="token punctuation">,</span> errorRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> errorRequestCoordinator<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><code>buildRequestRecursive()</code>，从名字上来看，是递归地生成请求。</p> 
<p><code>errorBuilder</code> 不为空，即我们设置了在主请求失败时开始新的请求（如下设置），才会走最后去递归构建错误请求。</p> 
<pre><code class="prism language-java"><span class="token comment">// 设置在主请求失败时开始新的请求</span>
Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>fallbackUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>若<code>errorBuilder</code> 为空，则调用<code>buildThumbnailRequestRecursive()</code>递归地构造一个缩略图请求。然后就返回。</p> 
<p>接下来我们主要关注<code>buildThumbnailRequestRecursive()</code>。</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> Request <span class="token function">buildThumbnailRequestRecursive</span><span class="token punctuation">(</span>
      Object requestLock<span class="token punctuation">,</span>
      Target<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> target<span class="token punctuation">,</span>
      RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> targetListener<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestCoordinator parentCoordinator<span class="token punctuation">,</span>
      TransitionOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> TranscodeType<span class="token operator">&gt;</span> transitionOptions<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideWidth<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideHeight<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> requestOptions<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置了缩略图请求的时候会走这里</span>
    <span class="token comment">// Glide.with(this).load(url).thumbnail(Glide.with(this).load(thumbnailUrl)).into(imageView);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>thumbnailBuilder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Recursive case: contains a potentially recursive thumbnail request builder.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isThumbnailBuilt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
            <span class="token string">"You cannot use a request as both the main request and a "</span>
                <span class="token operator">+</span> <span class="token string">"thumbnail, consider using clone() on the request(s) passed to thumbnail()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      TransitionOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> TranscodeType<span class="token operator">&gt;</span> thumbTransitionOptions <span class="token operator">=</span>
          thumbnailBuilder<span class="token punctuation">.</span>transitionOptions<span class="token punctuation">;</span>

      <span class="token comment">// Apply our transition by default to thumbnail requests but avoid overriding custom options</span>
      <span class="token comment">// that may have been applied on the thumbnail request explicitly.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>thumbnailBuilder<span class="token punctuation">.</span>isDefaultTransitionOptionsSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        thumbTransitionOptions <span class="token operator">=</span> transitionOptions<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      Priority thumbPriority <span class="token operator">=</span>
          thumbnailBuilder<span class="token punctuation">.</span><span class="token function">isPrioritySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token operator">?</span> thumbnailBuilder<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token operator">:</span> <span class="token function">getThumbnailPriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">int</span> thumbOverrideWidth <span class="token operator">=</span> thumbnailBuilder<span class="token punctuation">.</span><span class="token function">getOverrideWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> thumbOverrideHeight <span class="token operator">=</span> thumbnailBuilder<span class="token punctuation">.</span><span class="token function">getOverrideHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isValidDimensions</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>thumbnailBuilder<span class="token punctuation">.</span><span class="token function">isValidOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        thumbOverrideWidth <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">getOverrideWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thumbOverrideHeight <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">getOverrideHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 创建一个协调器，用来协调这两个请求，这样可以同时进行原图与缩略图的请求。</span>
      ThumbnailRequestCoordinator coordinator <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">ThumbnailRequestCoordinator</span><span class="token punctuation">(</span>requestLock<span class="token punctuation">,</span> parentCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取一个原图请求</span>
      Request fullRequest <span class="token operator">=</span>
          <span class="token function">obtainRequest</span><span class="token punctuation">(</span>
              requestLock<span class="token punctuation">,</span>
              target<span class="token punctuation">,</span>
              targetListener<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">,</span>
              coordinator<span class="token punctuation">,</span>
              transitionOptions<span class="token punctuation">,</span>
              priority<span class="token punctuation">,</span>
              overrideWidth<span class="token punctuation">,</span>
              overrideHeight<span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isThumbnailBuilt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// Recursively generate thumbnail requests.</span>
      <span class="token comment">// 根据设置的 thumbnailBuilder 来生成缩略图请求</span>
      Request thumbRequest <span class="token operator">=</span>
          thumbnailBuilder<span class="token punctuation">.</span><span class="token function">buildRequestRecursive</span><span class="token punctuation">(</span>
              requestLock<span class="token punctuation">,</span>
              target<span class="token punctuation">,</span>
              targetListener<span class="token punctuation">,</span>
              coordinator<span class="token punctuation">,</span>
              thumbTransitionOptions<span class="token punctuation">,</span>
              thumbPriority<span class="token punctuation">,</span>
              thumbOverrideWidth<span class="token punctuation">,</span>
              thumbOverrideHeight<span class="token punctuation">,</span>
              thumbnailBuilder<span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isThumbnailBuilt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      coordinator<span class="token punctuation">.</span><span class="token function">setRequests</span><span class="token punctuation">(</span>fullRequest<span class="token punctuation">,</span> thumbRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> coordinator<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>thumbSizeMultiplier <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 设置缩略图的缩略比例</span>
      <span class="token comment">// Glide.with(this).load(url).thumbnail(0.5f).into(imageView);</span>
      <span class="token comment">// Base case: thumbnail multiplier generates a thumbnail request, but cannot recurse.</span>
      <span class="token comment">// 同样是通过一个协调器来同时进行原图与缩略图的请求，不同的是这里生成缩略图用的是缩略比例。</span>
      ThumbnailRequestCoordinator coordinator <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">ThumbnailRequestCoordinator</span><span class="token punctuation">(</span>requestLock<span class="token punctuation">,</span> parentCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//原图</span>
      Request fullRequest <span class="token operator">=</span>
          <span class="token function">obtainRequest</span><span class="token punctuation">(</span>
              requestLock<span class="token punctuation">,</span>
              target<span class="token punctuation">,</span>
              targetListener<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">,</span>
              coordinator<span class="token punctuation">,</span>
              transitionOptions<span class="token punctuation">,</span>
              priority<span class="token punctuation">,</span>
              overrideWidth<span class="token punctuation">,</span>
              overrideHeight<span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> thumbnailOptions <span class="token operator">=</span>
          requestOptions<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sizeMultiplier</span><span class="token punctuation">(</span>thumbSizeMultiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 缩略图</span>
      Request thumbnailRequest <span class="token operator">=</span>
          <span class="token function">obtainRequest</span><span class="token punctuation">(</span>
              requestLock<span class="token punctuation">,</span>
              target<span class="token punctuation">,</span>
              targetListener<span class="token punctuation">,</span>
              thumbnailOptions<span class="token punctuation">,</span>
              coordinator<span class="token punctuation">,</span>
              transitionOptions<span class="token punctuation">,</span>
              <span class="token function">getThumbnailPriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">,</span>
              overrideWidth<span class="token punctuation">,</span>
              overrideHeight<span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

      coordinator<span class="token punctuation">.</span><span class="token function">setRequests</span><span class="token punctuation">(</span>fullRequest<span class="token punctuation">,</span> thumbnailRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> coordinator<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 没有缩略图相关设置，直接获取原图请求。</span>
      <span class="token comment">// Base case: no thumbnail.</span>
      <span class="token keyword">return</span> <span class="token function">obtainRequest</span><span class="token punctuation">(</span>
          requestLock<span class="token punctuation">,</span>
          target<span class="token punctuation">,</span>
          targetListener<span class="token punctuation">,</span>
          requestOptions<span class="token punctuation">,</span>
          parentCoordinator<span class="token punctuation">,</span>
          transitionOptions<span class="token punctuation">,</span>
          priority<span class="token punctuation">,</span>
          overrideWidth<span class="token punctuation">,</span>
          overrideHeight<span class="token punctuation">,</span>
          callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>函数比较长，先看 <code>if...else</code> 语句的整体结果</p> 
<p><code>thumbnailBuilder</code>不为空，说明设置了缩略图（如下设置）。</p> 
<pre><code class="prism language-java">Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thumbnail</span><span class="token punctuation">(</span>Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>thumbnailUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>thumbSizeMultiplier</code>不为空，说明设置了缩略比例（如下设置）。</p> 
<pre><code class="prism language-java">Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thumbnail</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>否则的会，没有缩略相关设置，直接获取原图。</p> 
<p>我们只关心核心流程，所以看最后的else分支。</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> Request <span class="token function">obtainRequest</span><span class="token punctuation">(</span>
      Object requestLock<span class="token punctuation">,</span>
      Target<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> target<span class="token punctuation">,</span>
      RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span> targetListener<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> requestOptions<span class="token punctuation">,</span>
      RequestCoordinator requestCoordinator<span class="token punctuation">,</span>
      TransitionOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> TranscodeType<span class="token operator">&gt;</span> transitionOptions<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideWidth<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideHeight<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 最终是实例化了一个 SingleRequest 的实例，</span>
    <span class="token comment">// 构建请求这一步已经完成了</span>
    <span class="token comment">// 需要注意一下Target&lt;TranscodeType&gt; target,</span>
    <span class="token keyword">return</span> SingleRequest<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        glideContext<span class="token punctuation">,</span>
        requestLock<span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        transcodeClass<span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">,</span>
        overrideWidth<span class="token punctuation">,</span>
        overrideHeight<span class="token punctuation">,</span>
        priority<span class="token punctuation">,</span>
        target<span class="token punctuation">,</span>
        targetListener<span class="token punctuation">,</span>
        requestListeners<span class="token punctuation">,</span>
        requestCoordinator<span class="token punctuation">,</span>
        glideContext<span class="token punctuation">.</span><span class="token function">getEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transitionOptions<span class="token punctuation">.</span><span class="token function">getTransitionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//SingleRequest#obtain</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> SingleRequest<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> <span class="token function">obtain</span><span class="token punctuation">(</span>
      Context context<span class="token punctuation">,</span>
      GlideContext glideContext<span class="token punctuation">,</span>
      Object requestLock<span class="token punctuation">,</span>
      Object model<span class="token punctuation">,</span>
      Class<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> transcodeClass<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> requestOptions<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideWidth<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideHeight<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      Target<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> target<span class="token punctuation">,</span>
      RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> targetListener<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> List<span class="token operator">&lt;</span>RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> requestListeners<span class="token punctuation">,</span>
      RequestCoordinator requestCoordinator<span class="token punctuation">,</span>
      Engine engine<span class="token punctuation">,</span>
      TransitionFactory<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> R<span class="token operator">&gt;</span> animationFactory<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SingleRequest</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
        context<span class="token punctuation">,</span>
        glideContext<span class="token punctuation">,</span>
        requestLock<span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        transcodeClass<span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">,</span>
        overrideWidth<span class="token punctuation">,</span>
        overrideHeight<span class="token punctuation">,</span>
        priority<span class="token punctuation">,</span>
        target<span class="token punctuation">,</span>
        targetListener<span class="token punctuation">,</span>
        requestListeners<span class="token punctuation">,</span>
        requestCoordinator<span class="token punctuation">,</span>
        engine<span class="token punctuation">,</span>
        animationFactory<span class="token punctuation">,</span>
        callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">SingleRequest</span><span class="token punctuation">(</span>
      Context context<span class="token punctuation">,</span>
      GlideContext glideContext<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Object requestLock<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> Object model<span class="token punctuation">,</span>
      Class<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> transcodeClass<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> requestOptions<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideWidth<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideHeight<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      Target<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> target<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> targetListener<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> List<span class="token operator">&lt;</span>RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> requestListeners<span class="token punctuation">,</span>
      RequestCoordinator requestCoordinator<span class="token punctuation">,</span>
      Engine engine<span class="token punctuation">,</span>
      TransitionFactory<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> R<span class="token operator">&gt;</span> animationFactory<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestLock <span class="token operator">=</span> requestLock<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>glideContext <span class="token operator">=</span> glideContext<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>model <span class="token operator">=</span> model<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>transcodeClass <span class="token operator">=</span> transcodeClass<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestOptions <span class="token operator">=</span> requestOptions<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>overrideWidth <span class="token operator">=</span> overrideWidth<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>overrideHeight <span class="token operator">=</span> overrideHeight<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>priority <span class="token operator">=</span> priority<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>targetListener <span class="token operator">=</span> targetListener<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestListeners <span class="token operator">=</span> requestListeners<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestCoordinator <span class="token operator">=</span> requestCoordinator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>engine <span class="token operator">=</span> engine<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>animationFactory <span class="token operator">=</span> animationFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbackExecutor <span class="token operator">=</span> callbackExecutor<span class="token punctuation">;</span>
    status <span class="token operator">=</span> Status<span class="token punctuation">.</span>PENDING<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestOrigin <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> glideContext<span class="token punctuation">.</span><span class="token function">getExperiments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span>LogRequestOrigins<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      requestOrigin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Glide request origin trace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>最终是实例化了一个 SingleRequest 的实例，也就是说构建请求这一步已经完成了。</p> 
<p>前面我们注意到返回的是Request对象，可以看到SingleRequest是Request的具体实现。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SingleRequest</span><span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Request</span><span class="token punctuation">,</span> SizeReadyCallback<span class="token punctuation">,</span> ResourceCallback<span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre> 
<p>接下来分析执行请求这一步。</p> 
<h5><a id="32_RequestManagertrack_1500"></a>3.2 RequestManager#track()</h5> 
<p>代码如下：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"this"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> TargetTracker targetTracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TargetTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"this"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> RequestTracker requestTracker<span class="token punctuation">;</span>

  <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> target<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Request request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 将一个 target 加入 Set 集合中</span>
    targetTracker<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//请求</span>
    requestTracker<span class="token punctuation">.</span><span class="token function">runRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>track的输入参数是<code>Target&lt;?&gt; target</code>和<code>@NonNull Request</code>。</p> 
<p>分别执行了<code>TargetTracker#track</code>和<code>RequestTracker#runRequest</code>。</p> 
<p><code>TargetTracker#track()</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TargetTracker</span> <span class="token keyword">implements</span> <span class="token class-name">LifecycleListener</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Set<span class="token operator">&lt;</span>Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span> targets <span class="token operator">=</span>
      Collections<span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token operator">&lt;</span>Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> Boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    targets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">untrack</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    targets<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> target <span class="token operator">:</span> Util<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      target<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> target <span class="token operator">:</span> Util<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      target<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> target <span class="token operator">:</span> Util<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      target<span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span> <span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> Util<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    targets<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>TargetTracker看着比较简单，<code>track()</code>方法是将一个 target 加入 Set 集合中。</p> 
<p><code>RequestTracker#runRequest()</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestTracker</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>Request<span class="token punctuation">&gt;</span></span> requests <span class="token operator">=</span>
      Collections<span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>Request<span class="token punctuation">,</span> Boolean<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>Request<span class="token punctuation">&gt;</span></span> pendingRequests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">boolean</span> isPaused<span class="token punctuation">;</span>
  
  <span class="token comment">/** Starts tracking the given request. */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runRequest</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Request request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 将请求加入一个 Set 集合</span>
    requests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 然后判断是否暂停状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isPaused<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 不是暂停状态则开始请求</span>
      <span class="token comment">// request为一个接口</span>
      <span class="token comment">// 前面我们分析到不加载缩略图Request的实现为SingleRequest</span>
      <span class="token comment">// 这里去看SingleRequest的begin方法</span>
      request<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 是则清空请求</span>
      request<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Paused, delaying request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 并将该请求加入待处理的请求集合中</span>
      pendingRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>  
  
<span class="token punctuation">}</span>
</code></pre> 
<p>代码如上所示。</p> 
<p>首先将请求加入一个 Set 集合；然后判断是否暂停状态，是则清空请求，并将该请求加入待处理的请求集合中；不是暂停状态，则开始请求。</p> 
<p>重点是<code>request.begin()</code>，我们上面分析过，Request的实现为SingleRequest，所以我们去看<code>SingleRequest#begin()</code>方法。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>requestLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">assertNotCallingCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stateVerifier<span class="token punctuation">.</span><span class="token function">throwIfRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      startTime <span class="token operator">=</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果加载的资源为空，则调用加载失败的回调</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isValidDimensions</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          width <span class="token operator">=</span> overrideWidth<span class="token punctuation">;</span>
          height <span class="token operator">=</span> overrideHeight<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> logLevel <span class="token operator">=</span> <span class="token function">getFallbackDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> Log<span class="token punctuation">.</span>WARN <span class="token operator">:</span> Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">;</span>
        <span class="token function">onLoadFailed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GlideException</span><span class="token punctuation">(</span><span class="token string">"Received null model"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> Status<span class="token punctuation">.</span>RUNNING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Cannot restart a running request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> Status<span class="token punctuation">.</span>COMPLETE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 资源加载完成</span>
        <span class="token function">onResourceReady</span><span class="token punctuation">(</span>
            resource<span class="token punctuation">,</span> DataSource<span class="token punctuation">.</span>MEMORY_CACHE<span class="token punctuation">,</span> <span class="token comment">/* isLoadedFromAlternateCacheKey= */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    status <span class="token operator">=</span> Status<span class="token punctuation">.</span>WAITING_FOR_SIZE<span class="token punctuation">;</span>
      <span class="token comment">// 这里做了一个判断，如果我们设置了overrideWidth 和 overrideHeight（如下设置），</span>
      <span class="token comment">// 则直接调用 onSizeReady() 方法，否则调用 getSize() 方法（第一次加载才会调用）。</span>
      <span class="token comment">// 设置加载图片的宽高为 100x100 px</span>
      <span class="token comment">// Glide.with(this).load(url).override(100,100).into(imageView);</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isValidDimensions</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">onSizeReady</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// getSize() 方法的作用是通过 ViewTreeObserver 来监听 ImageView 的宽高</span>
        <span class="token comment">// 拿到宽高后最终也是调用 onSizeReady() 方法。</span>
        target<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">==</span> Status<span class="token punctuation">.</span>RUNNING <span class="token operator">||</span> status <span class="token operator">==</span> Status<span class="token punctuation">.</span>WAITING_FOR_SIZE<span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token function">canNotifyStatusChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 刚开始加载的回调</span>
        target<span class="token punctuation">.</span><span class="token function">onLoadStarted</span><span class="token punctuation">(</span><span class="token function">getPlaceholderDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>IS_VERBOSE_LOGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">logV</span><span class="token punctuation">(</span><span class="token string">"finished run method in "</span> <span class="token operator">+</span> LogTime<span class="token punctuation">.</span><span class="token function">getElapsedMillis</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>这里代码比较多。当前我们关注的第一个关键代码如下：</p> 
<pre><code class="prism language-java">      <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isValidDimensions</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">onSizeReady</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        target<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre> 
<p>这里做了一个判断，如果我们设置了 overrideWidth 和 overrideHeight（如下代码所示），则直接调用 <code>onSizeReady()</code> 方法，否则调用 <code>getSize()</code> 方法（第一次加载才会调用）。</p> 
<pre><code class="prism language-java"><span class="token comment">// 设置加载图片的宽高为 100x100 px</span>
Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>getSize()</code> 方法的作用是通过 ViewTreeObserver 来监听 ImageView 的宽高，拿到宽高后最终也是调用 <code>onSizeReady()</code> 方法。</p> 
<pre><code class="prism language-java"><span class="token comment">//Target</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Target</span><span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">LifecycleListener</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">void</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> SizeReadyCallback cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">//SizeReadyCallback</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SizeReadyCallback</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">void</span> <span class="token function">onSizeReady</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来我们看 <code>onSizeReady()</code> 方法。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSizeReady</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    stateVerifier<span class="token punctuation">.</span><span class="token function">throwIfRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>requestLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>IS_VERBOSE_LOGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">logV</span><span class="token punctuation">(</span><span class="token string">"Got onSizeReady in "</span> <span class="token operator">+</span> LogTime<span class="token punctuation">.</span><span class="token function">getElapsedMillis</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> Status<span class="token punctuation">.</span>WAITING_FOR_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      status <span class="token operator">=</span> Status<span class="token punctuation">.</span>RUNNING<span class="token punctuation">;</span>
      <span class="token comment">// 根据缩略比例获取图片宽高</span>
      <span class="token keyword">float</span> sizeMultiplier <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">getSizeMultiplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token function">maybeApplySizeMultiplier</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> sizeMultiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token function">maybeApplySizeMultiplier</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> sizeMultiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>IS_VERBOSE_LOGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">logV</span><span class="token punctuation">(</span><span class="token string">"finished setup for calling load in "</span> <span class="token operator">+</span> LogTime<span class="token punctuation">.</span><span class="token function">getElapsedMillis</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 开始加载</span>
      loadStatus <span class="token operator">=</span>
          engine<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
              glideContext<span class="token punctuation">,</span>
              model<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getResourceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              transcodeClass<span class="token punctuation">,</span>
              priority<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getDiskCacheStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getTransformations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">isTransformationRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">isScaleOnlyOrNoTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">isMemoryCacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getUseUnlimitedSourceGeneratorsPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getUseAnimationPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getOnlyRetrieveFromCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> Status<span class="token punctuation">.</span>RUNNING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        loadStatus <span class="token operator">=</span> null<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>IS_VERBOSE_LOGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">logV</span><span class="token punctuation">(</span><span class="token string">"finished onSizeReady in "</span> <span class="token operator">+</span> LogTime<span class="token punctuation">.</span><span class="token function">getElapsedMillis</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里着重关注<code>engine.load()</code>方法，可以猜测为正在加载的部分。</p> 
<p><code>Engine#load()</code>如下：</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> LoadStatus <span class="token function">load</span><span class="token punctuation">(</span>
      GlideContext glideContext<span class="token punctuation">,</span>
      Object model<span class="token punctuation">,</span>
      Key signature<span class="token punctuation">,</span>
      <span class="token keyword">int</span> width<span class="token punctuation">,</span>
      <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> resourceClass<span class="token punctuation">,</span>
      Class<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> transcodeClass<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      DiskCacheStrategy diskCacheStrategy<span class="token punctuation">,</span>
      Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> Transformation<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span> transformations<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isTransformationRequired<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isScaleOnlyOrNoTransform<span class="token punctuation">,</span>
      Options options<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isMemoryCacheable<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> useUnlimitedSourceExecutorPool<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> useAnimationPool<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> onlyRetrieveFromCache<span class="token punctuation">,</span>
      ResourceCallback cb<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> VERBOSE_IS_LOGGABLE <span class="token operator">?</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 构建缓存 key</span>
    EngineKey key <span class="token operator">=</span>
        keyFactory<span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>
            model<span class="token punctuation">,</span>
            signature<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            transformations<span class="token punctuation">,</span>
            resourceClass<span class="token punctuation">,</span>
            transcodeClass<span class="token punctuation">,</span>
            options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从内存中加载资源</span>
    EngineResource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> memoryResource<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      memoryResource <span class="token operator">=</span> <span class="token function">loadFromMemory</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> isMemoryCacheable<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 内存中没有，则等待当前正在执行的或开始一个新的 EngineJob</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>memoryResource <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">waitForExistingOrStartNewJob</span><span class="token punctuation">(</span>
            glideContext<span class="token punctuation">,</span>
            model<span class="token punctuation">,</span>
            signature<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            resourceClass<span class="token punctuation">,</span>
            transcodeClass<span class="token punctuation">,</span>
            priority<span class="token punctuation">,</span>
            diskCacheStrategy<span class="token punctuation">,</span>
            transformations<span class="token punctuation">,</span>
            isTransformationRequired<span class="token punctuation">,</span>
            isScaleOnlyOrNoTransform<span class="token punctuation">,</span>
            options<span class="token punctuation">,</span>
            isMemoryCacheable<span class="token punctuation">,</span>
            useUnlimitedSourceExecutorPool<span class="token punctuation">,</span>
            useAnimationPool<span class="token punctuation">,</span>
            onlyRetrieveFromCache<span class="token punctuation">,</span>
            cb<span class="token punctuation">,</span>
            callbackExecutor<span class="token punctuation">,</span>
            key<span class="token punctuation">,</span>
            startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 加载完成回调</span>
    cb<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>
        memoryResource<span class="token punctuation">,</span> DataSource<span class="token punctuation">.</span>MEMORY_CACHE<span class="token punctuation">,</span> <span class="token comment">/* isLoadedFromAlternateCacheKey= */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>load分为几步：</p> 
<p>构建缓存 key，然后利用这个 key 获取缓存中的资源；如果内存中没有，则等待当前正在执行的或开始一个新的 EngineJob；内存中有则调用加载完成的回调。</p> 
<p>我们先不关注缓存，分析主要流程，也就是在缓存中查找不到数据，所以执行<code>waitForExistingOrStartNewJob()</code>。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> LoadStatus <span class="token function">waitForExistingOrStartNewJob</span><span class="token punctuation">(</span>
    GlideContext glideContext<span class="token punctuation">,</span>
    Object model<span class="token punctuation">,</span>
    Key signature<span class="token punctuation">,</span>
    <span class="token keyword">int</span> width<span class="token punctuation">,</span>
    <span class="token keyword">int</span> height<span class="token punctuation">,</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> resourceClass<span class="token punctuation">,</span>
    Class<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> transcodeClass<span class="token punctuation">,</span>
    Priority priority<span class="token punctuation">,</span>
    DiskCacheStrategy diskCacheStrategy<span class="token punctuation">,</span>
    Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> Transformation<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span> transformations<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> isTransformationRequired<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> isScaleOnlyOrNoTransform<span class="token punctuation">,</span>
    Options options<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> isMemoryCacheable<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> useUnlimitedSourceExecutorPool<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> useAnimationPool<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> onlyRetrieveFromCache<span class="token punctuation">,</span>
    ResourceCallback cb<span class="token punctuation">,</span>
    Executor callbackExecutor<span class="token punctuation">,</span>
    EngineKey key<span class="token punctuation">,</span>
    <span class="token keyword">long</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  <span class="token comment">// 从 map 集合中获取 EngineJob，如果不为空表示当前有正在执行的 EngineJob，添加回调并返回加载状态</span>
  EngineJob<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> current <span class="token operator">=</span> jobs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> onlyRetrieveFromCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    current<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>VERBOSE_IS_LOGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">logWithTimeAndKey</span><span class="token punctuation">(</span><span class="token string">"Added to existing load"</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 使用 EngineJob 工厂构建了一个 EngineJob，该类主要用来管理加载以及当加载完成时通知回调</span>
  EngineJob<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> engineJob <span class="token operator">=</span>
      engineJobFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
          key<span class="token punctuation">,</span>
          isMemoryCacheable<span class="token punctuation">,</span>
          useUnlimitedSourceExecutorPool<span class="token punctuation">,</span>
          useAnimationPool<span class="token punctuation">,</span>
          onlyRetrieveFromCache<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 使用 DecodeJob 工厂构建了一个 DecodeJob，该类主要负责图片的解码，实现了 Runnable 接口，属于一个任务</span>
  DecodeJob<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> decodeJob <span class="token operator">=</span>
      decodeJobFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
          glideContext<span class="token punctuation">,</span>
          model<span class="token punctuation">,</span>
          key<span class="token punctuation">,</span>
          signature<span class="token punctuation">,</span>
          width<span class="token punctuation">,</span>
          height<span class="token punctuation">,</span>
          resourceClass<span class="token punctuation">,</span>
          transcodeClass<span class="token punctuation">,</span>
          priority<span class="token punctuation">,</span>
          diskCacheStrategy<span class="token punctuation">,</span>
          transformations<span class="token punctuation">,</span>
          isTransformationRequired<span class="token punctuation">,</span>
          isScaleOnlyOrNoTransform<span class="token punctuation">,</span>
          onlyRetrieveFromCache<span class="token punctuation">,</span>
          options<span class="token punctuation">,</span>
          engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将 EngineJob 放到一个 map 集合中</span>
  jobs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 添加回调</span>
  engineJob<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 这里调用了 EngineJob#start()</span>
  engineJob<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>decodeJob<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>VERBOSE_IS_LOGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">logWithTimeAndKey</span><span class="token punctuation">(</span><span class="token string">"Started new load"</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回加载状态</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里做了以下几件事：</p> 
<ul><li> <p>从 map 集合中获取 EngineJob，如果不为空表示当前有正在执行的 EngineJob，添加回调并返回加载状态。</p> </li><li> <p>使用 EngineJob 工厂构建了一个 EngineJob，该类主要用来管理加载以及当加载完成时通知回调。</p> </li><li> <p>使用 DecodeJob 工厂构建了一个 DecodeJob，该类主要负责图片的解码，实现了 Runnable 接口，属于一个任务。</p> </li><li> <p>这里调用了 <code>EngineJob#start()</code></p> </li></ul> 
<p>这里我们主要关注<code>EngineJob#start()</code>过程。</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span>DecodeJob<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> decodeJob<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>decodeJob <span class="token operator">=</span> decodeJob<span class="token punctuation">;</span>
    <span class="token comment">// 直接将 DecodeJob 任务放到了一个线程池中去执行，也就是说从这里开始切换到子线程了</span>
    GlideExecutor executor <span class="token operator">=</span>
        decodeJob<span class="token punctuation">.</span><span class="token function">willDecodeFromCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> diskCacheExecutor <span class="token operator">:</span> <span class="token function">getActiveSourceExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//关注 DecodeJob 的 run() 方法</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>decodeJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，这里是将DecodeJob放到一个线程池中执行。</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">DecodeJob</span><span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">DataFetcherGenerator<span class="token punctuation">.</span>FetcherReadyCallback</span><span class="token punctuation">,</span>
        Runnable<span class="token punctuation">,</span>
        Comparable<span class="token operator">&lt;</span>DecodeJob<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
        Poolable <span class="token punctuation">{<!-- --></span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    GlideTrace<span class="token punctuation">.</span><span class="token function">beginSectionFormat</span><span class="token punctuation">(</span><span class="token string">"DecodeJob#run(model=%s)"</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    DataFetcher<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> localFetcher <span class="token operator">=</span> currentFetcher<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 被取消，则调用加载失败的回调</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isCancelled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">notifyFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 执行</span>
      <span class="token function">runWrapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CallbackException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">!=</span> Stage<span class="token punctuation">.</span>ENCODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        throwables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">notifyFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCancelled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> t<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>localFetcher <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        localFetcher<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      GlideTrace<span class="token punctuation">.</span><span class="token function">endSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
            
<span class="token punctuation">}</span>
</code></pre> 
<p>真的执行是在<code>runWrapped()</code>方法中。</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">runWrapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>runReason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> INITIALIZE<span class="token operator">:</span>
        <span class="token comment">// runReason 的默认值为 INITIALIZE，走的是第一个 case。</span>
        <span class="token comment">// 若配置了禁用内存与磁盘缓存，getNextStage得到的stage为 SOURCE</span>
        <span class="token comment">// 获取资源状态</span>
        stage <span class="token operator">=</span> <span class="token function">getNextStage</span><span class="token punctuation">(</span>Stage<span class="token punctuation">.</span>INITIALIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据资源状态获取资源执行器</span>
        currentGenerator <span class="token operator">=</span> <span class="token function">getNextGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行</span>
        <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> SWITCH_TO_SOURCE_SERVICE<span class="token operator">:</span>
        <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DECODE_DATA<span class="token operator">:</span>
        <span class="token function">decodeFromRetrievedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unrecognized run reason: "</span> <span class="token operator">+</span> runReason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> Stage <span class="token function">getNextStage</span><span class="token punctuation">(</span>Stage current<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> INITIALIZE<span class="token operator">:</span>
        <span class="token keyword">return</span> diskCacheStrategy<span class="token punctuation">.</span><span class="token function">decodeCachedResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> Stage<span class="token punctuation">.</span>RESOURCE_CACHE
            <span class="token operator">:</span> <span class="token function">getNextStage</span><span class="token punctuation">(</span>Stage<span class="token punctuation">.</span>RESOURCE_CACHE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> RESOURCE_CACHE<span class="token operator">:</span>
        <span class="token keyword">return</span> diskCacheStrategy<span class="token punctuation">.</span><span class="token function">decodeCachedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> Stage<span class="token punctuation">.</span>DATA_CACHE
            <span class="token operator">:</span> <span class="token function">getNextStage</span><span class="token punctuation">(</span>Stage<span class="token punctuation">.</span>DATA_CACHE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DATA_CACHE<span class="token operator">:</span>
        <span class="token comment">// Skip loading from source if the user opted to only retrieve the resource from cache.</span>
        <span class="token keyword">return</span> onlyRetrieveFromCache <span class="token operator">?</span> Stage<span class="token punctuation">.</span>FINISHED <span class="token operator">:</span> Stage<span class="token punctuation">.</span>SOURCE<span class="token punctuation">;</span>
      <span class="token keyword">case</span> SOURCE<span class="token operator">:</span>
      <span class="token keyword">case</span> FINISHED<span class="token operator">:</span>
        <span class="token keyword">return</span> Stage<span class="token punctuation">.</span>FINISHED<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unrecognized stage: "</span> <span class="token operator">+</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> DataFetcherGenerator <span class="token function">getNextGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> RESOURCE_CACHE<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResourceCacheGenerator</span><span class="token punctuation">(</span>decodeHelper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DATA_CACHE<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataCacheGenerator</span><span class="token punctuation">(</span>decodeHelper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> SOURCE<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SourceGenerator</span><span class="token punctuation">(</span>decodeHelper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> FINISHED<span class="token operator">:</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unrecognized stage: "</span> <span class="token operator">+</span> stage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>runReason 的默认值为 INITIALIZE，所以走的是第一个 case。</p> 
<p>由于我们配置了禁用内存与磁盘缓存，所以得到的 stage 为 SOURCE，currentGenerator 为 SourceGenerator。</p> 
<p>拿到资源执行器接着就是执行了，调用了<code>runGenerators()</code> 方法。</p> 
<p>接下来我们查看<code>runGenerators()</code> 方法</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    currentThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    startFetchTime <span class="token operator">=</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 若 currentGenerator 在这里为 SourceGenerator</span>
    <span class="token comment">// 调用 startNext() 方法的时候实际调用的是 SourceGenerator#startNext()</span>
    <span class="token comment">// 该方法执行完返回的结果为 true，所以 while 循环是进不去的</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCancelled
        <span class="token operator">&amp;&amp;</span> currentGenerator <span class="token operator">!=</span> null
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>isStarted <span class="token operator">=</span> currentGenerator<span class="token punctuation">.</span><span class="token function">startNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      stage <span class="token operator">=</span> <span class="token function">getNextStage</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      currentGenerator <span class="token operator">=</span> <span class="token function">getNextGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> Stage<span class="token punctuation">.</span>SOURCE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">reschedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stage <span class="token operator">==</span> Stage<span class="token punctuation">.</span>FINISHED <span class="token operator">||</span> isCancelled<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isStarted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">notifyFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>我们分析的currentGenerator 在这里为 SourceGenerator，所以调用 <code>startNext()</code> 方法的时候实际调用的是 <code>SourceGenerator#startNext()</code>。查看该方法后发现，执行完返回的结果为 true，所以 while 循环是进不去的。我们主要就是分析<code>SourceGenerator#startNext()</code>方法。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataToCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Object data <span class="token operator">=</span> dataToCache<span class="token punctuation">;</span>
      dataToCache <span class="token operator">=</span> null<span class="token punctuation">;</span>
      <span class="token function">cacheData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceCacheGenerator <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> sourceCacheGenerator<span class="token punctuation">.</span><span class="token function">startNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sourceCacheGenerator <span class="token operator">=</span> null<span class="token punctuation">;</span>

    loadData <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>started <span class="token operator">&amp;&amp;</span> <span class="token function">hasNextModelLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 通过 helper#getLoadData() 获取 LoadData 集合，</span>
      <span class="token comment">// 实际集合里面也就只有一个元素，然后通过索引获取一个 LoadData</span>
      loadData <span class="token operator">=</span> helper<span class="token punctuation">.</span><span class="token function">getLoadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loadDataListIndex<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>loadData <span class="token operator">!=</span> null
          <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>helper<span class="token punctuation">.</span><span class="token function">getDiskCacheStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDataCacheable</span><span class="token punctuation">(</span>loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token operator">||</span> helper<span class="token punctuation">.</span><span class="token function">hasLoadPath</span><span class="token punctuation">(</span>loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">getDataClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里表示开始加载了</span>
        <span class="token function">startNextLoad</span><span class="token punctuation">(</span>loadData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> started<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里我们先看<code>helper.getLoadData().get()</code>，再看<code>SourceGenerator#startNextLoad(loadData)</code>。</p> 
<p><code>helper.getLoadData().get()</code>：</p> 
<p><code>helper#getLoadData()</code> 获取 LoadData 集合，实际集合里面也就只有一个元素，然后通过索引获取一个 LoadData。</p> 
<pre><code class="prism language-java">  List<span class="token operator">&lt;</span>LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span> <span class="token function">getLoadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLoadDataSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      isLoadDataSet <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      loadData<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      List<span class="token operator">&lt;</span>ModelLoader<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;&gt;</span> modelLoaders <span class="token operator">=</span> glideContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModelLoaders</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> modelLoaders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ModelLoader<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">&gt;</span> modelLoader <span class="token operator">=</span> modelLoaders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过 ModelLoader 对象的 buildLoadData() 方法获取的 LoadData</span>
        <span class="token comment">// 从网络加载数据，这里实际调用的是</span>
        <span class="token comment">// com.bumptech.glide.load.model.stream HttpGlideUrlLoader#buildLoadData()</span>
        LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> current <span class="token operator">=</span> modelLoader<span class="token punctuation">.</span><span class="token function">buildLoadData</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          loadData<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> loadData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，这里是通过 ModelLoader 对象的<code>buildLoadData()</code> 方法获取的 LoadData。</p> 
<p>我们分析的是从网络加载数据，所以这里实际调用的是 <code>HttpGlideUrlLoader#buildLoadData()</code>，代码如下所示：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> LoadData<span class="token generics function"><span class="token punctuation">&lt;</span>InputStream<span class="token punctuation">&gt;</span></span> <span class="token function">buildLoadData</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> GlideUrl model<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    GlideUrl url <span class="token operator">=</span> model<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modelCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      url <span class="token operator">=</span> modelCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        modelCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        url <span class="token operator">=</span> model<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> timeout <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 实例化 LoadData 的时候顺带实例化了 HttpUrlFetcher</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadData</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpUrlFetcher</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>最后一行实例化 LoadData 的时候顺带实例化了 HttpUrlFetcher。</p> 
<p>接下来我们分析<code>SourceGenerator#startNextLoad(loadData)</code>：</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startNextLoad</span><span class="token punctuation">(</span><span class="token keyword">final</span> LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> toStart<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// loadData.fetcher 就是刚刚实例化 LoadData 的时候传进来的 HttpUrlFetcher</span>
    <span class="token comment">// 这里调用的是 HttpUrlFetcher#loadData()</span>
    loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">//这里的回调需要留心一下，后面会用到</span>
        <span class="token keyword">new</span> <span class="token class-name">DataCallback</span><span class="token generics function"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataReady</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Object data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentRequest</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">onDataReadyInternal</span><span class="token punctuation">(</span>toStart<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadFailed</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentRequest</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">onLoadFailedInternal</span><span class="token punctuation">(</span>toStart<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里的 <code>loadData.fetcher</code> 就是刚刚实例化 LoadData 的时候传进来的 HttpUrlFetcher，所以这里调用的是 <code>HttpUrlFetcher#loadData()</code>：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadData</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Priority priority<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> DataCallback<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> InputStream<span class="token operator">&gt;</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 通过重定向加载数据</span>
      InputStream result <span class="token operator">=</span> <span class="token function">loadDataWithRedirects</span><span class="token punctuation">(</span>glideUrl<span class="token punctuation">.</span><span class="token function">toURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> glideUrl<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 加载成功，回调数据</span>
      <span class="token comment">// 我们现在关注的实现在SourceGenerator</span>
      callback<span class="token punctuation">.</span><span class="token function">onDataReady</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to load data for url"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      callback<span class="token punctuation">.</span><span class="token function">onLoadFailed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Finished http url fetcher fetch in "</span> <span class="token operator">+</span> LogTime<span class="token punctuation">.</span><span class="token function">getElapsedMillis</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里我们需要关注2个点：<code>loadDataWithRedirects()</code>和<code>callback.onDataReady()</code></p> 
<p><code>loadDataWithRedirects()</code>在加载完数据后返回了 InputStream：</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> InputStream <span class="token function">loadDataWithRedirects</span><span class="token punctuation">(</span>
      URL url<span class="token punctuation">,</span> <span class="token keyword">int</span> redirects<span class="token punctuation">,</span> URL lastUrl<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> headers<span class="token punctuation">)</span> <span class="token keyword">throws</span> HttpException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redirects <span class="token operator">&gt;=</span> MAXIMUM_REDIRECTS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>
          <span class="token string">"Too many (&gt; "</span> <span class="token operator">+</span> MAXIMUM_REDIRECTS <span class="token operator">+</span> <span class="token string">") redirects!"</span><span class="token punctuation">,</span> INVALID_STATUS_CODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastUrl <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> url<span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lastUrl<span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token string">"In re-direct loop"</span><span class="token punctuation">,</span> INVALID_STATUS_CODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">URISyntaxException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取 HttpURLConnection 实例</span>
    urlConnection <span class="token operator">=</span> <span class="token function">buildAndConfigureConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      urlConnection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stream <span class="token operator">=</span> urlConnection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>
          <span class="token string">"Failed to connect or obtain data"</span><span class="token punctuation">,</span> <span class="token function">getHttpStatusCodeOrInvalid</span><span class="token punctuation">(</span>urlConnection<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCancelled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> statusCode <span class="token operator">=</span> <span class="token function">getHttpStatusCodeOrInvalid</span><span class="token punctuation">(</span>urlConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHttpOk</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 请求成功</span>
      <span class="token comment">// 获取 InputStream</span>
      <span class="token keyword">return</span> <span class="token function">getStreamForSuccessfulRequest</span><span class="token punctuation">(</span>urlConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHttpRedirect</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 重定向请求</span>
      String redirectUrlString <span class="token operator">=</span> urlConnection<span class="token punctuation">.</span><span class="token function">getHeaderField</span><span class="token punctuation">(</span>REDIRECT_HEADER_FIELD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>redirectUrlString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token string">"Received empty or null redirect url"</span><span class="token punctuation">,</span> statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      URL redirectUrl<span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        redirectUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> redirectUrlString<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token string">"Bad redirect url: "</span> <span class="token operator">+</span> redirectUrlString<span class="token punctuation">,</span> statusCode<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//递归调用</span>
      <span class="token keyword">return</span> <span class="token function">loadDataWithRedirects</span><span class="token punctuation">(</span>redirectUrl<span class="token punctuation">,</span> redirects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode <span class="token operator">==</span> INVALID_STATUS_CODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>urlConnection<span class="token punctuation">.</span><span class="token function">getResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token string">"Failed to get a response message"</span><span class="token punctuation">,</span> statusCode<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>改部分主要是进行网络请求，可以看到 Glide 底层是采用 HttpURLConnection 来进行网络请求的，请求成功后返回了 InputStream。</p> 
<p>然后我们看<code>callback.onDataReady</code>，将 InputStream 回调返回，回顾一下<code>startNextLoad()</code>方法，传入的回调使用了匿名内部类，在<code>onDataReady()</code>方法中调用了<code>onDataReadyInternal(toStart, data)</code>方法。</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startNextLoad</span><span class="token punctuation">(</span><span class="token keyword">final</span> LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> toStart<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// loadData.fetcher 就是刚刚实例化 LoadData 的时候传进来的 HttpUrlFetcher</span>
    <span class="token comment">// 这里调用的是 HttpUrlFetcher#loadData()</span>
    loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">//这里的回调需要留心一下，后面会用到</span>
        <span class="token keyword">new</span> <span class="token class-name">DataCallback</span><span class="token generics function"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataReady</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Object data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentRequest</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">onDataReadyInternal</span><span class="token punctuation">(</span>toStart<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadFailed</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentRequest</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">onLoadFailedInternal</span><span class="token punctuation">(</span>toStart<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>接下来我们关注<code>onDataReadyInternal(toStart, data)</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> FetcherReadyCallback cb<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Synthetic</span>
  <span class="token keyword">void</span> <span class="token function">onDataReadyInternal</span><span class="token punctuation">(</span>LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> loadData<span class="token punctuation">,</span> Object data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    DiskCacheStrategy diskCacheStrategy <span class="token operator">=</span> helper<span class="token punctuation">.</span><span class="token function">getDiskCacheStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> diskCacheStrategy<span class="token punctuation">.</span><span class="token function">isDataCacheable</span><span class="token punctuation">(</span>loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      dataToCache <span class="token operator">=</span> data<span class="token punctuation">;</span>
      cb<span class="token punctuation">.</span><span class="token function">reschedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 执行这里</span>
      <span class="token comment">// 实现在DecodeJob</span>
      cb<span class="token punctuation">.</span><span class="token function">onDataFetcherReady</span><span class="token punctuation">(</span>
          loadData<span class="token punctuation">.</span>sourceKey<span class="token punctuation">,</span>
          data<span class="token punctuation">,</span>
          loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">,</span>
          loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          originalKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">//DecodeJob</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataFetcherReady</span><span class="token punctuation">(</span>
      Key sourceKey<span class="token punctuation">,</span> Object data<span class="token punctuation">,</span> DataFetcher<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> fetcher<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">,</span> Key attemptedKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentSourceKey <span class="token operator">=</span> sourceKey<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentData <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentFetcher <span class="token operator">=</span> fetcher<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentDataSource <span class="token operator">=</span> dataSource<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentAttemptingKey <span class="token operator">=</span> attemptedKey<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isLoadingFromAlternateCacheKey <span class="token operator">=</span> sourceKey <span class="token operator">!=</span> decodeHelper<span class="token punctuation">.</span><span class="token function">getCacheKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> currentThread<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      runReason <span class="token operator">=</span> RunReason<span class="token punctuation">.</span>DECODE_DATA<span class="token punctuation">;</span>
      callback<span class="token punctuation">.</span><span class="token function">reschedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      GlideTrace<span class="token punctuation">.</span><span class="token function">beginSection</span><span class="token punctuation">(</span><span class="token string">"DecodeJob.decodeFromRetrievedData"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 解码</span>
        <span class="token function">decodeFromRetrievedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        GlideTrace<span class="token punctuation">.</span><span class="token function">endSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>如上所示，经过一系列调用，最终调用<code>decodeFromRetrievedData()</code>进行解码，实现如下：</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decodeFromRetrievedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">logWithTimeAndKey</span><span class="token punctuation">(</span>
          <span class="token string">"Retrieved data"</span><span class="token punctuation">,</span>
          startFetchTime<span class="token punctuation">,</span>
          <span class="token string">"data: "</span>
              <span class="token operator">+</span> currentData
              <span class="token operator">+</span> <span class="token string">", cache key: "</span>
              <span class="token operator">+</span> currentSourceKey
              <span class="token operator">+</span> <span class="token string">", fetcher: "</span>
              <span class="token operator">+</span> currentFetcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> resource <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//解码</span>
      resource <span class="token operator">=</span> <span class="token function">decodeFromData</span><span class="token punctuation">(</span>currentFetcher<span class="token punctuation">,</span> currentData<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GlideException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      e<span class="token punctuation">.</span><span class="token function">setLoggingDetails</span><span class="token punctuation">(</span>currentAttemptingKey<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      throwables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//解码完成，通知下去</span>
      <span class="token function">notifyEncodeAndRelease</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">,</span> isLoadingFromAlternateCacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里有2个主要关注的部分：<code>decodeFromData()</code> 和<code>notifyEncodeAndRelease()</code></p> 
<p><code>decodeFromData()</code></p> 
<pre><code class="prism language-java"> <span class="token keyword">private</span> <span class="token generics function"><span class="token punctuation">&lt;</span>Data<span class="token punctuation">&gt;</span></span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> <span class="token function">decodeFromData</span><span class="token punctuation">(</span>
      DataFetcher<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> fetcher<span class="token punctuation">,</span> Data data<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">)</span> <span class="token keyword">throws</span> GlideException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">long</span> startTime <span class="token operator">=</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token function">decodeFromFetcher</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">logWithTimeAndKey</span><span class="token punctuation">(</span><span class="token string">"Decoded result "</span> <span class="token operator">+</span> result<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      fetcher<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
    <span class="token keyword">private</span> <span class="token generics function"><span class="token punctuation">&lt;</span>Data<span class="token punctuation">&gt;</span></span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> <span class="token function">decodeFromFetcher</span><span class="token punctuation">(</span>Data data<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> GlideException <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取解码器，解码器里面封装了 DecodePath，它就是用来解码转码的</span>
    LoadPath<span class="token operator">&lt;</span>Data<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> R<span class="token operator">&gt;</span> path <span class="token operator">=</span> decodeHelper<span class="token punctuation">.</span><span class="token function">getLoadPath</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Class<span class="token generics function"><span class="token punctuation">&lt;</span>Data<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过解码器解析数据</span>
    <span class="token keyword">return</span> <span class="token function">runLoadPath</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">private</span> <span class="token generics function"><span class="token punctuation">&lt;</span>Data<span class="token punctuation">,</span> ResourceType<span class="token punctuation">&gt;</span></span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> <span class="token function">runLoadPath</span><span class="token punctuation">(</span>
      Data data<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">,</span> LoadPath<span class="token generics function"><span class="token punctuation">&lt;</span>Data<span class="token punctuation">,</span> ResourceType<span class="token punctuation">,</span> R<span class="token punctuation">&gt;</span></span> path<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> GlideException <span class="token punctuation">{<!-- --></span>
    Options options <span class="token operator">=</span> <span class="token function">getOptionsWithHardwareConfig</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    DataRewinder<span class="token generics function"><span class="token punctuation">&lt;</span>Data<span class="token punctuation">&gt;</span></span> rewinder <span class="token operator">=</span> glideContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRewinder</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// ResourceType in DecodeCallback below is required for compilation to work with gradle.</span>
      <span class="token comment">// 将解码任务传递给 LoadPath 完成</span>
      <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
          rewinder<span class="token punctuation">,</span> options<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DecodeCallback</span><span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      rewinder<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment">//LoadPath</span>
  <span class="token keyword">public</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Transcode<span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span>
      DataRewinder<span class="token generics function"><span class="token punctuation">&lt;</span>Data<span class="token punctuation">&gt;</span></span> rewinder<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">,</span>
      <span class="token keyword">int</span> width<span class="token punctuation">,</span>
      <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      DecodePath<span class="token punctuation">.</span>DecodeCallback<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> decodeCallback<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> GlideException <span class="token punctuation">{<!-- --></span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>Throwable<span class="token punctuation">&gt;</span></span> throwables <span class="token operator">=</span> Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>listPool<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token function">loadWithExceptionList</span><span class="token punctuation">(</span>rewinder<span class="token punctuation">,</span> options<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> decodeCallback<span class="token punctuation">,</span> throwables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      listPool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>throwables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Transcode<span class="token punctuation">&gt;</span></span> <span class="token function">loadWithExceptionList</span><span class="token punctuation">(</span>
      DataRewinder<span class="token generics function"><span class="token punctuation">&lt;</span>Data<span class="token punctuation">&gt;</span></span> rewinder<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">,</span>
      <span class="token keyword">int</span> width<span class="token punctuation">,</span>
      <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      DecodePath<span class="token punctuation">.</span>DecodeCallback<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> decodeCallback<span class="token punctuation">,</span>
      List<span class="token generics function"><span class="token punctuation">&lt;</span>Throwable<span class="token punctuation">&gt;</span></span> exceptions<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> GlideException <span class="token punctuation">{<!-- --></span>
    Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Transcode<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token comment">//noinspection ForLoopReplaceableByForEach to improve perf</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> decodePaths<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      DecodePath<span class="token generics function"><span class="token punctuation">&lt;</span>Data<span class="token punctuation">,</span> ResourceType<span class="token punctuation">,</span> Transcode<span class="token punctuation">&gt;</span></span> path <span class="token operator">=</span> decodePaths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 开始解析数据</span>
        result <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>rewinder<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">,</span> decodeCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GlideException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        exceptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GlideException</span><span class="token punctuation">(</span>failureMessage<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>exceptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>可以看到，上面主要是获取解码器（LoadPath），然后解码器里面是封装了 DecodePath，经过一系列调用，最后其实是交给 DecodePath 的 <code>decode()</code> 方法来真正开始解析数据的。</p> 
<p><code>decode()</code> 方法如下：</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Transcode<span class="token punctuation">&gt;</span></span> <span class="token function">decode</span><span class="token punctuation">(</span>
      DataRewinder<span class="token generics function"><span class="token punctuation">&lt;</span>DataType<span class="token punctuation">&gt;</span></span> rewinder<span class="token punctuation">,</span>
      <span class="token keyword">int</span> width<span class="token punctuation">,</span>
      <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">,</span>
      DecodeCallback<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> GlideException <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 这里是一个解码过程，主要是将原始数据解码成原始图片</span>
    Resource<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> decoded <span class="token operator">=</span> <span class="token function">decodeResource</span><span class="token punctuation">(</span>rewinder<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里会调用 callback#onResourceDecoded() 进行回调，这里是回调到 DecodeJob#onResourceDecoded()</span>
    Resource<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> transformed <span class="token operator">=</span> callback<span class="token punctuation">.</span><span class="token function">onResourceDecoded</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// transcoder 为 BitmapDrawableTranscoder，所以这里调用的是 BitmapDrawableTranscoder#transcode()</span>
    <span class="token keyword">return</span> transcoder<span class="token punctuation">.</span><span class="token function">transcode</span><span class="token punctuation">(</span>transformed<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>这里分为三个部分：</p> 
<ul><li><code>decodeResource()</code>：</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@NonNull</span>
<span class="token keyword">private</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> <span class="token function">decodeResource</span><span class="token punctuation">(</span>
    DataRewinder<span class="token generics function"><span class="token punctuation">&lt;</span>DataType<span class="token punctuation">&gt;</span></span> rewinder<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> GlideException <span class="token punctuation">{<!-- --></span>
  List<span class="token generics function"><span class="token punctuation">&lt;</span>Throwable<span class="token punctuation">&gt;</span></span> exceptions <span class="token operator">=</span> Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>listPool<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">decodeResourceWithList</span><span class="token punctuation">(</span>rewinder<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
    listPool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">private</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> <span class="token function">decodeResourceWithList</span><span class="token punctuation">(</span>
      DataRewinder<span class="token generics function"><span class="token punctuation">&lt;</span>DataType<span class="token punctuation">&gt;</span></span> rewinder<span class="token punctuation">,</span>
      <span class="token keyword">int</span> width<span class="token punctuation">,</span>
      <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">,</span>
      List<span class="token generics function"><span class="token punctuation">&lt;</span>Throwable<span class="token punctuation">&gt;</span></span> exceptions<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> GlideException <span class="token punctuation">{<!-- --></span>
    Resource<span class="token generics function"><span class="token punctuation">&lt;</span>ResourceType<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token comment">//noinspection ForLoopReplaceableByForEach to improve perf</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> decoders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ResourceDecoder<span class="token generics function"><span class="token punctuation">&lt;</span>DataType<span class="token punctuation">,</span> ResourceType<span class="token punctuation">&gt;</span></span> decoder <span class="token operator">=</span> decoders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        DataType data <span class="token operator">=</span> rewinder<span class="token punctuation">.</span><span class="token function">rewindAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">handles</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          data <span class="token operator">=</span> rewinder<span class="token punctuation">.</span><span class="token function">rewindAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//调用的是 StreamBitmapDecoder#decode()</span>
          result <span class="token operator">=</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> RuntimeException <span class="token operator">|</span> OutOfMemoryError e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to decode data for "</span> <span class="token operator">+</span> decoder<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        exceptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GlideException</span><span class="token punctuation">(</span>failureMessage<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>exceptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，这里遍历拿到可以解码当前数据的资源解码器，然后调用 decode() 方法进行解码。</p> 
<p>因为当前数据是 InputStream，所以这里遍历拿到的 ResourceDecoder 其实是 StreamBitmapDecoder，所以调用的是 <code>StreamBitmapDecoder#decode()</code>。</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Bitmap<span class="token punctuation">&gt;</span></span> <span class="token function">decode</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> InputStream source<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>

 
    <span class="token keyword">final</span> RecyclableBufferedInputStream bufferedStream<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> ownsBufferedStream<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token keyword">instanceof</span> <span class="token class-name">RecyclableBufferedInputStream</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      bufferedStream <span class="token operator">=</span> <span class="token punctuation">(</span>RecyclableBufferedInputStream<span class="token punctuation">)</span> source<span class="token punctuation">;</span>
      ownsBufferedStream <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      bufferedStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecyclableBufferedInputStream</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> byteArrayPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ownsBufferedStream <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ExceptionCatchingInputStream exceptionStream <span class="token operator">=</span>
        ExceptionCatchingInputStream<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>bufferedStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    MarkEnforcingInputStream invalidatingStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MarkEnforcingInputStream</span><span class="token punctuation">(</span>exceptionStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UntrustedCallbacks callbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UntrustedCallbacks</span><span class="token punctuation">(</span>bufferedStream<span class="token punctuation">,</span> exceptionStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//Downsampler#decode</span>
      <span class="token keyword">return</span> downsampler<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>invalidatingStream<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      exceptionStream<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ownsBufferedStream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bufferedStream<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">public</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Bitmap<span class="token punctuation">&gt;</span></span> <span class="token function">decode</span><span class="token punctuation">(</span>
      InputStream is<span class="token punctuation">,</span>
      <span class="token keyword">int</span> requestedWidth<span class="token punctuation">,</span>
      <span class="token keyword">int</span> requestedHeight<span class="token punctuation">,</span>
      Options options<span class="token punctuation">,</span>
      DecodeCallbacks callbacks<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">decode</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">ImageReader<span class="token punctuation">.</span>InputStreamImageReader</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> parsers<span class="token punctuation">,</span> byteArrayPool<span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestedWidth<span class="token punctuation">,</span>
        requestedHeight<span class="token punctuation">,</span>
        options<span class="token punctuation">,</span>
        callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Bitmap<span class="token punctuation">&gt;</span></span> <span class="token function">decode</span><span class="token punctuation">(</span>
      ImageReader imageReader<span class="token punctuation">,</span>
      <span class="token keyword">int</span> requestedWidth<span class="token punctuation">,</span>
      <span class="token keyword">int</span> requestedHeight<span class="token punctuation">,</span>
      Options options<span class="token punctuation">,</span>
      DecodeCallbacks callbacks<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//根据输入流解码得到 Bitmap</span>
      Bitmap result <span class="token operator">=</span>
          <span class="token function">decodeFromWrappedStreams</span><span class="token punctuation">(</span>
              imageReader<span class="token punctuation">,</span>
              bitmapFactoryOptions<span class="token punctuation">,</span>
              downsampleStrategy<span class="token punctuation">,</span>
              decodeFormat<span class="token punctuation">,</span>
              preferredColorSpace<span class="token punctuation">,</span>
              isHardwareConfigAllowed<span class="token punctuation">,</span>
              requestedWidth<span class="token punctuation">,</span>
              requestedHeight<span class="token punctuation">,</span>
              fixBitmapToRequestedDimensions<span class="token punctuation">,</span>
              callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//将 Bitmap 包装成 Resource&lt;Bitmap&gt; 返回</span>
      <span class="token keyword">return</span> BitmapResource<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> bitmapPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">releaseOptions</span><span class="token punctuation">(</span>bitmapFactoryOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
      byteArrayPool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>bytesForOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


</code></pre> 
<p>流程如上，调用了 <code>Downsampler#decode()</code>，然后将输入流解码得到 Bitmap，最后将 Bitmap 包装成 Resource 返回。</p> 
<ul><li><code>callback.onResourceDecoded()</code>：</li></ul> 
<p>这里会调用 <code>callback#onResourceDecoded()</code> 进行回调，这里是回调到 <code>DecodeJob#onResourceDecoded()</code>：</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">DecodeCallback</span><span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">DecodePath<span class="token punctuation">.</span>DecodeCallback</span><span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> DataSource dataSource<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Synthetic</span>
    <span class="token function">DecodeCallback</span><span class="token punctuation">(</span>DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@NonNull</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> <span class="token function">onResourceDecoded</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> decoded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> DecodeJob<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onResourceDecoded</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>继续：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Synthetic</span>
  <span class="token annotation punctuation">@NonNull</span>
  <span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> <span class="token function">onResourceDecoded</span><span class="token punctuation">(</span>DataSource dataSource<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> decoded<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    Class<span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> resourceSubClass <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> decoded<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Transformation<span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> appliedTransformation <span class="token operator">=</span> null<span class="token punctuation">;</span>
    Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> transformed <span class="token operator">=</span> decoded<span class="token punctuation">;</span>
    <span class="token comment">// 如果不是从磁盘缓存中获取的，则需要对资源进行转换</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource <span class="token operator">!=</span> DataSource<span class="token punctuation">.</span>RESOURCE_DISK_CACHE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      appliedTransformation <span class="token operator">=</span> decodeHelper<span class="token punctuation">.</span><span class="token function">getTransformation</span><span class="token punctuation">(</span>resourceSubClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
      transformed <span class="token operator">=</span> appliedTransformation<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>glideContext<span class="token punctuation">,</span> decoded<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// TODO: Make this the responsibility of the Transformation.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>decoded<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>transformed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      decoded<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> EncodeStrategy encodeStrategy<span class="token punctuation">;</span>
    <span class="token keyword">final</span> ResourceEncoder<span class="token generics function"><span class="token punctuation">&lt;</span>Z<span class="token punctuation">&gt;</span></span> encoder<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>decodeHelper<span class="token punctuation">.</span><span class="token function">isResourceEncoderAvailable</span><span class="token punctuation">(</span>transformed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      encoder <span class="token operator">=</span> decodeHelper<span class="token punctuation">.</span><span class="token function">getResultEncoder</span><span class="token punctuation">(</span>transformed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      encodeStrategy <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">getEncodeStrategy</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      encoder <span class="token operator">=</span> null<span class="token punctuation">;</span>
      encodeStrategy <span class="token operator">=</span> EncodeStrategy<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 缓存相关</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，这里的任务是对资源进行转换，也就是我们请求的时候如果配置了 centerCrop、fitCenter 等，这里就需要转换成对应的资源。</p> 
<ul><li><code>transcoder.transcode()</code>:</li></ul> 
<p><code>transcoder.transcode(transformed, options)</code>中的 transcoder 为 BitmapDrawableTranscoder，所以这里调用的是 <code>BitmapDrawableTranscoder#transcode()</code>：</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>BitmapDrawable<span class="token punctuation">&gt;</span></span> <span class="token function">transcode</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Bitmap<span class="token punctuation">&gt;</span></span> toTranscode<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> LazyBitmapDrawableResource<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>resources<span class="token punctuation">,</span> toTranscode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>BitmapDrawable<span class="token punctuation">&gt;</span></span> <span class="token function">obtain</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Resources resources<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Bitmap<span class="token punctuation">&gt;</span></span> bitmapResource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapResource <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LazyBitmapDrawableResource</span><span class="token punctuation">(</span>resources<span class="token punctuation">,</span> bitmapResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">LazyBitmapDrawableResource</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Resources resources<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Resource<span class="token generics function"><span class="token punctuation">&lt;</span>Bitmap<span class="token punctuation">&gt;</span></span> bitmapResource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resources <span class="token operator">=</span> Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bitmapResource <span class="token operator">=</span> Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>bitmapResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>因为 LazyBitmapDrawableResource 实现了 Resource，所以最后是返回了一个 Resource，也就是说转码这一步是将 Bitmap 转成了 Resource。</p> 
<p><code>DecodeJob#decodeFromRetrievedData()</code>中的解码的流程就走完了。</p> 
<p>接下来我们回来看<code>notifyEncodeAndRelease()</code>方法：</p> 
<pre><code class="prism language-java">  <span class="token comment">//DecodeJob</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decodeFromRetrievedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> resource <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//解码</span>
      resource <span class="token operator">=</span> <span class="token function">decodeFromData</span><span class="token punctuation">(</span>currentFetcher<span class="token punctuation">,</span> currentData<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GlideException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      e<span class="token punctuation">.</span><span class="token function">setLoggingDetails</span><span class="token punctuation">(</span>currentAttemptingKey<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      throwables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//解码完成，通知下去</span>
      <span class="token function">notifyEncodeAndRelease</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">,</span> isLoadingFromAlternateCacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifyEncodeAndRelease</span><span class="token punctuation">(</span>
      Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> resource<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isLoadedFromAlternateCacheKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token keyword">instanceof</span> <span class="token class-name">Initializable</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>Initializable<span class="token punctuation">)</span> resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> resource<span class="token punctuation">;</span>
    LockedResource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> lockedResource <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deferredEncodeManager<span class="token punctuation">.</span><span class="token function">hasResourceToEncode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      lockedResource <span class="token operator">=</span> LockedResource<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> lockedResource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 通知外面已经完成了</span>
    <span class="token function">notifyComplete</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> isLoadedFromAlternateCacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

    stage <span class="token operator">=</span> Stage<span class="token punctuation">.</span>ENCODE<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deferredEncodeManager<span class="token punctuation">.</span><span class="token function">hasResourceToEncode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将资源缓存到磁盘</span>
        deferredEncodeManager<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>diskCacheProvider<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>lockedResource <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        lockedResource<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 完成，释放各种资源</span>
    <span class="token function">onEncodeComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>我们需要着重关注的是<code>notifyComplete()</code>。</p> 
<pre><code class="prism language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifyComplete</span><span class="token punctuation">(</span>
      Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> resource<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isLoadedFromAlternateCacheKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">setNotifiedOrThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通知结果回调</span>
    callback<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> isLoadedFromAlternateCacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里的 callback 只有一个实现类就是 EngineJob，所以直接看 <code>EngineJob#onResourceReady()</code>：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>
      Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> resource<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isLoadedFromAlternateCacheKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> resource<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> dataSource<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>isLoadedFromAlternateCacheKey <span class="token operator">=</span> isLoadedFromAlternateCacheKey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 通知结果回调</span>
    <span class="token function">notifyCallbacksOfResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Synthetic</span>
  <span class="token keyword">void</span> <span class="token function">notifyCallbacksOfResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    ResourceCallbacksAndExecutors copy<span class="token punctuation">;</span>
    Key localKey<span class="token punctuation">;</span>
    EngineResource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> localResource<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      stateVerifier<span class="token punctuation">.</span><span class="token function">throwIfRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果取消，则回收和释放资源</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isCancelled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        resource<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cbs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Received a resource without any callbacks to notify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hasResource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Already have resource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      engineResource <span class="token operator">=</span> engineResourceFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> isCacheable<span class="token punctuation">,</span> key<span class="token punctuation">,</span> resourceListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
      hasResource <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      copy <span class="token operator">=</span> cbs<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">incrementPendingCallbacks</span><span class="token punctuation">(</span>copy<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      localKey <span class="token operator">=</span> key<span class="token punctuation">;</span>
      localResource <span class="token operator">=</span> engineResource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//这里表示 EngineJob 完成了，回调给 Engine</span>
    engineJobListener<span class="token punctuation">.</span><span class="token function">onEngineJobComplete</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> localKey<span class="token punctuation">,</span> localResource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//遍历 copy 后拿到了线程池的执行器（entry.executor）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> ResourceCallbackAndExecutor entry <span class="token operator">:</span> copy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      entry<span class="token punctuation">.</span>executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallResourceReady</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">decrementPendingCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>这里我们关注2个地方：<code>engineJobListener.onEngineJobComplete</code>和<code>entry.executor.execute</code>相关部分。</p> 
<p><code>engineJobListener.onEngineJobComplete</code>，表示 EngineJob 完成了，回调给 Engine，进入 onEngineJobComplete()</p> 
<pre><code class="prism language-java"> <span class="token comment">//Engine</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">onEngineJobComplete</span><span class="token punctuation">(</span>
      EngineJob<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> engineJob<span class="token punctuation">,</span> Key key<span class="token punctuation">,</span> EngineResource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> resource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// A null resource indicates that the load failed, usually due to an exception.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> resource<span class="token punctuation">.</span><span class="token function">isMemoryCacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      activeResources<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    jobs<span class="token punctuation">.</span><span class="token function">removeIfCurrent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 

  <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span>Key key<span class="token punctuation">,</span> EngineResource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> resource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    ResourceWeakReference toPut <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">ResourceWeakReference</span><span class="token punctuation">(</span>
            key<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> resourceReferenceQueue<span class="token punctuation">,</span> isActiveResourceRetentionAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ResourceWeakReference removed <span class="token operator">=</span> activeEngineResources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> toPut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>removed <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      removed<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里主要判断是否配置了内存缓存，有的话就存到缓存中。</p> 
<p><code>entry.executor.execute</code>相关部分：</p> 
<p>这里遍历 copy 后拿到了线程池的执行器（entry.executor），copy 是上面 <code>copy = cbs.copy();</code></p> 
<p>反推代码：</p> 
<pre><code class="prism language-java">    <span class="token comment">// 1. cbs.copy()</span>
    <span class="token comment">/*ResourceCallbacksAndExecutors*/</span>
    ResourceCallbacksAndExecutors <span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResourceCallbacksAndExecutors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>callbacksAndExecutors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. callbacksAndExecutors 集合是哪里添加元素的</span>
    <span class="token comment">/*ResourceCallbacksAndExecutors*/</span>
    <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>ResourceCallback cb<span class="token punctuation">,</span> Executor executor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      callbacksAndExecutors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceCallbackAndExecutor</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// 3. 上面的 add() 方法是哪里调用的</span>
  <span class="token comment">/*EngineJob*/</span>
  <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">final</span> ResourceCallback cb<span class="token punctuation">,</span> Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cbs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 4. 上面的 addCallback() 方法是哪里调用的</span>
  <span class="token comment">/*Engine*/</span>
  <span class="token keyword">private</span> <span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> LoadStatus <span class="token function">waitForExistingOrStartNewJob</span><span class="token punctuation">(</span>
	  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      Executor callbackExecutor<span class="token punctuation">,</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    engineJob<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>发现是从 <code>waitForExistingOrStartNewJob()</code> 方法那里传进来的，最后发现是从 into() 方法哪里传过来的。</p> 
<pre><code class="prism language-java">  <span class="token comment">/*RequestBuilder*/</span>
  <span class="token annotation punctuation">@NonNull</span>
  <span class="token keyword">public</span> <span class="token operator">&lt;</span>Y <span class="token keyword">extends</span> <span class="token class-name">Target</span><span class="token generics function"><span class="token punctuation">&lt;</span>TranscodeType<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> Y <span class="token function">into</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Y target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">into</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token comment">/*targetListener=*/</span> null<span class="token punctuation">,</span> Executors<span class="token punctuation">.</span><span class="token function">mainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>就是这里的 <code>Executors.mainThreadExecutor()</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Executors</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token function">Executors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Utility class.</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Executor MAIN_THREAD_EXECUTOR <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Runnable command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          Util<span class="token punctuation">.</span><span class="token function">postOnUiThread</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Executor DIRECT_EXECUTOR <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Runnable command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          command<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/** Posts executions to the main thread. */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Executor <span class="token function">mainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> MAIN_THREAD_EXECUTOR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/** Immediately calls {@link Runnable#run()} on the current thread. */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Executor <span class="token function">directExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> DIRECT_EXECUTOR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@VisibleForTesting</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shutdownAndAwaitTermination</span><span class="token punctuation">(</span>ExecutorService pool<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> shutdownSeconds <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    pool<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span>shutdownSeconds<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pool<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span>shutdownSeconds<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to shutdown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      pool<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>这里是创建了一个 Executor 的实例，然后重写了 <code>execute()</code> 方法，但是里面却用的是主线程中的 Handler 来 <code>post()</code> 一个任务，也就是<strong>切换到了主线程</strong>去执行了。</p> 
<p><code>entry.executor.execute(new CallResourceReady(entry.cb))</code>实际执行的是 <code>handler.post(command)</code>，CallResourceReady 中的 run() 方法是在主线程中执行的。</p> 
<p>看一下 <code>CallResourceReady#run()</code>：</p> 
<pre><code class="prism language-java">  <span class="token comment">// EngineJob</span>
  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">CallResourceReady</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> ResourceCallback cb<span class="token punctuation">;</span>

    <span class="token function">CallResourceReady</span><span class="token punctuation">(</span>ResourceCallback cb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>、
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>cb<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>EngineJob<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cbs<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Acquire for this particular callback.</span>
            engineResource<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">callCallbackOnResourceReady</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">removeCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">decrementPendingCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  
  <span class="token keyword">void</span> <span class="token function">callCallbackOnResourceReady</span><span class="token punctuation">(</span>ResourceCallback cb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
	  <span class="token comment">// 资源准备好了，回调给上一层</span>
      cb<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>engineResource<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CallbackException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>回调到 <code>SingleRequest#onResourceReady()</code>:</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>
      Resource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> resource<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isLoadedFromAlternateCacheKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    stateVerifier<span class="token punctuation">.</span><span class="token function">throwIfRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Resource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> toRelease <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>requestLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        loadStatus <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          GlideException exception <span class="token operator">=</span>
              <span class="token keyword">new</span> <span class="token class-name">GlideException</span><span class="token punctuation">(</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">onLoadFailed</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Object received <span class="token operator">=</span> resource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>received <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>transcodeClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>received<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          toRelease <span class="token operator">=</span> resource<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> null<span class="token punctuation">;</span>
          GlideException exception <span class="token operator">=</span>
              <span class="token keyword">new</span> <span class="token class-name">GlideException</span><span class="token punctuation">(</span> <span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">onLoadFailed</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canSetResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          toRelease <span class="token operator">=</span> resource<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> null<span class="token punctuation">;</span>
          <span class="token comment">// We can't put the status to complete before asking canSetResource().</span>
          status <span class="token operator">=</span> Status<span class="token punctuation">.</span>COMPLETE<span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		 <span class="token comment">//重载方法</span>
        <span class="token function">onResourceReady</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> resource<span class="token punctuation">,</span> <span class="token punctuation">(</span>R<span class="token punctuation">)</span> received<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> isLoadedFromAlternateCacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>toRelease <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        engine<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>toRelease<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>前面是一些加载失败的判断，看下最后的 <code>onResourceReady()</code>：</p> 
<pre><code class="prism language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>
      Resource<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> resource<span class="token punctuation">,</span> R result<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isAlternateCacheKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// We must call isFirstReadyResource before setting status.</span>
    <span class="token keyword">boolean</span> isFirstResource <span class="token operator">=</span> <span class="token function">isFirstReadyResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> Status<span class="token punctuation">.</span>COMPLETE<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> resource<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>glideContext<span class="token punctuation">.</span><span class="token function">getLogLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span> GLIDE_TAG<span class="token punctuation">,</span>  "<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>“<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    isCallingCallbacks <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">boolean</span> anyListenerHandledUpdatingTarget <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>requestListeners <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>RequestListener<span class="token generics function"><span class="token punctuation">&lt;</span>R<span class="token punctuation">&gt;</span></span> listener <span class="token operator">:</span> requestListeners<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          anyListenerHandledUpdatingTarget <span class="token operator">|=</span>
              listener<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> model<span class="token punctuation">,</span> target<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> isFirstResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      anyListenerHandledUpdatingTarget <span class="token operator">|=</span>
          targetListener <span class="token operator">!=</span> null
              <span class="token operator">&amp;&amp;</span> targetListener<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> model<span class="token punctuation">,</span> target<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> isFirstResource<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>anyListenerHandledUpdatingTarget<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Transition<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> R<span class="token operator">&gt;</span> animation <span class="token operator">=</span> animationFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> isFirstResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 回调给 ImageViewTarget</span>
        target<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> animation<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
      isCallingCallbacks <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	 <span class="token comment">// 通知加载成功</span>
    <span class="token function">notifyLoadSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里的 target 为 ImageViewTarget。</p> 
<p><code>ImageViewTarget#onResourceReady()</code>的代码如下：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Z resource<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Transition<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> Z<span class="token operator">&gt;</span> transition<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transition <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>transition<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">setResourceInternal</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">maybeUpdateAnimatable</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setResourceInternal</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Z resource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Order matters here. Set the resource first to make sure that the Drawable has a valid and</span>
    <span class="token comment">// non-null Callback before starting it.</span>
    <span class="token function">setResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">maybeUpdateAnimatable</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> 
<p>在前面 <code>GlideContext#buildImageViewTarget()</code>中创建的 ImageViewTarget 的实现类是 DrawableImageViewTarget，所以这里调用的是 <code>DrawableImageViewTarget#setResource()</code>，代码如下：</p> 
<pre><code>  @Override
  protected void setResource(@Nullable Drawable resource) {
    view.setImageDrawable(resource);
  }
</code></pre> 
<p>到这里终于将图片显示到我们的 ImageView 中了。</p> 
<p>into() 方法也结束了。</p> 
<h5><a id="33__3171"></a>3.3 总结</h5> 
<p>into() 方法很复杂。主要做了发起网络请求、缓存数据、解码并显示图片。</p> 
<p>大概流程为： 发起网络请求前先判断是否有内存缓存，有则直接从内存缓存那里获取数据进行显示，没有则判断是否有磁盘缓存；有磁盘缓存则直接从磁盘缓存那里获取数据进行显示，没有才发起网络请求；网络请求成功后将返回的数据存储到内存与磁盘缓存（如果有配置），最后将返回的输入流解码成 Drawable 显示在 ImageView 上。</p> 
<h3><a id="_3177"></a>参考资料</h3> 
<ol><li> <p><a href="https://juejin.cn/post/6844904152636604424#heading-11" rel="nofollow">Android 主流开源框架（六）Glide 的执行流程源码解析</a></p> </li><li> <p><a href="https://juejin.cn/post/6844904049595121672#heading-13" rel="nofollow">Android主流三方库源码分析（三、深入理解Glide源码）</a></p> </li></ol> 
<hr> 
<p><strong>我的<a href="https://github.com/zhangzhian/LearningNotes">学习笔记</a>，欢迎star和fork</strong></p> 
<p><strong>欢迎关注我的公众号，持续分析优质技术文章</strong><br> <img src="https://images2.imgbox.com/33/da/d4rU57Lf_o.jpg" alt="欢迎关注我的公众号"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f7a4c181a35bd7cf5ccfaebe7ae0edf4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux下网卡绑定 bond</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ef2bdddff4c82ffad3597ecfeeedf152/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于Java序列化的10个面试问题,总结的比较到位。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>