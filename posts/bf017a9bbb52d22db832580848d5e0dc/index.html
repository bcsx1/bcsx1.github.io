<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于合宙Air700E的4G环境监测节点（温湿度、气压等数据），通过MQTT上传阿里云物联网平台 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于合宙Air700E的4G环境监测节点（温湿度、气压等数据），通过MQTT上传阿里云物联网平台" />
<meta property="og:description" content="基于合宙Air700E的4G环境监测节点（温度、湿度、气压等数据），通过MQTT上传阿里云物联网平台。
介绍 合宙Air700E 4G模块读取传感器（温湿度、气压等）数据并通过MQTT协议上传阿里云物联网平台，数据也会同时显示在0.96寸的OLED屏幕上，使用了U8g2图形库。
ESP32C3 WiFi模块通过MQTT协议订阅4G节点上传的数据并显示在LCD屏上，使用了LVGL图形库。
这是我的一个课程设计，随便做做的，不是很完善。
题目要求：设计并制作无线通信系统，结合上学期所学知识，将本地采集的温、湿度/超声波测量距离通过无线收发的方式，发送到主机/接收端，并在接收端利用 LCD显示相关信息，具体要求如下：
⑴ 蓝牙无线传输系统设计实现
⑵ WiFi 无线传输系统设计及实现
⑶ ZigBee 无线传输系统设计及实现
⑷ GPRS/GSM 无线传输系统设计及实现
(5) 4G 无线传输系统设计及实现
(6) NBIoT/LoRa 无线传输系统设计及实现
提示：可用 8/16/32 处理器作为主控制器，按照本小组选定的综合部分内容来进行选型，至少完成 2 个小项，其中（1）（2）（3）选 1 个完成，（4）（5）（6）选 1 个完成。
Air700E和ESP32C3我都是使用LuatOS系统&#43;Lua脚本的开发方式来开发的。
LuatOS固件是我使用合宙的云编译生成的。
ESP32C3上自带的4MByte的flash被我换成了8MByte的了，固件也是大于4MB的，因为加了LVGL图形库以及几种字体。
阿里云学生优惠地址：https://www.aliyun.com/daily-act/ecs/activity_share?userCode=jdjc69nf
注意： 由于阿里云物联网平台不同设备间不能订阅对方的主题，只能订阅本设备的主题，所以需要在 消息转发→云产品流转 那里添加一条规则，将4G节点设备的发布的消息转发到WiFi节点设备的一个主题。
立创开源平台开源链接：https://oshwhub.com/zeruns/wen-shi-du-cai-ji-4g-shang-chuan
合宙Air700E介绍 Air700E 是合宙通信推出的 LTE Cat.1 bis通信模块，采用移芯EC618平台，支持 LTE 3GPP Rel.13 技术。该模块仅保留 LTE TDD 频段，适配中国移动运营主流频段，具有超小封装和极致成本，满足小型化和低成本需求。
主要特性包括：
支持单1.8/3.3V USIM接口支持1.8/3.3V可配置串口支持USB 2.0支持远程OTA固件升级支持PSM数字语音接口支持多种开发方式，如USB上网、标准AT开发， open CPU二次开发（LuatOS,C-SDK）等 Air700E 内置丰富的网络协议，集成多个工业标准接口，并支持多种驱动和软件功能（如Windows 7/8/8.1/10，Linux，Android等操作系统下的 USB 驱动等），极大地拓展了其在 M2M 领域的应用范围，如CPE、路由器、数据卡、平板电脑、车载、安防以及工业级 PDA 等。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/bf017a9bbb52d22db832580848d5e0dc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-26T15:02:29+08:00" />
<meta property="article:modified_time" content="2023-12-26T15:02:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于合宙Air700E的4G环境监测节点（温湿度、气压等数据），通过MQTT上传阿里云物联网平台</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>基于合宙Air700E的4G环境监测节点（温度、湿度、气压等数据），通过MQTT上传阿里云<a href="https://blog.zeruns.tech/tag/%E7%89%A9%E8%81%94%E7%BD%91%E5%B9%B3%E5%8F%B0/" rel="nofollow">物联网平台</a>。</p> 
<h3><a id="_2"></a>介绍</h3> 
<p><a href="https://blog.zeruns.tech/tag/%E5%90%88%E5%AE%99/" rel="nofollow">合宙</a>Air700E 4G模块读取传感器（<a href="https://blog.zeruns.tech/tag/%E6%B8%A9%E6%B9%BF%E5%BA%A6/" rel="nofollow">温湿度</a>、<a href="https://blog.zeruns.tech/tag/%E6%B0%94%E5%8E%8B/" rel="nofollow">气压</a>等）数据并通过<a href="https://blog.zeruns.tech/tag/MQTT/" rel="nofollow">MQTT</a>协议上传<a href="https://blog.zeruns.tech/tag/%E9%98%BF%E9%87%8C%E4%BA%91/" rel="nofollow">阿里云</a>物联网平台，数据也会同时显示在0.96寸的<a href="https://blog.zeruns.tech/tag/OLED/" rel="nofollow">OLED</a>屏幕上，使用了<a href="https://blog.zeruns.tech/tag/U8g2/" rel="nofollow">U8g2</a>图形库。</p> 
<p>ESP32C3 <a href="https://blog.zeruns.tech/tag/WIFI/" rel="nofollow">WiFi</a>模块通过MQTT协议订阅4G节点上传的数据并显示在<a href="https://blog.zeruns.tech/tag/LCD/" rel="nofollow">LCD</a>屏上，使用了<a href="https://blog.zeruns.tech/tag/LVGL/" rel="nofollow">LVGL</a>图形库。</p> 
<p>这是我的一个<a href="https://blog.zeruns.tech/tag/%E8%AF%BE%E7%A8%8B%E8%AE%BE%E8%AE%A1/" rel="nofollow">课程设计</a>，随便做做的，不是很完善。</p> 
<blockquote> 
 <p><strong>题目要求</strong>：设计并制作无线通信系统，结合上学期所学知识，将本地采集的温、湿度/超声波测量距离通过无线收发的方式，发送到主机/接收端，并在接收端利用 LCD显示相关信息，具体要求如下：</p> 
 <p>⑴ 蓝牙无线传输系统设计实现</p> 
 <p>⑵ WiFi 无线传输系统设计及实现</p> 
 <p>⑶ ZigBee 无线传输系统设计及实现</p> 
 <p>⑷ GPRS/GSM 无线传输系统设计及实现</p> 
 <p>(5) 4G 无线传输系统设计及实现</p> 
 <p>(6) NBIoT/LoRa 无线传输系统设计及实现</p> 
 <p><strong>提示</strong>：可用 8/16/32 处理器作为主控制器，按照本小组选定的综合部分内容来进行选型，至少完成 2 个小项，其中（1）（2）（3）选 1 个完成，（4）（5）（6）选 1 个完成。</p> 
</blockquote> 
<p>Air700E和ESP32C3我都是使用LuatOS系统+Lua脚本的开发方式来开发的。</p> 
<p>LuatOS固件是我使用合宙的云编译生成的。</p> 
<p>ESP32C3上自带的4MByte的flash被我换成了8MByte的了，固件也是大于4MB的，因为加了LVGL图形库以及几种字体。</p> 
<p><strong>阿里云学生优惠地址：</strong><a href="https://www.aliyun.com/daily-act/ecs/activity_share?userCode=jdjc69nf" rel="nofollow">https://www.aliyun.com/daily-act/ecs/activity_share?userCode=jdjc69nf</a></p> 
<p><strong>注意：</strong> 由于阿里云物联网平台不同设备间不能订阅对方的主题，只能订阅本设备的主题，所以需要在 <strong>消息转发→云产品流转</strong> 那里添加一条规则，将4G节点设备的发布的消息转发到WiFi节点设备的一个主题。</p> 
<p>立创开源平台开源链接：<a href="https://oshwhub.com/zeruns/wen-shi-du-cai-ji-4g-shang-chuan" rel="nofollow">https://oshwhub.com/zeruns/wen-shi-du-cai-ji-4g-shang-chuan</a></p> 
<h3><a id="Air700E_38"></a>合宙Air700E介绍</h3> 
<p>Air700E 是合宙通信推出的 LTE Cat.1 bis通信模块，采用移芯EC618平台，支持 LTE 3GPP Rel.13 技术。该模块仅保留 LTE TDD 频段，适配中国移动运营主流频段，具有超小封装和极致成本，满足小型化和低成本需求。</p> 
<p><strong>主要特性包括：</strong></p> 
<ul><li>支持单1.8/3.3V USIM接口</li><li>支持1.8/3.3V可配置串口</li><li>支持USB 2.0</li><li>支持远程OTA固件升级</li><li>支持PSM数字语音接口</li><li>支持多种开发方式，如USB上网、标准AT开发， open CPU二次开发（LuatOS,C-SDK）等</li></ul> 
<p>Air700E 内置丰富的网络协议，集成多个工业标准接口，并支持多种驱动和软件功能（如Windows 7/8/8.1/10，Linux，Android等操作系统下的 USB 驱动等），极大地拓展了其在 M2M 领域的应用范围，如CPE、路由器、数据卡、平板电脑、车载、安防以及工业级 PDA 等。</p> 
<p><strong>Air700E的技术规格如下：</strong></p> 
<p><strong>LTE-TDD频段：</strong> B34/B38/B39/B40/B41</p> 
<p><strong>LTE-TDD数据速率：</strong></p> 
<ul><li>上下行配比2时，最大8Mbps（DL）/最大2Mbps（UL）</li><li>上下行配比1时，最大6Mbps（DL）/最大4Mbps（UL）</li></ul> 
<p><strong>接口：</strong></p> 
<ul><li>1个USB 2.0高速接口（最高达480Mbps）</li><li>1个1.8V/3.0V (U)SIM卡接口</li><li>1个NETLIGHT接口 (NET_STATUS)</li><li>1路数字I2S接口，支持外置codec</li><li>3个UART接口（主串口，通用串口，调试串口）</li><li>PWRKEY（低电平有效）</li><li>2路ADC接口</li><li>13个通用GPIO + 2路中断输入</li><li>1路I2C接口</li></ul> 
<h3><a id="ESP32C3_74"></a>合宙ESP32-C3介绍</h3> 
<p>CORE ESP32核心板是基于乐鑫ESP32-C3进行设计的一款核心板，尺寸仅有21mm*51mm，板边采用邮票孔设计，方便开发者在不同场景下的使用。核心板支持UART、GPIO、SPI、I2C、ADC、PWM等接口，可根据实际需要选择。</p> 
<p><strong>硬件资源：</strong></p> 
<ul><li>尺寸长宽 21mm*51mm</li><li>1路SPI FLASH，板载4MB，支持最高 16MB</li><li>2路UART接口，UART0~UART1,其中下载口为UART0</li><li>5 路 12 比特 ADC，最高采样率 100KSPS</li><li>1路低速SPI接口，支持主模式</li><li>1路IIC控制器</li><li>4路PWM接口,可使用任意GPIO</li><li>GPIO外部管脚15路，可复用</li><li>2路贴片LED指示灯</li><li>1路复位按键+1路BOOT按键</li><li>1路USB转TTL下载调试口</li><li>2.4G PCB板载天线</li></ul> 
<h3><a id="_93"></a>实物图</h3> 
<p><strong>演示视频：</strong> <a href="https://www.bilibili.com/video/BV1MH4y1B7Df/" rel="nofollow">https://www.bilibili.com/video/BV1MH4y1B7Df/</a></p> 
<h4><a id="_97"></a>整体图</h4> 
<p><img src="https://images2.imgbox.com/3e/48/MBmt0Drq_o.jpg" alt=""></p> 
<h4><a id="4G_101"></a>4G节点</h4> 
<p><img src="https://images2.imgbox.com/31/80/zmIDeGXs_o.jpg" alt=""></p> 
<h4><a id="WiFi_105"></a>WiFi节点</h4> 
<p>WiFi连接时：</p> 
<p><img src="https://images2.imgbox.com/b4/1c/aaEkDS4A_o.jpg" alt=""></p> 
<p>连接上WiFi后开始连接MQTT服务器和NTP时间同步：</p> 
<p><img src="https://images2.imgbox.com/36/65/xTOl3KYf_o.jpg" alt=""></p> 
<p>显示4G节点采集到的数据：</p> 
<p><img src="https://images2.imgbox.com/d4/47/hZOF6q5K_o.jpg" alt=""></p> 
<p>显示温湿度变化曲线：</p> 
<p><img src="https://images2.imgbox.com/75/c7/rGCQG4pp_o.jpg" alt=""></p> 
<h4><a id="_123"></a>物联网平台</h4> 
<p>阿里云物联网平台上显示的数据：</p> 
<p><img src="https://images2.imgbox.com/13/b7/1loawsIH_o.png" alt=""></p> 
<h3><a id="_129"></a>原理图</h3> 
<h4><a id="4G_131"></a>4G节点</h4> 
<p><img src="https://images2.imgbox.com/d0/2f/E53TeFR4_o.png" alt=""></p> 
<h4><a id="WiFi_135"></a>WiFi节点</h4> 
<p><img src="https://images2.imgbox.com/d7/37/TVvR7ySl_o.png" alt=""></p> 
<h3><a id="PCB_139"></a>PCB</h3> 
<h4><a id="4G_141"></a>4G节点</h4> 
<p>这个4G模块的封装不太对的。</p> 
<p><strong>顶层：</strong></p> 
<p><img src="https://images2.imgbox.com/08/0c/nqPcMfOK_o.png" alt=""></p> 
<p><strong>底层：</strong></p> 
<p><img src="https://images2.imgbox.com/af/06/x2qAnX4A_o.png" alt=""></p> 
<h4><a id="WiFi_153"></a>WiFi节点</h4> 
<p><strong>顶层：</strong></p> 
<p><img src="https://images2.imgbox.com/6e/02/gQyPttW0_o.png" alt=""></p> 
<p><strong>底层：</strong></p> 
<p><img src="https://images2.imgbox.com/6d/27/Mp5GHKd8_o.png" alt=""></p> 
<h3><a id="_163"></a>代码</h3> 
<p>具体怎么下载代码我就不细说了，自行查看官方文档。</p> 
<p>Air700E文档：<a href="https://url.zeruns.tech/jy0t6" rel="nofollow">https://doc.openluat.com/wiki/44?wiki_page_id=4730</a></p> 
<p>LVGL for LuatOS 手册：<a href="https://url.zeruns.tech/7z7fN" rel="nofollow">https://url.zeruns.tech/7z7fN</a></p> 
<p>ESP32-C3文档：<a href="https://wiki.luatos.com/chips/esp32c3/index.html" rel="nofollow">https://url.zeruns.tech/497AP</a></p> 
<p>Lua教程：<a href="https://url.zeruns.tech/Pc4PA" rel="nofollow">https://url.zeruns.tech/Pc4PA</a></p> 
<h4><a id="4G_175"></a>4G节点</h4> 
<p>固件下载地址：<a href="https://pan.baidu.com/s/1eB1tIKPPJZ-bPNY5of4gFQ?pwd=rn6t" rel="nofollow">https://url.zeruns.tech/2G3K7</a></p> 
<p><strong>main.lua文件：</strong></p> 
<pre><code class="prism language-lua"><span class="token comment">-- LuaTools需要PROJECT和VERSION这两个信息</span>
PROJECT <span class="token operator">=</span> <span class="token string">"环境监测节点"</span>
VERSION <span class="token operator">=</span> <span class="token string">"1.1.0"</span>

<span class="token comment">-- 引入必要的库文件(lua编写), 内部库不需要require</span>
sys <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sys"</span><span class="token punctuation">)</span>
aht10 <span class="token operator">=</span> require <span class="token string">"aht10"</span>
bmx <span class="token operator">=</span> require <span class="token string">"bmx"</span>

<span class="token comment">--添加硬狗防止程序卡死</span>
<span class="token keyword">if</span> wdt <span class="token keyword">then</span>
    wdt<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token comment">--初始化watchdog设置为9s</span>
    sys<span class="token punctuation">.</span><span class="token function">timerLoopStart</span><span class="token punctuation">(</span>wdt<span class="token punctuation">.</span>feed<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token comment">--3s喂一次狗</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span>_VERSION<span class="token punctuation">)</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>mobile<span class="token punctuation">.</span><span class="token function">ipv6</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">--开启ipv6</span>

<span class="token keyword">local</span> ProductKey<span class="token operator">=</span> <span class="token string">"xxxxxx"</span>                         <span class="token comment">--产品key</span>
<span class="token keyword">local</span> DeviceName<span class="token operator">=</span> <span class="token string">"xxxxxx"</span>                <span class="token comment">--改为你自己的设备名</span>
<span class="token keyword">local</span> DeviceSecret <span class="token operator">=</span> <span class="token string">"xxxxxx"</span> <span class="token comment">--改为你自己的设备密钥</span>
<span class="token keyword">local</span> client_id<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> password <span class="token operator">=</span> iotauth<span class="token punctuation">.</span><span class="token function">aliyun</span><span class="token punctuation">(</span>ProductKey<span class="token punctuation">,</span> DeviceName <span class="token punctuation">,</span>DeviceSecret<span class="token punctuation">)</span> <span class="token comment">--生成MQTT三元组</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"MQTT参数"</span><span class="token punctuation">,</span> client_id<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> password<span class="token punctuation">)</span>

<span class="token keyword">local</span> softI2C <span class="token operator">=</span> i2c<span class="token punctuation">.</span><span class="token function">createSoft</span><span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment">--初始化软件I2C</span>
<span class="token keyword">local</span> aht10_data<span class="token punctuation">,</span>bmx_data
<span class="token keyword">local</span> RH<span class="token punctuation">,</span>Temp<span class="token punctuation">,</span>Press<span class="token punctuation">,</span>High<span class="token punctuation">,</span>distance<span class="token punctuation">,</span>BAT_Voltage<span class="token punctuation">,</span>CPU_T <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>                 <span class="token comment">--平均值,湿度、温度、气压、海拔、距离、电池电压、CPU温度</span>
<span class="token keyword">local</span> RH_C<span class="token punctuation">,</span>Temp_C<span class="token punctuation">,</span>Press_C<span class="token punctuation">,</span>High_C<span class="token punctuation">,</span>distance_C<span class="token punctuation">,</span>BAT_Voltage_C<span class="token punctuation">,</span>CPU_T_C <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>   <span class="token comment">--当前值</span>
<span class="token keyword">local</span> AHT10_flag<span class="token punctuation">,</span>BMP180_flag<span class="token punctuation">,</span>US100_flag<span class="token punctuation">,</span>BAT_Voltage_flag<span class="token punctuation">,</span>CPU_T_flag <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span><span class="token keyword">false</span><span class="token punctuation">,</span><span class="token keyword">false</span><span class="token punctuation">,</span><span class="token keyword">false</span><span class="token punctuation">,</span><span class="token keyword">false</span>
all_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>CurrentVoltage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>CurrentTemperature <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> CurrentHumidity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>Atmosphere <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Altitude <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>DetectDistance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>CPUTemperature <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">US_100</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">--US-100超声波测距模块读取数据</span>
    uart<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">char</span><span class="token punctuation">(</span><span class="token number">0x55</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">--发送16进制0x55</span>
    sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>    <span class="token comment">--延时50毫秒</span>
    <span class="token keyword">local</span> hData<span class="token punctuation">,</span>lData  <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">byte</span><span class="token punctuation">(</span>uart<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>   <span class="token comment">--串口接收2字节</span>
    uart<span class="token punctuation">.</span><span class="token function">rxClear</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">--清空接收缓存</span>
    <span class="token keyword">if</span> hData <span class="token keyword">and</span> lData <span class="token keyword">then</span> <span class="token comment">--判断是否接收到数据</span>
        <span class="token keyword">local</span> Distance_mm <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span><span class="token punctuation">(</span>hData <span class="token operator">*</span> <span class="token number">256</span> <span class="token punctuation">)</span> <span class="token operator">+</span> lData<span class="token punctuation">)</span>    <span class="token comment">--将高8位左移8位后和低8位数据相加</span>
        <span class="token keyword">if</span> Distance_mm <span class="token operator">&gt;</span> <span class="token number">4500</span> <span class="token keyword">then</span>  <span class="token comment">--判断是否超出测量范围</span>
            Distance_mm <span class="token operator">=</span> <span class="token number">4500</span>
        <span class="token keyword">end</span>
        <span class="token comment">--log.info("超声波："..Distance_mm.."mm")     --日志输出距离</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>Distance_mm <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span>                  <span class="token comment">--算出cm并返回</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token comment">-- https://blog.zeruns.tech</span>
sys<span class="token punctuation">.</span><span class="token function">taskInit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 创建一个线程，读取各个传感器数据</span>

    sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>       <span class="token comment">-- 延时500毫秒</span>
    aht10<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>softI2C<span class="token punctuation">)</span> <span class="token comment">-- 初始化AHT10,传入i2c_id</span>
    bmx<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>softI2C<span class="token punctuation">)</span>   <span class="token comment">-- 初始化BMP180,传入i2c_id</span>
    uart<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9600</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> uart<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>    <span class="token comment">--初始化串口1</span>
    adc<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment">-- 打开adc通道0,并读取</span>
    adc<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>adc<span class="token punctuation">.</span>CH_CPU<span class="token punctuation">)</span><span class="token comment">-- 打开ADC通道-CPU内部温度通道</span>
    <span class="token comment">--adc.setRange(adc.ADC_RANGE_3_8) -- 开启ADC0,1分压电阻，范围0~3.8V</span>
    sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>       <span class="token comment">-- 延时500毫秒</span>

    <span class="token keyword">local</span> RH_sum<span class="token punctuation">,</span> Temp_sum<span class="token punctuation">,</span> Press_sum<span class="token punctuation">,</span> High_sum<span class="token punctuation">,</span> distance_sum<span class="token punctuation">,</span>BAT_Voltage_sum<span class="token punctuation">,</span>CPU_T_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token comment">--总和，求平均值用</span>
    <span class="token keyword">local</span> avg_count<span class="token punctuation">,</span> avg_count2<span class="token punctuation">,</span>avg_count3<span class="token punctuation">,</span>avg_count4<span class="token punctuation">,</span>avg_count5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>

    <span class="token keyword">while</span> <span class="token number">1</span> <span class="token keyword">do</span>
        aht10_data <span class="token operator">=</span> aht10<span class="token punctuation">.</span><span class="token function">get_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">--读取AHT10的数据</span>
        bmx_data <span class="token operator">=</span> bmx<span class="token punctuation">.</span><span class="token function">get_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">--读取BMP10的数据</span>
        distance_C <span class="token operator">=</span> <span class="token function">US_100</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment">--读取US-100的数据</span>
        <span class="token comment">-- 电池电压采样，分压电阻比例：4.7K/10K</span>
        BAT_Voltage_C <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>adc<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">1007</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1473</span><span class="token punctuation">)</span> <span class="token comment">-- 读取AD0电压值，计算电池电压</span>
        CPU_T_C <span class="token operator">=</span> adc<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>adc<span class="token punctuation">.</span>CH_CPU<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span>                <span class="token comment">-- 读取CPU温度</span>

        <span class="token comment">-- AHT10温湿度平均值计算</span>
        <span class="token keyword">if</span> aht10_data<span class="token punctuation">.</span>RH <span class="token keyword">and</span> aht10_data<span class="token punctuation">.</span>T <span class="token keyword">then</span>  <span class="token comment">--判断AHT10是否读取到数据</span>
            all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CurrentTemperature <span class="token operator">=</span> aht10_data<span class="token punctuation">.</span>T
            all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CurrentHumidity <span class="token operator">=</span> aht10_data<span class="token punctuation">.</span>RH<span class="token operator">*</span><span class="token number">100</span>
            <span class="token keyword">if</span> avg_count <span class="token operator">&lt;</span> <span class="token number">6</span> <span class="token keyword">then</span>       <span class="token comment">--判断是否小于3，累加计平均值</span>
                RH_C<span class="token punctuation">,</span>Temp_C <span class="token operator">=</span> aht10_data<span class="token punctuation">.</span>RH<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span> aht10_data<span class="token punctuation">.</span>T   <span class="token comment">--读取温度和湿度的当前值</span>
                RH_sum <span class="token operator">=</span> RH_C <span class="token operator">+</span> RH_sum
                Temp_sum <span class="token operator">=</span> Temp_C <span class="token operator">+</span> Temp_sum
                avg_count <span class="token operator">=</span> avg_count <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">elseif</span> avg_count <span class="token operator">==</span> <span class="token number">6</span> <span class="token keyword">then</span>
                RH <span class="token operator">=</span> RH_sum <span class="token operator">/</span> <span class="token number">6</span>         <span class="token comment">-- 算出湿度平均值</span>
                Temp <span class="token operator">=</span> Temp_sum <span class="token operator">/</span> <span class="token number">6</span>     <span class="token comment">-- 算出温度平均值</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"AHT10_data.RH: "</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> RH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">" %"</span><span class="token punctuation">,</span><span class="token string">" AHT10_data.T: "</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> Temp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">" ℃"</span><span class="token punctuation">)</span>    <span class="token comment">--日志输出</span>
                AHT10_flag <span class="token operator">=</span> <span class="token keyword">true</span>       <span class="token comment">-- 标志位置位，数据采集完毕</span>
                sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"MQTT_P"</span><span class="token punctuation">)</span>   <span class="token comment">-- 发布消息，数据采集计算完毕，MQTT可以上报了</span>
                avg_count<span class="token punctuation">,</span>RH_sum<span class="token punctuation">,</span>Temp_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>   <span class="token comment">--计数值和总和清零</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        <span class="token comment">--BMP180气压和高度平均值计算</span>
        <span class="token keyword">if</span> bmx_data<span class="token punctuation">.</span>press <span class="token keyword">and</span> bmx_data<span class="token punctuation">.</span>high <span class="token keyword">then</span>
            all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>Atmosphere <span class="token operator">=</span> bmx_data<span class="token punctuation">.</span>press
            all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>Altitude <span class="token operator">=</span> bmx_data<span class="token punctuation">.</span>high
            <span class="token keyword">if</span> avg_count2 <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token keyword">then</span>       <span class="token comment">--判断是否小于10，累加计平均值</span>
                Press_C<span class="token punctuation">,</span>High_C <span class="token operator">=</span> bmx_data<span class="token punctuation">.</span>press<span class="token punctuation">,</span> bmx_data<span class="token punctuation">.</span>high  <span class="token comment">--读取气压和高度的当前值</span>
                Press_sum <span class="token operator">=</span> Press_C <span class="token operator">+</span> Press_sum
                High_sum <span class="token operator">=</span> High_C <span class="token operator">+</span> High_sum
                avg_count2 <span class="token operator">=</span> avg_count2 <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">elseif</span> avg_count2 <span class="token operator">==</span> <span class="token number">10</span> <span class="token keyword">then</span>
                Press <span class="token operator">=</span> Press_sum <span class="token operator">/</span> <span class="token number">10</span>
                High <span class="token operator">=</span> High_sum <span class="token operator">/</span> <span class="token number">10</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"BMP180_data.press: "</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> Press<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">" hPa"</span><span class="token punctuation">,</span><span class="token string">" BMP180_data.high: "</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> High<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">" m"</span><span class="token punctuation">)</span>
                BMP180_flag <span class="token operator">=</span> <span class="token keyword">true</span>
                sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"MQTT_P"</span><span class="token punctuation">)</span>
                avg_count2<span class="token punctuation">,</span>Press_sum<span class="token punctuation">,</span>High_sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        <span class="token comment">-- US-100超声波测距 距离平均值计算</span>
        <span class="token keyword">if</span> distance_C <span class="token keyword">then</span>    <span class="token comment">--判断是否读取到数据</span>
            all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>DetectDistance <span class="token operator">=</span> distance_C
            <span class="token keyword">if</span> avg_count3 <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token keyword">then</span>
                distance_sum <span class="token operator">=</span> distance_C <span class="token operator">+</span> distance_sum
                avg_count3 <span class="token operator">=</span> avg_count3 <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">elseif</span> avg_count3 <span class="token operator">==</span> <span class="token number">3</span> <span class="token keyword">then</span>
                distance <span class="token operator">=</span> distance_sum <span class="token operator">/</span> <span class="token number">3</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"US-100: "</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.1f"</span><span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">" cm"</span><span class="token punctuation">)</span>
                US100_flag <span class="token operator">=</span> <span class="token keyword">true</span>
                sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"MQTT_P"</span><span class="token punctuation">)</span>
                avg_count3<span class="token punctuation">,</span>distance_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        <span class="token comment">-- 电池电压</span>
        <span class="token keyword">if</span> BAT_Voltage_C <span class="token keyword">then</span>    <span class="token comment">--判断是否读取到数据</span>
            all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CurrentVoltage <span class="token operator">=</span> BAT_Voltage_C
            <span class="token keyword">if</span> avg_count4 <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token keyword">then</span>
                BAT_Voltage_sum <span class="token operator">=</span> BAT_Voltage_C <span class="token operator">+</span> BAT_Voltage_sum
                avg_count4 <span class="token operator">=</span> avg_count4 <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">elseif</span> avg_count4 <span class="token operator">==</span> <span class="token number">20</span> <span class="token keyword">then</span>
                BAT_Voltage <span class="token operator">=</span> BAT_Voltage_sum <span class="token operator">/</span> <span class="token number">20</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"BAT_Voltage: "</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> BAT_Voltage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">" V"</span><span class="token punctuation">)</span>
                BAT_Voltage_flag <span class="token operator">=</span> <span class="token keyword">true</span>
                sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"MQTT_P"</span><span class="token punctuation">)</span>
                avg_count4<span class="token punctuation">,</span>BAT_Voltage_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        <span class="token comment">-- CPU温度</span>
        <span class="token keyword">if</span> CPU_T_C <span class="token keyword">then</span>    <span class="token comment">--判断是否读取到数据</span>
            all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CPUTemperature <span class="token operator">=</span> CPU_T_C
            <span class="token keyword">if</span> avg_count5 <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token keyword">then</span>
                CPU_T_sum <span class="token operator">=</span> CPU_T_C <span class="token operator">+</span> CPU_T_sum
                avg_count5 <span class="token operator">=</span> avg_count4 <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">elseif</span> avg_count5 <span class="token operator">==</span> <span class="token number">20</span> <span class="token keyword">then</span>
                CPU_T <span class="token operator">=</span> CPU_T_sum <span class="token operator">/</span> <span class="token number">20</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"CPU_T: "</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> CPU_T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">" ℃"</span><span class="token punctuation">)</span>
                CPU_T_flag <span class="token operator">=</span> <span class="token keyword">true</span>
                sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"MQTT_P"</span><span class="token punctuation">)</span>
                avg_count5<span class="token punctuation">,</span>CPU_T_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token comment">--[[sys.taskInit(function() --创建一个任务，超声波测距，1.5秒一次
    uart.setup(1, 9600, 8, 1, uart.NONE)    --初始化串口1
    sys.wait(1000)
    while 1 do
        distance = US_100() --读取US-100的数据
        if distance then    --判断是否读取到数据
            log.info("US-100: "..(string.format("%.1f", distance)).." cm")
            US100_flag = true
            sys.publish("MQTT_P")
        end
        sys.wait(1500)
    end
end)]]</span>

sys<span class="token punctuation">.</span><span class="token function">taskInit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">--创建一个线程，MQTT初始化和数据上报</span>
    mqttc <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"a1sJbDQiEqr.iot-as-mqtt.cn-shanghai.aliyuncs.com"</span><span class="token punctuation">,</span> <span class="token number">1883</span><span class="token punctuation">,</span><span class="token keyword">true</span><span class="token punctuation">,</span><span class="token keyword">true</span><span class="token punctuation">)</span>
    mqttc<span class="token punctuation">:</span><span class="token function">auth</span><span class="token punctuation">(</span>client_id<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
    mqttc<span class="token punctuation">:</span><span class="token function">keepalive</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span> <span class="token comment">-- 默认值240s</span>
    mqttc<span class="token punctuation">:</span><span class="token function">autoreconn</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">-- 自动重连机制</span>
    mqttc<span class="token punctuation">:</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>mqtt_client<span class="token punctuation">,</span> event<span class="token punctuation">,</span> data<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
        <span class="token keyword">if</span> event <span class="token operator">==</span> <span class="token string">"conack"</span> <span class="token keyword">then</span>
            sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"mqtt_conack"</span><span class="token punctuation">)</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mqtt"</span><span class="token punctuation">,</span> <span class="token string">"mqtt已连接"</span><span class="token punctuation">)</span>
            mqtt_client<span class="token punctuation">:</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"/sys/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span>DeviceName<span class="token operator">..</span><span class="token string">"/thing/service/property/set"</span><span class="token punctuation">)</span>
        <span class="token keyword">elseif</span> event <span class="token operator">==</span> <span class="token string">"recv"</span> <span class="token keyword">then</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mqtt"</span><span class="token punctuation">,</span> <span class="token string">"收到消息"</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
            <span class="token keyword">local</span> mqtt_date <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        <span class="token keyword">elseif</span> event <span class="token operator">==</span> <span class="token string">"sent"</span> <span class="token keyword">then</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mqtt"</span><span class="token punctuation">,</span> <span class="token string">"sent"</span><span class="token punctuation">,</span> <span class="token string">"pkgid"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>
    mqttc<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
        sys<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token string">"MQTT_P"</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> AHT10_flag <span class="token keyword">then</span>
            <span class="token keyword">local</span> json_str <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>CurrentTemperature <span class="token operator">=</span> Temp<span class="token punctuation">,</span> CurrentHumidity <span class="token operator">=</span> RH<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"2f"</span><span class="token punctuation">)</span> <span class="token comment">-- 数据改成JSON格式，保留2位小数</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/sys/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span> DeviceName<span class="token operator">..</span><span class="token string">"/thing/event/property/post"</span><span class="token punctuation">,</span> json_str<span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span> DeviceName<span class="token operator">..</span><span class="token string">"/user/update"</span><span class="token punctuation">,</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span><span class="token string">"2f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            AHT10_flag <span class="token operator">=</span> <span class="token keyword">false</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> BMP180_flag <span class="token keyword">then</span>
            <span class="token keyword">local</span> json_str <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>Atmosphere <span class="token operator">=</span> Press<span class="token punctuation">,</span> Altitude <span class="token operator">=</span> High<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"2f"</span><span class="token punctuation">)</span> <span class="token comment">-- 数据改成JSON格式，保留2位小数</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/sys/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span>DeviceName<span class="token operator">..</span><span class="token string">"/thing/event/property/post"</span><span class="token punctuation">,</span> json_str<span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span> DeviceName<span class="token operator">..</span><span class="token string">"/user/update"</span><span class="token punctuation">,</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span><span class="token string">"2f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            BMP180_flag <span class="token operator">=</span> <span class="token keyword">false</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> US100_flag <span class="token keyword">then</span>
            <span class="token keyword">local</span> json_str <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>DetectDistance <span class="token operator">=</span> distance<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"1f"</span><span class="token punctuation">)</span> <span class="token comment">-- 数据改成JSON格式，保留2位小数</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/sys/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span>DeviceName<span class="token operator">..</span><span class="token string">"/thing/event/property/post"</span><span class="token punctuation">,</span> json_str<span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span> DeviceName<span class="token operator">..</span><span class="token string">"/user/update"</span><span class="token punctuation">,</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span><span class="token string">"2f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            US100_flag <span class="token operator">=</span> <span class="token keyword">false</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> BAT_Voltage_flag <span class="token keyword">then</span>
            <span class="token keyword">local</span> json_str <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>CurrentVoltage <span class="token operator">=</span> BAT_Voltage<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"2f"</span><span class="token punctuation">)</span> <span class="token comment">-- 数据改成JSON格式，保留2位小数</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/sys/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span>DeviceName<span class="token operator">..</span><span class="token string">"/thing/event/property/post"</span><span class="token punctuation">,</span> json_str<span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span> DeviceName<span class="token operator">..</span><span class="token string">"/user/update"</span><span class="token punctuation">,</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span><span class="token string">"2f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            BAT_Voltage_flag <span class="token operator">=</span> <span class="token keyword">false</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> CPU_T_flag <span class="token keyword">then</span>
            <span class="token keyword">local</span> json_str <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>CPUTemperature <span class="token operator">=</span> CPU_T<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"2f"</span><span class="token punctuation">)</span> <span class="token comment">-- 数据改成JSON格式</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/sys/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span>DeviceName<span class="token operator">..</span><span class="token string">"/thing/event/property/post"</span><span class="token punctuation">,</span> json_str<span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span> DeviceName<span class="token operator">..</span><span class="token string">"/user/update"</span><span class="token punctuation">,</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>all_data<span class="token punctuation">,</span><span class="token string">"2f"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            CPU_T_flag <span class="token operator">=</span> <span class="token keyword">false</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>


<span class="token comment">-- https://blog.zeruns.tech</span>
sys<span class="token punctuation">.</span><span class="token function">taskInit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    u8g2<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>ic <span class="token operator">=</span> <span class="token string">"ssd1306"</span><span class="token punctuation">,</span>direction <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>mode<span class="token operator">=</span><span class="token string">"i2c_hw"</span><span class="token punctuation">,</span>i2c_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>i2c_speed <span class="token operator">=</span> i2c<span class="token punctuation">.</span>FAST<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">-- direction 可选0 90 180 270</span>
    u8g2<span class="token punctuation">.</span><span class="token function">ClearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">--清屏</span>
    u8g2<span class="token punctuation">.</span><span class="token function">SetFont</span><span class="token punctuation">(</span>u8g2<span class="token punctuation">.</span>font_opposansm10<span class="token punctuation">)</span>  <span class="token comment">--切换字体</span>
    u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span><span class="token string">"IMEI:"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span>mobile<span class="token punctuation">.</span><span class="token function">imei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
    u8g2<span class="token punctuation">.</span><span class="token function">SendBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">--ntp同步时间</span>
    <span class="token comment">--socket.sntp()</span>
    socket<span class="token punctuation">.</span><span class="token function">sntp</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"ntp.aliyun.com"</span><span class="token punctuation">,</span><span class="token string">"ntp1.aliyun.com"</span><span class="token punctuation">,</span><span class="token string">"ntp2.aliyun.com"</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">--sntp自定义服务器地址</span>
    <span class="token comment">--socket.sntp(nil, socket.ETH0) --sntp自定义适配器序号</span>
    sys<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"NTP_UPDATE"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"sntp"</span><span class="token punctuation">,</span> <span class="token string">"time"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"NTP_OK"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"NTP_ERROR"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">,</span> <span class="token string">"sntp error"</span><span class="token punctuation">)</span>
        socket<span class="token punctuation">.</span><span class="token function">sntp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>

    sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>

    sys<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token string">"NTP_OK"</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
    u8g2<span class="token punctuation">.</span><span class="token function">ClearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">--清屏</span>
    u8g2<span class="token punctuation">.</span><span class="token function">SetFont</span><span class="token punctuation">(</span>u8g2<span class="token punctuation">.</span>font_opposansm10<span class="token punctuation">)</span>  <span class="token comment">--切换字体</span>
    u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">--显示时间</span>
    u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"%H:%M:%S"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token comment">--显示时间</span>
    <span class="token keyword">local</span> IP <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">localIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">--显示IP地址</span>
    <span class="token keyword">if</span> IP <span class="token keyword">then</span>
        u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span><span class="token string">"IP:"</span><span class="token operator">..</span>IP<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    u8g2<span class="token punctuation">.</span><span class="token function">SendBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">2500</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
        u8g2<span class="token punctuation">.</span><span class="token function">ClearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">--清屏</span>
        u8g2<span class="token punctuation">.</span><span class="token function">SetFont</span><span class="token punctuation">(</span>u8g2<span class="token punctuation">.</span>font_sarasa_m10_ascii<span class="token punctuation">)</span>
        <span class="token keyword">if</span> Temp_C <span class="token keyword">then</span>
            u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span><span class="token string">"T:"</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> Temp_C<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"°C"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> RH_C <span class="token keyword">then</span>
            u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span><span class="token string">"RH:"</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> RH_C<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"%"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> Press_C <span class="token keyword">then</span>
            u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span><span class="token string">"P:"</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> Press_C<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"hPa"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> distance_C <span class="token keyword">then</span>
            u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span><span class="token string">"D:"</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.1f"</span><span class="token punctuation">,</span> distance_C<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"cm"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> High_C <span class="token keyword">then</span>
            u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span><span class="token string">"H:"</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> High_C<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"m"</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> BAT_Voltage_C <span class="token keyword">then</span>
            u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span><span class="token string">"B:"</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> BAT_Voltage_C<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> CPU_T_C <span class="token keyword">then</span>
            u8g2<span class="token punctuation">.</span><span class="token function">DrawUTF8</span><span class="token punctuation">(</span><span class="token string">"CPUT:"</span><span class="token operator">..</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> CPU_T_C<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"°C"</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        u8g2<span class="token punctuation">.</span><span class="token function">SendBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">--显示数据更新到屏幕</span>
        sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

sys<span class="token punctuation">.</span><span class="token function">taskInit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">--创建一个线程，500毫秒闪一次LED</span>
    gpio<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">-- 设置gpio27为输出,且初始化电平为低,使用硬件默认上下拉配置</span>
    <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
        gpio<span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token number">27</span><span class="token punctuation">)</span> <span class="token comment">--gpio翻转电平</span>
        sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

<span class="token comment">--[[
    支持字体
    ["unifont_t_symbols","open_iconic_weather_6x_t","opposansm8","opposansm10","opposansm12","opposansm16","opposansm20",
    "opposansm24","opposansm32","sarasa_m8_ascii","sarasa_m10_ascii","sarasa_m12_ascii","sarasa_m14_ascii",
    "sarasa_m16_ascii","sarasa_m18_ascii","sarasa_m20_ascii","sarasa_m22_ascii"]
]]</span>
<span class="token comment">-- 用户代码已结束---------------------------------------------</span>
<span class="token comment">-- 结尾总是这一句</span>
sys<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- sys.run()之后后面不要加任何语句!!!!!</span>
</code></pre> 
<h4><a id="WiFi_491"></a>WiFi节点</h4> 
<p>固件下载地址：<a href="https://url.zeruns.tech/a7eXJ" rel="nofollow">https://url.zeruns.tech/a7eXJ</a></p> 
<p><strong>main.lua文件：</strong></p> 
<pre><code class="prism language-lua"><span class="token comment">-- LuaTools需要PROJECT和VERSION这两个信息</span>
PROJECT <span class="token operator">=</span> <span class="token string">"数据显示节点"</span>
VERSION <span class="token operator">=</span> <span class="token string">"1.0.5"</span>

<span class="token comment">-- sys库是标配</span>
_G<span class="token punctuation">.</span>sys <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sys"</span><span class="token punctuation">)</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sysplus"</span><span class="token punctuation">)</span>

<span class="token comment">--添加硬狗防止程序卡死</span>
wdt<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token comment">--初始化watchdog设置为6s</span>
wdt_timer_id <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">timerLoopStart</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    wdt<span class="token punctuation">.</span><span class="token function">feed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">end</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>  <span class="token comment">--2s喂一次狗</span>

<span class="token keyword">local</span> ProductKey<span class="token operator">=</span> <span class="token string">"xxxxxx"</span>                         <span class="token comment">--产品key</span>
<span class="token keyword">local</span> DeviceName<span class="token operator">=</span> <span class="token string">"xxxxxx"</span>                <span class="token comment">--改为你自己的设备名</span>
<span class="token keyword">local</span> DeviceSecret <span class="token operator">=</span> <span class="token string">"xxxxxx"</span> <span class="token comment">--改为你自己的设备密钥</span>
<span class="token keyword">local</span> client_id<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> password <span class="token operator">=</span> iotauth<span class="token punctuation">.</span><span class="token function">aliyun</span><span class="token punctuation">(</span>ProductKey<span class="token punctuation">,</span> DeviceName <span class="token punctuation">,</span>DeviceSecret<span class="token punctuation">)</span> <span class="token comment">--生成MQTT三元组</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"MQTT参数"</span><span class="token punctuation">,</span> client_id<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> password<span class="token punctuation">)</span>

<span class="token keyword">local</span> local_CPU_T_C <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">local</span> all_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>CurrentVoltage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>CurrentTemperature <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> CurrentHumidity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
Atmosphere <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Altitude <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>DetectDistance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>CPUTemperature <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">local</span> key1_flag<span class="token punctuation">,</span>key2_flag <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span><span class="token keyword">false</span>

sys<span class="token punctuation">.</span><span class="token function">taskInit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 创建一个线程</span>
    
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"wlan"</span><span class="token punctuation">,</span> <span class="token string">"wlan_init:"</span><span class="token punctuation">,</span> wlan<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 初始化wlan</span>
    wlan<span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span>wlan<span class="token punctuation">.</span>STATION<span class="token punctuation">)</span>                  <span class="token comment">-- 设置wlan模式为STATION</span>
    wlan<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"Mate 40 Pro"</span><span class="token punctuation">,</span> <span class="token string">"123456789"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>     <span class="token comment">-- 连接wlan网络</span>
    <span class="token keyword">local</span> result<span class="token punctuation">,</span> data <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token string">"IP_READY"</span><span class="token punctuation">,</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token comment">-- 等待IP_READY事件</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"wlan"</span><span class="token punctuation">,</span> <span class="token string">"IP_READY"</span><span class="token punctuation">,</span> result<span class="token punctuation">,</span> data<span class="token punctuation">)</span>  <span class="token comment">-- 打印IP_READY事件的结果和数据</span>
    <span class="token keyword">if</span> result <span class="token keyword">then</span>         
        socket<span class="token punctuation">.</span><span class="token function">setDNS</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>STA<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"114.114.114.114"</span><span class="token punctuation">)</span>     
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"wlan"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">,</span> json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>wlan<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">-- 打印wlan网络的详细信息</span>
        sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"WiFi_connected_OK"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>   <span class="token comment">-- 发布消息，WiFi连接成功</span>
        <span class="token comment">--ntp同步时间</span>
        <span class="token comment">--socket.sntp()</span>
        socket<span class="token punctuation">.</span><span class="token function">sntp</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"ntp.aliyun.com"</span><span class="token punctuation">,</span><span class="token string">"time.windows.com"</span><span class="token punctuation">,</span><span class="token string">"ntp.tencent.com"</span><span class="token punctuation">,</span><span class="token string">"ntp2.aliyun.com"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>STA<span class="token punctuation">)</span> <span class="token comment">--sntp自定义服务器地址</span>
        <span class="token comment">--socket.sntp(nil, socket.STA) --sntp自定义适配器序号</span>
        <span class="token comment">-- 订阅NTP_UPDATE事件</span>
        sys<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"NTP_UPDATE"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"NTP_OK"</span><span class="token punctuation">)</span>   <span class="token comment">-- 发布消息，NTP同步时间成功</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"sntp"</span><span class="token punctuation">,</span> <span class="token string">"time"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 打印系统时间</span>
        <span class="token keyword">end</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"NTP_ERROR"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">,</span> <span class="token string">"sntp error"</span><span class="token punctuation">)</span>
            socket<span class="token punctuation">.</span><span class="token function">sntp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
            sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    adc<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>adc<span class="token punctuation">.</span>CH_CPU<span class="token punctuation">)</span><span class="token comment">-- 打开ADC通道-CPU内部温度通道</span>
    <span class="token keyword">local</span> CH_CPU <span class="token operator">=</span> adc<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>adc<span class="token punctuation">.</span>CH_CPU<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span>    <span class="token comment">-- 读取CPU温度</span>
    <span class="token keyword">if</span> CH_CPU <span class="token keyword">then</span>  <span class="token comment">-- 判断数据是否有效</span>
        local_CPU_T_C <span class="token operator">=</span> CH_CPU
    <span class="token keyword">end</span>

    mqttc <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">"a1sJbDQiEqr.iot-as-mqtt.cn-shanghai.aliyuncs.com"</span><span class="token punctuation">,</span> <span class="token number">1883</span><span class="token punctuation">,</span><span class="token keyword">true</span><span class="token punctuation">)</span>    <span class="token comment">-- 创建MQTT客户端</span>
    mqttc<span class="token punctuation">:</span><span class="token function">auth</span><span class="token punctuation">(</span>client_id<span class="token punctuation">,</span> user_name<span class="token punctuation">,</span> password<span class="token punctuation">)</span>  <span class="token comment">-- 进行MQTT身份验证</span>
    mqttc<span class="token punctuation">:</span><span class="token function">keepalive</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>                        <span class="token comment">-- 设置MQTT保活时间，默认值为60秒</span>
    mqttc<span class="token punctuation">:</span><span class="token function">autoreconn</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>                <span class="token comment">-- 开启自动重连机制</span>
    mqttc<span class="token punctuation">:</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>mqtt_client<span class="token punctuation">,</span> event<span class="token punctuation">,</span> data<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token comment">-- 定义MQTT事件回调函数</span>
        <span class="token keyword">if</span> event <span class="token operator">==</span> <span class="token string">"conack"</span> <span class="token keyword">then</span>               <span class="token comment">-- 当收到连接确认事件（conack）时</span>
            sys<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"mqtt_conack"</span><span class="token punctuation">)</span>          <span class="token comment">-- 发布一个mqtt_conack消息</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mqtt"</span><span class="token punctuation">,</span> <span class="token string">"mqtt已连接"</span><span class="token punctuation">)</span>       <span class="token comment">-- 打印连接成功信息</span>
            mqtt_client<span class="token punctuation">:</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"/sys/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span>DeviceName<span class="token operator">..</span><span class="token string">"/thing/service/property/set"</span><span class="token punctuation">)</span>  <span class="token comment">-- 订阅指定主题</span>
            mqtt_client<span class="token punctuation">:</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span>DeviceName<span class="token operator">..</span><span class="token string">"/user/get"</span><span class="token punctuation">)</span>
        <span class="token keyword">elseif</span> event <span class="token operator">==</span> <span class="token string">"recv"</span> <span class="token keyword">then</span>             <span class="token comment">-- 当收到消息事件（recv）时</span>
            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">"/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span>DeviceName<span class="token operator">..</span><span class="token string">"/user/get"</span> <span class="token keyword">then</span>   <span class="token comment">-- 判断接收主题</span>
                all_data <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>             <span class="token comment">-- 解析消息内容为JSON格式</span>
                mqttc<span class="token punctuation">:</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"/sys/"</span><span class="token operator">..</span>ProductKey<span class="token operator">..</span><span class="token string">"/"</span><span class="token operator">..</span>DeviceName<span class="token operator">..</span><span class="token string">"/thing/event/property/post"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>  <span class="token comment">-- MQTT上报属性</span>
            <span class="token keyword">else</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mqtt"</span><span class="token punctuation">,</span> <span class="token string">"收到消息"</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> payload<span class="token punctuation">)</span> <span class="token comment">-- 打印接收消息信息</span>
                <span class="token keyword">local</span> mqtt_date <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span>      <span class="token comment">-- 解析消息内容为JSON格式</span>
            <span class="token keyword">end</span>
        <span class="token keyword">elseif</span> event <span class="token operator">==</span> <span class="token string">"sent"</span> <span class="token keyword">then</span>             <span class="token comment">-- 当发送消息事件（sent）时</span>
            <span class="token comment">--log.info("mqtt", "sent", "pkgid", data)-- 打印发送消息信息</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>
    mqttc<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> CH_CPU <span class="token operator">=</span> adc<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>adc<span class="token punctuation">.</span>CH_CPU<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span>    <span class="token comment">-- 读取CPU温度</span>
        <span class="token keyword">if</span> CH_CPU <span class="token keyword">then</span>  <span class="token comment">-- 判断数据是否有效</span>
            CPU_T_C <span class="token operator">=</span> CH_CPU
        <span class="token keyword">end</span>

        gpio<span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment">--gpio翻转电平</span>
        sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

sys<span class="token punctuation">.</span><span class="token function">taskInit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 创建一个线程 </span>
    spi<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">80</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> spi<span class="token punctuation">.</span>MSB<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment">-- 初始化SPI</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"lcd.init"</span><span class="token punctuation">,</span> lcd<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">"st7789"</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
        port <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>           <span class="token comment">-- spi端口</span>
        <span class="token comment">-- pin_cs = 7,         -- SPI片选</span>
        pin_dc <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>         <span class="token comment">-- lcd数据/命令选择引脚</span>
        <span class="token comment">-- pin_pwr = 18,       -- lcd背光引脚 可选项,可不设置</span>
        pin_rst <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span>        <span class="token comment">-- lcd复位引脚</span>
        direction <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>      <span class="token comment">-- lcd屏幕方向 0:0° 1:180° 2:270° 3:90°</span>
        w <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">,</span>            <span class="token comment">-- lcd 水平分辨率</span>
        h <span class="token operator">=</span> <span class="token number">172</span><span class="token punctuation">,</span>            <span class="token comment">-- lcd 垂直分辨率</span>
        xoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">-- x偏移(不同屏幕ic 不同屏幕方向会有差异)</span>
        yoffset <span class="token operator">=</span> <span class="token number">34</span><span class="token punctuation">;</span>       <span class="token comment">-- y偏移(不同屏幕ic 不同屏幕方向会有差异)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"lvgl"</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">--- 初始化LVGL</span>

    <span class="token keyword">local</span> style_screen_label_main <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">style_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment">-- 创建一个名为 style_screen_label_main 的样式对象</span>
    lvgl<span class="token punctuation">.</span><span class="token function">style_set_text_font</span><span class="token punctuation">(</span>style_screen_label_main<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>STATE_DEFAULT<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span><span class="token function">font_get</span><span class="token punctuation">(</span><span class="token string">"opposans_m_16"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 设置标签的默认字体</span>

    <span class="token keyword">local</span> Init_scr <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">obj_create</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span> <span class="token comment">-- 创建一个屏幕对象</span>
    lvgl<span class="token punctuation">.</span><span class="token function">scr_load</span><span class="token punctuation">(</span>Init_scr<span class="token punctuation">)</span>  <span class="token comment">-- 加载屏幕对象，显示在显示器上 </span>
    <span class="token keyword">local</span> spinner <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">spinner_create</span><span class="token punctuation">(</span>Init_scr<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span> <span class="token comment">-- 创建一个旋转图标对象</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_set_size</span><span class="token punctuation">(</span>spinner<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">-- 设置旋转图标对象的大小</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_align</span><span class="token punctuation">(</span>spinner<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>ALIGN_CENTER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token comment">-- 将旋转图标对象居中对齐</span>
    <span class="token keyword">local</span> label_WiFiConnecting <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">label_create</span><span class="token punctuation">(</span>Init_scr<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span> <span class="token comment">-- 创建一个标签对象</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_recolor</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token comment">-- 开启标签的重新上色功能，即当文本内容发生变化时自动更新颜色</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_add_style</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>LABEL_PART_MAIN<span class="token punctuation">,</span> style_screen_label_main<span class="token punctuation">)</span> <span class="token comment">-- 将样式对象分配给标签对象的main部分</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> <span class="token string">"WiFi连接中..."</span><span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_align</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>LABEL_ALIGN_CENTER<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本对齐方式为居中对齐</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_align</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>ALIGN_CENTER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">)</span> <span class="token comment">-- 将标签对象居中对齐</span>
    <span class="token keyword">local</span> result<span class="token punctuation">,</span> ip_data <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token string">"WiFi_connected_OK"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>    <span class="token comment">-- 等待WiFi连接成功的消息，超时5秒</span>
    <span class="token keyword">if</span> result <span class="token operator">==</span> <span class="token keyword">false</span> <span class="token keyword">then</span>
        lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> <span class="token string">"#ff0000 WiFi连接失败!#\n请重启设备,或检查网络"</span><span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容（显示WiFi连接失败）</span>
        lvgl<span class="token punctuation">.</span><span class="token function">label_set_align</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>LABEL_ALIGN_CENTER<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本对齐方式为居中对齐</span>
        lvgl<span class="token punctuation">.</span><span class="token function">obj_align</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>ALIGN_CENTER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">)</span> <span class="token comment">-- 将标签对象居中对齐</span>
        <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
            sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">-- 循环等待，防止程序继续执行</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> <span class="token string">"WiFi连接成功!"</span><span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容（显示WiFi连接成功）</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_align</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>LABEL_ALIGN_CENTER<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本对齐方式为居中对齐</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_align</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>ALIGN_CENTER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">)</span> <span class="token comment">-- 将标签对象居中对齐</span>
    sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token comment">-- 等待500毫秒</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_del</span><span class="token punctuation">(</span>label_WiFiConnecting<span class="token punctuation">)</span> <span class="token comment">-- 删除标签对象</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_align</span><span class="token punctuation">(</span>spinner<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>ALIGN_CENTER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">-- 将旋转图标对象居中对齐</span>
    <span class="token keyword">local</span> label_Init_log <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">label_create</span><span class="token punctuation">(</span>Init_scr<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span> <span class="token comment">-- 创建一个标签对象</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_recolor</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span> <span class="token comment">-- 开启标签的重新上色功能，即当文本内容发生变化时自动更新颜色</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_align</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>LABEL_ALIGN_LEFT<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本对齐方式为左对齐</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_align</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>ALIGN_IN_TOP_LEFT<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">-- 将标签对象对齐到屏幕的左上角</span>
    <span class="token keyword">local</span> Init_log <span class="token operator">=</span> <span class="token string">"#0000ff 初始化日志: #\nWiFi连接成功!\n"</span> <span class="token comment">-- 初始化日志信息</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> Init_log<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>
    Init_log <span class="token operator">=</span> Init_log<span class="token operator">..</span><span class="token string">"IP: "</span><span class="token operator">..</span>ip_data<span class="token operator">..</span><span class="token string">"\n连接MQTT服务器中...\n"</span> <span class="token comment">-- 更新日志信息</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> Init_log<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>
    <span class="token keyword">if</span> sys<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token string">"mqtt_conack"</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">false</span> <span class="token keyword">then</span>
        Init_log <span class="token operator">=</span> Init_log<span class="token operator">..</span><span class="token string">"#ff0000 连接MQTT服务器失败!\n请重启设备!#\n"</span> <span class="token comment">-- 更新日志信息（显示MQTT连接失败）</span>
        lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> Init_log<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>
        mqttc<span class="token punctuation">:</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 断开MQTT连接</span>
        mqttc<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 关闭MQTT连接</span>
        <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
            sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">-- 循环等待，防止程序继续执行</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    Init_log <span class="token operator">=</span> Init_log<span class="token operator">..</span><span class="token string">"连接MQTT服务器成功!\n"</span> <span class="token comment">-- 更新日志信息（显示MQTT连接成功）</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> Init_log<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>
    Init_log <span class="token operator">=</span> Init_log<span class="token operator">..</span><span class="token string">"NTP时间同步中...\n"</span> <span class="token comment">-- 更新日志信息</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> Init_log<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>
    <span class="token keyword">local</span> result <span class="token operator">=</span> sys<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token string">"NTP_OK"</span><span class="token punctuation">,</span> <span class="token number">3500</span><span class="token punctuation">)</span> <span class="token comment">-- 等待NTP时间同步成功的消息，超时3秒</span>
    <span class="token keyword">if</span> result <span class="token keyword">then</span>
        Init_log <span class="token operator">=</span> Init_log<span class="token operator">..</span><span class="token string">"NTP时间同步成功!\n"</span> <span class="token comment">-- 更新日志信息（显示NTP时间同步成功）</span>
        lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> Init_log<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>
    <span class="token keyword">else</span>
        Init_log <span class="token operator">=</span> Init_log<span class="token operator">..</span><span class="token string">"NTP时间同步失败!\n"</span> <span class="token comment">-- 更新日志信息（显示NTP时间同步失败）</span>
        lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> Init_log<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>
    <span class="token keyword">end</span>
    Init_log <span class="token operator">=</span> Init_log<span class="token operator">..</span><span class="token string">"当前时间: "</span><span class="token operator">..</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"\n"</span> <span class="token comment">-- 更新日志信息（显示当前时间）</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> Init_log<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>
    Init_log <span class="token operator">=</span> Init_log<span class="token operator">..</span><span class="token string">"系统初始化完成!\n"</span> <span class="token comment">-- 更新日志信息（显示系统初始化完成）</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_Init_log<span class="token punctuation">,</span> Init_log<span class="token punctuation">)</span> <span class="token comment">-- 设置标签对象的文本内容</span>

    sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> alldata_scr <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">obj_create</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>               <span class="token comment">-- 创建一个屏幕对象用于显示所有数据，没有父对象和样式</span>
    lvgl<span class="token punctuation">.</span><span class="token function">scr_load</span><span class="token punctuation">(</span>alldata_scr<span class="token punctuation">)</span>                                  <span class="token comment">-- 加载屏幕对象，显示在显示器上</span>

    <span class="token keyword">local</span> label_alldata <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">label_create</span><span class="token punctuation">(</span>alldata_scr<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>   <span class="token comment">-- 创建一个 Label 对象，用于显示所有数据</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_recolor</span><span class="token punctuation">(</span>label_alldata<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span>                 <span class="token comment">-- 开启标签的重新上色功能，即当文本内容发生变化时自动更新颜色</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_align</span><span class="token punctuation">(</span>label_alldata<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>LABEL_ALIGN_LEFT<span class="token punctuation">)</span>  <span class="token comment">-- 设置标签的对齐方式为左对齐</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_align</span><span class="token punctuation">(</span>label_alldata<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>ALIGN_IN_TOP_LEFT<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>   <span class="token comment">-- 将标签对齐到屏幕的左上角，距离左边距 10 像素，上边距 5 像素</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_add_style</span><span class="token punctuation">(</span>label_alldata<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>LABEL_PART_MAIN<span class="token punctuation">,</span> style_screen_label_main<span class="token punctuation">)</span><span class="token comment">-- 将样式对象分配给 label_alldata 标签的 main 部分</span>
    
    <span class="token keyword">local</span> label_time <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">label_create</span><span class="token punctuation">(</span>alldata_scr<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>      <span class="token comment">-- 创建一个 Label 对象，用于显示当前时间</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_time<span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"\n"</span><span class="token operator">..</span>os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"%H:%M:%S"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    lvgl<span class="token punctuation">.</span><span class="token function">label_set_align</span><span class="token punctuation">(</span>label_time<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>LABEL_ALIGN_CENTER<span class="token punctuation">)</span>   <span class="token comment">-- 设置标签的对齐方式为居中对齐</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_align</span><span class="token punctuation">(</span>label_time<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>ALIGN_IN_TOP_RIGHT<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">-- 将标签对齐到屏幕的有上角，距离左边距 10 像素，上边距 5 像素</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_add_style</span><span class="token punctuation">(</span>label_time<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>LABEL_PART_MAIN<span class="token punctuation">,</span> style_screen_label_main<span class="token punctuation">)</span>
    
    lvgl<span class="token punctuation">.</span><span class="token function">obj_del</span><span class="token punctuation">(</span>Init_scr<span class="token punctuation">)</span>

    <span class="token keyword">local</span> chart_scr <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">obj_create</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>               <span class="token comment">-- 创建一个屏幕对象用于显示图表，没有父对象和样式</span>

    <span class="token keyword">local</span> chart <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">chart_create</span><span class="token punctuation">(</span>chart_scr<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_set_size</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span> <span class="token number">310</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lvgl<span class="token punctuation">.</span><span class="token function">obj_align</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>ALIGN_CENTER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lvgl<span class="token punctuation">.</span><span class="token function">chart_set_type</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>CHART_TYPE_LINE<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">--Show lines and points too*/</span>
    lvgl<span class="token punctuation">.</span><span class="token function">chart_set_point_count</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
    lvgl<span class="token punctuation">.</span><span class="token function">chart_set_y_range</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span>CHART_AXIS_PRIMARY_Y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

    <span class="token keyword">local</span> ser1 <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">chart_add_series</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span><span class="token function">color_make</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">local</span> ser2 <span class="token operator">=</span> lvgl<span class="token punctuation">.</span><span class="token function">chart_add_series</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span> lvgl<span class="token punctuation">.</span><span class="token function">color_make</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token comment">-- 打印内存占用</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mem.lua"</span><span class="token punctuation">,</span> rtos<span class="token punctuation">.</span><span class="token function">meminfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mem.sys"</span><span class="token punctuation">,</span> rtos<span class="token punctuation">.</span><span class="token function">meminfo</span><span class="token punctuation">(</span><span class="token string">"sys"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
        lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_alldata<span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">[[#0000ff 环境温度: %.2f°C#
        #ff00ff 环境湿度: %.2f%%#
        #ff0000 气压: %.2fhPa#
        #800080 海拔高度: %.2fm#
        #0000ff 超声波测距: %.2fcm#
        #ff00ff 远程节点电池电压: %.2fV#
        #ff0000 远程节点CPU温度: %.0f°C#
        #800080 本地节点CPU温度: %.0f°C#
        ]]</span><span class="token punctuation">,</span>all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CurrentTemperature<span class="token punctuation">,</span>all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CurrentHumidity<span class="token punctuation">,</span>all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>Atmosphere<span class="token punctuation">,</span>
        all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>Altitude<span class="token punctuation">,</span>all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>DetectDistance<span class="token punctuation">,</span>all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CurrentVoltage<span class="token punctuation">,</span>
        all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CPUTemperature<span class="token punctuation">,</span>local_CPU_T_C<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 设置标签文本</span>
        lvgl<span class="token punctuation">.</span><span class="token function">label_set_text</span><span class="token punctuation">(</span>label_time<span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token operator">..</span><span class="token string">"\n"</span><span class="token operator">..</span>os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"%H:%M:%S"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        lvgl<span class="token punctuation">.</span><span class="token function">chart_set_next</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span> ser1<span class="token punctuation">,</span> all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CurrentTemperature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lvgl<span class="token punctuation">.</span><span class="token function">chart_set_next</span><span class="token punctuation">(</span>chart<span class="token punctuation">,</span> ser2<span class="token punctuation">,</span> all_data<span class="token punctuation">.</span>params<span class="token punctuation">.</span>CurrentHumidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lvgl<span class="token punctuation">.</span><span class="token function">chart_refresh</span><span class="token punctuation">(</span>chart<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> key1_flag <span class="token keyword">then</span>
            lvgl<span class="token punctuation">.</span><span class="token function">scr_load</span><span class="token punctuation">(</span>chart_scr<span class="token punctuation">)</span>
            key1_flag <span class="token operator">=</span> <span class="token keyword">false</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> key2_flag <span class="token keyword">then</span>
            lvgl<span class="token punctuation">.</span><span class="token function">scr_load</span><span class="token punctuation">(</span>alldata_scr<span class="token punctuation">)</span>
            key2_flag <span class="token operator">=</span> <span class="token keyword">false</span>
        <span class="token keyword">end</span>
        gpio<span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment">--gpio翻转电平</span>
        sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

sys<span class="token punctuation">.</span><span class="token function">taskInit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">--创建一个线程，500毫秒闪一次LED</span>
    gpio<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">-- 设置gpio13为输出,且初始化电平为低,使用硬件默认上下拉配置</span>
    gpio<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">-- 设置gpio12为输出,且初始化电平为低,使用硬件默认上下拉配置</span>
    <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
        gpio<span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token comment">--gpio翻转电平</span>
        sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>

sys<span class="token punctuation">.</span><span class="token function">taskInit</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">--创建一个线程，按键扫描</span>
    gpio<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> gpio<span class="token punctuation">.</span>PULLUP<span class="token punctuation">)</span>
    gpio<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> gpio<span class="token punctuation">.</span>PULLUP<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> gpio<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
            sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> gpio<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
                key1_flag <span class="token operator">=</span> <span class="token keyword">true</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        <span class="token keyword">if</span> gpio<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
            sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> gpio<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
                key2_flag <span class="token operator">=</span> <span class="token keyword">true</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        sys<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">)</span>


<span class="token comment">--[[
    支持的字体 ["sarasa_m8_ascii","sarasa_m10_ascii","sarasa_m12_ascii",
    "sarasa_m14_ascii","sarasa_m16_ascii","sarasa_m18_ascii","sarasa_m20_ascii","sarasa_m22_ascii"]
]]</span>

<span class="token comment">-- 用户代码已结束---------------------------------------------</span>
<span class="token comment">-- 结尾总是这一句</span>
sys<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">-- sys.run()之后后面不要加任何语句!!!!!</span>
</code></pre> 
<h3><a id="_782"></a>用到的硬件</h3> 
<p>用到的硬件模块和购买地址：</p> 
<ul><li>4G模块：Air700E，<a href="https://uland.taobao.com/coupon/edetail?e=LUUvClZZaoalhHvvyUNXZfh8CuWt5YH5OVuOuRD5gLJMmdsrkidbOUV9IBA4kmjLCKSz6NMEOpOk6DkEOOy39ANONOd65bn6k%2BQD1WLWk7D58pWrh7e7ViECg58T7b6E7qOXUj4MT3dyBOK%2B8KjzSuzY3MUSAX0G1TP3uC6T%2BzrKa4jyh4U%2Bo5gBVnx58RcK3x24QQZ%2BkKRI%2Bf4%2BtcDu44oLvKgaQ5D83qmGq7GPCXsH2XAjD13xyT%2FhMZgljYbZj4NAR0X%2B9c23Sv8LMk9JOkIQtV1V6tmtIciWFcjrsPzH6emLlAySAVD9ZzTfOOXe%2Bm9PGdJ%2FlaUZUAGa9XIpkqJ7%2BkHL3AEW&amp;traceId=213d811317025749037687621e65ab&amp;union_lens=lensId%3APUB%401702574899%40212be3f7_0d90_18c695f4255_c520%400212cIwjWn6h4JZ67isD7Et6%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3Bscm%3A1007.30148.329090.pub_search-item_ea9ed1dc-121c-4a26-85aa-1c27c9c4e982_" rel="nofollow">https://s.click.taobao.com/gMXE14u</a></li><li>WiFi模块：ESP32-C3，<a href="https://s.click.taobao.com/t?e=m%3D2%26s%3DZlxzb7VA%2BERw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFhiPRfK6WZZbW%2BG7BH3F%2BVP0JlhLk0Jl4QTquP0kWxBLBDnvz6xo38xspWc9%2BCL4bTGF1ceZMhPo8mL8HhJ3EdVrH4ks4QyiY4z4rjZDGVMA7PT7P4MIjv0iDnQnCfxRCKLWMw3EOEsyJN2owMjhufwDudUsQ2T%2BdtwdcXrvJnQ7ZHuYE9Ro5OOZ8DKCp9t3JAIHG%2FUGGufvqH4FkV%2B42f2z1OkmXn0f%2BU%2FuprW1TdmBLeMqtJBmsqBWpXpRELkuYcbEo3ADJdJgcSpj5qSCmbA%3D&amp;union_lens=lensId%3APUB%401702575245%4021334feb_0c8e_18c6964886f_3037%4002FXjqZ71jUAMAWD59wyxDr%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3Bscm%3A1007.30148.329090.pub_search-item_86a564e3-eb01-4328-b966-1f368fd8dd53_" rel="nofollow">https://s.click.taobao.com/VU6E14u</a></li><li>温湿度传感器：AHT10，<a href="https://s.click.taobao.com/t?e=m%3D2%26s%3D771Jk01ERgJw4vFB6t2Z2ueEDrYVVa64g3vZOarmkFi53hKxp7mNFhiPRfK6WZZbARW0aicXof30JlhLk0Jl4QTquP0kWxBLBDnvz6xo38xspWc9%2BCL4bTGF1ceZMhPo8mL8HhJ3EdVrH4ks4QyiY4z4rjZDGVMAhscfsB2%2FyzZJq71CBMBeP%2F1SarTXhIOTsgIpc1WFZiJNubylQlnZt9wh0O3n7rEs7VSraZkgkhwlqDRRVlGxRqvyzFinE2vlF34xAtPUu%2BiG3j8B3S26WYwmLWBgEm80VKxcI130SjETn2JhMaQNtYWLhXkoGmYy4m7hkqalpkwvY%2BXqRXyCksYOae24fhW0&amp;union_lens=lensId%3APUB%401702575301%4021055555_16ff_18c69656404_8e69%40024dxCNyvH1jSaZZpYn2bbD3%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3Bscm%3A1007.30148.329090.pub_search-item_e4951d39-761b-41f5-8840-673a3c0c7f1f_" rel="nofollow">https://s.click.taobao.com/0bmD14u</a></li><li>气压传感器：BMP180，<a href="https://s.click.taobao.com/t?e=m%3D2%26s%3DbnhyRgad73lw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFhiPRfK6WZZbbJVKleC4LJX0JlhLk0Jl4QTquP0kWxBLBDnvz6xo38xspWc9%2BCL4bTGF1ceZMhPo8mL8HhJ3EdVrH4ks4QyiY4z4rjZDGVMAFBcM8wkWlGmBPeR%2FUFCetKLWMw3EOEsyJN2owMjhufwDudUsQ2T%2BduXhptvf7sm0vQrr15PsJfJByQLpIiyxZXY%2Fio3PXH82JxEGSxl4yKUtXkuY7xjNZU%2FuprW1TdmBLeMqtJBmsqAZVo9hr9WaqYgTf7YQgcVJcSpj5qSCmbA%3D&amp;union_lens=lensId%3APUB%401702575360%402106d2ff_0cdf_18c69664982_7aaf%40021C2JTg214QOPnilxsDb2w%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3Bscm%3A1007.30148.329090.pub_search-item_f8a710ac-0037-4ec2-bbff-896f3c1af2c5_" rel="nofollow">https://s.click.taobao.com/lj5E14u</a></li><li>超声波测距模块：US-100（用串口通信模式），<a href="https://s.click.taobao.com/t?e=m%3D2%26s%3DInz6n3%2B%2FZwxw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFhiPRfK6WZZbq%2FcxWpaeRwj0JlhLk0Jl4QTquP0kWxBLBDnvz6xo38xspWc9%2BCL4bTGF1ceZMhPo8mL8HhJ3EdVrH4ks4QyiY4z4rjZDGVMAFBcM8wkWlGmBPeR%2FUFCetKLWMw3EOEsyJN2owMjhufwDudUsQ2T%2Bdg68505k9IiwAZQz22%2FRFMA5pQILDo6IOf16Gn%2BAIx7L96W3Eb16pLNyU%2FAPg17%2FFE%2FuprW1TdmBLeMqtJBmsqB4r3mjD%2F4H9bgUNPZMnoHFcSpj5qSCmbA%3D&amp;skuId=4276770277565&amp;union_lens=lensId%3APUB%401702575435%40213e7f1b_0c9e_18c69676fe9_4d3a%40036cIiBD2TZI9c9YU2Vchohd%40eyJmbG9vcklkIjo2MTQyOSwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfZGV0YWlsX2h0bSIsInNyY0Zsb29ySWQiiOiiI4MDY3NCJ9%3Bscm%3A1007.30148.329090.pub_search-item_972f304d-0e03-4fbf-b740-fd750c7af1d6_" rel="nofollow">https://s.click.taobao.com/K0o5X3u</a></li><li>LCD屏幕：1.47寸的ST7789，分辨率172*320，<a href="https://s.click.taobao.com/t?e=m%3D2%26s%3DgP4fG3vZI%2FNw4vFB6t2Z2ueEDrYVVa64g3vZOarmkFi53hKxp7mNFhiPRfK6WZZbfpmjeIyJHHf0JlhLk0Jl4QTquP0kWxBLBDnvz6xo38xspWc9%2BCL4bTGF1ceZMhPo8mL8HhJ3EdVrH4ks4QyiY4z4rjZDGVMAhscfsB2%2FyzZJq71CBMBeP%2F1SarTXhIOTsgIpc1WFZiJNubylQlnZt8KAViuQdyPNc8ER84P6KktsP7OMD4hiwaj%2Fx4cHJV5ILJ9HqoY3BUsLMohkjCbsqowmLWBgEm80VKxcI130SjETn2JhMaQNtYWLhXkoGmYyruoikO2OymYJLixcAe8pyMYOae24fhW0&amp;union_lens=lensId%3APUB%401702575502%40212c48cb_0c8f_18c69687670_23aa%40024B9sLEl2iRKmna6a9po7FA%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3Bscm%3A1007.30148.329090.pub_search-item_5e0d1922-0ca6-44f9-99a9-821166c9de7d_" rel="nofollow">https://s.click.taobao.com/qalD14u</a></li><li>OLED屏幕：0.96寸的SSD1306，I2C接口，<a href="https://s.click.taobao.com/t?e=m%3D2%26s%3DKH7sw7eX%2F2Bw4vFB6t2Z2ueEDrYVVa64YUrQeSeIhnK53hKxp7mNFhiPRfK6WZZbUnl%2Fg%2F1GNuL0JlhLk0Jl4QTquP0kWxBLBDnvz6xo38xspWc9%2BCL4bTGF1ceZMhPo8mL8HhJ3EdVrH4ks4QyiY4z4rjZDGVMAc7QBxLpsf4TZIsq6%2BWiNSqLWMw3EOEsyJN2owMjhufwDudUsQ2T%2BdqwhF6wjgAjmYU48%2FUVSeeMab%2F%2BCSuws4OiHLQ4Yn8csh%2BdzzS7mHW11b5eySA3UA0%2FuprW1TdmBLeMqtJBmsqChj81ryXyWXeLqYXvNN1cOcSpj5qSCmbA%3D&amp;union_lens=lensId%3APUB%401702575558%40213f6e5c_0cfd_18c69694f33_999c%40021vqRKMT5nzj9ALhoKTH8lx%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3Bscm%3A1007.30148.329090.pub_search-item_b4129703-d754-49d5-b48a-82cdfefb2b5f_" rel="nofollow">https://s.click.taobao.com/otWD14u</a></li><li>电池充放电芯片：IP5306-CK（注意要买CK版本的，普通版本的放电电流太小时会自动关断输出，不适合单片机用），<a href="https://s.click.taobao.com/t?e=m%3D2%26s%3DjX7JisUJSllw4vFB6t2Z2ueEDrYVVa64g3vZOarmkFi53hKxp7mNFhiPRfK6WZZbiJKehPSaPYD0JlhLk0Jl4QTquP0kWxBLBDnvz6xo38xspWc9%2BCL4bTGF1ceZMhPo8mL8HhJ3EdVrH4ks4QyiY4z4rjZDGVMAhscfsB2%2FyzZJq71CBMBeP%2F1SarTXhIOTsgIpc1WFZiJNubylQlnZt4mEKVwjSJcGFXvRQPy5FMG3%2FxXe%2BxQvKcLHPTEEdUKrO5xtKw8OA8bUMx%2BC19Mn3YwmLWBgEm80VKxcI130SjETn2JhMaQNtYWLhXkoGmYy5%2FXtHaC5QvUT2J2P4FlLNcYOae24fhW0&amp;union_lens=lensId%3APUB%401702575629%4021055b80_0c9f_18c696a64f6_4c08%40022k2R4UBS6bcyB2aIphUK2l%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3Bscm%3A1007.30148.329090.pub_search-item_9fa456ea-a73f-470b-94dc-a6e6199bf4a4_" rel="nofollow">https://s.click.taobao.com/eu85X3u</a></li><li>电池：亿纬35V-18650，3500mAh，<a href="https://s.click.taobao.com/t?e=m%3D2%26s%3DS952IFxDAbxw4vFB6t2Z2ueEDrYVVa64g3vZOarmkFi53hKxp7mNFhiPRfK6WZZbhQCvBpU9uKb0JlhLk0Jl4QTquP0kWxBLBDnvz6xo38xspWc9%2BCL4bTGF1ceZMhPo8mL8HhJ3EdVrH4ks4QyiY4z4rjZDGVMA2wPTjyt1VFhJDk80jsGTwv1SarTXhIOT%2FcbizUjsed%2BEr%2BInjt7kJlMJo4xVYoI6QTU2mSOmawi8xTwUuWBJq9spaWqoW5XN2MTzYpfP%2FlmjO9AJYjY8CXJ%2BwEVkOqHFdIW9JNkz7%2FgDXc3BRboPm%2FkFZVUCNgR0oMbC7PHmBq9RLBgaW5udaw%3D%3D&amp;union_lens=lensId%3APUB%401702575711%400b8b8151_148e_18c696ba6d8_29d5%40021a7vszDH3fGcvCMrLJyErd%40eyJmbG9vcklkIjo4MDY3NCwiic3BtQiiI6Il9wb3J0YWxfdjJfcGFnZXNfcHJvbW9fZ29vZHNfaW5kZXhfaHRtIiiwiic3JjRmxvb3JJZCI6IjgwNjc0In0ie%3Bscm%3A1007.30148.329090.pub_search-item_52261151-42b3-4abc-8483-08f2c5c3cc3d_" rel="nofollow">https://s.click.taobao.com/uUc5X3u</a></li></ul> 
<p><strong>元器件购买推荐立创商城，优惠注册链接：<a href="https://activity.szlcsc.com/invite/D03E5B9CEAAE70A4.html" rel="nofollow">https://activity.szlcsc.com/invite/D03E5B9CEAAE70A4.html</a></strong></p> 
<p><strong>板上所有元器件都可以在立创商城买到，在开源链接里的BOM表那点立即到立创商城下单可将用到的元器件一键导入到购物车。</strong></p> 
<h3><a id="_800"></a>物联网平台设置说明</h3> 
<p>首先到阿里云物联网平台新建产品，节点类型选直连设备。</p> 
<p><img src="https://images2.imgbox.com/21/42/0dvxQD2C_o.png" alt=""></p> 
<p>设置功能定义：</p> 
<p><img src="https://images2.imgbox.com/3f/8e/j3f1UFQY_o.png" alt=""></p> 
<p>接着添加两个设备</p> 
<p><img src="https://images2.imgbox.com/d1/0d/PvfXoCpF_o.png" alt=""></p> 
<p>修改好脚本中的产品密钥等参数，然后将固件和脚本下载到Air700E中，看看设备能不能正常上线并上传数据。</p> 
<p><img src="https://images2.imgbox.com/e2/fb/nRrTJrOX_o.png" alt=""></p> 
<p>到 消息转发→云产品流转 那里创建数据源：</p> 
<p><img src="https://images2.imgbox.com/fe/8b/sVHqTQtP_o.png" alt=""></p> 
<p>点击刚创建的数据源右边的查看，然后添加Topic，第一个选择自定义，第二个选择你创建的产品，第三个选择你的4G节点的设备，第四个选择<code>user/update</code></p> 
<p><img src="https://images2.imgbox.com/7e/bb/aIB8SJjG_o.png" alt=""></p> 
<p>创建数据目的地，选择操作选<code>发布到另一个 Topic</code>，产品也是选你上面创建的产品。</p> 
<p><img src="https://images2.imgbox.com/9d/39/B1hY3kCD_o.png" alt=""></p> 
<p>创建解析器，然后点击前往编辑，或者点击右边的查看。</p> 
<p><img src="https://images2.imgbox.com/33/95/aTvfX7ai_o.png" alt=""></p> 
<p>关联数据源选你刚刚创建的数据源：</p> 
<p><img src="https://images2.imgbox.com/56/77/aTlDqEjI_o.png" alt=""></p> 
<p>关联数据目的选你刚刚创建的数据目的地</p> 
<p><img src="https://images2.imgbox.com/d8/b3/4sawki2b_o.png" alt=""></p> 
<p>到解析器脚本这里，将<code>deviceName()</code>改成你WiFi节点的设备名，如下图所示。</p> 
<p><img src="https://images2.imgbox.com/1a/ae/PDAWGPp0_o.png" alt=""></p> 
<p>编辑完后点发布，然后启动即可，接着就会自动把 <code>/ProductKey/DeviceName/user/update</code> 主题的数据转发到 <code>/ProductKey/DeviceName/user/get</code> 主题了。</p> 
<h3><a id="_848"></a>其他开源项目推荐</h3> 
<ul><li>STM32F030C8T6最小系统板和流水灯（原理图和PCB）：<a href="https://blog.zeruns.tech/archives/715.html" rel="nofollow">https://blog.zeruns.tech/archives/715.html</a></li><li>画了个 MSP430F149的最小系统板 开源出来了：<a href="https://blog.zeruns.tech/archives/713.html" rel="nofollow">https://blog.zeruns.tech/archives/713.html</a></li><li>2007年电赛电源题：30到36V可调升压DCDC模块（UC3843）：<a href="https://oshwhub.com/zeruns/36v-sheng-ya-dcdc-mo-kuai-uc3842" rel="nofollow">https://oshwhub.com/zeruns/36v-sheng-ya-dcdc-mo-kuai-uc3842</a></li><li>STC12C5A60S2最小系统板/51单片机温度显示和温度控制风扇：<a href="https://blog.zeruns.tech/archives/721.html" rel="nofollow">https://blog.zeruns.tech/archives/721.html</a></li><li>移植好U8g2图形库的STM32F407标准库工程模板：<a href="https://blog.zeruns.tech/archives/722.html" rel="nofollow">https://blog.zeruns.tech/archives/722.html</a></li><li>沁恒CH32V307VCT6最小系统板开源：<a href="https://blog.zeruns.tech/archives/726.html" rel="nofollow">https://blog.zeruns.tech/archives/726.html</a></li><li>LM25118自动升降压可调DCDC电源模块：<a href="https://blog.zeruns.tech/archives/727.html" rel="nofollow">https://blog.zeruns.tech/archives/727.html</a></li><li>EG1164大功率同步整流升压模块开源，最高效率97%：<a href="https://blog.zeruns.tech/archives/730.html" rel="nofollow">https://blog.zeruns.tech/archives/730.html</a></li></ul> 
<h3><a id="_859"></a>推荐文章</h3> 
<ul><li><strong>高性价比和便宜的VPS/云服务器推荐:</strong> <a href="https://blog.zeruns.tech/archives/383.html" rel="nofollow">https://blog.zeruns.tech/archives/383.html</a></li><li>我的世界服务器搭建教程：<a href="https://blog.zeruns.tech/tag/mc/" rel="nofollow">https://blog.zeruns.tech/tag/mc/</a></li><li>分享一下我家网络机柜，家庭网络设备推荐：<a href="https://blog.zeruns.tech/archives/732.html" rel="nofollow">https://blog.zeruns.tech/archives/732.html</a></li><li>香橙派 Orange Pi 3B（RK3566）开发板 开箱测评：<a href="https://blog.zeruns.tech/archives/729.html" rel="nofollow">https://blog.zeruns.tech/archives/729.html</a></li><li>给自己电脑升级了一下，换了显卡，盈通RTX3070：<a href="https://blog.zeruns.tech/archives/746.html" rel="nofollow">https://blog.zeruns.tech/archives/746.html</a></li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/82447d5a514c057c1b31df1951c2b7ec/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AMEYA360：思瑞浦发布全新并联基准芯片—:TPR43x系列产品</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/780f49745796333217de69f3eb5234b9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux搭建我的世界Mohist1.20.2版服务器教程，MOD和插件服开服教程，MC开服教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>