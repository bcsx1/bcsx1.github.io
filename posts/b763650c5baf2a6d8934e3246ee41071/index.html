<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>用django开发一个报修系统 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="用django开发一个报修系统" />
<meta property="og:description" content="基于django开发了一个报修系统 实现功能环境前期准备创建项目网页开发页面开发api开发添加报修记录重头戏 报修记录的显示回顾 项目地址完结撒花 实现功能 以下功能建立在原生HTML的基础上
1.用户登录
2.用户添加报修记录
3.维修师对报修记录进行修改
4.退出登录
环境 python 3.8
nginx 1.18.0 (Ubuntu)
MySQL 8.0.26-0ubuntu0.20.04.2
django 3.2.6
uwsgi 9.3.0
阿里云服务器 ubuntu20.04
编辑器
Sublime Text
前期准备 1.安装python
这个不多说，记得把pip添加到环境变量
2.安装django
windows命令行内
pip install django 创建项目 1.创建项目文件
cd到自己指定的文件目录下
django-admin startproject 你自己的项目名称 这里我的项目名称叫backend
此时的文件结构
2.创建app
在项目文件目录下，命令行输入
django-admin startapp app名 这里我创建了一个名为api的app
此时的文件结构
3.修改配置文件
这里只是简单的让网站能够运行起来
鉴于作者水平，更复杂的文件配置这里不能详解
修改项目名称文件夹下的settings.py
在INSTALLED_APPS中添加刚才创建的app,多个app的添加同理
INSTALLED_APPS = [ &#39;django.contrib.admin&#39;, &#39;django.contrib.auth&#39;, &#39;django.contrib.contenttypes&#39;, &#39;django.contrib.sessions&#39;, &#39;django.contrib.messages&#39;, &#39;django.contrib.staticfiles&#39;, &#39;api&#39;, ] ALLOWED_HOSTS 修改为
ALLOWED_HOSTS = [&#39;*&#39;] 表示所有的host均可访问" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/b763650c5baf2a6d8934e3246ee41071/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-25T20:10:13+08:00" />
<meta property="article:modified_time" content="2022-07-25T20:10:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">用django开发一个报修系统</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>基于django开发了一个报修系统</h4> 
 <ul><li><a href="#_1" rel="nofollow">实现功能</a></li><li><a href="#_7" rel="nofollow">环境</a></li><li><a href="#_16" rel="nofollow">前期准备</a></li><li><a href="#_24" rel="nofollow">创建项目</a></li><li><a href="#_87" rel="nofollow">网页开发</a></li><li><ul><li><a href="#_90" rel="nofollow">页面开发</a></li><li><a href="#api_151" rel="nofollow">api开发</a></li><li><a href="#_584" rel="nofollow">添加报修记录</a></li><li><a href="#__830" rel="nofollow">重头戏 报修记录的显示</a></li><li><a href="#_1063" rel="nofollow">回顾</a></li></ul> 
  </li><li><a href="#_1284" rel="nofollow">项目地址</a></li><li><a href="#_1295" rel="nofollow">完结撒花</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>实现功能</h2> 
<p>以下功能建立在原生HTML的基础上<br> <strong>1.用户登录</strong><br> <strong>2.用户添加报修记录</strong><br> <strong>3.维修师对报修记录进行修改</strong><br> <strong>4.退出登录</strong></p> 
<h2><a id="_7"></a>环境</h2> 
<p>python 3.8<br> nginx 1.18.0 (Ubuntu)<br> MySQL 8.0.26-0ubuntu0.20.04.2<br> django 3.2.6<br> uwsgi 9.3.0<br> 阿里云服务器 ubuntu20.04<br> <strong>编辑器</strong><br> Sublime Text</p> 
<h2><a id="_16"></a>前期准备</h2> 
<p><strong>1.安装python</strong><br> 这个不多说，记得把pip添加到环境变量<br> <strong>2.安装django</strong><br> windows命令行内</p> 
<pre><code>pip install django
</code></pre> 
<h2><a id="_24"></a>创建项目</h2> 
<p><strong>1.创建项目文件</strong><br> cd到自己指定的文件目录下</p> 
<pre><code>django-admin startproject 你自己的项目名称
</code></pre> 
<p>这里我的项目名称叫backend<br> 此时的文件结构<br> <img src="https://images2.imgbox.com/c4/e8/Fm0s5bgF_o.png" alt="在这里插入图片描述"><br> <strong>2.创建app</strong><br> 在项目文件目录下，命令行输入</p> 
<pre><code>django-admin startapp app名
</code></pre> 
<p>这里我创建了一个名为api的app<br> 此时的文件结构<br> <img src="https://images2.imgbox.com/ec/71/zYwaOGvM_o.png" alt="在这里插入图片描述"><br> <strong>3.修改配置文件</strong><br> 这里只是简单的让网站能够运行起来<br> 鉴于作者水平，更复杂的文件配置这里不能详解<br> 修改项目名称文件夹下的settings.py<br> 在INSTALLED_APPS中添加刚才创建的app,多个app的添加同理</p> 
<pre><code>INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'api',
]
</code></pre> 
<p>ALLOWED_HOSTS 修改为</p> 
<pre><code>ALLOWED_HOSTS = ['*']
</code></pre> 
<p>表示所有的host均可访问<br> 注释掉django.middleware.csrf.CsrfViewMiddleware</p> 
<pre><code>MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    # 'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
</code></pre> 
<p>若不注释会导致后面的form表单提交出现问题<br> 修改时区</p> 
<pre><code>LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'Asia/Shanghai'
</code></pre> 
<p>添加STATIC_ROOT字段,后面部署到云服务器会使用到</p> 
<pre><code>STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR,'static')
</code></pre> 
<p>至此项目的创建已经基本完毕,下面开始开发具体的网页</p> 
<h2><a id="_87"></a>网页开发</h2> 
<p>本次开发使用的django返回前端静态文件的方式<br> 也可以使用vue等实现前后端分离，这里不做深入</p> 
<h3><a id="_90"></a>页面开发</h3> 
<p>在项目文件的views.py内开始将html指向路由<br> 下面的每一个HTML都记得绑定一个url</p> 
<pre><code>def login(request):
	return render(request,'login.html')
</code></pre> 
<p>定义了一个login函数接收HTTP请求<br> return login.html源码<br> 在urls.py中添加路由</p> 
<pre><code>from django.urls import path,include
from . import views
urlpatterns = [
    path('login',views.login),
    ]
</code></pre> 
<p>其他的url同理<br> 然后是静态文件的准备<br> 创建templates文件夹<br> 放在app还是项目文件里面都可以<br> login.html的源码</p> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;link rel="stylesheet"  href="/static/css/public.css"/&gt;
&lt;/head&gt;
&lt;body background="/static/img/bj.jpg" style=" background-repeat:no-repeat;background-size:100% 100%; background-attachment: fixed;" &gt;
    &lt;title&gt;登录&lt;/title&gt;
    &lt;div class="from"&gt;
        &lt;div class="submit"&gt;
            &lt;span class="form_title"&gt;统一登录&lt;/span&gt;
            &lt;div class="form_input"&gt;
                &lt;span&gt;账号：&lt;/span&gt;
                &lt;div&gt;
                &lt;input class="inputs" type="text" id="id_username" name="username"&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="form_input"&gt;
                &lt;span&gt;密码&lt;/span&gt;
                &lt;input class="inputs" type="password" id="id_password"  name="password"&gt;
            &lt;/div&gt;
            &lt;div class="btn_submit"&gt;
                    &lt;button class="btn" onclick="submit()"&gt;提交&lt;/button&gt;&lt;/a&gt;
            &lt;/div&gt;
        &lt;/div&gt;    

&lt;/div&gt;

&lt;/body&gt;
&lt;script type="text/javascript" src="/static/js/jquery-3.3.1.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="/static/js/public.js"&gt;&lt;/script&gt;
&lt;/html&gt;
</code></pre> 
<p>直接复制是无法使用的，还有css和js,img等依赖文件都没有准备<br> 上述任务完成后，命令行cd到项目文件目录输入</p> 
<pre><code>python manage.py runserver
</code></pre> 
<p>访问 http://127.0.0.1:8000/login 就可以看到我们刚刚开发的页面</p> 
<h3><a id="api_151"></a>api开发</h3> 
<p><strong>1.登录功能的实现</strong><br> 要实现登录验证，需要api进行配合<br> 前面已经创建了api这个app，在该文件目录下新建文件urls.py,和views.py<br> views.py完全可以使用其他名字，在urls.py中引入即可<br> 配置/api的路由表</p> 
<pre><code>from django.conf.urls import url
from . import views

urlpatterns = [
	url('login',views.login),
]
</code></pre> 
<p>还需要配置backend目录下的urls.py<br> 这里使用到include</p> 
<pre><code>from django.urls import path,include
from . import views
urlpatterns = [
    path('api/',include('api.urls')),
    path('login',views.login),
    ]
</code></pre> 
<p>include把api/所有的路由都指向了api这个app中的urls.py<br> 所以我们的api的路由就是/api/login<br> 下面开始写函数</p> 
<pre><code>def login(request):
	password = request.POST.get('password')
	username = request.POST.get('username')
</code></pre> 
<p>简单的获取HTTP POST请求中的参数<br> 这里我封装了一个wheel<br> 文件名为utils.py 存放在api文件夹下</p> 
<pre><code>import json
import datetime
import time
from django.http import HttpResponse
import string
import random


class CJsonEncoder(json.JSONEncoder):
	def default(self, obj):
		if isinstance(obj, datetime):
			return obj.strftime('%Y-%m-%d %H:%M:%S')
		elif isinstance(obj, date):
			return obj.strftime('%Y-%m-%d')
		elif isinstance(obj, decimal.Decimal):
			return float(obj)
		else:
			return json.JSONEncoder.default(self, obj)

def packApiData(code=0, message="Lack Parameter", tips="参数缺失", data={}):
	# packApiData 规范化组装接口回调数据

	return HttpResponse(json.dumps(
		
		{
			'code': code,
			'message': message,
			'tips': tips,
			'requestTime': int(time.time()),
			'data': data
		},
		cls=CJsonEncoder),content_type="application/json")
	
def makeRandomStr(length, type=1):
	 # makeRandomStr 获取随机字符串
	if type == 1:
		s = string.digits + string.ascii_lowercase + string.digits
	else:
		s = string.digits + string.ascii_lowercase + string.ascii_uppercase

	return "".join(random.sample(s, length))
</code></pre> 
<p>packApiData可以快速产生json<br> login的完整实现</p> 
<pre><code>from django.shortcuts import render
import json
import pymysql
from django.http import HttpResponse
from . import util
from authlib.jose import jwt
import time
# Create your views here.

def login(request):
	password = request.POST.get('password')
	username = request.POST.get('username')
	if len(password) == 0 or len(username) == 0:
		return util.packApiData(412,'please enter the account password','请输入账号密码',{})
	userid,role,name = userData(username,password)
	
	if userid:
		token = jwt.encode(	{'alg': 'HS256'}, {
			'iss': 'Kudan', 
			'exp': int(time.time()) + 7200 ,
			'userid':userid,
			'name':name,
			'role':role,
			'username':username,
			} 
			,'kexin').decode('UTF-8') 
		return util.packApiData(200,'ok','登录成功',{'token':token})
	else:
		return util.packApiData(403,'default','登录失败',{})
		
def userData(username,password):
	connection = pymysql.connect(host ='手动打码',port = 3306,user = "root",passwd = "124536")
	sql = 'SELECT password,userid,role,name FROM data.user WHERE username = %s'
	cursor = connection.cursor()
	cursor.execute(sql,[username])
	result = cursor.fetchone()
	try:
		if password == result[0]:
			userid = result[1]
			role = result[2]
			name = result[3]
			return userid,role,name
		else:
			return 0,0,0
	except:
		return 0,0,0
</code></pre> 
<p>这里作者使用了登录成功签发jwt的方式去实现登录保持，具体的功能实现还需要js的配合<br> jwt使用字符串kexin进行生成，读者也可使用其他自定义字符串，但需要保证与解密字符串一致<br> 连接数据库，django有原生的orm语句，但是过于繁琐，这里我选用了原生支持MySQL的pymysql进行数据库的操作<br> 关于数据库的搭建可见我另外的博客<br> <a href="https://blog.csdn.net/yoke__/article/details/122090477">传送门</a><br> MySQL的增删改查等本文不做详解<br> data数据库中的table表结构如下</p> 
<pre><code>+----------+----------+------+-----+---------+-------+
| Field    | Type     | Null | Key | Default | Extra |
+----------+----------+------+-----+---------+-------+
| username | char(20) | YES  |     | NULL    |       |
| password | char(50) | YES  |     | NULL    |       |
| userid   | char(5)  | YES  |     | NULL    |       |
| role     | int      | YES  |     | NULL    |       |
| name     | char(40) | YES  |     | NULL    |       |
+----------+----------+------+-----+---------+-------+
</code></pre> 
<p>role为用户的权限依据，id为用户唯一的5位随机码，后面绑定记录需要用到<br> 参考样例</p> 
<pre><code>+----------+----------+--------+------+--------------+
| username | password | userid | role | name         |
+----------+----------+--------+------+--------------+
| test     | 手动打码  | sh2kg  |    1 | 测试学生     |
| repair   | 手动打码  | 8j159  |    2 | 测试师傅     |
+----------+----------+--------+------+--------------+
</code></pre> 
<p>这里出于方便所以password直接明文存储，真实环境中是肯定不允许的<br> 后端逻辑搭建完毕，接下来还需要js去发力<br> 这里要用到js原生的ajax，需要依赖js，可以去网上下载</p> 
<pre><code>jquery-3.3.1.min.js
</code></pre> 
<p>源代码很长，这里就不直接贴出来<br> 登录的js代码，本项目中的js全部保存在public.js文件中，文章末尾会给出全部js代码</p> 
<pre><code>function submit() {
       // body...
    var username = $("#id_username").val();
    var password = $("#id_password").val();
$.ajax({
        url : "/api/scut/login",
        type : "post",
        async:true,
        data : {
            username: username,
            password : password,
        },
        dataType : "json",
        complete : function(res) {
            if (res.responseJSON.code == 412 ) {
                alert("请输入账号密码");
            }
            if (res.responseJSON.code == 403) {
                alert("用户名或密码错误");
                window.location.href="/login";
            }
            if (res.responseJSON.code == 200) {
                alert("登录成功");
                // console.log(res.responseJSON.data.token)
                var token = res.responseJSON.data.token;
                localStorage.setItem("token", token);
                window.location.href="/report";
                // headers.Authorization=localStorage.getItem("token")

            }
        
    }
    });
};
</code></pre> 
<p>这里根据html中元素的id去获取用户填写好的value<br> 然后封装成payload以post方式调用api<br> 登录成功获取到api签发的jwt并存储到本地以供后面调用<br> 然后跳转到/report页面<br> 这里report还没写<br> 至此，登录功能已经基本实现<br> 这里贴一下一些静态文件<br> public.css 建议放在/api/static/css文件夹下</p> 
<pre><code>*{
    margin: 0;
    padding: 0
}

.from{
    position: relative;
}

.submit{
    position: absolute;
    z-index: 9;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    margin: auto;
    margin-top: 150px;
    width: 500px;
    height: 300px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
}

.form_title{
    text-align: center;
    margin-top: 40px;
    font-size: 18px;
}

.form_input{
    padding: 0 30px;
    box-sizing: border-box;
    display: flex;
    margin-top: 20px;
}

.inputs{
    height: 40px;
    width: 300px;
    border-radius: 5px;
    border: none;
    background-color: #eee;
    color: #666;
    padding-left: 20px;
}

.form_input span{
    width: 85px;
    align-self: center;
}

.btn_submit{
    align-self: center;
}

.btn{
    border: none;
    width: 80px;
    height: 40px;
    color: #fff;
    border-radius: 5px;
    background: #999;
    margin-top: 40px;
}

.btn:hover{
    background: #666;
}

.back{
    margin-left: 10px;
}

.home_href{
    border: none;
    width: 80px;
    height: 40px;
    color: #fff;
    border-radius: 5px;
    background: #FFD204;
}
.footer{
    height: 40px;
    line-height: 40px;
    bottom: 0;
    width: 100%;
    text-align: center;
}
</code></pre> 
<p>img 建议放在/api/static/img文件夹下<br> <strong>2.主页</strong><br> report.html的源码<br> 记得在项目文件夹中的views.py中指向html<br> (其实叫index.html更合适)</p> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"&gt;
    &lt;title&gt;报修&lt;/title&gt;
    &lt;link rel="stylesheet" href="/static/css/layui.css"&gt;
&lt;/head&gt;

&lt;body class="layui-layout-body"&gt;
    &lt;div class="layui-layout-admin"&gt;
        &lt;div class="layui-header"&gt;
            &lt;div class="layui-logo"&gt;功能列表&lt;/div&gt;
            &lt;!-- 头部区域（可配合layui已有的水平导航） --&gt;
            &lt;ul class="layui-nav layui-layout-left"&gt;
                &lt;!-- &lt;li class="layui-nav-item"&gt;&lt;a href=""&gt;控制台&lt;/a&gt;&lt;/li&gt; --&gt;
                &lt;li class="layui-nav-item"&gt;
                    &lt;!-- &lt;a href="javascript:;"&gt;其它系统&lt;/a&gt; --&gt;
                    &lt;dl class="layui-nav-child"&gt;
                        &lt;dd&gt;&lt;a href=""&gt;授权管理&lt;/a&gt;&lt;/dd&gt;
                    &lt;/dl&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
            &lt;ul class="layui-nav layui-layout-right"&gt;
                &lt;li class="layui-nav-item"&gt;
                    &lt;a id="id_username"&gt;
                        &lt;!-- &lt;img src="./images/img.jpg" class="layui-nav-img"&gt; --&gt;
                        username
                    &lt;/a&gt;
                    &lt;dl class="layui-nav-child"&gt;
&lt;!--                         &lt;dd&gt;&lt;a href=""&gt;资料&lt;/a&gt;&lt;/dd&gt;
                        &lt;dd&gt;&lt;a href=""&gt;设置&lt;/a&gt;&lt;/dd&gt; --&gt;
                    &lt;/dl&gt;
                &lt;/li&gt;
                &lt;li class="layui-nav-item"&gt;&lt;a onclick="logout()"&gt;退出&lt;/a&gt;&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;

        &lt;div class="layui-side layui-bg-black"&gt;
            &lt;div class="layui-side-scroll"&gt;
                &lt;!-- 左侧导航区域（可配合layui已有的垂直导航） --&gt;
                &lt;ul class="layui-nav layui-nav-tree" lay-filter="test"&gt;
                    &lt;li class="layui-nav-item layui-nav-itemed"&gt;
                        &lt;a&gt;功能&lt;/a&gt;
                        &lt;dl class="layui-nav-child"&gt;
                            &lt;a href="/report"&gt;主页&lt;/a&gt;
                            &lt;a href="/record"&gt;报修记录&lt;/a&gt;
                            &lt;a href="/add"&gt;添加报修&lt;/a&gt;
                        &lt;/dl&gt;
                    &lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="layui-body"&gt;
            &lt;fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"&gt;
            &lt;legend&gt;主页&lt;/legend&gt;&lt;/fieldset&gt;
            欢迎你！&lt;span id = "show_name"&gt;&lt;/span&gt;!
        &lt;/div&gt;
    &lt;/div&gt;
&lt;script type="text/javascript" src="/static/js/jquery-3.3.1.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="/static/js/public.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
    userinfo();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
<p>这里使用到的layui.css太大这里就不放了，读者可以去代码仓库下载<br> <strong>功能的js实现逻辑</strong><br> 每次打开页面就调用API（这里是/api/userinfo）<br> 从本地缓存中获取jwt放到请求头中给后端API鉴权和身份识别<br> 后端鉴权识别身份后返回json<br> 样例</p> 
<pre><code>{"code": 200, "message": "ok", "tips": "ok", "requestTime": 1640354829, "data": {"username": "test"}}
</code></pre> 
<p>js接到返回json后通过</p> 
<pre><code>document.getElementById('id_username').innerText = res.responseJSON.data.username;
</code></pre> 
<p>实现相应信息的实现<br> 再加上一些响应码的判断以及ajax封装<br> 该部分js源码</p> 
<pre><code>function userinfo() {
    $.ajax({
        url:"/api/userinfo",
        type:"post",
        async:true,
        dataType:"json",
        complete : function(res) {
        if (res.responseJSON.code == 403) {
            alert("请先登录");
            window.location.href="/login";
            };
            document.getElementById('id_username').innerText = res.responseJSON.data.username;
            if(document.getElementById('show_name')){
            document.getElementById('show_name').innerText = res.responseJSON.data.username;
            }
        },
        beforeSend : function(xhr) {
        var token = window.localStorage.getItem('token');
            xhr.setRequestHeader("Authorization", token);
        }

    })
};
</code></pre> 
<p>前端基本就绪<br> 下面是该部分后端API的开发<br> api下views.py中新增函数</p> 
<pre><code>def userInfo(request):
	try:
		claim = jwt.decode(request.headers['Authorization'],'kexin')
		# print(claim)
		username = claim['username']
		if claim['exp'] &lt; int(time.time()):
			return packApiData(40302, 'Token is expired', '令牌已过期，请重新登录')
	except:
		return util.packApiData(403,'default','请先登录',{})
	return util.packApiData(200,'ok','ok',{"username":username})
</code></pre> 
<p>记得在urls.py中为该函数新建一个路由<br> jwt这里使用字符串kexin去进行解码，当然可以使用其他字符串，保证和加密使用字符串相同即可</p> 
<h3><a id="_584"></a>添加报修记录</h3> 
<p><strong>1.数据库的搭建</strong><br> 字段设计<br> record表<br> creator_id<br> 5位数随机码—user.id<br> name<br> 姓名<br> address<br> 地址<br> timestamp<br> 报修时间<br> content<br> 具体报修内容<br> id<br> 自增的id值,降序排列<br> status<br> 1:已提交<br> 2:已接单<br> 3:已处理<br> pid<br> 事件的五位随机码，用于修改状态时的匹配<br> 表结构如下</p> 
<pre><code>+------------+--------------+------+-----+---------+----------------+
| Field      | Type         | Null | Key | Default | Extra          |
+------------+--------------+------+-----+---------+----------------+
| id         | int          | NO   | PRI | NULL    | auto_increment |
| creator_id | varchar(5)   | YES  |     | NULL    |                |
| name       | varchar(255) | YES  |     | NULL    |                |
| address    | varchar(255) | YES  |     | NULL    |                |
| content    | varchar(255) | YES  |     | NULL    |                |
| time_stamp | varchar(255) | YES  |     | NULL    |                |
| phone      | varchar(255) | YES  |     | NULL    |                |
| repairman  | varchar(255) | YES  |     | NULL    |                |
| status     | int          | YES  |     | NULL    |                |
| pid        | varchar(5)   | YES  |     | NULL    |                |
+------------+--------------+------+-----+---------+----------------+
</code></pre> 
<p><strong>2.后端API设计</strong><br> 后端views.py中增加函数</p> 
<pre><code>def add(request):
	try:
		claim = jwt.decode(request.headers['Authorization'],'kexin')
		# print(claim)
		username = claim['username']
		if claim['exp'] &lt; int(time.time()):
			return packApiData(40302, 'Token is expired', '令牌已过期，请重新登录')
		creator_id = claim['userid']
	except:
		return util.packApiData(403,'default','请先登录',{})	
	name = request.POST.get('name')
	date = str(request.POST.get('date'))
	phone = request.POST.get('phone')
	content = request.POST.get('content')
	address = request.POST.get('address')
	time_stamp = date
	repairman = '测试维修师'
	status = 1
	pid = util.makeRandomStr(5)
	if name and phone and content and address and date:
		print(name,phone,content,address,date)
		connection = pymysql.connect(host = 手动打码,port = 3306,user = "root",passwd = "123456")
		cursor = connection.cursor()
		sql = "INSERT INTO data.record (name,address,creator_id,time_stamp,phone,content,repairman,status,pid) VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s)"
		cursor.execute(sql,[name,address,creator_id,time_stamp,phone,content,repairman,status,pid])
		connection.commit()
	else:
		return util.packApiData(401,'lack of param','缺少参数',{})
	return util.packApiData(200,'ok','ok',{})
</code></pre> 
<p>这里直接用简单的INSERT实现插入数据库<br> <strong>3.前端HTML</strong><br> 下面是前端add.html源码<br> 记得在项目文件夹中的views.py中指向html</p> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"&gt;
    &lt;title&gt;报修&lt;/title&gt;
    &lt;link rel="stylesheet" href="/static/css/layui.css"&gt;
&lt;/head&gt;

&lt;body class="layui-layout-body"&gt;
    &lt;div class="layui-layout-admin"&gt;
        &lt;div class="layui-header"&gt;
            &lt;div class="layui-logo"&gt;功能列表&lt;/div&gt;
            &lt;!-- 头部区域（可配合layui已有的水平导航） --&gt;
            &lt;ul class="layui-nav layui-layout-left"&gt;
                &lt;!-- &lt;li class="layui-nav-item"&gt;&lt;a href=""&gt;控制台&lt;/a&gt;&lt;/li&gt; --&gt;
                &lt;li class="layui-nav-item"&gt;
                    &lt;!-- &lt;a href="javascript:;"&gt;其它系统&lt;/a&gt; --&gt;
                    &lt;dl class="layui-nav-child"&gt;
                        &lt;dd&gt;&lt;a href=""&gt;授权管理&lt;/a&gt;&lt;/dd&gt;
                    &lt;/dl&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
            &lt;ul class="layui-nav layui-layout-right"&gt;
                &lt;li class="layui-nav-item"&gt;
                    &lt;a id="id_username"&gt;
                        &lt;!-- &lt;img src="./images/img.jpg" class="layui-nav-img"&gt; --&gt;
                        username
                    &lt;/a&gt;
                    &lt;dl class="layui-nav-child"&gt;
&lt;!--                         &lt;dd&gt;&lt;a href=""&gt;资料&lt;/a&gt;&lt;/dd&gt;
                        &lt;dd&gt;&lt;a href=""&gt;设置&lt;/a&gt;&lt;/dd&gt; --&gt;
                    &lt;/dl&gt;
                &lt;/li&gt;
                &lt;li class="layui-nav-item"&gt;&lt;a onclick="logout()"&gt;退出&lt;/a&gt;&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;

        &lt;div class="layui-side layui-bg-black"&gt;
            &lt;div class="layui-side-scroll"&gt;
                &lt;!-- 左侧导航区域（可配合layui已有的垂直导航） --&gt;
                &lt;ul class="layui-nav layui-nav-tree" lay-filter="test"&gt;
                    &lt;li class="layui-nav-item layui-nav-itemed"&gt;
                        &lt;a&gt;功能&lt;/a&gt;
                        &lt;dl class="layui-nav-child"&gt;
                            &lt;a href="/report"&gt;主页&lt;/a&gt;
                            &lt;a href="/record"&gt;报修记录&lt;/a&gt;
                            &lt;a href="/add"&gt;添加报修&lt;/a&gt;
                        &lt;/dl&gt;
                    &lt;/li&gt;
&lt;!--                     &lt;li class="layui-nav-item"&gt;
                        &lt;a href="/record"&gt;记录&lt;/a&gt;
                    &lt;/li&gt;
                    &lt;li class="layui-nav-item"&gt;
                        &lt;a href="/add"&gt;报修&lt;/a&gt;
                    &lt;/li&gt; --&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
        &lt;/div&gt;
            &lt;div class="layui-body"&gt;
            &lt;fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"&gt;
            &lt;legend&gt;添加报修&lt;/legend&gt;    
            &lt;form class="layui-form" action&gt;

            &lt;div class="layui-input-inline"&gt;
            &lt;label class="layui-form-label"&gt;姓名&lt;/label&gt;
            &lt;div class="layui-input-inline"&gt;
            &lt;input type="text" name="name"  autocomplete="off" class="layui-input" id="id_name"&gt;
            &lt;/div&gt;
            &lt;p&gt;&lt;/p&gt;
            &lt;label class="layui-form-label"&gt;手机号&lt;/label&gt;
            &lt;div class="layui-input-inline"&gt;
            &lt;input type="tel" name="phone"  autocomplete="off" class="layui-input" id="id_phone"&gt;
            &lt;/div&gt;
            &lt;p&gt;&lt;/p&gt;


            &lt;/div&gt;
            &lt;div&gt;
                &lt;label class="layui-form-label"&gt;详细地址&lt;/label&gt;
                &lt;div class="layui-input-block"&gt;
                &lt;input type="text" name="address"  autocomplete="off" class="layui-input" id="id_address"&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="layui-inline"&gt;
    &lt;label class="layui-form-label"&gt;预约时间&lt;/label&gt;
    &lt;div class="layui-input-inline"&gt;
    &lt;input type="date" name="date" id="date" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input" lay-key="1"&gt;
&lt;/div&gt;
&lt;/div&gt;

            &lt;/form&gt;

        &lt;div class="layui-form-item layui-form-text"&gt;
        &lt;label class="layui-form-label"&gt;报修内容&lt;/label&gt;
        &lt;div class="layui-input-block"&gt;
        &lt;textarea placeholder="请详细描述报修内容，所在位置等相关信息" class="layui-textarea" id = "id_content"&gt;&lt;/textarea&gt;
        &lt;/div&gt;
    &lt;/div&gt;




    &lt;div class="layui-input-block"&gt;
    &lt;button class="layui-btn" lay-submit lay-filter="demo1" onclick="add()"&gt;提交&lt;/button&gt;
    &lt;button type="reset" class="layui-btn layui-btn-primary" onclick="reset()"&gt;重置&lt;/button&gt;
    &lt;/div&gt;


&lt;!--         &lt;div class="layui-footer"&gt;
            底部固定区域
            © xxxx.com - 底部固定区域
        &lt;/div&gt; --&gt;
    &lt;/div&gt;
&lt;script type="text/javascript" src="/static/js/jquery-3.3.1.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="/static/js/public.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
userinfo();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
<p><strong>4.js配合前端食用</strong><br> js构造HTTP请求</p> 
<pre><code>function add() {
    var name = $("#id_name").val()
    var date = $("#date").val();
    var phone = $("#id_phone").val();
    var content = $("#id_content").val()
    var address = $("#id_address").val()
    $.ajax({
        url:"/api/add",
        type:"post",
        dataType:"json",
        data:{
            "name":name,
            "date":date,
            "phone":phone,
            "content":content,
            "address":address
        },
        complete:function(res) {
        if (res.responseJSON.code == 200) {
            alert("报修成功")
            window.location.href="/add";
            // body...
        };
        if (res.responseJSON.code == 401) {
            alert("报修信息不全")
            window.location.href="/add";
        
        };
        },

        beforeSend : function(xhr) {
        var token = window.localStorage.getItem('token');
            xhr.setRequestHeader("Authorization", token);
        },
    })

</code></pre> 
<p>这里清空输入直接采用刷新页面的方法</p> 
<pre><code>function reset() {
    window.location.href="/add";
};
</code></pre> 
<h3><a id="__830"></a>重头戏 报修记录的显示</h3> 
<p><strong>1.数据库设计</strong><br> 这个在前面的记录添加中已经讲过，这里不做重复<br> <strong>2.报修记录显示</strong><br> 由于本架构使用的是原生的HTML，所以我用了一个极其低效的方法：<br> 把API返回的数据用js封装为HTML再让浏览器渲染<br> <strong>3.维修师修改</strong><br> 我原本打算新开一个页面来实现维修师的修改功能<br> 然后发现可以通过鉴权直接在显示页面中添加一个修改栏<br> 权限不足的用户都无法看到该修改栏，即使恶意构造payload也过不了鉴权<br> record.html</p> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"&gt;
    &lt;title&gt;报修&lt;/title&gt;
    &lt;link rel="stylesheet" href="/static/css/layui.css"&gt;
    &lt;link rel="stylesheet" href="/static/css/apply.css"&gt;
&lt;/head&gt;

&lt;body class="layui-layout-body"&gt;
    &lt;div class="layui-layout-admin"&gt;
        &lt;div class="layui-header"&gt;
            &lt;div class="layui-logo"&gt;功能列表&lt;/div&gt;

            &lt;ul class="layui-nav layui-layout-left"&gt;

                &lt;li class="layui-nav-item"&gt;
                    &lt;!-- &lt;a href="javascript:;"&gt;其它系统&lt;/a&gt; --&gt;
                    &lt;dl class="layui-nav-child"&gt;
                        &lt;dd&gt;&lt;a href=""&gt;授权管理&lt;/a&gt;&lt;/dd&gt;
                    &lt;/dl&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
            &lt;ul class="layui-nav layui-layout-right"&gt;
                &lt;li class="layui-nav-item"&gt;
                    &lt;a id="id_username"&gt;
                        &lt;!-- &lt;img src="./images/img.jpg" class="layui-nav-img"&gt; --&gt;
                        username
                    &lt;/a&gt;
                    &lt;dl class="layui-nav-child"&gt;
                    &lt;/dl&gt;
                &lt;/li&gt;
                &lt;li class="layui-nav-item"&gt;&lt;a onclick="logout()"&gt;退出&lt;/a&gt;&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/div&gt;

        &lt;div class="layui-side layui-bg-black"&gt;
            &lt;div class="layui-side-scroll"&gt;
                &lt;!-- 左侧导航区域（可配合layui已有的垂直导航） --&gt;
                &lt;ul class="layui-nav layui-nav-tree" lay-filter="test"&gt;
                    &lt;li class="layui-nav-item layui-nav-itemed"&gt;
                        &lt;a&gt;功能&lt;/a&gt;
                        &lt;dl class="layui-nav-child"&gt;
                            &lt;a href="/report"&gt;主页&lt;/a&gt;
                            &lt;a href="/record"&gt;报修记录&lt;/a&gt;
                            &lt;a href="/add"&gt;添加报修&lt;/a&gt;
                        &lt;/dl&gt;
                    &lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="layui-body"&gt;
        &lt;fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"&gt;
        &lt;legend&gt;报修记录
       
        &lt;/legend&gt;
        &lt;/fieldset&gt;
        &lt;div id = "show"&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;script type="text/javascript" src="/static/js/jquery-3.3.1.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="/static/js/public.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
    record();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre> 
<p>js</p> 
<pre><code>function record() {
    $.ajax({
        url:"/api/record",
        type:"post",
        async:true,
        dataType:"json",
        complete : function(res) {
        if (res.responseJSON.code == 403) {
            alert("请先登录");
            window.location.href="/login";
            };
        if (res.responseJSON.code == 401) {
            alert("您还没有报修记录")
            window.location.href="/add";
        };
            document.getElementById('id_username').innerText = res.responseJSON.data.username;
            let record = res.responseJSON.data.record;
            // console.log(record)
            var html = "";
            if (res.responseJSON.data.role &gt; 1){
                    html = html + '&lt;div class="layui-input-inline"&gt; &lt;span&gt;请输入pid&lt;/span&gt; &lt;input type="text" name="pid" id="id_pid"&gt; 状态修改为 &lt;select id = "select"&gt; &lt;option value = "1"&gt;已提交&lt;/option&gt; &lt;option value = "2"&gt;已接单&lt;/option&gt; &lt;option value = "3"&gt;已处理&lt;/option&gt; &lt;/select&gt; &lt;button class="layui-btn" lay-submit lay-filter="demo1" onclick="edit()"&gt;提交&lt;/button&gt;'}

            record.forEach((item,index) =&gt; {
                // console.log(item)
                // console.log(item.name)

                
                if (item.status == 1){
                    html = html + '&lt;fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"&gt; &lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;状态&lt;/label&gt; &lt;div class="step_box"&gt;&lt;div class="step line"&gt;&lt;img src="/static/img/true.png" style="width:20px;height:20px;"&gt;&lt;span&gt;已提交&lt;/span&gt;&lt;/div&gt;&lt;div class="step line"&gt;&lt;img src="/static/img/unTrue.png" style="width:20px;height:20px;"&gt;&lt;span&gt;已接单&lt;/span&gt;&lt;/div&gt;&lt;div class="step"&gt;&lt;img src="/static/img/unTrue.png" style="width:20px;height:20px;"&gt;&lt;span&gt;已处理&lt;/span&gt;&lt;/div&gt;&lt;/div&gt; &lt;/div&gt;'
                };
                if (item.status == 2){
                    html = html + '&lt;fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"&gt; &lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;状态&lt;/label&gt; &lt;div class="step_box"&gt;&lt;div class="step line"&gt;&lt;img src="/static/img/true.png" style="width:20px;height:20px;"&gt;&lt;span&gt;已提交&lt;/span&gt;&lt;/div&gt;&lt;div class="step line"&gt;&lt;img src="/static/img/true.png" style="width:20px;height:20px;"&gt;&lt;span&gt;已接单&lt;/span&gt;&lt;/div&gt;&lt;div class="step"&gt;&lt;img src="/static/img/unTrue.png" style="width:20px;height:20px;"&gt;&lt;span&gt;已处理&lt;/span&gt;&lt;/div&gt;&lt;/div&gt; &lt;/div&gt;'
                };
                if (item.status == 3){
                    html = html + '&lt;fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"&gt; &lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;状态&lt;/label&gt; &lt;div class="step_box"&gt;&lt;div class="step line"&gt;&lt;img src="/static/img/true.png" style="width:20px;height:20px;"&gt;&lt;span&gt;已提交&lt;/span&gt;&lt;/div&gt;&lt;div class="step line"&gt;&lt;img src="/static/img/true.png" style="width:20px;height:20px;"&gt;&lt;span&gt;已接单&lt;/span&gt;&lt;/div&gt;&lt;div class="step"&gt;&lt;img src="/static/img/true.png" style="width:20px;height:20px;"&gt;&lt;span&gt;已处理&lt;/span&gt;&lt;/div&gt;&lt;/div&gt; &lt;/div&gt;'
                }
                if (res.responseJSON.data.role &lt;= 1){
                html = html + '&lt;p&gt;&lt;/p&gt;&lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;姓名&lt;/label&gt; &lt;div class="layui-input-block"&gt; &lt;text type="text" name="name"  autocomplete="off" class="layui-input" id = "id_name"&gt;' + item.name +  '&lt;/text&gt; &lt;/div&gt; &lt;/div&gt;&lt;div&gt; &lt;label class="layui-form-label"&gt;电话&lt;/label&gt; &lt;div class="layui-input-block"&gt; &lt;text type="text" name="address"  autocomplete="off" class="layui-input" id = "id_phone"&gt;' + item.phone +' &lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;div&gt; &lt;label class="layui-form-label"&gt;所属区域&lt;/label&gt; &lt;div class="layui-input-block"&gt; &lt;text type="text" name="address"  autocomplete="off" class="layui-input" id = "id_address"&gt;' + item.address +'&lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;维修师&lt;/label&gt; &lt;div class="layui-input-inline"&gt; &lt;text type="text" name="repairman"  autocomplete="off" class="layui-input" id = "id_repairman"&gt;' + item.repairman + '  &lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;p&gt;&lt;/p&gt; &lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;处理时间&lt;/label&gt; &lt;div class="layui-input-inline"&gt; &lt;text type="text" name="time"  autocomplete="off" class="layui-input" id = "id_time" &gt;' + item.appoint + ' &lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="layui-form-item layui-form-text"&gt; &lt;label class="layui-form-label"&gt;详情&lt;/label&gt; &lt;div class="layui-input-block"&gt; &lt;text class="layui-textarea" id = "id_content"&gt;' + item.content + '&lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/fieldset&gt;'
                }
                else {
                html = html + '&lt;p&gt;&lt;/p&gt;&lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;pid&lt;/label&gt; &lt;div class="layui-input-block"&gt; &lt;text type="text" name="name"  autocomplete="off" class="layui-input" id = "id_name"&gt;' + item.pid +  '&lt;/text&gt; &lt;/div&gt; &lt;/div&gt;' +'&lt;p&gt;&lt;/p&gt;&lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;姓名&lt;/label&gt; &lt;div class="layui-input-block"&gt; &lt;text type="text" name="name"  autocomplete="off" class="layui-input" id = "id_name"&gt;' + item.name +  '&lt;/text&gt; &lt;/div&gt; &lt;/div&gt;&lt;div&gt; &lt;label class="layui-form-label"&gt;电话&lt;/label&gt; &lt;div class="layui-input-block"&gt; &lt;text type="text" name="address"  autocomplete="off" class="layui-input" id = "id_phone"&gt;' + item.phone +' &lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;div&gt; &lt;label class="layui-form-label"&gt;所属区域&lt;/label&gt; &lt;div class="layui-input-block"&gt; &lt;text type="text" name="address"  autocomplete="off" class="layui-input" id = "id_address"&gt;' + item.address +'&lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;维修师&lt;/label&gt; &lt;div class="layui-input-inline"&gt; &lt;text type="text" name="repairman"  autocomplete="off" class="layui-input" id = "id_repairman"&gt;' + item.repairman + '  &lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;p&gt;&lt;/p&gt; &lt;div class="layui-input-inline"&gt; &lt;label class="layui-form-label"&gt;处理时间&lt;/label&gt; &lt;div class="layui-input-inline"&gt; &lt;text type="text" name="time"  autocomplete="off" class="layui-input" id = "id_time" &gt;' + item.appoint + ' &lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class="layui-form-item layui-form-text"&gt; &lt;label class="layui-form-label"&gt;详情&lt;/label&gt; &lt;div class="layui-input-block"&gt; &lt;text class="layui-textarea" id = "id_content"&gt;' + item.content + '&lt;/text&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/fieldset&gt;'
                }
                })
            document.getElementById('show').innerHTML = html


        },
        beforeSend : function(xhr) {
        var token = window.localStorage.getItem('token');
            xhr.setRequestHeader("Authorization", token);
        }

    })
};

function edit(){
    var myselect = document.getElementById('select');
    var index=myselect.selectedIndex;
    var status = myselect.options[index].value;
    var pid =  $("#id_pid").val()
    console.log(status);
    $.ajax({
        url:"/api/edit",
        type:"post",
        async:true,
        dataType:"json",
        data:{
            "pid":pid,
            "status":status,
        },
        complete : function(res) {
        if (res.responseJSON.code == 403) {
            alert("请先登录");
            window.location.href="/login";
            };
        if (res.responseJSON.code == 401) {
            alert("权限不足")
            window.location.href="/index";
            };
        if (res.responseJSON.code == 200) {
            alert("修改成功")
            window.location.href="/record";
            };

        },   
        beforeSend : function(xhr) {
        var token = window.localStorage.getItem('token');
            xhr.setRequestHeader("Authorization", token);
        },
    });
}
</code></pre> 
<p>封装成html看起来着实不优雅<br> 下面的edit()函数给API(/api/edit)发送请求实现编辑<br> views.py中新增函数</p> 
<pre><code>def add(request):
	try:
		claim = jwt.decode(request.headers['Authorization'],'kexin')
		# print(claim)
		username = claim['username']
		if claim['exp'] &lt; int(time.time()):
			return packApiData(40302, 'Token is expired', '令牌已过期，请重新登录')
		creator_id = claim['userid']
	except:
		return util.packApiData(403,'default','请先登录',{})	
	name = request.POST.get('name')
	date = str(request.POST.get('date'))
	phone = request.POST.get('phone')
	content = request.POST.get('content')
	address = request.POST.get('address')
	time_stamp = date
	repairman = '测试维修师'
	status = 1
	pid = util.makeRandomStr(5)
	if name and phone and content and address and date:
		print(name,phone,content,address,date)
		connection = pymysql.connect(host =手动打码,port = 3306,user = "root",passwd = "123456")
		cursor = connection.cursor()
		sql = "INSERT INTO data.record (name,address,creator_id,time_stamp,phone,content,repairman,status,pid) VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s)"
		cursor.execute(sql,[name,address,creator_id,time_stamp,phone,content,repairman,status,pid])
		connection.commit()
	else:
		return util.packApiData(401,'lack of param','缺少参数',{})
	return util.packApiData(200,'ok','ok',{})

def edit(request):
	try:
		claim = jwt.decode(request.headers['Authorization'],'kexin')
		# print(claim)
		username = claim['username']
		role = claim['role']
		if claim['exp'] &lt; int(time.time()):
			return packApiData(40302, 'Token is expired', '令牌已过期，请重新登录')
		creator_id = claim['userid']
		role = claim['role']
	except:
		return util.packApiData(403,'default','请先登录',{})
	if role &lt;= 1:
		return util.packApiData(401,'Insufficient permissions','权限不足',{})
	pid = request.POST.get('pid')
	status = request.POST.get('status')
	connection = pymysql.connect(host =手动打码,port = 3306,user = "root",passwd = "124536")
	cursor = connection.cursor()
	sql = 'UPDATE data.record SET status = %s WHERE pid = %s'
	cursor.execute(sql,[status,pid])
	connection.commit()
	return util.packApiData(200,'ok','ok',{})
</code></pre> 
<p>记得在项目文件夹中的views.py中指向html</p> 
<h3><a id="_1063"></a>回顾</h3> 
<p><strong>1.重要文件配置</strong><br> <strong>API</strong><br> api 下的templates<br> <img src="https://images2.imgbox.com/67/a8/IaY84iyc_o.png" alt="在这里插入图片描述"><br> api下的urls.py</p> 
<pre><code>from django.conf.urls import url
from . import views

urlpatterns = [
	url('login',views.login),
	url('record',views.record),
	url('add',views.add),
	url('userinfo',views.userInfo),
	url('edit',views.edit),
	]
</code></pre> 
<p>api下的views.py<br> 怕前面搞漏了，这里给全</p> 
<pre><code>from django.shortcuts import render
import json
import pymysql
from django.http import HttpResponse
from . import util
from authlib.jose import jwt
import time
# Create your views here.

def login(request):
	password = request.POST.get('password')
	username = request.POST.get('username')
	if len(password) == 0 or len(username) == 0:
		return util.packApiData(412,'please enter the account password','请输入账号密码',{})
	userid,role,name = userData(username,password)
	
	if userid:
		token = jwt.encode(	{'alg': 'HS256'}, {
			'iss': 'Kudan', 
			'exp': int(time.time()) + 7200 ,
			'userid':userid,
			'name':name,
			'role':role,
			'username':username,
			} 
			,'kexin').decode('UTF-8') 
		return util.packApiData(200,'ok','登录成功',{'token':token})
	else:
		return util.packApiData(403,'default','登录失败',{})

def userData(username,password):
	connection = pymysql.connect(host =手动打码,port = 3306,user = "root",passwd = "124536")
	sql = 'SELECT password,userid,role,name FROM data.user WHERE username = %s'
	cursor = connection.cursor()
	cursor.execute(sql,[username])
	result = cursor.fetchone()
	try:
		if password == result[0]:
			userid = result[1]
			role = result[2]
			name = result[3]
			return userid,role,name
		else:
			return 0,0,0
	except:
		return 0,0,0
	# userid
	# 0 登录失败
	# 1 user
	# 2 admin

def userInfo(request):
	try:
		claim = jwt.decode(request.headers['Authorization'],'kexin')
		# print(claim)
		username = claim['username']
		if claim['exp'] &lt; int(time.time()):
			return packApiData(40302, 'Token is expired', '令牌已过期，请重新登录')
	except:
		return util.packApiData(403,'default','请先登录',{})
	return util.packApiData(200,'ok','ok',{"username":username})

def record(request):
	try:
		claim = jwt.decode(request.headers['Authorization'],'kexin')
		# print(claim)
		username = claim['username']
		role = claim['role']
		if claim['exp'] &lt; int(time.time()):
			return packApiData(40302, 'Token is expired', '令牌已过期，请重新登录')
		creator_id = claim['userid']
		role = claim['role']
		print(creator_id)
	except:
		return util.packApiData(403,'default','请先登录',{})
	connection = pymysql.connect(host =手动打码,port = 3306,user = "root",passwd = "124536")
	cursor = connection.cursor()
	if role &lt;= 1:
		sql = 'SELECT name,address,content,time_stamp,repairman,status,phone,pid FROM data.record WHERE creator_id = %s ORDER BY id DESC'
	# sql = 'desc data.record'
		cursor.execute(sql,[creator_id])
	else:
		sql = 'SELECT name,address,content,time_stamp,repairman,status,phone,pid FROM data.record ORDER BY id DESC'
		cursor.execute(sql)
	result = cursor.fetchall()
	event_list = []
	try:
		for record in result:
			name,address,content,time_stamp,repairman,status,phone,pid = record[0],record[1],record[2],record[3],record[4],record[5],record[6],record[7]
			appoint = time_stamp
			event_list.append({'name':name,'address':address,'phone':phone,'content':content,'appoint':appoint,'repairman':repairman,'status':status,'pid':pid})
	except:
		return util.packApiData(401,'lack of data','缺少数据',{})
	return util.packApiData(200,'ok','成功',{'role':role,'username':username,'creator_id':creator_id,'record':event_list})
	# 报修记录
	
def date(time_stamp):
	time_stamp = time.localtime(int(time_stamp))
	date = time.strftime("%Y-%m-%d",time_stamp)
	return date


def add(request):
	try:
		claim = jwt.decode(request.headers['Authorization'],'kexin')
		# print(claim)
		username = claim['username']
		if claim['exp'] &lt; int(time.time()):
			return packApiData(40302, 'Token is expired', '令牌已过期，请重新登录')
		creator_id = claim['userid']
	except:
		return util.packApiData(403,'default','请先登录',{})	
	name = request.POST.get('name')
	date = str(request.POST.get('date'))
	phone = request.POST.get('phone')
	content = request.POST.get('content')
	address = request.POST.get('address')
	time_stamp = date
	repairman = '测试维修师'
	status = 1
	pid = util.makeRandomStr(5)
	if name and phone and content and address and date:
		print(name,phone,content,address,date)
		connection = pymysql.connect(host =手动打码,port = 3306,user = "root",passwd = "qweqwe111")
		cursor = connection.cursor()
		sql = "INSERT INTO data.record (name,address,creator_id,time_stamp,phone,content,repairman,status,pid) VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s)"
		cursor.execute(sql,[name,address,creator_id,time_stamp,phone,content,repairman,status,pid])
		connection.commit()
	else:
		return util.packApiData(401,'lack of param','缺少参数',{})
	return util.packApiData(200,'ok','ok',{})

def edit(request):
	try:
		claim = jwt.decode(request.headers['Authorization'],'kexin')
		# print(claim)
		username = claim['username']
		role = claim['role']
		if claim['exp'] &lt; int(time.time()):
			return packApiData(40302, 'Token is expired', '令牌已过期，请重新登录')
		creator_id = claim['userid']
		role = claim['role']
	except:
		return util.packApiData(403,'default','请先登录',{})
	if role &lt;= 1:
		return util.packApiData(401,'Insufficient permissions','权限不足',{})
	pid = request.POST.get('pid')
	status = request.POST.get('status')
	connection = pymysql.connect(host =手动打码,port = 3306,user = "root",passwd = "124536")
	cursor = connection.cursor()
	sql = 'UPDATE data.record SET status = %s WHERE pid = %s'
	cursor.execute(sql,[status,pid])
	connection.commit()
	return util.packApiData(200,'ok','ok',{})
</code></pre> 
<p><strong>项目文件</strong><br> 项目文件下的views.py</p> 
<pre><code>from django.shortcuts import render

def index(request):
	return render(request,'index.html')

def login(request):
	return render(request,'login.html')

def report(request):
	return render(request,'report.html')

def record(request):
	return render(request,'record.html')

def add(request):
	return render(request,'add.html')
	
def edit(request):
	return render(request,'edit.html')
</code></pre> 
<p>urls.py</p> 
<pre><code>from django.urls import path,include
from . import views
urlpatterns = [
    path('api/',include('api.urls')),
    path('login',views.login),
    path('report',views.report),
    path('record',views.record),
    path('add',views.add),
    path('edit',views.edit),
]
</code></pre> 
<p><strong>设置</strong><br> settings.py中几个注意点</p> 
<pre><code>INSTALLED_APPS 记得添加自己新增的app
ALLOWED_HOSTS = ['*']
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR,'static')
如果报错就import os
</code></pre> 
<h2><a id="_1284"></a>项目地址</h2> 
<p>vue开发的界面<br> <a href="http://112.74.86.205/" rel="nofollow">传送门1</a><br> 本文中使用到的原始HTML+js界面<br> <a href="http://112.74.86.205:8080/" rel="nofollow">传送门2</a><br> 测试账号<br> username repair<br> password 123456<br> 2022-05-03更新<br> 我自己又用vue把前端重写了一下<br> 开发过程及踩坑后面会补上</p> 
<h2><a id="_1295"></a>完结撒花</h2>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/af4b6bdc2691876c76315cdf55d4e5c3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">stm32学习----正电原子精英板控制电机正反转</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/111a02333b0be608a431128cdd6127a8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Flink 架构——状态管理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>