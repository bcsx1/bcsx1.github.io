<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Seata-Saga - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Seata-Saga" />
<meta property="og:description" content="seata saga模式 整理自seata 官网 seata.io
为什么要用saga模式
场景，调用第三方系统，且不能提供TCC接口，否则还是建议使用TCC
优点
1、适用场景
2、如果一个过程已经完善了，后续可以复用
缺点
1、侵入性强
2、要新增状态的时候或者在整个事务中增加一个流程（状态），需要修改json
Saga 服务设计的实践经验 允许空补偿 空补偿：原服务未执行，补偿服务执行了出现原因： 原服务 超时（丢包）Saga 事务触发 回滚未收到 原服务请求，先收到 补偿请求 所以服务设计时需要允许空补偿, 即没有找到要补偿的业务主键时返回补偿成功并将原业务主键记录下来
防悬挂控制 悬挂：补偿服务 比 原服务 先执行出现原因： 原服务 超时（拥堵）Saga 事务回滚，触发 回滚拥堵的 原服务 到达 所以要检查当前业务主键是否已经在空补偿记录下来的业务主键中存在，如果存在则要拒绝服务的执行
幂等控制 原服务与补偿服务都需要保证幂等性, 由于网络可能超时, 可以设置重试策略，重试发生时要通过幂等控制避免业务数据重复更新 缺乏隔离性的应对 由于 Saga 事务不保证隔离性, 在极端情况下可能由于脏写无法完成回滚操作, 比如举一个极端的例子, 分布式事务内先给用户A充值, 然后给用户B扣减余额, 如果在给A用户充值成功, 在事务提交以前, A用户把余额消费掉了, 如果事务发生回滚, 这时则没有办法进行补偿了。这就是缺乏隔离性造成的典型的问题, 实践中一般的应对方法是： 业务流程设计时遵循“宁可长款, 不可短款”的原则, 长款意思是客户少了钱机构多了钱, 以机构信誉可以给客户退款, 反之则是短款, 少的钱可能追不回来了。所以在业务流程设计上一定是先扣款。有些业务场景可以允许让业务最终成功, 在回滚不了的情况下可以继续重试完成后面的流程, 所以状态机引擎除了提供“回滚”能力还需要提供“向前”恢复上下文继续执行的能力, 让业务最终执行成功, 达到最终一致性的目的。 性能优化 配置客户端参数client.rm.report.success.enable=false，可以在当分支事务执行成功时不上报分支状态到server，从而提升性能。 当上一个分支事务的状态还没有上报的时候，下一个分支事务已注册，可以认为上一个实际已成功
API referance StateMachineEngine API public interface StateMachineEngine { /** * start a state machine instance * @param stateMachineName * @param tenantId * @param startParams * @return * @throws EngineExecutionException */ StateMachineInstance start(String stateMachineName, String tenantId, Map&lt;String, Object&gt; startParams) throws EngineExecutionException; /** * start a state machine instance with businessKey * @param stateMachineName * @param tenantId * @param businessKey * @param startParams * @return * @throws EngineExecutionException */ StateMachineInstance startWithBusinessKey(String stateMachineName, String tenantId, String businessKey, Map&lt;String, Object&gt; startParams) throws EngineExecutionException; /** * start a state machine instance asynchronously * @param stateMachineName * @param tenantId * @param startParams * @param callback * @return * @throws EngineExecutionException */ StateMachineInstance startAsync(String stateMachineName, String tenantId, Map&lt;String, Object&gt; startParams, AsyncCallback callback) throws EngineExecutionException; /** * start a state machine instance asynchronously with businessKey * @param stateMachineName * @param tenantId * @param businessKey * @param startParams * @param callback * @return * @throws EngineExecutionException */ StateMachineInstance startWithBusinessKeyAsync(String stateMachineName, String tenantId, String businessKey, Map&lt;String, Object&gt; startParams, AsyncCallback callback) throws EngineExecutionException; /** * forward restart a failed state machine instance * @param stateMachineInstId * @param replaceParams * @return * @throws ForwardInvalidException */ StateMachineInstance forward(String stateMachineInstId, Map&lt;String, Object&gt; replaceParams) throws ForwardInvalidException; /** * forward restart a failed state machine instance asynchronously * @param stateMachineInstId * @param replaceParams * @param callback * @return * @throws ForwardInvalidException */ StateMachineInstance forwardAsync(String stateMachineInstId, Map&lt;String, Object&gt; replaceParams, AsyncCallback callback) throws ForwardInvalidException; /** * compensate a state machine instance * @param stateMachineInstId * @param replaceParams * @return * @throws EngineExecutionException */ StateMachineInstance compensate(String stateMachineInstId, Map&lt;String, Object&gt; replaceParams) throws EngineExecutionException; /** * compensate a state machine instance asynchronously * @param stateMachineInstId * @param replaceParams * @param callback * @return * @throws EngineExecutionException */ StateMachineInstance compensateAsync(String stateMachineInstId, Map&lt;String, Object&gt; replaceParams, AsyncCallback callback) throws EngineExecutionException; /** * skip current failed state instance and forward restart state machine instance * @param stateMachineInstId * @return * @throws EngineExecutionException */ StateMachineInstance skipAndForward(String stateMachineInstId) throws EngineExecutionException; /** * skip current failed state instance and forward restart state machine instance asynchronously * @param stateMachineInstId * @param callback * @return * @throws EngineExecutionException */ StateMachineInstance skipAndForwardAsync(String stateMachineInstId, AsyncCallback callback) throws EngineExecutionException; /** * get state machine configurations * @return */ StateMachineConfig getStateMachineConfig(); } StateMachine Execution Instance API: StateLogRepository stateLogRepository = stateMachineEngine." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/fd3637061592932bebeb973b697d8929/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-09T16:10:26+08:00" />
<meta property="article:modified_time" content="2021-01-09T16:10:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Seata-Saga</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="seata_saga_0"></a>seata saga模式</h2> 
<p>整理自seata 官网 <a href="http://seata.io/zh-cn/" rel="nofollow">seata.io</a></p> 
<p>为什么要用saga模式</p> 
<p>场景，调用第三方系统，且不能提供TCC接口，否则还是建议使用TCC</p> 
<p>优点</p> 
<p>1、适用场景</p> 
<p>2、如果一个过程已经完善了，后续可以复用</p> 
<p>缺点</p> 
<p>1、侵入性强</p> 
<p>2、要新增状态的时候或者在整个事务中增加一个流程（状态），需要修改json</p> 
<h4><a id="Saga__21"></a>Saga 服务设计的实践经验</h4> 
<h5><a id="_23"></a>允许空补偿</h5> 
<ul><li>空补偿：原服务未执行，补偿服务执行了</li><li>出现原因： 
  <ul><li>原服务 超时（丢包）</li><li>Saga 事务触发 回滚</li><li>未收到 原服务请求，先收到 补偿请求</li></ul> </li></ul> 
<p>所以服务设计时需要允许空补偿, 即没有找到要补偿的业务主键时返回补偿成功并将原业务主键记录下来</p> 
<h5><a id="_33"></a>防悬挂控制</h5> 
<ul><li>悬挂：补偿服务 比 原服务 先执行</li><li>出现原因： 
  <ul><li>原服务 超时（拥堵）</li><li>Saga 事务回滚，触发 回滚</li><li>拥堵的 原服务 到达</li></ul> </li></ul> 
<p>所以要检查当前业务主键是否已经在空补偿记录下来的业务主键中存在，如果存在则要拒绝服务的执行</p> 
<h5><a id="_43"></a>幂等控制</h5> 
<ul><li>原服务与补偿服务都需要保证幂等性, 由于网络可能超时, 可以设置重试策略，重试发生时要通过幂等控制避免业务数据重复更新</li></ul> 
<h4><a id="_47"></a>缺乏隔离性的应对</h4> 
<ul><li>由于 Saga 事务不保证隔离性, 在极端情况下可能由于脏写无法完成回滚操作, 比如举一个极端的例子, 分布式事务内先给用户A充值, 然后给用户B扣减余额, 如果在给A用户充值成功, 在事务提交以前, A用户把余额消费掉了, 如果事务发生回滚, 这时则没有办法进行补偿了。这就是缺乏隔离性造成的典型的问题, 实践中一般的应对方法是： 
  <ul><li>业务流程设计时遵循“宁可长款, 不可短款”的原则, 长款意思是客户少了钱机构多了钱, 以机构信誉可以给客户退款, 反之则是短款, 少的钱可能追不回来了。所以在业务流程设计上一定是先扣款。</li><li>有些业务场景可以允许让业务最终成功, 在回滚不了的情况下可以继续重试完成后面的流程, 所以状态机引擎除了提供“回滚”能力还需要提供“向前”恢复上下文继续执行的能力, 让业务最终执行成功, 达到最终一致性的目的。</li></ul> </li></ul> 
<h4><a id="_53"></a>性能优化</h4> 
<ul><li>配置客户端参数<code>client.rm.report.success.enable=false</code>，可以在当分支事务执行成功时不上报分支状态到server，从而提升性能。</li></ul> 
<blockquote> 
 <p>当上一个分支事务的状态还没有上报的时候，下一个分支事务已注册，可以认为上一个实际已成功</p> 
</blockquote> 
<h3><a id="API_referance_59"></a>API referance</h3> 
<h5><a id="StateMachineEngine_API_61"></a>StateMachineEngine API</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StateMachineEngine</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * start a state machine instance
     * @param stateMachineName
     * @param tenantId
     * @param startParams
     * @return
     * @throws EngineExecutionException
     */</span>
    StateMachineInstance <span class="token function">start</span><span class="token punctuation">(</span>String stateMachineName<span class="token punctuation">,</span> String tenantId<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> startParams<span class="token punctuation">)</span> <span class="token keyword">throws</span> EngineExecutionException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * start a state machine instance with businessKey
     * @param stateMachineName
     * @param tenantId
     * @param businessKey
     * @param startParams
     * @return
     * @throws EngineExecutionException
     */</span>
    StateMachineInstance <span class="token function">startWithBusinessKey</span><span class="token punctuation">(</span>String stateMachineName<span class="token punctuation">,</span> String tenantId<span class="token punctuation">,</span> String businessKey<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> startParams<span class="token punctuation">)</span> <span class="token keyword">throws</span> EngineExecutionException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * start a state machine instance asynchronously
     * @param stateMachineName
     * @param tenantId
     * @param startParams
     * @param callback
     * @return
     * @throws EngineExecutionException
     */</span>
    StateMachineInstance <span class="token function">startAsync</span><span class="token punctuation">(</span>String stateMachineName<span class="token punctuation">,</span> String tenantId<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> startParams<span class="token punctuation">,</span> AsyncCallback callback<span class="token punctuation">)</span> <span class="token keyword">throws</span> EngineExecutionException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * start a state machine instance asynchronously with businessKey
     * @param stateMachineName
     * @param tenantId
     * @param businessKey
     * @param startParams
     * @param callback
     * @return
     * @throws EngineExecutionException
     */</span>
    StateMachineInstance <span class="token function">startWithBusinessKeyAsync</span><span class="token punctuation">(</span>String stateMachineName<span class="token punctuation">,</span> String tenantId<span class="token punctuation">,</span> String businessKey<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> startParams<span class="token punctuation">,</span> AsyncCallback callback<span class="token punctuation">)</span> <span class="token keyword">throws</span> EngineExecutionException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * forward restart a failed state machine instance
     * @param stateMachineInstId
     * @param replaceParams
     * @return
     * @throws ForwardInvalidException
     */</span>
    StateMachineInstance <span class="token function">forward</span><span class="token punctuation">(</span>String stateMachineInstId<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> replaceParams<span class="token punctuation">)</span> <span class="token keyword">throws</span> ForwardInvalidException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * forward restart a failed state machine instance asynchronously
     * @param stateMachineInstId
     * @param replaceParams
     * @param callback
     * @return
     * @throws ForwardInvalidException
     */</span>
    StateMachineInstance <span class="token function">forwardAsync</span><span class="token punctuation">(</span>String stateMachineInstId<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> replaceParams<span class="token punctuation">,</span> AsyncCallback callback<span class="token punctuation">)</span> <span class="token keyword">throws</span> ForwardInvalidException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * compensate a state machine instance
     * @param stateMachineInstId
     * @param replaceParams
     * @return
     * @throws EngineExecutionException
     */</span>
    StateMachineInstance <span class="token function">compensate</span><span class="token punctuation">(</span>String stateMachineInstId<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> replaceParams<span class="token punctuation">)</span> <span class="token keyword">throws</span> EngineExecutionException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * compensate a state machine instance asynchronously
     * @param stateMachineInstId
     * @param replaceParams
     * @param callback
     * @return
     * @throws EngineExecutionException
     */</span>
    StateMachineInstance <span class="token function">compensateAsync</span><span class="token punctuation">(</span>String stateMachineInstId<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> replaceParams<span class="token punctuation">,</span> AsyncCallback callback<span class="token punctuation">)</span> <span class="token keyword">throws</span> EngineExecutionException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * skip current failed state instance and forward restart state machine instance
     * @param stateMachineInstId
     * @return
     * @throws EngineExecutionException
     */</span>
    StateMachineInstance <span class="token function">skipAndForward</span><span class="token punctuation">(</span>String stateMachineInstId<span class="token punctuation">)</span> <span class="token keyword">throws</span> EngineExecutionException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * skip current failed state instance and forward restart state machine instance asynchronously
     * @param stateMachineInstId
     * @param callback
     * @return
     * @throws EngineExecutionException
     */</span>
    StateMachineInstance <span class="token function">skipAndForwardAsync</span><span class="token punctuation">(</span>String stateMachineInstId<span class="token punctuation">,</span> AsyncCallback callback<span class="token punctuation">)</span> <span class="token keyword">throws</span> EngineExecutionException<span class="token punctuation">;</span>

    <span class="token comment">/**
     * get state machine configurations
     * @return
     */</span>
    StateMachineConfig <span class="token function">getStateMachineConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="StateMachine_Execution_Instance_API_173"></a>StateMachine Execution Instance API:</h5> 
<pre><code class="prism language-java">StateLogRepository stateLogRepository <span class="token operator">=</span> stateMachineEngine<span class="token punctuation">.</span><span class="token function">getStateMachineConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStateLogRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
StateMachineInstance stateMachineInstance <span class="token operator">=</span> stateLogRepository<span class="token punctuation">.</span><span class="token function">getStateMachineInstanceByBusinessKey</span><span class="token punctuation">(</span>businessKey<span class="token punctuation">,</span> tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * State Log Repository
 *
 * @author lorne.cl
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StateLogRepository</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * Get state machine instance
     *
     * @param stateMachineInstanceId
     * @return
     */</span>
    StateMachineInstance <span class="token function">getStateMachineInstance</span><span class="token punctuation">(</span>String stateMachineInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Get state machine instance by businessKey
     *
     * @param businessKey
     * @param tenantId
     * @return
     */</span>
    StateMachineInstance <span class="token function">getStateMachineInstanceByBusinessKey</span><span class="token punctuation">(</span>String businessKey<span class="token punctuation">,</span> String tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Query the list of state machine instances by parent id
     *
     * @param parentId
     * @return
     */</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>StateMachineInstance<span class="token punctuation">&gt;</span></span> <span class="token function">queryStateMachineInstanceByParentId</span><span class="token punctuation">(</span>String parentId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Get state instance
     *
     * @param stateInstanceId
     * @param machineInstId
     * @return
     */</span>
    StateInstance <span class="token function">getStateInstance</span><span class="token punctuation">(</span>String stateInstanceId<span class="token punctuation">,</span> String machineInstId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Get a list of state instances by state machine instance id
     *
     * @param stateMachineInstanceId
     * @return
     */</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>StateInstance<span class="token punctuation">&gt;</span></span> <span class="token function">queryStateInstanceListByMachineInstanceId</span><span class="token punctuation">(</span>String stateMachineInstanceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="StateMachine_Definition_API_230"></a>StateMachine Definition API:</h5> 
<pre><code class="prism language-java">StateMachineRepository stateMachineRepository <span class="token operator">=</span> stateMachineEngine<span class="token punctuation">.</span><span class="token function">getStateMachineConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStateMachineRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
StateMachine stateMachine <span class="token operator">=</span> stateMachineRepository<span class="token punctuation">.</span><span class="token function">getStateMachine</span><span class="token punctuation">(</span>stateMachineName<span class="token punctuation">,</span> tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * StateMachineRepository
 *
 * @author lorne.cl
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StateMachineRepository</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * Gets get state machine by id.
     *
     * @param stateMachineId the state machine id
     * @return the get state machine by id
     */</span>
    StateMachine <span class="token function">getStateMachineById</span><span class="token punctuation">(</span>String stateMachineId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Gets get state machine.
     *
     * @param stateMachineName the state machine name
     * @param tenantId         the tenant id
     * @return the get state machine
     */</span>
    StateMachine <span class="token function">getStateMachine</span><span class="token punctuation">(</span>String stateMachineName<span class="token punctuation">,</span> String tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Gets get state machine.
     *
     * @param stateMachineName the state machine name
     * @param tenantId         the tenant id
     * @param version          the version
     * @return the get state machine
     */</span>
    StateMachine <span class="token function">getStateMachine</span><span class="token punctuation">(</span>String stateMachineName<span class="token punctuation">,</span> String tenantId<span class="token punctuation">,</span> String version<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Register the state machine to the repository (if the same version already exists, return the existing version)
     *
     * @param stateMachine
     */</span>
    StateMachine <span class="token function">registryStateMachine</span><span class="token punctuation">(</span>StateMachine stateMachine<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * registry by resources
     *
     * @param resources
     * @param tenantId
     */</span>
    <span class="token keyword">void</span> <span class="token function">registryByResources</span><span class="token punctuation">(</span>Resource<span class="token punctuation">[</span><span class="token punctuation">]</span> resources<span class="token punctuation">,</span> String tenantId<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Config_referance_287"></a>Config referance</h3> 
<h5><a id="Spring_BeanStateMachineEngine_289"></a>在Spring Bean配置文件中配置一个StateMachineEngine</h5> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stateMachineEngine<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.seata.saga.engine.impl.ProcessCtrlStateMachineEngine<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stateMachineConfig<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dbStateMachineConfig<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dbStateMachineConfig<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.seata.saga.engine.config.DbStateMachineConfig<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>resources<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>statelang/*.json<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>enableAsync<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>threadPoolExecutor<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>threadExecutor<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 事件驱动执行时使用的线程池, 如果所有状态机都同步执行可以不需要 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>applicationId<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>saga_sample<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>txServiceGroup<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my_test_tx_group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>threadExecutor<span class="token punctuation">"</span></span>
        <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.scheduling.concurrent.ThreadPoolExecutorFactoryBean<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>threadNamePrefix<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>SAGA_ASYNC_EXE_<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>corePoolSize<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxPoolSize<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- Seata Server进行事务恢复时需要通过这个Holder拿到stateMachineEngine实例 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>io.seata.saga.rm.StateMachineEngineHolder<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stateMachineEngine<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stateMachineEngine<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="State_language_referance_319"></a>State language referance</h3> 
<h4><a id="__321"></a>“状态机” 属性简介:</h4> 
<ul><li>Name: 表示状态机的名称，必须唯一</li><li>Comment: 状态机的描述</li><li>Version: 状态机定义版本</li><li>StartState: 启动时运行的第一个"状态"</li><li>States: 状态列表，是一个map结构，key是"状态"的名称，在状态机内必须唯一</li></ul> 
<h4><a id="__329"></a>“状态” 属性简介:</h4> 
<ul><li>Type: “状态” 的类型，比如有: 
  <ul><li>ServiceTask: 执行调用服务任务</li><li>Choice: 单条件选择路由</li><li>CompensationTrigger: 触发补偿流程</li><li>Succeed: 状态机正常结束</li><li>Fail: 状态机异常结束</li><li>SubStateMachine: 调用子状态机</li><li>CompensateSubMachine: 用于补偿一个子状态机</li></ul> </li><li>ServiceName: 服务名称，通常是服务的beanId</li><li>ServiceMethod: 服务方法名称</li><li>CompensateState: 该"状态"的补偿"状态"</li><li><strong>Input:</strong> <strong>调用服务的输入参数列表, 是一个数组, 对应于服务方法的参数列表, $.表示使用表达式从状态机上下文中取参数，表达使用的<a href="https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html" rel="nofollow">SpringEL</a>, 如果是常量直接写值即可</strong></li><li><strong>Ouput: 将服务返回的参数赋值到状态机上下文中, 是一个map结构，key为放入到状态机上文时的key（状态机上下文也是一个map），value中$.是表示SpringEL表达式，表示从服务的返回参数中取值，#root表示服务的整个返回参数</strong></li><li>Status: 服务执行状态映射，框架定义了三个状态，SU 成功、FA 失败、UN 未知, 我们需要把服务执行的状态映射成这三个状态，帮助框架判断整个事务的一致性，是一个map结构，key是条件表达式，一般是取服务的返回值或抛出的异常进行判断，默认是SpringEL表达式判断服务返回参数，带$Exception{开头表示判断异常类型。value是当这个条件表达式成立时则将服务执行状态映射成这个值</li><li>Catch: 捕获到异常后的路由</li><li>Next: 服务执行完成后下一个执行的"状态"</li><li>Choices: Choice类型的"状态"里, 可选的分支列表, 分支中的Expression为SpringEL表达式, Next为当表达式成立时执行的下一个"状态"</li><li>ErrorCode: Fail类型"状态"的错误码</li><li>Message: Fail类型"状态"的错误信息</li></ul> 
<h4><a id="_351"></a>"状态机"的属性列表</h4> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"reduceInventoryAndBalance"</span><span class="token punctuation">,</span>
    <span class="token string">"Comment"</span><span class="token punctuation">:</span> <span class="token string">"reduce inventory then reduce balance in a transaction"</span><span class="token punctuation">,</span>
    <span class="token string">"StartState"</span><span class="token punctuation">:</span> <span class="token string">"ReduceInventory"</span><span class="token punctuation">,</span>
    <span class="token string">"Version"</span><span class="token punctuation">:</span> <span class="token string">"0.0.1"</span><span class="token punctuation">,</span>
    <span class="token string">"States"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>Name: 表示状态机的名称，必须唯一</li><li>Comment: 状态机的描述</li><li>Version: 状态机定义版本</li><li>StartState: 启动时运行的第一个"状态"</li><li>States: 状态列表，是一个map结构，key是"状态"的名称，在状态机内必须唯一, value是一个map结构表示"状态"的属性列表</li></ul> 
<h4><a id="_370"></a>"状态"的属性列表</h4> 
<h5><a id="ServiceTask_372"></a>ServiceTask:</h5> 
<pre><code class="prism language-json"><span class="token string">"States"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
    <span class="token string">"ReduceBalance"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"Type"</span><span class="token punctuation">:</span> <span class="token string">"ServiceTask"</span><span class="token punctuation">,</span>
        <span class="token string">"ServiceName"</span><span class="token punctuation">:</span> <span class="token string">"balanceAction"</span><span class="token punctuation">,</span>
        <span class="token string">"ServiceMethod"</span><span class="token punctuation">:</span> <span class="token string">"reduce"</span><span class="token punctuation">,</span>
        <span class="token string">"CompensateState"</span><span class="token punctuation">:</span> <span class="token string">"CompensateReduceBalance"</span><span class="token punctuation">,</span>
        <span class="token string">"IsForUpdate"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">"IsPersist"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">"IsAsync"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">"Input"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"$.[businessKey]"</span><span class="token punctuation">,</span>
            <span class="token string">"$.[amount]"</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"throwException"</span> <span class="token punctuation">:</span> <span class="token string">"$.[mockReduceBalanceFail]"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"Output"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"compensateReduceBalanceResult"</span><span class="token punctuation">:</span> <span class="token string">"$.#root"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"Status"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"#root == true"</span><span class="token punctuation">:</span> <span class="token string">"SU"</span><span class="token punctuation">,</span>
            <span class="token string">"#root == false"</span><span class="token punctuation">:</span> <span class="token string">"FA"</span><span class="token punctuation">,</span>
            <span class="token string">"$Exception{java.lang.Throwable}"</span><span class="token punctuation">:</span> <span class="token string">"UN"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"Retry"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"Exceptions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"io.seata.saga.engine.mock.DemoException"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"IntervalSeconds"</span><span class="token punctuation">:</span> <span class="token number">1.5</span><span class="token punctuation">,</span>
                <span class="token string">"MaxAttempts"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string">"BackoffRate"</span><span class="token punctuation">:</span> <span class="token number">1.5</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"IntervalSeconds"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string">"MaxAttempts"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string">"BackoffRate"</span><span class="token punctuation">:</span> <span class="token number">1.5</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"Catch"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"Exceptions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token string">"java.lang.Throwable"</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"Next"</span><span class="token punctuation">:</span> <span class="token string">"CompensationTrigger"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"Next"</span><span class="token punctuation">:</span> <span class="token string">"Succeed"</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>ServiceName: 服务名称，通常是服务的beanId</li><li>ServiceMethod: 服务方法名称</li><li>CompensateState: 该"状态"的补偿"状态"</li><li>IsForUpdate: 标识该服务会更新数据, 默认是false, 如果配置了CompensateState则默认是true, 有补偿服务的服务肯定是数据更新类服务</li><li>IsPersist: 执行日志是否进行存储, 默认是true, 有一些查询类的服务可以配置为false, 执行日志不进行存储提高性能, 因为当异常恢复时可以重复执行</li><li>IsAsync: 异步调用服务, 注意: 因为异步调用服务会忽略服务的返回结果, 所以用户定义的服务执行状态映射(下面的Status属性)将被忽略, 默认为服务调用成功, 如果提交异步调用就失败(比如线程池已满)则为服务执行状态为失败</li><li>Input: 调用服务的输入参数列表, 是一个数组, 对应于服务方法的参数列表, $.表示使用表达式从状态机上下文中取参数，表达使用的<a href="https://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/html/expressions.html" rel="nofollow">SpringEL</a>, 如果是常量直接写值即可。复杂的参数如何传入见:<a href="https://seata.io/zh-cn/docs/user/saga.html#%E5%A4%8D%E6%9D%82%E5%8F%82%E6%95%B0%E7%9A%84Input%E5%AE%9A%E4%B9%89" rel="nofollow">复杂参数的Input定义</a></li><li>Output: 将服务返回的参数赋值到状态机上下文中, 是一个map结构，key为放入到状态机上文时的key（状态机上下文也是一个map），value中$.是表示SpringEL表达式，表示从服务的返回参数中取值，#root表示服务的整个返回参数</li><li>Status: 服务执行状态映射，框架定义了三个状态，SU 成功、FA 失败、UN 未知, 我们需要把服务执行的状态映射成这三个状态，帮助框架判断整个事务的一致性，是一个map结构，key是条件表达式，一般是取服务的返回值或抛出的异常进行判断，默认是SpringEL表达式判断服务返回参数，带$Exception{开头表示判断异常类型。value是当这个条件表达式成立时则将服务执行状态映射成这个值</li><li>Catch: 捕获到异常后的路由</li><li>Retry: 捕获异常后的重试策略, 是个数组可以配置多个规则, <code>Exceptions</code> 为匹配的的异常列表, <code>IntervalSeconds</code> 为重试间隔, <code>MaxAttempts</code> 为最大重试次数, <code>BackoffRate</code> 下一次重试间隔相对于上一次重试间隔的倍数，比如说上次一重试间隔是2秒, <code>BackoffRate=1.5</code> 则下一次重试间隔是3秒。<code>Exceptions</code> 属性可以不配置, 不配置时表示框架自动匹配网络超时异常。当在重试过程中发生了别的异常，框架会重新匹配规则，并按新规则进行重试，同一种规则的总重试次数不会超过该规则的<code>MaxAttempts</code></li><li>Next: 服务执行完成后下一个执行的"状态"</li></ul> 
<blockquote> 
 <p>当没有配置Status对服务执行状态进行映射, 系统会自动判断状态:</p> 
 <ul><li>没有异常则认为执行成功,</li><li>如果有异常, 则判断异常是不是网路连接超时, 如果是则认为是FA</li><li>如果是其它异常, 服务IsForUpdate=true则状态为UN, 否则为FA</li></ul> 
</blockquote> 
<blockquote> 
 <p>整个状态机的执行状态如何判断？是由框架自己判断的, 状态机有两个状态: status(正向执行状态), compensateStatus(补偿状态)：</p> 
 <ul><li>如果所有服务执行成功（事务提交成功）则status=SU, compensateStatus=null</li><li>如果有服务执行失败且存在更新类服务执行成功且没有进行补偿（事务提交失败） 则status=UN, compensateStatus=null</li><li>如果有服务执行失败且不存在更新类服务执行成功且没有进行补偿（事务提交失败） 则status=FA, compensateStatus=null</li><li>如果补偿成功（事务回滚成功）则status=FA/UN, compensateStatus=SU</li><li>发生补偿且有未补偿成功的服务（回滚失败）则status=FA/UN, compensateStatus=UN</li><li>存在事务提交或回滚失败的情况Seata Sever都会不断发起重试</li></ul> 
</blockquote> 
<h5><a id="Choice_455"></a>Choice:</h5> 
<pre><code class="prism language-json"><span class="token string">"ChoiceState"</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"Type"</span><span class="token punctuation">:</span> <span class="token string">"Choice"</span><span class="token punctuation">,</span>
    <span class="token string">"Choices"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Expression"</span><span class="token punctuation">:</span><span class="token string">"[reduceInventoryResult] == true"</span><span class="token punctuation">,</span>
            <span class="token string">"Next"</span><span class="token punctuation">:</span><span class="token string">"ReduceBalance"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"Default"</span><span class="token punctuation">:</span><span class="token string">"Fail"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Choice类型的"状态"是单项选择路由 Choices: 可选的分支列表, 只会选择第一个条件成立的分支 Expression: SpringEL表达式 Next: 当Expression表达式成立时执行的下一个"状态"</p> 
<h5><a id="Succeed_472"></a>Succeed:</h5> 
<pre><code class="prism language-json"><span class="token string">"Succeed"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Type"</span><span class="token punctuation">:</span><span class="token string">"Succeed"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行到"Succeed状态"表示状态机正常结束, 正常结束不代表成功结束, 是否成功要看每个"状态"是否都成功</p> 
<h5><a id="Fail_482"></a>Fail:</h5> 
<pre><code class="prism language-json"><span class="token string">"Fail"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Type"</span><span class="token punctuation">:</span><span class="token string">"Fail"</span><span class="token punctuation">,</span>
    <span class="token string">"ErrorCode"</span><span class="token punctuation">:</span> <span class="token string">"PURCHASE_FAILED"</span><span class="token punctuation">,</span>
    <span class="token string">"Message"</span><span class="token punctuation">:</span> <span class="token string">"purchase failed"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行到"Fail状态"状态机异常结束, 异常结束时可以配置ErrorCode和Message, 表示错误码和错误信息, 可以用于给调用方返回错误码和消息</p> 
<h5><a id="CompensationTrigger_494"></a>CompensationTrigger:</h5> 
<pre><code class="prism language-json"><span class="token string">"CompensationTrigger"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Type"</span><span class="token punctuation">:</span> <span class="token string">"CompensationTrigger"</span><span class="token punctuation">,</span>
    <span class="token string">"Next"</span><span class="token punctuation">:</span> <span class="token string">"Fail"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>CompensationTrigger类型的state是用于触发补偿事件, 回滚分布式事务 Next: 补偿成功后路由到的state</p> 
<h5><a id="SubStateMachine_505"></a>SubStateMachine:</h5> 
<pre><code class="prism language-json"><span class="token string">"CallSubStateMachine"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Type"</span><span class="token punctuation">:</span> <span class="token string">"SubStateMachine"</span><span class="token punctuation">,</span>
    <span class="token string">"StateMachineName"</span><span class="token punctuation">:</span> <span class="token string">"simpleCompensationStateMachine"</span><span class="token punctuation">,</span>
    <span class="token string">"CompensateState"</span><span class="token punctuation">:</span> <span class="token string">"CompensateSubMachine"</span><span class="token punctuation">,</span>
    <span class="token string">"Input"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"a"</span><span class="token punctuation">:</span> <span class="token string">"$.1"</span><span class="token punctuation">,</span>
            <span class="token string">"barThrowException"</span><span class="token punctuation">:</span> <span class="token string">"$.[barThrowException]"</span><span class="token punctuation">,</span>
            <span class="token string">"fooThrowException"</span><span class="token punctuation">:</span> <span class="token string">"$.[fooThrowException]"</span><span class="token punctuation">,</span>
            <span class="token string">"compensateFooThrowException"</span><span class="token punctuation">:</span> <span class="token string">"$.[compensateFooThrowException]"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"Output"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"fooResult"</span><span class="token punctuation">:</span> <span class="token string">"$.#root"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"Next"</span><span class="token punctuation">:</span> <span class="token string">"Succeed"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>SubStateMachine类型的"状态"是调用子状态机 StateMachineName: 要调用的子状态机名称 CompensateState: 子状态机的补偿state, 可以不配置, 系统会自动创建它的补偿state, 子状态机的补偿实际就是调用子状态机的compensate方法, 所以用户并不需要自己实现一个对子状态机的补偿服务。当配置这个属性时, 可以里利用Input属性自定义传入一些变量, 见下面的CompensateSubMachine</p> 
<h5><a id="CompensateSubMachine_529"></a>CompensateSubMachine:</h5> 
<pre><code class="prism language-json"><span class="token string">"CompensateSubMachine"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Type"</span><span class="token punctuation">:</span> <span class="token string">"CompensateSubMachine"</span><span class="token punctuation">,</span>
    <span class="token string">"Input"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"compensateFooThrowException"</span><span class="token punctuation">:</span> <span class="token string">"$.[compensateFooThrowException]"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>CompensateSubMachine类型的state是专门用于补偿一个子状态机的state，它会调用子状态机的compensate方法，可以利用Input属性传入一些自定义的变量, Status属性自定判断补偿是否成功</p> 
<h5><a id="Input_544"></a>复杂参数的Input定义</h5> 
<pre><code class="prism language-json"><span class="token string">"FirstState"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Type"</span><span class="token punctuation">:</span> <span class="token string">"ServiceTask"</span><span class="token punctuation">,</span>
    <span class="token string">"ServiceName"</span><span class="token punctuation">:</span> <span class="token string">"demoService"</span><span class="token punctuation">,</span>
    <span class="token string">"ServiceMethod"</span><span class="token punctuation">:</span> <span class="token string">"complexParameterMethod"</span><span class="token punctuation">,</span>
    <span class="token string">"Next"</span><span class="token punctuation">:</span> <span class="token string">"ChoiceState"</span><span class="token punctuation">,</span>
    <span class="token string">"ParameterTypes"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"java.lang.String"</span><span class="token punctuation">,</span> <span class="token string">"int"</span><span class="token punctuation">,</span> <span class="token string">"io.seata.saga.engine.mock.DemoService$People"</span><span class="token punctuation">,</span> <span class="token string">"[Lio.seata.saga.engine.mock.DemoService$People;"</span><span class="token punctuation">,</span> <span class="token string">"java.util.List"</span><span class="token punctuation">,</span> <span class="token string">"java.util.Map"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"Input"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
        <span class="token string">"$.[people].age"</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
            <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span><span class="token punctuation">,</span>
            <span class="token string">"childrenArray"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
                    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
                    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"childrenList"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
                    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
                    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"childrenMap"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"lilei"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
                    <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
                <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
                <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"@type"</span><span class="token punctuation">:</span> <span class="token string">"io.seata.saga.engine.mock.DemoService$People"</span><span class="token punctuation">,</span>
                <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
                <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"lilei"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"@type"</span><span class="token punctuation">:</span> <span class="token string">"io.seata.saga.engine.mock.DemoService$People"</span><span class="token punctuation">,</span>
                <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].name"</span><span class="token punctuation">,</span>
                <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token string">"$.[people].age"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"Output"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"complexParameterMethodResult"</span><span class="token punctuation">:</span> <span class="token string">"$.#root"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面的complexParameterMethod方法定义如下:</p> 
<pre><code class="prism language-java">People <span class="token function">complexParameterMethod</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">,</span> People people<span class="token punctuation">,</span> People<span class="token punctuation">[</span><span class="token punctuation">]</span> peopleArrya<span class="token punctuation">,</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>People<span class="token punctuation">&gt;</span></span> peopleList<span class="token punctuation">,</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> People<span class="token punctuation">&gt;</span></span> peopleMap<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">People</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span>    age<span class="token punctuation">;</span>

    <span class="token keyword">private</span> People<span class="token punctuation">[</span><span class="token punctuation">]</span> childrenArray<span class="token punctuation">;</span>
    <span class="token keyword">private</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>People<span class="token punctuation">&gt;</span></span> childrenList<span class="token punctuation">;</span>
    <span class="token keyword">private</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> People<span class="token punctuation">&gt;</span></span> childrenMap<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动状态机时传入参数:</p> 
<pre><code class="prism language-java">Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> paramMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
People people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">People</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
people<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"lilei"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
people<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
paramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"people"</span><span class="token punctuation">,</span> people<span class="token punctuation">)</span><span class="token punctuation">;</span>
String stateMachineName <span class="token operator">=</span> <span class="token string">"simpleStateMachineWithComplexParams"</span><span class="token punctuation">;</span>
StateMachineInstance inst <span class="token operator">=</span> stateMachineEngine<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>stateMachineName<span class="token punctuation">,</span> null<span class="token punctuation">,</span> paramMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>注意ParameterTypes属性是可以不用传的，调用的方法的参数列表中有Map, List这种可以带泛型的集合类型, 因为java编译会丢失泛型, 所以需要用这个属性, 同时在Input的json中对应的对这个json加"@type"来申明泛型(集合的元素类型)</p> 
</blockquote> 
<h3><a id="FAQ_651"></a>FAQ</h3> 
<p>在状态里面可以自己捕捉异常，也可以交由状态机捕捉，自己捕捉必须要抛出异常</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cdffd12d8abdb34e18801e2a2d745961/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">interp1函数_matlab自带的插值函数interp1的四种插值方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5b571c511e482f82e676906375a2e72d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java企业级电商 initial总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>