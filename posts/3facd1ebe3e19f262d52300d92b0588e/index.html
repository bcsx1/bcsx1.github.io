<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kubernetes 部署RocketMQ高可用集群 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kubernetes 部署RocketMQ高可用集群" />
<meta property="og:description" content="Kubernetes 部署RocketMQ高可用集群 导言RocketMQ 常用的部署模式如下单 Master 模式多 Master 多 Slave-异步复制模式 离线镜像制作1.安装 Go 1.162.制作 RocketMQ Operator Image获取 RocketMQ Operator制作 RocketMQ Operator Image 3.制作 RocketMQ Broker Image制作 RocketMQ Name Server Image根据官方已有镜像制作离线镜像(和上面的步骤二选一)制作 RocketMQ Console Image 准备单 Master RocketMQ 部署方案涉及的离线镜像单 Master 模式部署思路梳理资源配置清单GitOps部署资源部署资源 (分步式，二选一)部署资源 (一键式，二选一)验证 清理资源 多 Master 多 Slave-异步复制模式部署思路梳理获取 RocketMQ Operator准备资源配置清单部署 RocketMQ Operator (自动)部署 RocketMQ Operator (首选手动)部署 RocketMQ 集群验证清理资源清理 RocketMQ Cluster清理 RocketMQ Operator清理存储卷 扩容 NameServer特别说明扩容 Broker 导言 在网上有很多使用k8s部署rocketmq集群的文章，但是都不能很好的做到高可用集群的扩展和缩容，因此我在部署的时候自己整理了这样一份笔记，并且已经在生产环境使用。
关于RocketMQ，是在Spring Cloud Alibaba 全家桶之下的一款典型的分布式架构下的消息中间件产品，使用异步通信方式和发布订阅的消息传输模型。RocketMQ的基础使用，以及线上会碰到的问题，以及高级用法在这里就不做过多的介绍了，如果是刚入门的同学，可以去看我之前的一篇文章RocketMQ使用详解以及高并发系统实践问题
如果你要Kubernetes 部署RocketMQ高可用集群，那么前提就是你先得有一个k8s的集群环境，至于怎么部署k8s高可用集群，可以参考一下的文章，相信你自己就可以搭建k8s高可用集群" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/3facd1ebe3e19f262d52300d92b0588e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-18T15:39:14+08:00" />
<meta property="article:modified_time" content="2023-09-18T15:39:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kubernetes 部署RocketMQ高可用集群</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Kubernetes 部署RocketMQ高可用集群</h4> 
 <ul><li><a href="#_3" rel="nofollow">导言</a></li><li><ul><li><a href="#RocketMQ__18" rel="nofollow">RocketMQ 常用的部署模式如下</a></li><li><a href="#_Master__32" rel="nofollow">单 Master 模式</a></li><li><a href="#_Master__Slave_37" rel="nofollow">多 Master 多 Slave-异步复制模式</a></li></ul> 
  </li><li><a href="#_50" rel="nofollow">离线镜像制作</a></li><li><ul><li><a href="#1_Go_116_62" rel="nofollow">1.安装 Go 1.16</a></li><li><a href="#2_RocketMQ_Operator_Image_113" rel="nofollow">2.制作 RocketMQ Operator Image</a></li><li><ul><li><a href="#_RocketMQ_Operator_115" rel="nofollow">获取 RocketMQ Operator</a></li><li><a href="#_RocketMQ_Operator_Image_125" rel="nofollow">制作 RocketMQ Operator Image</a></li></ul> 
   </li><li><a href="#3_RocketMQ_Broker_Image_199" rel="nofollow">3.制作 RocketMQ Broker Image</a></li><li><a href="#_RocketMQ_Name_Server_Image_250" rel="nofollow">制作 RocketMQ Name Server Image</a></li><li><a href="#_302" rel="nofollow">根据官方已有镜像制作离线镜像(和上面的步骤二选一)</a></li><li><a href="#_RocketMQ_Console_Image_350" rel="nofollow">制作 RocketMQ Console Image</a></li></ul> 
  </li><li><a href="#_Master_RocketMQ__384" rel="nofollow">准备单 Master RocketMQ 部署方案涉及的离线镜像</a></li><li><a href="#_Master__420" rel="nofollow">单 Master 模式部署</a></li><li><ul><li><a href="#_421" rel="nofollow">思路梳理</a></li><li><a href="#_430" rel="nofollow">资源配置清单</a></li><li><a href="#GitOps_688" rel="nofollow">GitOps</a></li><li><a href="#_712" rel="nofollow">部署资源</a></li><li><ul><li><a href="#__720" rel="nofollow">部署资源 (分步式，二选一)</a></li><li><a href="#__730" rel="nofollow">部署资源 (一键式，二选一)</a></li><li><a href="#_736" rel="nofollow">验证</a></li></ul> 
   </li><li><a href="#_758" rel="nofollow">清理资源</a></li></ul> 
  </li><li><a href="#_Master__Slave_800" rel="nofollow">多 Master 多 Slave-异步复制模式部署</a></li><li><ul><li><a href="#_801" rel="nofollow">思路梳理</a></li><li><a href="#_RocketMQ_Operator_805" rel="nofollow">获取 RocketMQ Operator</a></li><li><a href="#_812" rel="nofollow">准备资源配置清单</a></li><li><a href="#_RocketMQ_Operator__897" rel="nofollow">部署 RocketMQ Operator (自动)</a></li><li><a href="#_RocketMQ_Operator__904" rel="nofollow">部署 RocketMQ Operator (首选手动)</a></li><li><a href="#_RocketMQ__940" rel="nofollow">部署 RocketMQ 集群</a></li><li><a href="#_959" rel="nofollow">验证</a></li><li><a href="#_1005" rel="nofollow">清理资源</a></li><li><ul><li><a href="#_RocketMQ_Cluster_1007" rel="nofollow">清理 RocketMQ Cluster</a></li><li><a href="#_RocketMQ_Operator_1014" rel="nofollow">清理 RocketMQ Operator</a></li><li><a href="#_1026" rel="nofollow">清理存储卷</a></li></ul> 
   </li><li><a href="#_NameServer_1043" rel="nofollow">扩容 NameServer</a></li><li><a href="#_1101" rel="nofollow">特别说明</a></li><li><a href="#_Broker_1104" rel="nofollow">扩容 Broker</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_3"></a>导言</h2> 
<p>在网上有很多使用k8s部署rocketmq集群的文章，但是都不能很好的做到高可用集群的扩展和缩容，因此我在部署的时候自己整理了这样一份笔记，并且已经在生产环境使用。</p> 
<p>关于RocketMQ，是在Spring Cloud Alibaba 全家桶之下的一款典型的分布式架构下的消息中间件产品，使用异步通信方式和发布订阅的消息传输模型。RocketMQ的基础使用，以及线上会碰到的问题，以及高级用法在这里就不做过多的介绍了，如果是刚入门的同学，可以去看我之前的一篇文章<a href="https://blog.csdn.net/weixin_43691942/article/details/123363964?spm=1001.2014.3001.5501">RocketMQ使用详解以及高并发系统实践问题</a></p> 
<p>如果你要Kubernetes 部署RocketMQ高可用集群，那么前提就是你先得有一个k8s的集群环境，至于怎么部署k8s高可用集群，可以参考一下的文章，相信你自己就可以搭建k8s高可用集群<br> <a href="https://kuboard.cn/install/history-k8s/install-k8s-1.22.x.html" rel="nofollow">使用kubeadm安装kubernetes_v1.22.x</a></p> 
<p><a href="https://kuboard.cn/install/install-k8s.html#kuboard-spray" rel="nofollow">使用 KuboardSpray 安装kubernetes_v1.23.1</a></p> 
<h3><a id="RocketMQ__18"></a>RocketMQ 常用的部署模式如下</h3> 
<ul><li>单 Master 模式</li><li>多 Master 无 Slave 模式</li><li>多 Master 多 Slave 模式-异步复制</li><li>多 Master 多 Slave 模式-同步双写</li></ul> 
<p>更多的部署方案详细信息可以参考<a href="https://gitee.com/apache/rocketmq/blob/master/docs/cn/operation.md#%E8%BF%90%E7%BB%B4%E7%AE%A1%E7%90%86" rel="nofollow">官方文档</a>。</p> 
<p>本文重点介绍 单 Master 模式和多 Master 多 Slave-异步复制模式在 K8s 集群上的部署方案</p> 
<h3><a id="_Master__32"></a>单 Master 模式</h3> 
<p><strong>这种部署方式风险较大，仅部署一个 NameServer 和一个 Broker，一旦 Broker 重启或者宕机时，会导致整个服务不可用，不建议线上生产环境使用，仅可以用于开发和测试环境。<br> 部署方案参考官方rocketmq-docker项目中使用的容器化部署方案涉及的镜像、启动方式、定制化配置。</strong></p> 
<h3><a id="_Master__Slave_37"></a>多 Master 多 Slave-异步复制模式</h3> 
<p>每个 Master 配置一个 Slave，有多对 Master-Slave，HA 采用异步复制方式，主备有短暂消息延迟（毫秒级），这种模式的优缺点如下：</p> 
<ul><li>优点：即使磁盘损坏，消息丢失的非常少，且消息实时性不会受影响，同时 Master 宕机后，消费者仍然可以从 Slave 消费，而且此过程对应用透明，不需要人工干预，性能同多 Master 模式几乎一样；</li><li>缺点：Master 宕机，磁盘损坏情况下会丢失少量消息。</li></ul> 
<p><img src="https://images2.imgbox.com/1e/1f/zo4EngR6_o.png" alt="在这里插入图片描述"></p> 
<p>为了方便后续的使用，我们这里采用自己制作镜像，这样可以使得你的配置和集群非常灵活，并且可以根据不同公司不同配置去部署。</p> 
<h2><a id="_50"></a>离线镜像制作</h2> 
<p>本文分别介绍了单 Master 模式和多 Master 多 Slave-异步复制模式部署 RocketMQ 使用的离线镜像的制作方式。</p> 
<ul><li>单 Master 模式直接采用 RocketMQ 官方文档中介绍的容器化部署方案中使用的镜像。</li><li>多 Master 多 Slave-异步复制模式的离线镜像制作方式采用 RocketMQ Operator 官方自带的镜像制作工具制作打包，制作过程中很多包都需要到国外网络下载，但是受限于国外网络访问，默认成功率较低，需要多次尝试或采取特殊手段 ( 懂的都懂)。</li></ul> 
<blockquote> 
 <p>也可以用传统的方式手工的 Pull Docker Hub 上已有的镜像，然后再 Push 到私有镜像仓库。</p> 
</blockquote> 
<h3><a id="1_Go_116_62"></a>1.安装 Go 1.16</h3> 
<p>RocketMQ Operator 自定义镜像制作需要用到 Go 环境，需要先安装配置。<br> 下载 Go 1.16 系列的最新版：</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>opt/
wget https:<span class="token operator">/</span><span class="token operator">/</span>golang<span class="token punctuation">.</span>google<span class="token punctuation">.</span>cn/dl/go1<span class="token punctuation">.</span>16<span class="token punctuation">.</span>15<span class="token punctuation">.</span>linux-amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
</code></pre> 
<p>解压源代码到指定目录：</p> 
<pre><code class="prism language-powershell">tar zxvf go1<span class="token punctuation">.</span>16<span class="token punctuation">.</span>15<span class="token punctuation">.</span>linux-amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">-</span>C <span class="token operator">/</span>usr/local/
</code></pre> 
<p>配置环境变量：</p> 
<pre><code class="prism language-powershell"><span class="token function">cat</span> &gt;&gt; <span class="token operator">/</span>etc/profile<span class="token punctuation">.</span>d/go<span class="token punctuation">.</span>sh &lt;&lt; EOF
<span class="token comment"># go environment</span>
export GOROOT=<span class="token operator">/</span>usr/local/go
export GOPATH=<span class="token operator">/</span>srv/go
export PATH=<span class="token variable">$PATH</span>:<span class="token variable">$GOROOT</span><span class="token operator">/</span>bin:<span class="token variable">$GOPATH</span><span class="token operator">/</span>bin
EOF
</code></pre> 
<blockquote> 
 <p>GOPATH 为工作目录也是代码的存放目录，可以根据自己的习惯配置</p> 
</blockquote> 
<p>配置 Go：</p> 
<pre><code class="prism language-powershell">go env <span class="token operator">-</span>w GO111MODULE=on
go env <span class="token operator">-</span>w GOPROXY=https:<span class="token operator">/</span><span class="token operator">/</span>goproxy<span class="token punctuation">.</span>cn<span class="token punctuation">,</span>direct

</code></pre> 
<p>验证：</p> 
<pre><code class="prism language-powershell">source <span class="token operator">/</span>etc/profile<span class="token punctuation">.</span>d/go<span class="token punctuation">.</span>sh
go verison
</code></pre> 
<h3><a id="2_RocketMQ_Operator_Image_113"></a>2.制作 RocketMQ Operator Image</h3> 
<h4><a id="_RocketMQ_Operator_115"></a>获取 RocketMQ Operator</h4> 
<p>从 Apache 官方 GitHub 仓库获取 rocketmq-operator 代码。</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>srv
git clone <span class="token operator">-</span>b 0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0 https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/apache/rocketmq-operator<span class="token punctuation">.</span>git
</code></pre> 
<h4><a id="_RocketMQ_Operator_Image_125"></a>制作 RocketMQ Operator Image</h4> 
<p>在根目录修改 DockerFile：</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>srv/rocketmq-operator
vi Dockerfile
</code></pre> 
<blockquote> 
 <p>Notice: 构建镜像的过程需访问国外的软件源和镜像仓库，在国内访问有时会受限制，因此可以提前修改为国内的软件源和镜像仓库。<br> 此操作为可选项，如果访问不受限则不需要配置。</p> 
</blockquote> 
<p>必要的修改内容：</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 第 10 行（修改代理地址为国内地址，加速访问）</span>
<span class="token comment"># 修改前</span>
RUN go mod download
<span class="token comment"># 修改后</span>
RUN go env <span class="token operator">-</span>w GOPROXY=https:<span class="token operator">/</span><span class="token operator">/</span>goproxy<span class="token punctuation">.</span>cn<span class="token punctuation">,</span>direct &amp;&amp; go mod download
<span class="token comment"># 第 25 行（修改源地址为国内源）</span>
<span class="token comment"># 修改前</span>
RUN apk add <span class="token operator">--</span>no-cache bash gettext nmap-ncat openssl busybox-extras
<span class="token comment"># 修改后</span>
RUN sed <span class="token operator">-</span>i <span class="token string">'s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g'</span> <span class="token operator">/</span>etc/apk/repositories &amp;&amp; \
apk add <span class="token operator">--</span>no-cache bash gettext nmap-ncat openssl busybox-extras
</code></pre> 
<p>可选的修改内容：</p> 
<pre><code class="prism language-perl"><span class="token comment"># 默认安装的 ROCKETMQ版本为 4.9.4，可以修改为指定版本</span>
<span class="token comment"># 第 28 行，修改 4.9.4</span>
ENV ROCKETMQ_VERSION <span class="token v-string string">4.9.4</span>
</code></pre> 
<p>制作镜像：</p> 
<pre><code class="prism language-powershell">yum install gcc
cd <span class="token operator">/</span>srv/rocketmq-operator
go mod tidy
<span class="token comment">#注意下面的镜像仓库地址改为自己的远程仓库地址</span>
IMAGE_URL=registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
make docker-build IMG=$<span class="token punctuation">{<!-- --></span>IMAGE_URL<span class="token punctuation">}</span>
</code></pre> 
<p>验证镜像构建成功：</p> 
<pre><code class="prism language-powershell">docker images <span class="token punctuation">|</span> grep rocketmq-operator
</code></pre> 
<p>推送镜像：</p> 
<pre><code class="prism language-powershell">make docker-push IMG=$<span class="token punctuation">{<!-- --></span>IMAGE_URL<span class="token punctuation">}</span>
</code></pre> 
<p>清理临时镜像：</p> 
<pre><code class="prism language-powershell">docker rmi registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
</code></pre> 
<h3><a id="3_RocketMQ_Broker_Image_199"></a>3.制作 RocketMQ Broker Image</h3> 
<p>修改 DockerFile(可选)：</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>srv/rocketmq-operator/images/broker/alpine
vi Dockerfile
</code></pre> 
<blockquote> 
 <p>此操作为可选项，主要是为了安装软件加速，如果访问不受限则不需要配置。</p> 
</blockquote> 
<pre><code class="prism language-powershell"><span class="token comment"># 第 20 行（修改源地址为国内源）</span>
<span class="token comment"># 修改前</span>
RUN apk add <span class="token operator">--</span>no-cache bash gettext nmap-ncat openssl busybox-extras
<span class="token comment"># 修改后</span>
RUN sed <span class="token operator">-</span>i <span class="token string">'s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g'</span> <span class="token operator">/</span>etc/apk/repositories &amp;&amp; \
apk add <span class="token operator">--</span>no-cache bash gettext nmap-ncat openssl busybox-extras
</code></pre> 
<p>修改镜像构建脚本build-broker-image.sh:</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'s#apacherocketmq#registry.xxx.com.cn/apacherocketmq#g'</span> build-namesrv-image<span class="token punctuation">.</span>sh
</code></pre> 
<p>构建并推送镜像：</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">.</span><span class="token operator">/</span>build-broker-image<span class="token punctuation">.</span>sh 4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4
</code></pre> 
<p>验证镜像构建成功：</p> 
<pre><code class="prism language-powershell">docker images <span class="token punctuation">|</span> grep rocketmq-broker
</code></pre> 
<p>清理临时镜像：</p> 
<pre><code class="prism language-powershell">docker rmi registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
</code></pre> 
<h3><a id="_RocketMQ_Name_Server_Image_250"></a>制作 RocketMQ Name Server Image</h3> 
<p>修改 DockerFile(可选)：</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>srv/rocketmq-operator/images/namesrv/alpine
vi Dockerfile
</code></pre> 
<blockquote> 
 <p>此操作为可选项，主要是为了安装软件加速，如果访问不受限则不需要配置。</p> 
</blockquote> 
<pre><code class="prism language-powershell"><span class="token comment"># 第 20 行（修改源地址为国内源）</span>
<span class="token comment"># 修改前</span>
RUN apk add <span class="token operator">--</span>no-cache bash gettext nmap-ncat openssl busybox-extras
<span class="token comment"># 修改后</span>
RUN sed <span class="token operator">-</span>i <span class="token string">'s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g'</span> <span class="token operator">/</span>etc/apk/repositories &amp;&amp; \
    apk add <span class="token operator">--</span>no-cache bash gettext nmap-ncat openssl busybox-extras
</code></pre> 
<p>修改镜像构建脚本build-broker-image.sh:</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'s#apacherocketmq#registry.xxx.com.cn/apacherocketmq#g'</span> build-namesrv-image<span class="token punctuation">.</span>sh
</code></pre> 
<p>构建并推送镜像：</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">.</span><span class="token operator">/</span>build-namesrv-image<span class="token punctuation">.</span>sh 4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4
</code></pre> 
<p>验证镜像构建成功：</p> 
<pre><code class="prism language-powershell">docker images <span class="token punctuation">|</span> grep rocketmq-nameserver
</code></pre> 
<p>清理临时镜像：</p> 
<pre><code class="prism language-powershell">docker rmi registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
</code></pre> 
<h3><a id="_302"></a>根据官方已有镜像制作离线镜像(和上面的步骤二选一)</h3> 
<p>上面的 RocketMQ 多 Master 多 Slave-异步复制模式部署方案中用到的离线镜像制作方案更适合于本地修改定制的场景，如果单纯的只想把官方已有镜像不做修改的下载并推送到本地仓库，可以参考下面的方案。</p> 
<p>下载镜像：</p> 
<pre><code class="prism language-powershell">docker pull apache/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker pull apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker pull apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
</code></pre> 
<blockquote> 
 <p>Notice: 官方仓库最新版的镜像是 2 年前的 4.5.0.</p> 
</blockquote> 
<p>重新打 tag：</p> 
<pre><code class="prism language-powershell">docker tag apache/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0-snapshot registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker tag apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0 registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker tag apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0 registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
</code></pre> 
<p>推送到私有镜像仓库：</p> 
<pre><code class="prism language-powershell">docker push registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker push registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker push registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
</code></pre> 
<p>清理临时镜像：</p> 
<pre><code class="prism language-powershell">docker rmi apache/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker rmi apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker rmi apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker rmi registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker rmi registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
docker rmi registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>0-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
</code></pre> 
<h3><a id="_RocketMQ_Console_Image_350"></a>制作 RocketMQ Console Image</h3> 
<p>本文直接拉取官方镜像作为本地离线镜像，如果需要修改内容并重构，可以参考 RocketMQ Console 使用的 <a href="https:github.com/apache/rocketmq-docker/blob/master/image-build/Dockerfile-centos-dashboard" rel="nofollow">官方 Dockerfile</a> Build your own.</p> 
<p>下载镜像：</p> 
<pre><code class="prism language-powershell">docker pull apacherocketmq/rocketmq-console:2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
</code></pre> 
<p>重新打 tag：</p> 
<pre><code class="prism language-powershell">docker tag apacherocketmq/rocketmq-console:2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0 registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-console:2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
</code></pre> 
<p>推送到私有镜像仓库：</p> 
<pre><code class="prism language-powershell">docker push registry<span class="token punctuation">.</span>xxxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-console:2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
</code></pre> 
<p>清理临时镜像：</p> 
<pre><code class="prism language-powershell">docker rmi apacherocketmq/rocketmq-console:2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
docker rmi registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-console:2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
</code></pre> 
<h2><a id="_Master_RocketMQ__384"></a>准备单 Master RocketMQ 部署方案涉及的离线镜像</h2> 
<p>单 Master RocketMQ 部署方案涉及的镜像跟集群模式部署方案采用的 RocketMQ Operator 中使用的镜像不同，在制作离线镜像时，直接从官方镜像库拉取然后重新打 tag，再推送本地镜像仓库。</p> 
<p>二者具体不同说明如下：</p> 
<ul><li>单 Master 方案使用的是 Docker Hub 中 apache 命名空间下的镜像，并且镜像名称不区分 nameserver 和 broker，RocketMQ Operator 使用的是 apacherocketmq 命名空间下的镜像，镜像名称区分 nameserver 和 broker。</li><li>单 Master 方案和 RocketMQ Operator 方案中管理工具使用的镜像也不同，单 Master 方案使用的是 apacherocketmq 命名空间下的 rocketmq-dashboard 镜像，RocketMQ Operator 使用的是 apacherocketmq 命名空间下的 rocketmq-console 镜像。</li></ul> 
<p>具体的离线镜像制作流程如下：</p> 
<p>下载镜像：</p> 
<pre><code class="prism language-powershell">docker pull apache/rocketmq:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4
docker pull apacherocketmq/rocketmq-dashboard:1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
</code></pre> 
<p>重新打 tag</p> 
<pre><code class="prism language-powershell">docker tag apache/rocketmq:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4 registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apache/rocketmq:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4
docker tag apacherocketmq/rocketmq-dashboard:1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0 registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-dashboard:1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
</code></pre> 
<p>推送到私有镜像仓库</p> 
<pre><code class="prism language-powershell">docker push registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apache/rocketmq:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4
docker push registry<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-dashboard:1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
</code></pre> 
<p>清理临时镜像</p> 
<pre><code class="prism language-powershell">docker rmi apache/rocketmq:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4
docker rmi apacherocketmq/rocketmq-dashboard:1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
docker rmi registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apache/rocketmq:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4
docker rmi registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-dashboard:1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
</code></pre> 
<h2><a id="_Master__420"></a>单 Master 模式部署</h2> 
<h3><a id="_421"></a>思路梳理</h3> 
<p>根据 RocketMQ 服务使用的组件，需要部署以下资源</p> 
<ul><li>Broker StatefulSet</li><li>NameServer StatefulSet</li><li>NameServer Cluster Service：内部服务</li><li>Dashboard Deployment</li><li>Dashboard External Service：Dashboard 外部管理用</li><li>ConfigMap：Broker 自定义配置文件</li></ul> 
<h3><a id="_430"></a>资源配置清单</h3> 
<p>参考 GitHub 中 Apache rocketmq-docker项目中介绍的容器化启动示例配置，编写适用于 K8S 的资源配置清单。</p> 
<blockquote> 
 <p>Notice: 每个人技术能力、技术习惯、服务环境有所不同，这里介绍的只是我采用的一种简单方式，并不一定是最优的方案，大家可以根据实际情况编写适合自己的配置。</p> 
</blockquote> 
<p><strong>rocketmq-cm.yaml：</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> xxx
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">BROKER_MEM</span><span class="token punctuation">:</span> <span class="token string">' -Xms2g -Xmx2g -Xmn1g '</span>
  <span class="token key atrule">broker-common.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    brokerClusterName = DefaultCluster
    brokerName = broker<span class="token punctuation">-</span><span class="token number">0</span>
    brokerId = 0
    deleteWhen = 04
    fileReservedTime = 48
    brokerRole = ASYNC_MASTER
    flushDiskType = ASYNC_FLUSH
</code></pre> 
<p><strong>rocketmq-name-service-sts.yaml：</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> xxx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>service
      <span class="token key atrule">name_service_cr</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>service
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>service
        <span class="token key atrule">name_service_cr</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>service
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>time
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime
            <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">''</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>service
          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'registry.zdevops.com.cn/apache/rocketmq:4.9.4'</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /bin/sh
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> mqnamesrv
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span><span class="token number">9876</span>
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9876</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 250m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>namesrv<span class="token punctuation">-</span>storage
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/rocketmq/logs
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logs
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>time
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
      <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>namesrv<span class="token punctuation">-</span>storage
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ReadWriteOnce
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> glusterfs
        <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> <span class="token string">''</span>

<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>server<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> xxx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span><span class="token number">9876</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9876</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9876</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">name_service_cr</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>service
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
</code></pre> 
<p><strong>rocketmq-broker-sts.yaml：</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>0<span class="token punctuation">-</span>master
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> xxx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker
      <span class="token key atrule">broker_cr</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker
        <span class="token key atrule">broker_cr</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>config
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>config
            <span class="token key atrule">items</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> broker<span class="token punctuation">-</span>common.conf
                <span class="token key atrule">path</span><span class="token punctuation">:</span> broker<span class="token punctuation">-</span>common.conf
            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>time
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime
            <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">''</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker
          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'apache/rocketmq:4.9.4'</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /bin/sh
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> mqbroker
            <span class="token punctuation">-</span> <span class="token string">"-c"</span>
            <span class="token punctuation">-</span> /home/rocketmq/conf/broker<span class="token punctuation">-</span>common.conf
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>vip<span class="token punctuation">-</span><span class="token number">10909</span>
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">10909</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>main<span class="token punctuation">-</span><span class="token number">10911</span>
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">10911</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>ha<span class="token punctuation">-</span><span class="token number">10912</span>
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">10912</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NAMESRV_ADDR
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'rocketmq-name-server-service.zdevops:9876'</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> BROKER_MEM
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> BROKER_MEM
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 12Gi
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 250m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2Gi
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>time
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>storage
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/rocketmq/logs
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logs/broker<span class="token punctuation">-</span>0<span class="token punctuation">-</span>master
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>storage
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/rocketmq/store
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> store/broker<span class="token punctuation">-</span>0<span class="token punctuation">-</span>master
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>config
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/rocketmq/conf/broker<span class="token punctuation">-</span>common.conf
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> broker<span class="token punctuation">-</span>common.conf
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
      <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>storage
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ReadWriteOnce
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 8Gi
        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> glusterfs
        <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> <span class="token string">''</span>
</code></pre> 
<p><strong>rocketmq-dashboard.yaml：</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> xxx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>dashboard
          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'registry.xxx.com.cn/apacherocketmq/rocketmq-dashboard:1.0.0'</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span><span class="token number">8080</span>
              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JAVA_OPTS
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token punctuation">&gt;</span><span class="token punctuation">-</span>
                <span class="token punctuation">-</span>Drocketmq.namesrv.addr=rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>server<span class="token punctuation">-</span>service.zdevops<span class="token punctuation">:</span><span class="token number">9876</span>
                <span class="token punctuation">-</span>Dcom.rocketmq.sendMessageWithVIPChannel=false                
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2Gi
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 50m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always

<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> xxx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span><span class="token number">8080</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort

</code></pre> 
<h3><a id="GitOps_688"></a>GitOps</h3> 
<p>本操作为可选项，本人习惯在个人开发服务器上编辑或修改资源配置清单，然后提交到 Git 服务器 (Gitlab、Gitee、GitHub 等)，然后在 k8s 节点上从 Git 服务器拉取资源配置清单并执行，从而实现资源配置清单的版本化管理，简单的实现运维 GitOps。</p> 
<p>本系列文档的所有 k8s 资源配置清单文件，为了演示和操作方便，都放在了统一的 k8s-yaml 仓库中，实际工作中都是一个应用一个 Git 仓库，更便于应用配置的版本控制。</p> 
<p>大家在实际使用中可以忽略本步骤，直接在 k8s 节点上编写资源配置清单并执行，也可以参考我的使用方式，实现简单的 GitOps。</p> 
<p>在个人运维开发服务器上操作：</p> 
<pre><code class="prism language-yaml"><span class="token comment"># 在已有代码仓库创建 rocketmq/single 目录</span>
mkdir <span class="token punctuation">-</span>p rocketmq/single

<span class="token comment"># 编辑资源配置清单</span>
vi rocketmq/single/rocketmq<span class="token punctuation">-</span>cm.yaml
vi rocketmq/single/rocketmq<span class="token punctuation">-</span>name<span class="token punctuation">-</span>service<span class="token punctuation">-</span>sts.yaml
vi rocketmq/single/rocketmq<span class="token punctuation">-</span>broker<span class="token punctuation">-</span>sts.yaml
vi rocketmq/single/rocketmq<span class="token punctuation">-</span>dashboard.yaml

<span class="token comment"># 提交 Git</span>
git add rocketmq
git commit <span class="token punctuation">-</span>am '添加 rocketmq 单节点资源配置清单'
git push
</code></pre> 
<h3><a id="_712"></a>部署资源</h3> 
<p>在 k8s 集群 Master 节点上或是独立的运维管理服务器上操作。<br> 更新镜像仓库代码</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>srv/k8s-yaml
git pull
</code></pre> 
<h4><a id="__720"></a>部署资源 (分步式，二选一)</h4> 
<p>测试环境使用分步单独部署的方式，以便测试资源配置清单的准确性。</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>srv/k8s-yaml
kubectl apply <span class="token operator">-</span>f rocketmq/single/rocketmq-cm<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f rocketmq/single/rocketmq-name-service-sts<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f rocketmq/single/rocketmq-broker-sts<span class="token punctuation">.</span>yaml
kubectl apply <span class="token operator">-</span>f rocketmq/single/rocketmq-dashboard<span class="token punctuation">.</span>yaml
</code></pre> 
<h4><a id="__730"></a>部署资源 (一键式，二选一)</h4> 
<p>实际使用中，可以直接 apply 整个目录，实现一键式自动部署，在正式研发和生产环境中使用目录的方式实现快速部署。</p> 
<pre><code class="prism language-powershell">kubectl apply <span class="token operator">-</span>f rocketmq/single/
</code></pre> 
<h4><a id="_736"></a>验证</h4> 
<p>ConfigMap：</p> 
<pre><code class="prism language-powershell">$ kubectl get cm <span class="token operator">-</span>n xxx

NAME                     <span class="token keyword">DATA</span>   AGE
kube-root-ca<span class="token punctuation">.</span>crt         1      17d
rocketmq-broker-config   2      22s
</code></pre> 
<p>Pods：</p> 
<pre><code class="prism language-powershell">$ kubectl get pods <span class="token operator">-</span>o wide <span class="token operator">-</span>n xxx

NAME                                 READY   STATUS    RESTARTS   AGE   IP               NODE              NOMINATED NODE   READINESS GATES
rocketmq-broker-0-master-0           1/1     Running   0          77s   10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>116<span class="token punctuation">.</span>103   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
rocketmq-dashboard-b5dbb9d88-cwhqc   1/1     Running   0          3s    10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>87<span class="token punctuation">.</span>115    ks-k8s-master-1   &lt;none&gt;           &lt;none&gt;
rocketmq-name-service-0              1/1     Running   0          78s   10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>116<span class="token punctuation">.</span>102   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</code></pre> 
<p>通过浏览器打开 K8S 集群中任意节点的 IP:31080，可以看到 RocketMQ 控制台的管理界面。<br> <img src="https://images2.imgbox.com/9a/91/1ZcC82xA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_758"></a>清理资源</h3> 
<p>卸载 RocketMQ 或是安装失败需要清理后重新安装，可以在 K8S 集群上使用下面的流程清理资源。<br> 清理 StatefulSet：</p> 
<pre><code class="prism language-powershell">kubectl delete sts rocketmq-broker-0-master <span class="token operator">-</span>n xxx
kubectl delete sts rocketmq-name-service <span class="token operator">-</span>n xxx
</code></pre> 
<p>清理 Deployment：</p> 
<pre><code class="prism language-powershell">kubectl delete deployments rocketmq-dashboard <span class="token operator">-</span>n xxx
</code></pre> 
<p>清理 ConfigMap：</p> 
<pre><code class="prism language-powershell">kubectl delete cm rocketmq-broker-config <span class="token operator">-</span>n xxx
</code></pre> 
<p>清理服务：</p> 
<pre><code class="prism language-powershell">kubectl delete svc rocketmq-name-server-service <span class="token operator">-</span>n xxx 
kubectl delete svc rocketmq-dashboard-service <span class="token operator">-</span>n xxx 
</code></pre> 
<p>清理存储卷：</p> 
<pre><code class="prism language-powershell">kubectl delete pvc rocketmq-namesrv-storage-rocketmq-name-service-0 <span class="token operator">-</span>n zdevops
kubectl delete pvc rocketmq-broker-storage-rocketmq-broker-0-master-0 <span class="token operator">-</span>n zdevops
</code></pre> 
<p>当然，也可以利用资源配置清单清理资源，更简单快捷 (存储卷无法自动清理，需要手工清理)。</p> 
<pre><code class="prism language-powershell">$ kubectl delete <span class="token operator">-</span>f rocketmq/single/

statefulset<span class="token punctuation">.</span>apps <span class="token string">"rocketmq-broker-0-master"</span> deleted
configmap <span class="token string">"rocketmq-broker-config"</span> deleted
deployment<span class="token punctuation">.</span>apps <span class="token string">"rocketmq-dashboard"</span> deleted
service <span class="token string">"rocketmq-dashboard-service"</span> deleted
statefulset<span class="token punctuation">.</span>apps <span class="token string">"rocketmq-name-service"</span> deleted
service <span class="token string">"rocketmq-name-server-service"</span> deleted
</code></pre> 
<h2><a id="_Master__Slave_800"></a>多 Master 多 Slave-异步复制模式部署</h2> 
<h3><a id="_801"></a>思路梳理</h3> 
<p>多 Master 多 Slave-异步复制模式的 RocketMQ 部署，使用官方提供的 RocketMQ Operator，部署起来比较快速便捷，扩容也比较方便。</p> 
<p>默认配置会部署 1 个 Master 和 1 个对应的 Slave，部署完成后可以根据需求扩容 Master 和 Slave。</p> 
<h3><a id="_RocketMQ_Operator_805"></a>获取 RocketMQ Operator</h3> 
<pre><code class="prism language-powershell"><span class="token comment"># git 获取代码时指定版本</span>
cd <span class="token operator">/</span>srv 
git clone <span class="token operator">-</span>b 0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0 https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/apache/rocketmq-operator<span class="token punctuation">.</span>git
</code></pre> 
<h3><a id="_812"></a>准备资源配置清单</h3> 
<p>本文演示的资源配置清单都是直接修改 rocketmq-operator 默认的配置，生产环境应根据默认配置修改一套适合自己环境的标准配置文件，并存放于 git 仓库中。</p> 
<p>为 deploy 资源配置清单文件增加或修改命名空间：</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>srv/rocketmq-operator
sed <span class="token operator">-</span>i <span class="token string">'N;8 a \  namespace: xxx'</span> deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_brokers<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'N;8 a \  namespace: xxx'</span> deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_consoles<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'N;8 a \  namespace: xxx'</span> deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_nameservices<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'N;8 a \  namespace: xxx'</span> deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_topictransfers<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'N;18 a \  namespace: xxx'</span> deploy/operator<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'N;18 a \  namespace: xxx'</span> deploy/role_binding<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'s/namespace: default/namespace: xxx/g'</span> deploy/role_binding<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'N;18 a \  namespace: xxx'</span> deploy/service_account<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'N;20 a \  namespace: xxx'</span> deploy/role<span class="token punctuation">.</span>yaml
</code></pre> 
<blockquote> 
 <p>切记此步骤只能执行一次，如果失败了则需要删掉后重新执行。<br> <strong>执行完成后一定要查看一下结果是否符合预期</strong> grep -r zdevops deploy/*。</p> 
</blockquote> 
<p>修改 example 资源配置清单文件中的命名空间</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'s/namespace: default/namespace: xxx/g'</span> example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'N;18 a \  namespace: xxx'</span> example/rocketmq_v1alpha1_cluster_service<span class="token punctuation">.</span>yaml
</code></pre> 
<p>修改镜像地址为内网地址：</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'s#apache/rocketmq-operator:0.3.0#registry.xxx.com.cn/apacherocketmq/rocketmq-operator:0.3.0#g'</span> deploy/operator<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'s#apacherocketmq#registry.xxx.com.cn/apacherocketmq#g'</span> example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml 
</code></pre> 
<p>修改 RocketMQ 版本 (可选)：</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'s/4.5.0/4.9.4/g'</span> example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml
</code></pre> 
<p>修改 NameService 网络模式 (可选)：</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'s/hostNetwork: true/hostNetwork: false/g'</span> example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml 
sed <span class="token operator">-</span>i <span class="token string">'s/dnsPolicy: ClusterFirstWithHostNet/dnsPolicy: ClusterFirst/g'</span> example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml
</code></pre> 
<blockquote> 
 <p>Notice: 官方示例默认配置使用 hostNetwork 模式 , 适用于同时给 K8S 集群内、外应用提供服务 , 实际使用时请根据需求调整 .<br> 个人倾向于禁用 hostNetwork 模式 , 不跟外部应用混用 . 如果需要混用 , 则倾向于在外部独立部署 RocketMQ。</p> 
</blockquote> 
<p>修改 storageClassName 为 glusterfs：</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'s/storageClassName: rocketmq-storage/storageClassName: glusterfs/g'</span> example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'s/storageMode: EmptyDir/storageMode: StorageClass/g'</span> example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml
</code></pre> 
<blockquote> 
 <p>Notice: 演示环境 GlusterFS 存储对应的 storageClassName 为 glusterfs，请根据实际情况修改。</p> 
</blockquote> 
<p>修改 nameServers 为域名的形式：</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'s/nameServers: ""/nameServers: "name-server-service.xxx:9876"/g'</span> example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml
</code></pre> 
<blockquote> 
 <p>Notice: name-server-service.zdevops 是 NameServer service 名称 + 项目名称的组合<br> 默认配置采用 pod [ip:port] 的形式 , 一旦 Pod IP 发生变化 ,Console 就没法管理集群了 , 且 Console 不会自动变更配置，如果设置为空的话可能还会出现随便配置的情况，因此一定要提前修改。</p> 
</blockquote> 
<p>修改 RocketMQ Console 外部访问的 NodePort：</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'s/nodePort: 30000/nodePort: 31080/g'</span> example/rocketmq_v1alpha1_cluster_service<span class="token punctuation">.</span>yaml

</code></pre> 
<blockquote> 
 <p>Notice: 官方示例默认配置端口号为 30000, 实际使用时请根据需求调整。</p> 
</blockquote> 
<p>修改 RocketMQ NameServer 和 Console 的 service 配置：</p> 
<pre><code class="prism language-powershell">sed <span class="token operator">-</span>i <span class="token string">'32,46s/^#//g'</span> example/rocketmq_v1alpha1_cluster_service<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'s/nodePort: 30001/nodePort: 31081/g'</span> example/rocketmq_v1alpha1_cluster_service<span class="token punctuation">.</span>yaml
sed <span class="token operator">-</span>i <span class="token string">'s/namespace: default/namespace: xxx/g'</span> example/rocketmq_v1alpha1_cluster_service<span class="token punctuation">.</span>yaml
</code></pre> 
<blockquote> 
 <p>NameServer 默认使用了 NodePort 的形式，单纯在 K8S 集群内部使用的话，可以修改为集群模式。</p> 
</blockquote> 
<h3><a id="_RocketMQ_Operator__897"></a>部署 RocketMQ Operator (自动)</h3> 
<p>官方介绍的自动部署方法，适用于能连接互联网的环境，部署过程中需要下载 controller-gen 和 kustomize 二进制文件，同时会下载一堆 go 依赖。</p> 
<p>不适合于内网离线环境，这里只是简单介绍，本文重点采用后面的手动部署的方案。</p> 
<p>部署 RocketMQ Operator：<code>make deploy</code></p> 
<h3><a id="_RocketMQ_Operator__904"></a>部署 RocketMQ Operator (首选手动)</h3> 
<p>部署 RocketMQ Operator</p> 
<pre><code class="prism language-powershell">kubectl create <span class="token operator">-</span>f deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_brokers<span class="token punctuation">.</span>yaml
kubectl create <span class="token operator">-</span>f deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_nameservices<span class="token punctuation">.</span>yaml
kubectl create <span class="token operator">-</span>f deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_consoles<span class="token punctuation">.</span>yaml
kubectl create <span class="token operator">-</span>f deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_topictransfers<span class="token punctuation">.</span>yaml
kubectl create <span class="token operator">-</span>f deploy/service_account<span class="token punctuation">.</span>yaml
kubectl create <span class="token operator">-</span>f deploy/role<span class="token punctuation">.</span>yaml
kubectl create <span class="token operator">-</span>f deploy/role_binding<span class="token punctuation">.</span>yaml
kubectl create <span class="token operator">-</span>f deploy/operator<span class="token punctuation">.</span>yaml
</code></pre> 
<p>验证 CRDS：</p> 
<pre><code class="prism language-powershell">$ kubectl get crd <span class="token punctuation">|</span> grep rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org

brokers<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org                           2022-11-09T02:54:52Z
consoles<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org                          2022-11-09T02:54:54Z
nameservices<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org                      2022-11-09T02:54:53Z
topictransfers<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org                    2022-11-09T02:54:54Z
</code></pre> 
<p>验证 RocketMQ Operator：</p> 
<pre><code class="prism language-powershell">$ kubectl get deploy <span class="token operator">-</span>n xxx <span class="token operator">-</span>o wide

NAME                READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                                                           SELECTOR
rocketmq-operator   1/1     1            1           6m46s   manager      registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0   name=rocketmq-operator

$ kubectl get pods <span class="token operator">-</span>n xxx <span class="token operator">-</span>o wide

NAME                                 READY   STATUS    RESTARTS   AGE     IP              NODE              NOMINATED NODE   READINESS GATES
rocketmq-operator-7cc6b48796-htpk8   1/1     Running   0          2m28s   10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>116<span class="token punctuation">.</span>70   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</code></pre> 
<h3><a id="_RocketMQ__940"></a>部署 RocketMQ 集群</h3> 
<p>创建服务：</p> 
<pre><code class="prism language-powershell">$ kubectl apply <span class="token operator">-</span>f example/rocketmq_v1alpha1_cluster_service<span class="token punctuation">.</span>yaml

service/console-service created
service/name-server-service created
</code></pre> 
<p>创建集群：</p> 
<pre><code class="prism language-powershell">$ kubectl apply <span class="token operator">-</span>f example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml

configmap/broker-config created
broker<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org/broker created
nameservice<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org/name-service created
console<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org/console created
</code></pre> 
<h3><a id="_959"></a>验证</h3> 
<p>StatefulSet:</p> 
<pre><code class="prism language-powershell">$ kubectl get sts <span class="token operator">-</span>o wide <span class="token operator">-</span>n xxx

NAME                 READY   AGE   CONTAINERS     IMAGES
broker-0-master      1/1     27s   broker         registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
broker-0-replica-1   1/1     27s   broker         registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
name-service         1/1     27s   name-service   registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
</code></pre> 
<p>Deployment：</p> 
<pre><code class="prism language-powershell">$ kubectl get deploy <span class="token operator">-</span>o wide <span class="token operator">-</span>n xxx

NAME                READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                                                           SELECTOR
console             1/1     1            1           52s     console      registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-console:2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0    app=rocketmq-console
rocketmq-operator   1/1     1            1           4h43m   manager      registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-operator:0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0   name=rocketmq-operator

</code></pre> 
<p>Pod：</p> 
<pre><code class="prism language-powershell">$ kubectl get pods <span class="token operator">-</span>o wide <span class="token operator">-</span>n xxx

NAME                                 READY   STATUS    RESTARTS      AGE     IP              NODE              NOMINATED NODE   READINESS GATES
broker-0-master-0                    1/1     Running   0             47s     10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>87<span class="token punctuation">.</span>24    ks-k8s-master-1   &lt;none&gt;           &lt;none&gt;
broker-0-replica-1-0                 1/1     Running   0             17s     10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>117<span class="token punctuation">.</span>28   ks-k8s-master-0   &lt;none&gt;           &lt;none&gt;
console-8d685798f-5pwct              1/1     Running   0             116s    10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>116<span class="token punctuation">.</span>84   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
name-service-0                       1/1     Running   0             96s     10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>116<span class="token punctuation">.</span>85   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
rocketmq-operator-7cc6b48796-htpk8   1/1     Running   2 <span class="token punctuation">(</span>98s ago<span class="token punctuation">)</span>   4h39m   10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>116<span class="token punctuation">.</span>70   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;

</code></pre> 
<p>Services：</p> 
<pre><code class="prism language-powershell">$ kubectl get svc <span class="token operator">-</span>o wide <span class="token operator">-</span>n zdevops

NAME                                                     <span class="token function">TYPE</span>        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE   SELECTOR
console-service                                          NodePort    10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>38<span class="token punctuation">.</span>15    &lt;none&gt;        8080:31080/TCP   21m   app=rocketmq-console
name-server-service                                      NodePort    10<span class="token punctuation">.</span>233<span class="token punctuation">.</span>56<span class="token punctuation">.</span>238   &lt;none&gt;        9876:31081/TCP   21m   name_service_cr=name-service   
</code></pre> 
<p>通过浏览器打开 K8S 集群中任意节点的 IP:31080，可以看到 RocketMQ 控制台的管理界面。</p> 
<p><img src="https://images2.imgbox.com/0b/ab/N6tAiD9X_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_1005"></a>清理资源</h3> 
<h4><a id="_RocketMQ_Cluster_1007"></a>清理 RocketMQ Cluster</h4> 
<p>部署集群失败或是需要重新部署时，采用下面的顺序清理删除。</p> 
<pre><code class="prism language-powershell">kubectl delete <span class="token operator">-</span>f example/rocketmq_v1alpha1_rocketmq_cluster<span class="token punctuation">.</span>yaml
kubectl delete <span class="token operator">-</span>f example/rocketmq_v1alpha1_cluster_service<span class="token punctuation">.</span>yaml
</code></pre> 
<h4><a id="_RocketMQ_Operator_1014"></a>清理 RocketMQ Operator</h4> 
<pre><code class="prism language-powershell">kubectl delete <span class="token operator">-</span>f deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_brokers<span class="token punctuation">.</span>yaml
kubectl delete <span class="token operator">-</span>f deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_nameservices<span class="token punctuation">.</span>yaml
kubectl delete <span class="token operator">-</span>f deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_consoles<span class="token punctuation">.</span>yaml
kubectl delete <span class="token operator">-</span>f deploy/crds/rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org_topictransfers<span class="token punctuation">.</span>yaml
kubectl delete <span class="token operator">-</span>f deploy/service_account<span class="token punctuation">.</span>yaml
kubectl delete <span class="token operator">-</span>f deploy/role<span class="token punctuation">.</span>yaml
kubectl delete <span class="token operator">-</span>f deploy/role_binding<span class="token punctuation">.</span>yaml
kubectl delete <span class="token operator">-</span>f deploy/operator<span class="token punctuation">.</span>yaml
</code></pre> 
<h4><a id="_1026"></a>清理存储卷</h4> 
<p>需要手工查找 Broker 和 NameServer 相关的存储卷并删除。</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 查找存储卷</span>
$ kubectl get pvc <span class="token operator">-</span>n xxx

NAME                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
broker-storage-broker-0-master-0      Bound    pvc-6a78b573-d72a-47ca-9012-5bc888dfcb0f   8Gi        RWO            glusterfs      3m54s
broker-storage-broker-0-replica-1-0   Bound    pvc-4f096942-505d-4e34-ac7f-b871b9f33df3   8Gi        RWO            glusterfs      3m54s
namesrv-storage-name-service-0        Bound    pvc-2c45a77e-3ca1-4eab-bb57-8374aa9068d3   1Gi        RWO            glusterfs      3m54s

<span class="token comment"># 删除存储卷</span>
kubectl delete pvc namesrv-storage-name-service-0 <span class="token operator">-</span>n xxx
kubectl delete pvc broker-storage-broker-0-master-0 <span class="token operator">-</span>n xxx
kubectl delete pvc broker-storage-broker-0-replica-1-0 <span class="token operator">-</span>n xxx
</code></pre> 
<h3><a id="_NameServer_1043"></a>扩容 NameServer</h3> 
<p>如果当前的 name service 集群规模不能满足您的需求，您可以简单地使用 RocketMQ-Operator 来扩大或缩小 name service 集群的规模。</p> 
<p>扩容 name service 需要编写并执行独立的资源配置清单，参考官方示例Name Server Cluster Scale，并结合自己实际环境的 rocketmq-operator 配置修改。</p> 
<p>Notice: 不要在已部署的资源中直接修改副本数，直接修改不会生效，会被 Operator 干掉。</p> 
<p>编辑扩容 NameServer 资源配置清单<br> rocketmq_v1alpha1_nameservice_cr.yaml：</p> 
<pre><code class="prism language-powershell">apiVersion: rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org/v1alpha1
kind: NameService
metadata:
  name: name-service
  namespace: xxx
spec:
  size: 2
  nameServiceImage: registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
  imagePullPolicy: Always
  hostNetwork: false
  dnsPolicy: ClusterFirst
  resources:
    requests:
      memory: <span class="token string">"512Mi"</span>
      cpu: <span class="token string">"250m"</span>
    limits:
      memory: <span class="token string">"1024Mi"</span>
      cpu: <span class="token string">"500m"</span>
  storageMode: StorageClass
  hostPath: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>rocketmq/nameserver
  volumeClaimTemplates:
    <span class="token operator">-</span> metadata:
        name: namesrv-storage
      spec:
        accessModes:
          <span class="token operator">-</span> ReadWriteOnce
        storageClassName: glusterfs
        resources:
          requests:
            storage: 1Gi
</code></pre> 
<p>执行扩容操作：</p> 
<pre><code class="prism language-powershell">kubectl apply <span class="token operator">-</span>f rocketmq/cluster/rocketmq_v1alpha1_nameservice_cr<span class="token punctuation">.</span>yaml

</code></pre> 
<p>验证 StatefulSet：</p> 
<pre><code class="prism language-powershell">$ kubectl get sts name-service <span class="token operator">-</span>o wide <span class="token operator">-</span>n xxx

NAME           READY   AGE   CONTAINERS     IMAGES
name-service   2/2     16m   name-service   registry<span class="token punctuation">.</span>zdevops<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-nameserver:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
</code></pre> 
<p>别的验证省略了。。。</p> 
<h3><a id="_1101"></a>特别说明</h3> 
<p><strong>NameServer 扩容一定要慎重，在实际验证测试中发现 NameServer 扩容会导致重建已有的除了 Broker-0 的 Master 之外的其他 Broker 的 Master 和 所有的 Slave。按官方文档上的说明，应该是 Operator 通知所有的 Broker 更新 name service list parameters，以便它们可以注册到新的 NameServer Service。<br> 同时，在 allowRestart: true 策略下，Broker 将逐渐更新，因此更新过程也不会被生产者和消费者客户端感知，也就是说理论上不会影响业务(未实际测试)。</strong></p> 
<h3><a id="_Broker_1104"></a>扩容 Broker</h3> 
<p>通常情况下，随着业务的发展，现有的 Broker 集群规模可能不再满足您的业务需求。你可以简单地使用 RocketMQ-Operator 来升级、扩容 Broker 集群。</p> 
<p>扩容 Broker 需要编写并执行独立的资源配置清单，参考官方示例Broker Cluster Scale，并结合自己实际环境的 rocketmq-operator 配置修改。</p> 
<p>编辑扩容 Broker 资源配置清单</p> 
<p>rocketmq_v1alpha1_broker_cr.yaml：</p> 
<pre><code class="prism language-powershell">apiVersion: rocketmq<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>org/v1alpha1
kind: Broker
metadata:
  name: broker
  namespace: xxx
spec:
  size: 2
  nameServers: <span class="token string">"name-server-service.zdevops::9876"</span>
  replicaPerGroup: 1
  brokerImage: registry<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token punctuation">.</span>cn/apacherocketmq/rocketmq-broker:4<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-alpine-operator-0<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
  imagePullPolicy: Always
  resources:
    requests:
      memory: <span class="token string">"2048Mi"</span>
      cpu: <span class="token string">"250m"</span>
    limits:
      memory: <span class="token string">"12288Mi"</span>
      cpu: <span class="token string">"500m"</span>
  allowRestart: true
  storageMode: StorageClass
  hostPath: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>rocketmq/broker
  <span class="token comment"># scalePodName is [Broker name]-[broker group number]-master-0</span>
  scalePodName: broker-0-master-0
  env:
    <span class="token operator">-</span> name: BROKER_MEM
      valueFrom:
        configMapKeyRef:
          name: broker-config
          key: BROKER_MEM
  volumes:
    <span class="token operator">-</span> name: broker-config
      configMap:
        name: broker-config
        items:
          <span class="token operator">-</span> key: broker-common<span class="token punctuation">.</span>conf
            path: broker-common<span class="token punctuation">.</span>conf
  volumeClaimTemplates:
    <span class="token operator">-</span> metadata:
        name: broker-storage
      spec:
        accessModes:
          <span class="token operator">-</span> ReadWriteOnce
        storageClassName: glusterfs
        resources:
          requests:
            storage: 8Gi
</code></pre> 
<blockquote> 
 <p>Notice: 注意重点字段 scalePodName: broker-0-master-0。<br> 选择源 Broker pod，将从其中将主题和订阅信息数据等旧元数据传输到新创建的 Broker。</p> 
</blockquote> 
<p>执行扩容 Broker：</p> 
<pre><code class="prism language-powershell">kubectl apply <span class="token operator">-</span>f rocketmq/cluster/rocketmq_v1alpha1_broker_cr<span class="token punctuation">.</span>yaml

</code></pre> 
<blockquote> 
 <p>Notice: 执行成功后将部署一个新的 Broker Pod 组，同时 Operator 将在启动新 Broker 之前将源 Broker Pod 中的元数据复制到新创建的 Broker Pod 中，因此新 Broker 将重新加载已有的主题和订阅信息。</p> 
</blockquote> 
<p>以上服务我已经在生产环境使用，如有任何问题欢迎留言。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/10f0f7efa92568e89c5ccd7428f86f2c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Nuxt3】Vue3 &#43; Element-plus 打包后报错 @popperjs/core</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bdab2b50eaf7611563dbe78de03fa93f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">pybind11 调用 C&#43;&#43; 函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>