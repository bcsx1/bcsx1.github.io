<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>gitlab CI/CD 持续集成 部署 一文到底 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="gitlab CI/CD 持续集成 部署 一文到底" />
<meta property="og:description" content="gitlab CI/CD (tip: 要了解一下gitlab ci yml的语法 、 shell 脚本 、Liunx的基本命令)
第一部分、准备Linux操作系统 安装Linux操作系统或使用虚拟机 注意是64位 CentOS 7 以上版本
采用虚拟机的时候网络适配器要选择NAT 否则虚拟机每次重启IP地址都会变换 后面需要改很多地方的服务器IP地址
第二部分、在Liunx系统上搭建docker环境 1、使用官方的安装脚本命令 curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun 2、安装后使用命令 systemctl start docker 启动docker
3、使用命令 systemctl status docker 查看docker状态（绿色为正在运行）
4、安装所需要的软件包 sudo yum install -y yum-utils device-mapper-persistent-data lvm2
5、配置阿里云的镜像仓库进行加速
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo 6、重新启动docker 7、运行 docker run hello-world 阿里云镜像配置成功情况如下图
可能会出现运行 docker run hello-world 后长时间停留在 Unable to find image &#39;hello-world:latest&#39; locally 不往下进行 需要Ctrl&#43;C 进行退出 现在阿里云镜像可能没有配置成功 需要手动配置一下" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/6af7d3ab8cac8e0113d6967531a83a5d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-10T20:00:40+08:00" />
<meta property="article:modified_time" content="2022-09-10T20:00:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">gitlab CI/CD 持续集成 部署 一文到底</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 style="margin-left:.0001pt;text-align:center;">gitlab CI/CD</h2> 
<p>(tip: 要了解一下gitlab ci yml的语法 、 shell 脚本 、Liunx的基本命令)</p> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第一部分、准备Linux操作系统</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">  安装Linux操作系统或使用虚拟机 注意是<strong>64位 CentOS 7 以上版本</strong></p> 
<p style="margin-left:.0001pt;text-align:left;">  采用虚拟机的时候网络适配器要选择NAT 否则虚拟机每次重启IP地址都会变换 后面需要改很多地方的服务器IP地址</p> 
<p class="img-center"><img alt="" height="283" src="https://images2.imgbox.com/c7/22/Q0XMlLct_o.png" width="392"></p> 
<p></p> 
<p style="margin-left:.0001pt;text-align:center;"></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第二部分、在Liunx系统上搭建docker环境</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">  1、使用官方的安装脚本命令 <strong>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</strong>  </p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="560" src="https://images2.imgbox.com/e8/78/6sgvX9S7_o.png" width="958"></p> 
<p>2、安装后使用命令 <strong>systemctl start docker </strong>启动docker</p> 
<p style="margin-left:.0001pt;text-align:left;">3、使用命令 <strong>systemctl status docker </strong>查看docker状态（绿色为正在运行）</p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="437" src="https://images2.imgbox.com/92/46/mKtiiCgX_o.png" width="960"></p> 
<p> 4、安装所需要的软件包 <strong>sudo yum install -y yum-utils device-mapper-persistent-data lvm2</strong></p> 
<p><img alt="" height="183" src="https://images2.imgbox.com/47/de/NeiVAei7_o.png" width="966">5、配置阿里云的镜像仓库进行加速</p> 
<p><strong>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</strong> </p> 
<p><img alt="" height="138" src="https://images2.imgbox.com/7a/51/TzGjlivz_o.png" width="964"></p> 
<p>6、重新启动docker  </p> 
<p>7、运行 <strong>docker run hello-world</strong>  阿里云镜像配置成功情况如下图</p> 
<p><img alt="" height="518" src="https://images2.imgbox.com/32/9e/iqtrlTmB_o.png" width="967"></p> 
<p>可能会出现运行 docker run hello-world 后长时间停留在<strong> Unable to find image 'hello-world:latest' locally</strong> 不往下进行 需要Ctrl+C 进行退出 现在阿里云镜像可能没有配置成功 需要手动配置一下</p> 
<p>使用命令：</p> 
<pre><code class="language-bash">cd /etc/docker
touch daemon.json   （创建一个空文件）
chmod 777 daemon.json  （设置文件权限）
vi daemon.json</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">进入daemon.json 后输入</p> 
<p style="margin-left:.0001pt;text-align:left;">{<!-- --></p> 
<p style="margin-left:.0001pt;text-align:left;"> "registry-mirrors": ["https://<span style="background-color:#f76964;"><span style="color:#2ea121;">77bpaouo</span></span>.mirror.aliyuncs.com"]</p> 
<p style="margin-left:.0001pt;text-align:left;">}</p> 
<p style="margin-left:.0001pt;text-align:left;"><strong>注意：标红部分(77bpaouo)需要到阿里云申请加速地址 网址:https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</strong></p> 
<p class="img-center"><img alt="" height="846" src="https://images2.imgbox.com/5b/2c/uKFEEFTK_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;"> 修改完毕后 ESC   :wq 退出</p> 
<p style="margin-left:.0001pt;text-align:left;">重启docker  <strong>systemctl restart docker</strong></p> 
<p style="margin-left:.0001pt;text-align:left;">重新尝试运行hello-world</p> 
<p style="margin-left:.0001pt;text-align:left;">8、<strong>docker images</strong> 查看docker已经存在的镜像</p> 
<p class="img-center"><img alt="" height="37" src="https://images2.imgbox.com/14/35/lhfwMUm4_o.png" width="564"></p> 
<p style="margin-left:.0001pt;text-align:left;">9、尝试拉取docker镜像（以tomcat为例）</p> 
<p style="margin-left:.0001pt;text-align:left;">  <strong>docker search tomca</strong>t 查看tomcat 云端docker镜像</p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="707" src="https://images2.imgbox.com/c3/13/H46EeRfS_o.png" width="968"></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong>docker pull tomcat </strong>拉取云端tomcat镜像</p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="306" src="https://images2.imgbox.com/25/27/4pOBepwK_o.png" width="720"></p> 
<p style="margin-left:.0001pt;text-align:left;">拉取时间过长的情况下 考虑一下阿里云配置失败</p> 
<p style="margin-left:.0001pt;text-align:left;">拉取完成后 查看docker本地镜像 tomcat是否已经存在</p> 
<p style="margin-left:.0001pt;text-align:center;"></p> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="77" src="https://images2.imgbox.com/66/bd/zMNxxbYo_o.png" width="965"></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第三部分、在docker上配置gitlab和gitlab-runner</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">1、拉取gitlab镜像<strong> docker pull gitlab/gitlab-ce</strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="263" src="https://images2.imgbox.com/a4/e3/9bakRnbo_o.png" width="725"></p> 
<p style="margin-left:.0001pt;text-align:left;">2、查看docker本地镜像库 <strong>docker images</strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="101" src="https://images2.imgbox.com/07/92/ODK1lZrF_o.png" width="633"></p> 
<p style="margin-left:.0001pt;text-align:left;">3、后台运行gitlab镜像 <strong>docker run -d -p 8080:8080 gitlab/gitlab-ce</strong></p> 
<p style="margin-left:.0001pt;text-align:left;">4、查看docker运行状态 <strong>docker ps</strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="99" src="https://images2.imgbox.com/1b/74/we0BZaDi_o.png" width="964"></p> 
<p style="margin-left:.0001pt;text-align:left;">5、拉取gitlab-runner 镜像  <strong>docker pull gitlab/gitlab-runne</strong>r</p> 
<p style="margin-left:.0001pt;"><img alt="" height="176" src="https://images2.imgbox.com/40/0c/mXvTufVP_o.png" width="965"> 6、启动gitlab-runner镜像</p> 
<pre><code class="language-bash">docker run -d --name gitlab-runner --restart always \
  -v /opt/data/gitlab-runner/config:/etc/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner</code></pre> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第四部分、拉起本地gitlab服务器</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">1、<strong>docker container ls -a</strong> 查看docker内的容器</p> 
<p style="margin-left:.0001pt;text-align:left;">2、<strong>docker stop 容器ID</strong> <strong>docker rm 容器ID</strong>  清除容器防止启动ID冲突</p> 
<p style="margin-left:.0001pt;text-align:left;">3、</p> 
<pre><code class="language-bash">sudo docker run --detach \
       --publish 10022:22 --publish 80:80 --publish 443:443 \
       --name gitlab\
       --restart always \
       --volume /data/gitlab/config:/etc/gitlab \
       --volume /data/gitlab/logs:/var/log/gitlab \
       --volume /data/gitlab/data:/var/opt/gitlab \
       gitlab/gitlab-ce</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">启动gitlab服务</p> 
<p style="margin-left:.0001pt;text-align:left;"><strong>要尽可能大的给gitlab服务分配内存空间</strong>  内存空间过小服务启动不起来 访问网址会响应不到 502</p> 
<p style="margin-left:.0001pt;text-align:left;">本次虚拟机上分配的是3G内存</p> 
<p style="margin-left:.0001pt;text-align:left;">4、<strong>ifconfig</strong>查看网络地址</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="356" src="https://images2.imgbox.com/78/5a/86pM1TV0_o.png" width="703"></p> 
<p> 5、浏览器地址访问 （192.168.40.129）</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="622" src="https://images2.imgbox.com/09/20/hignLrZu_o.png" width="1200"></p> 
<p></p> 
<p style="margin-left:.0001pt;text-align:left;">6、初始化管理员账号密码</p> 
<p style="margin-left:.0001pt;text-align:left;">   （1）查看gitlab/gitlab-ce镜像的容器ID   </p> 
<p style="margin-left:.0001pt;text-align:left;">          <strong>docker container ls -a </strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="98" src="https://images2.imgbox.com/8e/23/kms5BLiZ_o.png" width="1149"></p> 
<p>        或者  <strong>docker ps</strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="99" src="https://images2.imgbox.com/71/2e/RGMu2T5d_o.png" width="1137"></p> 
<p style="margin-left:.0001pt;text-align:left;">   （2）进入gitlab控制台   </p> 
<p style="margin-left:.0001pt;text-align:left;">        <strong> docker exec -it </strong><strong><span style="background-color:#f76964;">d004ced4439c</span></strong><strong> bash       </strong>（标红部分为容器ID）</p> 
<p style="margin-left:.0001pt;text-align:left;">       <strong>  gitlab-rails console -e production</strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="170" src="https://images2.imgbox.com/e1/d3/TBHAyHxc_o.png" width="771"></p> 
<p style="margin-left:.0001pt;text-align:left;">   （3）进入gitlab镜像的root账号</p> 
<p style="margin-left:.0001pt;text-align:left;">          <strong>user = User.where(username:"root").first</strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="40" src="https://images2.imgbox.com/28/98/cBeVRJFP_o.png" width="554"></p> 
<p style="margin-left:.0001pt;text-align:left;">   （4）设置root账号密码</p> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">Bash</span><br><strong>user.password ="12345678"</strong><br><strong>user.password_confirmation="12345678"</strong><br><strong>user.save</strong></p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:left;">      (注意密码长度至少八位)</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="120" src="https://images2.imgbox.com/01/57/8a0KLN69_o.png" width="540"></p> 
<p class="img-center"><img alt="" height="114" src="https://images2.imgbox.com/b7/c6/NNYUF1Qh_o.png" width="519"></p> 
<p><strong>      exit</strong></p> 
<p style="margin-left:.0001pt;text-align:left;">  （5）尝试用root账号登陆</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="756" src="https://images2.imgbox.com/34/6f/LYTMgjPI_o.png" width="1200"></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第五部分、gitlab-runner注册到gitlab</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">1、启动 gitlab 和 gitlab-runner 镜像</p> 
<p style="margin-left:.0001pt;text-align:left;">2、注册gitlab-runner  <strong>docker exec -it gitlab-runner gitlab-ci-multi-runner register</strong></p> 
<p style="margin-left:.0001pt;"><img alt="" height="384" src="https://images2.imgbox.com/b2/fd/3Q1tFmz9_o.png" width="1151"> 标红的两个参数很重要   在gitlab项目中的 Setting-&gt;CI/DI-&gt;Runners-&gt;</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="511" src="https://images2.imgbox.com/7f/40/UrdnNagW_o.png" width="569"></p> 
<p style="margin-left:.0001pt;text-align:left;">3、注册成功后 在runner会有显示</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="203" src="https://images2.imgbox.com/e6/88/WxsSH12G_o.png" width="567"></p> 
<p style="margin-left:.0001pt;text-align:left;">编辑runner</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="638" src="https://images2.imgbox.com/98/85/DNqzjnUI_o.png" width="1200"></p> 
<p></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第六部分、核对克隆地址是否有效</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">  这种地址就是无效情况  不是虚拟机的内部地址</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="382" src="https://images2.imgbox.com/42/ab/l43h41OT_o.png" width="433"></p> 
<p>进入docker  gitlab/gitlab-ce 容器内部 <strong> docker exec -it 容器ID /bin/bash </strong></p> 
<p style="margin-left:.0001pt;text-align:left;">进入到gitlab.rb文件  <strong>  vi /etc/gitlab/gitlab.rb</strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="224" src="https://images2.imgbox.com/fd/ef/yWWHjkPT_o.png" width="967"></p> 
<p> 修改标红部分引号里的地址（此处已经修改完毕）</p> 
<p style="margin-left:.0001pt;text-align:left;">退出容器重新启动 gitlab/gitlab-ce  <strong>docker restart 容器ID</strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="378" src="https://images2.imgbox.com/37/ad/RVuccYcX_o.png" width="427"></p> 
<p></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第七部分、编写流水线脚本</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">.gitlab-ci.yml文件属性</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="1093" src="https://images2.imgbox.com/89/cd/OvtKkw7V_o.png" width="811"></p> 
<p style="margin-left:.0001pt;text-align:left;">.gitlab-ci.yml 内容：  注意修改参数</p> 
<pre><code class="language-XML">workflow:
    rules:
        - if: $CI_COMMIT_BRANCH != "master" &amp;&amp; $CI_PIPELINE_SOURCE != "merge_request_event"
          when: never
        - when: always
# 定义一些变量, 下面各阶段会使用
variables:
#服务器地址
  server_ip: 192.168.40.129
  jar_name: demo-0.0.1-SNAPSHOT.jar
  java_path: /usr/local/java1.8/bin
  upload_path: /usr/local/gitlab-project
# 定义执行的各个阶段及顺序
stages:
  - code_check
  - test
  - build_upload
  - deploy
#代码审查
check_code_Job:
  #所在阶段
  stage: code_check
  script:
    - echo "code Check ...."
#单元测试
unit_test_Job:
  #所需镜像
  image: maven:3.5.3-jdk-8
  stage: test
  script:
    - echo 'unit test code ....'
    - mvn test
# 使用 maven 镜像打包
JAVA_maven_build_Job:
  stage: build_upload
  image: maven:3.5.3-jdk-8
  script:
     - echo "building code...."
     - mvn clean package -Dmaven.test.skip=true
  #保存再gitlab服务器默认时长一个月
  artifacts:
    paths:
      - target/$jar_name
#项目上传至服务器
JAR_SHELL_upload_Job:   
   stage: build_upload
   #所依赖的job  依赖的job不成功则不执行
   needs:
     - JAVA_maven_build_Job
   image: ictu/sshpass
   script:
    - echo "uploading code...."
    #上传JAR包
    - sshpass -p 服务器密码 scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no target/$jar_name root@$server_ip:$upload_path/$jar_name
    #上传热部署脚本
    - sshpass -p 服务器密码 scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no reploy_jar.sh root@$server_ip:$upload_path/reploy_jar.sh
# 启动 SpringBoot jar包
deploy_Jar_Job:
  stage: deploy
  image: ictu/sshpass
  script:
     #执行服务器热部署脚本  第一次会失败到服务器上给脚本开权限 chmod 777 XXXX
     - sshpass -p 服务器密码 ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no root@$server_ip $upload_path/./reploy_jar.sh restart</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">自动部署shell脚本 需要放在目标服务器上 reploy_jar.sh  注意修改参数</p> 
<pre><code class="language-bash">#!/bin/bash

export PATH=/usr/java/jdk1.8.0_341/bin:$PATH
#这里可替换为你自己的执行程序，其他代码无需更改
APP_NAME=demo-0.0.1-SNAPSHOT.jar
APP_PATH=/usr/local/gitlab-project
#使用说明，用来提示输入参数
usage() {
 echo "Usage: sh restart.sh [start|stop|restart|status]"
 exit 1
}
 
#检查程序是否在运行
is_exist(){
 pid=`ps -ef|grep $APP_NAME|grep -v grep|awk '{print $2}' `
 #如果不存在返回1，存在返回0
 if [ -z "${pid}" ]; then
 return 1
 else
 return 0
 fi
}
 
#启动方法
start(){
 is_exist
 if [ $? -eq "0" ]; then
 echo "${APP_NAME} is already running. pid=${pid} ."
 else
 nohup java -jar ${APP_PATH}/${APP_NAME} &gt; ${APP_PATH}/websocketserverlog_admin.file 2&gt;&amp;1 &amp;
 echo "${APP_NAME} start success"
 fi
}
 
#停止方法
stop(){
 is_exist
 if [ $? -eq "0" ]; then
 kill -9 $pid
 else
 echo "${APP_NAME} is not running"
 fi
}
 
#输出运行状态
status(){
 is_exist
 if [ $? -eq "0" ]; then
 echo "${APP_NAME} is running. Pid is ${pid}"
 else
 echo "${APP_NAME} is NOT running."
 fi
}
 
#重启
restart(){
 stop
 start
}
 
#根据输入参数，选择执行对应方法，不输入则执行使用说明
case "$1" in
 "start")
 start
 ;;
 "stop")
 stop
 ;;
 "status")
 status
 ;;
 "restart")
 restart
 ;;
 *)
 usage
 ;;
esac</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">执行shell脚本出现下面异常是因为windows（\r\n）和linux换行符不同导致的(\n)</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="42" src="https://images2.imgbox.com/e0/37/uolHyaUm_o.png" width="637"></p> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">Shell</span><br> sed 's/\r//' -i 脚本名称</p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:left;">测试项目本次采用的是gitlab仓库的Spring模板项目</p> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第八部分、部署GITLAB分布式缓存（S3协议采用minio）</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;"> artifacts 和 cache 见：https://blog.csdn.net/pxiongw/article/details/123308800</p> 
<pre><code class="language-bash"># 下载MinIO
sudo docker pull minio/minio:RELEASE.2022-02-12T00-51-25Z
 
# 启动MinIO
# 账号：MINIO_ROOT_USER=minioroot，密码：MINIO_ROOT_PASSWORD=minioroot
# 9001是网页的端口，9000是接口的端口
sudo docker run \
  -d \
  --name minio \
  --restart=always \
  -p 9000:9000 \
  -p 9001:9001 \
  -e "MINIO_ROOT_USER=minioroot" \
  -e "MINIO_ROOT_PASSWORD=minioroot" \
  -v /home/yyp/minio/data:/data \
  -v /home/yyp/minio/config:/root/.minio \
  minio/minio:RELEASE.2022-02-12T00-51-25Z server /data --console-address ":9001"
 
# 查看安装日志
sudo docker logs minio
 
# 出现以下信息说明安装成功
API: http://172.17.0.2:9000  http://127.0.0.1:9000
Console: http://172.17.0.2:9001 http://127.0.0.1:9001
Documentation: https://docs.min.io</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">创建一个bucket</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="636" src="https://images2.imgbox.com/63/ba/ZX2HaXyB_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;">创建一个服务器账户</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="636" src="https://images2.imgbox.com/58/43/C1LGnPH9_o.png" width="1200"></p> 
<p></p> 
<p style="margin-left:.0001pt;text-align:left;">修改gitlab-runner配置文件config.toml     在容器中 etc/gitlab-runner文件夹下可以查看 (liunx系统下 /opt/data/gitlab-runner/config  本次是在修改)</p> 
<pre><code class="language-bash">SQL
  [[runners]]
     #日志输出大小限制  默认是4096  可以不添加
     output_limit = 8192
   
   [runners.cache]
    Type = "s3"  #协议
    Path = "cache"  #buckets下的文件夹
    Shared = true   #是否共享
    [runners.cache.s3]
      ServerAddress = "192.168.40.131:9000"  #minio服务器地址
      AccessKey = "I91PSUUQNUBUE11SQHK2"     #账号
      SecretKey = "UZ8LwaJRq3+DuRCg0w3sQWZ8TlYVSomgcslfMuPz"  #密码
      BucketName = "gitlabcache"   
      Insecure = true  #HTTP
      
  [runners.docker] #经过测试后不加也可以
    volumes = ["/cache","/run/docker.sock:/run/docker.sock"] #修改此项其余都是默认值</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">更新.gitlab-ci.yml文件  几个重要部分</p> 
<pre><code class="language-XML">YAML
variables:
  #远程服务器pom缓存参数
  DOCKER_DRIVER: overlay2
  MAVEN_CLI_OPTS: "-s .m2/settings.xml --batch-mode"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
 cache:
  paths:
    #project目标文件
    - target/
    #project 依赖
    - .m2/repository/</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">分布式缓存没采用之前</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="171" src="https://images2.imgbox.com/01/58/rWh5a1Jw_o.png" width="789"></p> 
<p style="margin-left:.0001pt;text-align:left;">分布式缓存采用之后</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="171" src="https://images2.imgbox.com/7a/8f/M6oNeBy8_o.png" width="782"></p> 
<p style="margin-left:.0001pt;text-align:left;">采用缓存之后的.gitlab-ci.yml文件</p> 
<pre><code class="language-XML">workflow:
    rules:
        - if: $CI_COMMIT_BRANCH != "master" &amp;&amp; $CI_PIPELINE_SOURCE != "merge_request_event"
          when: never
        - when: always
# 定义一些变量, 下面各阶段会使用
variables:
  #服务器
  server_ip: 192.168.40.131
  jar_name: demo-0.0.1-SNAPSHOT.jar
  java_path: /usr/local/java1.8/bin
  upload_path: /usr/local/gitlab-project
  #远程服务器pom缓存参数
  DOCKER_DRIVER: overlay2
  MAVEN_CLI_OPTS: "-s .m2/settings.xml --batch-mode"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
#缓存
cache:
  paths:
    #project目标文件
    - target/
    #project 依赖
    - .m2/repository/
# 定义执行的各个阶段及顺序
stages:
  - code_check
  - test_build_upload
  - deploy
#代码审查
check_code_Job:
  stage: code_check
  before_script:
    - echo "=====&gt;&gt; 静态代码审查 &lt;&lt;====="
  script:
    - echo "check....."
    
#单元测试
unit_test_Job:
  image: maven:3.5.3-jdk-8
  stage: test_build_upload
  before_script:
    - echo '=====&gt;&gt; 代码单元测试 &lt;&lt;====='
  script:
    - mvn surefire-report:report -DshowSuccess=false
# 使用 maven 镜像打包
JAVA_maven_build_Job:
  stage: test_build_upload
  image: maven:3.5.3-jdk-8
  needs:
    - unit_test_Job
  only:
    - master
  before_script:
     - echo "=====&gt;&gt; 项目开始打包 &lt;&lt;====="
  script:
     - mvn clean package -Dmaven.test.skip=true
  artifacts:
    paths:
      - target/$jar_name
#项目上传至服务器
JAR_SHELL_upload_Job:   
   stage: test_build_upload
   needs:
     - unit_test_Job
     - JAVA_maven_build_Job
   only:
    - master
   image: ictu/sshpass
   before_script:
     - echo "=====&gt;&gt; 项目开始打包 &lt;&lt;====="
   script:
    #上传JAR包
    - sshpass -p 服务器密码 scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no target/$jar_name root@$server_ip:$upload_path/$jar_name
    #上传热部署脚本
    - sshpass -p 服务器密码 scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no reploy_jar.sh root@$server_ip:$upload_path/reploy_jar.sh
# 启动 SpringBoot jar包
deploy_Jar_Job:
  stage: deploy
  image: ictu/sshpass
  only:
    - master
  before_script:
     - echo "=====&gt;&gt; 项目开始热部署 &lt;&lt;====="
  script:
     #执行服务器热部署脚本
     - sshpass -p 服务器密码 ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no root@$server_ip  $upload_path/./reploy_jar.sh restart</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">配置分布式缓存的单个gitlab-runner</p> 
<pre><code class="language-bash">[[runners]]
  name = "newrun"
  url = "http://192.168.40.131/"
  id = 9
  token = "s2HaoJP18QLXHNP6uXsB"
  token_obtained_at = 2022-08-29T07:02:35Z
  token_expires_at = 0001-01-01T00:00:00Z
  executor = "docker"
  [runners.custom_build_dir]
   [runners.cache]
    Type = "s3"
    Path = "cache"
    Shared = true
    [runners.cache.s3]
      ServerAddress = "192.168.40.131:9000"
      AccessKey = "I91PSUUQNUBUE11SQHK2"
      SecretKey = "UZ8LwaJRq3+DuRCg0w3sQWZ8TlYVSomgcslfMuPz"
      BucketName = "gitlabcache"
      Insecure = true
  [runners.docker]
    tls_verify = false
    image = "maven"
    privileged = false
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = ["/cache","/run/docker.sock:/run/docker.sock"]#标红部分 在gitlab上构建docker必须添加
    shm_size = 0</code></pre> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第九部分、gitlab-runner job拉取新镜像优化</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">在gitlab-runner的config.toml 的runner配置添加下面的参数</p> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">YAML</span><br>  [runners.docker]<br>     pull_policy="if-not-present"</p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:left;">优化前</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="111" src="https://images2.imgbox.com/32/44/yk1UVZKP_o.png" width="980"></p> 
<p> 优化后</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="133" src="https://images2.imgbox.com/69/f4/Gf8cmHXq_o.png" width="982"></p> 
<p>经过配置分布式缓存和不拉取新镜像后项目pipeline时长对比</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="97" src="https://images2.imgbox.com/7a/0d/2ry381gd_o.png" width="1200"></p> 
<p><img alt="" height="107" src="https://images2.imgbox.com/63/51/fh1FAeSy_o.png" width="1200"></p> 
<p><img alt="" height="101" src="https://images2.imgbox.com/80/84/DQtaF8lF_o.png" width="1200"></p> 
<p></p> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第十部分、把项目打包成jar改造成打包成docker镜像部署运行（命令）</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">准备项目的dockerfile文件</p> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">Dockerfile</span><br> #基础镜像通过java8来的FROM<br> maven:3.5.3-jdk-8<br> #将当前文件中所有*.jar  拷贝到项目的app.jar中（这个app.jar是自己生成的）<br> COPY *.jar /app.jar<br> #映射地址CMD<br> ["--server.prot=8080"]<br> #暴露端口<br> EXPOSE 8080<br> #执行命令<br> java  -jarENTRYPOINT ["java","-jar","/app.jar"]</p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:left;">准备shell脚本用于删除之前的项目镜像  记得修改项目的镜像名称和yml的保持一致</p> 
<pre><code class="language-bash">#!/bin/bash

project_docker_image_name=projectdocker
#使用说明，用来提示输入参数
usage() {
 echo "Usage: sh restart.sh [kill]"
 exit 1
}
 
#检查程序是否在运行
ps_exist(){
 ps_id=`docker ps -a| grep ${project_docker_image_name} | awk '{print $1}'` #有点小bug
 #如果不存在返回1，存在返回0
 if [ -z "${ps_id}" ]; then
 return 1
 else
 return 0
 fi
}
#停止方法
ps_stop(){
 ps_exist
 if [ $? -eq "0" ]; then
 docker stop ${ps_id}
 docker rm ${ps_id}
 else
 echo "${project_docker_image_name} is not running"
 fi
}
image_exist(){
 image_id=`docker images -q projectdocker | awk '{print $1}'`
 #如果不存在返回1，存在返回0
 if [ -z "${image_id}" ]; then
 return 1
 else
 return 0
 fi

}
image_remove(){
 image_exist
 if [ $? -eq "0" ]; then
 echo "${image_id}"
 docker rmi -f ${image_id}
 else
 echo "${project_docker_image_name} is not exist"
 fi
}
check(){
 echo "docker run check...."
 ps_stop
 echo "docker images check...."
 image_remove
}
#根据输入参数，选择执行对应方法，不输入则执行使用说明
case "$1" in
 "kill")
 check
;;
 *)
 usage
 ;;
esac</code></pre> 
<p style="margin-left:.0001pt;text-align:left;">.gitlab-ci.yml内容</p> 
<pre><code class="language-bash">workflow:
    rules:
        - if: $CI_COMMIT_BRANCH != "master" &amp;&amp; $CI_PIPELINE_SOURCE != "merge_request_event"
          when: never
        - when: always
# 定义一些变量, 下面各阶段会使用
variables:
  #服务器地址
  server_ip: ***.***.**.***
  server_pwd: 服务器密码
  server_name: 服务器账号
  #生成的jar名称
  jar_name:  ****.jar
  #jar生成文件路径
  jar_addr: ******/target
  #服务器文件上传位置
  upload_path: /***/**
  #服务器生成镜像名称  要和脚本的同步
  project_docker_image_name: ******
  #镜像热部署脚本名称
  shell_name: ****.sh
  #dockerfile位置
  dockerfile_addr: ****/Dockerfile
  #远程服务器pom缓存参数
  DOCKER_DRIVER: overlay2
  MAVEN_CLI_OPTS: "-s .m2/settings.xml --batch-mode"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
# 定义执行的各个阶段及顺序
stages:
  - code_check
  - test_build_upload
  - deploy
#代码审查
check_code_Job:
  stage: code_check
  before_script:
    - echo "=====&gt;&gt; 静态代码审查 &lt;&lt;====="
  script:
    - echo "check....."
#单元测试
unit_test_Job:
  #缓存
  cache:
    paths:
    #project目标文件
     - target/
    #project 依赖
     - .m2/repository/
  image: maven:3.5.3-jdk-8
  stage: test_build_upload
  before_script:
    - echo '=====&gt;&gt; 代码单元测试 &lt;&lt;====='
  script:
    - echo "test"
    - mvn surefire-report:report -DshowSuccess=false

#使用 maven 镜像打包
JAVA_maven_build_Job:
   #缓存
  cache:
    paths:
    #project目标文件
     - target/
    #project 依赖
     - .m2/repository/
  stage: test_build_upload
  image: maven:3.5.3-jdk-8
  needs:
    - unit_test_Job
  only:
    - master
  before_script:
     - echo "=====&gt;&gt; 项目开始打包 &lt;&lt;====="
  script:
     #跳过测试进行打包
     - mvn clean package -Dmaven.test.skip=true
  artifacts:
    paths:
      - target/$jar_name
#项目上传至服务器
JAR_DOCKERFILE_upload_Job:   
   stage: test_build_upload
   needs:
     - unit_test_Job
     - JAVA_maven_build_Job
   only:
    - master
   image: ictu/sshpass
   before_script:
     - echo "=====&gt;&gt; 项目文件开始上传至服务器 &lt;&lt;====="
   script:
      #将项目的部署脚本和dockerfile都复制到target临时文件中
     - mkdir -p uploadfile
     - cp $shell_name  uploadfile/$shell_name
     - cp $dockerfile_addr uploadfile/Dockerfile
     - cp $jar_addr/$jar_name uploadfile/$jar_name
      #检查服务器的文件路径 不存在就创建
     - sshpass -p $server_pwd ssh -o StrictHostKeyChecking=no root@$server_ip -tt "cd / &amp;&amp; mkdir -p $upload_path"
     - echo "目录创建完成"
     #将target文件下所有的文件上传至服务器
     - sshpass -p $server_pwd scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no uploadfile/* $server_name@$server_ip:$upload_path/
     - echo "文件已上传至服务器"
deploy_project_Job:
  stage: deploy
  only:
    - master
  image: ictu/sshpass
  script:
    #给脚本权限 运行脚本清除当前服务器正在运行的项目image 把上传的文件打包成docker并运行
    - sshpass -p $server_pwd ssh -o StrictHostKeyChecking=no $server_name@$server_ip -tt " cd $upload_path &amp;&amp; chmod 777 $shell_name &amp;&amp; ./$shell_name kill  &amp;&amp; docker build -t $project_docker_image_name . &amp;&amp; docker run -d -p 8080:8080 $project_docker_image_name"</code></pre> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第十一部分、Nexus私服搭建 或者 Aliyun 镜像仓库 job打包并推送</strong></h4> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">Shell</span><br> #拉取镜像<br> &gt;   docker pull sonatype/nexus3<br> #启动镜像<br> &gt;   docker run -p 8081:8081 -v /home/docker/nexus/nexus-data:/var/nexus-data -v /etc/localtime:/etc/localtime:ro --lways -d  sonatype/nexus3:latest<br> #进入容器<br> &gt;   docker exec -it 容器ID /bin/bash<br> #查看密码   账号默认admin<br> &gt;   cat /opt/sonatype/sonatype-work/nexus3/admin.password<br><br> #浏览器访问  $serveaddress:8081</p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="636" src="https://images2.imgbox.com/a2/54/vYe4wPiK_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="636" src="https://images2.imgbox.com/8d/ab/WOf6a9ZU_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;">传输有http 和 https协议问题 暂时没有解决 选用的阿里镜像服务</p> 
<p style="margin-left:.0001pt;text-align:left;">https://cr.console.aliyun.com/repository/cn-shanghai   在aliyun镜像从仓库信息内有具体操作</p> 
<p style="margin-left:.0001pt;text-align:left;">将原来的镜像构建 从服务器上构建转为gitlab job虚拟镜像内构建 推送到远程仓库上</p> 
<p style="margin-left:.0001pt;text-align:left;">注意要修改runner配置  支持docker.sock服务 标红部分</p> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">YAML</span><br>  [runners.docker]<br>     volumes = ["/cache",<span style="background-color:#f76964;">"/run/docker.sock:/run/docker.sock"</span>]</p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:left;">修改原来的job构建过程  把jar和dockerfile都copy同一个虚拟目录进行镜像构建  推送到aliyun镜像仓库  其他服务器拉取进行运行</p> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">YAML</span><br>      - mkdir -p uploadfile<br>      - cp $dockerfile_addr uploadfile/Dockerfile<br>      - cp $jar_addr/$jar_name uploadfile/$jar_name<br>      - cd uploadfile/<br>      - docker build -t $project_docker_image_name .<br>      - echo $docker_pwd | docker login --username=$docker_user --password-stdin $hub_addr<br>      - docker tag  $project_docker_image_name $dockerhub_addr/$project_docker_image_name:$docker_version<br>      - docker push $dockerhub_addr/$project_docker_image_name:$docker_version<br>  </p> </td></tr></tbody></table> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第十二部分、gitlab及集成邮件服务</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">修改gitlab 容器的gitlab.rb  在90行左右就会有   ### GitLab email server settings   </p> 
<p style="margin-left:.0001pt;text-align:left;">以QQ邮箱为例：</p> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">YAML</span><br>  gitlab_rails['smtp_enable'] = true                                                                           <br>  gitlab_rails['smtp_address'] = "smtp.qq.com"   #发送邮箱的smtp                                                              <br>  gitlab_rails['smtp_port'] = 465                 #发送端口                                                <br>  gitlab_rails['smtp_user_name'] = "*********@qq.com"  #发送邮箱地址                                                        <br>  gitlab_rails['smtp_password'] = "********"    #所发送邮箱的授权码                                        <br>  gitlab_rails['smtp_domain'] = "qq.com"                   #发送邮箱后缀                                 <br>  gitlab_rails['smtp_authentication'] = "login"               #开启日志记录                                   <br>  gitlab_rails['smtp_enable_starttls_auto'] = true                                             <br>  gitlab_rails['smtp_tls'] = true                                                                         <br>  gitlab_rails['smtp_pool'] = false<br>  ### Email Settings                                                                                                                                                                                                         <br>  gitlab_rails['gitlab_email_enabled'] = true                                                                                                                                                                       <br> ##! If your SMTP server does not like the default 'From: gitlab@gitlab.example.com'                           <br> ##! can change the 'From' with this setting.                                                                  <br>  gitlab_rails['gitlab_email_from'] = '*********@qq.com'     #gitlab发信人和发送邮箱地址保持一致                                                <br>  gitlab_rails['gitlab_email_display_name'] = 'Example'      #邮件主题                                                <br>  gitlab_rails['gitlab_email_reply_to'] = '*******@qq.com'                                             <br>  gitlab_rails['gitlab_email_subject_suffix'] = ''  </p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:left;">获取授权码：<img alt="" height="316" src="https://images2.imgbox.com/a5/49/kGbU9KIv_o.png" width="1200"></p> 
<p><img alt="" height="571" src="https://images2.imgbox.com/3d/cb/AyYEfd9W_o.png" width="1200"></p> 
<p><img alt="" height="636" src="https://images2.imgbox.com/ad/da/iibmSGLh_o.png" width="1200"></p> 
<p><img alt="" height="636" src="https://images2.imgbox.com/16/47/6aUZS8zx_o.png" width="1200"></p> 
<p><img alt="" height="636" src="https://images2.imgbox.com/e3/35/2WZ6ZYOF_o.png" width="1200"></p> 
<p> <strong>第十三部分、gitlab pipeline 外部触发</strong></p> 
<p style="margin-left:.0001pt;text-align:left;">添加一个管道触发器</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="636" src="https://images2.imgbox.com/26/67/uO7BbM2m_o.png" width="1200"></p> 
<p> 会生成一个令牌</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="392" src="https://images2.imgbox.com/4c/3f/xHcRbGlZ_o.png" width="1057"></p> 
<p> 下面提供了触发方式</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="411" src="https://images2.imgbox.com/50/c1/XirSX1bU_o.png" width="1051"></p> 
<p style="margin-left:.0001pt;text-align:left;">我选择了webhook方式 利用postman发送post请求</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="534" src="https://images2.imgbox.com/95/f6/nvPU0XB5_o.png" width="1200"></p> 
<p><img alt="" height="97" src="https://images2.imgbox.com/75/dc/HKoElY9E_o.png" width="1200"></p> 
<p></p> 
<p style="margin-left:.0001pt;text-align:left;"><strong>第十四部分、pipeline定时触发任务</strong></p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="727" src="https://images2.imgbox.com/e3/2d/os07OhdO_o.png" width="1200"></p> 
<p><img alt="" height="727" src="https://images2.imgbox.com/fa/35/blgBkMEv_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;">以上部分完成后 就享受定时任务带的便利吧！！！</p> 
<h4 style="margin-left:.0001pt;text-align:left;"><strong>第十五部分、配置gitlab 的docker镜像库</strong></h4> 
<p style="margin-left:.0001pt;text-align:left;">启动 Docker registry镜像仓库</p> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">Shell</span><br> docker run -d -v /data/registry:/var/lib/registry -e REGISTRY_STORAGE_DELETE_ENABLED=true -p 5001:5000 --restart=always --name registry registry:2</p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:left;">访问<span style="background-color:#eff0f1;">http://&lt;服务器IP&gt;:5001/v2/_catalog</span>，会返回一个空的JSON</p> 
<p style="margin-left:.0001pt;text-align:left;">修改配置文件gitlab.rb  780行左右  仓库服务器地址</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="335" src="https://images2.imgbox.com/bd/d3/N1GMXUEy_o.png" width="850"></p> 
<p style="margin-left:.0001pt;text-align:left;">追加 daemon.json 文件</p> 
<table border="1" cellspacing="0" style="margin-left:-.6pt;"><tbody><tr><td style="background-color:#f5f6f7;width:425.25pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#646a73;">Bash</span><br> "insecure-registries":["xxx:5001"]</p> </td></tr></tbody></table> 
<p style="margin-left:.0001pt;text-align:left;"><img alt="" height="112" src="https://images2.imgbox.com/c2/ae/6bjZaVkm_o.png" width="759"></p> 
<p style="margin-left:.0001pt;text-align:left;">重启docker   多了一个容器镜像仓库</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="636" src="https://images2.imgbox.com/92/90/pbDJXOIt_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:left;">在流水线 job内打包就可以上传到仓库中</p> 
<p style="margin-left:.0001pt;text-align:center;"><img alt="" height="297" src="https://images2.imgbox.com/0c/a8/BpsCCMv7_o.png" width="956"></p> 
<p style="margin-left:.0001pt;text-align:left;">感觉没有阿里云好用 相同版本的镜像标签会被顶掉 但是镜像依旧存在</p> 
<p style="margin-left:.0001pt;text-align:left;">未完待续.........</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/32a5425d711469f4ecdb794b974ad06a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">华为悦盒烧写Ubuntu系统刷机教程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ef8d1faa037b6d9089cae0cd7f4c2ff9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java 实现单例模式的七种写法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>