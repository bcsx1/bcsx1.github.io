<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android组件生命周期管理 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android组件生命周期管理" />
<meta property="og:description" content="每个Android应用启动时，都会先创建一个Application。通常在Application里我们会做一些应用初始化的操作，常见的有第三方SDK初始化。在应用组件化之后，组件与壳工程是隔离开来的，但是组件有时候也需要获取应用的Application，也需要在应用启动时进行初始化。这就涉及到组件的生命周期管理问题。
最简单的实现方式如下：
我们定义一个Application的代理接口IAppLike出来，它模拟了Application的几个主要方法。 public interface IAppLike { void onCreate(); void onTerminate(); void onLowMemory(); void onTrimMemory(int level); } 在组件内部写一个实现IAppLike的类，我们把这个类当做是组件的Application容器。这里的onCreate()等同于Application的onCreate()方法，组件可以在这里获取Application实例、执行启动初始化等操作，也可以在这里设置保存一些全局性的数据等。 public class NewsDelegate implements IApplicationDelegate { @Override public void onCreate() { Log.i(&#34;hx&#34;, &#34;NewsDelegate-onCreate&#34;); } @Override public void onTerminate() { Log.i(&#34;hx&#34;, &#34;NewsDelegate-onTerminate&#34;); } @Override public void onLowMemory() { } @Override public void onTrimMemory(int level) { } } 在壳工程的Application.onCreate()方法里执行： @Override public void onCreate() { super.onCreate(); MainDelegate mainDelegate = new MainDelegate(); NewsDelegate newsDelegate = new NewsDelegate(); MusicDelegate musicDelegate = new MusicDelegate(); MimeDelegate mimeDelegate = new MimeDelegate(); mainDelegate." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/e58e91cd89fff5388d28fab0072699e3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-14T19:44:24+08:00" />
<meta property="article:modified_time" content="2020-01-14T19:44:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android组件生命周期管理</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>每个Android应用启动时，都会先创建一个Application。通常在Application里我们会做一些应用初始化的操作，常见的有第三方SDK初始化。在应用组件化之后，组件与壳工程是隔离开来的，但是组件有时候也需要获取应用的Application，也需要在应用启动时进行初始化。这就涉及到组件的生命周期管理问题。</p> 
<p>最简单的实现方式如下：</p> 
<ol><li>我们定义一个Application的代理接口IAppLike出来，它模拟了Application的几个主要方法。</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAppLike</span> <span class="token punctuation">{<!-- --></span>      
    <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
    <span class="token keyword">void</span> <span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
    <span class="token keyword">void</span> <span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">void</span> <span class="token function">onTrimMemory</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>在组件内部写一个实现IAppLike的类，我们把这个类当做是组件的Application容器。这里的onCreate()等同于Application的onCreate()方法，组件可以在这里获取Application实例、执行启动初始化等操作，也可以在这里设置保存一些全局性的数据等。</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NewsDelegate</span> <span class="token keyword">implements</span> <span class="token class-name">IApplicationDelegate</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"hx"</span><span class="token punctuation">,</span> <span class="token string">"NewsDelegate-onCreate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"hx"</span><span class="token punctuation">,</span> <span class="token string">"NewsDelegate-onTerminate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTrimMemory</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>在壳工程的Application.onCreate()方法里执行：</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span> 
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>     
   <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
   MainDelegate mainDelegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MainDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
   NewsDelegate newsDelegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NewsDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
   MusicDelegate musicDelegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MusicDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
   MimeDelegate mimeDelegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   mainDelegate<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
   newsDelegate<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
   musicDelegate<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
   mimeDelegate<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token punctuation">}</span>
</code></pre> 
<p>看起来貌似很简单，根本没什么技术含量，但是实际运用时，你会发现很多问题：<br> （1）组件初始化先后顺序问题：<br> 前面介绍过，上层业务组件是依赖下层业务组件的，如果下层组件在应用启动时也需要初始化，那么我们在加载组件时，必然要先加载下层组件，否则加载上层组件时可能会出现问题。但是组件这么多，我们怎么确定要先加载谁后加载谁呢，当然你可以手动维护，代码里写死，但是当业务越来越多、时间越来越久，肯定不灵活，你新加一个业务组件进来，你都需要确定组件初始化先后顺序。所以，我们必须有个机制来确定组件初始化先后顺序。<br> 类似线程优先级一样， 为每个组件定义了一个优先级，通过重写getPriority()方法可以设置组件的优先级。优先级范围从[1-10]，默认优先级都为5，下层组件或需要先初始化的组件，优先级设置高一点。这样我们在加载组件的时候，先对所有组件的优先级进行排序，优先级高的排前面，然后再按顺序进行加载组件，就可解决这个问题了。</p> 
<p>（2）自动加载问题<br> 这里需要在壳工程代码里，手动构建各个组件的Delegate类。如果很多个组件都有实现该类，那在集成时得一个一个找出这些类，并且新增加一个组件，你都有可能要去修改壳工程代码，这样显然是不灵活且不利于代码维护的。如果能自动读取并加载这些Delegate类，那显然是极好的，这里有2种方式来实现：</p> 
<ul><li>全局扫描代理类</li></ul> 
<p>应用启动时通过包名全局扫描源代码文件并找到代理类，通过反射去加载并初始化组件。这种方式只需要在组件中实现代理类即可，实现起来比较简单，但是全局扫描有性能的损耗。</p> 
<ul><li>自定义gradle插件/字节码插入技术</li></ul> 
<p>通过自定义gradle插件和字节码插入技术来实现AOP，在编译期间在BaseApplication生命周期中动态注入字节码，实现调用代理类的对应方法。</p> 
<h2><a id="_72"></a>全局扫描代理类</h2> 
<p>在BaseApplication初始化时扫描出所有组件的代理类，再通过反射加载并初始化。这里也有个问题，所有组件的代理类散落在各个不同的组件中，包名各不相同，当扫描到class文件后判断条件就必须是【class文件全类命.equal(组件1代理类全类命) || class文件全类命.equal(组件2代理类全类命) || …】,是不是很麻烦，这里我们可以采取apt技术，通过编译时注解动态生成这些代理类的辅助文件，在辅助文件中调用代理类的方法，而这些辅助文件的包名一样，这样我们只需要扫描辅助文件就可以了，判断条件就变成【class文件包名.startWith(辅助文件包名)】，是不是简单多了。</p> 
<p>初步思路：</p> 
<ol><li>定义一个注解来标识实现了IAppLike的类。</li><li>通过APT技术，在组件编译时扫描和处理前面定义的注解，生成一个AppLike的代理类，姑且称之为AppLikeProxy，所有的代理类都在同一个包名下，这个包名下必须只包含代理类，且类名由固定的规则来生成，保证不同组件生成的代理类的类名不会重复。</li><li>需要有一个组件生命周期管理类，初始化时能扫描到固定包名下有多少个类文件，以及类文件的名称，这个固定包名就是前面我们生成的AppLikeProxy的包名，代理类都放在同一个包名下，是为了通过包名找到我们所有的目标类。</li><li>组件集成后在应用的Application.onCreate()方法里，调用组件生命周期管理类的初始化方法。</li><li>组件生命周期管理类的内部，扫描到所有的AppLikeProxy类名之后，通过反射进行类实例化。</li></ol> 
<p><strong>初步技术难点：</strong><br> 需要了解APT技术，怎么在编译时动态生成java代码；关于编译时注解可以参考<a href="https://blog.csdn.net/huaxun66/article/details/77507085">详解Android注解 Annotation</a>这篇文章。<br> 应用在运行时，怎么能扫描到某个包名下有多少个class，以及他们的名称呢；</p> 
<h4><a id="_88"></a>注解定义</h4> 
<p>在Android Studio中，新建一个Java Library module，命名为lifecycle-annotation，在该module中创建一个注解类，同时创建一个后面要生成代理类的相关配置文件。<br> 注解类：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>CLASS<span class="token punctuation">)</span> 
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span>ElementType<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span> 
<span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">AppLifeCycle</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre> 
<p>配置文件：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LifeCycleConfig</span> <span class="token punctuation">{<!-- --></span>      
<span class="token comment">/*** 生成代理类的包名      */</span>     
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String PROXY_CLASS_PACKAGE_NAME <span class="token operator">=</span> <span class="token string">"com.example.lifecycle.apt.proxy"</span><span class="token punctuation">;</span>      
<span class="token comment">/*** 生成代理类统一的后缀      */</span>     
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String PROXY_CLASS_SUFFIX <span class="token operator">=</span> <span class="token string">"$$Proxy"</span><span class="token punctuation">;</span>      
<span class="token comment">/*** 生成代理类统一的前缀      */</span>     
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String PROXY_CLASS_PREFIX <span class="token operator">=</span> <span class="token string">"Watson$$"</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="APTIAppLike_111"></a>使用APT来生成IAppLike的代理类</h4> 
<p>新建一个Java Library module，命名为lifecycle-apt，在该module里实现我们自己的注解处理器。</p> 
<p>在build.gradle里修改配置为：</p> 
<pre><code class="prism language-java">apply plugin<span class="token operator">:</span> <span class="token string">'java-library'</span>  

dependencies <span class="token punctuation">{<!-- --></span>     
implementation <span class="token function">fileTree</span><span class="token punctuation">(</span>dir<span class="token operator">:</span> <span class="token string">'libs'</span><span class="token punctuation">,</span> include<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'*.jar'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>      
implementation <span class="token string">'com.google.auto.service:auto-service:1.0-rc2'</span>     
implementation <span class="token function">project</span><span class="token punctuation">(</span><span class="token string">':lifecycle-annotation'</span><span class="token punctuation">)</span>  
<span class="token punctuation">}</span>  

sourceCompatibility <span class="token operator">=</span> <span class="token string">"1.8"</span> 
targetCompatibility <span class="token operator">=</span> <span class="token string">"1.8"</span>  

tasks<span class="token punctuation">.</span><span class="token function">withType</span><span class="token punctuation">(</span>JavaCompile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>     
   options<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">"UTF-8"</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来就是实现我们自己的注解处理器了：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@AutoService</span><span class="token punctuation">(</span>Processor<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppLikeProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProcessor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> Elements mElementUtils<span class="token punctuation">;</span>
    <span class="token keyword">private</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> AppLikeProxyClassCreator<span class="token punctuation">&gt;</span></span> mMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>ProcessingEnvironment processingEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>processingEnvironment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mElementUtils <span class="token operator">=</span> processingEnvironment<span class="token punctuation">.</span><span class="token function">getElementUtils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*** 支持解析的注解      */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> <span class="token function">getSupportedAnnotationTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Set<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>AppLifeCycle<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> set<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SourceVersion <span class="token function">getSupportedSourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> SourceVersion<span class="token punctuation">.</span>RELEASE_8<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">process</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TypeElement</span><span class="token operator">&gt;</span> set<span class="token punctuation">,</span> RoundEnvironment roundEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Set<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Element</span><span class="token operator">&gt;</span> elements <span class="token operator">=</span> roundEnvironment<span class="token punctuation">.</span><span class="token function">getElementsAnnotatedWith</span><span class="token punctuation">(</span>AppLifeCycle<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Element element <span class="token operator">:</span> elements<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>element<span class="token punctuation">.</span><span class="token function">getKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Annotation AppLifeCycle can only be used in class."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            TypeElement typeElement <span class="token operator">=</span> <span class="token punctuation">(</span>TypeElement<span class="token punctuation">)</span> element<span class="token punctuation">;</span>
            <span class="token comment">//这里检查一下，使用了该注解的类，同时必须要实现com.example.lifecycle.api.IAppLike接口，否则会报错，因为我们要实现一个代理类             </span>
            List<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TypeMirror</span><span class="token operator">&gt;</span> mirrorList <span class="token operator">=</span> typeElement<span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mirrorList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>typeElement<span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" must implements interface com.example.lifecycle.api.IAppLike"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> checkInterfaceFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>TypeMirror mirror <span class="token operator">:</span> mirrorList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"com.example.lifecycle.api.IAppLike"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mirror<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    checkInterfaceFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>checkInterfaceFlag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>typeElement<span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" must implements interface com.example.lifecycle.api.IAppLike"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            String fullClassName <span class="token operator">=</span> typeElement<span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>fullClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"process class name : "</span> <span class="token operator">+</span> fullClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                AppLikeProxyClassCreator creator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppLikeProxyClassCreator</span><span class="token punctuation">(</span>mElementUtils<span class="token punctuation">,</span> typeElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>fullClassName<span class="token punctuation">,</span> creator<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"start to generate proxy class code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> AppLikeProxyClassCreator<span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> mMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            String className <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            AppLikeProxyClassCreator creator <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"generate proxy class for "</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                JavaFileObject jfo <span class="token operator">=</span> processingEnv<span class="token punctuation">.</span><span class="token function">getFiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createSourceFile</span><span class="token punctuation">(</span>creator<span class="token punctuation">.</span><span class="token function">getProxyClassFullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Writer writer <span class="token operator">=</span> jfo<span class="token punctuation">.</span><span class="token function">openWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>creator<span class="token punctuation">.</span><span class="token function">generateJavaCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppLikeProxyClassCreator</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> Elements mElementUtils<span class="token punctuation">;</span>
    <span class="token keyword">private</span> TypeElement mTypeElement<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String mProxyClassSimpleName<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">AppLikeProxyClassCreator</span><span class="token punctuation">(</span>Elements elements<span class="token punctuation">,</span> TypeElement typeElement<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mElementUtils <span class="token operator">=</span> elements<span class="token punctuation">;</span>
        mTypeElement <span class="token operator">=</span> typeElement<span class="token punctuation">;</span>
        mProxyClassSimpleName <span class="token operator">=</span> LifeCycleConfig<span class="token punctuation">.</span>PROXY_CLASS_PREFIX <span class="token operator">+</span> mTypeElement<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> LifeCycleConfig<span class="token punctuation">.</span>PROXY_CLASS_SUFFIX<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取要生成的代理类的完整类名      *      * @return
     */</span>
    <span class="token keyword">public</span> String <span class="token function">getProxyClassFullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String name <span class="token operator">=</span> LifeCycleConfig<span class="token punctuation">.</span>PROXY_CLASS_PACKAGE_NAME <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> mProxyClassSimpleName<span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成java代码
     */</span>
    <span class="token keyword">public</span> String <span class="token function">generateJavaCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置包名         </span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"package "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>LifeCycleConfig<span class="token punctuation">.</span>PROXY_CLASS_PACKAGE_NAME<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">";\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置import部分         </span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"import android.content.Context;\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"import com.example.lifecycle.api.IAppLike;\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"import "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mTypeElement<span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">";\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"public class "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mProxyClassSimpleName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" implements "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"IAppLike "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" {\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置变量         </span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  private "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mTypeElement<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" mAppLike;\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//构造函数         </span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  public "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mProxyClassSimpleName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"() {\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  mAppLike = new "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mTypeElement<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"();\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  }\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//getPriority()方法         </span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  public int getPriority() {\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"    return mAppLike.getPriority();\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  }\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//onCreate()方法         </span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  public void onCreate() {\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"    mAppLike.onCreate();\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  }\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//onTerminate方法         </span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  public void onTerminate() {\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"    mAppLike.onTerminate();\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  }\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//onTerminate方法         </span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  public void onLowMemory() {\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"    mAppLike.onLowMemory();\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  }\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//onTerminate方法        </span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  public void onTrimMemory(int level) {\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"    mAppLike.onTrimMemory(level);\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"  }\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>关于APT的调试可以参考<a href="https://blog.csdn.net/zhangteng22/article/details/54946270">https://blog.csdn.net/zhangteng22/article/details/54946270</a>这篇文章。</p> 
<p>在前面定义的几个组件代理类上添加注解@AppLifeCycle</p> 
<pre><code class="prism language-java"><span class="token comment">//实现了IAppLike接口，并且采用了AppLifeCycle注解，二者缺一不可，否则APT处理时会报错 </span>
<span class="token annotation punctuation">@AppLifeCycle</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainDelegate</span> <span class="token keyword">implements</span> <span class="token class-name">IAppLike</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"hx"</span><span class="token punctuation">,</span> <span class="token string">"MainDelegate-onCreate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"hx"</span><span class="token punctuation">,</span> <span class="token string">"MainDelegate-onTerminate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTrimMemory</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同时修改组件的build.gradle，添加依赖:</p> 
<pre><code class="prism language-java"><span class="token comment">//---------其他依赖------------     </span>
api <span class="token function">project</span><span class="token punctuation">(</span><span class="token string">':lifecycle-annotation'</span><span class="token punctuation">)</span>     
api <span class="token function">project</span><span class="token punctuation">(</span><span class="token string">':lifecycle-api'</span><span class="token punctuation">)</span>     
<span class="token comment">//需要注意这里是使用 annotationProcessor，即我们刚定义的注解处理器     </span>
annotationProcessor <span class="token function">project</span><span class="token punctuation">(</span><span class="token string">':lifecycle-apt'</span><span class="token punctuation">)</span>
</code></pre> 
<p>到这里注解处理器就可以工作啦，将整个工程编译一下，可以看到在build目录下已经生成了我们定义的注解类，具体路径如下所示：<br> <img src="https://images2.imgbox.com/ff/57/b4hyuEKp_o.png" alt="在这里插入图片描述"><br> 打开看一下呢：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Watson</span>$$MainDelegate$$Proxy <span class="token keyword">implements</span> <span class="token class-name">IAppLike</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> MainDelegate mAppLike<span class="token punctuation">;</span>

    <span class="token keyword">public</span> Watson$$MainDelegate$$<span class="token function">Proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mAppLike <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MainDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mAppLike<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mAppLike<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mAppLike<span class="token punctuation">.</span><span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mAppLike<span class="token punctuation">.</span><span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTrimMemory</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mAppLike<span class="token punctuation">.</span><span class="token function">onTrimMemory</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="IAppLike_352"></a>重新定义IAppLike接口</h4> 
<p>新建一个Android Library module，命名为lifecycle-api，在这个module里定义IAppLike接口，以及一个生命周期管理类。现在工程目录差不多是这样的：<br> <img src="https://images2.imgbox.com/d8/96/78AYyfq1_o.png" alt="捕获.PNG"></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAppLike</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> MAX_PRIORITY <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> MIN_PRIORITY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> NORM_PRIORITY <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> NORM_PRIORITY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">onTrimMemory</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>生命周期管理类，初始化的时候扫描所有的代理辅助类，并在相应方法中调用组件生命周期方法。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppLifeCycleManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 初始化
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">scanClassFile</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"hx"</span><span class="token punctuation">,</span> <span class="token string">"代理子模块数目："</span> <span class="token operator">+</span> APP_LIKE_LIST<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>APP_LIKE_LIST<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AppDelegateComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//优先级排序    </span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>IAppLike delegate <span class="token operator">:</span> APP_LIKE_LIST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            delegate<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>IAppLike delegate <span class="token operator">:</span> APP_LIKE_LIST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            delegate<span class="token punctuation">.</span><span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>IAppLike delegate <span class="token operator">:</span> APP_LIKE_LIST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            delegate<span class="token punctuation">.</span><span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onTrimMemory</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>IAppLike delegate <span class="token operator">:</span> APP_LIKE_LIST<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            delegate<span class="token punctuation">.</span><span class="token function">onTrimMemory</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 扫描出固定包名下，实现了IAppLike接口的代理类      *      * @param context
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">scanClassFile</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Set<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> set <span class="token operator">=</span> ClassUtils<span class="token punctuation">.</span><span class="token function">getFileNameByPackageName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> LifeCycleConfig<span class="token punctuation">.</span>PROXY_CLASS_PACKAGE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>set <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String className <span class="token operator">:</span> set<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"hx"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        Object obj <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">IAppLike</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            APP_LIKE_LIST<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span>IAppLike<span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 优先级比较器，优先级大的排在前面
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AppDelegateComparator</span> <span class="token keyword">implements</span> <span class="token class-name">Comparator</span><span class="token generics function"><span class="token punctuation">&lt;</span>IAppLike<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span>IAppLike o1<span class="token punctuation">,</span> IAppLike o2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> p1 <span class="token operator">=</span> o1<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> p2 <span class="token operator">=</span> o2<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> p2 <span class="token operator">-</span> p1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="BaseApplication_453"></a>BaseApplication修改</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> BaseApplication sInstance<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> BaseApplication <span class="token function">getIns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> sInstance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>BuildConfig<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ARouter<span class="token punctuation">.</span><span class="token function">openLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打印日志             </span>
            ARouter<span class="token punctuation">.</span><span class="token function">openDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 开启调试模式(如果在InstantRun模式下运行，必须开启调试模式！线上版本需要关闭,否则有安全风险)         </span>
        <span class="token punctuation">}</span>
        ARouter<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 尽可能早，推荐在Application中初始化         </span>
        <span class="token comment">// 代理方法         </span>
        AppLifeCycleManager<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AppLifeCycleManager<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ARouter<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AppLifeCycleManager<span class="token punctuation">.</span><span class="token function">onTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AppLifeCycleManager<span class="token punctuation">.</span><span class="token function">onLowMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTrimMemory</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onTrimMemory</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AppLifeCycleManager<span class="token punctuation">.</span><span class="token function">onTrimMemory</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在BaseApplication的生命周期中调用Manager中相应的方法即可。</p> 
<p>跑一下，看日志输入，可以看到扫描到了四个代理辅助类，在BaseApplication的onCreate方法中分别调用了四个代理类的onCreate方法，且按照优先级顺序调用。<br> <img src="https://images2.imgbox.com/a6/5d/WZyLZ5Au_o.png" alt="捕获.PNG"></p> 
<p><strong>更进一步的思考：</strong><br> 前面的思路里，应用在启动时，需要扫描dex文件里的所有class，然后通过class文件的包名来判断是不是我们的目标类。通常一个安装包里，加上第三方库，class文件可能数以千计、数以万计，但是我们的要用到的可能只有几个，这让人有点杀鸡用牛刀的感觉。能不能在运行时，不扫描所有class文件，就已经知道了所有的AppLikeProxy类名呢？首先想到的就是采用gradle插件技术，在应用打包编译时，动态插入字节码来实现。这里又会碰到几个技术难点：</p> 
<ol><li>怎么制作gradle插件。可以参考<a href="https://blog.csdn.net/huaxun66/article/details/103497369">Gradle自定义插件</a>这篇文章。</li><li>怎么在打包时动态插入字节码。可以参考<a href="https://blog.csdn.net/huaxun66/article/details/103497729">Android字节码插桩</a>这篇文章。</li></ol> 
<h2><a id="gradle_509"></a>自定义gradle插件/字节码插入技术</h2> 
<h4><a id="groovy_511"></a>采用groovy创建插件</h4> 
<p>新建一个Java Library module，命名为lifecycle-plugin，删除 src-&gt;main 下面的java目录，新建一个groovy目录，在groovy目录下创建类似java的package，在 src-&gt;main 下面创建一个 resources 目录，在resources目录下依次创建 META-INF/gradle-plugins 目录，最后在该目录下创建一个名为 <strong>com.example.plugin.lifecycle.properties</strong>的文本文件，文件名是你要定义的插件名，按需自定义即可。最后的工程结构如图所示：<br> <img src="https://images2.imgbox.com/31/a0/YjcZe0EF_o.png" alt="捕获.PNG"><br> 修改module的build.gradle文件，引入groovy插件等：</p> 
<pre><code class="prism language-java">apply plugin<span class="token operator">:</span><span class="token string">'java-library'</span>
apply plugin<span class="token operator">:</span><span class="token string">'groovy'</span>
apply plugin<span class="token operator">:</span><span class="token string">'maven'</span>

dependencies<span class="token punctuation">{<!-- --></span>
    implementation <span class="token function">fileTree</span><span class="token punctuation">(</span>dir<span class="token operator">:</span><span class="token string">'libs'</span><span class="token punctuation">,</span>include<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'*.jar'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    compile <span class="token function">gradleApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    compile <span class="token function">localGroovy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    compile<span class="token string">'com.android.tools.build:transform-api:1.5.0'</span>
    compile<span class="token string">'com.android.tools.build:gradle:3.0.1'</span>
<span class="token punctuation">}</span>

sourceCompatibility<span class="token operator">=</span><span class="token string">"1.8"</span>
targetCompatibility<span class="token operator">=</span><span class="token string">"1.8"</span>
        
tasks<span class="token punctuation">.</span><span class="token function">withType</span><span class="token punctuation">(</span>JavaCompile<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    options<span class="token punctuation">.</span>encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span>
<span class="token punctuation">}</span>  

<span class="token comment">//通过maven将插件发布到本地的脚本配置，根据自己的要求来修改 </span>
uploadArchives <span class="token punctuation">{<!-- --></span>     
    repositories<span class="token punctuation">.</span>mavenDeployer <span class="token punctuation">{<!-- --></span>         
        pom<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">'1.0.0'</span>         
        pom<span class="token punctuation">.</span>artifactId <span class="token operator">=</span> <span class="token string">'lifecycleplugin'</span>         
        pom<span class="token punctuation">.</span>groupId <span class="token operator">=</span> <span class="token string">'com.example.component'</span>         
        <span class="token function">repository</span><span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token string">"file:///D:/repository/"</span><span class="token punctuation">)</span>     
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>这里有几点需要说明的是：</p> 
<ol><li>通常都是采用groovy语言来创建gradle<br> plugin的，groovy是兼容java的，你完全可以采用java来编写插件。关于groovy语言，了解一些基础语法就足够支撑我们去编写插件了。</li><li>在<br> <strong>src/main/resources/META-INF/gradle-plugins</strong>目录下定义插件声明，*.properties文件的文件名就是插件名称。</li></ol> 
<h4><a id="_555"></a>使用插件</h4> 
<p>我们通过maven将该插件发布到本地的maven仓库里，发布成功后，我们在app module里引入该插件，修改app module目录下的build.gradle文件，增加如下配置：</p> 
<pre><code class="prism language-java"><span class="token comment">//自定义插件 </span>
apply plugin<span class="token operator">:</span> <span class="token string">'com.example.plugin.lifecycle'</span> 
buildscript <span class="token punctuation">{<!-- --></span>     
   repositories <span class="token punctuation">{<!-- --></span>        
      <span class="token function">google</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         
      <span class="token function">jcenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         
      <span class="token comment">//自定义插件maven地址         </span>
      maven <span class="token punctuation">{<!-- --></span>             
         url <span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">'D:/repository'</span><span class="token punctuation">)</span>  <span class="token comment">//add         </span>
      <span class="token punctuation">}</span>     
    <span class="token punctuation">}</span>     

    dependencies <span class="token punctuation">{<!-- --></span>         
      <span class="token comment">//加载自定义插件         </span>
      classpath <span class="token string">'com.example.component:lifecycleplugin:1.0.0'</span>     
      <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Plugin_579"></a>实现Plugin接口</h4> 
<p>要编写一个插件是很简单的，只需实现Plugin接口即可，在里面注册LifeCycleTransform:</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">LifeCyclePlugin</span> <span class="token keyword">implements</span> <span class="token class-name">Plugin</span><span class="token generics function"><span class="token punctuation">&lt;</span>Project<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>Project project<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        println <span class="token string">"------LifeCycle plugin entrance-------"</span>
        def android <span class="token operator">=</span> project<span class="token punctuation">.</span>extensions<span class="token punctuation">.</span><span class="token function">getByType</span><span class="token punctuation">(</span>AppExtension<span class="token punctuation">)</span>
        android<span class="token punctuation">.</span><span class="token function">registerTransform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LifeCycleTransform</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接着在com.example.plugin.lifecycle.properties文件里增加配置：</p> 
<pre><code class="prism language-java">implementation<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">=</span>com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>plugin<span class="token punctuation">.</span>LifeCyclePlugin
</code></pre> 
<p>其中implementation-class的值为Plugin接口的实现类的全限定类名。</p> 
<p>那么怎么通过插件在打包前去扫描所有的class文件呢，幸运的是官方给我们提供了 Gradle Transform 技术，简单来说就是能够让开发者在项目构建阶段即由class到dex转换期间修改class文件，Transform阶段会扫描所有的class文件和资源文件，下面通过代码部分说下我的思路：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">LifeCycleTransform</span> <span class="token keyword">extends</span> <span class="token class-name">Transform</span> <span class="token punctuation">{<!-- --></span>
    Project project

    <span class="token function">LifeCycleTransform</span><span class="token punctuation">(</span>Project project<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>project <span class="token operator">=</span> project
    <span class="token punctuation">}</span>

    <span class="token comment">//该Transform的名称，自定义即可，只是一个标识     </span>
    <span class="token annotation punctuation">@Override</span>
    String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"LifeCycleTransform"</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//该Transform支持扫描的文件类型，分为class文件和资源文件，我们这里只处理class文件的扫描     </span>
    <span class="token annotation punctuation">@Override</span>
    Set<span class="token generics function"><span class="token punctuation">&lt;</span>QualifiedContent<span class="token punctuation">.</span>ContentType<span class="token punctuation">&gt;</span></span> <span class="token function">getInputTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> TransformManager<span class="token punctuation">.</span>CONTENT_CLASS
    <span class="token punctuation">}</span>

    <span class="token comment">//Transform的扫描范围，我这里扫描整个工程，包括当前module以及其他jar包、aar文件等所有的class     </span>
    <span class="token annotation punctuation">@Override</span>
    Set<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> QualifiedContent<span class="token punctuation">.</span>Scope<span class="token operator">&gt;</span> <span class="token function">getScopes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> TransformManager<span class="token punctuation">.</span>SCOPE_FULL_PROJECT
    <span class="token punctuation">}</span>

    <span class="token comment">//是否增量扫描     </span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">boolean</span> <span class="token function">isIncremental</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Collection<span class="token generics function"><span class="token punctuation">&lt;</span>TransformInput<span class="token punctuation">&gt;</span></span> inputs<span class="token punctuation">,</span> Collection<span class="token generics function"><span class="token punctuation">&lt;</span>TransformInput<span class="token punctuation">&gt;</span></span> referencedInputs<span class="token punctuation">,</span> TransformOutputProvider outputProvider<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isIncremental<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> TransformException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{<!-- --></span>
        println <span class="token string">"\nstart to transform--------------&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>
        def appLikeProxyClassList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment">//inputs就是所有扫描到的class文件或者是jar包，一共2种类型         </span>
        inputs<span class="token punctuation">.</span>each <span class="token punctuation">{<!-- --></span>
            TransformInput input <span class="token operator">-</span><span class="token operator">&gt;</span>
            <span class="token comment">//1.遍历所有的class文件目录             </span>
            input<span class="token punctuation">.</span>directoryInputs<span class="token punctuation">.</span>each <span class="token punctuation">{<!-- --></span>
                DirectoryInput directoryInput <span class="token operator">-</span><span class="token operator">&gt;</span>
                <span class="token comment">//递归扫描该目录下所有的class文件                 </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>directoryInput<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    directoryInput<span class="token punctuation">.</span>file<span class="token punctuation">.</span>eachFileRecurse <span class="token punctuation">{<!-- --></span>
                        File file <span class="token operator">-</span><span class="token operator">&gt;</span>
                        <span class="token comment">//形如 Watson****$$Proxy.class 的类，是我们要找的目标class                         </span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ScanUtil<span class="token punctuation">.</span><span class="token function">isTargetProxyClass</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">//如果是我们自己生产的代理类，保存该类的类名                             </span>
                            appLikeProxyClassList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//Transform扫描的class文件是输入文件(input)，有输入必然会有输出(output)，处理完成后需要将输入文件拷贝到一个输出目录下去，                 </span>
                <span class="token comment">// 后面打包将class文件转换成dex文件时，直接采用的就是输出目录下的class文件了。                 </span>
                <span class="token comment">// 必须这样获取输出路径的目录名称                 </span>
                def dest <span class="token operator">=</span> outputProvider<span class="token punctuation">.</span><span class="token function">getContentLocation</span><span class="token punctuation">(</span>directoryInput<span class="token punctuation">.</span>name<span class="token punctuation">,</span> directoryInput<span class="token punctuation">.</span>contentTypes<span class="token punctuation">,</span> directoryInput<span class="token punctuation">.</span>scopes<span class="token punctuation">,</span> Format<span class="token punctuation">.</span>DIRECTORY<span class="token punctuation">)</span>
                FileUtils<span class="token punctuation">.</span><span class="token function">copyDirectory</span><span class="token punctuation">(</span>directoryInput<span class="token punctuation">.</span>file<span class="token punctuation">,</span> dest<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//2.遍历查找所有的jar包             </span>
            input<span class="token punctuation">.</span>jarInputs<span class="token punctuation">.</span>each <span class="token punctuation">{<!-- --></span>
                JarInput jarInput <span class="token operator">-</span><span class="token operator">&gt;</span>println
                <span class="token string">"\njarInput = ${jarInput}"</span>
                <span class="token comment">//与处理class文件一样，处理jar包也是一样，最后要将inputs转换为outputs                 </span>
                def jarName <span class="token operator">=</span> jarInput<span class="token punctuation">.</span>name
                def md5 <span class="token operator">=</span> DigestUtils<span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>jarInput<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>jarName<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".jar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    jarName <span class="token operator">=</span> jarName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> jarName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//获取输出路径下的jar包名称，必须这样获取，得到的输出路径名不能重复，否则会被覆盖</span>
                def dest <span class="token operator">=</span> outputProvider<span class="token punctuation">.</span><span class="token function">getContentLocation</span><span class="token punctuation">(</span>jarName <span class="token operator">+</span> md5<span class="token punctuation">,</span> jarInput<span class="token punctuation">.</span>contentTypes<span class="token punctuation">,</span> jarInput<span class="token punctuation">.</span>scopes<span class="token punctuation">,</span> Format<span class="token punctuation">.</span>JAR<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>jarInput<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".jar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//处理jar包里的代码                    </span>
                    File src <span class="token operator">=</span> jarInput<span class="token punctuation">.</span>file
                    <span class="token comment">//先简单过滤掉 support-v4 之类的jar包，只处理有我们业务逻辑的jar包                     </span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ScanUtil<span class="token punctuation">.</span><span class="token function">shouldProcessPreDexJar</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//扫描jar包的核心代码在这里，主要做2件事情：                         </span>
                        <span class="token comment">// 1.扫描该jar包里有没有实现IAppLike接口的代理类;                         </span>
                        <span class="token comment">// 2.扫描AppLifeCycleManager这个类在哪个jar包里，并记录下来，后面需要在该类里动态注入字节码;                         </span>
                        List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> ScanUtil<span class="token punctuation">.</span><span class="token function">scanJar</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dest<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            appLikeProxyClassList<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//将输入文件拷贝到输出目录下                 </span>
                FileUtils<span class="token punctuation">.</span><span class="token function">copyFile</span><span class="token punctuation">(</span>jarInput<span class="token punctuation">.</span>file<span class="token punctuation">,</span> dest<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        println <span class="token string">""</span> appLikeProxyClassList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>fileName <span class="token operator">-</span><span class="token operator">&gt;</span> println<span class="token string">"file name = "</span> <span class="token operator">+</span> fileName<span class="token punctuation">}</span><span class="token punctuation">)</span>
        println <span class="token string">"\n包含AppLifeCycleManager类的jar文件"</span> println ScanUtil<span class="token punctuation">.</span>
        FILE_CONTAINS_INIT_CLASS<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> println
        <span class="token string">"开始自动注册"</span>
        <span class="token comment">//1.通过前面的步骤，我们已经扫描到所有实现了 IAppLike接口的代理类；         </span>
        <span class="token comment">// 2.后面需要在 AppLifeCycleManager 这个类的初始化方法里，动态注入字节码；         </span>
        <span class="token comment">// 3.将所有 IAppLike 接口的代理类，通过类名进行反射调用实例化         </span>
        <span class="token comment">// 这样最终生成的apk包里，AppLifeCycleManager调用init()方法时，已经可以加载所有组件的生命周期类了        </span>
        <span class="token keyword">new</span> <span class="token class-name">AppLikeCodeInjector</span><span class="token punctuation">(</span>appLikeProxyClassList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        println <span class="token string">"transform finish----------------&lt;&lt;&lt;&lt;&lt;&lt;&lt;\n"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们来看看ScanUtil类里的代码逻辑：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ScanUtil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> PROXY_CLASS_PREFIX <span class="token operator">=</span><span class="token string">"Watson\$\$"</span><span class="token keyword">static</span> <span class="token keyword">final</span> PROXY_CLASS_SUFFIX <span class="token operator">=</span><span class="token string">"\$\$Proxy.class"</span><span class="token keyword">static</span> <span class="token keyword">final</span> PROXY_CLASS_PACKAGE_NAME <span class="token operator">=</span><span class="token string">"com/example/lifecycle/apt/proxy"</span><span class="token keyword">static</span> <span class="token keyword">final</span> REGISTER_CLASS_FILE_NAME <span class="token operator">=</span><span class="token string">"com/example/lifecycle/api/AppLifeCycleManager.class"</span><span class="token keyword">static</span> <span class="token keyword">final</span> REGISTER_CLASS_METHOD_NAME <span class="token operator">=</span><span class="token string">"loadApplicationDelegate"</span>
    <span class="token comment">//包含生命周期管理初始化类的文件，及包含 AppLifeCycleManager 类的class文件或者jar文件</span>
    <span class="token keyword">static</span> File FILE_CONTAINS_INIT_CLASS

    <span class="token comment">/**
     * 判断该class是否是我们的目标类
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isTargetProxyClass</span><span class="token punctuation">(</span>File file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>PROXY_CLASS_SUFFIX<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>PROXY_CLASS_PREFIX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 扫描jar包里的所有class文件：
     * * 1.通过包名识别所有需要注入的类名
     * * 2.找到注入管理类所在的jar包，后面我们会在该jar包里进行代码注入
     */</span>
    <span class="token keyword">static</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> <span class="token function">scanJar</span><span class="token punctuation">(</span>File jarFile<span class="token punctuation">,</span> File destFile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        def file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JarFile</span><span class="token punctuation">(</span>jarFile<span class="token punctuation">)</span> Enumeration<span class="token generics function"><span class="token punctuation">&lt;</span>JarEntry<span class="token punctuation">&gt;</span></span> enumeration <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> null <span class="token keyword">while</span> <span class="token punctuation">(</span>enumeration<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            JarEntry jarEntry <span class="token operator">=</span> enumeration<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> String entryName <span class="token operator">=</span> jarEntry<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entryName <span class="token operator">==</span> REGISTER_CLASS_FILE_NAME<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//标记这个jar包包含 AppLifeCycleManager.class                 </span>
                <span class="token comment">// 扫描结束后，我们会生成注册代码到这个文件里                 </span>
                FILE_CONTAINS_INIT_CLASS <span class="token operator">=</span> destFile
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entryName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>PROXY_CLASS_PACKAGE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> list<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>entryName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>entryName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> list
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldProcessPreDexJar</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"com.android.support"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"/android/m2repository"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>前面的代码里，先注释掉LifeCycleTransform类里的AppLikeCodeInjector相关代码，这块我们后面再讲。采用最新的插件重新build一下工程，看看Gradle Console里的输出信息。</p> 
<p><img src="https://images2.imgbox.com/d4/ab/R2cGBgYl_o.png" alt="捕获.PNG"></p> 
<p>可以看到，在Transform过程中，我们找到了NewsDelegate、MusicDelegate、MimeDelegate、MainDelegate这4个类的代理类，以及AppLifeCycleManager这个class文件所在的jar包。</p> 
<p><img src="https://images2.imgbox.com/de/06/7Ck1ljeo_o.png" alt="捕获.PNG"></p> 
<p>在app-&gt;build-&gt;intermediates-&gt;transforms中，可以看到所有的Transform，包括我们刚才自定义的LifeCycleTransform。从上图中可以看到，这里的0.jar、1.jar、2.jar等等，都是通过outputProvider.getContentLocation()方法来生成的，这个Transform目录下的class文件、jar包等，会当做下一个Transform的inputs传递过去。</p> 
<h4><a id="ASM_763"></a>通过ASM动态修改字节码</h4> 
<p>到现在，我们只剩下最后一步了，那就是如何注入代码了。ASM 是一个 Java 字节码操控框架，它能被用来动态生成类或者增强既有类的功能。我这里对ASM不做详细介绍了，主要是介绍使用ASM动态注入代码的思路。<br> 首先，我们修改一下AppLifeCycleManager类，增加动态注入字节码的入口方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppLifeCycleManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>IAppLike<span class="token punctuation">&gt;</span></span> APP_LIKE_LIST <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> REGISTER_BY_PLUGIN <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 通过插件加载 IApplicationDelegate 类
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadApplicationDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerApplicationDelegate</span><span class="token punctuation">(</span>String className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Object obj <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">IAppLike</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">registerApplicationDelegate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>IAppLike<span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 注册IApplicationDelegate
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerApplicationDelegate</span><span class="token punctuation">(</span>IAppLike appLike<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//标志我们已经通过插件注入代码了         </span>
        REGISTER_BY_PLUGIN <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        APP_LIKE_LIST<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>appLike<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 初始化
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">loadApplicationDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>REGISTER_BY_PLUGIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"hx"</span><span class="token punctuation">,</span> <span class="token string">"需要扫描所有类..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scanClassFile</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"hx"</span><span class="token punctuation">,</span> <span class="token string">"插件里已自动注册..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"hx"</span><span class="token punctuation">,</span> <span class="token string">"代理子模块数目："</span> <span class="token operator">+</span> APP_LIKE_LIST<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>APP_LIKE_LIST<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AppDelegateComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//优先级排序     </span>
    <span class="token punctuation">}</span>    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>相比之前，这里增加了一个loadApplicationDelegate()方法，在init()方法调用时会先执行。通过前面Transform步骤之后，我们现在的目标是把代码动态插入到loadApplicationDelegate()方法里，下面这段代码是我们期望插入后的结果：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadAppLike</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   
   <span class="token function">registerAppLike</span><span class="token punctuation">(</span><span class="token string">"com.example.lifecycle.apt.proxy.Watson$$MusicDelegate$$Proxy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
   <span class="token function">registerAppLike</span><span class="token punctuation">(</span><span class="token string">"com.example.lifecycle.apt.proxy.Watson$$MainDelegate$$Proxy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
   <span class="token function">registerAppLike</span><span class="token punctuation">(</span><span class="token string">"com.example.lifecycle.apt.proxy.Watson$$MimeDelegate$$Proxy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
   <span class="token function">registerAppLike</span><span class="token punctuation">(</span><span class="token string">"com.example.lifecycle.apt.proxy.Watson$$NewsDelegate$$Proxy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样在初始化时，就已经知道要加载哪些生命周期类，来看看具体实现方法，关于ASM不了解的地方，需要先搞清楚其使用方法再来阅读：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">AppLikeCodeInjector</span> <span class="token punctuation">{<!-- --></span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> proxyAppLikeClassList

    <span class="token function">AppLikeCodeInjector</span><span class="token punctuation">(</span>List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        proxyAppLikeClassList <span class="token operator">=</span> list
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"开始执行ASM方法======&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span><span class="token punctuation">)</span>
        File srcFile <span class="token operator">=</span> ScanUtil<span class="token punctuation">.</span>FILE_CONTAINS_INIT_CLASS
        <span class="token comment">//创建一个临时jar文件，要修改注入的字节码会先写入该文件里         </span>
        def optJar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> srcFile<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">".opt"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>optJar<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> optJar<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> def file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JarFile</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">)</span>
        Enumeration<span class="token generics function"><span class="token punctuation">&lt;</span>JarEntry<span class="token punctuation">&gt;</span></span> enumeration <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        JarOutputStream jarOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JarOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>optJar<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>enumeration<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            JarEntry jarEntry <span class="token operator">=</span> enumeration<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> String entryName <span class="token operator">=</span> jarEntry<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            ZipEntry zipEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipEntry</span><span class="token punctuation">(</span>entryName<span class="token punctuation">)</span>
            InputStream inputStream <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span>jarEntry<span class="token punctuation">)</span>
            jarOutputStream<span class="token punctuation">.</span><span class="token function">putNextEntry</span><span class="token punctuation">(</span>zipEntry<span class="token punctuation">)</span>
            <span class="token comment">//找到需要插入代码的class，通过ASM动态注入字节码             </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ScanUtil<span class="token punctuation">.</span>REGISTER_CLASS_FILE_NAME <span class="token operator">==</span> entryName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                println <span class="token string">"insert register code to class &gt;&gt; "</span> <span class="token operator">+</span> entryName
                ClassReader classReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span>
                <span class="token comment">// 构建一个ClassWriter对象，并设置让系统自动计算栈和本地变量大小                 </span>
                ClassWriter classWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span>ClassWriter<span class="token punctuation">.</span>COMPUTE_MAXS<span class="token punctuation">)</span>
                ClassVisitor classVisitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppLikeClassVisitor</span><span class="token punctuation">(</span>classWriter<span class="token punctuation">)</span>
                <span class="token comment">//开始扫描class文件                 </span>
                classReader<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>classVisitor<span class="token punctuation">,</span> ClassReader<span class="token punctuation">.</span>EXPAND_FRAMES<span class="token punctuation">)</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> classWriter<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//将注入过字节码的class，写入临时jar文件里                 </span>
                jarOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//不需要修改的class，原样写入临时jar文件里                 </span>
                jarOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>IOUtils<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> jarOutputStream<span class="token punctuation">.</span><span class="token function">closeEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> jarOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        file<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//删除原来的jar文件         </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>srcFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            srcFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//重新命名临时jar文件，新的jar包里已经包含了我们注入的字节码了         </span>
        optJar<span class="token punctuation">.</span><span class="token function">renameTo</span><span class="token punctuation">(</span>srcFile<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">AppLikeClassVisitor</span> <span class="token keyword">extends</span> <span class="token class-name">ClassVisitor</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">AppLikeClassVisitor</span><span class="token punctuation">(</span>ClassVisitor classVisitor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>Opcodes<span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> classVisitor<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        MethodVisitor <span class="token function">visitMethod</span><span class="token punctuation">(</span><span class="token keyword">int</span> access<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String desc<span class="token punctuation">,</span> String signature<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            println <span class="token string">"visit method: "</span> <span class="token operator">+</span> name
            MethodVisitor mv <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exception<span class="token punctuation">)</span>
            <span class="token comment">//找到 AppLifeCycleManager里的loadApplicationDelegate()方法             </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ScanUtil<span class="token punctuation">.</span>REGISTER_CLASS_METHOD_NAME <span class="token operator">==</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoadAppLikeMethodAdapter</span><span class="token punctuation">(</span>mv<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">return</span> mv
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">LoadAppLikeMethodAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">AdviceAdapter</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LoadAppLikeMethodAdapter</span><span class="token punctuation">(</span>MethodVisitor mv<span class="token punctuation">,</span> <span class="token keyword">int</span> access<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String desc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>Opcodes<span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> mv<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onMethodEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onMethodEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> println <span class="token string">"-------onMethodEnter------"</span>
            proxyAppLikeClassList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>proxyClassName <span class="token operator">-</span><span class="token operator">&gt;</span> println<span class="token string">"开始注入代码：${proxyClassName}"</span>def fullName <span class="token operator">=</span> ScanUtil<span class="token punctuation">.</span>PROXY_CLASS_PACKAGE_NAME<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> proxyClassName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> proxyClassName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>println<span class="token string">"full classname = ${fullName}"</span>mv<span class="token punctuation">.</span><span class="token function">visitLdcInsn</span><span class="token punctuation">(</span>fullName<span class="token punctuation">)</span>mv<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span>INVOKESTATIC<span class="token punctuation">,</span> <span class="token string">"com/example/lifecycle/api/AppLifeCycleManager"</span><span class="token punctuation">,</span> <span class="token string">"registerApplicationDelegate"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)V"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onMethodExit</span><span class="token punctuation">(</span><span class="token keyword">int</span> opcode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onMethodExit</span><span class="token punctuation">(</span>opcode<span class="token punctuation">)</span> println <span class="token string">"-------onMethodEnter------"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>clean工程（不然有时候看不到transform中输出的console log），使用插件重新编译代码：</p> 
<p><img src="https://images2.imgbox.com/0c/3c/1C8tzATB_o.png" alt="捕获.PNG"></p> 
<p>可以看到在编译过程中已经字节码增强注入了新的代码，最后打开APP运行，验证结果。<br> <img src="https://images2.imgbox.com/74/11/LItDOJ88_o.png" alt="捕获.PNG"><br> <a href="https://download.csdn.net/download/huaxun66/12120672"><strong>DEMO下载地址</strong></a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8f261f27bafbb2c00e3c5f1601c6d699/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">五步完成 Ubuntu 16.04 网卡bond</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/18ae6cf495431dcbaa6b0fcfb304a249/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">传值和传址</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>