<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx-rtmp协议解读 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nginx-rtmp协议解读" />
<meta property="og:description" content="前言 1.RTMP(实时消息传输协议)是Adobe 公司开发的一个基于TCP的应用层协议。
2.RTMP协议中基本的数据单元称为消息（Message）。
3.当RTMP协议在互联网中传输数据的时候，消息会被拆分成更小的单元，称为消息块（Chunk）。
一、握手协议 要建立一个有效的RTMP Connection链接，首先要“握手”:客户端要向服务器发送C0,C1,C2（按序）三个chunk，服务器向客户端发送S0,S1,S2（按序）三个chunk，然后才能进行有效的信息传输。RTMP协议本身并没有规定这6个Message的具体传输顺序，但RTMP协议的实现者需要保证这几点：
客户端要等收到S1之后才能发送C2客户端要等收到S2之后才能发送其他信息（控制信息和真实音视频等数据）服务端要等到收到C0之后发送S1服务端必须等到收到C1之后才能发送S2服务端必须等到收到C2之后才能发送其他信息（控制信息和真实音视频等数据）
如果每次发送一个握手chunk的话握手顺序会是这样： 在实际工程应用中，一般是客户端先将C0, C1块同时发出，服务器在收到C1 之后同时将S0, S1, S2发给客户端。之后客户端向服务器端发送C2块，简单握手完成。
｜client｜Server ｜ ｜－－－C0&#43;C1—-&gt;| ｜&lt;－－S0&#43;S1&#43;S2– | ｜－－－C2-－－－&gt; ｜ 下面是以此抓包截图：
握手数据格式：
在 Flash10.1 之后，Adobe 对 RTMP 握手进行了一轮修改，握手的步骤和上文记述的没有不同，而是对握手的数据进行了修改，采用了加密数据。因此，现在存在两种握手数据，一般通过C1[4:8]是否为0来区分。我们将使用0值称为简单握手(simple handshake)，将非0值的称为复杂握手(complex handshake)。
握手状态
Uninitialized
(未初始化)：协议的版本在这个状态中被发送。客户端在数据包C0中将协议版本发出，如果服务端支持这个版本，将在回应中发送S0和S1，并进入Version
Sent状态。如果不支持，服务端会终止连接。 Version Sent
(版本已发送)：客户端和服务端分别等待接收S1和C1。接收完成后，将会进入Ack Sent状态。 Ack Sent
(确认已发送)：客户端和服务端分别等待接收S2和C2。接收完成后，进入Handshake Done状态。 Handshake Done
(握手完成)：客户端和服务端可以开始交换消息了。
参考：https://www.jianshu.com/p/dc4fc2b58362
1.1 complex handshake Rtmp握手
•客户端发送C0&#43;C1一共是1537个bytes.
•服务端发送S0&#43;S1&#43;S2.
•客户端发送C2
•到此握手建立完成，双方收到C2和S2以后就可以发送命令了，C0，S0都占一个字节保存版本号，C1,S1占1536个字节一次是时间戳4bytes，0四个bytes,随机数填满。C2和S2占1536bytes,具体和C1差不多。
1.1.1 C0 和 S0 格式 C0 和 S0 包由一个字节组成，下面是 C0/S0 包内的字段：
0 1 2 3 4 5 6 7 &#43;-&#43;-&#43;-&#43;-&#43;-&#43;-&#43;-&#43;-&#43; | version | &#43;-&#43;-&#43;-&#43;-&#43;-&#43;-&#43;-&#43;-&#43; C0 and S0 bits version（1 byte）：RTMP 的版本，一般为 3 version（1 byte）：版本号，表示客户端请求的 RTMP 版本号或服务端支持的 RTMP 版本号。当前使用的版本是3。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/3f3c514ef0bdd0427d361dcdf047d5a9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-14T17:28:12+08:00" />
<meta property="article:modified_time" content="2021-06-14T17:28:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx-rtmp协议解读</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <hr color="#000000" size='1"'> 
<h2><a id="_5"></a>前言</h2> 
<p>1.RTMP(实时消息传输协议)是Adobe 公司开发的一个基于TCP的应用层协议。<br> 2.RTMP协议中基本的数据单元称为消息（Message）。<br> 3.当RTMP协议在互联网中传输数据的时候，消息会被拆分成更小的单元，称为消息块（Chunk）。<br> <img src="https://images2.imgbox.com/c3/27/Vwndt5a7_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_10"></a>一、握手协议</h2> 
<p>要建立一个有效的RTMP Connection链接，首先要“握手”:客户端要向服务器发送C0,C1,C2（按序）三个chunk，服务器向客户端发送S0,S1,S2（按序）三个chunk，然后才能进行有效的信息传输。RTMP协议本身并没有规定这6个Message的具体传输顺序，但RTMP协议的实现者需要保证这几点：</p> 
<ul><li>客户端要等收到S1之后才能发送C2</li><li>客户端要等收到S2之后才能发送其他信息（控制信息和真实音视频等数据）</li><li>服务端要等到收到C0之后发送S1</li><li>服务端必须等到收到C1之后才能发送S2</li><li>服务端必须等到收到C2之后才能发送其他信息（控制信息和真实音视频等数据）<br> 如果每次发送一个握手chunk的话握手顺序会是这样：</li></ul> 
<p><img src="https://images2.imgbox.com/5c/75/M2WdgmtI_o.png" alt="在这里插入图片描述"></p> 
<p>在实际工程应用中，一般是客户端先将C0, C1块同时发出，服务器在收到C1 之后同时将S0, S1, S2发给客户端。之后客户端向服务器端发送C2块，简单握手完成。</p> 
<pre><code class="prism language-c">｜client｜Server ｜
｜－－－C0<span class="token operator">+</span>C1—<span class="token operator">-&gt;</span><span class="token operator">|</span>
｜<span class="token operator">&lt;</span>－－S0<span class="token operator">+</span>S1<span class="token operator">+</span>S2– <span class="token operator">|</span>
｜－－－C2<span class="token operator">-</span>－－－<span class="token operator">&gt;</span> ｜
</code></pre> 
<p>下面是以此抓包截图：<br> <img src="https://images2.imgbox.com/6c/cb/zqmOMoAY_o.png" alt="在这里插入图片描述"><br> <strong>握手数据格式：</strong></p> 
<p>在 Flash10.1 之后，Adobe 对 RTMP 握手进行了一轮修改，握手的步骤和上文记述的没有不同，而是对握手的数据进行了修改，采用了加密数据。因此，现在存在两种握手数据，一般通过C1[4:8]是否为0来区分。我们将使用0值称为简单握手(simple handshake)，将非0值的称为复杂握手(complex handshake)。</p> 
<p>握手状态</p> 
<blockquote> 
 <p>Uninitialized<br> (未初始化)：协议的版本在这个状态中被发送。客户端在数据包C0中将协议版本发出，如果服务端支持这个版本，将在回应中发送S0和S1，并进入Version<br> Sent状态。如果不支持，服务端会终止连接。 Version Sent<br> (版本已发送)：客户端和服务端分别等待接收S1和C1。接收完成后，将会进入Ack Sent状态。 Ack Sent<br> (确认已发送)：客户端和服务端分别等待接收S2和C2。接收完成后，进入Handshake Done状态。 Handshake Done<br> (握手完成)：客户端和服务端可以开始交换消息了。<br> 参考：https://www.jianshu.com/p/dc4fc2b58362</p> 
</blockquote> 
<h3><a id="11_complex_handshake_49"></a>1.1 complex handshake</h3> 
<blockquote> 
 <p>Rtmp握手<br> •客户端发送C0+C1一共是1537个bytes.<br> •服务端发送S0+S1+S2.<br> •客户端发送C2<br> •到此握手建立完成，双方收到C2和S2以后就可以发送命令了，C0，S0都占一个字节保存版本号，C1,S1占1536个字节一次是时间戳4bytes，0四个bytes,随机数填满。C2和S2占1536bytes,具体和C1差不多。</p> 
</blockquote> 
<h4><a id="111___C0__S0__57"></a>1.1.1 C0 和 S0 格式</h4> 
<p>C0 和 S0 包由一个字节组成，下面是 C0/S0 包内的字段：</p> 
<pre><code class="prism language-cpp">     <span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span>
    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span>   version     <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">+</span>
     C0 <span class="token operator">and</span> S0 bits
     version（<span class="token number">1</span> byte）：RTMP 的版本，一般为 <span class="token number">3</span>
</code></pre> 
<p>version（1 byte）：版本号，表示客户端请求的 RTMP 版本号或服务端支持的 RTMP 版本号。当前使用的版本是3。</p> 
<h4><a id="112____C1__S1__69"></a>1.1.2 C1 和 S1 格式</h4> 
<p><img src="https://images2.imgbox.com/87/77/9bhtdLQL_o.png" alt="在这里插入图片描述"><br> key 和 digest 的顺序是不确定的，也有可能是:(nginx-rtmp中是如下的顺序)：<br> <img src="https://images2.imgbox.com/50/58/GKINhPza_o.png" alt="在这里插入图片描述"><br> 764 bytes <strong>key</strong> 结构：</p> 
<blockquote> 
 <p>random-data: (offset) bytes<br> key-data: 128 bytes<br> random-data: (764 - offset - 128 - 4) bytes<br> offset: 4 bytes</p> 
</blockquote> 
<p>764 bytes <strong>diges</strong>t 结构：</p> 
<blockquote> 
 <p>offset: 4 bytes<br> random-data: (offset) bytes<br> digest-data: 32 bytes<br> random-data: (764 - 4 - offset - 32) bytes</p> 
</blockquote> 
<h4><a id="113_C2__S2__87"></a>1.1.3 C2 和 S2 格式</h4> 
<p><img src="https://images2.imgbox.com/35/41/6gjAmbQf_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12_simple_handshake_90"></a>1.2 simple handshake</h3> 
<h4><a id="121_C0__S0__92"></a>1.2.1 C0 和 S0 格式</h4> 
<p>C0 和 S0 包由一个字节组成，下面是 C0/S0 包内的字段：<br> <img src="https://images2.imgbox.com/39/64/mPLE9bMM_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>version（1 byte）：<br> 版本 在 C0 包内，这个字段代表客户端请求的 RTMP 版本号。 在 S0 包内，这个字段代表服务端选择的<br> RTMP 版本号。<br> 当前使用的版本是 3。版本 0-2 用在早期的产品中，如今已经弃用； 版本 4-31 被预留用于后续产品； 版本<br> 32-255 （为了区分 RTMP 协议和文本协议，文本协议通常是可以打印字符）不允许使用。 如果服务器无法识别客户端的版本号，应该回复版本3。<br> 客户端可以选择降低到版本 3，或者终止握手过程。</p> 
</blockquote> 
<h4><a id="122_C1__S1__104"></a>1.2.2 C1 和 S1 格式</h4> 
<p>C1 和 S1 包长度为 1536 字节，包含以下字段</p> 
<p><img src="https://images2.imgbox.com/2a/fd/sTXt4ltv_o.png" alt="在这里插入图片描述"><br> time（4 bytes）：本字段包含一个时间戳，客户端应该使用此字段来标识所有流块的时刻。时间戳取值可以为零或其他任意值。为了同步多个块流，客户端可能希望多个块流使用相同的时间戳。<br> zero（4 bytes）：本字段必须为零。<br> random （1528 bytes）：本字段可以包含任意数据。由于握手的双方需要区分另一端，此字段填充的数据必须足够随机（以防止与其他握手端混淆）。不过没有必要为此使用加密数据或动态数据。</p> 
<h4><a id="123_C2__S2__113"></a>1.2.3 C2 和 S2 格式</h4> 
<p>C2 和 S2 包长度为 1536 字节，作为 C1 和 S1 的回应，包含以下字段：</p> 
<p><img src="https://images2.imgbox.com/49/9f/1cEfPYXt_o.png" alt="在这里插入图片描述"><br> time（4 bytes）：本字段必须包含对端发送的时间戳。<br> time2（4 bytes）：本字段必须包含时间戳，取值为接收对端发送过来的握手包的时刻。<br> random（1528 bytes）：本字段必须包含对端发送过来的随机数据。握手的双方可以使用时间 1 和时间 2 字段来估算网络连接的带宽和/或延迟，但是不一定有用。</p> 
<h3><a id="13_RTMP_Chunk_Stream_122"></a>1.3 RTMP Chunk Stream</h3> 
<blockquote> 
 <p>Chunk Stream是对传输RTMP Chunk的流的逻辑上的抽象，客户端和服务器之间有关RTMP的信息都在这个流上通信。这个流上的操作也是我们关注RTMP协议的重点。<br> 在RTMP协议中信令和媒体数据都称之为Message，在网络中传输这些Message，为了区分它们肯定是要加一个Message head的，所以RTMP协议也有一个Message head，还有一个问题因为RTMP协议是基于TCP的，由于TCP的包长度是有限制的（一般来说不超过1500个字节），而RTMP的Message长度是有可能很大的，像一个视频帧的包可能会有几十甚至几千K，这个问题就必然有一个分片的问题，在RTMP协议中对应的说法就是chunk，每一个Message + Message head都是由一个和多个chunk组成的。</p> 
</blockquote> 
<p><em><strong>RTMP包头 （Message(消息头)）</strong></em><br> <img src="https://images2.imgbox.com/ad/e1/GLDId6zV_o.png" alt="在这里插入图片描述"></p> 
<p>Basic Header + Message Header =1+11 = 12字节<br> 其实就是把chunk包组合一下重新构成一个新的RTMP包。</p> 
<blockquote> 
 <p>RTMP协议封包 由一个Message head包头和一个Message 包体组成。<br> 包头可以是4种长度的任意一种:12, 8, 4, 1byte(s).<br> 完整的RTMP包头应该是12bytes,包含了时间戳,Head_Type,AMFSize,AMFType,StreamID信息,<br> 8字节的包头只纪录了时间戳,Head_Type,AMFSize,AMFType,<br> 4个字节的包头记录了时间戳,Head_Type。<br> 1个字节的包头只记录了Head_Type<br> 包体最大长度默认为128字节,通过chunkSize可改变包体最大长度,通常当一段AFM数据超过128字节后,超过128的部分就放到了其他的RTMP封包中,包头为一个字节。</p> 
</blockquote> 
<blockquote> 
 <p>完整的RTMP包头有12字节，由下面5个部分组成:<br> <img src="https://images2.imgbox.com/f3/24/jVLEsSJ7_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p><strong>a) Head_Type - 包头类型</strong></p> 
<p>Head_Type占用RTMP包的第一个字节，这个字节里面记录了包的类型和包的ChannelID。Head_Type字节的前两个Bit决定了包头的长度.它可以用掩码0xC0进行"与"计算:</p> 
<blockquote> 
 <p>Head_Type的前两个Bit和长度对应关系：<br> <img src="https://images2.imgbox.com/23/9f/i95apnSW_o.png" alt="在这里插入图片描述"><br> Head_Type的后面6个Bit和StreamID决定了ChannelID。 StreamID和ChannelID对应关系：StreamID=(ChannelID-4)/5+1 。<br> 参考red5。<img src="https://images2.imgbox.com/86/5b/VlTNwGNV_o.png" alt="在这里插入图片描述"><br> 例如: 在rtmp包的数据中里面,发现被插入了一个0xC2,这个就是一字节的包头,并且channelID=2.</p> 
</blockquote> 
<p><em><strong>b) TiMMER - 时间戳</strong></em></p> 
<blockquote> 
 <p>时间戳占用RTMP包头的第2、3、4三个字节。<br> RTMP时间戳可分为绝对时间戳和相对时间戳，纪录的是音视频的时间信息。<br> 相对时间戳指的是二个RTMP包之间的时间间隔，单位毫秒。<br> 绝对时间戳指的是当前封包发送的时刻，单位也是毫秒。<br> 对于音视频的播放，时间戳非常关键，因为音视频的播放同步是由时间戳来控制的，如果你的视频出现卡顿，音视频不同步，延时越来越大，很可能就是你的时间戳不准导致的。<br> fms对于同一个流，发布(publish)的时间戳和播放(play)的时间戳是有区别的<br> publish时间戳,采用相对时间戳，时间戳值等于当前媒体包的绝对时间戳与上个媒体包的绝对时间戳之间的差距，也就是说音视频时间戳在一个时间轴上面.单位毫秒。<br> play时间戳，也是相对时间戳，时间戳值等于当前媒体包的绝对时间戳与上个同类型媒体包的绝对时间戳之间的差距,<br> 注意这里跟上面不同的是强调“同类型的媒体包”。也就是说音视频时间戳分别采用单独的时间轴，单位毫秒。<br> flv格式文件时间戳，绝对时间戳，时间戳长度3个字节。超过0xFFFFFF后时间戳值等于TimeStamp &amp; 0xFFFFFF。<br> flv格式文件影片总时间长度保存在onMetaData的duration属性里面，长度为8个字节，是一个double类型。</p> 
</blockquote> 
<p><em><strong>c）AMFSize - 数据大小</strong></em></p> 
<blockquote> 
 <p>AMFSize占3个字节，这个长度是AMF长度，可超过RTMP包的最大长度128字节。如果超过了128字节，那么由多个后续RTMP封包组合Chunk，每个后续RTMP封包(Chunk)的头只占一个字节。一般就是以0xC？开头。1个字节的包头表示这个包的时间戳、数据大小、数据类型、流ID都和上一个相同ChannelID的RTMP包完全一样。</p> 
</blockquote> 
<p><em><strong>d）AMFType - 数据类型</strong></em></p> 
<blockquote> 
 <p>AMFType是RTMP包里面的数据的类型，占用1个字节。例如音频包的类型为8，视频包的类型为9。下面列出的是常用的数据类型：<img src="https://images2.imgbox.com/03/6b/Dum7wY10_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p><em><strong>e）StreamID - 流 ID</strong></em></p> 
<blockquote> 
 <p>占用RTMP包头的最后4个字节，是一个big-endian的int型数据。<br> 我们x86计算机内存中数据存放都是小尾数模式：little-endian，而网络数据流一般都是大尾数模式：big-endian。<br> StreamID是音视频流的唯一ID,一路流如果既有音频包又有视频包，那么这路流音频包的StreamID和他视频包的StreamID相同，但ChannelID不同。<br> ChannelID 和StreamID之间的计算公式：StreamID=(ChannelID-4)/5+1 参考red5。<br> 如果这个封包既不是音频包，也不是视频包，那么他的StreamID=0.<br> 例如当音视频包ChannelID为2、3、4时StreamID都为1 当音视频包ChannelID为9的时候StreamID为2。</p> 
</blockquote> 
<p><em><strong>f ) RTMP 封包分析</strong></em></p> 
<p>更加确切的说这是一个chunk包，关于message包和chunk包区别，可以这样说，RTMP包（message包）也就是一个包两个名字，这个包在实际传输中并不存在，在实际环境中是通过chunk包来传输的。最后接收者通过chunk包组合成一个RTMP包（你的，明白？）</p> 
<p>这个数据结构在真是的传输环境中是通过chunk包来实现的。</p> 
<p>例如有一个RTMP封包的数据 (多个chunk包组合而成的包)<br> 0300 00 00 00 01 02 1400 00 00 00 0200 07 63 6F 6E 6E 65 63 74 003F F0 00 00 00 00 00 00 08 ，，，<br> 数据依次解析的含义<br> 03表示12字节头，channelid=3<br> 000000表示时间戳 Timer=0<br> 000102表示AMFSize=18<br> 14表示AMFType=Invoke 方法调用<br> 00 00 00 00 表示StreamID = 0<br> 到此,12字节RTMP头结束.</p> 
<p>下面的是AMF数据分析,具体的AMF0数据格式<br> AMF数据<br> 02表示String<br> 0007表示String长度7<br> 63 6F 6E 6E 65 63 74 是String的Ascall值"connect"<br> 00表示Double<br> 3F F0 00 00 00 00 00 00 表示double的0.0<br> 08表示Map数据开始</p> 
<p><em><strong>g ) AMF数据</strong></em></p> 
<blockquote> 
 <p>Rtmp包默认的最大长度为128字节,(或通过chunksize改变rtmp包最大长度),当AMF数据超过128Byte的时候就可能有多个rtmp(chunk)包组成，如果需要解码的rtmp包太长则被rtmp协议分割成多个rtmp包.那么解码的时候需要先将包含rtmp包合并, 再把合并的数据解码，解码后可得到amf格式的数据,将这些AMF数据取出来就可以对AMF数据解码了.<br> RTMP封包包括包头和AMF数据2部分，AMF数据里面可以是命令也可以是音视频数据。<br> 组成服务器和Flash客户端之间的所有数据都是用AMF格式的数据在传送,例如connect() publish()等命令。<br> AMF数据由2部分组成：<br> ObjType 和 ObjValue。<br> ObjType的大小为一个字节。<br> ObjValue的大小不固定，和ObjType相关。<br> 常用的ObjType类型和对应的ObjValue大小整理如下，详细的ObjType的数据在本文的最下面列出:<br> <img src="https://images2.imgbox.com/f8/f7/WUDR3VyH_o.png" alt="在这里插入图片描述"><br> ObjValue不一定是一个固定的大小，他可以包含另外一个AMF数据，这另外一个AMF数据里面又有ObjType 加上 ObjValue，也就是AMF数据的嵌套关系<br> AMF0数据的嵌套关系如下:<br> Object={ObjType + ObjValue}<br> CORE_BOOLEAN={Value(1 Byte)}<br> CORE_NUMBER={Value(8 Byte)}<br> CORE_String={StringLen(2 Byte) + StringValue(StringLen Byte)}<br> CORE_DATE={value(10 Byte)}<br> CORE_Array={ArrayLen(4 Byte) + Object}<br> CORE_Map={MapNum(4 Byte) + CORE_Object}<br> CORE_Object={CORE_String + Object}</p> 
</blockquote> 
<p>看起来有些复杂，所以我这里图文并茂来详解，例如完成握手后,Flash向FMS发送的第一个RTMP数据,内容如下:<br> <img src="https://images2.imgbox.com/8c/0e/QHvHvnNC_o.png" alt="在这里插入图片描述"><br> 蓝色的表示包头，红色的表示ObjType，绿色的表示数据。上面一段数据由2个RTMP包组成,2个RTMP包头分别用蓝色表示,第一个蓝色的是12字节的包头,后面一个蓝色的C3是一个字节的包头,绿色部分是数据,红色的是AMF数据类型,整个RTMP解码过程如下<br> [2008-06-18 16:59:20] DecodeInvoke:<br> [2008-06-18 16:59:20] InvokeName:String:connect<br> [2008-06-18 16:59:20] InvokeID:Double:0<br> [2008-06-18 16:59:20] Map:MapNum:0<br> [2008-06-18 16:59:20] Params:{<!-- --><br> [2008-06-18 16:59:20] Key:String:objectEncoding<br> [2008-06-18 16:59:20] Value:Double:0<br> [2008-06-18 16:59:20] Key:String:app<br> [2008-06-18 16:59:20] Value:String:mediaserver<br> [2008-06-18 16:59:20] Key:String:fpda<br> [2008-06-18 16:59:20] Value:Bool:0<br> [2008-06-18 16:59:20] Key:String:tcUrl<br> [2008-06-18 16:59:20] Value:String:rtmp://127.0.0.1/mediaserver<br> [2008-06-18 16:59:20] Key:String:audioCodecs<br> [2008-06-18 16:59:20] Value:Double:615<br> [2008-06-18 16:59:20] Key:String:videoCodecs<br> [2008-06-18 16:59:20] Value:Double:76<br> [2008-06-18 16:59:20] }End Params<br> [2008-06-18 16:59:20] InvokeParams:String:PUBLISHER<br> [2008-06-18 16:59:20] InvokeParams:String:streamRecode</p> 
<p>ps:</p> 
<blockquote> 
 <p>FMS3中为了实现H.264数据的直播而增加了一个数据类型,这个类型的值为0x16,这个类型</p> 
 <p>关于rtmp封包中数据类型为0x16的封包 。<br> 使用rtmp协议从FMS3中拉音视频数据的时候,会收到AMFType=0x16的封包,这种包在FMS2中从没有出现过.<br> rtmp包头的第8个字节就是AMFType,也就是数据类型。例如AMFType=0x08表示音频包，AMFType=0x04表示Ping包等等。FMS3中为了实现H.264数据的直播而增加了一个数据类型,这个类型的值为0x16。AMFType=0x16的包中既包含了音频帧也包含了视频帧。其中音频帧和视频帧是一种新的格式存放的，类似FLV文件存储格式，每个音视频包作为一个Tag,许多的Tag组成了这个AMFType=0x16的数据类型，Tag的格式如下：<img src="https://images2.imgbox.com/7b/36/qEl60gVU_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p><em><strong>Chunking(Message分块)</strong></em></p> 
<p>RTMP在收发数据的时候并不是以Message包为单位的，而是把Message包拆分成Chunk发送，而且必须在一个Chunk发送完成之后才能开始发送下一个Chunk。每个Chunk中带有MessageID代表属于哪个Message，接受端也会按照这个id来将chunk组装成Message。</p> 
<p>为什么RTMP要将Message拆分成不同的Chunk呢？通过拆分，数据量较大的Message可以被拆分成较小的“Message”，这样就可以避免优先级低的消息持续发送阻塞优先级高的数据，比如在视频的传输过程中，会包括视频帧，音频帧和RTMP控制信息，如果持续发送音频数据或者控制数据的话可能就会造成视频帧的阻塞，然后就会造成看视频时最烦人的卡顿现象。同时对于数据量较小的Message，可以通过对Chunk Header的字段来压缩信息，从而减少信息的传输量。（具体的压缩方式会在后面介绍）</p> 
<p>Chunk的默认大小是128字节，在传输过程中，通过一个叫做Set Chunk Size的控制信息可以设置Chunk数据量的最大值，在发送端和接受端会各自维护一个Chunk Size，可以分别设置这个值来改变自己这一方发送的Chunk的最大大小。大一点的Chunk减少了计算每个chunk的时间从而减少了CPU的占用率，但是它会占用更多的时间在发送上，尤其是在低带宽的网络情况下，很可能会阻塞后面更重要信息的传输。小一点的Chunk可以减少这种阻塞问题，但小的Chunk会引入过多额外的信息（Chunk中的Header），少量多次的传输也可能会造成发送的间断导致不能充分利用高带宽的优势，因此并不适合在高比特率的流中传输。在实际发送时应对要发送的数据用不同的Chunk Size去尝试，通过抓包分析等手段得出合适的Chunk大小，并且在传输过程中可以根据当前的带宽信息和实际信息的大小动态调整Chunk的大小，从而尽量提高CPU的利用率并减少信息的阻塞机率。<br> <img src="https://images2.imgbox.com/d9/a0/PjEg63s7_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/e2/1c/kYyOt7lq_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/9e/74/iOGr1X1V_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <ul><li>块的基本头(Basic Header)（1-3字节）：这个字段包含块流ID和块类型。块类型决定了编码过的消息头的格式。这个字段是一个变 长字段，长度取决于块流ID。</li><li>消息头(Message Header)（0,3,7,11字节）：这个字段包含被发送的消息信息（无论是全部，还是部分）。字段长度由块头中的 块类型来决定。</li><li>扩展时间戳(Extenderd Timestamp)（0,4字节）：这个字段是否存在取决于块消息头中编码的时间戳。 块数据（可变大小）：当前块的有效数据，上限为配置的最大块大小</li></ul> 
</blockquote> 
<p>关于Message Header这里为什么是11字节，而前面说的是12字节，这是因为前面将Basic Header也算到里面去了，一般来说我们常见的组合是 Basic Header + Message Header =1+11 = 12字节</p> 
<h6><a id="131_Basic_Header_290"></a>1.3.1 Basic Header</h6> 
<p>包含 chunk stream ID（流通道id）和chunk type（即fmt），chunk stream id 一般被简写为CSID，用来唯一标识一个特定的流通道，chunk type决定了后面Message Header的格式。<br> Basic Header的长度可能是 1，2，或 3 个字节，其中 chunk type 的长度是固定的（占2位，单位是bit），Basic Header 的长度取决于 CSID 的大小，在足够存储这两个字段的前提下最好用尽量少的字节从而减少由于引入Header增加的数据量。</p> 
<p>RTMP协议支持用户自定义 [3,65599] 之间的 CSID，0, 1, 2 由协议保留表示特殊信息。0 代表 Basic Header 总共要占用 2 个字节，CSID 在 [64,319] 之间; 1 代表占用 3 个字节，CSID 在 [64,65599] 之间; 2 代表该 chunk 是控制信息和一些命令信息</p> 
<h6><a id="1311__Basic_Header1_byte_296"></a>1.3.1.1 Basic Header：1 byte</h6> 
<p><img src="https://images2.imgbox.com/e3/e8/zAa9pKg6_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="1312__Basic_Header_2_byte__csid__0_298"></a>1.3.1.2 Basic Header: 2 byte , csid == 0</h6> 
<blockquote> 
 <p>CSID占14bit，此时协议将于chunk type所在字节的其他bit都置为0，剩下的一个字节表示CSID - 64，这样共有8个bit来存储 CSID，8 bit 可以表示 [0,255] 个数，因此这种情况下 CSID 在 [64,319]，其中 319 = 255 + 64。<br> <img src="https://images2.imgbox.com/16/4d/y8v7lTlc_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h6><a id="1313__Basic_Header_3_byte__csid__1_302"></a>1.3.1.3 Basic Header: 3 byte , csid == 1</h6> 
<blockquote> 
 <p>CSID占22bit，此时协议将第一个字节的[2,8]bit置1，余下的16个bit表示CSID -64，这样共有16个bit来存储CSID， 16bit可以表示[0,65535]共 65536 个数，因此这种情况下 CSID 在 [64,65599]，其中65599=65535+64，需要注意的是， BasicHeader是采用小端存储的方式，越往后的字节数量级越高，因此通过3个字节的每一个bit的值来计算CSID时， 应该是: &lt;第三个字节的值&gt; * 256 + &lt;第二个字节的值&gt; + 64.</p> 
</blockquote> 
<h6><a id="132__Message_Header_305"></a>1.3.2 Message Header</h6> 
<blockquote> 
 <p>包含了要发送的实际信息（可能是完整的，也可能是一部分）的描述信息。Message Header的格式和长度取决于BasicHeader的chunk type，即fmt，共有四种不同的格式。<br> 其中第一种格式可以表示其他三种表示的所有数据，但由于其他三种格式是基于对之前chunk的差量化的表示，因此可以更简洁地表示相同的数据，实际使用的时候还是应该采用尽量少的字节表示相同意 义的数据。下面按字节从多到少的顺序分别介绍这四种格式的 Message Header。</p> 
</blockquote> 
<p><strong>Message Header 四种消息头格式。</strong></p> 
<h6><a id="1321_Chunk_Typefmt__011_bytes_312"></a>1.3.2.1 Chunk Type(fmt) = 0：11 bytes</h6> 
<p><img src="https://images2.imgbox.com/d0/82/bt7R13c3_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>type=0时Message Header占用11个字节，其他三种能表示的数据它都能表示，但在chunk stream 的开始第一个chunk和头信息 中的时间戳后退（即值与上一个chunk相比减小，通常在回退播放的时候会出现这种情况）的时候必须采用这种格式。</p> 
 <p>timestamp（时间戳）：占用3个字节，因此它最多能表示到16777215=0xFFFFFF=2^24-1，当它<br> 的值超过这个最大值时，这三个字节都置为1，这样实际的timestamp会转存到 ExtendedTimestamp<br> 字段中，接收端在判断timestamp字段24个位都为1时就会去Extended Timestamp 中解析实际的时间戳。 message<br> length（消息数据长度）：占用3个字节，表示实际发送的消息的数据如音频帧、视频帧等数据的长度，单位是字节。注意这里是Message的长度，也就是chunk属于的Message的总长 度，而不是chunk本身data的长度.<br> message type id(消息的类型id)：1个字节，表示实际发送的数据的类型，如8代表音频数据， 9代表视频数据。 message stream<br> id(消息的流id)：4个字节，表示该chunk所在的流的ID，和Basic Header 的CSID一样，它采用小端存储方式。</p> 
</blockquote> 
<h6><a id="1322_Chunk_Typefmt__17_bytes_324"></a>1.3.2.2 Chunk Type(fmt) = 1：7 bytes</h6> 
<p><img src="https://images2.imgbox.com/39/84/1xXaub8m_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>type为1时占用7个字节，省去了表示message stream id的4个字节，表示此chunk和上一次发的 chunk 所在的流相同，如果在 发送端和对端有一个流链接的时候可以尽量采取这种格式。</p> 
 <p>timestamp delta：3 bytes，这里和type=0时不同，存储的是和上一个chunk的时间差。类似上面提到的timestamp，当它的值超过3个字节所能表示的最大值时，三个字节都置为1，实际 的时间戳差值就会转存到Extended<br> Timestamp字段中，接收端在判断timestamp delta字段24 个bit都为1时就会去Extended Timestamp<br> 中解析实际的与上次时间戳的差值。 其他字段与上面的解释相同.</p> 
</blockquote> 
<h6><a id="1323_Chunk_Typefmt__23_bytes_333"></a>1.3.2.3 Chunk Type(fmt) = 2：3 bytes</h6> 
<blockquote> 
 <p>type 为 2 时占用 3 个字节，相对于 type = 1 格式又省去了表示消息长度的3个字节和表示消息类型的1个字节，表示此chunk 和上一次发送的 chunk 所在的流、消息的长度和消息的类型都相同。余下的这三个字节表示 timestamp delta，使用同type=1。</p> 
</blockquote> 
<h6><a id="1324_Chunk_Typefmt__30_bytes_337"></a>1.3.2.4 Chunk Type(fmt) = 3：0 bytes</h6> 
<blockquote> 
 <p>type=3时，为0字节，表示这个chunk的Message Header和上一个是完全相同的。当它跟在type=0的chunk后面时，表示和前一 个 chunk 的时间戳都是相同。什么时候连时间戳都是相同呢？就是一个 Message 拆分成多个 chunk，这个 chunk 和上 一个 chunk 同属于一个 Message。而当它跟在 type = 1或 type = 2 的chunk后面时的chunk后面时，表示和前一个 chunk的时间戳的差是相同的。比如第一个 chunk 的 type = 0，timestamp = 100，第二个 chunk 的 type = 2， timestamp delta = 20，表示时间戳为 100 + 20 = 120，第三个 chunk 的 type = 3，表示timestamp delta = 20,</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/ac/f7/YP2B3srF_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="133__Extended_Timestamp_343"></a>1.3.3 Extended Timestamp(扩展时间戳)</h6> 
<blockquote> 
 <p>在 chunk 中会有时间戳 timestamp 和时间戳差 timestamp delta，并且它们不会同时存在，只有这两者之一大于3字节能表示的 最大数值 0xFFFFFF ＝ 16777215时，才会用这个字段来表示真正的时间戳，否则这个字段为 0。扩展时间戳占 4 个字节， 能表示的最大数值就是 0xFFFFFFFF ＝ 4294967295。当扩展时间戳启用时，timestamp字段或者timestamp delta要全置为1， 而不是减去时间戳或者时间戳差的值。</p> 
</blockquote> 
<h2><a id="2__347"></a>2 协议控制消息</h2> 
<p>RTMP 块流使用消息类型 ID 1、2、3、5、6 作为控制消息。这些消息包含了必要的 RTMP 块流协议信息。</p> 
<p>这些协议控制消息必须使用 0 作为消息流ID（作为已知的控制流ID），同时使用 2 作为块流ID。协议控制消息接收立即生效；<br> 解析时，时间戳字段被忽略。</p> 
<h3><a id="21____1_353"></a>2.1 设置块大小 (1)</h3> 
<p>协议控制消息（1），设置块大小，被用来通知对方新的最大的块大小。<br> 4个字节<br> <img src="https://images2.imgbox.com/7f/ae/ihOgEz7N_o.png" alt="在这里插入图片描述"></p> 
<p>默认最大的块大小为 128 字节，客户端和服务器可以使用此消息来修改默认的块大小。例如，假设客户端想要发送的音频数据大小为131 字节，而块大小为 128 字节。在这种情况下，客户端可以通知服务器新的块大小为 131 字节，然后就可以使用一个块来发送完整的音频数据了。</p> 
<p>最大的块大小至少为 128 字节，块至少携带 1 个字节的内容。通信的每一个方向（例如从客户端到服务器）拥有独立的块大小设置。</p> 
<p>0：当前比特位必须为零。<br> chunk size(31 bits): This field holds the new maximum chunk size, in bytes, which will be used for all of the sender’s<br> subsequent chunks until further notice. Valid sizes are 1 to 2147483647(0x7FFFFFFF) inclusive; however, all sizes<br> greater than 16777215(0xFFFFFF) are equivalent since no chunk is larger than onemessage, and no message is larger than<br> 16777215 bytes.<br> 块大小（31比特）：本字段标识了新的最大块大小，以字节为单位，发送端之后将使用此值作为最大的块大小。本字段的<br> 有效值为 1 - 2147483647(0x7FFFFFFF)，由于消息的最大长度为 16777215(0xFFFFFF)，而一个块最多只能携带一条消<br> 息，因此本字段的实际有效值为 1~16777215(0xFFFFFF)。<br> <img src="https://images2.imgbox.com/3d/49/p0iEaOsD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22____2_371"></a>2.2 中断消息 (2)</h3> 
<p>协议控制消息（2），中断消息，用来通知通信的对方，如果正在等待一条消息的部分块（已经接收了一部分），那么可以丢弃之前已经接收到的块。通信的一方将接收到块流ID作为当前协议消息的有效数据。应用程序可以发送此消息来通知对方，当前正在传输的消息没有必要再处理了。</p> 
<p><img src="https://images2.imgbox.com/d2/86/rdCw7rLG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23___3_375"></a>2.3 应答（3）</h3> 
<p>客户端和服务器在接收到与接收窗口大小相等的数据后，必须发送应答消息给对方。窗口大小的定义为发送方在接收到接收方的任何应答前，可以发送的最大数据量。本消息包含了序列号，序列号为截至目前接收到的数据总和，以字节为单位。</p> 
<p><img src="https://images2.imgbox.com/cb/c6/4hegKdU4_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="24__5_379"></a>2.4 应答窗口大小（5）</h3> 
<p>客户端和服务器发送这个消息来通知对方应答窗口的大小。发送方在发送了等于窗口大小的数据之后，等待接收对方的应答消息（在接收到应答之前停止发送数据）。接收方必须发送应答消息，在会话开始时，或从上一次发送应答之后接收到了等于窗口大小的数据。</p> 
<p><img src="https://images2.imgbox.com/ea/36/P9Lv8FmP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="25_35_6_386"></a>2.5 3.5 设置流带宽（6）</h3> 
<p>客户端和服务器发送此消息来说明对方的出口带宽限制。接收方以此来限制自己的出口带宽，即限制未被应答的消息数据大<br> 小。接收到此消息的一方，如果窗口大小与上次发送的不一致，应该回复应答窗口大小的消息。<br> <img src="https://images2.imgbox.com/38/ef/YO8IR6tv_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_Command_Message_17__20_391"></a>3 Command Message （17 或 20）</h2> 
<p>Command Message（命令消息，Message Type ID = 17 或 20）：表示在客户端和服务器间传递的在对端执行某些操作的命令消息，connect 表示连接对端，对端如果同意连接的话就会记录发送端信息并返回连接成功消息，publish 表示开始向对方推流，接收端接收到命令后准备好接收对端发送的流信息。当信息使用 AMF0 编码时，Message Type ID = 20，AMF3 编码时 为 17。</p> 
<p>服务器和客户端之间使用 AMF 编码的命令消息交互。 一些命令消息被用来发送操作指令，比如 connect，createStream，public，play，pause。另外一些命令消息被用来通知发送方请求命令的状态，比如 onstatus，result 等。一条命令消息包括命令对称、交互 ID、包含相关参数的命令对象。服务器和客户端通过在创建的流中远程调用的方式，使用命令消息来进行交互。</p> 
<p><img src="https://images2.imgbox.com/55/7f/rPxVwscb_o.png" alt="在这里插入图片描述"></p> 
<p>客户端和服务器通过 AMF 编码的数据交换命令。发送者发送包含命令名称，事务ID，包含相关参数的命令对象的消息。例如，通过连接命令中包含的 APP 参数来告诉服务器连接的对方是哪个客户端。接收方处理命令消息，并使用相同的事务ID应答。<br> 应答字符串为 _result 或 _error 或方法名，例如 verifyClient 或 contactExternalServer。事务 ID 标明了应答指向的命令。事务ID相当于 IMAP 协议或其他协议中的标签。命令字符串中的方法名，表明了发送端想要在接收端执行的方法。</p> 
<p>下面的类对象被用来发送各种命令：</p> 
<p>NetConnection：服务器和客户端之间进行网络连接的一种高级表示形式。<br> NetStream：代表了发送音频流，视频流，或其他相关数据的频道。当然还有一些像播放，暂停之类的命令，据流。</p> 
<h3><a id="31___407"></a>3.1 网络连接命令</h3> 
<p>网络连接管理着客户端和服务器之间的双向连接。另外，它也支持异步远程命令调用。<br> 网络连接允许使用以下的命令：</p> 
<p>连接 connect<br> 调用 call<br> 停止 close<br> 创建流 createStream<br> 建立网络连接</p> 
<h4><a id="31__NetConnection_421"></a>3.1 网络连接命令（NetConnection）</h4> 
<h4><a id="31_1_connect__423"></a>3.1 .1 connect: 连接</h4> 
<p>命令执行过程中的消息流如下:</p> 
<p>客户端发送连接命令给服务器，获得与服务器连接的实例。<br> 服务器在接收到连接命令后，发送应答窗口大小的消息给客户端。同时与连接命令中接到的应用建立连接。<br> 服务器发送设置流带宽消息给客户端。<br> 客户端在接收并处理了设置流带宽的消息后，发送应答窗口大小的消息给服务器。<br> 服务器接着发送开始流的用户控制消息给客户端。<br> 服务器发送 result 命令消息给客户端，通知连接状态是成功或失败。命令消息中包含了事务ID。消息中还包含了像 FMS版本之类的属性，以及级别，编码，描述，对象编码等信息。<br> <img src="https://images2.imgbox.com/97/5e/ifAOXaOi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ce/d4/2FKbOdld_o.png" alt="在这里插入图片描述"><br> 客户端发送连接命令给服务器，来获取一个和服务器通信的实例。客户端发送给服务器的命令结构如下：<br> <img src="https://images2.imgbox.com/bc/69/UaB1Sqgh_o.png" alt="在这里插入图片描述"><br> 下面是连接命令的命令对象Command Object里包含的键值对的说明：<br> <img src="https://images2.imgbox.com/34/43/vxUbhm4O_o.png" alt="在这里插入图片描述"><br> 音频编码属性的可选值：<br> 原始 PCM，ADPCM，MP3，NellyMoser（5，8,11，16，22，44kHz），AAC，Speex。</p> 
<p><img src="https://images2.imgbox.com/2b/d3/5eUM2izO_o.png" alt="在这里插入图片描述"></p> 
<p>视频编码属性的可选值：</p> 
<p>Sorenson，V1，On2，V2，H264.<br> <img src="https://images2.imgbox.com/a3/f3/LxlqV6ya_o.png" alt="在这里插入图片描述"><br> 视频函数属性的可选值：<br> <img src="https://images2.imgbox.com/37/41/YJzdrWYP_o.png" alt="在这里插入图片描述"></p> 
<p>对象编码属性的可选值：<br> <img src="https://images2.imgbox.com/fa/06/tZ7ngYan_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f6/f6/psi09NgT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/59/62/2rxhjNRy_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="31_2___call__455"></a>3.1 .2 call: 调用</h4> 
<p>网络连接对象中包含的 call 方法，会在接收端执行远程过程调用（RPC）。被调用的 RPC 方法名作为 call 方法的参数传输。</p> 
<p>从发送端到接收端的命令结构如下</p> 
<p><img src="https://images2.imgbox.com/70/7b/sP1Odaxp_o.png" alt="在这里插入图片描述"><br> 应答的命令结构如下<br> <img src="https://images2.imgbox.com/c7/0a/qRolTNFH_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="313_createStream__464"></a>3.1.3 createStream: 创建流</h4> 
<p><img src="https://images2.imgbox.com/2d/e0/UC0Q1e8T_o.png" alt="在这里插入图片描述"></p> 
<p>客户端通过发送此消息给服务器来创建一个用于消息交互的逻辑通道。音频，视频，和元数据都是通过 createStream 命令创建的流通道发布出去的。</p> 
<p>NetConnection 是默认的交互通道，流 ID 为0. 协议和一部分命令消息，包含 createStream，都是使用默认的交互通道发布的。</p> 
<p>从客户端发送给服务器的命令结构如下：</p> 
<p><img src="https://images2.imgbox.com/78/d4/cA3nbOnk_o.png" alt="在这里插入图片描述"><br> 从服务器发送给客户端的命令结构：<br> <img src="https://images2.imgbox.com/b2/c1/CXCIHaRi_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/41/06/Po8A2PMy_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dd/7f/POKlTWwu_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32__482"></a>3.2 网络连接命令</h3> 
<p>网络流定义了通过网络连接把音频，视频和数据消息流在客户端和服务器之间进行交换的通道。一个网络连接对象可以有多个<br> 网络流，进而支持多个数据流。</p> 
<p>客户端可以通过网络流发送到服务器的命令如下：</p> 
<p>播放play<br> 播放2 play2<br> 删除流 deleteStream<br> 关闭流 closeStream<br> 接收音频 receiveAudio<br> 接收视频 receiveVideo<br> 发布 publish<br> 定位 seek<br> 暂停 pause</p> 
<p><em><strong>服务器通过发送 onStatus 命令给客户端来通知网络流状态的更新:</strong></em></p> 
<p><img src="https://images2.imgbox.com/51/73/feSHzaIP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="321__play__504"></a>3.2.1 play: 播放</h3> 
<p>客户端发送此命令来通知服务器开始播放流。多次使用此命令可以创建一个播放列表。如果想要创建一个动态播放列表来在不同的直播或点播流之间切换，可以通过多次调用播放命令，同时将 Reset 字段设置为 false。相反，如果想要立即播放指定的流，先清理掉之前的播放队列，再调用播放命令，同时将 Reset 字段设置为 true。</p> 
<p>play 播放命令执行流程：</p> 
<p>当客户端接收到服务器返回的 createStream 成功的消息时，开始发送播放命令。<br> 服务器接收到播放命令后，发送设置块大小的消息。<br> 服务器发送一条用户控制消息，消息内包含了 StreamlsRecorded 事件和流ID。事件类型位于消息的前 2 个字节，流 ID位于消息的最后 4 个字节。<br> 服务器发送一条用户控制消息，消息内包含了 StreamBegin 事件，用于通知客户端开始播放流。<br> 如果客户端已经成功发送了播放命令，那么服务器发送两条 onStatus 命令给客户端，命令的内容为 NetStream.Play.Start和 NetStream.Play.Reset。服务器只有在客户端发送了设置有重置标签的播放命令后，才能发送 NetStream.Play.Reset命令。如果服务器找不到客户端请求播放的流，那么发送 NetStream.Play.StreamNotFound 命令给客户端。之后，服务器发送音频和视频数据给客户端。</p> 
<p>原文链接：<br> <img src="https://images2.imgbox.com/13/82/bDRsNxs7_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b4/ac/p3R7aLhS_o.png" alt="在这里插入图片描述"></p> 
<p>从客户端发送给服务器的命令结构如下：</p> 
<pre><code class="prism language-c"><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span> Field Name   <span class="token operator">|</span>   Type   <span class="token operator">|</span>             Description                 <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span> Command Name <span class="token operator">|</span>  String  <span class="token operator">|</span> Name of the command<span class="token punctuation">.</span> Set to <span class="token string">"play"</span><span class="token punctuation">.</span>     <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span> Transaction  <span class="token operator">|</span>  Number  <span class="token operator">|</span> Transaction ID set to <span class="token number">0.</span>                <span class="token operator">|</span>
    <span class="token operator">|</span> ID           <span class="token operator">|</span>          <span class="token operator">|</span>                                         <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span> Command      <span class="token operator">|</span>   Null   <span class="token operator">|</span> Command information does not exist<span class="token punctuation">.</span>     <span class="token operator">|</span>
    <span class="token operator">|</span> Object       <span class="token operator">|</span>          <span class="token operator">|</span> Set to null type<span class="token punctuation">.</span>                       <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span> Stream Name  <span class="token operator">|</span>  String  <span class="token operator">|</span> Name of the stream to play<span class="token punctuation">.</span>             <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> To play <span class="token function">video</span> <span class="token punctuation">(</span>FLV<span class="token punctuation">)</span> files<span class="token punctuation">,</span> specify the  <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> name of the stream without a file       <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> <span class="token function">extension</span> <span class="token punctuation">(</span><span class="token keyword">for</span> example<span class="token punctuation">,</span> <span class="token string">"sample"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> To   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> play back MP3 or ID3 tags<span class="token punctuation">,</span> you must     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> precede the stream name with mp3<span class="token operator">:</span>       <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token keyword">for</span> example<span class="token punctuation">,</span> <span class="token string">"mp3:sample"</span><span class="token punctuation">.</span> To play     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> H<span class="token punctuation">.</span><span class="token number">264</span><span class="token operator">/</span>AAC files<span class="token punctuation">,</span> you must precede the   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> stream name with mp4<span class="token operator">:</span> and specify the   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> file extension<span class="token punctuation">.</span> For example<span class="token punctuation">,</span> to play the<span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> file sample<span class="token punctuation">.</span>m4v<span class="token punctuation">,</span>specify <span class="token string">"mp4:sample.m4v"</span><span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span>                                         <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span> Start        <span class="token operator">|</span>  Number  <span class="token operator">|</span> An optional parameter that specifies    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> the start time in seconds<span class="token punctuation">.</span> The <span class="token keyword">default</span>  <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> value is <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> which means the subscriber <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> first tries to play the live stream     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> specified in the Stream Name field<span class="token punctuation">.</span> If a<span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> live stream of that name is not found<span class="token punctuation">,</span>it<span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> plays the recorded stream of the same   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> name<span class="token punctuation">.</span> If there is no recorded stream    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> with that name<span class="token punctuation">,</span> the subscriber waits <span class="token keyword">for</span><span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> a new live stream with that name and    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> plays it when available<span class="token punctuation">.</span> If you pass <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> in the Start field<span class="token punctuation">,</span> only the live stream<span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> specified in the Stream Name field is   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> played<span class="token punctuation">.</span> If you pass <span class="token number">0</span> or a positive     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> number in the Start field<span class="token punctuation">,</span> a recorded   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> stream specified in the Stream Name     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> field is played beginning from the time <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> specified in the Start field<span class="token punctuation">.</span> If no     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> recorded stream is found<span class="token punctuation">,</span> the next item <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> in the playlist is played<span class="token punctuation">.</span>              <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span> Duration     <span class="token operator">|</span>  Number  <span class="token operator">|</span> An optional parameter that specifies the<span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> duration of playback in seconds<span class="token punctuation">.</span> The    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> <span class="token keyword">default</span> value is <span class="token operator">-</span><span class="token number">1.</span> The <span class="token operator">-</span><span class="token number">1</span> value means <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> a live stream is played until it is no  <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> longer available or a recorded stream is<span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> played until it ends<span class="token punctuation">.</span> If you pass <span class="token number">0</span><span class="token punctuation">,</span> it <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> plays the single frame since the time   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> specified in the Start field from the   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> beginning of a recorded stream<span class="token punctuation">.</span> It is   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> assumed that the value specified in     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> the Start field is equal to or greater  <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> than <span class="token number">0.</span> If you pass a positive number<span class="token punctuation">,</span>  <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> it plays a live stream <span class="token keyword">for</span>              <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> the time period specified in the        <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> Duration field<span class="token punctuation">.</span> After that it becomes   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> available or plays a recorded stream    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> <span class="token keyword">for</span> the time specified in the Duration  <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> field<span class="token punctuation">.</span> <span class="token punctuation">(</span>If a stream ends before the     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> time specified in the Duration field<span class="token punctuation">,</span>   <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> playback ends when the stream ends<span class="token punctuation">.</span><span class="token punctuation">)</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> If you pass a negative number other     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> than <span class="token operator">-</span><span class="token number">1</span> in the Duration field<span class="token punctuation">,</span> it       <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> interprets the value as <span class="token keyword">if</span> it were <span class="token operator">-</span><span class="token number">1.</span>  <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span> Reset        <span class="token operator">|</span> Boolean  <span class="token operator">|</span> An optional Boolean value or number     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> that specifies whether to flush any     <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">|</span>          <span class="token operator">|</span> previous playlist<span class="token punctuation">.</span>                      <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
</code></pre> 
<h3><a id="322__play_2_600"></a>3.2.2 play: 播放2</h3> 
<p>与播放命令的不同之处在于，播放 2 命令可以在不修改播放内容时间线的前提下切换到一个不同码率的流。服务器包含了多个不同码率的流文件用于支持客户端的播放 2 请求。<br> 有关 NetStreamPlayOptions 对象的公开属性的说明详见 AS3 语言的文档。</p> 
<p>此命令的消息流如下所示：</p> 
<p>从客户端发送给服务器的命令结构如下：</p> 
<p><img src="https://images2.imgbox.com/0f/94/WPkRWACc_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/13/7e/GGZc59Um_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="323__deleteStream__612"></a>3.2.3 deleteStream: 删除流</h3> 
<p>如果需要销毁网络流对象，可以通过网络流发送删除流消息给服务器。</p> 
<p>客户端发送给服务器的命令结构如下：<br> <img src="https://images2.imgbox.com/33/1f/H5fJFJmy_o.png" alt="在这里插入图片描述"><br> 服务器接收到此消息后，不做任何回复。</p> 
<h3><a id="324___receiveAudio__619"></a>3.2.4 receiveAudio: 接收音频</h3> 
<p>网络流发送此消息通知服务器，是否要发送音频数据给客户端<br> <img src="https://images2.imgbox.com/18/79/VLjsYKmk_o.png" alt="在这里插入图片描述"><br> 如果服务器接收到带有 fasle 标签的消息后，不做任何回复。如果接收到带有 true 标签的消息，服务器回复带有NetStream.Seek.Notify 和 NetStream.Play.Start 的消息给客户端。</p> 
<h3><a id="325__receiveVideo__624"></a>3.2.5 receiveVideo: 接收视频</h3> 
<p>网络流发送此消息通知服务器，是否要发送视频数据给客户端。</p> 
<p>客户端发送给服务器的命令结构如下：</p> 
<p><img src="https://images2.imgbox.com/a0/4c/uRVT4BGx_o.png" alt="在这里插入图片描述"><br> 如果服务器接收到带有 false 标签的消息后，不做任何回复。如果接收到带有 true 标签的消息，服务器回复带有<br> NetStream.Seek.Notify 和 NetStream.Play.Start 的消息给客户端。</p> 
<h3><a id="326__publish__633"></a>3.2.6 publish: 发布</h3> 
<p>客户端发送此消息，用来发布一个有名字的流到服务器。其他客户端可以使用此流名来播放流，接收发布的音频，视频，以及其他数据消息。<br> <img src="https://images2.imgbox.com/69/01/PqWjTlmg_o.png" alt="在这里插入图片描述"><br> 服务器接收到此消息后，回复 onStatus 命令来标记发布的开始。</p> 
<p>示例1：发布录制的视频</p> 
<p>此示例阐述了发布者如果发布视频流到服务器。其他客户端可以订阅并播放此视频流。</p> 
<p><img src="https://images2.imgbox.com/55/19/hgxLOWdr_o.png" alt="在这里插入图片描述"><br> 示例2：从录制的流发布元数据</p> 
<p>本示例展示了发布元数据的消息交换过程。</p> 
<p><img src="https://images2.imgbox.com/0f/8f/SJ5O74b7_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="327___seek__649"></a>3.2.7 seek: 定位</h3> 
<p>客户端发送此消息来定位多媒体文件或播放列表的偏移（以毫秒为单位）。</p> 
<p>客户端发送给服务器的命令结构如下：<br> <img src="https://images2.imgbox.com/4f/56/VEjsxnan_o.png" alt="在这里插入图片描述"><br> 当定位完成后，服务器回复 NetStream.Seek.Notify 状态消息给客户端。如果定位失败，将回复 _error 消息。</p> 
<h3><a id="328___pause__656"></a>3.2.8 pause: 暂停</h3> 
<p>客户端发送此消息来通知服务器暂停或开始播放。</p> 
<p>客户端发送给服务器的命令结构如下<br> <img src="https://images2.imgbox.com/76/a0/VgobkyUB_o.png" alt="在这里插入图片描述"><br> 当流暂停成功，服务器发送 NetStream.Pause.Notify 状态消息给客户端，如果流未暂停，服务器发送<br> NetStream.Unpause.Notify 状态消息给客户端。如果暂停失败，则发送 _error 消息。</p> 
<h2><a id="33___Data_Message__15__18_663"></a>3.3 Data Message （ 15 或 18）</h2> 
<p>Data Message（数据消息，Message Type ID = 15 或 18）：传递一些元数据（Metadata，比如视频名，分辨率等等）或者用户自定义的一些消息。当信息使用 AMF0 编码时，Message Type ID = 18，AMF3 则为15.</p> 
<p>元数据包含了（音视频）数据的细节信息，像流的创建时间，时间点，主题等等.</p> 
<h2><a id="34__Shared_Object_Message_16__19_669"></a>3.4 Shared Object Message （16 或 19）</h2> 
<p>Shared Object Message（共享消息，Message Type ID = 16 或 19）：表示一个 Flash 类型的对象，由键值对的集合组成，用于多客户端，多实例时使用。AMF0 时 Message Type ID 为 19，AMF3 为 16。每个消息可以包含多个事件。</p> 
<p>共享消息格式<br> <img src="https://images2.imgbox.com/e6/7d/6mSvi80I_o.png" alt="在这里插入图片描述"></p> 
<p>下面是共享消息支持的事件类型：<br> <img src="https://images2.imgbox.com/5e/47/rWfA2vPn_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1e/a2/wlphYRtW_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="35_Audio_Message_8_678"></a>3.5 Audio Message （8）</h2> 
<p>Audio Message（音频信息，Message Type ID = 8）：音频数据</p> 
<h2><a id="36_Video_Message_9_681"></a>3.6 Video Message （9）</h2> 
<p>Video Message（视频信息，Message Type ID = 9）：视频数据</p> 
<h2><a id="37_Aggregate_Message_22_684"></a>3.7 Aggregate Message （22）</h2> 
<p>Aggregate Message（聚集信息，Message Type ID = 22）：多个 RTMP 子消息的集合。<br> 集合消息由消息头和消息内容组成。<br> 消息内容由子消息组成，子消息由消息头，消息数据，回放指针组成。</p> 
<p><img src="https://images2.imgbox.com/cd/0e/Sz1GcrbK_o.png" alt="在这里插入图片描述"></p> 
<p>集合消息的消息流 ID 覆盖此消息内的子消息流的ID。</p> 
<p>集合消息和第一个子消息的时间戳之间的偏移量，用来将子消息的时间戳处理为流的时间刻度。每个子消息的时间戳可以通过添加偏移量来处理为正常的流时间。第一个子消息的时间戳应该和集合消息的时间戳相同，因此偏移量应该为零。</p> 
<p>方向指针包含了以前的消息（包含头信息）的大小。集合消息包含此字段，一是为了适配 FLV 文件格式，二是为了回放定位。</p> 
<p>使用集合消息有如下几种优势：</p> 
<p>块流在一个块内至多可以携带一条完整的消息。使用集合消息之后，不仅可以增加块大小，同时还减少了发送的块数量；<br> 集合消息的子消息可以连续的存储在内存中。当系统调用网络发送数据时更高效。</p> 
<h2><a id="38_User_Control_Message_Events_4_701"></a>3.8 User Control Message Events （4）</h2> 
<p>User Control Message Events（用户控制消息，Message Type ID = 4）：告知对方执行该信息中包含的用户控制事件，比如Stream Begin 事件告知对方流信息开始传输。和前面提到的协议控制信息（Protocol Control Message）不同，用户控制消息是在 RTMP 协议层的，而不是在 RTMP chunk 流协议层，这个很容易弄混。该信息在 chunk 流中发送时，<br> Message Stream ID= 0，Chunk Strean id = 2，Message type id = 4.</p> 
<p>用户控制消息应该使用 0 作为消息流 ID，当通过 RTMP 块流发送此消息时，块流 ID 为 2. RTMP 流中的用户控制消息在接收时立即生效，消息中的时间戳被忽略。</p> 
<p>客户端或服务器发送此消息用来通知对方用户控制事件。此消息包含事件类型和事件数据。<br> <img src="https://images2.imgbox.com/d4/fb/RWqbvQ25_o.png" alt="在这里插入图片描述"><br> 用户控制消息的前 2 个字节数据用来标识事件类型。事件类型后面是事件数据。事件数据字段是可变的。由于此消息是通过RTMP 块流层发送的，块大小的最大值应该满足在一个块里包含此消息。</p> 
<p>用户控制事件支持如下类型：<br> <img src="https://images2.imgbox.com/1a/94/aPEbU2bU_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="381_Stream_Begin_713"></a>3.8.1 Stream Begin</h2> 
<p><img src="https://images2.imgbox.com/87/a1/ns70fBwE_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="382_streamIsrecord_715"></a>3.8.2 streamIsrecord</h2> 
<p><img src="https://images2.imgbox.com/d1/01/cuR5E5WY_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="383_Stream_EOF_717"></a>3.8.3 Stream EOF</h2> 
<p><img src="https://images2.imgbox.com/8e/a9/HOEZTm9I_o.png" alt="在这里插入图片描述"></p> 
<p>下面是nginx-rmp文件结构</p> 
<p>/* 点播相关*/</p> 
<p>ngx_rtmp_dash_module</p> 
<p>ngx_rtmp_mp4</p> 
<p>ngx_rtmp_mp4</p> 
<p>ngx_rtmp_mp4_module /* 主要支持rtmp MP4这块点播相关功能，支持seek操作*/</p> 
<p>ngx_rtmp_flv_module /* 主要是flv文件格式的点播相关功能，支持seek操作 */</p> 
<p>ngx_rtmp_play_module /* rtmp点播相关，支持本地，远程两种方式点播，远程点播http方式，支持flv，mp4两种格式 */</p> 
<p>ngx_rtmp_record_module /* 视频录制默认是flv格式， 支持按时间，按文件大小，帧个数录制文件 */</p> 
<p>/* hls文件切片相关*/</p> 
<p>ngx_rtmp_hls_module</p> 
<p>ngx_rtmp_mpegts</p> 
<p>/* rtmp机制整体框架， 协议握手，初始化相关，数据收发*/</p> 
<p>ngx_rtmp_handshake 主要是是三次握手相关</p> 
<p>ngx_rtmp_handler 主要是数据接收recv，发送send，ping命令相关</p> 
<p>ngx_rtmp_init 初始化连接相关的信息</p> 
<p>ngx_rtmp_core_module 主要是rtmp协议核心配置相关.</p> 
<p>ngx_rtmp rtmp配置解析，rtmp事件框架的初始化信息，注册事件回调函数(协议handler，amfhandler)</p> 
<p>/* rtmp直播，以及统计、通知、控制相关功能*/</p> 
<p>ngx_rtmp_receive 主要是rtmp协议数据接收这块</p> 
<p>ngx_rtmp_send 数据发送这块，以及各种rtmp消息包发送封装的函数</p> 
<p>ngx_rtmp_live_module主要处理接收音视频消息数据，以及ngx_rtmp_live_av中进行数据分发，从接收到发送给每个其他session</p> 
<p>ngx_rtmp_netcall_module 主要是http请求相关部分</p> 
<p>ngx_rtmp_notify_module 主要rtmp发送http请求，通知作用主要监听connect,disconnect,play,publish,close,record_done等相关事件</p> 
<p>ngx_rtmp_relay_module 主要是rtmp提供回源请求拉流，以及转推，监听_result，_error, onStatus</p> 
<p>ngx_rtmp_stat_module 主要是rtmp流状态信息可以输出到本地文件</p> 
<p>ngx_rtmp_shared 主要是rtmp协议内存管理方面，其中用到了引用计数来管理内存</p> 
<p>ngx_rtmp_bandwidth 主要是rtmp协议的带宽计费</p> 
<p>ngx_rtmp_cmd_module rtmp消息命令相关play，publish</p> 
<p>ngx_rtmp_codec_module rtmp音视频编解码信息相关</p> 
<p>ngx_rtmp_control_module 主要是一些控制接口，录制开始/暂停，支持record,query,drop相关的接口</p> 
<p>ngx_rtmp_eval 主要提供一些变量替换的函数接口，有内存泄漏</p> 
<p>ngx_rtmp_amf ngx_rtmp_bitop 主要是封装读，写amf包信息</p> 
<p>ngx_rtmp_access_module 监听play，publish事件，对ip做检查访问</p> 
<p>ngx_rtmp_auto_push_module 多进程方案，推流来时，自动推流到其他worker进程</p> 
<p>ngx_rtmp_exec_module 主要监听publish，play，close，record_done事件，然后进行执行脚本进行相应的业务，如转码</p> 
<p>ngx_rtmp_limit_module 主要监听connect以及disconnect事件，通过计算连接数量来限制连接个数</p> 
<p>ngx_rtmp_log_module 主要是rtmp日志相关，连接断开disconncet事件的时候，输出访问日志相关</p> 
<p>业务相关扩展功能大体有四类：统计、通知、控制。它们的实现代价如下：<br> “统计”处理了数据收发部分的代码；<br> “通知”事件框架；<br> “控制”耦合了具体功能的调用；<br> 还有其他一些异常消息情况</p> 
<p>参考：<br> https://www.cnblogs.com/jimodetiantang/p/8974075.html<br> https://blog.csdn.net/weixin_39371129/article/details/74576960</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8ed28218d7ccaf3d1c376b5f5aa05dbd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【数学建模】评价模型</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/00545691f57244b69773ae7b41695caa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">云服务器部署nginx</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>