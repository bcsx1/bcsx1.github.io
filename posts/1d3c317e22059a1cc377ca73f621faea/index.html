<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>推荐系统实战 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="推荐系统实战" />
<meta property="og:description" content="今天在朋友圈看到一篇“一号店从0到1构建推荐系统通用平台”，突然感觉很有感触，上线八年的一号店从0到1构建，那我们这个5.19上线的百联o2o平台，推荐系统说是从-1爬到0.x更确切。很多时候看到都是某大型电商或互联网平台某个系统的架构图，这个架构图都很高大上，似曾相识，展示的都是很美好的一面。很少有人介绍在实现这个系统最初遇到的各种问题，因为电商发展至今，最初的那几个人早已已经成为技术总监或者cto了，都已经功成名就出书立传了。如果感兴趣可以看看专著《大数据架构商业之路:从业务需求到技术方案》豆瓣好评推荐。 虽然之前也曾接触过推荐系统,但也都是其中的某个算法，或者说大一点其中的某个栏位。也看过《推荐系统实践》这样的图书，现在反观一下，感觉这些更像是一本介绍推荐算法的书，而不是能落地的一套系统。在这里就是想记录一下，在百联全渠道(bl.com),和另外一个同事踩坑排雷实现百联推荐系统的一个过程。希望后来者能从中吸取教训。这篇文章没有高深架构图，复杂逻辑图，基本凭记忆，用文字讲述俩人历时4个月构建一个推荐系统雏形的历程。
数据准备阶段
商品数据
首先要了解数据，电商就是贩卖商品的，与商品相关的一些概念包括商品（sku）,产品(spu),属性、品类，自营、商城（商家）等，在这个阶段先了解一下商品和产品。借用某东的解答：spu就是一个苹果6s, sku就是银色苹果6s、灰色苹果6s 。这种一个携带基本属性的spu，衍生多个sku的情况在服饰类里最多见，同一款衬衫对应不同颜色、不同尺码。 一个spu 有多个属性，不同spu有不同属性，属性又分为属性和属性值。属性和属性值又分别用key,value表示。看个简单例子，手机苹果（Apple）iPhone 6S 64G 玫瑰金色移动联通电信4G手机，在百联商品ID是248397，对应的产品ID是30277，其中部分属性如下表，在数据库里面产品的一条属性，包括(roduct_sid,props_sid,values_sid)三项。这张表的数据在后面做推荐的时候还会用到。可以看到这里面没有价格，价格是和商品绑定的，顺便广告一下，即时价格是5188，和某东某店价格差不多，但保证有货，而且，尤其预约抢购的产品可以来百联（bl.com）看看。 再一个概念就是品类，对于品类不同的平台有不同的划分和叫法，总之有前台类目，后台类目。一个商品依据其功用划分到一个后台类目，后台类目可以映射到多个前台类目。例如手机的类目层级就是这样手机数码/电脑办公&gt;手机通讯&gt;手机。顺便说一下，这个类目导航叫面包屑导航，来自童话故事”汉赛尔和格莱特”，作用是告诉你目前在网站中的位置以及如何返回。 当然情人节来临的时候，网站类目多了个情人节礼物类目，也可以把手机这个类目映射到情人节礼物这个前台类目上。例如在1号店手机这个类目也可以映射到送男士这个类目下，创意礼品、礼品卡&gt;送男士&gt;数码通讯&gt;手机&gt;。至此与商品相关的数据基本够用了。接下来需要了解与用户相关的数据。
行为数据 对于用户产生的数据可以概括为何人(user_id)在何时（time）、何地（gps坐标，ip）对何种商品(item_id)通过何种渠道(channel_id)产生了何种行为（behavior_type ）,这样的数据格式和阿里推荐大赛数据格式基本一致。数据来源可以通过埋点和日志收集获得。 这里用到的是用户ID，用户在pc端访问时，通常不会登陆，那么只能取到系统的一个cookie_id,cookie_id和user_id可能出现多对多情况。我们主要通过把cookie_id绑定到紧邻其后第一个登陆的user_id来把cookie_id绑定起来，丰富用户行为。至此，必要的数据已经准备完了，接下来就要实现推荐栏位了。
实现推荐栏位 了解完数据结构，组织数据到此已经过了半个月了，要在一个月以内跑通推荐系统流程，就要立刻着手搭框架，上算法编接口了。此时还没产品经理，就按照老套路，先对详情页栏位入手，“看了又看”、“看了最终买”，“买了还买“，有了这三个栏位，推荐系统基本完成大半。既然大数据，那大数据工具一定还是要用一下，spark风头正盛，刚好公司也倡导，就用spark了。幸好在跳槽前学过一周快学scala,那就直接上手吧，看了又看，买了还买之类的简单关联采用简易bayes实现起来都不是问题。于是和另外一个同事，开始编写离线数据处理的部分，处理结果就是对于某个商品，如果是看了又看栏位，该给它推荐哪些商品。很快离线处理部分就结束了。Hive里面的原始数据，经过spark处理，写到了redis，再写个接口，传入一个商品ID，在redis一读取返回几个商品id就结束了。 此时应该过去有一个月了，就剩接口开发了，当时想，这个太简单了，一个栏位给一个接口，一天就搞定了。虽然百联还未正式对外宣布上线（5.19百联全渠道正式加入电商大家庭），但是也是对外访问的接口，健壮性还是需要的，那还是要搭个可靠的架构，部署俩tomcat,前端加个nginx做负载均衡,再申请个二级域名。Redis也配成master_slave模式。后面开发猜你喜欢接口，主从模式的redis遇到很多问题，无奈改用redis集群，由此引起接口整个重构。 架构搞定了，开始写接口，通过接口返回结果发现，返回的商品个数参差不齐，很多商品都无用户行为。只靠离线处理结果，无法满足栏位需求。需要制定每个接口返回商品规则， 以“看了又看”为例，最终一个栏位获得的5个或者的，10个商品，就是按照如下顺序得来，基本上踩一个坑加一项。真是如一位同事讲的“都开始怀疑人生了”，此时之前的一位同事已经离职，又新进一位同事。 这个规则的最低目标是，推荐栏位不能留白，这一条由“热门随机商品”来保证。在满足最低目标的情况下还要最求品质，首当其冲的是用户行为产生的推荐结果，这是大数据落地的表现。对于无用户行为的商品（未必是新品），推荐相似商品。如果是新品，无相似商品的推荐同品类下随机商品。本以为到这里坑踩得差不多了，不成想有的品类下只有一两个商品，没办法用兄弟类目下商品来补。 一个坑补一段代码，一个栏位复制粘贴一下，到此代码已经惨不忍睹，但是还是奔着之前的规划在前进，先可用再追求易用。虽然此时代码已惨不忍睹了，我还跟这位刚来的同事打了一个比喻，我指着窗外的高楼说，你看盖楼的，都是浇筑框架，再装修，怎么不盖一层装修一层。这句话对同事产生了重大影响，虽不能受用一生，估计也要懵一阵。 这里再补充几个细节，第一就是相似商品计算，其实就是根据商品本身的属性计算相似商品的相似性。每个属性有个权重，这个权重采用tf/idf，如果拥有某个属性的商品越多，那么该属性，权重越小。每个商品用属性来表示，两两计算余弦距离。如果计算两个文档相似性，估计大家更容易理解。用在两个商品上，估计还需要思维转换一下，文本不都是字词吗，怎么就是54071，54039……。计算的时候商品限定在同一品类下，把value_sid映射到一个向量空间，这个空间的维度是一个常数，也许会设置很大。 推荐接口返回哪些内容哪，一般情况下，都是返回一串商品id,调用方再去查询商品价格、图片，标题、库存。当时也是这么想的，最后只提供推荐商品ID，这样推荐系统风险、责任也小一点。但是必须携带的信息还是要准备的，这个初衷还是想方便自己查看到底推荐出来的是什么东西。还有一个附加信息就是这个商品到底出自哪个“坑”，以“看了又看”为例，每个商品后面都跟着一个商品来源，是来自用户浏览，还是相似商品，或者其它的”坑“。 百联在没有推荐之前，前端都是调用搜索接口，在该类目下随机取几个商品，商品价格、库存一起取来。当时一种方案是推荐出来的商品ID，传给搜索接口，取回实时商品信息。这个方案其实两方都不喜欢，搜索感觉增加负担，增加风险。我们推荐也感觉延迟太大。既然我们必要信息都有，那么就取我们自己的商品信息。为了减少不T&#43;1数据更新带来的不一致，最初想把搜索实时数据接过来，可最终也没成，还打击了离职同事的自尊心。无奈只能增加从百联“中台”数据库更新的频率。每天更新三次，这三次中间出现的不一致就无能无力了。就这样，详情页三个栏位基本上线了。偶尔价格不一致，也没出现大的问题，无非是同spu商品个数过多等小问题。 至此走通了从数据抽取、数据处理、数据存储到接口提供的整个流程，就如标题写的一样，都不算是一个系统。至此大概俩月过去了，接下来就应该实现电商里面推荐重头戏“猜你喜欢”了。 这个栏位算法主流就是基于邻域或者模型的协同过滤算法。算法不是首要考虑的问题，既然平台用到了spark，当然首选就是als。既然算法没问题，重点就是数据了，算法应用案例都是用户评论打分这样的显示反馈。从之前经验知道，很多用户购买不评论，评论的也只为赚积分，有的人文字描述是差评打分是五星。加之系统刚刚上线，用户购买少，购买的商品基本偏向食品、零食之类的商超品类。为了增加推荐新颖性和多样性，先用用户浏览行为做一版，对浏览行为给个权重，随日期衰减和累加。数据套入算法，根据接口要求取打分最高的topn。未登陆或新用户给推荐热门，把一天时间分为早中晚时间段，分别推荐该时间段热门浏览的或者爆款，为了多样化，随机选取。至此好像这个栏位比性情页来的还要轻松，接口代码无非再增加一个函数。 首先上线的是pc端。该栏位处在整个页面的最下面，用户拉到最低显示猜你喜欢，还没上线，pc开发就发现问题了，说出现重复商品。后来反复查看接口，接口无分页，也做过sku,spu,品类商品数量控制之类的校验。后来pc开发发现问题，是因为他们是下拉到可视区域加载，每加载一栏请求一次接口，而接口返回商品有随机性，因此位置不固定，出现不同栏商品重复的情况。首页调用到查看完猜你喜欢栏位，前后调用7次，而且还出现不一致。因此必须要把用户推荐结果进行缓存。回写redis,过期时间设为两分钟。两分钟足够用户浏览完六栏推荐商品了。可问题来了，采用master-slave模式的redis在缓存方面实在是无法满足。为了满足健壮性，只能一个tomcat绑定一个redis,把slave开启可写模式。Nginx 改为IP hash模式。后来通过查看tomcat实际请求日志发现，多数IP基本映射到一台机器。系统可靠性又岌岌可危，眼下首要问题是更换redis集群。可面临一个问题是，前同事配的开发环境用的是Spring MVC 加RedisClientTemplate来读取redis，搜遍baidu也没找到怎么更换到redis cluster。 但是更换redis机群的想法还是没动摇，兵分两路，一路一个人，申请三台机器，另一个同事参考官网文档，部署了redis集群，然后着手处理离线代码，全部改为redis机群，我也在着手把接口更换为读redis机群。此时，很多接口已提前开发完，就等前端调用，开发任务没那么重，也有时间回头看一下代码。也对之前的开发流程做了个梳理，从熟悉数据、业务，到hive脚本数据处理，到spark 算法处理输出到redis，从部署tomcat，redis到nginx负载均衡,基本都是俩个人实现。过程也是从一个坑到另一个坑，基本上都被坑牵着走，还没来的及好好看路。借着这次redis更换，把接口也重构一把。 重构推荐接口 目前百联用到的推荐接口主要还是实现商品推荐，之前的实现方式是每上一个接口，增加一段代码。有的参数都一致，只是重新起个名字，区别可能是pc端和移动端显示方式的差别。当时就想这样的问题，能不能连代码都不用改，只是配置一下就可以了。朝着这个方向开始重新设计，设计的目标朝着可重用、可扩展、可监控、可评估方向进行。 为此，对于商品推荐只提供一个接口，不同栏位用参数进行区分，构造一个统一参数魔板。 首先在数据库为为接口建了一张表，把实物推荐所涉及的参数罗列出来 到目前，这些参数满足基本应用，也可以根据需要进行扩展，比如可以传入gps坐标位置，实现基于lbs推荐。 接下来需要考虑的就是，在优化算法效果的时候通常要做ABtest。为此设计了API与method的映射表 在这个设计中，一个栏位对应多个方法，这些方法有序排列，并指定所占流量占比。在用户访问时会分配一个随机数，这个随机数落在哪个区间，即走其对应的方法，这里存在一个问题就是，用户两次访问可能走不同的方法，可以通过缓存当天用户分配随机数解决。 因此如果该接口Track_type配置为记录推荐结果，在推荐结果里要增加字段method_code，来区分通过不通方法返回结果，用于后续做转化对比。 每个方法可能需要多个来源的数据组合起来才能满足栏位需求。而这些数据源又可以分为两类，一类就是前面离线处理的比如算法产生的数据，来源redis里面的，另一类是需要经过变换的数据，例如依据商品ID，找到其所属类目的兄弟类目下的商品。为此我们设计了方法与数据源的对应关系表 以百联移动端首页猜你喜欢为例，api为gyl,channel为1，决定了一个推荐栏位，这个栏位推荐60个商品，需要分页，目前采用的以LFM协同过滤(spark als),这个栏位组合顺序为，前6个为基于usercf的推荐结果（0.1*60）,后面是基于lfm算法的。通过观察不同用户推荐效果 发现很多用户都是新用户，基本没历史行为，为这类用户推荐最近10分钟热门top20商品，对于某类用户，有历史行为数据，但是近一段时间没有，为这类用户依据历史用户偏好进行推荐。最后为防止留白，proportion=1表示，尽量把该栏位填满。 对于redis里面数据源，由key前缀和输入参数的取值拼接构成，取值用参数名到传入参数列表中去取。 至此，增加一个栏位推荐接口，如果已有数据源的情况下，就可以通过组合不同数据源来实现，无需改动任何代码。为此app猜你喜欢的接口访问形式如下： http://rec.bl.com/xx/rec?api=gyl&amp;chan=1&amp;memberId=100000000162626&amp;pNum=1&amp;pSize=10 数据库设计好，数据存在mysql,在原先接口增加mybatis框架，读取配置。配置何时加载哪，第一方案是定时加载，在spring mvc 加入quartz晚上定时加载，每天更新一次，为了即时生效，增加接口调用，通过调用接口，立刻生效。 接口重构从规划到数据库设计到代码更改，接入redis 集群，用了大概一周的时间，又用了一周时间来测试。测试方法不能手工，况且就俩人测试也不全面，于是到tomcat把原先访问日志里面的请求url下载下来，对新接口和新redis重新调用一遍，每个接口用不同的参数组合调用几万次，直到没有bug通过为止。至此redis集群和配置接口升级完毕。 2 引入实时数据处理 前面在规划的时候，就对每个接口，设置了track类型，最初的设想是，记录给每个用户的推荐内容，对于无转化的情况，减少推荐次数，防止用户疲劳，另一个应用是想用推荐无转化情况作为反例，训练个模型，对于详情页实现“千人千面”，人人不同。那么首要问题就是怎么记录这些，kafka必须的，其它电商平台有的，我们也可以有，自己搭建。当然亲自动手的还是另外一个同事，测试环境配上三台kafka，同时我也在接口里面把“猜你喜欢”接口推荐结果写进kafka.这个过程很短，基本不到一周就实现。（很多自己开发的电商平台，可能在开发的时候，就已经规划了埋点，日志收集，对于实时数据的收集不是问题。对于百联采用的是第三方平台，实时收集难度大，实施比较久时间久） 有了kafka就要利用，spark streaming处理实时能用，这个也用上，对于传来的曝光数据进行解析写入hbase,以备后续使用。此后又增加了几个跟实时相关的应用，首先通过修改前端调用接口传递参数，实现三端用户访问商品实时记录。未登陆用户推荐什么，实时热门商品，10分钟更新一次。登陆用户根据当天访问行为1个小时更新一次。三端浏览记录实时同步，pc浏览商品，即刻出现移动端浏览记录里。 此时基本框架构造完成了，基本栏位也覆盖了，之前t&#43;1的商品价格、库存、上下架信息滞后矛盾也突出了。产品经理联系中台，让中台变更信息，实时写入我们kafka。为实现实现价格库存、上下架等信息同步，重新更新商品信息，增加商品上下架和库存信息，之前redis只保存可售有库存商品，这样遗留的问题就是，只有商品上架，无商品下架，只能每天多次清空下架商品。这类实时数据接入，所有问题迎刃而解，距离初次提出这个需求也已快半年之久。 至此，百联推荐系统已初具雏形。这中间又有一个新同事加入到项目组，负载开发推荐运营工具。负责热搜词、商品运营配置工具开发。在这里我们只介绍整个系统从无到有的过程，算法用的也都是一些主流的算法，bayes,usercf,itemcf,als,word2vector,(word2vector在商品相似性计算过程用测试过，主要想实现商品跨品类推荐，类似买了还买)。再下一步在现有框架基础上，来优化算法、增加用户属性和商品属性，实现更精准推荐。
后续优化 丰富算法、丰富数据、提升转化效果，目前已爬取某店三千个类目商品、品牌，价格分布及40几万商品价格、评论数据，做对比分析处理。如有进展再交流。百联刚起步，我们的推荐系统初具雏形。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/1d3c317e22059a1cc377ca73f621faea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-01-23T13:19:35+08:00" />
<meta property="article:modified_time" content="2017-01-23T13:19:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">推荐系统实战</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>今天在朋友圈看到一篇“一号店从0到1构建推荐系统通用平台”，突然感觉很有感触，上线八年的一号店从0到1构建，那我们这个5.19上线的百联o2o平台，推荐系统说是从-1爬到0.x更确切。很多时候看到都是某大型电商或互联网平台某个系统的架构图，这个架构图都很高大上，似曾相识，展示的都是很美好的一面。很少有人介绍在实现这个系统最初遇到的各种问题，因为电商发展至今，最初的那几个人早已已经成为技术总监或者cto了，都已经功成名就出书立传了。如果感兴趣可以看看专著《大数据架构商业之路:从业务需求到技术方案》豆瓣好评推荐。 <br> 虽然之前也曾接触过推荐系统,但也都是其中的某个算法，或者说大一点其中的某个栏位。也看过《推荐系统实践》这样的图书，现在反观一下，感觉这些更像是一本介绍推荐算法的书，而不是能落地的一套系统。在这里就是想记录一下，在百联全渠道(bl.com),和另外一个同事踩坑排雷实现百联推荐系统的一个过程。希望后来者能从中吸取教训。这篇文章没有高深架构图，复杂逻辑图，基本凭记忆，用文字讲述俩人历时4个月构建一个推荐系统雏形的历程。</p> 
<hr> 
<p><strong>数据准备阶段</strong></p> 
<ol><li><p>商品数据</p> <p>首先要了解数据，电商就是贩卖商品的，与商品相关的一些概念包括商品（sku）,产品(spu),属性、品类，自营、商城（商家）等，在这个阶段先了解一下商品和产品。借用某东的解答：spu就是一个苹果6s, sku就是银色苹果6s、灰色苹果6s 。这种一个携带基本属性的spu，衍生多个sku的情况在服饰类里最多见，同一款衬衫对应不同颜色、不同尺码。 <br> 一个spu 有多个属性，不同spu有不同属性，属性又分为属性和属性值。属性和属性值又分别用key,value表示。看个简单例子，手机苹果（Apple）iPhone 6S 64G 玫瑰金色移动联通电信4G手机，在百联商品ID是248397，对应的产品ID是30277，其中部分属性如下表，在数据库里面产品的一条属性，包括(roduct_sid,props_sid,values_sid)三项。这张表的数据在后面做推荐的时候还会用到。可以看到这里面没有价格，价格是和商品绑定的，顺便广告一下，即时价格是5188，和某东某店价格差不多，但保证有货，而且，尤其预约抢购的产品可以来百联（bl.com）看看。 <br><img src="https://images2.imgbox.com/fc/1b/LAZe0dUQ_o.jpg" alt="图片描述" title=""></p></li></ol> 
<p>再一个概念就是品类，对于品类不同的平台有不同的划分和叫法，总之有前台类目，后台类目。一个商品依据其功用划分到一个后台类目，后台类目可以映射到多个前台类目。例如手机的类目层级就是这样手机数码/电脑办公&gt;手机通讯&gt;手机。顺便说一下，这个类目导航叫面包屑导航，来自童话故事”汉赛尔和格莱特”，作用是告诉你目前在网站中的位置以及如何返回。 <br> 当然情人节来临的时候，网站类目多了个情人节礼物类目，也可以把手机这个类目映射到情人节礼物这个前台类目上。例如在1号店手机这个类目也可以映射到送男士这个类目下，创意礼品、礼品卡&gt;送男士&gt;数码通讯&gt;手机&gt;。至此与商品相关的数据基本够用了。接下来需要了解与用户相关的数据。</p> 
<ol><li>行为数据</li></ol> 
<p>对于用户产生的数据可以概括为何人(user_id)在何时（time）、何地（gps坐标，ip）对何种商品(item_id)通过何种渠道(channel_id)产生了何种行为（behavior_type ）,这样的数据格式和阿里推荐大赛数据格式基本一致。数据来源可以通过埋点和日志收集获得。 <br><img src="https://images2.imgbox.com/c5/68/eBqk34X6_o.jpg" alt="图片描述" title=""><br> 这里用到的是用户ID，用户在pc端访问时，通常不会登陆，那么只能取到系统的一个cookie_id,cookie_id和user_id可能出现多对多情况。我们主要通过把cookie_id绑定到紧邻其后第一个登陆的user_id来把cookie_id绑定起来，丰富用户行为。至此，必要的数据已经准备完了，接下来就要实现推荐栏位了。</p> 
<hr> 
<hr> 
<p><strong>实现推荐栏位</strong> <br> 　　了解完数据结构，组织数据到此已经过了半个月了，要在一个月以内跑通推荐系统流程，就要立刻着手搭框架，上算法编接口了。此时还没产品经理，就按照老套路，先对详情页栏位入手，“看了又看”、“看了最终买”，“买了还买“，有了这三个栏位，推荐系统基本完成大半。既然大数据，那大数据工具一定还是要用一下，spark风头正盛，刚好公司也倡导，就用spark了。幸好在跳槽前学过一周快学scala,那就直接上手吧，看了又看，买了还买之类的简单关联采用简易bayes实现起来都不是问题。于是和另外一个同事，开始编写离线数据处理的部分，处理结果就是对于某个商品，如果是看了又看栏位，该给它推荐哪些商品。很快离线处理部分就结束了。Hive里面的原始数据，经过spark处理，写到了redis，再写个接口，传入一个商品ID，在redis一读取返回几个商品id就结束了。 <br> 　　此时应该过去有一个月了，就剩接口开发了，当时想，这个太简单了，一个栏位给一个接口，一天就搞定了。虽然百联还未正式对外宣布上线（5.19百联全渠道正式加入电商大家庭），但是也是对外访问的接口，健壮性还是需要的，那还是要搭个可靠的架构，部署俩tomcat,前端加个nginx做负载均衡,再申请个二级域名。Redis也配成master_slave模式。后面开发猜你喜欢接口，主从模式的redis遇到很多问题，无奈改用redis集群，由此引起接口整个重构。 <br> 　　架构搞定了，开始写接口，通过接口返回结果发现，返回的商品个数参差不齐，很多商品都无用户行为。只靠离线处理结果，无法满足栏位需求。需要制定每个接口返回商品规则， <br> 　　以“看了又看”为例，最终一个栏位获得的5个或者的，10个商品，就是按照如下顺序得来，基本上踩一个坑加一项。真是如一位同事讲的“都开始怀疑人生了”，此时之前的一位同事已经离职，又新进一位同事。 <br> 　　<img src="https://images2.imgbox.com/51/9b/oJUr4zKs_o.png" alt="图片描述" title=""><br> 这个规则的最低目标是，推荐栏位不能留白，这一条由“热门随机商品”来保证。在满足最低目标的情况下还要最求品质，首当其冲的是用户行为产生的推荐结果，这是大数据落地的表现。对于无用户行为的商品（未必是新品），推荐相似商品。如果是新品，无相似商品的推荐同品类下随机商品。本以为到这里坑踩得差不多了，不成想有的品类下只有一两个商品，没办法用兄弟类目下商品来补。 <br> 　　一个坑补一段代码，一个栏位复制粘贴一下，到此代码已经惨不忍睹，但是还是奔着之前的规划在前进，先可用再追求易用。虽然此时代码已惨不忍睹了，我还跟这位刚来的同事打了一个比喻，我指着窗外的高楼说，你看盖楼的，都是浇筑框架，再装修，怎么不盖一层装修一层。这句话对同事产生了重大影响，虽不能受用一生，估计也要懵一阵。 <br> 　　这里再补充几个细节，第一就是相似商品计算，其实就是根据商品本身的属性计算相似商品的相似性。每个属性有个权重，这个权重采用tf/idf，如果拥有某个属性的商品越多，那么该属性，权重越小。每个商品用属性来表示，两两计算余弦距离。如果计算两个文档相似性，估计大家更容易理解。用在两个商品上，估计还需要思维转换一下，文本不都是字词吗，怎么就是54071，54039……。计算的时候商品限定在同一品类下，把value_sid映射到一个向量空间，这个空间的维度是一个常数，也许会设置很大。 <br><img src="https://images2.imgbox.com/29/de/L1rQJDtG_o.png" alt="图片描述" title=""><br> 推荐接口返回哪些内容哪，一般情况下，都是返回一串商品id,调用方再去查询商品价格、图片，标题、库存。当时也是这么想的，最后只提供推荐商品ID，这样推荐系统风险、责任也小一点。但是必须携带的信息还是要准备的，这个初衷还是想方便自己查看到底推荐出来的是什么东西。还有一个附加信息就是这个商品到底出自哪个“坑”，以“看了又看”为例，每个商品后面都跟着一个商品来源，是来自用户浏览，还是相似商品，或者其它的”坑“。 <br> 　　百联在没有推荐之前，前端都是调用搜索接口，在该类目下随机取几个商品，商品价格、库存一起取来。当时一种方案是推荐出来的商品ID，传给搜索接口，取回实时商品信息。这个方案其实两方都不喜欢，搜索感觉增加负担，增加风险。我们推荐也感觉延迟太大。既然我们必要信息都有，那么就取我们自己的商品信息。为了减少不T+1数据更新带来的不一致，最初想把搜索实时数据接过来，可最终也没成，还打击了离职同事的自尊心。无奈只能增加从百联“中台”数据库更新的频率。每天更新三次，这三次中间出现的不一致就无能无力了。就这样，详情页三个栏位基本上线了。偶尔价格不一致，也没出现大的问题，无非是同spu商品个数过多等小问题。 <br> 　　至此走通了从数据抽取、数据处理、数据存储到接口提供的整个流程，就如标题写的一样，都不算是一个系统。至此大概俩月过去了，接下来就应该实现电商里面推荐重头戏“猜你喜欢”了。 <br> 　　这个栏位算法主流就是基于邻域或者模型的协同过滤算法。算法不是首要考虑的问题，既然平台用到了spark，当然首选就是als。既然算法没问题，重点就是数据了，算法应用案例都是用户评论打分这样的显示反馈。从之前经验知道，很多用户购买不评论，评论的也只为赚积分，有的人文字描述是差评打分是五星。加之系统刚刚上线，用户购买少，购买的商品基本偏向食品、零食之类的商超品类。为了增加推荐新颖性和多样性，先用用户浏览行为做一版，对浏览行为给个权重，随日期衰减和累加。数据套入算法，根据接口要求取打分最高的topn。未登陆或新用户给推荐热门，把一天时间分为早中晚时间段，分别推荐该时间段热门浏览的或者爆款，为了多样化，随机选取。至此好像这个栏位比性情页来的还要轻松，接口代码无非再增加一个函数。 <br> 　　首先上线的是pc端。该栏位处在整个页面的最下面，用户拉到最低显示猜你喜欢，还没上线，pc开发就发现问题了，说出现重复商品。后来反复查看接口，接口无分页，也做过sku,spu,品类商品数量控制之类的校验。后来pc开发发现问题，是因为他们是下拉到可视区域加载，每加载一栏请求一次接口，而接口返回商品有随机性，因此位置不固定，出现不同栏商品重复的情况。首页调用到查看完猜你喜欢栏位，前后调用7次，而且还出现不一致。因此必须要把用户推荐结果进行缓存。回写redis,过期时间设为两分钟。两分钟足够用户浏览完六栏推荐商品了。可问题来了，采用master-slave模式的redis在缓存方面实在是无法满足。为了满足健壮性，只能一个tomcat绑定一个redis,把slave开启可写模式。Nginx 改为IP hash模式。后来通过查看tomcat实际请求日志发现，多数IP基本映射到一台机器。系统可靠性又岌岌可危，眼下首要问题是更换redis集群。可面临一个问题是，前同事配的开发环境用的是Spring MVC 加RedisClientTemplate来读取redis，搜遍baidu也没找到怎么更换到redis cluster。 <br> 　　但是更换redis机群的想法还是没动摇，兵分两路，一路一个人，申请三台机器，另一个同事参考官网文档，部署了redis集群，然后着手处理离线代码，全部改为redis机群，我也在着手把接口更换为读redis机群。此时，很多接口已提前开发完，就等前端调用，开发任务没那么重，也有时间回头看一下代码。也对之前的开发流程做了个梳理，从熟悉数据、业务，到hive脚本数据处理，到spark 算法处理输出到redis，从部署tomcat，redis到nginx负载均衡,基本都是俩个人实现。过程也是从一个坑到另一个坑，基本上都被坑牵着走，还没来的及好好看路。借着这次redis更换，把接口也重构一把。 <br> 　　</p> 
<hr> 
<p><strong>重构推荐接口</strong> <br> 目前百联用到的推荐接口主要还是实现商品推荐，之前的实现方式是每上一个接口，增加一段代码。有的参数都一致，只是重新起个名字，区别可能是pc端和移动端显示方式的差别。当时就想这样的问题，能不能连代码都不用改，只是配置一下就可以了。朝着这个方向开始重新设计，设计的目标朝着可重用、可扩展、可监控、可评估方向进行。 <br> 为此，对于商品推荐只提供一个接口，不同栏位用参数进行区分，构造一个统一参数魔板。 <br> 首先在数据库为为接口建了一张表，把实物推荐所涉及的参数罗列出来 <br><img src="https://images2.imgbox.com/0c/b2/CAEfAggC_o.png" alt="图片描述" title=""><br> 到目前，这些参数满足基本应用，也可以根据需要进行扩展，比如可以传入gps坐标位置，实现基于lbs推荐。 <br> 接下来需要考虑的就是，在优化算法效果的时候通常要做ABtest。为此设计了API与method的映射表 <br><img src="https://images2.imgbox.com/22/32/eYbLRc90_o.png" alt="图片描述" title=""></p> 
<pre><code>在这个设计中，一个栏位对应多个方法，这些方法有序排列，并指定所占流量占比。在用户访问时会分配一个随机数，这个随机数落在哪个区间，即走其对应的方法，这里存在一个问题就是，用户两次访问可能走不同的方法，可以通过缓存当天用户分配随机数解决。
因此如果该接口Track_type配置为记录推荐结果，在推荐结果里要增加字段method_code，来区分通过不通方法返回结果，用于后续做转化对比。
</code></pre> 
<p>每个方法可能需要多个来源的数据组合起来才能满足栏位需求。而这些数据源又可以分为两类，一类就是前面离线处理的比如算法产生的数据，来源redis里面的，另一类是需要经过变换的数据，例如依据商品ID，找到其所属类目的兄弟类目下的商品。为此我们设计了方法与数据源的对应关系表 <br><img src="https://images2.imgbox.com/e9/93/nf3fPbqJ_o.png" alt="图片描述" title=""></p> 
<p>以百联移动端首页猜你喜欢为例，api为gyl,channel为1，决定了一个推荐栏位，这个栏位推荐60个商品，需要分页，目前采用的以LFM协同过滤(spark als),这个栏位组合顺序为，前6个为基于usercf的推荐结果（0.1*60）,后面是基于lfm算法的。通过观察不同用户推荐效果 <br> 发现很多用户都是新用户，基本没历史行为，为这类用户推荐最近10分钟热门top20商品，对于某类用户，有历史行为数据，但是近一段时间没有，为这类用户依据历史用户偏好进行推荐。最后为防止留白，proportion=1表示，尽量把该栏位填满。 <br><img src="https://images2.imgbox.com/a2/dc/6WOcTrIA_o.png" alt="图片描述" title=""></p> 
<p>对于redis里面数据源，由key前缀和输入参数的取值拼接构成，取值用参数名到传入参数列表中去取。 <br><img src="https://images2.imgbox.com/00/f2/UHcxdsRW_o.png" alt="图片描述" title=""></p> 
<p>至此，增加一个栏位推荐接口，如果已有数据源的情况下，就可以通过组合不同数据源来实现，无需改动任何代码。为此app猜你喜欢的接口访问形式如下： <br><a href="http://rec.bl.com/xx/rec?api=gyl&amp;chan=1&amp;memberId=100000000162626&amp;pNum=1&amp;pSize=10" rel="nofollow">http://rec.bl.com/xx/rec?api=gyl&amp;chan=1&amp;memberId=100000000162626&amp;pNum=1&amp;pSize=10</a> <br> 数据库设计好，数据存在mysql,在原先接口增加mybatis框架，读取配置。配置何时加载哪，第一方案是定时加载，在spring mvc 加入quartz晚上定时加载，每天更新一次，为了即时生效，增加接口调用，通过调用接口，立刻生效。 <br> 接口重构从规划到数据库设计到代码更改，接入redis 集群，用了大概一周的时间，又用了一周时间来测试。测试方法不能手工，况且就俩人测试也不全面，于是到tomcat把原先访问日志里面的请求url下载下来，对新接口和新redis重新调用一遍，每个接口用不同的参数组合调用几万次，直到没有bug通过为止。至此redis集群和配置接口升级完毕。 <br> 2 引入实时数据处理 <br> 前面在规划的时候，就对每个接口，设置了track类型，最初的设想是，记录给每个用户的推荐内容，对于无转化的情况，减少推荐次数，防止用户疲劳，另一个应用是想用推荐无转化情况作为反例，训练个模型，对于详情页实现“千人千面”，人人不同。那么首要问题就是怎么记录这些，kafka必须的，其它电商平台有的，我们也可以有，自己搭建。当然亲自动手的还是另外一个同事，测试环境配上三台kafka，同时我也在接口里面把“猜你喜欢”接口推荐结果写进kafka.这个过程很短，基本不到一周就实现。（很多自己开发的电商平台，可能在开发的时候，就已经规划了埋点，日志收集，对于实时数据的收集不是问题。对于百联采用的是第三方平台，实时收集难度大，实施比较久时间久） <br> 有了kafka就要利用，spark streaming处理实时能用，这个也用上，对于传来的曝光数据进行解析写入hbase,以备后续使用。此后又增加了几个跟实时相关的应用，首先通过修改前端调用接口传递参数，实现三端用户访问商品实时记录。未登陆用户推荐什么，实时热门商品，10分钟更新一次。登陆用户根据当天访问行为1个小时更新一次。三端浏览记录实时同步，pc浏览商品，即刻出现移动端浏览记录里。 <br> 此时基本框架构造完成了，基本栏位也覆盖了，之前t+1的商品价格、库存、上下架信息滞后矛盾也突出了。产品经理联系中台，让中台变更信息，实时写入我们kafka。为实现实现价格库存、上下架等信息同步，重新更新商品信息，增加商品上下架和库存信息，之前redis只保存可售有库存商品，这样遗留的问题就是，只有商品上架，无商品下架，只能每天多次清空下架商品。这类实时数据接入，所有问题迎刃而解，距离初次提出这个需求也已快半年之久。 <br> 至此，百联推荐系统已初具雏形。这中间又有一个新同事加入到项目组，负载开发推荐运营工具。负责热搜词、商品运营配置工具开发。在这里我们只介绍整个系统从无到有的过程，算法用的也都是一些主流的算法，bayes,usercf,itemcf,als,word2vector,(word2vector在商品相似性计算过程用测试过，主要想实现商品跨品类推荐，类似买了还买)。再下一步在现有框架基础上，来优化算法、增加用户属性和商品属性，实现更精准推荐。</p> 
<p><strong>后续优化</strong> <br> 丰富算法、丰富数据、提升转化效果，目前已爬取某店三千个类目商品、品牌，价格分布及40几万商品价格、评论数据，做对比分析处理。如有进展再交流。百联刚起步，我们的推荐系统初具雏形。</p> 
<p><img src="https://images2.imgbox.com/d3/90/5fCzAQ6o_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/ea/58/oK6zW5Im_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/0e/06/alXXoyrd_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/d6/f0/efBs1l3w_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/38/bd/RTrju1Lx_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/44/e5/H8iTE08J_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/e1/f5/mCEhWLzc_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/13/6c/HIg3U8Yc_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/de/45/xiZOs9qe_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/30/db/tdY1JD39_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/08/e6/moOgHi48_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/5c/c9/s0cPKVzI_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/0a/f5/SgTWxYsn_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/15/97/ttHhwGal_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/b0/49/k9nVYoIW_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/62/9f/EPIvnrJB_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/53/a5/dlDqFU6y_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/93/12/mLthtzNb_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/35/99/ILxslDnr_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/57/21/yAzB60uh_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/b8/b8/MHr348wp_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/4d/e0/zPBTdZTv_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/e3/4d/skBMTlbU_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/6a/f3/6nffwOjt_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/01/7c/U8NKf1Rb_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/27/15/T7aAlj4n_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/8b/13/R6xTu7WK_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/d8/28/FdvKon7L_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/43/5a/oCPl9Bfu_o.png" alt="图片描述" title=""><br><img src="https://images2.imgbox.com/af/aa/jeYGFV9S_o.png" alt="图片描述" title=""></p> 
<hr> 
<hr>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ea626bd9889a1947992bb5fadd57779d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux input/output error</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bfb17093e408fd41f65c62e8b2db9985/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringBatch JobExecution</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>