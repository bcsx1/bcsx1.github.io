<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Go学习圣经：Go语言实现高并发CRUD业务开发 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Go学习圣经：Go语言实现高并发CRUD业务开发" />
<meta property="og:description" content="说在前面： 现在拿到offer超级难，甚至连面试电话，一个都搞不到。
尼恩的技术社群中（50&#43;），很多小伙伴凭借 “左手云原生&#43;右手大数据”的绝活，拿到了offer，并且是非常优质的offer，据说年终奖都足足18个月。
第二个案例就是：前段时间，一个2年小伙伴希望涨薪到18K， 尼恩把GO 语言的项目架构，给他写入了简历，导致他的简历金光闪闪，脱胎换骨，完全可以去拿头条、腾讯等30K的offer， 年薪可以直接多 20W。
第二个案例就是：一个6年小伙伴凭借Java&#43;go双语言云原生架构，年薪60W。
从Java高薪岗位和就业岗位来看，云原生、K8S、GO 现在对于 高级工程师/架构师 来说，越来越重要。
所以，尼恩从架构师视角出发，基于尼恩 3高架构知识宇宙，写一本《GO学习圣经》，请到文末【技术自由圈】取。
《GO学习圣经》已经完成的内容有：
Go学习圣经：0基础精通GO开发与高并发架构 Go学习圣经：队列削峰&#43;批量写入 超高并发原理和实操 Go学习圣经：从0开始，精通Go语言Rest微服务架构和开发
《GO学习圣经》PDF的最终目标
咱们的目标，不仅仅在于 GO 应用编程自由，更在于 GO 架构自由。
另外，前面尼恩的云原生是没有涉及GO的，但是，没有GO的云原生是不完整的。
所以， GO语言、GO架构学习完了之后，咱们再去打个回马枪，完成云原生的第二部分: 《Istio &#43; K8S CRD的架构与开发实操》 , 帮助大家彻底穿透云原生。
文章目录 说在前面：业务CRUD的Restful API接口层的设计与开发业务CRUD的Restful API接口的设计Restful API路由管理，类似于SpringMVC 控制器Handler 处理器的设计和实现启动Gin WEB服务器 业务CRUD的Restful API服务层的设计与开发服务层的基础类context.Context 类型的上下文对象Context的原理Context接口内置函数Background()和TODO() Context的With系列函数WithCancelWithDeadlineWithTimeoutWithValue 使用Context的注意事项 业务CRUD的Dao层设计与开发Dao层的基础类global.DBEngine 对象的初始化model领域对象层使用GORM 链式操作，完成orm持久层的访问链式方法终结方法（Finisher ）新建会话方法 编写公共组件错误处理组件定义公共错误码定义处理公共方法 公共日志组件logrus 日志组件的使用日志组件初始化包全局变量 分页响应处理响应处理分页返回的使用 Swagger接口文档OpenAPI &amp; Swagger安装 Swagger写入注解swagger注解的编写swagger 配置文件的生成swagger中间件的注册通过swagger查看接口文档Swagger 背后发生了什么初始化 docsswagger注册路由 为接口做参数校验validator 介绍业务接口校验文章接口校验 模块开发：商品管理商品model 领域层开发商品 dao 层开发商品 service 层开发新增业务错误码新增商品的handler方法新增商品的api路由验证商品接口 《Golang 圣经》还有 5W字待发布参考资料技术自由的实现路径 PDF：实现你的 架构自由：实现你的 响应式 自由：实现你的 spring cloud 自由：实现你的 linux 自由：实现你的 网络 自由：实现你的 分布式锁 自由：实现你的 王者组件 自由：实现你的 面试题 自由： 业务CRUD的Restful API接口层的设计与开发 本文，围绕一个简单的商品微服务CRUD案例进行介绍。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/6ce890b715b25b7c3d2a0d372a832178/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-25T21:01:25+08:00" />
<meta property="article:modified_time" content="2023-06-25T21:01:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Go学习圣经：Go语言实现高并发CRUD业务开发</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_11"></a>说在前面：</h3> 
<p>现在<strong>拿到offer超级难</strong>，甚至连面试电话，一个都搞不到。</p> 
<p>尼恩的技术社群中（50+），很多小伙伴凭借 “左手云原生+右手大数据”的绝活，拿到了offer，并且是非常优质的offer，<strong>据说年终奖都足足18个月</strong>。</p> 
<p>第二个案例就是：前段时间，一个2年小伙伴希望涨薪到18K， 尼恩把GO 语言的项目架构，给他写入了简历，导致他的简历金光闪闪，脱胎换骨，完全可以去拿头条、腾讯等30K的offer， <strong>年薪可以直接多 20W</strong>。</p> 
<p>第二个案例就是：<strong>一个6年小伙伴凭借Java+go双语言云原生架构，年薪60W</strong>。</p> 
<p>从Java高薪岗位和就业岗位来看，云原生、K8S、GO 现在对于 高级工程师/架构师 来说，越来越重要。</p> 
<p>所以，尼恩从架构师视角出发，基于尼恩 3高架构知识宇宙，写一本《GO学习圣经》，请到文末【技术自由圈】取。</p> 
<p><strong>《GO学习圣经》已经完成的内容有：</strong></p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/130803296">Go学习圣经：0基础精通GO开发与高并发架构 </a></p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/130854308">Go学习圣经：队列削峰+批量写入 超高并发原理和实操 </a></p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/131234144">Go学习圣经：从0开始，精通Go语言Rest微服务架构和开发</a></p> 
<p><strong>《GO学习圣经》PDF的最终目标</strong></p> 
<p>咱们的目标，不仅仅在于 GO 应用编程自由，更在于 GO 架构自由。</p> 
<p>另外，前面尼恩的云原生是没有涉及GO的，但是，没有GO的云原生是不完整的。</p> 
<p>所以， GO语言、GO架构学习完了之后，咱们再去打个回马枪，完成云原生的第二部分: <strong>《Istio + K8S CRD的架构与开发实操》</strong> , 帮助大家彻底穿透云原生。</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_11" rel="nofollow">说在前面：</a></li><li><a href="#CRUDRestful_API_48" rel="nofollow">业务CRUD的Restful API接口层的设计与开发</a></li><li><ul><li><a href="#CRUDRestful_API_52" rel="nofollow">业务CRUD的Restful API接口的设计</a></li><li><a href="#Restful_APISpringMVC__72" rel="nofollow">Restful API路由管理，类似于SpringMVC 控制器</a></li><li><a href="#Handler__97" rel="nofollow">Handler 处理器的设计和实现</a></li><li><a href="#Gin_WEB_119" rel="nofollow">启动Gin WEB服务器</a></li></ul> 
   </li><li><a href="#CRUDRestful_API_145" rel="nofollow">业务CRUD的Restful API服务层的设计与开发</a></li><li><ul><li><a href="#_149" rel="nofollow">服务层的基础类</a></li><li><a href="#contextContext__183" rel="nofollow">context.Context 类型的上下文对象</a></li><li><a href="#Context_199" rel="nofollow">Context的原理</a></li><li><ul><li><a href="#Context_211" rel="nofollow">Context接口</a></li><li><a href="#BackgroundTODO_233" rel="nofollow">内置函数Background()和TODO()</a></li></ul> 
    </li><li><a href="#ContextWith_245" rel="nofollow">Context的With系列函数</a></li><li><ul><li><a href="#WithCancel_261" rel="nofollow">WithCancel</a></li><li><a href="#WithDeadline_307" rel="nofollow">WithDeadline</a></li><li><a href="#WithTimeout_347" rel="nofollow">WithTimeout</a></li><li><a href="#WithValue_403" rel="nofollow">WithValue</a></li></ul> 
    </li><li><a href="#Context_482" rel="nofollow">使用Context的注意事项</a></li></ul> 
   </li><li><a href="#CRUDDao_498" rel="nofollow">业务CRUD的Dao层设计与开发</a></li><li><ul><li><a href="#Dao_500" rel="nofollow">Dao层的基础类</a></li><li><a href="#globalDBEngine__568" rel="nofollow">global.DBEngine 对象的初始化</a></li><li><a href="#model_630" rel="nofollow">model领域对象层</a></li><li><a href="#GORM_orm_703" rel="nofollow">使用GORM 链式操作，完成orm持久层的访问</a></li><li><ul><li><a href="#_730" rel="nofollow">链式方法</a></li><li><a href="#Finisher__742" rel="nofollow">终结方法（Finisher ）</a></li><li><a href="#_782" rel="nofollow">新建会话方法</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_818" rel="nofollow">编写公共组件</a></li><li><ul><li><a href="#_826" rel="nofollow">错误处理组件</a></li><li><ul><li><a href="#_832" rel="nofollow">定义公共错误码</a></li><li><a href="#_850" rel="nofollow">定义处理公共方法</a></li></ul> 
    </li><li><a href="#_920" rel="nofollow">公共日志组件</a></li><li><ul><li><a href="#logrus__930" rel="nofollow">logrus 日志组件的使用</a></li><li><a href="#_946" rel="nofollow">日志组件初始化</a></li><li><a href="#_994" rel="nofollow">包全局变量</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_1010" rel="nofollow">分页响应处理</a></li><li><ul><li><a href="#_1051" rel="nofollow">响应处理</a></li><li><a href="#_1174" rel="nofollow">分页返回的使用</a></li></ul> 
   </li><li><a href="#Swagger_1216" rel="nofollow">Swagger接口文档</a></li><li><ul><li><a href="#OpenAPI__Swagger_1224" rel="nofollow">OpenAPI &amp; Swagger</a></li><li><a href="#_Swagger_1237" rel="nofollow">安装 Swagger</a></li><li><a href="#_1258" rel="nofollow">写入注解</a></li><li><a href="#swagger_1271" rel="nofollow">swagger注解的编写</a></li><li><a href="#swagger__1291" rel="nofollow">swagger 配置文件的生成</a></li><li><a href="#swagger_1301" rel="nofollow">swagger中间件的注册</a></li><li><a href="#swagger_1331" rel="nofollow">通过swagger查看接口文档</a></li><li><a href="#Swagger__1345" rel="nofollow">Swagger 背后发生了什么</a></li><li><ul><li><a href="#_docs_1358" rel="nofollow">初始化 docs</a></li><li><a href="#swagger_1541" rel="nofollow">swagger注册路由</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_1589" rel="nofollow">为接口做参数校验</a></li><li><ul><li><a href="#validator__1593" rel="nofollow">validator 介绍</a></li><li><a href="#_1605" rel="nofollow">业务接口校验</a></li><li><a href="#_1621" rel="nofollow">文章接口校验</a></li></ul> 
   </li><li><a href="#_1660" rel="nofollow">模块开发：商品管理</a></li><li><ul><li><a href="#model__1675" rel="nofollow">商品model 领域层开发</a></li><li><a href="#_dao__1763" rel="nofollow">商品 dao 层开发</a></li><li><a href="#_service__1808" rel="nofollow">商品 service 层开发</a></li><li><a href="#_1872" rel="nofollow">新增业务错误码</a></li><li><a href="#handler_1886" rel="nofollow">新增商品的handler方法</a></li><li><a href="#api_2003" rel="nofollow">新增商品的api路由</a></li><li><a href="#_2015" rel="nofollow">验证商品接口</a></li></ul> 
   </li><li><a href="#Golang__5W_2057" rel="nofollow">《Golang 圣经》还有 5W字待发布</a></li><li><a href="#_2065" rel="nofollow">参考资料</a></li><li><a href="#_PDF_2085" rel="nofollow">技术自由的实现路径 PDF：</a></li><li><ul><li><ul><li><a href="#__2087" rel="nofollow">实现你的 架构自由：</a></li><li><a href="#___2105" rel="nofollow">实现你的 响应式 自由：</a></li><li><a href="#_spring_cloud__2113" rel="nofollow">实现你的 spring cloud 自由：</a></li><li><a href="#_linux__2124" rel="nofollow">实现你的 linux 自由：</a></li><li><a href="#___2130" rel="nofollow">实现你的 网络 自由：</a></li><li><a href="#___2138" rel="nofollow">实现你的 分布式锁 自由：</a></li><li><a href="#___2146" rel="nofollow">实现你的 王者组件 自由：</a></li><li><a href="#___2158" rel="nofollow">实现你的 面试题 自由：</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="CRUDRestful_API_48"></a>业务CRUD的Restful API接口层的设计与开发</h3> 
<p>本文，围绕一个简单的商品微服务CRUD案例进行介绍。</p> 
<h4><a id="CRUDRestful_API_52"></a>业务CRUD的Restful API接口的设计</h4> 
<p>参照 CRUD的Restful API接口的设计规范，完成类似下面的CRUD接口设计。</p> 
<table><thead><tr><th align="left">功能</th><th align="left">HTTP 方法</th><th align="left">路径</th></tr></thead><tbody><tr><td align="left">新增文章</td><td align="left">POST</td><td align="left">/articles</td></tr><tr><td align="left">删除指定文章</td><td align="left">DELETE</td><td align="left">/articles/:id</td></tr><tr><td align="left">更新指定文章</td><td align="left">PUT</td><td align="left">/articles/:id</td></tr><tr><td align="left">获取指定文章</td><td align="left">GET</td><td align="left">/articles/:id</td></tr><tr><td align="left">获取文章列表</td><td align="left">GET</td><td align="left">/articles</td></tr></tbody></table> 
<p>增删改查的 RESTful API 设计和编写，在 RESTful API 中 HTTP 方法对应的行为动作分别如下：</p> 
<ul><li><strong>GET</strong>：读取/检索动作。</li><li><strong>POST</strong>：新增/新建动作。</li><li><strong>PUT</strong>：更新动作，用于更新一个完整的资源，要求为幂等。</li><li><strong>PATCH</strong>：更新动作，用于更新某一个资源的一个组成部分，也就是只需要更新该资源的某一项，就应该使用 PATCH 而不是 PUT，可以不幂等。</li><li><strong>DELETE</strong>：删除动作。</li></ul> 
<h4><a id="Restful_APISpringMVC__72"></a>Restful API路由管理，类似于SpringMVC 控制器</h4> 
<p>Restful API路由管理，类似于SpringMVC 控制器。</p> 
<p>Restful API路由管理，放在 <code>internal/routers</code> 目录下，并新建 router.go 文件，代码参考：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">NewRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{<!-- --></span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span><span class="token function">Recovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   article <span class="token operator">:=</span> v1<span class="token punctuation">.</span><span class="token function">NewArticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   apiv1 <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/api/v1"</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
    apiv1<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/articles"</span><span class="token punctuation">,</span> article<span class="token punctuation">.</span>Create<span class="token punctuation">)</span>
    apiv1<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span><span class="token string">"/articles/:id"</span><span class="token punctuation">,</span> article<span class="token punctuation">.</span>Delete<span class="token punctuation">)</span>
    apiv1<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span><span class="token string">"/articles/:id"</span><span class="token punctuation">,</span> article<span class="token punctuation">.</span>Update<span class="token punctuation">)</span>
    apiv1<span class="token punctuation">.</span><span class="token function">PATCH</span><span class="token punctuation">(</span><span class="token string">"/articles/:id/state"</span><span class="token punctuation">,</span> article<span class="token punctuation">.</span>Update<span class="token punctuation">)</span>
    apiv1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/articles/:id"</span><span class="token punctuation">,</span> article<span class="token punctuation">.</span>Get<span class="token punctuation">)</span>
    apiv1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/articles"</span><span class="token punctuation">,</span> article<span class="token punctuation">.</span>List<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> r
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Handler__97"></a>Handler 处理器的设计和实现</h4> 
<p>Handler 处理器 ，对应的就是 SpringMVC的 Controller。</p> 
<p>Handler 处理器 的位置，这里是放在 <code>internal/routers/api/v1</code> 文件夹。</p> 
<p>这里的Handler处理器 ，文件名称叫做 article.go。</p> 
<p>参考的代码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Article <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">NewArticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Article <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> Article<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a Article<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a Article<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a Article<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a Article<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a Article<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Gin_WEB_119"></a>启动Gin WEB服务器</h4> 
<p>在完成了模型、路由的代码编写后，修改 main.go 文件，把它改造为这个项目的启动文件，</p> 
<p>修改代码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    router <span class="token operator">:=</span> routers<span class="token punctuation">.</span><span class="token function">NewRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    s <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{<!-- --></span>
        Addr<span class="token punctuation">:</span>           <span class="token string">":8080"</span><span class="token punctuation">,</span>
        Handler<span class="token punctuation">:</span>        router<span class="token punctuation">,</span>
        ReadTimeout<span class="token punctuation">:</span>    <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
        WriteTimeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
        MaxHeaderBytes<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们通过自定义 <code>http.Server</code>，设置了监听的 TCP Endpoint、处理的程序、允许读取/写入的最大时间、请求头的最大字节数等基础参数，最后调用 <code>ListenAndServe</code> 方法开始监听。</p> 
<h3><a id="CRUDRestful_API_145"></a>业务CRUD的Restful API服务层的设计与开发</h3> 
<p>服务层的职责和功能，类似于SpringMVC 服务层。</p> 
<h4><a id="_149"></a>服务层的基础类</h4> 
<pre><code class="prism language-go"><span class="token keyword">package</span> service

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/common/global"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/internal/dao"</span>
	otgorm <span class="token string">"github.com/eddycjy/opentracing-gorm"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Service <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	ctx context<span class="token punctuation">.</span>Context
	dao <span class="token operator">*</span>dao<span class="token punctuation">.</span>Dao
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> Service <span class="token punctuation">{<!-- --></span>
	svc <span class="token operator">:=</span> Service<span class="token punctuation">{<!-- --></span>ctx<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span>
	svc<span class="token punctuation">.</span>dao <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>DBEngine<span class="token punctuation">)</span>
	svc<span class="token punctuation">.</span>dao <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>otgorm<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>svc<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> global<span class="token punctuation">.</span>DBEngine<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> svc
<span class="token punctuation">}</span>
</code></pre> 
<p>基础类封层了两个对象：</p> 
<ul><li>context.Context 类型的上下文对象</li><li>dao.Dao 类型的 dao层 基础对象</li></ul> 
<h4><a id="contextContext__183"></a>context.Context 类型的上下文对象</h4> 
<p>在 Go http包的Server中，每一个请求在都有一个对应的 goroutine 去处理。</p> 
<p>每一个请求handler处理函数，很多的时候，也是需要并发处理的，往往会启动额外的 goroutine 用来访问后端服务，比如访问数据库、调用RPC服务。</p> 
<p><img src="https://images2.imgbox.com/26/48/R5TbHqYv_o.png" alt=""></p> 
<p>虽然db协程、rpc协程和req协程都是并发执行的。</p> 
<p>但是，当req协程请求被取消时，所有用来处理该请求的 goroutine 都应该迅速退出，然后系统迅速释放这些 goroutine 占用的资源。</p> 
<h4><a id="Context_199"></a>Context的原理</h4> 
<p>Go1.7加入了一个新的标准库context，它定义了Context类型。</p> 
<p>Context上下文 专门用来简化单个WEB请求的多个 goroutine 之间与请求有关的数据、取消信号、截止时间等相关操作，这些操作可能涉及多个 API 调用。</p> 
<p>对服务器传入的请求应该创建上下文，而对服务器的传出调用应该接受上下文。</p> 
<p>它们之间的函数调用链必须传递上下文，或者可以使用WithCancel、WithDeadline、WithTimeout或WithValue创建的派生上下文。</p> 
<p>注意： 当一个上下文被取消时，它派生的所有上下文也被取消。</p> 
<h5><a id="Context_211"></a>Context接口</h5> 
<p>context.Context是一个接口，该接口定义了四个需要实现的方法。具体签名如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中：</p> 
<ul><li>Deadline方法需要返回当前Context被取消的时间，也就是完成工作的截止时间（deadline）；</li><li>Done方法需要返回一个Channel，这个Channel会在当前工作完成或者上下文被取消之后关闭，多次调用Done方法会返回同一个Channel；</li><li>Err方法会返回当前Context结束的原因，它只会在Done返回的Channel被关闭时才会返回非空的值； 
  <ul><li>如果当前Context被取消就会返回Canceled错误；</li><li>如果当前Context超时就会返回DeadlineExceeded错误；</li></ul> </li><li>Value方法会从Context中返回键对应的值，对于同一个上下文来说，多次调用Value 并传入相同的Key会返回相同的结果，该方法仅用于传递跨API和进程间跟请求域的数据；</li></ul> 
<h5><a id="BackgroundTODO_233"></a>内置函数Background()和TODO()</h5> 
<p>Go内置两个函数：Background()和TODO()，这两个函数分别返回一个实现了Context接口的background和todo。</p> 
<p>我们代码中最开始都是以这两个内置的上下文对象作为最顶层的partent context，衍生出更多的子上下文对象。</p> 
<p>Background()主要用于main函数、初始化以及测试代码中，作为Context这个树结构的最顶层的Context，也就是根Context。</p> 
<p>TODO()，它目前还不知道具体的使用场景，如果我们不知道该使用什么Context的时候，可以使用这个。</p> 
<p>background和todo本质上都是emptyCtx结构体类型，是一个不可取消，没有设置截止时间，没有携带任何值的Context。</p> 
<h4><a id="ContextWith_245"></a>Context的With系列函数</h4> 
<p>context包中定义了四个With系列函数。</p> 
<p>对服务器的传入请求应该创建一个Context上下文，对服务器的传出调用应该接受一个Context上下文。它们之间的函数调用链必须传播 Context，可选择将其替换为使用 WithCancel、WithDeadline、WithTimeout 或 WithValue 创建的派生 Context。</p> 
<p><img src="https://images2.imgbox.com/ba/50/yUhMtvO3_o.png" alt=""></p> 
<p>当一个上下文 Context 被取消时，所有从它派生的上下文也被取消。</p> 
<h5><a id="WithCancel_261"></a>WithCancel</h5> 
<p>WithCancel的函数签名如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">WithCancel</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctx Context<span class="token punctuation">,</span> cancel CancelFunc<span class="token punctuation">)</span>
</code></pre> 
<p>WithCancel返回带有新Done通道的父节点的副本。当调用返回的cancel函数或当关闭父上下文的Done通道时，将关闭返回上下文的Done通道，无论先发生什么情况。</p> 
<p>取消此上下文将释放与其关联的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">generate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
        dst <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
        n <span class="token operator">:=</span> <span class="token number">1</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token comment">// return结束该goroutine，防止泄露</span>
                <span class="token keyword">case</span> dst <span class="token operator">&lt;-</span> n<span class="token punctuation">:</span>
                    n<span class="token operator">++</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> dst
    <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 当我们取完需要的整数后调用cancel</span>

    <span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">generate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
        <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">5</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面的示例代码中，generate函数在单独的goroutine中生成整数，并将它们发送到返回的通道。</p> 
<p>generate的调用者在使用生成的整数之后需要取消上下文，以免generate启动的内部goroutine发生泄漏。</p> 
<h5><a id="WithDeadline_307"></a>WithDeadline</h5> 
<p>WithDeadline的函数签名如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">WithDeadline</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span>
</code></pre> 
<p>返回父上下文的副本，并将deadline调整为不迟于d。</p> 
<p>如果父上下文的deadline已经早于d，则<code>WithDeadline(parent, d)</code>在语义上等同于父上下文。</p> 
<p>当截止日过期时，当调用返回的cancel函数时，或者当父上下文的Done通道关闭时，返回上下文的Done通道将被关闭，以最先发生的情况为准。</p> 
<p>取消此上下文将释放与其关联的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel。</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    d <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithDeadline</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>

    <span class="token comment">// 尽管ctx会过期，但在任何情况下调用它的cancel函数都是很好的实践。</span>
    <span class="token comment">// 如果不这样做，可能会使上下文及其父类存活的时间超过必要的时间。</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"overslept"</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面的代码中，定义了一个50毫秒之后过期的deadline，</p> 
<p>然后我们调用<code>context.WithDeadline(context.Background(), d)</code> 得到一个上下文（ctx）和一个取消函数cancel，然后使用一个select让主程序陷入等待：等待1秒后打印overslept退出，或者等待ctx过期后退出。</p> 
<p>因为ctx50秒后就过期，所以ctx.Done()会先接收到值，上面的代码会打印ctx.Err()取消原因。</p> 
<h5><a id="WithTimeout_347"></a>WithTimeout</h5> 
<p>WithTimeout的函数签名如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">WithTimeout</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span>Context<span class="token punctuation">,</span> CancelFunc<span class="token punctuation">)</span>
</code></pre> 
<p>WithTimeout返回<code>WithDeadline(parent, time.Now().Add(timeout))</code>。</p> 
<p>取消此上下文将释放与其相关的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel，通常用于数据库或者网络连接的超时控制。</p> 
<p>具体示例如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"sync"</span>

    <span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token comment">// context.WithTimeout</span>

<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
LOOP<span class="token punctuation">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"db connecting ..."</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 假设正常连接数据库耗时10毫秒</span>
        <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// 50毫秒后自动调用</span>
            <span class="token keyword">break</span> LOOP
        <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker done!"</span><span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置一个50毫秒的超时</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Millisecond<span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 通知子goroutine结束</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"over"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="WithValue_403"></a>WithValue</h5> 
<p>WithValue函数能够将请求作用域的数据与 Context 对象建立关系。</p> 
<p>WithValue声明如下：</p> 
<pre><code class="prism language-go"> <span class="token keyword">func</span> <span class="token function">WithValue</span><span class="token punctuation">(</span>parent Context<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> Context
</code></pre> 
<p>WithValue返回父节点的副本，其中与key关联的值为val。</p> 
<p>下面的一个例子， 在所有的 协程之中，使用 context进行 日志编码 的传播。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"context"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"sync"</span>

    <span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token comment">// context.WithValue</span>

<span class="token keyword">type</span> TraceCode <span class="token builtin">string</span>

<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    key <span class="token operator">:=</span> <span class="token function">TraceCode</span><span class="token punctuation">(</span><span class="token string">"TRACE_CODE"</span><span class="token punctuation">)</span>
    traceCode<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token comment">// 在子goroutine中获取trace code</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"invalid trace code"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
LOOP<span class="token punctuation">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"worker, trace code:%s\n"</span><span class="token punctuation">,</span> traceCode<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 假设正常连接数据库耗时10毫秒</span>
        <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// 50毫秒后自动调用</span>
            <span class="token keyword">break</span> LOOP
        <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker done!"</span><span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置一个50毫秒的超时</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Millisecond<span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token comment">// 在系统的入口中设置trace code传递给后续启动的goroutine实现日志数据聚合</span>
    ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">TraceCode</span><span class="token punctuation">(</span><span class="token string">"TRACE_CODE"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"12512312234"</span><span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 通知子goroutine结束</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"over"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面的 break LOOP，表示跳出循环</p> 
<pre><code class="prism language-go">Go语言中 <span class="token keyword">break</span> 语句可以结束 <span class="token keyword">for</span>、<span class="token keyword">switch</span> 和 <span class="token keyword">select</span> 的代码块，

<span class="token keyword">break</span> 语句可以在语句后面添加标签，表示退出某个标签对应的代码块，
 
<span class="token keyword">break</span> 后面的标签，要求必须定义在对应的 <span class="token keyword">for</span>、<span class="token keyword">switch</span> 和 <span class="token keyword">select</span> 的代码块上。
</code></pre> 
<p>最后说一下： context.WithValue上下文所提供的键必须是可比较的，并且不应该是string类型或任何其他内置类型，以避免使用上下文在包之间发生冲突。context.WithValue上下文的键，应该是用户定义自己的类型。</p> 
<h4><a id="Context_482"></a>使用Context的注意事项</h4> 
<ul><li>规则1：推荐以参数的方式显示传递Context</li><li>规则2：以Context作为参数的函数方法，应该把Context作为第一个参数。</li><li>规则3：给一个函数方法传递Context的时候，不要传递nil，如果不知道传递什么，就使用context.TODO()</li><li>规则4：Context的Value相关方法应该传递请求域的必要数据，不应该用于传递可选参数</li><li>规则5：Context是线程安全的，可以放心的在多个goroutine中传递</li></ul> 
<p>尼恩提示： 在咱们的案例中，为了编码的简单，不是以参数的方式显示传递Context，而是用封装的方式放在了service基类里边，这点，违背了 规则1.</p> 
<p>总之，咱们的案例，违背了 规则1.</p> 
<h3><a id="CRUDDao_498"></a>业务CRUD的Dao层设计与开发</h3> 
<h4><a id="Dao_500"></a>Dao层的基础类</h4> 
<pre><code class="prism language-go"><span class="token keyword">package</span> dao

<span class="token keyword">import</span> <span class="token string">"github.com/jinzhu/gorm"</span>

<span class="token keyword">type</span> Dao <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	engine <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>engine <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>Dao <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Dao<span class="token punctuation">{<!-- --></span>engine<span class="token punctuation">:</span> engine<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意这个 engine 是外部注入的，主要在外部进行 构建。</p> 
<p>什么时候创建的 gorm.DB ORM engine 对象呢？ 是在构建 service的时候：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Service <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	ctx context<span class="token punctuation">.</span>Context
	dao <span class="token operator">*</span>dao<span class="token punctuation">.</span>Dao
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> Service <span class="token punctuation">{<!-- --></span>
	svc <span class="token operator">:=</span> Service<span class="token punctuation">{<!-- --></span>ctx<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span>
	<span class="token comment">//svc.dao = dao.New(global.DBEngine)</span>
	svc<span class="token punctuation">.</span>dao <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>otgorm<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>svc<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> global<span class="token punctuation">.</span>DBEngine<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> svc
<span class="token punctuation">}</span>
</code></pre> 
<p>在构建 service的时候，构建了 一个dao对象，并且把 一个全局的 gorm 数据持久化组件对象，作为参数进行的注入。</p> 
<p>再看这个全局的 global.DBEngine 对象的定义：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> global

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/elastic/go-elasticsearch/v8"</span>
	rdb <span class="token string">"github.com/go-redis/redis/v8"</span>
	<span class="token string">"github.com/gomodule/redigo/redis"</span>
	<span class="token string">"github.com/jinzhu/gorm"</span>
	<span class="token string">"github.com/opentracing/opentracing-go"</span>
	<span class="token string">"github.com/sirupsen/logrus"</span>
	<span class="token string">"go.mongodb.org/mongo-driver/mongo"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	DBEngine     <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB
	RedisPool    <span class="token operator">*</span>redis<span class="token punctuation">.</span>Pool
	Redis        <span class="token operator">*</span>rdb<span class="token punctuation">.</span>Client
	Logger       <span class="token operator">*</span>logrus<span class="token punctuation">.</span>Logger
	Tracer       opentracing<span class="token punctuation">.</span>Tracer
	Es           <span class="token operator">*</span>elasticsearch<span class="token punctuation">.</span>Client
	Mongo        <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Client
	ModelPath    <span class="token builtin">string</span>
	ModelReplace <span class="token builtin">string</span>
<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="globalDBEngine__568"></a>global.DBEngine 对象的初始化</h4> 
<p>这个全局的 global.DBEngine 对象的初始化，在model 模块的model 基础类中。</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> model

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/common/global"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/pkg/toolkit/cast"</span>
	<span class="token string">"github.com/jinzhu/gorm"</span>
	<span class="token boolean">_</span> <span class="token string">"github.com/jinzhu/gorm/dialects/mysql"</span>
	log <span class="token string">"github.com/sirupsen/logrus"</span>
	<span class="token string">"time"</span>

	cfg <span class="token string">"crazymakercircle.com/gin-rest/internal/config"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
	<span class="token comment">//关于读写分离我们可以定义两个变量，一个读和一个写的，</span>
	<span class="token comment">//然后分别初始化，</span>
	<span class="token comment">//然后在查询和写入操作的时候使用不同的连接，或者使用一个map保存读和写的连接</span>
	global<span class="token punctuation">.</span>DBEngine<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">NewDBEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewDBEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	dsn <span class="token operator">:=</span> cfg<span class="token punctuation">.</span>AppDbDsn<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	driver <span class="token operator">:=</span> cfg<span class="token punctuation">.</span>AppDbDriver<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> driver <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> <span class="token string">"mysql"</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s:%s"</span><span class="token punctuation">,</span>
			driver<span class="token punctuation">,</span>
			dsn<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"invalid db driver %v\n"</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>AppDbDriver<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> gorm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> dsn<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Open "</span><span class="token operator">+</span>cfg<span class="token punctuation">.</span>AppDbDriver<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" failed. %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	db<span class="token punctuation">.</span><span class="token function">LogMode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	db<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetConnMaxLifetime</span><span class="token punctuation">(</span>cast<span class="token punctuation">.</span><span class="token function">ToDuration</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>AppDbMaxLifetime<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//最大连接周期，超过时间的连接就close</span>
	db<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span>cast<span class="token punctuation">.</span><span class="token function">ToInt</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>AppDbMaxOpens<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment">//设置最大连接数</span>
	db<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span>cast<span class="token punctuation">.</span><span class="token function">ToInt</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>AppDbMaxIdles<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment">//设置闲置连接数</span>
	<span class="token comment">//设置全局表名禁用复数</span>
	db<span class="token punctuation">.</span><span class="token function">SingularTable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> db<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h4><a id="model_630"></a>model领域对象层</h4> 
<p>model层，类似SpringMVC 中的PO层。</p> 
<p>下面是model层的一个类：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> model

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"crazymakercircle.com/gin-rest/pkg/app"</span>
	<span class="token string">"github.com/jinzhu/gorm"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> ArticleSwagger <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	List  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Article
	Pager <span class="token operator">*</span>app<span class="token punctuation">.</span>Pager
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Article <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Id           <span class="token builtin">uint64</span> <span class="token string">`json:"id"`</span>
	Title        <span class="token builtin">string</span> <span class="token string">`json:"title"`</span>
	Content      <span class="token builtin">string</span> <span class="token string">`json:"content"`</span>
	Introduction <span class="token builtin">string</span> <span class="token string">`json:"introduction"`</span>
	Views        <span class="token builtin">int</span>    <span class="token string">`json:"views"`</span>
	CreatedAt    <span class="token builtin">string</span> <span class="token string">`json:"created_at"`</span>
	UpdatedAt    <span class="token builtin">string</span> <span class="token string">`json:"-"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a Article<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token string">"article"</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a Article<span class="token punctuation">)</span> <span class="token function">Count</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> count <span class="token builtin">int</span>
	<span class="token keyword">if</span> a<span class="token punctuation">.</span>Title <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"title like ?"</span><span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token operator">+</span>a<span class="token punctuation">.</span>Title<span class="token operator">+</span><span class="token string">"%"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> count<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>a Article<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> pageOffset<span class="token punctuation">,</span> pageSize <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Article<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> list <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Article
	<span class="token keyword">if</span> a<span class="token punctuation">.</span>Title <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"title like ?"</span><span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token operator">+</span>a<span class="token punctuation">.</span>Title<span class="token operator">+</span><span class="token string">"%"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>pageOffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
	<span class="token keyword">return</span> list<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre> 
<p>注意，这个和springmvc不同：</p> 
<ul><li>springmvc 的业务模型（领域对象）是贫血模型， 没有对数据库的任何操作的</li><li>这里的model领域对象，是充血模型</li></ul> 
<p>贫血模型是指model对象只用于在各层之间传输数据使用，只有数据字段和Get/Set方法，没有逻辑在对象中。</p> 
<p>充血模型是面向对象设计的本质，一个对象是拥有状态和行为的。将大多数业务逻辑和持久化放在领域对象中，业务逻辑只是完成对业务逻辑的封装、事务、权限、校验等的处理。</p> 
<p>当然， 这里仅仅是套用一下DDD里边的概念。 和DDD的模式，并不是完全一致。</p> 
<p>这里的Dao层对数据的访问进行了弱化， 很多的orm 数据访问逻辑， 委托到了 model 领域对象层。</p> 
<h4><a id="GORM_orm_703"></a>使用GORM 链式操作，完成orm持久层的访问</h4> 
<p>上面的代码在访问数据库的时候，使用了 GORM 链式操作。</p> 
<p>比如，在Count方法中获取Article 数据的时候，就是使用GORM 链式操作，具体如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>a Article<span class="token punctuation">)</span> <span class="token function">Count</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> count <span class="token builtin">int</span>
	<span class="token keyword">if</span> a<span class="token punctuation">.</span>Title <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"title like ?"</span><span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token operator">+</span>a<span class="token punctuation">.</span>Title<span class="token operator">+</span><span class="token string">"%"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> count<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>GORM 允许进行链式操作，所以大家可以像这样写代码：</p> 
<pre><code class="prism language-go">db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"name = ?"</span><span class="token punctuation">,</span> <span class="token string">"jinzhu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"age = ?"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
</code></pre> 
<p>GORM 中有三种类型的方法： 链式方法、终结方法、新建会话方法。</p> 
<h5><a id="_730"></a>链式方法</h5> 
<p>链式方法是将 <code>Clauses（sql字句）</code> 修改或添加到当前Statement 的方法，例如：</p> 
<p><code>Where</code>, <code>Select</code>, <code>Omit</code>, <code>Joins</code>, <code>Scopes</code>, <code>Preload</code>, 等</p> 
<pre><code class="prism language-go">db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"users"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">"name, email"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"age &gt; ?"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre> 
<p>上面的 Select、Where 都是链式方法</p> 
<h5><a id="Finisher__742"></a>终结方法（Finisher ）</h5> 
<p>Finishers 是会立即执行注册回调的方法，然后生成并执行 SQL，比如这些方法：</p> 
<p><code>Create</code>, <code>First</code>, <code>Find</code>, <code>Take</code>, <code>Save</code>, <code>Update</code>, <code>Delete</code>, <code>Scan</code>, <code>Row</code>, <code>Rows</code>… 等</p> 
<pre><code class="prism language-go">db<span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token string">"users"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span><span class="token string">"name, email"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"age &gt; ?"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
</code></pre> 
<p>上面的Find 都是终结方法, 会生成并执行 SQL。</p> 
<p>下面是几个 终结方法（Finisher ）的示例：</p> 
<pre><code class="prism language-go"><span class="token comment">// 获取第一条记录，按主键排序</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">//生成的SQL： SELECT * FROM users ORDER BY id LIMIT 1;</span>

<span class="token comment">// 获取一条记录，不指定排序</span>
db<span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">//生成的SQL： SELECT * FROM users LIMIT 1;</span>

<span class="token comment">// 获取最后一条记录，按主键排序</span>
db<span class="token punctuation">.</span><span class="token function">Last</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">//生成的SQL： SELECT * FROM users ORDER BY id DESC LIMIT 1;</span>

<span class="token comment">// 获取所有的记录</span>
db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">)</span>
<span class="token comment">//生成的SQL： SELECT * FROM users;</span>

<span class="token comment">// 通过主键进行查询 (仅适用于主键是数字类型)</span>
db<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">//生成的SQL： SELECT * FROM users WHERE id = 10;</span>
</code></pre> 
<h5><a id="_782"></a>新建会话方法</h5> 
<p>在 链式方法, 终结方法之后, GORM 返回一个初始化的<code>*gorm.DB</code>实例。需要注意的是， <code>*gorm.DB</code>不能安全地重复使用，并且新生成的 SQL 可能会被先前的条件污染，例如：</p> 
<pre><code class="prism language-go">queryDB <span class="token operator">:=</span> DB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"name = ?"</span><span class="token punctuation">,</span> <span class="token string">"jinzhu"</span><span class="token punctuation">)</span>

queryDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"age &gt; ?"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">//生成的SQL： SELECT * FROM users WHERE name = "jinzhu" AND age &gt; 10</span>

queryDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"age &gt; ?"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span>
<span class="token comment">//生成的SQL： SELECT * FROM users WHERE name = "jinzhu" AND age &gt; 10 AND age &gt; 20</span>
</code></pre> 
<p>上面的代码中第二个where生成的sql，明显不需要前面where的条件，所以，后面的新生成的 SQL 被先前的条件污染。</p> 
<p>为了重新使用初始化的 <code>*gorm.DB</code> 实例, 可以使用 新建会话方法， 创建一个可共享的 <code>*gorm.DB</code>, 例如:</p> 
<pre><code class="prism language-go">queryDB <span class="token operator">:=</span> DB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"name = ?"</span><span class="token punctuation">,</span> <span class="token string">"jinzhu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gorm<span class="token punctuation">.</span>Session<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
queryDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"age &gt; ?"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = "jinzhu" AND age &gt; 10</span>
queryDB<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"age &gt; ?"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user2<span class="token punctuation">)</span>
<span class="token comment">// SELECT * FROM users WHERE name = "jinzhu" AND age &gt; 20</span>
</code></pre> 
<p>关于gorm 的 session介绍，请参见下面的链接：</p> 
<p>https://gorm.cn/zh_CN/docs/session.html</p> 
<h3><a id="_818"></a>编写公共组件</h3> 
<p>每个项目中，都会有一类组件，我们常称其为基础组件，又或是公共组件，它们是不带强业务属性的，串联着整个应用程序.</p> 
<p>公共组件由架构师、高级开发或技术中台团队的同事进行梳理和编写，并且负责统一维护，如果集中统一的管理，每个业务团队都写一套，是非常糟糕的，既带来重复建设重复开发，也会带来不同业务团队代码复用和移植的难度。</p> 
<p>公共组件其实非常多，这里简单的介绍几个。</p> 
<h4><a id="_826"></a>错误处理组件</h4> 
<p>在应用程序的运行中，我们常常需要与客户端进行交互，而交互分别是两点，一个是正确响应下的结果集返回，另外一个是错误响应的错误码和消息体返回，用于告诉客户端，这一次请求发生了什么事，因为什么原因失败了。</p> 
<p>因此在一个新项目搭建之初，其中重要的一项预备工作，那就是标准化我们的错误码格式，保证客户端是“理解”我们的错误码规则，不需要每次都写一套新的。</p> 
<h5><a id="_832"></a>定义公共错误码</h5> 
<p>在项目目录下的 <code>pkg/errcode</code> 目录新建 common_code.go 文件，用于预定义项目中的一些公共错误码，便于引导和规范大家的使用，如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>
    Success                   <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"成功"</span><span class="token punctuation">)</span>
    ServerError               <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">,</span> <span class="token string">"服务内部错误"</span><span class="token punctuation">)</span>
    InvalidParams             <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">10000001</span><span class="token punctuation">,</span> <span class="token string">"入参错误"</span><span class="token punctuation">)</span>
    NotFound                  <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">10000002</span><span class="token punctuation">,</span> <span class="token string">"找不到"</span><span class="token punctuation">)</span>
    UnauthorizedAuthNotExist  <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">10000003</span><span class="token punctuation">,</span> <span class="token string">"鉴权失败，找不到对应的 AppKey 和 AppSecret"</span><span class="token punctuation">)</span>
    UnauthorizedTokenError    <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">10000004</span><span class="token punctuation">,</span> <span class="token string">"鉴权失败，Token 错误"</span><span class="token punctuation">)</span>
    UnauthorizedTokenTimeout  <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">10000005</span><span class="token punctuation">,</span> <span class="token string">"鉴权失败，Token 超时"</span><span class="token punctuation">)</span>
    UnauthorizedTokenGenerate <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">10000006</span><span class="token punctuation">,</span> <span class="token string">"鉴权失败，Token 生成失败"</span><span class="token punctuation">)</span>
    TooManyRequests           <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">10000007</span><span class="token punctuation">,</span> <span class="token string">"请求过多"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_850"></a>定义处理公共方法</h5> 
<p>在项目目录下的 <code>pkg/errcode</code> 目录新建 errcode.go 文件，编写常用的一些错误处理公共方法，标准化我们的错误输出，如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Error <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    code <span class="token builtin">int</span> <span class="token string">`json:"code"`</span>
    msg <span class="token builtin">string</span> <span class="token string">`json:"msg"`</span>
    details <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"details"`</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> codes <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">NewError</span><span class="token punctuation">(</span>code <span class="token builtin">int</span><span class="token punctuation">,</span> msg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Error <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> codes<span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
        <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"错误码 %d 已经存在，请更换一个"</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    codes<span class="token punctuation">[</span>code<span class="token punctuation">]</span> <span class="token operator">=</span> msg
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Error<span class="token punctuation">{<!-- --></span>code<span class="token punctuation">:</span> code<span class="token punctuation">,</span> msg<span class="token punctuation">:</span> msg<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Error<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"错误码：%d, 错误信息:：%s"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Error<span class="token punctuation">)</span> <span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> e<span class="token punctuation">.</span>code
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Error<span class="token punctuation">)</span> <span class="token function">Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> e<span class="token punctuation">.</span>msg
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Error<span class="token punctuation">)</span> <span class="token function">Msgf</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>msg<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Error<span class="token punctuation">)</span> <span class="token function">Details</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> e<span class="token punctuation">.</span>details
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Error<span class="token punctuation">)</span> <span class="token function">WithDetails</span><span class="token punctuation">(</span>details <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Error <span class="token punctuation">{<!-- --></span>
    newError <span class="token operator">:=</span> <span class="token operator">*</span>e
    newError<span class="token punctuation">.</span>details <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> details <span class="token punctuation">{<!-- --></span>
        newError<span class="token punctuation">.</span>details <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>newError<span class="token punctuation">.</span>details<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>newError
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Error<span class="token punctuation">)</span> <span class="token function">StatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> e<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> Success<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span>StatusOK
    <span class="token keyword">case</span> ServerError<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span>StatusInternalServerError
    <span class="token keyword">case</span> InvalidParams<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span>StatusBadRequest
    <span class="token keyword">case</span> UnauthorizedAuthNotExist<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">fallthrough</span>
    <span class="token keyword">case</span> UnauthorizedTokenError<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">fallthrough</span>
    <span class="token keyword">case</span> UnauthorizedTokenGenerate<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">fallthrough</span>
    <span class="token keyword">case</span> UnauthorizedTokenTimeout<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span>StatusUnauthorized
    <span class="token keyword">case</span> TooManyRequests<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span>StatusTooManyRequests
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> http<span class="token punctuation">.</span>StatusInternalServerError
<span class="token punctuation">}</span>
</code></pre> 
<p>在错误码方法的编写中，我们声明了 <code>Error</code> 结构体用于表示错误的响应结果，并利用 <code>codes</code> 作为全局错误码的存储载体，便于查看当前注册情况，并在调用 <code>NewError</code> 创建新的 <code>Error</code> 实例的同时进行排重的校验。</p> 
<p>另外相对特殊的是 <code>StatusCode</code> 方法，它主要用于针对一些特定错误码进行状态码的转换，因为不同的内部错误码在 HTTP 状态码中都代表着不同的意义，我们需要将其区分开来，便于客户端以及监控/报警等系统的识别和监听。</p> 
<h4><a id="_920"></a>公共日志组件</h4> 
<p>一般来说，应用代码中，都是直接使用 Go 标准库 log 来进行的日志输出。</p> 
<p>使用 标准库 log 来进行的日志输出有啥问题呢？</p> 
<p>在一个项目中，我们的日志需要标准化的记录一些的公共信息，例如：代码调用堆栈、请求链路 ID、公共的业务属性字段等等，而直接输出标准库的日志的话，并不具备这些数据，也不够灵活。</p> 
<p>日志的信息的齐全与否在排查和调试问题中是非常重要的一环，因此在应用程序中我们也会有一个标准的日志组件会进行统一处理和输出。</p> 
<h5><a id="logrus__930"></a>logrus 日志组件的使用</h5> 
<p>logrus日志库是一个结构化、插件化的日志记录库。</p> 
<p>完全兼容 golang 标准库中的日志模块。</p> 
<p>它还内置了 2 种日志输出格式 JSONFormatter 和 TextFormatter，来定义输出的日志格式。</p> 
<p>github地址：https://github.com/sirupsen/logrus</p> 
<p>这里使用 logrus 日志组件 作为基础组件。</p> 
<h5><a id="_946"></a>日志组件初始化</h5> 
<p>在项目目录下的 <code>pkg/</code> 目录新建 <code>logger</code> 目录，并创建 logrus.go 文件，写入日志组件初始化的代码：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> logger

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"crazymakercircle.com/gin-rest/common/global"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/internal/config"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/pkg/helper/files"</span>
	<span class="token string">"github.com/evalphobia/logrus_sentry"</span>
	<span class="token string">"github.com/sirupsen/logrus"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	global<span class="token punctuation">.</span>Logger <span class="token operator">=</span> logrus<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> config<span class="token punctuation">.</span>AppSentryDsn<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		hook<span class="token punctuation">,</span> err <span class="token operator">:=</span> logrus_sentry<span class="token punctuation">.</span><span class="token function">NewSentryHook</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>AppSentryDsn<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>logrus<span class="token punctuation">.</span>Level<span class="token punctuation">{<!-- --></span>
			logrus<span class="token punctuation">.</span>PanicLevel<span class="token punctuation">,</span>
			logrus<span class="token punctuation">.</span>FatalLevel<span class="token punctuation">,</span>
			logrus<span class="token punctuation">.</span>ErrorLevel<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span>Hooks<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span>
			hook<span class="token punctuation">.</span>Timeout <span class="token operator">=</span> <span class="token number">0</span>
			hook<span class="token punctuation">.</span>StacktraceConfiguration<span class="token punctuation">.</span>Enable <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 设置日志格式为json格式</span>
	global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">SetFormatter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>logrus<span class="token punctuation">.</span>JSONFormatter<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">//设置文件输出</span>
	f<span class="token punctuation">,</span> logFilePath <span class="token operator">:=</span> files<span class="token punctuation">.</span><span class="token function">LogFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 日志消息输出可以是任意的io.writer类型，这里我们获取文件句柄，将日志输出到文件</span>
	global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">SetOutput</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token comment">// 设置日志级别为debug以上</span>
	global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">SetLevel</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>DebugLevel<span class="token punctuation">)</span>
	<span class="token comment">// 设置显示文件名和行号</span>
	global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">SetReportCaller</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token comment">// 设置rotatelogs日志分割Hook</span>
	global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">AddHook</span><span class="token punctuation">(</span><span class="token function">NewLfsHook</span><span class="token punctuation">(</span>logFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="_994"></a>包全局变量</h5> 
<p>在完成日志库的编写后，我们需要定义一个 Logger 对象便于我们的应用程序使用。</p> 
<p>因此我们打开项目目录下的 common/global/global.go 文件，新增如下内容：</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>
    <span class="token operator">...</span>
   	Logger       <span class="token operator">*</span>logrus<span class="token punctuation">.</span>Logger

<span class="token punctuation">)</span>
</code></pre> 
<p>我们在包全局变量中新增了 Logger 对象，用于日志组件的初始化。</p> 
<h3><a id="_1010"></a>分页响应处理</h3> 
<p>在项目目录下的 <code>pkg/app</code> 目录下新建 pagination.go 文件，如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> app

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"crazymakercircle.com/gin-rest/internal/config"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/pkg/toolkit/cast"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/pkg/toolkit/convert"</span>
	<span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">GetPage</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
	page <span class="token operator">:=</span> convert<span class="token punctuation">.</span><span class="token function">Str</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"page"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> page <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> page
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetPageSize</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
	pageSize <span class="token operator">:=</span> convert<span class="token punctuation">.</span><span class="token function">Str</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"page_size"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> pageSize <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> cast<span class="token punctuation">.</span><span class="token function">ToInt</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>AppDefaultPageSize<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> pageSize
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetPageOffset</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> pageSize <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
	result <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">if</span> page <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		result <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1051"></a>响应处理</h4> 
<p>在项目目录下的 <code>pkg/app</code> 目录下新建 app.go 文件，如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> app

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/common/dict"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/pkg/helper/gjson"</span>
	<span class="token string">"github.com/gin-gonic/gin"</span>
	<span class="token string">"io/ioutil"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Response <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Code    <span class="token builtin">int</span>         <span class="token string">`json:"code"`</span>
	Msg     <span class="token builtin">string</span>      <span class="token string">`json:"msg"`</span>
	Data    <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token string">`json:"data"`</span>
	Elapsed <span class="token builtin">float64</span>     <span class="token string">`json:"elapsed"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Pager <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Page      <span class="token builtin">int</span> <span class="token string">`json:"page"`</span>
	PageSize  <span class="token builtin">int</span> <span class="token string">`json:"page_size"`</span>
	TotalRows <span class="token builtin">int</span> <span class="token string">`json:"total_rows"`</span>
<span class="token punctuation">}</span>

<span class="token comment">//Success 正常返回</span>
<span class="token keyword">func</span> <span class="token function">Success</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> data <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		data <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	response <span class="token operator">:=</span> Response<span class="token punctuation">{<!-- --></span>Code<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Msg<span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span> Data<span class="token punctuation">:</span> data<span class="token punctuation">,</span> Elapsed<span class="token punctuation">:</span> <span class="token function">GetElapsed</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"responseData"</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//SuccessList 分页返回</span>
<span class="token keyword">func</span> <span class="token function">SuccessList</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> list <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> totalRows <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	data <span class="token operator">:=</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
		<span class="token string">"list"</span><span class="token punctuation">:</span> list<span class="token punctuation">,</span>
		<span class="token string">"pager"</span><span class="token punctuation">:</span> Pager<span class="token punctuation">{<!-- --></span>
			Page<span class="token punctuation">:</span>      <span class="token function">GetPage</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span>
			PageSize<span class="token punctuation">:</span>  <span class="token function">GetPageSize</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span>
			TotalRows<span class="token punctuation">:</span> totalRows<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	e <span class="token operator">:=</span> dict<span class="token punctuation">.</span>Success
	response <span class="token operator">:=</span> Response<span class="token punctuation">{<!-- --></span>Code<span class="token punctuation">:</span> e<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Msg<span class="token punctuation">:</span> e<span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Data<span class="token punctuation">:</span> data<span class="token punctuation">,</span> Elapsed<span class="token punctuation">:</span> <span class="token function">GetElapsed</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"responseData"</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//Error 使用公共配置的消息返回</span>
<span class="token keyword">func</span> <span class="token function">Error</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> err <span class="token operator">*</span>dict<span class="token punctuation">.</span>Error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	response <span class="token operator">:=</span> Response<span class="token punctuation">{<!-- --></span>Code<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Msg<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Elapsed<span class="token punctuation">:</span> <span class="token function">GetElapsed</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">}</span>
	details <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token function">Details</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err<span class="token punctuation">.</span><span class="token function">Level</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//默认错误返回为warn，不记录日志到sentry</span>
		err <span class="token operator">=</span> err<span class="token punctuation">.</span><span class="token function">WithLevel</span><span class="token punctuation">(</span><span class="token string">"warn"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">SetLevel</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Level</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>details<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">SetDetail</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Details</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err<span class="token punctuation">.</span><span class="token function">Level</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> dict<span class="token punctuation">.</span>LevelError <span class="token punctuation">{<!-- --></span>
			response<span class="token punctuation">.</span>Data <span class="token operator">=</span> details
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"responseData"</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">StatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">SetLevel</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> level <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"level"</span><span class="token punctuation">,</span> level<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">SetDetail</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> detail <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"detail"</span><span class="token punctuation">,</span> detail<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetLevel</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">Get</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"level"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetDetail</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">Get</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"detail"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Get</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
	val<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">return</span> val
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GetElapsed</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{<!-- --></span>
	elapsed <span class="token operator">:=</span> <span class="token number">0.00</span>
	<span class="token keyword">if</span> requestTime <span class="token operator">:=</span> <span class="token function">Get</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"beginTime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> requestTime <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		elapsed <span class="token operator">=</span> <span class="token function">float64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>requestTime<span class="token punctuation">.</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1e9</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> elapsed
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">JsonParams</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
	b<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 将取出来的body内容重新插入body，否则ShouldBindJSON无法绑定参数</span>
	c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> gjson<span class="token punctuation">.</span><span class="token function">JsonDecode</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Params</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	b<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 将取出来的body内容重新插入body，否则ShouldBindJSON无法绑定参数</span>
	c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Body <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">NopCloser</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1174"></a>分页返回的使用</h4> 
<p>我们可以找到其中一个接口方法，调用对应的方法，如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Article<span class="token punctuation">)</span> <span class="token function">ArticleList</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	param <span class="token operator">:=</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		Title <span class="token builtin">string</span> <span class="token string">`form:"title" binding:"max=100"`</span>
	<span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	valid<span class="token punctuation">,</span> errs <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">BindAndCheck</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>valid <span class="token punctuation">{<!-- --></span>
		app<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> dict<span class="token punctuation">.</span>InvalidParams<span class="token punctuation">.</span><span class="token function">WithDetails</span><span class="token punctuation">(</span>errs<span class="token punctuation">.</span><span class="token function">Errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	pager <span class="token operator">:=</span> app<span class="token punctuation">.</span>Pager<span class="token punctuation">{<!-- --></span>Page<span class="token punctuation">:</span> app<span class="token punctuation">.</span><span class="token function">GetPage</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> PageSize<span class="token punctuation">:</span> app<span class="token punctuation">.</span><span class="token function">GetPageSize</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">}</span>

	svc <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	totalRows<span class="token punctuation">,</span> err <span class="token operator">:=</span> svc<span class="token punctuation">.</span><span class="token function">CountArticle</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>Title<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		app<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> dict<span class="token punctuation">.</span>ErrGetArtCountFail<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	articles<span class="token punctuation">,</span> err <span class="token operator">:=</span> svc<span class="token punctuation">.</span><span class="token function">GetArticleList</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>Title<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pager<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		app<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> dict<span class="token punctuation">.</span>ErrGetArtListFail<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> article <span class="token operator">:=</span> <span class="token keyword">range</span> articles <span class="token punctuation">{<!-- --></span>
		num<span class="token punctuation">,</span> err <span class="token operator">:=</span> redigo<span class="token punctuation">.</span><span class="token function">GetNum</span><span class="token punctuation">(</span><span class="token string">"article"</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			num <span class="token operator">=</span> <span class="token number">1</span>
		<span class="token punctuation">}</span>
		article<span class="token punctuation">.</span>Views <span class="token operator">+=</span> num
	<span class="token punctuation">}</span>
	<span class="token comment">//分页返回的使用</span>
	app<span class="token punctuation">.</span><span class="token function">SuccessList</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> articles<span class="token punctuation">,</span> totalRows<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Swagger_1216"></a>Swagger接口文档</h3> 
<p>如何维护rest api 接口文档，是绝大部分开发人员都经历过的问题，因为前端、后端、测试开发等等人员都要看，每个人都给一份的话，怎么维护，这将是一个非常头大的问题。</p> 
<p>针对这类问题，市面上出现了大量的解决方案，Swagger 正是其中的佼佼者，它更加的全面和完善，具有相关联的生态圈。</p> 
<p>它是基于标准的 OpenAPI 规范进行设计的，只要照着这套规范去编写你的注解或通过扫描代码去生成注解，就能生成统一标准的接口文档和一系列 Swagger 工具。</p> 
<h4><a id="OpenAPI__Swagger_1224"></a>OpenAPI &amp; Swagger</h4> 
<p>在上文我们有提到 OpenAPI，你可能会对此产生疑惑，OpenAPI 和 Swagger 又是什么关系？</p> 
<p>其实 OpenAPI 规范是在 2015 年由 OpenAPI Initiative 捐赠给 Linux 基金会的，并且 Swagger 对此更进一步的针对 OpenAPI 规范提供了大量与之相匹配的工具集，能够充分利用 OpenAPI 规范去映射生成所有与之关联的资源和操作去查看和调用 RESTful 接口，因此我们也常说 Swagger 不仅是一个“规范”，更是一个框架。</p> 
<p>从功能使用上来讲，OpenAPI 规范能够帮助我们描述一个 API 的基本信息，比如：</p> 
<ul><li>有关该 API 的描述。</li><li>可用路径（/资源）。</li><li>在每个路径上的可用操作（获取/提交…）。</li><li>每个操作的输入/输出格式。</li></ul> 
<h4><a id="_Swagger_1237"></a>安装 Swagger</h4> 
<p>Swagger 相关的工具集会根据 OpenAPI 规范去生成各式各类的与接口相关联的内容，常见的流程是编写注解 =》调用生成库-》生成标准描述文件 =》生成/导入到对应的 Swagger 工具。</p> 
<p>因此接下来第一步，我们要先安装 Go 对应的开源 Swagger 相关联的库，在项目 blog-service 根目录下执行安装命令，如下：</p> 
<pre><code class="prism language-bash">$ go get -u github.com/swaggo/swag/cmd/swag@v1.6.5
$ go get -u github.com/swaggo/gin-swagger@v1.2.0 
$ go get -u github.com/swaggo/files
$ go get -u github.com/alecthomas/template
</code></pre> 
<p>验证是否安装成功，如下：</p> 
<pre><code class="prism language-bash">$ swag -vswag version v1.6.5
</code></pre> 
<p>如果命令行提示寻找不到 swag 文件，可以检查一下对应的 bin 目录是否已经加入到环境变量 PATH 中。</p> 
<h4><a id="_1258"></a>写入注解</h4> 
<p>在完成了 Swagger 关联库的安装后，我们需要针对项目里的 API 接口进行注解的编写，以便于后续在进行生成时能够正确的运行，接下来我们将使用到如下注解：</p> 
<table><thead><tr><th align="left">注解</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">@Summary</td><td align="left">摘要</td></tr><tr><td align="left">@Produce</td><td align="left">API 可以产生的 MIME 类型的列表，MIME 类型你可以简单的理解为响应类型，例如：json、xml、html 等等</td></tr><tr><td align="left">@Param</td><td align="left">参数格式，从左到右分别为：参数名、入参类型、数据类型、是否必填、注释</td></tr><tr><td align="left">@Success</td><td align="left">响应成功，从左到右分别为：状态码、参数类型、数据类型、注释</td></tr><tr><td align="left">@Failure</td><td align="left">响应失败，从左到右分别为：状态码、参数类型、数据类型、注释</td></tr><tr><td align="left">@Router</td><td align="left">路由，从左到右分别为：路由地址，HTTP 方法</td></tr></tbody></table> 
<h4><a id="swagger_1271"></a>swagger注解的编写</h4> 
<p>我们切换到项目目录下的 <code>internal/routers/api/</code> 目录，打开 article.go 文件，在 ArticleList 方法前面，加上swagger注解：</p> 
<pre><code class="prism language-go"><span class="token comment">// ArticleList</span>
<span class="token comment">// @Summary 获取列表</span>
<span class="token comment">// @Produce  json</span>
<span class="token comment">// @Param name query string false "名称" maxlength(100)</span>
<span class="token comment">// @Param page query int false "页码"</span>
<span class="token comment">// @Param page_size query int false "每页数量"</span>
<span class="token comment">// @Success 200 {object} model.Article"成功"</span>
<span class="token comment">// @Failure 400 {object} dict.Error "请求错误"</span>
<span class="token comment">// @Failure 500 {object} dict.Error "内部错误"</span>
<span class="token comment">// @Router /api/articles [get]</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Article<span class="token punctuation">)</span> <span class="token function">ArticleList</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
</code></pre> 
<p>在这里我们只展示了一个接口注解编写，接下来你应当按照注解的含义和参考上述接口注解，完成其他接口注解的编写。</p> 
<h4><a id="swagger__1291"></a>swagger 配置文件的生成</h4> 
<p>在完成了所有的注解编写后，我们回到项目根目录下，执行如下命令：</p> 
<pre><code class="prism language-bash">$ swag init
</code></pre> 
<p>在执行命令完毕后，会发现在 docs 文件夹生成 docs.go、swagger.json、swagger.yaml 三个文件。</p> 
<h4><a id="swagger_1301"></a>swagger中间件的注册</h4> 
<p>那注解编写完，也通过 swag init 把 Swagger API 所需要的文件都生成了，那接下来我们怎么访问接口文档呢？</p> 
<p>其实很简单，我们只需要在 routers 中进行默认初始化和注册对应的路由就可以了，打开项目目录下的 <code>internal/routers</code> 目录中的 router.go 文件，新增代码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token operator">...</span>
    <span class="token boolean">_</span> <span class="token string">"github.com/go-programming-tour-book/blog-service/docs"</span>
    ginSwagger <span class="token string">"github.com/swaggo/gin-swagger"</span>
    <span class="token string">"github.com/swaggo/gin-swagger/swaggerFiles"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">NewRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{<!-- --></span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span><span class="token function">Recovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/swagger/*any"</span><span class="token punctuation">,</span> ginSwagger<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span>swaggerFiles<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> r
<span class="token punctuation">}</span>
</code></pre> 
<p>从表面上来看，主要做了两件事，分别是初始化 docs 包和注册一个针对 swagger 的路由，而在初始化 docs 包后，其 swagger.json 将会默认指向当前应用所启动的域名下的 swagger/doc.json 路径，如果有额外需求，可进行手动指定，如下：</p> 
<pre><code class="prism language-go">url <span class="token operator">:=</span> ginSwagger<span class="token punctuation">.</span><span class="token function">URL</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:8000/swagger/doc.json"</span><span class="token punctuation">)</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/swagger/*any"</span><span class="token punctuation">,</span> ginSwagger<span class="token punctuation">.</span><span class="token function">WrapHandler</span><span class="token punctuation">(</span>swaggerFiles<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="swagger_1331"></a>通过swagger查看接口文档</h4> 
<pre><code class="prism language-go">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">9099</span><span class="token operator">/</span>swagger<span class="token operator">/</span>index<span class="token punctuation">.</span>html
</code></pre> 
<p><img src="https://images2.imgbox.com/09/a7/SxMG3mZE_o.png" alt=""></p> 
<p>在完成了上述的设置后，我们重新启动服务端，在浏览器中访问 Swagger 的地址 ，就可以看到上述图片中的 Swagger 文档展示，</p> 
<p>其主要分为三个部分，分别是项目主体信息、接口路由信息、模型信息，这三部分共同组成了我们主体内容。</p> 
<h4><a id="Swagger__1345"></a>Swagger 背后发生了什么</h4> 
<p>可能会疑惑，我明明只是初始化了个 docs 包并注册了一个 Swagger 相关路由，Swagger 的文档是怎么关联上的呢，我在接口上写的注解又到哪里去了？</p> 
<p>其实主体是与swagger init 生成的文件有关的，分别是：</p> 
<pre><code>docs
├── docs.go
├── swagger.json
└── swagger.yaml
</code></pre> 
<h5><a id="_docs_1358"></a>初始化 docs</h5> 
<p>在第一步中，我们初始化了 docs 包，对应的其实就是 docs.go 文件，因为目录下仅有一个 go 源文件，其源码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> docs

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"strings"</span>

	<span class="token string">"github.com/alecthomas/template"</span>
	<span class="token string">"github.com/swaggo/swag"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> doc <span class="token operator">=</span> <span class="token string">`{
    "schemes": {<!-- -->{ marshal .Schemes }},
    "swagger": "2.0",
    "info": {
        "description": "{<!-- -->{.Description}}",
        "title": "{<!-- -->{.Title}}",
        "contact": {},
        "license": {},
        "version": "{<!-- -->{.Version}}"
    },
    "host": "{<!-- -->{.Host}}",
    "basePath": "{<!-- -->{.BasePath}}",
    "paths": {
        "/api/articles": {
            "get": {
                "produces": [
                    "application/json"
                ],
                "summary": "获取列表",
                "parameters": [
                    {
                        "maxLength": 100,
                        "type": "string",
                        "description": "名称",
                        "name": "name",
                        "in": "query"
                    },
                    {
                        "enum": [
                            0,
                            1
                        ],
                        "type": "integer",
                        "default": 1,
                        "description": "状态",
                        "name": "state",
                        "in": "query"
                    },
                    {
                        "type": "integer",
                        "description": "页码",
                        "name": "page",
                        "in": "query"
                    },
                    {
                        "type": "integer",
                        "description": "每页数量",
                        "name": "page_size",
                        "in": "query"
                    }
                ],
                "responses": {
                    "200": {
                        "description": "成功",
                        "schema": {
                            "$ref": "#/definitions/model.Article"
                        }
                    },
                    "400": {
                        "description": "请求错误",
                        "schema": {
                            "$ref": "#/definitions/dict.Error"
                        }
                    },
                    "500": {
                        "description": "内部错误",
                        "schema": {
                            "$ref": "#/definitions/dict.Error"
                        }
                    }
                }
            }
        }
    },
    "definitions": {
        "dict.Error": {
            "type": "object",
            "properties": {
                "code": {
                    "type": "integer"
                },
                "details": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "level": {
                    "type": "string"
                },
                "msg": {
                    "type": "string"
                }
            }
        },
        "model.Article": {
            "type": "object",
            "properties": {
                "content": {
                    "type": "string"
                },
                "id": {
                    "type": "integer"
                },
                "introduction": {
                    "type": "string"
                },
                "title": {
                    "type": "string"
                }
            }
        }
    }
}`</span>

<span class="token keyword">type</span> swaggerInfo <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Version     <span class="token builtin">string</span>
	Host        <span class="token builtin">string</span>
	BasePath    <span class="token builtin">string</span>
	Schemes     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	Title       <span class="token builtin">string</span>
	Description <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// SwaggerInfo holds exported Swagger Info so clients can modify it</span>
<span class="token keyword">var</span> SwaggerInfo <span class="token operator">=</span> swaggerInfo<span class="token punctuation">{<!-- --></span>
	Version<span class="token punctuation">:</span>     <span class="token string">"1.0"</span><span class="token punctuation">,</span>
	Host<span class="token punctuation">:</span>        <span class="token string">""</span><span class="token punctuation">,</span>
	BasePath<span class="token punctuation">:</span>    <span class="token string">""</span><span class="token punctuation">,</span>
	Schemes<span class="token punctuation">:</span>     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	Title<span class="token punctuation">:</span>       <span class="token string">"gin系统"</span><span class="token punctuation">,</span>
	Description<span class="token punctuation">:</span> <span class="token string">"gin开发的系统"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> s <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token function">ReadDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	sInfo <span class="token operator">:=</span> SwaggerInfo
	sInfo<span class="token punctuation">.</span>Description <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>sInfo<span class="token punctuation">.</span>Description<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">"\\n"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

	t<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"swagger_info"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Funcs</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span>FuncMap<span class="token punctuation">{<!-- --></span>
		<span class="token string">"marshal"</span><span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
			a<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> doc
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> tpl bytes<span class="token punctuation">.</span>Buffer
	<span class="token keyword">if</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tpl<span class="token punctuation">,</span> sInfo<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> doc
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> tpl<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	swag<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>swag<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过对源码的分析，我们可以得知实质上在初始化 docs 包时，会默认执行 init 方法，而在 init 方法中，会注册相关方法，主体逻辑是 swag 会在生成时去检索项目下的注解信息，然后将项目信息和接口路由信息按规范生成到包全局变量 doc 中去。</p> 
<p>紧接着会在 ReadDoc 方法中做一些 template 的模板映射等工作，完善 doc 的输出。</p> 
<h5><a id="swagger_1541"></a>swagger注册路由</h5> 
<p>在上一步中，我们知道了生成的注解数据源在哪，但是它们两者又是怎么关联起来的呢，实际上与我们调用的 <code>ginSwagger.WrapHandler(swaggerFiles.Handler)</code> 有关，如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">WrapHandler</span><span class="token punctuation">(</span>h <span class="token operator">*</span>webdav<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> confs <span class="token operator">...</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Config<span class="token punctuation">)</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{<!-- --></span>
    defaultConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>Config<span class="token punctuation">{<!-- --></span>URL<span class="token punctuation">:</span> <span class="token string">"doc.json"</span><span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token function">CustomWrapHandler</span><span class="token punctuation">(</span>defaultConfig<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实际上在调用 WrapHandler 后，swag 内部会将其默认调用的 URL 设置为 doc.json，但你可能会纠结，明明我们生成的文件里没有 doc.json，这又是从哪里来的，我们接着往下看，如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">CustomWrapHandler</span><span class="token punctuation">(</span>config <span class="token operator">*</span>Config<span class="token punctuation">,</span> h <span class="token operator">*</span>webdav<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{<!-- --></span>
      <span class="token operator">...</span>
        <span class="token keyword">switch</span> path <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token string">"index.html"</span><span class="token punctuation">:</span>
            index<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>swaggerUIBundle<span class="token punctuation">{<!-- --></span>
                URL<span class="token punctuation">:</span> config<span class="token punctuation">.</span>URL<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token string">"doc.json"</span><span class="token punctuation">:</span>
            doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> swag<span class="token punctuation">.</span><span class="token function">ReadDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            h<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 CustomWrapHandler 方法中，我们可以发现一处比较经典 switch case 的逻辑。</p> 
<p>在第一个 case 中，处理是的 index.html，这又是什么呢，其实你可以回顾一下，我们在先前是通过</p> 
<pre><code class="prism language-go">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">9099</span><span class="token operator">/</span>swagger<span class="token operator">/</span>index<span class="token punctuation">.</span>html
</code></pre> 
<p>访问到 Swagger 文档的，对应的便是这里的逻辑。</p> 
<h3><a id="_1589"></a>为接口做参数校验</h3> 
<p>接下来我们将正式进行编码，在进行对应的业务模块开发时，第一步要考虑到的问题的就是如何进行入参校验，我们需要将整个项目，甚至整个团队的组件给定下来，形成一个通用规范，并完成标签模块的接口的入参校验。</p> 
<h4><a id="validator__1593"></a>validator 介绍</h4> 
<p>在本项目中我们将使用开源项目 <a href="https://github.com/go-playground/validator"><strong>go-playground/validator</strong></a> 作为我们的本项目的基础库，它是一个基于标签来对结构体和字段进行值验证的一个验证器。</p> 
<p>那么，我们要单独引入这个库吗，其实不然，因为我们使用的 gin 框架，其内部的模型绑定和验证默认使用的是 <a href="https://github.com/go-playground/validator"><strong>go-playground/validator</strong></a> 来进行参数绑定和校验，使用起来非常方便。</p> 
<p>在项目根目录下执行命令，进行安装：</p> 
<pre><code class="prism language-bash">$ go get -u github.com/go-playground/validator/v10
</code></pre> 
<h4><a id="_1605"></a>业务接口校验</h4> 
<p>接下来我们将正式开始对接口的入参进行校验规则的编写，也就是将校验规则写在对应的结构体的字段标签上，常见的标签含义如下：</p> 
<table><thead><tr><th align="left">标签</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">required</td><td align="left">必填</td></tr><tr><td align="left">gt</td><td align="left">大于</td></tr><tr><td align="left">gte</td><td align="left">大于等于</td></tr><tr><td align="left">lt</td><td align="left">小于</td></tr><tr><td align="left">lte</td><td align="left">小于等于</td></tr><tr><td align="left">min</td><td align="left">最小值</td></tr><tr><td align="left">max</td><td align="left">最大值</td></tr><tr><td align="left">oneof</td><td align="left">参数集内的其中之一</td></tr><tr><td align="left">len</td><td align="left">长度要求与 len 给定的一致</td></tr></tbody></table> 
<h4><a id="_1621"></a>文章接口校验</h4> 
<p>我们回到项目的 <code>internal/service</code> 目录下的 article.go 文件，针对入参校验增加绑定/验证结构体。</p> 
<p>这块与登录模块的验证规则差不多，主要是必填，长度最小、最大的限制，以及要求参数值必须在某个集合内的其中之一.</p> 
<p>登录模块的验证规则， 回顾如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> LoginForm <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Username <span class="token builtin">string</span> <span class="token string">`json:"username" binding:"required" validate:"required"`</span>
	Password <span class="token builtin">string</span> <span class="token string">`json:"password" binding:"required" validate:"required"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Login</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> form LoginForm
	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindWith</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>form<span class="token punctuation">,</span> binding<span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	validate <span class="token operator">:=</span> validator<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> validate<span class="token punctuation">.</span><span class="token function">Struct</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnprocessableEntity<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
		<span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"login"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// TODO: 处理登录逻辑</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1660"></a>模块开发：商品管理</h3> 
<p>作为一个参考，接下来我们正式的进入一个业务模块的业务逻辑开发，商品管理 的开发，</p> 
<p>首先进行 rest api 的设计， 涉及的api 接口如下：</p> 
<table><thead><tr><th align="left">功能</th><th align="left">HTTP 方法</th><th align="left">路径</th></tr></thead><tbody><tr><td align="left">新增商品</td><td align="left">POST</td><td align="left">/seckillskus</td></tr><tr><td align="left">删除指定商品</td><td align="left">DELETE</td><td align="left">/seckillskus/:id</td></tr><tr><td align="left">更新指定商品</td><td align="left">PUT</td><td align="left">/seckillskus/:id</td></tr><tr><td align="left">获取商品列表</td><td align="left">GET</td><td align="left">/seckillskus</td></tr></tbody></table> 
<h4><a id="model__1675"></a>商品model 领域层开发</h4> 
<p>首先，根据数据库里边的表 seckill_sku，生产一个简单的 model</p> 
<p><img src="https://images2.imgbox.com/df/11/CKnyn25w_o.png" alt=""></p> 
<p>生产之后，放在了项目的 <code>internal/model</code> 目录下。</p> 
<p>这个对应的model文件 seckillsku.go 文件。</p> 
<p>接下来， 在 seckillsku.go 文件中添加 orm操作的方法，并且只添加与orm 实体相关的方法，代码如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> model

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/jinzhu/gorm"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> SeckillSku <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	SkuId      <span class="token builtin">int64</span>     <span class="token string">`json:"sku_id"`</span>     <span class="token comment">// 商品id</span>
	CostPrice  <span class="token builtin">float32</span>   <span class="token string">`json:"cost_price"`</span> <span class="token comment">// 秒杀价格</span>
	CreateTime time<span class="token punctuation">.</span>Time <span class="token string">`json:"create_time"`</span>
	EndTime    time<span class="token punctuation">.</span>Time <span class="token string">`json:"end_time"`</span>
	SkuImage   <span class="token builtin">string</span>    <span class="token string">`json:"sku_image"`</span>
	SkuPrice   <span class="token builtin">float32</span>   <span class="token string">`json:"sku_price"`</span> <span class="token comment">// 价格</span>
	StartTime  time<span class="token punctuation">.</span>Time <span class="token string">`json:"start_time"`</span>
	StockCount <span class="token builtin">int</span>       <span class="token string">`json:"stock_count"`</span> <span class="token comment">// 剩余库存</span>
	SkuTitle   <span class="token builtin">string</span>    <span class="token string">`json:"sku_title"`</span>
	RawStock   <span class="token builtin">int</span>       <span class="token string">`json:"raw_stock"`</span>   <span class="token comment">// 原始库存</span>
	ExposedKey <span class="token builtin">string</span>    <span class="token string">`json:"exposed_key"`</span> <span class="token comment">// 秒杀md5</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s SeckillSku<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token string">"seckill_sku"</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s SeckillSku<span class="token punctuation">)</span> <span class="token function">Count</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> count <span class="token builtin">int</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>SkuTitle <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		db <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"sku_title = ?"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>SkuTitle<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> count<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s SeckillSku<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> pageOffset<span class="token punctuation">,</span> pageSize <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SeckillSku<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> SeckillSkus <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SeckillSku
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
	<span class="token keyword">if</span> pageOffset <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pageSize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		db <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span>pageOffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>SkuTitle <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		db <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"sku_title = ?"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>SkuTitle<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SeckillSkus<span class="token punctuation">)</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> SeckillSkus<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s SeckillSku<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s SeckillSku<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"sku_id = ? "</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>SkuId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s SeckillSku<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token string">"sku_id = ?"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>SkuId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>Model</strong>：指定运行 DB 操作的模型实例，默认解析该结构体的名字为表名，格式为大写驼峰转小写下划线驼峰。若情况特殊，也可以编写该结构体的 TableName 方法用于指定其对应返回的表名。</li><li><strong>Where</strong>：设置筛选条件，接受 map，struct 或 string 作为条件。</li><li><strong>Offset</strong>：偏移量，用于指定开始返回记录之前要跳过的记录数。</li><li><strong>Limit</strong>：限制检索的记录数。</li><li><strong>Find</strong>：查找符合筛选条件的记录。</li><li><strong>Updates</strong>：更新所选字段。</li><li><strong>Delete</strong>：删除数据。</li><li><strong>Count</strong>：统计行为，用于统计模型的记录数。</li></ul> 
<p>需要注意的是，在上述代码中，我们采取的是将 <code>db *gorm.DB</code> 作为函数首参数传入的方式，而在业界中也有另外一种方式，是基于结构体传入的，两者本质上都可以实现目的，读者根据实际情况（使用习惯、项目规范等）进行选用即可，其各有利弊。</p> 
<h4><a id="_dao__1763"></a>商品 dao 层开发</h4> 
<p>我们在项目的 <code>internal/dao</code> 目录下新建 seckillSku.go 文件，写入如下代码：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> dao

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"crazymakercircle.com/gin-rest/internal/model"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/pkg/app"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Dao<span class="token punctuation">)</span> <span class="token function">CountSeckillSku</span><span class="token punctuation">(</span>title <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	tag <span class="token operator">:=</span> model<span class="token punctuation">.</span>SeckillSku<span class="token punctuation">{<!-- --></span>SkuTitle<span class="token punctuation">:</span> title<span class="token punctuation">}</span>
	<span class="token keyword">return</span> tag<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>engine<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Dao<span class="token punctuation">)</span> <span class="token function">GetSeckillSkuList</span><span class="token punctuation">(</span>title <span class="token builtin">string</span><span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>model<span class="token punctuation">.</span>SeckillSku<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	seckillSku <span class="token operator">:=</span> model<span class="token punctuation">.</span>SeckillSku<span class="token punctuation">{<!-- --></span>SkuTitle<span class="token punctuation">:</span> title<span class="token punctuation">}</span>
	pageOffset <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">GetPageOffset</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span>
	<span class="token keyword">return</span> seckillSku<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>engine<span class="token punctuation">,</span> pageOffset<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Dao<span class="token punctuation">)</span> <span class="token function">CreateSeckillSku</span><span class="token punctuation">(</span>title <span class="token builtin">string</span><span class="token punctuation">,</span> rawStock <span class="token builtin">int</span><span class="token punctuation">,</span> createdBy <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	tag <span class="token operator">:=</span> model<span class="token punctuation">.</span>SeckillSku<span class="token punctuation">{<!-- --></span>
		SkuTitle<span class="token punctuation">:</span> title<span class="token punctuation">,</span>
		RawStock<span class="token punctuation">:</span> rawStock<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> tag<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>engine<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Dao<span class="token punctuation">)</span> <span class="token function">UpdateSeckillSku</span><span class="token punctuation">(</span>id <span class="token builtin">int64</span><span class="token punctuation">,</span> title <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	seckillSku <span class="token operator">:=</span> model<span class="token punctuation">.</span>SeckillSku<span class="token punctuation">{<!-- --></span>
		SkuTitle<span class="token punctuation">:</span> title<span class="token punctuation">,</span>
		SkuId<span class="token punctuation">:</span>    id<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> seckillSku<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>engine<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Dao<span class="token punctuation">)</span> <span class="token function">DeleteSeckillSku</span><span class="token punctuation">(</span>id <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	seckillSku <span class="token operator">:=</span> model<span class="token punctuation">.</span>SeckillSku<span class="token punctuation">{<!-- --></span>SkuId<span class="token punctuation">:</span> id<span class="token punctuation">}</span>
	<span class="token keyword">return</span> seckillSku<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>engine<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上述代码中，我们主要是在 dao 层进行了数据访问对象的封装，并针对业务所需的字段进行了处理。</p> 
<h4><a id="_service__1808"></a>商品 service 层开发</h4> 
<p>我们在项目的 <code>internal/service</code> 目录下新建 service.go 文件，写入如下代码：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Service <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    ctx context<span class="token punctuation">.</span>Context
    dao <span class="token operator">*</span>dao<span class="token punctuation">.</span>Dao
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> Service <span class="token punctuation">{<!-- --></span>
    svc <span class="token operator">:=</span> Service<span class="token punctuation">{<!-- --></span>ctx<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span>
    svc<span class="token punctuation">.</span>dao <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>DBEngine<span class="token punctuation">)</span>
    <span class="token keyword">return</span> svc
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来在同层级下新建 seckillSku.go 文件，用于处理商品模块的业务逻辑，写入如下代码：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> service

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"crazymakercircle.com/gin-rest/internal/model"</span>
	<span class="token string">"crazymakercircle.com/gin-rest/pkg/app"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> SeckillSkuListRequest <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	title <span class="token builtin">string</span> <span class="token string">`form:"title" binding:"max=100"`</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> CreateSeckillSkuRequest <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	title    <span class="token builtin">string</span> <span class="token string">`form:"title" binding:"required,max=100"`</span>
	rawStock <span class="token builtin">int</span>    <span class="token string">`form:"rawStock,default=1" binding:"required"`</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> UpdateSeckillSkuRequest <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	ID    <span class="token builtin">int64</span>  <span class="token string">`form:"id" binding:"required,gte=0"`</span>
	title <span class="token builtin">string</span> <span class="token string">`form:"title" binding:"required,max=100"`</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> DeleteSeckillSkuRequest <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	ID <span class="token builtin">int64</span> <span class="token string">`form:"id" binding:"required,gte=0"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>svc <span class="token operator">*</span>Service<span class="token punctuation">)</span> <span class="token function">CountSeckillSku</span><span class="token punctuation">(</span>param <span class="token operator">*</span>SeckillSkuListRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> svc<span class="token punctuation">.</span>dao<span class="token punctuation">.</span><span class="token function">CountSeckillSku</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>svc <span class="token operator">*</span>Service<span class="token punctuation">)</span> <span class="token function">GetSeckillSkuList</span><span class="token punctuation">(</span>param <span class="token operator">*</span>SeckillSkuListRequest<span class="token punctuation">,</span> pager <span class="token operator">*</span>app<span class="token punctuation">.</span>Pager<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>model<span class="token punctuation">.</span>SeckillSku<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> svc<span class="token punctuation">.</span>dao<span class="token punctuation">.</span><span class="token function">GetSeckillSkuList</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>title<span class="token punctuation">,</span> pager<span class="token punctuation">.</span>Page<span class="token punctuation">,</span> pager<span class="token punctuation">.</span>PageSize<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>svc <span class="token operator">*</span>Service<span class="token punctuation">)</span> <span class="token function">CreateSeckillSku</span><span class="token punctuation">(</span>param <span class="token operator">*</span>CreateSeckillSkuRequest<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> svc<span class="token punctuation">.</span>dao<span class="token punctuation">.</span><span class="token function">CreateSeckillSku</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>title<span class="token punctuation">,</span> param<span class="token punctuation">.</span>rawStock<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>svc <span class="token operator">*</span>Service<span class="token punctuation">)</span> <span class="token function">UpdateSeckillSku</span><span class="token punctuation">(</span>param <span class="token operator">*</span>UpdateSeckillSkuRequest<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> svc<span class="token punctuation">.</span>dao<span class="token punctuation">.</span><span class="token function">UpdateSeckillSku</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> param<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>svc <span class="token operator">*</span>Service<span class="token punctuation">)</span> <span class="token function">DeleteSeckillSku</span><span class="token punctuation">(</span>param <span class="token operator">*</span>DeleteSeckillSkuRequest<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> svc<span class="token punctuation">.</span>dao<span class="token punctuation">.</span><span class="token function">DeleteSeckillSku</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>service 主要是 调用了dao中的方法，当然，还可以在service 进行了一些简单的逻辑编写。</p> 
<p>这里主要是为了演示，没有添加任何的业务逻辑。</p> 
<h4><a id="_1872"></a>新增业务错误码</h4> 
<p>我们在项目的 common/dict/errcode.go 文件，针对商品模块，写入如下错误代码：</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>
	ErrorGetSeckillSkuListFail <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">20010001</span><span class="token punctuation">,</span> <span class="token string">"获取商品列表失败"</span><span class="token punctuation">)</span>
	ErrorCreateSeckillSkuFail  <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">20010002</span><span class="token punctuation">,</span> <span class="token string">"创建商品失败"</span><span class="token punctuation">)</span>
	ErrorUpdateSeckillSkuFail  <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">20010003</span><span class="token punctuation">,</span> <span class="token string">"更新商品失败"</span><span class="token punctuation">)</span>
	ErrorDeleteSeckillSkuFail  <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">20010004</span><span class="token punctuation">,</span> <span class="token string">"删除商品失败"</span><span class="token punctuation">)</span>
	ErrorCountSeckillSkuFail   <span class="token operator">=</span> <span class="token function">NewError</span><span class="token punctuation">(</span><span class="token number">20010005</span><span class="token punctuation">,</span> <span class="token string">"统计商品失败"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="handler_1886"></a>新增商品的handler方法</h4> 
<p>我们打开 <code>internal/api/</code> 项目目录下的 seckillsku.go 文件，写入如下代码：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t SeckillSku<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	param <span class="token operator">:=</span> service<span class="token punctuation">.</span>SeckillSkuListRequest<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	response <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewCtxResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	valid<span class="token punctuation">,</span> errs <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">BindAndValid</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>valid <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"app.BindAndValid errs: %v"</span><span class="token punctuation">,</span> errs<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>InvalidParams<span class="token punctuation">.</span><span class="token function">WithDetails</span><span class="token punctuation">(</span>errs<span class="token punctuation">.</span><span class="token function">Errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	svc <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	pager <span class="token operator">:=</span> app<span class="token punctuation">.</span>Pager<span class="token punctuation">{<!-- --></span>Page<span class="token punctuation">:</span> app<span class="token punctuation">.</span><span class="token function">GetPage</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> PageSize<span class="token punctuation">:</span> app<span class="token punctuation">.</span><span class="token function">GetPageSize</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">}</span>
	totalRows<span class="token punctuation">,</span> err <span class="token operator">:=</span> svc<span class="token punctuation">.</span><span class="token function">CountSeckillSku</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>service<span class="token punctuation">.</span>SeckillSkuListRequest<span class="token punctuation">{<!-- --></span>Title<span class="token punctuation">:</span> param<span class="token punctuation">.</span>Title<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"svc.CountSeckillSku err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>ErrorCountSeckillSkuFail<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	tags<span class="token punctuation">,</span> err <span class="token operator">:=</span> svc<span class="token punctuation">.</span><span class="token function">GetSeckillSkuList</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>param<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pager<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"svc.GetSeckillSkuList err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>ErrorGetSeckillSkuListFail<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	response<span class="token punctuation">.</span><span class="token function">ToCtxResponseList</span><span class="token punctuation">(</span>tags<span class="token punctuation">,</span> totalRows<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上述代码中，我们完成了获取商品列表接口的处理方法，</p> 
<p>我们在方法中完成了入参校验和绑定、获取商品总数、获取商品列表、 序列化结果集等四大功能板块的逻辑串联和日志、错误处理。</p> 
<p>我们继续写入创建商品、更新商品、删除商品的接口处理方法，如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t SeckillSku<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	param <span class="token operator">:=</span> service<span class="token punctuation">.</span>CreateSeckillSkuRequest<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	response <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewCtxResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	valid<span class="token punctuation">,</span> errs <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">BindAndValid</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>valid <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"app.BindAndValid errs: %v"</span><span class="token punctuation">,</span> errs<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>InvalidParams<span class="token punctuation">.</span><span class="token function">WithDetails</span><span class="token punctuation">(</span>errs<span class="token punctuation">.</span><span class="token function">Errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	svc <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	err <span class="token operator">:=</span> svc<span class="token punctuation">.</span><span class="token function">CreateSeckillSku</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>param<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"svc.CreateSeckillSku err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>ErrorCreateSeckillSkuFail<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	app<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"title"</span><span class="token punctuation">:</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t SeckillSku<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	response <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewCtxResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> cast<span class="token punctuation">.</span><span class="token function">ToInt64E</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"svc.UpdateSeckillSku err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>ErrorUpdateSeckillSkuFail<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	param <span class="token operator">:=</span> service<span class="token punctuation">.</span>UpdateSeckillSkuRequest<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	valid<span class="token punctuation">,</span> errs <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">BindAndValid</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>valid <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"app.BindAndValid errs: %v"</span><span class="token punctuation">,</span> errs<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>InvalidParams<span class="token punctuation">.</span><span class="token function">WithDetails</span><span class="token punctuation">(</span>errs<span class="token punctuation">.</span><span class="token function">Errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	svc <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	err1 <span class="token operator">:=</span> svc<span class="token punctuation">.</span><span class="token function">UpdateSeckillSku</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>param<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"svc.UpdateSeckillSku err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>ErrorUpdateSeckillSkuFail<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	app<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t SeckillSku<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	response <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewCtxResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> cast<span class="token punctuation">.</span><span class="token function">ToInt64E</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"svc.Delete err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>ErrorUpdateSeckillSkuFail<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	param <span class="token operator">:=</span> service<span class="token punctuation">.</span>DeleteSeckillSkuRequest<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	valid<span class="token punctuation">,</span> errs <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">BindAndValid</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>valid <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"app.BindAndValid errs: %v"</span><span class="token punctuation">,</span> errs<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>InvalidParams<span class="token punctuation">.</span><span class="token function">WithDetails</span><span class="token punctuation">(</span>errs<span class="token punctuation">.</span><span class="token function">Errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	svc <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	err1 <span class="token operator">:=</span> svc<span class="token punctuation">.</span><span class="token function">DeleteSeckillSku</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>param<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		global<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"svc.DeleteSeckillSku err: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span><span class="token function">ToErrorResponse</span><span class="token punctuation">(</span>dict<span class="token punctuation">.</span>ErrorDeleteSeckillSkuFail<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	app<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"id"</span><span class="token punctuation">:</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="api_2003"></a>新增商品的api路由</h4> 
<pre><code class="prism language-go">seckillSku <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">NewSeckillsku</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
apiRouterGroup<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/seckillskus"</span><span class="token punctuation">,</span> seckillSku<span class="token punctuation">.</span>List<span class="token punctuation">)</span>
apiRouterGroup<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/seckillskus/:id"</span><span class="token punctuation">,</span> seckillSku<span class="token punctuation">.</span>Detail<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_2015"></a>验证商品接口</h4> 
<p>我们重新启动服务，也就是再执行 <code>go run main.go</code>，查看启动信息正常后，对商品模块的接口进行验证</p> 
<p>（1）商品列表的验证</p> 
<pre><code class="prism language-bash">$ <span class="token function">curl</span> -X GET http://192.168.56.1:9099/api/seckillskus?page_size<span class="token operator">=</span><span class="token number">2</span> 
</code></pre> 
<p>执行的效果如下</p> 
<p><img src="https://images2.imgbox.com/f7/73/kVzElZIB_o.png" alt=""></p> 
<p>（2）验证获取商品</p> 
<pre><code class="prism language-bash">$ <span class="token function">curl</span> -X GET http://192.168.56.1:9099/api/seckillskus/1?title<span class="token operator">=</span>demo
</code></pre> 
<p>执行的效果如下</p> 
<p><img src="https://images2.imgbox.com/3a/08/dZXZHVZ0_o.png" alt=""></p> 
<p>这里的获取商品详情的 DAO层、Service 层代码，都没有实现，留个大家自己去实现。</p> 
<p>删除商品、删除商品的验证，也留给大家自己去实现。</p> 
<p>另外注意：在更新的时候，当使用 GORM 中使用 struct 类型传入进行更新时，GORM 是不会对值为零值的字段进行变更。这又是为什么呢，根本的原因是因为在识别这个结构体中的这个字段值时，很难判定是真的是零值，还是外部传入恰好是该类型的零值，GORM 在这块并没有过多的去做特殊识别。</p> 
<h3><a id="Golang__5W_2057"></a>《Golang 圣经》还有 5W字待发布</h3> 
<p>本文，仅仅是《Golang 圣经》 的第4部分。《Golang 圣经》后面的内容 更加精彩，涉及到<strong>高并发、分布式微服务架构、 WEB开发架构</strong>。</p> 
<p>《Golang 圣经》PDF， 请到文末【技术自由圈】取 。</p> 
<p>最后，如果学习过程中遇到问题，可以来尼恩的 万人高并发社区 中沟通。</p> 
<h3><a id="_2065"></a>参考资料</h3> 
<ul><li><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection#Na.C3.AFve_mark-and-sweep" rel="nofollow">Tracing Garbage Collection - wikipedia</a></li><li><a href="http://www.cs.utexas.edu/users/mckinley/395Tmm/talks/Mar-30-Dijkstra.pdf" rel="nofollow">On-the-fly Garbage Collection: an exercise in cooperation.</a></li><li><a href="https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29" rel="nofollow">Garbage Collection</a></li><li><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection" rel="nofollow">Tracing Garbage Collection</a></li><li><a href="https://www.youtube.com/watch?v=P1rU_9IB414" rel="nofollow">Copying Garbage Collection</a></li><li><a href="https://www.youtube.com/watch?v=pJHISaOW6Vc" rel="nofollow">Generational Garbage Collection</a></li><li><a href="https://github.com/KeKe-Li/book/blob/master/Go/go-gc.pdf">Golang Gc Talk</a></li><li><a href="https://github.com/golang/proposal/blob/master/design/17503-eliminate-rescan.md">Eliminate Rescan</a></li></ul> 
<h3><a id="_PDF_2085"></a>技术自由的实现路径 PDF：</h3> 
<h5><a id="__2087"></a>实现你的 架构自由：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129204455">吃透8图1模板，人人可以做架构</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129410795">10Wqps评论中台，如何架构？B站是这么做的！！！</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128848309">阿里二面：千万级、亿级数据，如何性能优化？ 教科书级 答案来了</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128725701">峰值21WQps、亿级DAU，小游戏《羊了个羊》是怎么架构的？</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129145200">100亿级订单怎么调度，来一个大厂的极品方案</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128697096">2个大厂 100亿级 超大流量 红包 架构方案</a>》</p> 
<p><em>… 更多架构文章，正在添加中</em></p> 
<h5><a id="___2105"></a>实现你的 响应式 自由：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129022714">响应式圣经：10W字，实现Spring响应式编程自由</a>》</p> 
<p>这是老版本 《<a href="https://blog.csdn.net/crazymakercircle/article/details/124120506">Flux、Mono、Reactor 实战（史上最全）</a>》</p> 
<h5><a id="_spring_cloud__2113"></a>实现你的 spring cloud 自由：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129559428">Spring cloud Alibaba 学习圣经</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/123420859">分库分表 Sharding-JDBC 底层原理、核心实战（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125135726">一文搞定：SpringBoot、SLF4j、Log4j、Logback、Netty之间混乱关系（史上最全）</a>》</p> 
<h5><a id="_linux__2124"></a>实现你的 linux 自由：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128932396">Linux命令大全：2W多字，一次实现Linux自由</a>》</p> 
<h5><a id="___2130"></a>实现你的 网络 自由：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/114527369">TCP协议详解 (史上最全)</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129334254">网络三张表：ARP表, MAC表, 路由表，实现你的网络自由！！</a>》</p> 
<h5><a id="___2138"></a>实现你的 分布式锁 自由：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/116425814">Redis分布式锁（图解 - 秒懂 - 史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/85956246">Zookeeper 分布式锁 - 图解 - 秒懂</a>》</p> 
<h5><a id="___2146"></a>实现你的 王者组件 自由：</h5> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128264803">队列之王： Disruptor 原理、架构、源码 一文穿透</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128123114">缓存之王：Caffeine 源码、架构、原理（史上最全，10W字 超级长文）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/113751575">缓存之王：Caffeine 的使用（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/126579528">Java Agent 探针、字节码增强 ByteBuddy（史上最全）</a>》</p> 
<h5><a id="___2158"></a>实现你的 面试题 自由：</h5> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/124790425">4000页《尼恩Java面试宝典 》 40个专题</a></p> 
<p>尼恩 架构笔记、面试题 的PDF文件更新，请到下面《技术自由圈》公号取↓↓↓</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f3cf9bd9360b95a2de3b88ab4d750bd8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Java|多线程与高并发】定时器(Timer)详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/54cde976c48ebd3a426a4f0387bf5bf5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android系统安全 — 6.3 TLS双向认证原理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>