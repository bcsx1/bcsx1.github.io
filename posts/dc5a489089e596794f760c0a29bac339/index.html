<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>linux设备驱动程序注册过程详解(一) - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="linux设备驱动程序注册过程详解(一)" />
<meta property="og:description" content="原文地址：http://blog.csdn.net/tuzhutuzhu/article/details/34445847
Linux的驱动程序注册过程，大致分为两个步骤：
模块初始化驱动程序注册 下面以内核提供的示例代码pci-skeleton.c，详细说明一个pci设备驱动程序的注册过程。其他设备的驱动代码注册过程基本相同，大家可自行查看。使用的内核代码版本是2.6.38。
1. 模块初始化 1.1 驱动程序入口 所有的设备驱动程序都会有如下两行代码：
1922 module_init( netdrv_init_module) ; 1923 module_exit( netdrv_cleanup_module) ; module_init/module_exit是两个宏。module_init是该驱动程序的入口，加载驱动模块时，驱动程序就从netdrv_init_module函数开始执行。而当该驱动程序对应的设备被删除了，则会执行netdrv_cleanup_module这个函数。---至于何时驱动模块加载，何时驱动模块卸载，有待后续追踪follow up 1.2 模块初始化 当驱动程序开始执行时，首先会执行该驱动程序的初始化函数netdrv_init_module，代码如下：
1906 static int __init netdrv_init_module( void) 1907 { 1908 /* when a module, this is printed whether or not devices are found in probe */ 1909 #ifdef MODULE 1910 printk(version); 1911 #endif 1912 return pci_register_driver(&amp;netdrv_pci_driver); 1913 } 可以看到，模块初始化函数很简单，只执行了一个pci_register_driver函数就返回了。 其实模块的初始化过程就是这么简单，这也是linux驱动程序的ISO标准流程：module_init--&gt;xx_init_module--&gt;xx_register_driver。在这里xxx_register_driver中是驱动注册到XX总线上 International Standardization Operation 2. 驱动程序注册 什么是驱动模块的注册？上面讲到的初始化函数中调用的pci_register_driver()函数就是注册驱动程序啦。在介绍注册函数之前，必须要详细说明下linux的总线设备驱动模型，否则下面的内容很难描述清楚。 2.1 linux总线设备驱动模型 关于总线设备驱动模型，很多书上都有详细的讲解，但是都很抽象，很难理解(至少我是这样认为的)。下面我尽量用最简单的方法来说明相关内容。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/dc5a489089e596794f760c0a29bac339/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-05-16T19:28:52+08:00" />
<meta property="article:modified_time" content="2018-05-16T19:28:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">linux设备驱动程序注册过程详解(一)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p> 原文地址：http://blog.csdn.net/tuzhutuzhu/article/details/34445847</p> 
<p></p> 
<div style="font-size:16px;"> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">Linux的驱动程序注册过程，大致分为两个步骤：</span></span></p> 
 <ul style="padding:0px;margin:0px 0px .75em 25px;list-style-type:none;font-size:16px;"><li style="list-style-type:disc;font-size:16px;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">模块初始化</span></span></li><li style="list-style-type:disc;font-size:16px;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">驱动程序注册</span></span></li></ul> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">下面以内核提供的示例代码pci-skeleton.c，详细说明一个pci设备驱动程序的注册过程。其他设备的驱动代码注册过程基本相同，大家可自行查看。使用的内核代码版本是2.6.38。</span></span></p> 
 <h3 style="margin:0px 0px .5em;font-family:inherit;font-weight:bold;color:inherit;font-size:18px;text-indent:1em;">1. 模块初始化</h3> 
 <h4 style="margin:0px 0px .5em;font-family:inherit;font-weight:bold;color:inherit;font-size:18px;text-indent:1em;">1.1 驱动程序入口</h4> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">所有的设备驱动程序都会有如下两行代码：</span></span></p> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <div> 
   <span style="color:rgb(136,0,0);">1922</span> module_init( 
   <span style="color:rgb(51,51,51);font-weight:700;">netdrv_init_module</span>) 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">1923</span> module_exit( 
   <span style="color:rgb(51,51,51);font-weight:700;">netdrv_cleanup_module</span>) 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
 </div> 
 <div style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"> 
  <div> 
   <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">module_init/module_exit是两个宏。module_init是该驱动程序的入口，加载驱动模块时，驱动程序就从netdrv_init_module函数开始执行。而当该驱动程序对应的设备被删除了，则会执行netdrv_cleanup_module这个函数。<strong><span style="color:rgb(255,0,0);">---至于何时驱动模块加载，何时驱动模块卸载，有待后续追踪follow up</span></strong></span></span> 
  </div> 
 </div> 
</div> 
<div style="font-size:16px;"> 
 <h4 style="margin:0px 0px .5em;font-family:inherit;font-weight:bold;color:inherit;font-size:18px;text-indent:1em;">1.2 模块初始化</h4> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">当驱动程序开始执行时，首先会执行该驱动程序的初始化函数netdrv_init_module，代码如下：</span></span></p> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">1906</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">static</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">int</span> __init  
  <span style="color:rgb(136,0,0);"><strong>netdrv_init_module</strong></span>( 
  <span style="color:rgb(51,51,51);font-weight:700;">void</span>) 
  <br>1907 { 
  <div> 
   <span style="color:rgb(136,0,0);">1908</span>  
   <span style="color:rgb(136,136,136);">/* when a module, this is printed whether or not devices are found in probe */</span> 
   <span style="color:rgb(136,0,0);">1909</span>  
   <span style="color:rgb(31,113,153);">#<span style="color:rgb(51,51,51);font-weight:700;">ifdef</span> MODULE</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">1910</span>     printk(version); 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">1911</span>  
   <span style="color:rgb(31,113,153);">#<span style="color:rgb(51,51,51);font-weight:700;">endif</span></span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">1912</span>      
   <span style="color:rgb(51,51,51);font-weight:700;">return</span>  
   <span style="color:rgb(255,0,0);"><strong>pci_register_driver</strong></span>(&amp;netdrv_pci_driver); 
  </div> 
  <span style="color:rgb(136,0,0);">1913</span> } 
 </div> 
</div> 
<div> 
 <span style="font-size:16px;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">可以看到，模块初始化函数很简单，只执行了一个pci_register_driver函数就返回了。</span></span></span> 
</div> 
<div> 
 <div style="margin:0px 0px .75em;text-indent:1em;"> 
  <div> 
   <span style="font-size:16px;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">其实模块的初始化过程就是这么简单，这也是linux驱动程序的ISO标准流程：module_init--&gt;xx_init_module--&gt;xx_register_driver。在这里xxx_register_driver中是驱动注册到XX总线上</span></span></span> 
  </div> 
  <div> 
   <br> 
  </div> 
  <div> 
   <span style="color:rgb(67,67,67);font-family:Tahoma, Arial, '宋体', 'Malgun Gothic';font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:left;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;background-color:rgb(242,242,242);float:none;">International Standardization Operation</span> 
  </div> 
 </div> 
 <div style="margin:0px 0px .5em;font-family:inherit;font-weight:bold;color:inherit;font-size:18px;text-indent:1em;"> 
  <div>
    2. 驱动程序注册 
  </div> 
 </div> 
 <div style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"> 
  <div> 
   <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">什么是驱动模块的注册？上面讲到的初始化函数中调用的<strong><span style="color:rgb(255,0,0);">pci_register_driver()函数就是注册驱动程序</span></strong>啦。在介绍注册函数之前，必须要详细说明下linux的总线设备驱动模型，否则下面的内容很难描述清楚。</span></span> 
  </div> 
 </div> 
 <h4 style="margin:0px 0px .5em;font-family:inherit;font-weight:bold;color:inherit;font-size:18px;text-indent:1em;">2.1 linux总线设备驱动模型</h4> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">关于总线设备驱动模型，很多书上都有详细的讲解，但是都很抽象，很难理解(至少我是这样认为的)。下面我尽量用最简单的方法来说明相关内容。</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">linux内核中分别用<strong><span style="color:rgb(255,0,0);">struct bus_type，struct device和struct device_driver来描述总线、设备和驱动。</span></strong></span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">总线：</span></span></p> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">50</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(255,122,116);">bus_type </span>{ 
  <br>  
  <span style="color:rgb(136,0,0);">51</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">const</span> char      *name; 
  <br>  
  <span style="color:rgb(136,0,0);">52</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> bus_attribute    *bus_attrs; 
  <br>  
  <span style="color:rgb(136,0,0);">53</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(241,79,154);"><strong>device</strong></span>_attribute *dev_attrs; 
  <br>  
  <span style="color:rgb(136,0,0);">54</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(241,79,154);"><strong>driver</strong></span>_attribute *drv_attrs; 
  <br>  
  <span style="color:rgb(136,0,0);">55</span> 
  <div>
      
   <span style="color:rgb(136,0,0);">56     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">int</span> (*match)( 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <strong><span style="color:rgb(241,79,154);">device</span></strong> *dev, 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <strong><span style="color:rgb(255,122,116);">device_driver</span></strong> *drv); 
  </div> 
  <div>
    }; 
  </div> 
 </div> 
 <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">设备：</span></span> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">406</span> 
  <span style="color:rgb(68,68,68);"> </span> 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
  <span style="color:rgb(68,68,68);"> <span style="color:rgb(255,122,116);">device </span>{<!-- --><br></span> 
  <span style="color:rgb(136,0,0);">407</span> 
  <span style="color:rgb(68,68,68);">     </span> 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
  <span style="color:rgb(68,68,68);"> device       *parent;</span> 
  <div> 
   <span style="color:rgb(136,0,0);">408</span> 
   <span style="color:rgb(68,68,68);">   </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:rgb(68,68,68);"> device_private   *p;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">410</span> 
   <span style="color:rgb(68,68,68);">   </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:rgb(68,68,68);"> kobject kobj;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">412</span> 
   <span style="color:rgb(68,68,68);">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">const</span> 
   <span style="color:rgb(68,68,68);"> char      *init_name; </span> 
   <span style="color:rgb(136,136,136);">/* initial name of the device */</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">413</span> 
   <span style="color:rgb(68,68,68);">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:rgb(68,68,68);"> device_type  *</span> 
   <span style="color:rgb(51,51,51);font-weight:700;">type</span> 
   <span style="color:rgb(68,68,68);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">414</span> 
   <span style="color:rgb(68,68,68);">   </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:rgb(68,68,68);"> mutex        mutex; </span> 
   <span style="color:rgb(136,136,136);">/* mutex to synchronize calls to</span> 
   <span style="color:rgb(136,136,136);">*/</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">419</span> 
   <span style="color:rgb(68,68,68);">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:rgb(68,68,68);"> <span style="color:rgb(229,0,255);"><strong><span style="color:rgb(255,122,116);">bus_type</span> </strong></span>*bus;       </span> 
   <span style="color:rgb(136,136,136);">/* type of bus device is on */</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">420</span> 
   <span style="color:rgb(51,51,51);"><strong>     </strong><span style="color:rgb(51,51,51);font-weight:700;">struct</span></span> 
   <span style="color:rgb(68,68,68);"><strong><span style="color:rgb(255,122,116);">device_driver</span></strong> *driver;</span> 
   <span style="color:rgb(136,136,136);">/* which driver has allocated this 421 device */</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">456</span> 
   <span style="color:rgb(136,0,0);">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">void</span> 
   <span style="color:rgb(68,68,68);">(*</span> 
   <span style="color:rgb(51,51,51);font-weight:700;">release</span> 
   <span style="color:rgb(68,68,68);">)(</span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:rgb(68,68,68);">device *dev);</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">458</span> 
   <span style="color:rgb(68,68,68);">};</span> 
  </div> 
 </div> 
 <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">驱动：</span></span> 
</div> 
<div> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">122</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <strong><span style="color:rgb(255,122,116);">device_driver </span></strong>{ 
  <div> 
   <span style="color:rgb(136,0,0);">123</span>      
   <span style="color:rgb(51,51,51);font-weight:700;">const</span>  
   <span style="color:rgb(51,51,51);font-weight:700;">char</span>      *name; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">124     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <strong><span style="color:rgb(255,122,116);">bus_type</span></strong> *bus; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">125     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> module *owner; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">127     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">const </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">char</span> *mod_name; 
   <span style="color:rgb(136,136,136);">/* used for built-in modules */</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">128     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">bool</span> suppress_bind_attrs; 
   <span style="color:rgb(136,136,136);">/* disables bind/unbind via sysfs */</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">130     </span> 
   <span style="color:rgb(31,113,153);">#<span style="color:rgb(51,51,51);font-weight:700;">if</span> defined(CONFIG_OF)</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">132     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">const </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> of_device_id *of_match_table; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">133</span> 
   <span style="color:rgb(31,113,153);">#<span style="color:rgb(51,51,51);font-weight:700;">endif</span></span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">135     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">int</span> (* 
   <strong>probe</strong>) ( 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> device *dev);&lt;/span&gt;&lt;/strong&gt; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">136     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">int</span> (* 
   <span style="color:rgb(51,51,51);font-weight:700;">remove</span>) ( 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> device *dev); }; 
  </div> 
 </div> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">上述三个结构体中，我将下文需要使用的成员进行了标识，后面会讨论到。</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">对比上面的三个结构体，你会发现：<strong><span style="color:rgb(241,79,154);">总线中既定义了设备，也定义了驱动；设备中既有总线，也有驱动；</span><span style="color:rgb(255,122,116);">驱动中既有总线也有设备相关的信息。</span></strong>那这三个的关系到底是什么呢？</span></span></p> 
 <div style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"> 
  <div> 
   <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">三者的关系是：</span></span> 
  </div> 
 </div> 
 <div style="margin:0px 0px .75em;text-indent:1em;"> 
  <div> 
   <span style="color:rgb(51,51,51);"><span style="font-size:16px;"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">内核要求每次出现一个设备，就要向总线汇报，会着说注册；每次出现一个驱动，也要向总线汇报，或者叫注册。比如系统初始化时，会扫描连接了哪些设备，并为每一个<strong><span style="color:rgb(255,122,116);">设备建立一个struct device变量</span></strong>，并为每一个驱动程序准备一个struct <strong><span style="color:rgb(255,122,116);">device_driver结构的变量</span></strong>。把这些量变量加入相应的链表，<strong><span style="color:rgb(255,0,0);">形成一条设备链表和一条驱动链表</span></strong></span></span></span> 
   <span style="color:rgb(51,51,51);"><span style="font-size:16px;"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">。这样，就能通过总线找到注册挂载在该总线上的每一个设备和每一个驱动程序。</span></span></span> 
  </div> 
 </div> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">当一个struct device诞生，总线就会去driver链表找设备对应的驱动程序。如果找到就执行设备的驱动程序，否则就等待。反之亦然。</span></span></p> 
</div> 
<div style="font-size:16px;"> 
 <div style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"> 
  <div> 
   <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">还有一个需要注意的地方：</span></span> 
  </div> 
 </div> 
</div> 
<div style="font-size:16px;"> 
 <div style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"> 
  <div> 
   <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">usb_type<strong><span style="color:rgb(255,0,0);">总线</span></strong>结构体的match函数，它的两个参数一个是<span style="color:rgb(255,122,116);"><strong>驱动struct device_driver*</strong></span>，另一个则是<span style="color:rgb(255,122,116);"><strong>设备struct device *</strong></span>。这个函数就是用来进行判断，总线上的驱动程序能不能处理设备的。至于这个函数什么时候调用，怎么调用，后面会有说。</span></span> 
  </div> 
 </div> 
 <h4 style="margin:0px 0px .5em;font-family:inherit;font-weight:bold;color:inherit;font-size:18px;text-indent:1em;">2.2 注册函数详解</h4> 
</div> 
<div style="font-size:16px;"> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">下面我们来详细解释驱动的注册函数。</span></span></p> 
 <h5 style="margin:0px 0px .5em;font-family:inherit;font-weight:bold;color:inherit;font-size:16px;text-indent:1em;">2.2.1 驱动的描述</h5> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">首先从register函数的函数原型看起：</span></span></p> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">896</span>  
  <span style="color:rgb(31,113,153);">#<span style="color:rgb(51,51,51);font-weight:700;">define</span> pci_register_driver(driver)     \<br>897     __pci_register_driver(driver, THIS_MODULE, KBUILD_MODNAME)</span> 
  <br> 
  <br> 
  <span style="color:rgb(136,0,0);">1103</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">int</span>  
  <strong><span style="color:rgb(241,79,154);">__pci_register_driver</span></strong>( 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(255,122,116);"><strong>pci_driver </strong></span>*drv,  
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">module</span> *owner, 
  <br> 
  <span style="color:rgb(136,0,0);">1104</span>                
  <span style="color:rgb(51,51,51);font-weight:700;">const</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">char</span> *mod_name) 
  <br> 
 </div> 
</div> 
<div> 
 <span style="font-size:16px;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">真正的注册函数是__pci_register_driver()，它的第一个参数是struct pci_driver类型的，再看看这个结构的定义：</span></span></span> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">542</span> 
  <span style="color:#444444;"> </span> 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
  <span style="color:#444444;"> pci_driver {<!-- --><br> </span> 
  <span style="color:rgb(136,0,0);">543</span> 
  <span style="color:#444444;">     </span> 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
  <span style="color:#444444;"> list_head node;</span> 
  <div> 
   <span style="color:rgb(68,68,68);"> </span> 
   <span style="color:rgb(136,0,0);">544</span> 
   <span style="color:#444444;">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">const</span> 
   <span style="color:#444444;"> char *name;</span> 
  </div> 
  <div> 
   <span style="color:rgb(68,68,68);"> </span> 
   <span style="color:rgb(136,0,0);">545</span> 
   <span style="color:#444444;">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">const</span> 
   <span style="color:#444444;"> </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:#444444;"> pci_device_id *id_table;   </span> 
   <span style="color:rgb(136,136,136);">/* must be non-NULL for probe to be called */</span> 
  </div> 
  <div> 
   <span style="color:#444444;"> </span> 
   <span style="color:rgb(136,0,0);">546</span> 
   <span style="color:#444444;">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">int</span> 
   <span style="color:#444444;">  (*probe)  (</span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:#444444;"> pci_dev *dev, </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">const</span> 
   <span style="color:#444444;"> </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:#444444;"> pci_device_id *id);   </span> 
   <span style="color:rgb(136,136,136);">/* New device inserted */</span> 
  </div> 
  <div> 
   <span style="color:#444444;"> </span> 
   <span style="color:rgb(136,0,0);">547</span> 
   <span style="color:#444444;">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">void</span> 
   <span style="color:#444444;"> (*remove) (</span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:#444444;"> pci_dev *dev);   </span> 
   <span style="color:rgb(136,136,136);">/* Device removed (NULL if not a hot-plug capable driver) */</span> 
  </div> 
  <div> 
   <span style="color:#444444;"> </span> 
   <span style="color:rgb(136,0,0);">548</span> 
   <span style="color:#444444;">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">int</span> 
   <span style="color:#444444;">  (*suspend) (</span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:#444444;"> pci_dev *dev, pm_message_t state); </span> 
   <span style="color:rgb(136,136,136);">/* Device suspended */</span> 
  </div> 
  <span style="color:rgb(136,136,136);"> 549     int  (*suspend_late) (struct pci_dev *dev, pm_message_t state);</span> 
  <div> 
   <span style="color:rgb(136,136,136);"> 550     int  (*resume_early) (struct pci_dev *dev);</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,136,136);"> 551     int  (*resume) (struct pci_dev *dev);     /* Device woken up */</span> 
  </div> 
  <span style="color:#444444;"> </span> 
  <span style="color:rgb(136,0,0);">552</span> 
  <span style="color:#444444;">     </span> 
  <span style="color:rgb(51,51,51);font-weight:700;">void</span> 
  <span style="color:#444444;"> (*shutdown) (</span> 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
  <span style="color:#444444;"> pci_dev *dev);</span> 
  <div> 
   <span style="color:rgb(68,68,68);"> </span> 
   <span style="color:rgb(136,0,0);">553</span> 
   <span style="color:#444444;">     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
   <span style="color:#444444;"> pci_error_handlers *err_handler;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);"> 554</span> 
   <span style="color:#444444;">  <span style="color:rgb(255,70,53);"> </span></span> 
   <span style="color:rgb(255,70,53);">struct device_driver    driver;</span> 
  </div> 
  <span style="color:#444444;"> </span> 
  <span style="color:rgb(136,0,0);">555</span> 
  <span style="color:#444444;">     </span> 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> 
  <span style="color:#444444;"> pci_dynids dynids;<br> </span> 
  <span style="color:rgb(136,0,0);">556</span> 
  <span style="color:#444444;"> };<br></span> 
 </div> 
 <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">仔细看这个结构，发现其中一个成员是我们上面的总线设备模型中的driver的结构体。 其实在linux内核中，<strong><span style="color:rgb(255,70,53);">所有设备的驱动的定义，都是以struct device_driver为基类，进行继承与扩展的</span></strong>。 你没有看错，内核当中使用了很多OO面向对象的思想。再看看网卡I2C设备的的驱动描述：</span></span> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">143</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> i2c_driver { 
  <br> 
  <span style="color:rgb(136,0,0);">144</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">unsigned</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">int</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">class</span>; 
  <div> 
   <span style="color:rgb(136,0,0);">145</span>    
   <strong><span style="color:rgb(255,70,53);"> struct device_driver driver;</span></strong> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">175     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">const </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> i2c_device_id *id_table; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">176     </span> 
   <span style="color:rgb(136,136,136);">/* Device detection callback for automatic device creation */</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">178     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">int</span> (*detect)( 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> i2c_client *, 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> i2c_board_info *); 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">179     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">const </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">unsigned</span> short *address_list; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">180     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">struct</span> list_head clients; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">181</span> }; 
  </div> 
 </div> 
 <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">现在我们知道了pci设备的驱动程序的描述方法。但是问题又来了：这么复杂的一个结构体，我们怎么用呢？</span></span> 
</div> 
<div style="font-size:16px;"> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">首先看下实例代码中是怎么玩的：</span></span></p> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">1894</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">static</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> pci_driver netdrv_pci_driver = { 
  <br> 
  <span style="color:rgb(136,0,0);">1895</span>     .name       = MODNAME, 
  <br> 
  <span style="color:rgb(136,0,0);">1896</span>     .id_table   =  
  <strong><span style="color:rgb(26,173,224);">netdrv_pci_tbl</span></strong>, 
  <br> 
  <span style="color:rgb(136,0,0);">1897</span>     . 
  <strong>probe     </strong> = netdrv_init_one, 
  <br> 
  <span style="color:rgb(136,0,0);">1898</span>     . 
  <span style="color:rgb(51,51,51);font-weight:700;">remove</span>     = __devexit_p(netdrv_remove_one), 
  <br> 
  <span style="color:rgb(136,0,0);">1899</span>  
  <span style="color:rgb(31,113,153);">#ifdef CONFIG_PM</span> 
  <span style="color:rgb(136,0,0);">1900</span>     .suspend    = netdrv_suspend, 
  <br> 
  <span style="color:rgb(136,0,0);">1901</span>     .resume     = netdrv_resume, 
  <div> 
   <span style="color:rgb(136,0,0);">1902</span>  
   <span style="color:rgb(31,113,153);">#<span style="color:rgb(51,51,51);font-weight:700;">endif</span> /* CONFIG_PM */</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">1903</span> }; 
  </div> 
 </div> 
 <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">我们可以看出来，<strong><span style="color:rgb(255,70,53);">并不是这个结构体的所有成员我们都要操作，我们只管其中最关键的几个就行了。</span></strong></span></span> 
</div> 
<div style="font-size:16px;"> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">那上面的几个分别什么作用呢？</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">name：驱动模块的名字，这个可以忽略。</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">id_table：这个id的表很重要， <span style="text-indent:0px;"><strong>它的作用是<span style="color:rgb(250,122,0);">匹配驱动所支持的设备</span>。</strong></span> 同样看看代码中的用法：</span></span></p> 
 <div style="font-size:16px;"> 
  <pre style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;white-space:pre;background-color:rgb(246,246,246);border:none;"><span style="color:rgb(136,0,0);">221</span> static DEFINE_PCI_DEVICE_TABLE(<strong><span style="color:rgb(26,173,224);">netdrv_pci_tbl</span></strong>) = {
 <span style="color:rgb(136,0,0);">222</span>     {<!-- --><span style="color:rgb(136,0,0);">0x10ec</span>, <span style="color:rgb(136,0,0);">0x8139</span>, PCI_ANY_ID, PCI_ANY_ID, <span style="color:rgb(136,0,0);">0</span>, <span style="color:rgb(136,0,0);">0</span>, RTL8139 },
 <span style="color:rgb(136,0,0);">223</span>     {<!-- --><span style="color:rgb(136,0,0);">0x10ec</span>, <span style="color:rgb(136,0,0);">0x8138</span>, PCI_ANY_ID, PCI_ANY_ID, <span style="color:rgb(136,0,0);">0</span>, <span style="color:rgb(136,0,0);">0</span>, NETDRV_CB },
 <span style="color:rgb(136,0,0);">224</span>     {<!-- --><span style="color:rgb(136,0,0);">0x1113</span>, <span style="color:rgb(136,0,0);">0x1211</span>, PCI_ANY_ID, PCI_ANY_ID, <span style="color:rgb(136,0,0);">0</span>, <span style="color:rgb(136,0,0);">0</span>, SMC1211TX },
 <span style="color:rgb(136,0,0);">225</span> /*  {<!-- --><span style="color:rgb(136,0,0);">0x1113</span>, <span style="color:rgb(136,0,0);">0x1211</span>, PCI_ANY_ID, PCI_ANY_ID, <span style="color:rgb(136,0,0);">0</span>, <span style="color:rgb(136,0,0);">0</span>, MPX503<span style="color:rgb(136,0,0);">0</span> },*/
 <span style="color:rgb(136,0,0);">226</span>     {<!-- --><span style="color:rgb(136,0,0);">0x1500</span>, <span style="color:rgb(136,0,0);">0x1360</span>, PCI_ANY_ID, PCI_ANY_ID, <span style="color:rgb(136,0,0);">0</span>, <span style="color:rgb(136,0,0);">0</span>, DELTA8139 },
 <span style="color:rgb(136,0,0);">227</span>     {<!-- --><span style="color:rgb(136,0,0);">0x4033</span>, <span style="color:rgb(136,0,0);">0x1360</span>, PCI_ANY_ID, PCI_ANY_ID, <span style="color:rgb(136,0,0);">0</span>, <span style="color:rgb(136,0,0);">0</span>, ADDTRON8139 },
 <span style="color:rgb(136,0,0);">228</span>     {<!-- --><span style="color:rgb(136,0,0);">0</span>,}
 <span style="color:rgb(136,0,0);">229</span> };
 <span style="color:rgb(136,0,0);">230</span> MODULE_DEVICE_TABLE(pci, netdrv_pci_tbl);
</pre> 
  <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">这里表示的就是本驱动程序支持的设备类型。</span></span> 
 </div> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">probe：这个函数指针同样很重要。 <span style="text-indent:0px;"><strong>当驱动匹配到了对应的设备之后，就会调用该函数来驱动设备。</strong></span> 所以可以说这个函数才是驱动程序真正的入口。</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">remove：当驱动程序对应的设备被删除之后，使用这个函数来删除驱动程序。</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">综合看来，上面的id_table和probe函数好像是最重要的，那我们就看看它们是怎么使用的。</span></span></p> 
 <h5 style="margin:0px 0px .5em;font-family:inherit;font-weight:bold;color:inherit;font-size:16px;text-indent:1em;">2.2.2 驱动-设备的匹配</h5> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">上面在说明probe函数的时候说到：当驱动 匹配 到了对应的设备之后，就会调用该函数来驱动设备。这个匹配是什么意思？如何进行匹配？跟bus结构体中的match函数有没有关系？</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">带着这几个问题，我们来看看register函数。这里我将只说明<strong><span style="color:rgb(255,70,53);">驱动-设备匹配</span></strong>相关的内容，过程中看到的其他内容不在讨论范围内。我们将调用过程加粗和标红。</span></span></p> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">1103</span>  
  <span style="color:rgb(57,115,0);">int</span> __pci_register_driver( 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> pci_driver *drv,  
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">module</span> *owner, 
  <br> 
  <span style="color:rgb(136,0,0);">1104</span>               const  
  <span style="color:rgb(57,115,0);">char</span> *mod_name) 
  <br> 
  <span style="color:rgb(136,0,0);">1105</span> { 
  <br> 
  <span style="color:rgb(136,0,0);">1106</span>      
  <span style="color:rgb(57,115,0);">int</span> error; 
  <div> 
   <span style="color:rgb(136,0,0);">1107</span>     /* initialize common driver fields */ 
  </div> 
  <span style="color:rgb(136,0,0);">1109</span>     drv-&gt;driver.name = drv-&gt;name; 
  <br> 
  <span style="color:rgb(136,0,0);">1110</span>     drv-&gt;driver.bus = &amp;pci_bus_type; 
  <br> 
  <span style="color:rgb(136,0,0);">1111</span>     drv-&gt;driver.owner = owner; 
  <div> 
   <span style="color:rgb(136,0,0);">1112</span>     drv-&gt;driver.mod_name = mod_name; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">1113</span>     spin_lock_init(&amp;drv-&gt;dynids.lock); 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">1115</span>      
   <span style="color:rgb(136,0,0);">INIT_LIST_HEAD</span>(&amp;drv-&gt;dynids. 
   <span style="color:rgb(57,115,0);">list</span>); 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">1116</span>     /* register  
   <span style="color:rgb(51,51,51);font-weight:700;">with</span> core */ 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">1118</span>     error =  
   <strong><span style="color:rgb(255,0,0);">driver_register(&amp;drv-&gt;driver);</span></strong> 
  </div> 
  <span style="color:rgb(136,0,0);">1119</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">if</span> (error) 
  <br> 
  <span style="color:rgb(136,0,0);">1120</span>         goto out; 
  <br> 
  <span style="color:rgb(136,0,0);">1121</span> 
  <br>         。。。。。。。。 
  <br> 
  <span style="color:rgb(136,0,0);">1137</span> } 
  <br> 
 </div> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">__pci_register_driver函数中，调用<span style="color:rgb(255,0,0);"><strong>driver_register，在总线上注册驱动。</strong></span></span></span></p> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">222</span> int  
  <strong><span style="color:rgb(229,0,255);">driver_register</span></strong>( 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> device_driver *drv) 
  <br>223 { 
  <div>
    224     int ret; 
  </div> 
  <div>
    225     struct device_driver *other 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">227</span>     BUG_ON(!drv-&gt;bus-&gt;p) 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">229</span>     if (( 
   <span style="color:rgb(51,51,51);font-weight:700;">drv-&gt;bus-&gt;probe</span>  
   <span style="color:rgb(188,96,96);">&amp;&amp;</span> drv-&gt;probe) || 
  </div> 
  <span style="color:rgb(136,0,0);">230</span>         ( 
  <span style="color:rgb(51,51,51);font-weight:700;">drv-&gt;bus-&gt;remove</span>  
  <span style="color:rgb(188,96,96);">&amp;&amp;</span> drv-&gt;remove) || 
  <br> 
  <span style="color:rgb(136,0,0);">231</span>         ( 
  <span style="color:rgb(51,51,51);font-weight:700;">drv-&gt;bus-&gt;shutdown</span>  
  <span style="color:rgb(188,96,96);">&amp;&amp;</span> drv-&gt;shutdown)) 
  <div> 
   <span style="color:rgb(136,0,0);">232</span>         printk( 
   <span style="color:rgb(51,51,51);font-weight:700;">KERN_WARNING</span>  
   <span style="color:rgb(136,0,0);">"Driver '%s' needs updating - please use "</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">233</span>              
   <span style="color:rgb(136,0,0);">"bus_type methods\n"</span>, drv-&gt;name) 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">235</span>     other = driver_find( 
   <span style="color:rgb(51,51,51);font-weight:700;">drv-&gt;name</span>, drv-&gt;bus) 
   <span style="color:rgb(136,136,136);">;//根据driver_name 在bus链表上面查找到驱动driver(驱动链表&amp; 设备链表)</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">236</span>     if ( 
   <span style="color:rgb(51,51,51);font-weight:700;">other</span>) {//驱动已经被注册了 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">237</span>         put_driver( 
   <span style="color:rgb(51,51,51);font-weight:700;">other</span>) 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">238</span>         printk( 
   <span style="color:rgb(51,51,51);font-weight:700;">KERN_ERR</span>  
   <span style="color:rgb(136,0,0);">"Error: Driver '%s' is already registered, "</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">239</span>              
   <span style="color:rgb(136,0,0);">"aborting...\n"</span>, drv-&gt;name) 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">240</span>         return -EBUSY 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">241</span>     } 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">242</span>     
   <strong><span style="color:rgb(255,0,0);">ret = bus_add_driver(drv)</span></strong> 
   <span style="color:rgb(136,136,136);"><strong><span style="color:rgb(255,0,0);">;//总线上添加传递的驱动(将驱动添加到驱动链表中去)</span></strong></span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">244</span>     if ( 
   <span style="color:rgb(51,51,51);font-weight:700;">ret</span>) 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">245</span>         return ret 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">246</span>     ret = driver_add_groups( 
   <span style="color:rgb(51,51,51);font-weight:700;">drv</span>, drv-&gt;groups) 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">247</span>     if ( 
   <span style="color:rgb(51,51,51);font-weight:700;">ret</span>) 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">248</span>         bus_remove_driver( 
   <span style="color:rgb(51,51,51);font-weight:700;">drv</span>) 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">249</span>     return ret 
   <span style="color:rgb(136,136,136);">;</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">250</span> } 
  </div> 
 </div> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">driver_register中调用bus_add_driver，将设备驱动添加到总线上。</span></span></p> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">625</span> int  
  <strong><span style="color:rgb(255,0,0);">bus_add_driver</span></strong>(struct device_driver *drv) 
  <br>  
  <span style="color:rgb(136,0,0);">626</span> { 
  <br>  。。。。。。。。。。。。。 
  <br>  
  <span style="color:rgb(136,0,0);">642</span>     klist_init(&amp;priv-&gt;klist_devices,  
  <span style="color:rgb(51,51,51);font-weight:700;">NULL</span>,  
  <span style="color:rgb(51,51,51);font-weight:700;">NULL</span>); 
  <br>  
  <span style="color:rgb(136,0,0);">643</span>     priv-&gt;driver = drv; 
  <br>  
  <span style="color:rgb(136,0,0);">644</span>     drv-&gt;p = priv; 
  <br>  
  <span style="color:rgb(136,0,0);">645</span>     priv-&gt;kobj.kset = bus-&gt;p-&gt;drivers_kset; 
  <br>  
  <span style="color:rgb(136,0,0);">646</span>     error = kobject_init_and_add(&amp;priv-&gt;kobj, &amp;driver_ktype,  
  <span style="color:rgb(51,51,51);font-weight:700;">NULL</span>, 
  <br>  
  <span style="color:rgb(136,0,0);">647</span>                      
  <span style="color:rgb(136,0,0);">"%s"</span>, drv-&gt;name); 
  <br>  
  <span style="color:rgb(136,0,0);">648</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">if</span> (error) 
  <br>  
  <span style="color:rgb(136,0,0);">649</span>          
  <span style="color:rgb(51,51,51);font-weight:700;">goto</span> out_unregister; 
  <br>  
  <span style="color:rgb(136,0,0);">650</span> 
  <br>  
  <span style="color:rgb(136,0,0);">651</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">if</span> (drv-&gt;bus-&gt;p-&gt;drivers_autoprobe) { 
  <div>
      
   <span style="color:rgb(136,0,0);">652</span>         
   <strong><span style="color:rgb(255,70,53);">error = driver_attach(drv)</span></strong>; 
  </div> 
  <div>
      
   <span style="color:rgb(136,0,0);">653</span> 
   <span style="color:rgb(51,51,51);font-weight:700;">if</span> (error) 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">654     </span> 
   <span style="color:rgb(51,51,51);font-weight:700;">goto</span> out_unregister 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">655</span> } 。。。。。。。。。。。。。。。 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">690</span> } 
  </div> 
 </div> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">303</span> int  
  <strong><span style="color:rgb(255,0,0);">driver_attach</span></strong>(struct device_driver *drv) 
  <br> 
  <span style="color:rgb(136,0,0);">304</span> { 
  <div> 
   <span style="color:rgb(136,0,0);">305</span>      
   <span style="color:rgb(51,51,51);font-weight:700;">return </span> 
   <span style="color:rgb(255,0,0);"><strong>bus_for_each_dev</strong></span>(drv-&gt;bus, NULL, drv, __driver_attach); 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">306</span> } 
  </div> 
 </div> 
 <div style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"> 
  <div> 
   <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">可以看出来，上面将驱动程序追加到总线上之后，现在开始将设备与驱动进行匹配了。</span></span> 
  </div> 
 </div> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">285</span> int  
  <strong><span style="color:rgb(255,70,53);">bus_for_each_dev</span></strong>(struct bus_type *bus, struct device *start, 
  <br>  
  <span style="color:rgb(136,0,0);">286</span>              void * 
  <span style="color:rgb(51,51,51);font-weight:700;">data</span>, int (* 
  <span style="color:rgb(136,0,0);"><strong>fn</strong></span>)( 
  <span style="color:rgb(136,0,0);"><strong>struct</strong></span>  
  <span style="color:rgb(136,0,0);"><strong>device</strong></span> *,  
  <span style="color:rgb(136,0,0);"><strong>void</strong></span> *)) 
  <br>  
  <span style="color:rgb(136,0,0);">287</span> { 
  <br>  。。。。。。。。。。。。 
  <br>  
  <span style="color:rgb(136,0,0);">295</span>     klist_iter_init_node(&amp;bus-&gt;p-&gt;klist_devices, &amp;i, 
  <br>  
  <span style="color:rgb(136,0,0);">296</span>                  (start ? &amp;start-&gt;p-&gt;knode_bus :  
  <span style="color:rgb(136,0,0);">NULL</span>)); 
  <div>
      
   <span style="color:rgb(136,0,0);">297</span>     while ((dev = next_device(&amp;i)) &amp;&amp; !error) 
  </div> 
  <div>
      
   <span style="color:rgb(136,0,0);">298</span>         
   <strong><span style="color:rgb(255,70,53);">error = fn(dev, data);</span></strong> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">299</span>          klist_iter_exit(&amp;i); 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">300</span>          return error; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">301</span> } 
  </div> 
 </div> 
 <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">这里的<strong><span style="color:rgb(255,70,53);">fn就是__driver_attach函数</span></strong>，我们来看一下它干了什么：</span></span> 
</div> 
<div style="font-size:16px;"> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">265</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">static</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">int</span>  
  <strong><span style="color:rgb(255,70,53);">__driver_attach</span></strong>( 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> device *dev,  
  <span style="color:rgb(51,51,51);font-weight:700;">void</span> *data) 
  <br> 
  <span style="color:rgb(136,0,0);">266</span> { 
  <br> 
  <span style="color:rgb(136,0,0);">267</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span> device_driver *drv = data; 
  <div>
    。。。。。。。。。。。。。。。 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">279</span>     
   <span style="color:rgb(227,0,0);"><strong>if (!driver_match_device(drv, dev))//在驱动driver注册到总线时调用match函数</strong></span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">280</span>          
   <span style="color:rgb(51,51,51);font-weight:700;">return</span>  
   <span style="color:rgb(136,0,0);">0</span>; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">281</span>     
   <span style="color:rgb(51,51,51);font-weight:700;">if</span> (dev-&gt;parent)    
   <span style="color:rgb(136,136,136);">/* Needed for USB */</span> 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">283</span>     device_lock(dev-&gt;parent); 
  </div> 
  <span style="color:rgb(136,0,0);">284</span>     device_lock(dev); 
  <div> 
   <span style="color:rgb(136,0,0);">285</span>      
   <span style="color:rgb(51,51,51);font-weight:700;">if</span> (!dev-&gt;driver) 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">286</span> 
   <strong><span style="color:rgb(255,0,0);">        driver_probe_device(drv, dev);//当驱动注册到总线并match成功后，调用驱动probe()函数</span></strong> 
  </div> 
  <span style="color:rgb(136,0,0);">287</span>     device_unlock(dev); 
  <br> 
  <span style="color:rgb(136,0,0);">288</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">if</span> (dev-&gt;parent) 
  <div> 
   <span style="color:rgb(136,0,0);">289</span>         device_unlock(dev-&gt;parent); 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">290</span>     
   <span style="color:rgb(51,51,51);font-weight:700;">return</span>  
   <span style="color:rgb(136,0,0);">0</span>; 
  </div> 
  <span style="color:rgb(136,0,0);">292</span> } 
  <br> 
 </div> 
</div> 
<div style="font-size:16px;"> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">279行的<strong><span style="color:rgb(255,70,53);">driver_match_device函数就是用来为driver匹配device的。match函数和probe函数被调用的地方</span></strong></span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;"><strong><span style="color:rgb(255,70,53);"><span style="color:rgb(68,68,68);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:14px;background-color:rgb(246,246,246);"> </span><span style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:14px;background-color:rgb(246,246,246);color:rgb(227,0,0);"><strong>if (!driver_match_device(drv, dev))//在驱动driver注册到总线时调用match函数。</strong></span><br></span></strong></span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;"><span style="font-weight:bold;"><span style="color:rgb(255,70,53);"><span style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:14px;background-color:rgb(246,246,246);color:rgb(227,0,0);"><strong><span style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:14px;background-color:rgb(246,246,246);color:rgb(136,0,0);">286</span><span style="color:rgb(68,68,68);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:14px;background-color:rgb(246,246,246);"> </span><span style="color:rgb(68,68,68);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:14px;background-color:rgb(246,246,246);"><strong><span style="color:rgb(255,0,0);">        driver_probe_device(drv, dev);//当驱动注册到总线并match成功后，调用驱动probe()函数</span></strong></span><br></strong></span></span></span></span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;"><strong><span style="color:rgb(255,70,53);"><br></span></strong></span></span></p> 
 <pre style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;white-space:pre;background-color:rgb(246,246,246);border:none;"><span style="color:rgb(136,0,0);">108</span> <span style="color:rgb(51,51,51);font-weight:700;">static</span> inline <span style="color:rgb(51,51,51);font-weight:700;">int</span> driver_match_device(<span style="color:rgb(51,51,51);font-weight:700;">struct</span> <span style="color:rgb(136,0,0);"><strong>device_driver</strong></span> *drv,
<span style="color:rgb(136,0,0);">109</span>                       <span style="color:rgb(51,51,51);font-weight:700;">struct</span> <span style="color:rgb(136,0,0);"><strong>device</strong></span> *dev)
<span style="color:rgb(136,0,0);">110</span> {
<span style="color:rgb(136,0,0);">111</span>     <span style="color:rgb(51,51,51);font-weight:700;">return</span> drv-&gt;bus-&gt;<span style="color:rgb(51,51,51);font-weight:700;">match</span> ? drv-&gt;bus-&gt;<span style="color:rgb(51,51,51);font-weight:700;">match</span>(dev, drv) : <span style="color:rgb(136,0,0);">1</span>;
<span style="color:rgb(136,0,0);">112</span> }
</pre> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">这里开始调用<strong><span style="color:rgb(255,70,53);">device_driver</span></strong>中注册BUS总线上的match函数来进行匹配了，匹配的具体过程就不看了。再回到上面的__driver_attach函数的driver_probe_device中。</span></span></p> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">200</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">int</span>  
  <strong><span style="color:rgb(255,0,0);">driver_probe_device</span></strong>( 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(136,0,0);"><strong>device_driver</strong></span> *drv,  
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(136,0,0);"><strong>device</strong></span> *dev) 
  <br> 
  <span style="color:rgb(136,0,0);">201</span> { 
  <div> 
   <span style="color:rgb(136,0,0);">202</span>      
   <span style="color:rgb(51,51,51);font-weight:700;">int</span> ret =  
   <span style="color:rgb(136,0,0);">0</span>; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">203</span>     
   <span style="color:rgb(51,51,51);font-weight:700;">if</span> (!device_is_registered(dev)) 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">205</span>          
   <span style="color:rgb(51,51,51);font-weight:700;">return</span> -ENODEV; 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">206</span>     pr_debug( 
   <span style="color:rgb(136,0,0);">"bus: '%s': %s: matched device %s with driver %s\n"</span>, 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">208</span>          drv-&gt;bus-&gt;name, __func__, dev_name(dev), drv-&gt;name); 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">209</span>     pm_runtime_get_noresume(dev); 
  </div> 
  <span style="color:rgb(136,0,0);">211</span>     pm_runtime_barrier(dev); 
  <br> 
  <span style="color:rgb(136,0,0);">212</span>     ret =  
  <strong><span style="color:rgb(255,0,0);">really_probe</span></strong>(dev, drv); 
  <div> 
   <span style="color:rgb(136,0,0);">213</span>     pm_runtime_put_sync(dev); 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">214</span>     
   <span style="color:rgb(51,51,51);font-weight:700;">return</span> ret; 
  </div> 
  <span style="color:rgb(136,0,0);">216</span> } 
  <br> 
 </div> 
 <div style="padding:.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:rgb(68,68,68);margin:0px 0px 1.5em;font-size:14px;background-color:rgb(246,246,246);border:none;"> 
  <span style="color:rgb(136,0,0);">108</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">static</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">int</span>  
  <span style="color:rgb(255,70,53);"><strong>really_probe</strong></span>( 
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(136,0,0);"><strong>device</strong></span> *dev,  
  <span style="color:rgb(51,51,51);font-weight:700;">struct</span>  
  <span style="color:rgb(136,0,0);"><strong>device_driver</strong></span> *drv) 
  <br> 
  <span style="color:rgb(136,0,0);">109</span> { 
  <br> 
  <span style="color:rgb(136,0,0);">110</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">int</span> ret =  
  <span style="color:rgb(136,0,0);">0</span>; 
  <br> 
  <span style="color:rgb(136,0,0);">111</span> 
  <span style="color:rgb(136,0,0);">112</span>     atomic_inc(&amp;probe_count); 
  <br> 
  <span style="color:rgb(136,0,0);">113</span>     pr_debug( 
  <span style="color:rgb(136,0,0);">"bus: '%s': %s: probing driver %s with device %s\n"</span>, 
  <br> 
  <span style="color:rgb(136,0,0);">114</span>          drv-&gt;bus-&gt;name, __func__, drv-&gt;name, dev_name(dev)); 
  <br> 
  <span style="color:rgb(136,0,0);">115</span>     WARN_ON(!list_empty(&amp;dev-&gt;devres_head)); 
  <br> 
  <span style="color:rgb(136,0,0);">116</span> 
  <span style="color:rgb(136,0,0);">117</span>     dev-&gt;driver = drv; 
  <br> 
  <span style="color:rgb(136,0,0);">118</span>      
  <span style="color:rgb(51,51,51);font-weight:700;">if</span> (driver_sysfs_add(dev)) { 
  <br> 
  <span style="color:rgb(136,0,0);">119</span>         printk(KERN_ERR  
  <span style="color:rgb(136,0,0);">"%s: driver_sysfs_add(%s) failed\n"</span>, 
  <br> 
  <span style="color:rgb(136,0,0);">120</span>             __func__, dev_name(dev)); 
  <br> 
  <span style="color:rgb(136,0,0);">121</span>         goto probe_failed; 
  <div> 
   <span style="color:rgb(136,0,0);">122</span>     } 
  </div> 
  <div> 
   <span style="color:rgb(136,0,0);">123</span>     
   <span style="color:rgb(51,51,51);font-weight:700;">if</span> (dev-&gt;bus-&gt;probe) { 
  </div> 
  <span style="color:rgb(136,0,0);">125</span>         ret =  
  <strong><span style="color:rgb(255,70,53);">dev-&gt;bus-&gt;probe(dev);</span></strong> 
  <br> 
  <span style="color:rgb(136,0,0);">126</span>          
  <span style="color:rgb(51,51,51);font-weight:700;">if</span> (ret) 
  <br> 
  <span style="color:rgb(136,0,0);">127</span>             goto probe_failed; 
  <br> 
  <span style="color:rgb(136,0,0);">128</span>     }  
  <span style="color:rgb(51,51,51);font-weight:700;">else</span>  
  <span style="color:rgb(51,51,51);font-weight:700;">if</span> (drv-&gt;probe) { 
  <br> 
  <span style="color:rgb(136,0,0);">129</span>         ret =  
  <strong><span style="color:rgb(255,70,53);">drv-&gt;probe(dev);</span></strong> 
  <br> 
  <span style="color:rgb(136,0,0);">130</span>          
  <span style="color:rgb(51,51,51);font-weight:700;">if</span> (ret) 
  <br> 
  <span style="color:rgb(136,0,0);">131</span>             goto probe_failed; 
  <br> 
  <span style="color:rgb(136,0,0);">132</span>     } 
  <br> 
  <span style="color:rgb(136,0,0);">133</span> 
  <br>   。。。。。。。。。。。。。。 
  <br> 
  <span style="color:rgb(136,0,0);">160</span> } 
  <br> 
 </div> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">到这里，终于看到drv-&gt;probe函数了。驱动程序的probe函数开始执行了，驱动程序的注册工作也就大功告成了。</span></span></p> 
 <h3 style="margin:0px 0px .5em;font-family:inherit;font-weight:bold;color:inherit;font-size:18px;text-indent:1em;">3. 总结</h3> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">我们来总结一下设备驱动程序初始化的几个步骤：</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">1. 根据设备类型，构造所需描述驱动的结构体。该结构体需要继承struct device_driver结构，并给几个重要的成员初始化。</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">2. 通过module_init宏调用驱动程序的初始化函数xx_init_module，在初始化函数中注册驱动程序。</span></span></p> 
 <p style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"><strong><span style="color:rgb(255,70,53);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">3.驱动程序会遍历总线上的struct device和struct device_driver两条链表，调用总线的match函数，对设备与驱动程序进行匹配。</span></span></strong></p> 
 <div style="margin:0px 0px .75em;font-size:16px;text-indent:1em;"> 
  <div> 
   <span style="color:rgb(51,51,51);"><span style="font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', '微软雅黑', sans-serif;">4<strong><span style="color:rgb(255,70,53);">.如果设备与驱动程序匹配成功，则调用驱动程序的probe函数</span></strong>。probe函数的实现，需要根据驱动程序的功能来定，不属于本文的讨论范围。</span></span> 
  </div> 
 </div> 
</div> 
<br> 
<br>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bcbf09dc72fc30e4416127579225cf68/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">单链表实现两组整数相加(python)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fbe154c07d7a59a43e2e30d433e56e97/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SQLServer中各种存储过程创建及执行方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>