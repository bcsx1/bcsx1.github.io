<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Elasticsearch7.x——Search API详解 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Elasticsearch7.x——Search API详解" />
<meta property="og:description" content="目录 Search API1、URI模式2、Body模式2.1、Explain参数2.2、折叠结果（collapse）2.2.1、展开折叠结果2.2.2、二级折叠 2.3、对结果分页2.4、高亮结果2.4.1、unified高亮器2.4.2、plain高亮器2.4.3、fvh高亮器2.4.4、为字段设置高亮器2.4.5、highlight_query查询2.4.6、高亮器类型选择2.4.7、配置高亮器标签2.4.8、_source字段高亮显示2.4.9、高亮显示所有字段2.4.10、组合字段高亮显示2.4.11、高亮字段排序2.4.12、高亮片段控制2.4.13、Posting List的应用2.4.14、为Plain高亮器指定片段 2.5、索引加权2.6、命中文档嵌套2.6.1、嵌套的inner_hits2.6.2、嵌套内部名字和_source2.6.3、嵌套对象字段和内部命中的层次级别2.6.4、父子嵌套 2.7、分数值过滤2.8、查询命名2.9、post_filter过滤2.10、分片选择（preference）2.11、重排序2.12、脚本字段2.13、滚动查询2.13.1、保持搜索上下文处于活跃状态2.13.2、清理搜索上下文2.13.3、切片 2.14、search_after参数2.15、搜索类型2.16、排序2.16.1、排序方式2.16.2、多值字段排序模式2.16.3、嵌套对象的排序2.16.4、缺失值的处理2.16.5、地理距离排序2.16.5.1、JSON经纬度格式2.16.5.2、逗号分隔格式2.16.5.3、pin码格式2.16.5.4、数组格式2.16.5.5、两点距离格式 2.16.6、自定义脚本排序 2.17、_source字段过滤2.18、存储字段2.19、total返回值详解（track_total_hits）2.20、版本控制（_version） 3、返回索引分片信息（_search_shards）4、Count API5、Validate API6、调试（_explain） Search API 搜索API(_search)允许用来执行搜索查询并返回匹配的结果。 可以使用简单查询字符串作为参数提供查询(URI形式)，也可以使 用请求正文(body形式)。大多数搜索API都是支持多索引的， Explain API除外(用于调试性能)。
//语法 GET /&lt;index&gt;/_search GET /_search POST /&lt;index&gt;/_search POST /_search 所有搜索API都支持跨索引机制，并支持多索引语法。例如，搜 索twitter索引中的所有文档:
GET /twitter/_search?q=user:kimchy 还可以在多个索引中搜索具有特定标记的所有文档，例如当每个 用户有一个索引时:
GET /kimchy,Elasticsearch/_search?q=tag:now 或者使用_all搜索所有可用索引:
GET /_all/_search?q=tag:now 为了确保快速响应，如果一个或多个分片失败，搜索API将以部 分结果响应。
1、URI模式 通过提供请求参数，可以纯粹使用URI执行搜索请求。在使用此 模式执行搜索时，并非所有搜索选项都可用，但对于快速的“测试” 来说，它非常方便。
GET twitter/_search?1=user:kimchy URI搜索模式支持的参数如下表：
2、Body模式 搜索请求可以在请求正文中使用Query DSL:
GET /twitter/_search { &#34;query&#34; : { &#34;term&#34; : { &#34;user&#34; : &#34;kimchy&#34; } } } Body搜索模式支持的参数如下表：
注 意 : search_type 、 request_cache 和 allow_partial_search_results必须作为查询字符串参数传递(不能放在body里面，要放在URL里面)。搜索请求的其余部分应该在主体内 部传递。正文内容也可以作为名为source的REST参数传递。HTTP GET 和HTTP POST都可以用于执行带Body的搜索。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/001d02521808bb3b75042f2928d956ad/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-16T23:20:25+08:00" />
<meta property="article:modified_time" content="2023-10-16T23:20:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Elasticsearch7.x——Search API详解</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#Search_API_2" rel="nofollow">Search API</a></li><li><ul><li><a href="#1URI_28" rel="nofollow">1、URI模式</a></li><li><a href="#2Body_39" rel="nofollow">2、Body模式</a></li><li><ul><li><a href="#21Explain_88" rel="nofollow">2.1、Explain参数</a></li><li><a href="#22collapse_204" rel="nofollow">2.2、折叠结果（collapse）</a></li><li><ul><li><a href="#221_327" rel="nofollow">2.2.1、展开折叠结果</a></li><li><a href="#222_496" rel="nofollow">2.2.2、二级折叠</a></li></ul> 
    </li><li><a href="#23_589" rel="nofollow">2.3、对结果分页</a></li><li><a href="#24_607" rel="nofollow">2.4、高亮结果</a></li><li><ul><li><a href="#241unified_683" rel="nofollow">2.4.1、unified高亮器</a></li><li><a href="#242plain_686" rel="nofollow">2.4.2、plain高亮器</a></li><li><a href="#243fvh_692" rel="nofollow">2.4.3、fvh高亮器</a></li><li><a href="#244_701" rel="nofollow">2.4.4、为字段设置高亮器</a></li><li><a href="#245highlight_query_722" rel="nofollow">2.4.5、highlight_query查询</a></li><li><a href="#246_783" rel="nofollow">2.4.6、高亮器类型选择</a></li><li><a href="#247_800" rel="nofollow">2.4.7、配置高亮器标签</a></li><li><a href="#248_source_851" rel="nofollow">2.4.8、_source字段高亮显示</a></li><li><a href="#249_867" rel="nofollow">2.4.9、高亮显示所有字段</a></li><li><a href="#2410_884" rel="nofollow">2.4.10、组合字段高亮显示</a></li><li><a href="#2411_932" rel="nofollow">2.4.11、高亮字段排序</a></li><li><a href="#2412_947" rel="nofollow">2.4.12、高亮片段控制</a></li><li><a href="#2413Posting_List_1014" rel="nofollow">2.4.13、Posting List的应用</a></li><li><a href="#2414Plain_1046" rel="nofollow">2.4.14、为Plain高亮器指定片段</a></li></ul> 
    </li><li><a href="#25_1067" rel="nofollow">2.5、索引加权</a></li><li><a href="#26_1091" rel="nofollow">2.6、命中文档嵌套</a></li><li><ul><li><a href="#261inner_hits_1133" rel="nofollow">2.6.1、嵌套的inner_hits</a></li><li><a href="#262_source_1251" rel="nofollow">2.6.2、嵌套内部名字和_source</a></li><li><a href="#263_1369" rel="nofollow">2.6.3、嵌套对象字段和内部命中的层次级别</a></li><li><a href="#264_1507" rel="nofollow">2.6.4、父子嵌套</a></li></ul> 
    </li><li><a href="#27_1614" rel="nofollow">2.7、分数值过滤</a></li><li><a href="#28_1631" rel="nofollow">2.8、查询命名</a></li><li><a href="#29post_filter_1655" rel="nofollow">2.9、post_filter过滤</a></li><li><a href="#210preference_1749" rel="nofollow">2.10、分片选择（preference）</a></li><li><a href="#211_1762" rel="nofollow">2.11、重排序</a></li><li><a href="#212_1856" rel="nofollow">2.12、脚本字段</a></li><li><a href="#213_1903" rel="nofollow">2.13、滚动查询</a></li><li><ul><li><a href="#2131_1950" rel="nofollow">2.13.1、保持搜索上下文处于活跃状态</a></li><li><a href="#2132_1965" rel="nofollow">2.13.2、清理搜索上下文</a></li><li><a href="#2133_1994" rel="nofollow">2.13.3、切片</a></li></ul> 
    </li><li><a href="#214search_after_2042" rel="nofollow">2.14、search_after参数</a></li><li><a href="#215_2087" rel="nofollow">2.15、搜索类型</a></li><li><a href="#216_2105" rel="nofollow">2.16、排序</a></li><li><ul><li><a href="#2161_2144" rel="nofollow">2.16.1、排序方式</a></li><li><a href="#2162_2147" rel="nofollow">2.16.2、多值字段排序模式</a></li><li><a href="#2163_2177" rel="nofollow">2.16.3、嵌套对象的排序</a></li><li><a href="#2164_2250" rel="nofollow">2.16.4、缺失值的处理</a></li><li><a href="#2165_2278" rel="nofollow">2.16.5、地理距离排序</a></li><li><ul><li><a href="#21651JSON_2310" rel="nofollow">2.16.5.1、JSON经纬度格式</a></li><li><a href="#21652_2332" rel="nofollow">2.16.5.2、逗号分隔格式</a></li><li><a href="#21653pin_2351" rel="nofollow">2.16.5.3、pin码格式</a></li><li><a href="#21654_2370" rel="nofollow">2.16.5.4、数组格式</a></li><li><a href="#21655_2389" rel="nofollow">2.16.5.5、两点距离格式</a></li></ul> 
     </li><li><a href="#2166_2408" rel="nofollow">2.16.6、自定义脚本排序</a></li></ul> 
    </li><li><a href="#217_source_2432" rel="nofollow">2.17、_source字段过滤</a></li><li><a href="#218_2477" rel="nofollow">2.18、存储字段</a></li><li><a href="#219totaltrack_total_hits_2520" rel="nofollow">2.19、total返回值详解（track_total_hits）</a></li><li><a href="#220_version_2580" rel="nofollow">2.20、版本控制（_version）</a></li></ul> 
   </li><li><a href="#3_search_shards_2600" rel="nofollow">3、返回索引分片信息（_search_shards）</a></li><li><a href="#4Count_API_2673" rel="nofollow">4、Count API</a></li><li><a href="#5Validate_API_2698" rel="nofollow">5、Validate API</a></li><li><a href="#6_explain_2737" rel="nofollow">6、调试（_explain）</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Search_API_2"></a>Search API</h2> 
<p>搜索API(_search)允许用来执行搜索查询并返回匹配的结果。 可以使用简单查询字符串作为参数提供查询(URI形式)，也可以使 用请求正文(body形式)。大多数搜索API都是支持多索引的， Explain API除外(用于调试性能)。</p> 
<pre><code class="prism language-json"><span class="token comment">//语法</span>
<span class="token constant">GET</span> <span class="token operator">/</span><span class="token operator">&lt;</span>index<span class="token operator">&gt;</span><span class="token operator">/</span>_search
<span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token constant">POST</span> <span class="token operator">/</span><span class="token operator">&lt;</span>index<span class="token operator">&gt;</span><span class="token operator">/</span>_search
<span class="token constant">POST</span> <span class="token operator">/</span>_search
</code></pre> 
<p>所有搜索API都支持跨索引机制，并支持多索引语法。例如，搜 索twitter索引中的所有文档:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search<span class="token operator">?</span>q<span class="token operator">=</span>user<span class="token operator">:</span>kimchy
</code></pre> 
<p>还可以在多个索引中搜索具有特定标记的所有文档，例如当每个 用户有一个索引时:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>kimchy<span class="token punctuation">,</span>Elasticsearch<span class="token operator">/</span>_search<span class="token operator">?</span>q<span class="token operator">=</span>tag<span class="token operator">:</span>now
</code></pre> 
<p>或者使用_all搜索所有可用索引:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_all<span class="token operator">/</span>_search<span class="token operator">?</span>q<span class="token operator">=</span>tag<span class="token operator">:</span>now
</code></pre> 
<p>为了确保快速响应，如果一个或多个分片失败，搜索API将以部 分结果响应。</p> 
<h3><a id="1URI_28"></a>1、URI模式</h3> 
<p>通过提供请求参数，可以纯粹使用URI执行搜索请求。在使用此 模式执行搜索时，并非所有搜索选项都可用，但对于快速的“测试” 来说，它非常方便。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> twitter<span class="token operator">/</span>_search<span class="token operator">?</span><span class="token number">1</span><span class="token operator">=</span>user<span class="token operator">:</span>kimchy
</code></pre> 
<p>URI搜索模式支持的参数如下表：<br> <img src="https://images2.imgbox.com/2a/3a/T1xZNgip_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2Body_39"></a>2、Body模式</h3> 
<p>搜索请求可以在请求正文中使用Query DSL:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Body搜索模式支持的参数如下表：<br> <img src="https://images2.imgbox.com/1b/c5/JnFADHAM_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>注 意 : search_type 、 request_cache 和 allow_partial_search_results必须作为查询字符串参数传递(不能放在body里面，要放在URL里面)。搜索请求的其余部分应该在主体内 部传递。正文内容也可以作为名为source的REST参数传递。HTTP GET 和HTTP POST都可以用于执行带Body的搜索。</p> 
</blockquote> 
<p>terminate_after始终在post_filter之后应用，并在分片上收集到 足够的命中结果后停止查询和聚合。聚合上的文档计数可能不会反映 响应中的hits.total，因为聚合是在post_filter之前应用的。</p> 
<p>如果只需要知道是否有任何文档匹配特定的查询，可以将size设 置为0，以表示对搜索结果不感兴趣。此外，还可以将 terminate_after设置为1，以指示只要找到第一个匹配的文档(每个 分片)，就可以终止查询执行。示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search<span class="token operator">?</span>q<span class="token operator">=</span>message<span class="token operator">:</span>number<span class="token operator">&amp;</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>terminate_after<span class="token operator">=</span><span class="token number">1</span>
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"took"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token string-property property">"timed_out"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">"terminated_early"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"_shards"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"successful"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"failed"</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string-property property">"relation"</span><span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_score"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，响应结果中不包含任何文档，因为size设置为0。 hits.total将等于0，表示没有匹配的文档，或者大于0，表示在提前 终止查询时，至少有多个文档匹配此查询。此外，如果查询提前终 止，则在响应中将terminated_early标志设置为true。</p> 
<p>响应中所用的时间took是处理此请求所用的毫秒数，从节点收到 查询后快速开始，直到完成所有与搜索相关的工作，然后再将上述 JSON返回到客户机。这意味着它包括在线程池中等待、在整个集群 中执行分布式搜索以及收集所有结果所花费的时间。</p> 
<h4><a id="21Explain_88"></a>2.1、Explain参数</h4> 
<p>Explain参数是Elasticsearch提供的辅助API，经常不为人所知 和所用。Explain参数用来帮助分析文档的相关性分数是如何计算出 来的。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"explain"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"hello"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"took"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">0.2876821</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_shard"</span> <span class="token operator">:</span> <span class="token string">"[test][0]"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_node"</span> <span class="token operator">:</span> <span class="token string">"Cc6ARDA6TY-poOdtxvsA6g"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">0.2876821</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"text"</span> <span class="token operator">:</span> <span class="token string">"hello world"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"flag"</span> <span class="token operator">:</span> <span class="token string">"foo"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_explanation"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">0.2876821</span><span class="token punctuation">,</span>
          <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"weight(text:hello in 0) [PerFieldSimilarity], result of:"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">0.2876821</span><span class="token punctuation">,</span>
              <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"score(freq=1.0), computed as boost * idf * tf from:"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">2.2</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"boost"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">0.2876821</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{<!-- --></span>
                      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"n, number of documents containing term"</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{<!-- --></span>
                      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"N, total number of documents with field"</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">0.45454544</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{<!-- --></span>
                      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"freq, occurrences of term within document"</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{<!-- --></span>
                      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1.2</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"k1, term saturation parameter"</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{<!-- --></span>
                      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">0.75</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"b, length normalization parameter"</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{<!-- --></span>
                      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"dl, length of field"</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{<!-- --></span>
                      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"description"</span> <span class="token operator">:</span> <span class="token string">"avgdl, average length of field"</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"details"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果形式上比较复杂，里面最重要的内容就是对文档计算得到的 总分以及总分的计算过程。如果总分等于0，则该文档将不能匹配给 定的查询。另一个重要内容是关于不同打分项的描述信息，根据查询 类型的不同，打分项会以不同方式对最后得分产生影响。</p> 
<h4><a id="22collapse_204"></a>2.2、折叠结果（collapse）</h4> 
<p>允许基于字段值折叠(collapse)搜索结果。折叠是通过每个折 叠键仅选择顶部排序的文档来完成的。其实就是按照某个字段分组， 每个分组只取一条结果。例如，下面的查询示例为每个用户检索最好 的tweet，并按喜欢的次数(likes字段)对其进行排序。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"collapse"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span> <span class="token operator">:</span> <span class="token string">"user"</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"likes"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token string-property property">"from"</span><span class="token operator">:</span> <span class="token number">10</span> 
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>注意:响应中的命中total指示匹配文档的数量，是非折叠的结 果。非重复组(折叠后的数量)的总数是未知的。</p> 
</blockquote> 
<blockquote> 
 <p>用于折叠的字段必须是单值keyword或数字numeric字段，而且 doc_values属性开启。</p> 
</blockquote> 
<p>示例：根据age字段折叠结果集，按balance倒序排序</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>bank<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"address"</span><span class="token operator">:</span> <span class="token string">"street"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"collapse"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"age"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"balance"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"from"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"took"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">385</span><span class="token punctuation">,</span>
      <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"bank"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"854"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"account_number"</span> <span class="token operator">:</span> <span class="token number">854</span><span class="token punctuation">,</span>
          <span class="token string-property property">"balance"</span> <span class="token operator">:</span> <span class="token number">49795</span><span class="token punctuation">,</span>
          <span class="token string-property property">"firstname"</span> <span class="token operator">:</span> <span class="token string">"Jimenez"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"lastname"</span> <span class="token operator">:</span> <span class="token string">"Barry"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
          <span class="token string-property property">"gender"</span> <span class="token operator">:</span> <span class="token string">"F"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"address"</span> <span class="token operator">:</span> <span class="token string">"603 Cooper Street"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"employer"</span> <span class="token operator">:</span> <span class="token string">"Verton"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"email"</span> <span class="token operator">:</span> <span class="token string">"jimenezbarry@verton.com"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"city"</span> <span class="token operator">:</span> <span class="token string">"Moscow"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"state"</span> <span class="token operator">:</span> <span class="token string">"AL"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token number">25</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token number">49795</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"bank"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"926"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"account_number"</span> <span class="token operator">:</span> <span class="token number">926</span><span class="token punctuation">,</span>
          <span class="token string-property property">"balance"</span> <span class="token operator">:</span> <span class="token number">49433</span><span class="token punctuation">,</span>
          <span class="token string-property property">"firstname"</span> <span class="token operator">:</span> <span class="token string">"Welch"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"lastname"</span> <span class="token operator">:</span> <span class="token string">"Mcgowan"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
          <span class="token string-property property">"gender"</span> <span class="token operator">:</span> <span class="token string">"M"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"address"</span> <span class="token operator">:</span> <span class="token string">"833 Quincy Street"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"employer"</span> <span class="token operator">:</span> <span class="token string">"Atomica"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"email"</span> <span class="token operator">:</span> <span class="token string">"welchmcgowan@atomica.com"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"city"</span> <span class="token operator">:</span> <span class="token string">"Hampstead"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"state"</span> <span class="token operator">:</span> <span class="token string">"VT"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token number">21</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token number">49433</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="221_327"></a>2.2.1、展开折叠结果</h5> 
<p>可以使用inner_hits选项展开每个折叠的顶部结果：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>bank<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"address"</span><span class="token operator">:</span> <span class="token string">"street"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"collapse"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"age"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"inner_hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span><span class="token string">"inner_list"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"size"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string-property property">"sort"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"balance"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"order"</span><span class="token operator">:</span><span class="token string">"desc"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_concurrent_group_searches"</span><span class="token operator">:</span> <span class="token number">4</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"balance"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"from"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>name：响应中每个组内部展开结果使用的名称</li><li>size：每个折叠键要检索的结果数，也就是每组返回多少个结 果。</li><li>sort：如何对每组中的文档进行排序。</li><li>max_concurrent_group_searches：允许每个组检索内部结果的并发请求数。</li></ul> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"took"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string-property property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">385</span><span class="token punctuation">,</span>
      <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"bank"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"854"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"account_number"</span> <span class="token operator">:</span> <span class="token number">854</span><span class="token punctuation">,</span>
          <span class="token string-property property">"balance"</span> <span class="token operator">:</span> <span class="token number">49795</span><span class="token punctuation">,</span>
          <span class="token string-property property">"firstname"</span> <span class="token operator">:</span> <span class="token string">"Jimenez"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"lastname"</span> <span class="token operator">:</span> <span class="token string">"Barry"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
          <span class="token string-property property">"gender"</span> <span class="token operator">:</span> <span class="token string">"F"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"address"</span> <span class="token operator">:</span> <span class="token string">"603 Cooper Street"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"employer"</span> <span class="token operator">:</span> <span class="token string">"Verton"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"email"</span> <span class="token operator">:</span> <span class="token string">"jimenezbarry@verton.com"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"city"</span> <span class="token operator">:</span> <span class="token string">"Moscow"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"state"</span> <span class="token operator">:</span> <span class="token string">"AL"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token number">25</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token number">49795</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"inner_hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"inner_list"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
                <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
              <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"bank"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"854"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"account_number"</span> <span class="token operator">:</span> <span class="token number">854</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"balance"</span> <span class="token operator">:</span> <span class="token number">49795</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"firstname"</span> <span class="token operator">:</span> <span class="token string">"Jimenez"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"lastname"</span> <span class="token operator">:</span> <span class="token string">"Barry"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"gender"</span> <span class="token operator">:</span> <span class="token string">"F"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"address"</span> <span class="token operator">:</span> <span class="token string">"603 Cooper Street"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"employer"</span> <span class="token operator">:</span> <span class="token string">"Verton"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"email"</span> <span class="token operator">:</span> <span class="token string">"jimenezbarry@verton.com"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"city"</span> <span class="token operator">:</span> <span class="token string">"Moscow"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"state"</span> <span class="token operator">:</span> <span class="token string">"AL"</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token number">49795</span>
                  <span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"bank"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"835"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"account_number"</span> <span class="token operator">:</span> <span class="token number">835</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"balance"</span> <span class="token operator">:</span> <span class="token number">46558</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"firstname"</span> <span class="token operator">:</span> <span class="token string">"Glover"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"lastname"</span> <span class="token operator">:</span> <span class="token string">"Rutledge"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"gender"</span> <span class="token operator">:</span> <span class="token string">"F"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"address"</span> <span class="token operator">:</span> <span class="token string">"641 Royce Street"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"employer"</span> <span class="token operator">:</span> <span class="token string">"Ginkogene"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"email"</span> <span class="token operator">:</span> <span class="token string">"gloverrutledge@ginkogene.com"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"city"</span> <span class="token operator">:</span> <span class="token string">"Dixonville"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"state"</span> <span class="token operator">:</span> <span class="token string">"VA"</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token number">46558</span>
                  <span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>还可以为每个折叠组定义不同的展开请求参数。当希望获得折叠 的多个表示形式时，这很有用。示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"collapse"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span> <span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> 
        <span class="token string-property property">"inner_hits"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"most_liked"</span><span class="token punctuation">,</span>  
                <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"likes"</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"most_recent"</span><span class="token punctuation">,</span> 
                <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> <span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token string">"asc"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"likes"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="222_496"></a>2.2.2、二级折叠</h5> 
<p>二级折叠也是支持的，并可应用于inner_hits。例如，下面的请 求为每个国家(country字段)查找得分最高的tweet，在每个国家内 为每个用户查找得分最高的tweet。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"collapse"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span> <span class="token operator">:</span> <span class="token string">"country"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"inner_hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"by_location"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"collapse"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"field"</span> <span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
    <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"_index"</span><span class="token operator">:</span> <span class="token string">"twitter"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token string">"9"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"_score"</span><span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
            <span class="token string-property property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"country"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"UK"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"inner_hits"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"by_location"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                       <span class="token operator">...</span><span class="token punctuation">,</span>
                       <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                          <span class="token punctuation">{<!-- --></span>
                            <span class="token operator">...</span>
                            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"user124"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
                          <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          <span class="token punctuation">{<!-- --></span>
                            <span class="token operator">...</span>
                            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"user589"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
                          <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          <span class="token punctuation">{<!-- --></span>
                            <span class="token operator">...</span>
                             <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"user001"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
                          <span class="token punctuation">}</span>
                       <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                 <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"_index"</span><span class="token operator">:</span> <span class="token string">"twitter"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"_type"</span><span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"_score"</span><span class="token operator">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
            <span class="token string-property property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"country"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Canada"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"inner_hits"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"by_location"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                       <span class="token operator">...</span><span class="token punctuation">,</span>
                       <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                          <span class="token punctuation">{<!-- --></span>
                            <span class="token operator">...</span>
                            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"user444"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
                          <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          <span class="token punctuation">{<!-- --></span>
                            <span class="token operator">...</span>
                            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"user1111"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
                          <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          <span class="token punctuation">{<!-- --></span>
                            <span class="token operator">...</span>
                             <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"user999"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
                          <span class="token punctuation">}</span>
                       <span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                 <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>第二级折叠不允许再展开。</p> 
</blockquote> 
<h4><a id="23_589"></a>2.3、对结果分页</h4> 
<p>可以使用from和size参数对结果进行分页。from参数定义要获取 的第一个结果的偏移量，size参数表示要返回的最大结果的数量。</p> 
<p>尽管可以将from和size设置为请求参数，但它们也可以在body中 设置。from默认值为0，size默认值为10，示例如下。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
	<span class="token string-property property">"from"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token string-property property">"size"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span>
	<span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"term"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span><span class="token operator">:</span><span class="token string">"kimchy"</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>注意:from+size不能超过index.max_result_window参数设置的 值，后者的默认值为10000。增大此参数，会导致系统开销线性增大。</p> 
</blockquote> 
<h4><a id="24_607"></a>2.4、高亮结果</h4> 
<p>高亮器(Highlighter)用来标识出搜索结果中的一个或多个字段 中需要突出显示的代码段，以便向用户显示查询匹配的位置。</p> 
<p>当请求中包括高亮的参数设置时，响应结果包含每个搜索命中的 高亮元素，其中包括突出显示的字段和突出显示的片段。</p> 
<p>高亮器在提取要突出显示的项时不反映查询的布尔逻辑。因此， 对于某些复杂的布尔查询(例如嵌套布尔查询、 minimum_should_match等)，可能会突出显示与查询匹配不对应 的部分文档。</p> 
<p>高亮需要字段有实际内容(索引时将store设置为true)。如果未 存储字段(映射未将store设置为true)，则加载实际的_source，并 从_source提取相关字段。</p> 
<p>例如，使用默认高亮器对每条搜索结果中的content字段突出显 示，请在请求正文中包含一个highlight对象，该对象指定content字 段:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>bank<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"firstname"</span><span class="token operator">:</span> <span class="token string">"Jimenez"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"firstname"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"took"</span> <span class="token operator">:</span> <span class="token number">46</span><span class="token punctuation">,</span>
  <span class="token string-property property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">6.5052857</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"bank"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"854"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">6.5052857</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"account_number"</span> <span class="token operator">:</span> <span class="token number">854</span><span class="token punctuation">,</span>
          <span class="token string-property property">"balance"</span> <span class="token operator">:</span> <span class="token number">49795</span><span class="token punctuation">,</span>
          <span class="token string-property property">"firstname"</span> <span class="token operator">:</span> <span class="token string">"Jimenez"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"lastname"</span> <span class="token operator">:</span> <span class="token string">"Barry"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
          <span class="token string-property property">"gender"</span> <span class="token operator">:</span> <span class="token string">"F"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"address"</span> <span class="token operator">:</span> <span class="token string">"603 Cooper Street"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"employer"</span> <span class="token operator">:</span> <span class="token string">"Verton"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"email"</span> <span class="token operator">:</span> <span class="token string">"jimenezbarry@verton.com"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"city"</span> <span class="token operator">:</span> <span class="token string">"Moscow"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"state"</span> <span class="token operator">:</span> <span class="token string">"AL"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"firstname"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"&lt;em&gt;Jimenez&lt;/em&gt;"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Elasticsearch支持三种高亮器:unified(基于BM25算法的高 亮器)、plain(Lucene标准高亮器)和fvh(快速矢量高亮器)。实 际应用中，可以为每个字段指定不同的高亮。</p> 
<h5><a id="241unified_683"></a>2.4.1、unified高亮器</h5> 
<p>unified高亮器使用的是Lucene Unified Highlighter。这个高亮 器将文本分成句子，并使用BM25算法对单个句子进行评分，就如同 它们是语料库中的文档。这是默认的高亮器。</p> 
<h5><a id="242plain_686"></a>2.4.2、plain高亮器</h5> 
<p>plain高亮器使用标准Lucene高亮器。它试图从词的重要性和短 语查询中的任何词定位条件来反映查询匹配逻辑。</p> 
<p>plain高亮器最适合在单个字段中突出显示简单查询匹配项。为了 准确反映查询逻辑，它会创建一个很小的内存中的索引，并通过 Lucene的查询执行计划器重新运行原始查询条件，以访问当前文档的 低级匹配信息。对于需要突出显示的每个字段和每个文档，重复此操 作。如果想突出显示许多文档中的许多字段，进行较为复杂的查询， 作者建议在postings或term_vector字段上使用unified高亮器。</p> 
<h5><a id="243fvh_692"></a>2.4.3、fvh高亮器</h5> 
<p>fvh高亮器使用Lucene快速矢量高亮器。此高亮器可用于在映射 中将term_vector设置为<code>with_positions_offsets</code>的字段。此高亮器特 点如下:</p> 
<ul><li>可以通过boundary_scanner参数进行自定义设置。</li><li>需要设置term_vector为with_positions_offsets，以增加索 引的大小。</li><li>可以将多个字段中的匹配项组合为一个结果。</li><li>可以为不同位置的匹配分配不同的权重，将短语匹配排序在 Term匹配前面，主要应用于boost查询(对某个字段加 权)。</li></ul> 
<h5><a id="244_701"></a>2.4.4、为字段设置高亮器</h5> 
<p>如下示例中，对每个字段进行单独设置，覆盖全局高亮设置。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fragment_size"</span> <span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"body"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"pre_tags"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;em&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-property property">"post_tags"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;/em&gt;"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"blog.title"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"blog.author"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"blog.comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"score"</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="245highlight_query_722"></a>2.4.5、highlight_query查询</h5> 
<p>可以指定highlight_query查询(重评分查询)，以便在突出显 示时考虑其他信息。例如，下面的查询同时包含搜索查询和重新评分查询，如果用了highlight_query查询，突出显示将只考虑搜索查 询。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"foo bar"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"rescore"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"window_size"</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
        <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"rescore_query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"match_phrase"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"comment"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"foo bar"</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"slop"</span><span class="token operator">:</span> <span class="token number">1</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"rescore_query_weight"</span> <span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"_source"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"score"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"fragment_size"</span> <span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
                <span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string-property property">"highlight_query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"must"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token string-property property">"comment"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"foo bar"</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"should"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"match_phrase"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token string-property property">"comment"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"foo bar"</span><span class="token punctuation">,</span>
                                    <span class="token string-property property">"slop"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                                    <span class="token string-property property">"boost"</span><span class="token operator">:</span> <span class="token number">10.0</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"minimum_should_match"</span><span class="token operator">:</span> <span class="token number">0</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="246_783"></a>2.4.6、高亮器类型选择</h5> 
<p>类型字段type允许强制使用特定的高亮器类型。允许值为 unified、plain和fvh。以下是强制使用plain高亮器的示例:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"plain"</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="247_800"></a>2.4.7、配置高亮器标签</h5> 
<p>默认情况下，高亮显示的文本包裹在<code>&lt;em&gt;</code>和<code>&lt;/em&gt;</code>中。这可以 通过设置pre_tags标记和post_tags标记来控制，例如:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"pre_tags"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;tag1&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"post_tags"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;/tag1&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"body"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当使用快速矢量高亮器时，可以指定其他标签，并按重要性进行 排序，示例如下。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"pre_tags"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;tag1&gt;"</span><span class="token punctuation">,</span> <span class="token string">"&lt;tag2&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"post_tags"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;/tag1&gt;"</span><span class="token punctuation">,</span> <span class="token string">"&lt;/tag2&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"body"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>还可以使用内置样式的styled模式:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"tags_schema"</span> <span class="token operator">:</span> <span class="token string">"styled"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="248_source_851"></a>2.4.8、_source字段高亮显示</h5> 
<p>可以强制高亮显示_source中的字段，即使字段是单独存储的， 示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"force_source"</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="249_867"></a>2.4.9、高亮显示所有字段</h5> 
<p>默认情况下，只高亮显示包含查询匹配的字段。设置 require_field_match为false可以高亮显示所有字段，示例如下。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"require_field_match"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"body"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"pre_tags"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;em&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-property property">"post_tags"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;/em&gt;"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2410_884"></a>2.4.10、组合字段高亮显示</h5> 
<p>只有fvh高亮器支持这个特性。快速矢量高亮器可以把多个字段的 匹配结果组合成单个字段来高亮显示。对于以不同方式分析同一字符 串的多字段来说，这是最直观的。所有匹配的matched_fields字段都 必须将term_vector设置为with_positions_offsets，但只有匹配项组 合到的字段才会被加载，因此最好将该字段的store属性设置为 true(加速查询，无须加载_source)。</p> 
<p>在 下 面 的 示 例 中 ， comment 由 英 语 分 析 器 分 析 ， comment.plain由标准分析器分析。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"query_string"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"comment.plain:running scissors"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"comment"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"order"</span><span class="token operator">:</span> <span class="token string">"score"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"matched_fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"comment"</span><span class="token punctuation">,</span> <span class="token string">"comment.plain"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"fvh"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以上两种匹配查询既会匹配run with scissors，又会匹配 running with scissors。但只会高亮running和scissors，而不会高 亮run。如果这两个短语都出现在一个大文档中，那么running with scissors对应的文档将排在run with scissors对应的文档上方，因为 该片段中有更多的匹配项。用running scissors查询时，默认是OR 的关系，所以只要文档中出现其一就会匹配到，但只会高亮查询词 run和scissors，排序是同时命中两个词的文档会排在只命中一个词 的前面。示例如下。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"query_string"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"running scissors"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"comment"</span><span class="token punctuation">,</span> <span class="token string">"comment.plain^10"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"order"</span><span class="token operator">:</span> <span class="token string">"score"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"matched_fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"comment"</span><span class="token punctuation">,</span> <span class="token string">"comment.plain"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"fvh"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面高亮显示了run以及running和scissors，但仍然将 running with scissors匹配的文档排序在run with scissors匹配文 档的前面，因为plain匹配(running)被加权了。</p> 
<h5><a id="2411_932"></a>2.4.11、高亮字段排序</h5> 
<p>Elasticsearch按发送顺序显示高亮字段，但根据JSON规范，对 象是无序的。如果需要明确高亮字的显示顺序，请将高亮字段fields 指定为数组，用法如下。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2412_947"></a>2.4.12、高亮片段控制</h5> 
<p>高亮的每个字段可以控制高亮显示片段的大小(以字符为单位， 默认值为100)，以及要返回的最大片段数(默认值为5)，示例如 下。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"fragment_size"</span> <span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>除此之外，还可以指定高亮显示的片段按分数排序:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"score"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"fragment_size"</span> <span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果number_of_fragments值设置为0，则不会生成片段，而是 高亮返回字段的全部内容。如果需要高亮显示短文本(如文档标题或 地址)，但不需要片段，操作非常方便。注意，在这种情况下 fragment_size被忽略。示例如下。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"body"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"blog.title"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用fvh时，可以使用fragment_offset参数控制要从中开始高亮 显示的边距。如果没有匹配的片段要高亮显示，则默认情况下不返回 任何内容。相反，可以通过将no_match_size(默认值为0)设置为 要返回的文本的长度，从字段开头返回一段文本。实际长度可能比指 定的短或长，因为它试图在单词边界上中断(不会把一个词截断)。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"fragment_size"</span> <span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
                <span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string-property property">"no_match_size"</span><span class="token operator">:</span> <span class="token number">150</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2413Posting_List_1014"></a>2.4.13、Posting List的应用</h5> 
<p>Posting List就是一个整型数组，存储了所有符合某个Term的文 档ID。</p> 
<p>以下示例在索引映射中设置comment字段以允许使用Posting List高亮显示结果。</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>example
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"index_options"</span> <span class="token operator">:</span> <span class="token string">"offsets"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面是设置comment字段以允许使用term_vectors向量(这将 导致索引更大)的示例:</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>example
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"comment"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"term_vector"</span> <span class="token operator">:</span> <span class="token string">"with_positions_offsets"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2414Plain_1046"></a>2.4.14、为Plain高亮器指定片段</h5> 
<p>使用Plain高亮器时，可以在simple片段和span片段之间进行选 择:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match_phrase"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"number 1"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"plain"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"fragment_size"</span> <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
                <span class="token string-property property">"number_of_fragments"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                <span class="token string-property property">"fragmenter"</span><span class="token operator">:</span> <span class="token string">"simple"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="25_1067"></a>2.5、索引加权</h4> 
<p>在搜索多个索引时，可以为每个索引配置不同的权重。当来自一 个索引的命中文档比来自另一个索引的更重要时，这非常方便。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"indices_boost"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"index1"</span> <span class="token operator">:</span> <span class="token number">1.4</span><span class="token punctuation">,</span>
        <span class="token string-property property">"index2"</span> <span class="token operator">:</span> <span class="token number">1.3</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这在使用别名或通配符表达式时很重要。如果找到多个匹配项， 将使用第一个匹配项。例如，如果一个索引同时包含在alias1和 index*中，则将应用1.4的boost值。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"indices_boost"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"alias1"</span> <span class="token operator">:</span> <span class="token number">1.4</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"index*"</span> <span class="token operator">:</span> <span class="token number">1.3</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="26_1091"></a>2.6、命中文档嵌套</h4> 
<p>父联接(parent-join)和嵌套(nested)功能允许返回在不同 范围内具有匹配项的文档。在父/子案例中，父文档基于子文档中的匹配项返回，或者子文档基于父文档中的匹配项返回。在嵌套的情况 下，基于嵌套内部对象中的匹配项返回文档。</p> 
<p>在这两种情况下，导致返回文档的不同范围中的实际匹配都是隐 藏的。在许多情况下，了解哪些内部嵌套对象(对于嵌套对象)或子 /父文档(对于父/子文档)导致返回某些信息是非常必要的。此功 能在搜索响应中返回每次搜索命中的其他嵌套命中，这些嵌套命中导 致搜索命中在不同范围内匹配。</p> 
<p>使用方法是通过在nested、has_child或has_parent查询和筛选 上定义内部定义inner_hits。结构如下:</p> 
<pre><code class="prism language-json"><span class="token string-property property">"&lt;query&gt;"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"inner_hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">&lt;</span>inner_hits_options<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果在查询上定义了inner_hits，那么每个搜索命中都将包含一 个具有以下结构的inner_hits JSON对象:</p> 
<pre><code class="prism language-json"><span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
     <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_index"</span><span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span><span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
        <span class="token string-property property">"inner_hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
           <span class="token string-property property">"&lt;inner_hits_name&gt;"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token string-property property">"total"</span><span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
                 <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{<!-- --></span>
                       <span class="token string-property property">"_type"</span><span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
                       <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
                       <span class="token operator">...</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token operator">...</span>
                 <span class="token punctuation">]</span>
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token operator">...</span>
<span class="token punctuation">]</span>
</code></pre> 
<h5><a id="261inner_hits_1133"></a>2.6.1、嵌套的inner_hits</h5> 
<p>嵌套的inner_hits可用于将嵌套的内部对象包含为搜索命中的内 部命中。示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> test
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"comments"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"nested"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">PUT</span> test<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span><span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"Test title"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"comments"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"number"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token string">"nik9000"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"number"</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> test<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"comments"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"comments.number"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"inner_hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"took"</span> <span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token string-property property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"Test title"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"comments"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"number"</span> <span class="token operator">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"nik9000"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"number"</span> <span class="token operator">:</span> <span class="token number">2</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"inner_hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"comments"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
              <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_nested"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"field"</span> <span class="token operator">:</span> <span class="token string">"comments"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"offset"</span> <span class="token operator">:</span> <span class="token number">1</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"number"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"nik9000"</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的例子中，嵌套元数据_nested是至关重要的，因为它定 义了这个内部命中来自哪个内部嵌套对象。Field定义嵌套命中来自的 对象数组字段，以及相对于其在_source中位置的偏移量offset。由于 排序和评分，inner_hits中命中对象的实际位置通常与定义嵌套内部 对象的位置不同。</p> 
<p>默认情况下，也会为inner_hits中的命中对象返回_source，但 这可以更改。通过_source过滤功能可以返回部分字段。如果在嵌套 级别上定义了存储字段，也可以通过fields功能返回这些字段。</p> 
<p>一个重要的默认行为是，在返回结果中，inner_hits元素中的 hits元素的_source字段只包含定义为_nested类型的字段。因此在上 面的示例中，每次嵌套命中只返回注释部分，而不是包含注释的顶级 文档的整个源。</p> 
<h5><a id="262_source_1251"></a>2.6.2、嵌套内部名字和_source</h5> 
<p>嵌套文档没有_source字段，因为整个文档_source是与根文档一 起存储在其_source字段下。为了仅包含嵌套文档的源，将解析根文 档的源，并且只将嵌套文档的相关bit作为源包含在内部命中中。为每 个匹配的嵌套文档执行此操作会影响执行整个搜索请求所需的时间， 特别是当size和内部命中数的size设置高于默认值时，会付出相对昂 贵的代价。为了避免为获取嵌套内部命中的_source而解析整个根文 档的_source，可以禁用返回_source的功能(“source”:false)， 并且只依赖于doc values字段。示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> test
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"comments"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"nested"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">PUT</span> test<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span><span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"Test title"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"comments"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"comment text"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token string">"nik9000"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"words words words"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> test<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"comments"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"comments.text"</span> <span class="token operator">:</span> <span class="token string">"words"</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"inner_hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string-property property">"docvalue_fields"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"comments.text.keyword"</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"took"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string-property property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">1.0444684</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0444684</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"Test title"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"comments"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"text"</span> <span class="token operator">:</span> <span class="token string">"comment text"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"nik9000"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"text"</span> <span class="token operator">:</span> <span class="token string">"words words words"</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"inner_hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"comments"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">1.0444684</span><span class="token punctuation">,</span>
              <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_nested"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"field"</span> <span class="token operator">:</span> <span class="token string">"comments"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"offset"</span> <span class="token operator">:</span> <span class="token number">1</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0444684</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"comments.text.keyword"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                      <span class="token string">"words words words"</span>
                    <span class="token punctuation">]</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="263_1369"></a>2.6.3、嵌套对象字段和内部命中的层次级别</h5> 
<p>如果映射具有多层次嵌套对象字段，则可以通过点标记访问每个 级别。例如，如果有一个包含votes嵌套字段的comments嵌套字 段，并且votes应直接与根一起返回，则可以定义以下路径:</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> test
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"comments"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"nested"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"votes"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"nested"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">PUT</span> test<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span><span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"Test title"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"comments"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"comment text"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"votes"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token string">"nik9000"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"words words words"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"votes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token string-property property">"voter"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">"voter"</span><span class="token operator">:</span> <span class="token string">"other"</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> test<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"comments.votes"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"comments.votes.voter"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"inner_hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"took"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string-property property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">0.6931471</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">0.6931471</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"Test title"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"comments"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"text"</span> <span class="token operator">:</span> <span class="token string">"comment text"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"votes"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"nik9000"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"text"</span> <span class="token operator">:</span> <span class="token string">"words words words"</span><span class="token punctuation">,</span>
              <span class="token string-property property">"votes"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"voter"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"voter"</span> <span class="token operator">:</span> <span class="token string">"other"</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"inner_hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"comments.votes"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">0.6931471</span><span class="token punctuation">,</span>
              <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_nested"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"field"</span> <span class="token operator">:</span> <span class="token string">"comments"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"offset"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"_nested"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token string-property property">"field"</span> <span class="token operator">:</span> <span class="token string">"votes"</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"offset"</span> <span class="token operator">:</span> <span class="token number">0</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">0.6931471</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"voter"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="264_1507"></a>2.6.4、父子嵌套</h5> 
<p>父/子inner_hits可用于包括父或子对象，示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> test
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"my_join_field"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"join"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"relations"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"my_parent"</span><span class="token operator">:</span> <span class="token string">"my_child"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">PUT</span> test<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span><span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"number"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string-property property">"my_join_field"</span><span class="token operator">:</span> <span class="token string">"my_parent"</span>
<span class="token punctuation">}</span>

<span class="token constant">PUT</span> test<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">2</span><span class="token operator">?</span>routing<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>refresh
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"number"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token string-property property">"my_join_field"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"my_child"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"parent"</span><span class="token operator">:</span> <span class="token string">"1"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> test<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"has_child"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"my_child"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"number"</span><span class="token operator">:</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"inner_hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>    
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"took"</span> <span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
  <span class="token string-property property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string-property property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"number"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token string-property property">"my_join_field"</span> <span class="token operator">:</span> <span class="token string">"my_parent"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"inner_hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"my_child"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"value"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string-property property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token string-property property">"max_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
              <span class="token string-property property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_routing"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"number"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"my_join_field"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token string-property property">"name"</span> <span class="token operator">:</span> <span class="token string">"my_child"</span><span class="token punctuation">,</span>
                      <span class="token string-property property">"parent"</span> <span class="token operator">:</span> <span class="token string">"1"</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="27_1614"></a>2.7、分数值过滤</h4> 
<p>如下实例中，排除得分_score低于设定的min_score的文档:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"min_score"</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>注意:大多数情况下，这没有多大意义，但它是为高级用例提供 的。</p> 
</blockquote> 
<h4><a id="28_1631"></a>2.8、查询命名</h4> 
<p>可以为每个查询或过滤起个名字:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"bool"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"should"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span><span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"name.first"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token string">"shay"</span><span class="token punctuation">,</span> <span class="token string-property property">"_name"</span> <span class="token operator">:</span> <span class="token string">"first"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span><span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"name.last"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token string">"banon"</span><span class="token punctuation">,</span> <span class="token string-property property">"_name"</span> <span class="token operator">:</span> <span class="token string">"last"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string-property property">"filter"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"terms"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"name.last"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"banon"</span><span class="token punctuation">,</span> <span class="token string">"kimchy"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"_name"</span> <span class="token operator">:</span> <span class="token string">"test"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>搜索响应将包括matched_queries。查询和过滤器的命名只对 bool查询有意义。</p> 
</blockquote> 
<h4><a id="29post_filter_1655"></a>2.9、post_filter过滤</h4> 
<p>在计算聚合之后，post_filter用来对搜索结果进行二次过滤。其 目的通过如下示例来解释:</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>shirts
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"brand"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"color"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"model"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">PUT</span> <span class="token operator">/</span>shirts<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span><span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"brand"</span><span class="token operator">:</span> <span class="token string">"gucci"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"color"</span><span class="token operator">:</span> <span class="token string">"red"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"model"</span><span class="token operator">:</span> <span class="token string">"slim"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>假设用户指定了两个过滤器:color:red和brand:gucci。通常 情况下，也可以使用bool查询进行此操作:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>shirts<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"color"</span><span class="token operator">:</span> <span class="token string">"red"</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"brand"</span><span class="token operator">:</span> <span class="token string">"gucci"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>但是，用户可能还需要使用faceted切面导航来显示用户可以单击 的其他选项的列表。也许有一个model字段，允许用户将搜索结果限 制为t-shirts或dress-shirts。<br> <img src="https://images2.imgbox.com/b8/c7/Mr0Vd04A_o.png" alt="在这里插入图片描述"></p> 
<p>可以使用如下聚合查询，实现上述功能:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>shirts<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"color"</span><span class="token operator">:</span> <span class="token string">"red"</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"brand"</span><span class="token operator">:</span> <span class="token string">"gucci"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"models"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"model"</span> <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同时，用户可能需要知道有多少其他颜色的Gucci衬衫。如果只 是在颜色字段color上添加一个Term聚合，那么将只返回red对应的结 果，因为查询只返回Gucci的红色衬衫。</p> 
<p>相反，用户希望在聚合期间包含所有颜色的衬衫，然后只将 colors过滤器应用于搜索结果。这是post_filter过滤器的目的:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>shirts<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"brand"</span><span class="token operator">:</span> <span class="token string">"gucci"</span> <span class="token punctuation">}</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"colors"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"color"</span> <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"color_red"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"color"</span><span class="token operator">:</span> <span class="token string">"red"</span> <span class="token punctuation">}</span> 
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"models"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"model"</span> <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"post_filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
    <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"color"</span><span class="token operator">:</span> <span class="token string">"red"</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="210preference_1749"></a>2.10、分片选择（preference）</h4> 
<p>参数preference控制要对其执行搜索的分片的选择机制。默认情 况下，Elasticsearch以未指定的顺序从可用的分片中进行选择。但 是，有时可能需要尝试将某些搜索路由到特定的分片副本集，以更好 地利用每个副本的缓存。</p> 
<p>preference是一个查询字符串参数，可以设置为如下参数:</p> 
<ul><li><strong>_only_local</strong>：该操作将仅在接受请求的本地节点的分片上执 行。</li><li><strong>_local</strong>：优先选择本地的分片，本地没有对应分片或对应分 片不可用时再路由到其他分片。</li><li><strong>_prefer_nodes</strong>：abc，xyz:如果可能，该操作将在具有提 供的节点ID之一的节点上执行(本例中为abc或xyz)。如果 在多个选定节点上存在合适的分片副本，则这些副本之间的 首选顺序不确定。指定的ID不满足时会路由到其他分片。</li><li><strong>_shards</strong>：2，3:将操作限制在为指定的分片，本例中为2 和3。此首选项可以与其他首选项组合，但必须首先配置: _shards:2，3_u local。</li><li><strong>_only_nodes</strong>：abc*，x*yz，…:将操作限制到根据节点规 范指定的节点。如果在多个选定节点上存在合适的分片副 本，则这些副本之间的首选顺序不确定。</li></ul> 
<blockquote> 
 <p>在实际生产环境中用得最多的是_local，可以节省一定的网络开 销。</p> 
</blockquote> 
<h4><a id="211_1762"></a>2.11、重排序</h4> 
<p>重新排序有助于提高检索结果的精度，只需重新排序顶部(例如 100-500)文档，使用二级(通常更昂贵)算法，而不是将昂贵的算 法应用于索引中的所有文档。</p> 
<p>在每个分片返回其结果给协调节点之前，就会执行重排序 (rescore)请求。</p> 
<p>目前，rescore API只有一个实现:query rescorer，它使用查询 来调整评分。在未来，可能会有其他的实现方式。</p> 
<p>如果在重排序查询rescore中提供了显式排序，则将引发错误。既 然重排序，就不能再自定义排序。</p> 
<p>当向用户显示分页时，不应该在单步浏览每个页面时更改窗口大 小window_size(通过传递不同的值)，因为这样会改变顶部命中， 导致结果在用户单步浏览页面时发生令人困惑的移动(结果重复或缺 少某些文档)。</p> 
<p>查询重新排序器(query rescorer)仅对查询和post_filter筛选 阶段返回的前k个结果执行二次查询。每个分片上要检查的文档数可 以由window_size参数控制，该参数默认为10。</p> 
<p>默认情况下，原始查询和重排序查询的分数是线性组合的，以生 成每个文档的最终分数。原始查询和重排序查询的相对重要性可以分 别 用 查 询 权 重 query_weight 和 重 排 序 查 询 权 重 rescore_query_weight来控制。两者都默认为1。下面是一个具体示 例:</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
         <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"operator"</span> <span class="token operator">:</span> <span class="token string">"or"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token string">"the quick brown"</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string-property property">"rescore"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"window_size"</span> <span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
      <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
         <span class="token string-property property">"rescore_query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"match_phrase"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
               <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token string">"the quick brown"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"slop"</span> <span class="token operator">:</span> <span class="token number">2</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token string-property property">"query_weight"</span> <span class="token operator">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
         <span class="token string-property property">"rescore_query_weight"</span> <span class="token operator">:</span> <span class="token number">1.2</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>score_mode控制分数的组合方式，支持以下模式:</p> 
<ul><li>total:加总原始查询和重排序查询的分数，这是默认方式。</li><li>multiply:原始分数乘以重排序查询分数，适用于函数查询 的重排序。</li><li>avg:原始查询和重排序查询的分数取平均值。</li><li>max:原始查询和重排序查询的分数取二者的最大值。</li><li>min:原始查询和重排序查询的分数取二者的最小值。</li></ul> 
<p>下面示例按顺序执行多个重排序查询:</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
         <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"operator"</span> <span class="token operator">:</span> <span class="token string">"or"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token string">"the quick brown"</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string-property property">"rescore"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"window_size"</span> <span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
         <span class="token string-property property">"rescore_query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"match_phrase"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
               <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token string">"the quick brown"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"slop"</span> <span class="token operator">:</span> <span class="token number">2</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         <span class="token string-property property">"query_weight"</span> <span class="token operator">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
         <span class="token string-property property">"rescore_query_weight"</span> <span class="token operator">:</span> <span class="token number">1.2</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"window_size"</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
         <span class="token string-property property">"score_mode"</span><span class="token operator">:</span> <span class="token string">"multiply"</span><span class="token punctuation">,</span>
         <span class="token string-property property">"rescore_query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"function_score"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
               <span class="token string-property property">"script_score"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"script"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"source"</span><span class="token operator">:</span> <span class="token string">"Math.log10(doc.likes.value + 2)"</span>
                  <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先第一个query获取查询结果，然后第二个query得到第一个 query的结果。第二个rescore将“看到”第一个rescore所做的排 序，因此可以使用第一个rescore上的大窗口将文档拉到第二个 rescore的较小窗口中。</p> 
<h4><a id="212_1856"></a>2.12、脚本字段</h4> 
<p>允许为每次命中返回脚本(script)计算值(基于不同字段)， 例如:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"script_fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"test1"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"script"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"lang"</span><span class="token operator">:</span> <span class="token string">"painless"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"source"</span><span class="token operator">:</span> <span class="token string">"doc['price'].value * 2"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"test2"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"script"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"lang"</span><span class="token operator">:</span> <span class="token string">"painless"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"source"</span><span class="token operator">:</span> <span class="token string">"doc['price'].value * params.factor"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"params"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"factor"</span>  <span class="token operator">:</span> <span class="token number">2.0</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>脚本字段可以处理未存储的字段，并允许返回自定义值(脚本的 计算值)。</p> 
<p>脚 本 字 段 还 可 以 访 问 实 际 的 _source 文 档 ， 并 使 用 params[‘_source’]从中提取要返回的特定元素。下面是一个例子:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"script_fields"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"test1"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"script"</span> <span class="token operator">:</span> <span class="token string">"params['_source']['message']"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>理解doc[‘my_field’].value和params[‘_source’][‘my_field’]之间 的区别很重要。本节第一个示例，使用doc关键字，将导致该字段的 Term被加载到内存(缓存)，致使更快的执行速度，但会造成更多的 内存消耗。另外，doc[…]表示法只允许简单值字段(不能从中返回 JSON对象)，并且只对非分析字段或基于单Term的字段有意义。但 是，如果可能，使用doc仍然是从文档中访问值的推荐方法，因为每 次使用_source时都必须加载和分析，导致使用_source非常慢。</p> 
<h4><a id="213_1903"></a>2.13、滚动查询</h4> 
<p>当搜索请求返回单个“页面”的结果时，可以使用滚动查询 (scroll)API从单个搜索请求中检索大量结果(甚至是所有结果)， 这与在传统数据库中使用游标的方式非常相似。</p> 
<p>滚动不适用于实时用户请求，而适用于处理大量数据，例如为了 将一个索引的内容重新索引到具有不同配置的新索引中。</p> 
<p>从滚动请求返回的结果反映了在发出初始搜索请求时索引的状 态，如及时快照。对文档的后续更改(索引、更新或删除)只会影响 以后的搜索请求。</p> 
<p>为了使用滚动搜索功能，初始搜索请求应该在查询字符串中指定 scroll参数，该参数告诉Elasticsearch“搜索上下文”应保持活动多长时间，例如scroll=1m。示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search<span class="token operator">?</span>scroll<span class="token operator">=</span>1m
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述请求的结果包括一个_scroll_id，它应该传递给scroll API， 以便检索下一批结果:</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>_search<span class="token operator">/</span>scroll 
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"scroll"</span> <span class="token operator">:</span> <span class="token string">"1m"</span><span class="token punctuation">,</span> 
    <span class="token string-property property">"scroll_id"</span> <span class="token operator">:</span> <span class="token string">"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ=="</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>上述示例中，scroll参数告诉Elasticsearch将搜索上下文再保持 活跃时间1m。scroll_id参数是上一次查询的返回值。</p> 
<p>size参数用来配置每批结果返回的最大命中数。对scroll API的每 次调用都会返回下一批结果，直到没有更多的结果可以返回，即hits 数组为空。</p> 
<p>初始搜索请求和随后的每个滚动请求都返回一个_scroll_id。虽 然_scroll_id可能在请求之间发生变化，但它并不总是变化。在任何 情况下，只应使用最近收到的_scroll_id。</p> 
<p>如果请求指定聚合，则只有初始搜索响应将包含聚合结果。</p> 
<p>当排序顺序为_doc时，滚动请求会进行优化。如果需要迭代所有 文档，不管顺序如何，这都是最有效的选项，示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search<span class="token operator">?</span>scroll<span class="token operator">=</span>1m
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"_doc"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2131_1950"></a>2.13.1、保持搜索上下文处于活跃状态</h5> 
<p>滚动搜索请求可返回初始搜索请求匹配的所有文档。它忽略对这 些文档的任何后续更改，搜索上下文跟踪Elasticsearch返回正确文 档所需的所有信息。搜索上下文由初始请求创建，并由后续请求保持 活跃性。</p> 
<p>滚动参数scroll(传递给搜索请求和每个滚动请求)告诉 Elasticsearch应该保持搜索上下文活动多长时间。它的值(例如1分 钟)不需要足够长的时间来处理所有数据，只需要足够长的时间来处 理前一批结果，因为每个scroll请求(带有scroll参数)会设置一个新 的到期时间。如果scroll请求没有传递参数scroll，那么搜索上下文将 作为滚动请求的一部分被释放。</p> 
<p>通常，后台合并过程通过合并较小的段来优化索引，从而创建新 的较大的段。一旦不再需要较小的段，它们就会被删除。此过程在 scroll查询期间也是正常执行的，但打开的搜索上下文会阻止删除旧 段，因为它们仍在使用中。</p> 
<p>此外，如果某个段包含已删除或更新的文档，则搜索上下文必须 跟踪该段中的每个文档在初始搜索请求时是否处于活动状态。如果索 引上有许多打开的滚动查询，并且这些查询会受到正在进行的删除或 更新的影响，请确保节点具有足够的堆空间。</p> 
<p>可以使用如下方式检查打开了多少搜索上下文:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_nodes<span class="token operator">/</span>stats<span class="token operator">/</span>indices<span class="token operator">/</span>search
</code></pre> 
<h5><a id="2132_1965"></a>2.13.2、清理搜索上下文</h5> 
<p>当超过scroll参数设置的超时时间时，搜索上下文将自动删除。 但是，正常情况下保持搜索上下文是有成本的，因此当滚动不再使用 时，应明确清除，示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">DELETE</span> <span class="token operator">/</span>_search<span class="token operator">/</span>scroll
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"scroll_id"</span> <span class="token operator">:</span> <span class="token string">"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ=="</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>也可以一次清除多个搜索上下文:</p> 
<pre><code class="prism language-json"><span class="token constant">DELETE</span> <span class="token operator">/</span>_search<span class="token operator">/</span>scroll
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"scroll_id"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ=="</span><span class="token punctuation">,</span>
      <span class="token string">"DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAABFmtSWWRRWUJrU2o2ZExpSGJCVmQxYUEAAAAAAAAAAxZrUllkUVlCa1NqNmRMaUhiQlZkMWFBAAAAAAAAAAIWa1JZZFFZQmtTajZkTGlIYkJWZDFhQQAAAAAAAAAFFmtSWWRRWUJrU2o2ZExpSGJCVmQxYUEAAAAAAAAABBZrUllkUVlCa1NqNmRMaUhiQlZkMWFB"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>要清除所有搜索上下文，可以使用_all参数:</p> 
<pre><code class="prism language-json"><span class="token constant">DELETE</span> <span class="token operator">/</span>_search<span class="token operator">/</span>scroll<span class="token operator">/</span>_all
</code></pre> 
<p>scroll_id可以作为查询字符串参数或在请求主体中传递。可以将 用逗号分隔的多个滚动ID传递:</p> 
<pre><code class="prism language-json"><span class="token constant">DELETE</span> <span class="token operator">/</span>_search<span class="token operator">/</span>scroll<span class="token operator">/</span>DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ<span class="token operator">==</span><span class="token punctuation">,</span>DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAABFmtSWWRRWUJrU2o2ZExpSGJCVmQxYUEAAAAAAAAAAxZrUllkUVlCa1NqNmRMaUhiQlZkMWFBAAAAAAAAAAIWa1JZZFFZQmtTajZkTGlIYkJWZDFhQQAAAAAAAAAFFmtSWWRRWUJrU2o2ZExpSGJCVmQxYUEAAAAAAAAABBZrUllkUVlCa1NqNmRMaUhiQlZkMWFB
</code></pre> 
<h5><a id="2133_1994"></a>2.13.3、切片</h5> 
<p>对于返回大量文档的滚动查询，可以将滚动拆分为多个可独立使 用的切片，来并行执行整个查询过程，示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search<span class="token operator">?</span>scroll<span class="token operator">=</span>1m
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"slice"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        <span class="token string-property property">"max"</span><span class="token operator">:</span> <span class="token number">2</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search<span class="token operator">?</span>scroll<span class="token operator">=</span>1m
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"slice"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string-property property">"max"</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述示例中，第一个请求的结果属于第一个切片(ID:0)的文 档，第二个请求的结果属于第二个切片的文档。由于最大切片数设置 为2，因此两个请求的结果的并集相当于不进行切片的滚动查询的结 果。默认情况下，首先在分片上完成分割，然后在每个分片上使用带 有以下公式的_id字段进行切片:</p> 
<pre><code class="prism language-json"><span class="token function">slice</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">floorMod</span><span class="token punctuation">(</span><span class="token function">hashCode</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">,</span>max<span class="token punctuation">)</span>
</code></pre> 
<p>例如，如果分片数量等于2，并且用户请求4个切片，则切片0和2 被分配给第一个分片，切片1和3被分配到第二个分片。</p> 
<p>每个滚动是独立的，可以并行处理。</p> 
<p>如果切片数量大于分片数量，则切片过滤器在第一次调用时速度 非常慢，它的复杂性为O(n)，并且内存成本等于每个切片的 NBit，其中N是分片中的文档总数。在几次调用之后，应该会缓存过 滤器，随后的调用就会更快，但是应该限制并行执行的切片查询的数 量，以避免内存爆炸。</p> 
<p>为了完全避免这种开销，可以使用另一个字段的doc_values进行 切片，但用户必须确保该字段具有以下属性:</p> 
<ul><li>该字段是数字。</li><li>在该字段上启用doc_values。</li><li>每个文档的该字段都应该是单值。如果一个文档的指定字段 有多个值，则使用第一个值。</li><li>创建文档时，每个文档的值都应设置一次，并且从不更新。 这样可以确保每个切片都得到确定的结果。</li><li>字段的基数应该很高，这样可以确保每个切片获得大致相同 数量的文档。</li></ul> 
<p>默认情况下，每个滚动请求允许的最大切片数限制为1024。可以 更新index.max_slices_per_scroll设置以绕过此限制。</p> 
<h4><a id="214search_after_2042"></a>2.14、search_after参数</h4> 
<p>结果的分页可以通过使用from和size来完成，但当达到深度分页 时，开销会变得难以控制。index.max_result_window默认值为10 000，是一种保护措施，搜索请求占用堆内存和时间，与from+size 大小成比例。建议使用scroll API进行深度分页，但滚动上下文成本 高昂，不建议将其用于实时用户请求。search_after参数通过提供活 动光标来绕过这个问题。其思想是使用上一页的结果来帮助检索下一 页。</p> 
<p>假设检索第一页的查询如下所示:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"tie_breaker_id"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span>      
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述示例代码中，tie_breaker_id是_id字段的副本，已启用 doc_values。</p> 
<p>每个文档应使用具有唯一值的字段来排序。否则，具有相同排序 值的文档的排序顺序将未定义，并可能导致结果丢失或重复。_id字段 对于每个文档都有唯一的值，但不建议将其直接用作排序的决定因 子。注意，tiebreaker要查找完全或部分匹配tiebreaker(排序的决 定值)提供的值的第一个文档。因此，如果一个文档的tiebreaker值 为654 323，并且在其后面搜索654，它仍然会匹配该文档并返回在 其之后找到的结果。doc_values在这个字段上被禁用，因此对它进行 排序需要在内存中加载大量数据。相反，建议在启用了doc_values的 另一个字段中复制id字段的内容，并使用此新字段作为排序字段。</p> 
<p>上述请求的结果包括每个文档的sort values。这些sort values 可以与search_after参数一起使用，以在结果列表中的任何文档“之 后”开始返回结果。例如，可以使用最后一个文档的排序值sort values，然后将其传递给搜索者，以便检索下一页的结果，示例如 下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"search_after"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1463538857</span><span class="token punctuation">,</span> <span class="token string">"654323"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string-property property">"tie_breaker_id"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>参数from必须设置为0(或-1)。</p> 
<p>search_after不是自由跳转到随机页面的解决方案，而是并行滚 动许多查询。它与scroll API非常相似，但与之不同的是， search_after参数是无状态的，它总是根据搜索者的最新版本进行解析。因此，在执行过程中，排序顺序可能会根据索引的更新或删除而 改变。</p> 
<h4><a id="215_2087"></a>2.15、搜索类型</h4> 
<p>在进行分布式搜索时，会执行不同的路径。分布式搜索操作需要 把请求分发到所有相关的分片上，然后将所有结果收集回到协调节 点。当执行分发和收集时，有几种方法可以做到这一点，特别是使用 搜索引擎时。</p> 
<p>执行分布式搜索时的一个问题是从每个分片中检索多少结果。例 如，如果有10个分片，第一个分片可能包含从0到10的最相关结果， 其他分片的结果排名低于它。因此，在执行请求时，需要从所有分片 中都获取从0到10的结果，对它们进行排序，然后返回结果，这样才 可以确保结果的正确性。</p> 
<p>另一个与搜索引擎相关的问题是，每个分片都是独立存在的。当 对特定分片执行查询时，它不考虑来自其他分片的Term频率和向量信 息。如果我们想要支持精确的排名，需要首先从所有分片收集Term频 率来计算全局Term频率，然后使用这些全局频率对每个分片执行查 询。</p> 
<p>此外，由于需要对结果进行排序、返回大型文档集，甚至滚动 它，同时保持正确的排序行为可能是一个非常昂贵的操作。对于大型 结果集的scroll操作，如果返回文档的顺序不重要，最好按_doc排 序。</p> 
<p>Elasticsearch是非常灵活的，它允许根据每个搜索请求控制要 执行的搜索类型(search_type)。可以通过在查询字符串中设置 search_type参数来配置搜索类型，其中类型有如下两种:</p> 
<ul><li>query_then_fetch(默认值):请求分两个阶段处理。在第 一阶段，查询被转发到所有相关的分片，每个分片执行搜索 并生成一个结果的排序列表。每个分片只返回足够的信息给 协调节点(排序过的文档ID和排序需要的相关字段)，以允 许它合并并将分片级别的结果重新排序。</li></ul> 
<p>在第二阶段中，协调节点只从相关的分片请求文档内容(以及高 亮显示的片段，如果有)。</p> 
<ul><li>dfs_query_then_fetch : 第 二 阶 段 与 query_then_fetch 相 同，但在初始请求分发执行阶段是不同的，该阶段进行并计 算分布式Term频率，以便更准确地评分。</li></ul> 
<h4><a id="216_2105"></a>2.16、排序</h4> 
<p>可以按特定一个或多个字段对结果排序。排序是在每个字段级别 上定义的，_score用于按得分排序，以及按索引顺序排序的_doc。<br> 假设以下索引映射:</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>my_index
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"post_date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"age"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如下示例，返回结果按多个字段进行排序，与SQL语言中的 order by功能类似:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>my_index<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"post_date"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"user"</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"name"</span> <span class="token operator">:</span> <span class="token string">"desc"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"age"</span> <span class="token operator">:</span> <span class="token string">"desc"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"_score"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>除了最准确的排序(因为_doc是唯一值，排序准确)顺序之外， _doc很少被实际应用。因此，如果不关心返回文档的顺序，那么应该 按_doc排序，这在滚动查询时尤其有用。</p> 
<h5><a id="2161_2144"></a>2.16.1、排序方式</h5> 
<p>排序方式有两种:asc，升序;desc，降序。与SQL语言是相同 的。</p> 
<h5><a id="2162_2147"></a>2.16.2、多值字段排序模式</h5> 
<p>Elasticsearch支持按数组或多值字段排序。模式选项mode控制 对文档进行排序的值，它有以下几种值:</p> 
<ul><li><strong>min</strong>：数组或多值字段的最小值作为排序值。</li><li><strong>max</strong>：数组或多值字段的最大值作为排序值。</li><li><strong>sum</strong>：数组或多值字段的和作为排序值。</li><li><strong>avg</strong>：数组或多值字段的平均值作为排序值。</li><li><strong>median</strong>：数组或多值字段的中位数作为排序值。</li></ul> 
<p>以升序排序的默认排序模式是min，选择最小值作为排序值。按 降序排列的默认排序模式是max，取最大值作为排序值。</p> 
<p>在下面的示例中，字段price每个文档有多个价格。在这种情况 下，结果将按每个文档的平均价格升序排序。</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>my_index<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span><span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"product"</span><span class="token operator">:</span> <span class="token string">"chocolate"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token constant">POST</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"product"</span> <span class="token operator">:</span> <span class="token string">"chocolate"</span> <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span><span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span> <span class="token string-property property">"mode"</span> <span class="token operator">:</span> <span class="token string">"avg"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2163_2177"></a>2.16.3、嵌套对象的排序</h5> 
<p>Elasticsearch还支持按一个或多个嵌套对象中的字段排序。按 嵌套字段的排序支持一个nested属性，该属性具有以下选项:</p> 
<ul><li><strong>path</strong>：定义要用来排序的嵌套对象字段。实际排序字段必须 是此嵌套对象内的直接字段(内部不能再嵌套)。按嵌套字 段排序时，此字段是必需的。</li><li><strong>filter</strong>：常见的情况是在嵌套的过滤器或查询中重复查询/过 滤。</li><li><strong>max_children</strong>：选择排序值时每个根文档要考虑的最大子 级数，默认为无限制。</li><li><strong>nested</strong>：与顶层嵌套相同，但适用于当前嵌套对象中的另一 个嵌套路径。</li></ul> 
<p>在下面的示例中，offer是一个嵌套类型的字段。需要指定嵌套路 径path，否则Elasticsearch不知道需要获取什么嵌套级别的排序 值。</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"product"</span> <span class="token operator">:</span> <span class="token string">"chocolate"</span> <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
       <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"offer.price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
             <span class="token string-property property">"mode"</span> <span class="token operator">:</span>  <span class="token string">"avg"</span><span class="token punctuation">,</span>
             <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span>
             <span class="token string-property property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"offer"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                   <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"offer.color"</span> <span class="token operator">:</span> <span class="token string">"blue"</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在下面的示例中，父字段和子字段的类型为嵌套。嵌套的路径需 要在每个级别上指定，否则，Elasticsearch不知道需要捕获哪个嵌 套级别的排序值。</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
         <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"parent"</span><span class="token punctuation">,</span>
         <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"must"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"parent.age"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"gte"</span><span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"parent.child"</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"parent.child.name"</span><span class="token operator">:</span> <span class="token string">"matt"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
         <span class="token string-property property">"parent.child.age"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"mode"</span> <span class="token operator">:</span>  <span class="token string">"min"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
               <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"parent"</span><span class="token punctuation">,</span>
               <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"parent.age"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"gte"</span><span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
               <span class="token punctuation">}</span><span class="token punctuation">,</span>
               <span class="token string-property property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"parent.child"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                     <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"parent.child.name"</span><span class="token operator">:</span> <span class="token string">"matt"</span><span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2164_2250"></a>2.16.4、缺失值的处理</h5> 
<p>missing参数指定如何处理缺少排序字段的文档。可以将 missing的值设置为_last、_first或自定义值(将用作缺失排序字段的文档的排序值)，默认值为_last。示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"missing"</span> <span class="token operator">:</span> <span class="token string">"_last"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"product"</span> <span class="token operator">:</span> <span class="token string">"chocolate"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>默认情况下，排序字段如果没有与字段关联的映射，则搜索请求 将失败。unmapped_type选项允许忽略没有映射的字段，不按它们 排序。此参数的值用于确定要排序字段的映射类型，即自定义排序字 段的数据类型。下面是一个如何使用它的示例:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"unmapped_type"</span> <span class="token operator">:</span> <span class="token string">"long"</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"product"</span> <span class="token operator">:</span> <span class="token string">"chocolate"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果查询的任何索引没有价格(price)映射类型，那么 Elasticsearch将当作long类型的映射来处理long，该索引中的所有 文档都没有该字段的值。</p> 
<h5><a id="2165_2278"></a>2.16.5、地理距离排序</h5> 
<p>可以按地理距离(geo)_geo_distance排序。下面是一个例子， 假设pin.location是geo_point类型的字段:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"pin.location"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"mode"</span> <span class="token operator">:</span> <span class="token string">"min"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"distance_type"</span> <span class="token operator">:</span> <span class="token string">"arc"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"ignore_unmapped"</span><span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>各参数的含义如下:</p> 
<ul><li><strong>distance_type</strong>：如何计算距离。可以是arc(默认)，也可 以是plane(更快，但在长距离和接近极点时不准确)。</li><li><strong>mode</strong>：如果一个场景有几个地理点(也就是多值)，该怎 么办?默认情况下，升序排序时考虑最短距离，降序排序时 考虑最长距离。支持的值包括min、max、median和avg。</li><li><strong>unit</strong>：排序字段值的单位，默认是m(米)。</li><li><strong>ignore_unmapped</strong>：上面已经讲过了，排序字段没有类型 该怎么处理。</li></ul> 
<p>地理距离排序不支持可配置的默认值:当文档没有用于距离计算 的字段值时，该距离将始终被视为无穷大(Infinity)。<br> 地理距离排序支持多种坐标格式，如下是应用示例。</p> 
<h6><a id="21651JSON_2310"></a>2.16.5.1、JSON经纬度格式</h6> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"pin.location"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"lat"</span> <span class="token operator">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"lon"</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">70</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="21652_2332"></a>2.16.5.2、逗号分隔格式</h6> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"pin.location"</span> <span class="token operator">:</span> <span class="token string">"40,-70"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="21653pin_2351"></a>2.16.5.3、pin码格式</h6> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"pin.location"</span> <span class="token operator">:</span> <span class="token string">"drm3btev3e86"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="21654_2370"></a>2.16.5.4、数组格式</h6> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"pin.location"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="21655_2389"></a>2.16.5.5、两点距离格式</h6> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"pin.location"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2166_2408"></a>2.16.6、自定义脚本排序</h5> 
<p>可以通过自定义的脚本的计算结果进行排序，示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"_script"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"script"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"lang"</span><span class="token operator">:</span> <span class="token string">"painless"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"source"</span><span class="token operator">:</span> <span class="token string">"doc['field_name'].value * params.factor"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"params"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"factor"</span> <span class="token operator">:</span> <span class="token number">1.1</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="217_source_2432"></a>2.17、_source字段过滤</h4> 
<p>可以控制每个命中文档的_source字段的返回方式。默认情况 下，操作将返回_source字段的内容，除非使用了stored_fields参数 或禁用了_source字段。</p> 
<p>可以使用_source参数关闭_source字段检索，要禁用_source字 段返回，设置为false，示例如下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
	<span class="token string-property property">"_source"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	<span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"term"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span><span class="token operator">:</span><span class="token string">"kimchy"</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>_source还接受一个或多个通配符模式来控制应返回_source的哪 些部分，当然也可以不包括通配符即准确指定返回的字段，下面是两 个示例:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
	<span class="token string-property property">"_source"</span><span class="token operator">:</span> <span class="token string">"obj.*"</span><span class="token punctuation">,</span>
	<span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"term"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span><span class="token operator">:</span><span class="token string">"kimchy"</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
	<span class="token string-property property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"obj1.*"</span><span class="token punctuation">,</span><span class="token string">"obj2.*"</span><span class="token punctuation">]</span>
	<span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"term"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span><span class="token operator">:</span><span class="token string">"kimchy"</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果需要更完全的控制，可以指定includes和excludes模式:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
	<span class="token string-property property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"includes"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"obj1.*"</span><span class="token punctuation">,</span><span class="token string">"obj2.*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string-property property">"excludes"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"*.description"</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"term"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span><span class="token operator">:</span><span class="token string">"kimchy"</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="218_2477"></a>2.18、存储字段</h4> 
<p>存储字段指的是建立索引映射，store设置为true的字段(默认是 false)，通常不建议使用(增加内存开销)。</p> 
<p>stored_fields参数控制存储字段的返回，建议使用source来选择 要返回的原始文档的哪些字段。</p> 
<p>允许有选择地为搜索命中的文档加载特定的存储字段，示例如 下:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"stored_fields"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"postDate"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>*可用于加载文档中的所有存储字段。<br> stored_fields为空数组将只返回每次命中的_id和_type字段，例 如:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"stored_fields"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果请求的字段存储映射设置为false，则将忽略这些字段。</p> 
<p>从文档本身获取的存储字段值始终作为数组返回。相反，像路由 _routing这样的元数据字段永远不会作为数组返回。此外，只能通过 字段选项返回叶字段，不能返回对象字段，这样的请求将失败。</p> 
<p>脚本字段也可以自动检测并用作字段，因此可以使用 _source.obj1.field1之类的内容，但不推荐，因为obj1.field1是更好 的选择。</p> 
<p>下面的示例禁用stored_fields:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"stored_fields"</span><span class="token operator">:</span> <span class="token string">"_none_"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="219totaltrack_total_hits_2520"></a>2.19、total返回值详解（track_total_hits）</h4> 
<p>通常，要准确计算总命中数，必须访问所有匹配项，这对于匹配 大量文档的查询来说代价高昂。track_total_hits参数允许控制应如 何跟踪命中总数(控制total的准确度)。track_total_hits默认设置 为10 000，这意味着请求命中数在10 000以内，total计数是准确 的，total.relation值是eq。如果请求命中数大于10 000时，计数是不准确的，此时total的值是10 000，total.relation值是gte。如果不 需要准确的命中总数，这种设计可以加速查询。</p> 
<p>当track_total_hits设置为true时，搜索响应返回的命中总数始 终是准确的(total.relation始终等于eq)。搜索响应中total对象中 返回的total.relation将决定total.value是否准确。gte的值表示 total.value匹配查询的总命中数的下限，eq的值表示total.value是准 确的计数。</p> 
<p>通过如下示例，再来分析:</p> 
<pre><code class="prism language-json"> <span class="token constant">GET</span> twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
     <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token string">"Elasticsearch"</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"_shards"</span><span class="token operator">:</span> <span class="token operator">...</span>
    <span class="token string-property property">"timed_out"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string-property property">"took"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"max_score"</span><span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token string-property property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token number">2048</span><span class="token punctuation">,</span>    
            <span class="token string-property property">"relation"</span><span class="token operator">:</span> <span class="token string">"eq"</span>  
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"hits"</span><span class="token operator">:</span> <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>也可以将track_total_hits设置为整数。例如，以下查询将准确 跟踪与查询匹配的命中总数，最多100个文档，也就是命中文档数低 于100时，是准确的，高于100时是不准确的(total.relation值是 gte):</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
     <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token string">"Elasticsearch"</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果不需要跟踪命中总数，可以通过将此选项设置为false来改进 查询时间:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> twitter<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"track_total_hits"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
     <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token string">"Elasticsearch"</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="220_version_2580"></a>2.20、版本控制（_version）</h4> 
<p>Elasticsearch中的版本功能在并发更新文档时，用来处理冲突 的机制。Elasticsearch采用的是乐观并发控制机制。这种方法假定 冲突是不可能发生的，所以不会阻塞正在尝试的操作。然而，如果源 数据在读写当中被修改，更新将会失败。应用程序接下来将决定该如 何解决冲突。例如，可以获取新的数据，重试更新或者将相关情况报 告给用户。</p> 
<p>Elasticsearch是分布式的，当文档创建、更新、删除时，新版 本的文档必须复制到集群中其他节点，同时，Elasticsearch也是异 步和并发的。这就意味着这些复制请求被并行发送，并且到达目的地 时也许顺序是乱的(老版本可能在新版本之后到达)。 Elasticsearch需要一种方法确保文档的旧版本不会覆盖新的版本。 Elasticsearch利用_version(版本号)的方式来确保应用中相互冲 突的变更不会导致数据丢失。需要修改数据时，需要指定想要修改文 档的version号，如果该版本不是当前版本号，请求将会失败。</p> 
<p>可以通过如下方式返回文档的版本信息:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>bank<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"city.keyword"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"Orick"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3_search_shards_2600"></a>3、返回索引分片信息（_search_shards）</h3> 
<p>_search_shards API返回将针对其执行搜索请求的索引和分片 信息。这可以为解决问题或使用路由和分片首选项计划优化提供有用 的反馈。</p> 
<pre><code class="prism language-json"><span class="token comment">//语法</span>
<span class="token constant">GET</span> <span class="token operator">/</span><span class="token operator">&lt;</span>index<span class="token operator">&gt;</span><span class="token operator">/</span>_search_shards
</code></pre> 
<p>示例：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search_shards
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"nodes"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"Cc6ARDA6TY-poOdtxvsA6g"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span> <span class="token operator">:</span> <span class="token string">"zhangchenglongdeMacBook-Pro.local"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"ephemeral_id"</span> <span class="token operator">:</span> <span class="token string">"YekwqhksTmazQePnvw1-YQ"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"transport_address"</span> <span class="token operator">:</span> <span class="token string">"127.0.0.1:9300"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"attributes"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"ml.machine_memory"</span> <span class="token operator">:</span> <span class="token string">"17179869184"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"xpack.installed"</span> <span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"transform.node"</span> <span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"ml.max_open_jobs"</span> <span class="token operator">:</span> <span class="token string">"512"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"ml.max_jvm_size"</span> <span class="token operator">:</span> <span class="token string">"1037959168"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"roles"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"data"</span><span class="token punctuation">,</span>
        <span class="token string">"data_cold"</span><span class="token punctuation">,</span>
        <span class="token string">"data_content"</span><span class="token punctuation">,</span>
        <span class="token string">"data_frozen"</span><span class="token punctuation">,</span>
        <span class="token string">"data_hot"</span><span class="token punctuation">,</span>
        <span class="token string">"data_warm"</span><span class="token punctuation">,</span>
        <span class="token string">"ingest"</span><span class="token punctuation">,</span>
        <span class="token string">"master"</span><span class="token punctuation">,</span>
        <span class="token string">"ml"</span><span class="token punctuation">,</span>
        <span class="token string">"remote_cluster_client"</span><span class="token punctuation">,</span>
        <span class="token string">"transform"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"indices"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"twitter"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"shards"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"state"</span> <span class="token operator">:</span> <span class="token string">"STARTED"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"primary"</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string-property property">"node"</span> <span class="token operator">:</span> <span class="token string">"Cc6ARDA6TY-poOdtxvsA6g"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"relocating_node"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string-property property">"shard"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string-property property">"index"</span> <span class="token operator">:</span> <span class="token string">"twitter"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"allocation_id"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"id"</span> <span class="token operator">:</span> <span class="token string">"3OsEagVpRFifBrs-baJTzA"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>也可以在请求中带有路由值:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_search_shards<span class="token operator">?</span>routing<span class="token operator">=</span>foo<span class="token punctuation">,</span>bar
</code></pre> 
<p>支持的参数如下：</p> 
<ul><li><strong>routing</strong>：一个逗号分隔的路由值列表，在确定请求将分发哪个分片执行时 用到这些值。</li><li><strong>preference</strong>：这个是控制优先在哪些分片上执行请求，在上面的章节已经进行 过讲解。</li><li><strong>local</strong>：一个布尔值，控制是否在本地读取集群状态，以确定在何处分配 分片，而不是使用主节点的集群状态。</li></ul> 
<h3><a id="4Count_API_2673"></a>4、Count API</h3> 
<p>Count API可以轻量级执行查询并获取该查询的匹配文档数。它 可以跨一个或多个索引执行。可以使用简单查询字符串作为参数提供 查询，也可以使用请求正文中定义的查询DSL。</p> 
<pre><code class="prism language-json"><span class="token comment">//语法</span>
<span class="token constant">GET</span> <span class="token operator">/</span><span class="token operator">&lt;</span>index<span class="token operator">&gt;</span><span class="token operator">/</span>_count
</code></pre> 
<p>示例：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span><span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"kimchy"</span>
<span class="token punctuation">}</span>

<span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_count<span class="token operator">?</span>q<span class="token operator">=</span>user<span class="token operator">:</span>kimchy

<span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_count
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5Validate_API_2698"></a>5、Validate API</h3> 
<p>Validate API允许用户在不执行查询的情况下验证查询的合法 性。</p> 
<pre><code class="prism language-json"><span class="token comment">//语法</span>
<span class="token constant">GET</span> <span class="token operator">/</span><span class="token operator">&lt;</span>index<span class="token operator">&gt;</span><span class="token operator">/</span>_validate<span class="token operator">/</span><span class="token operator">&lt;</span>query<span class="token operator">&gt;</span>
</code></pre> 
<p>示例：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> twitter<span class="token operator">/</span>_bulk<span class="token operator">?</span>refresh
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"index"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"_id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span><span class="token punctuation">,</span> <span class="token string-property property">"post_date"</span> <span class="token operator">:</span> <span class="token string">"2009-11-15T14:12:12"</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token string">"trying out Elasticsearch"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"index"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"_id"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchi"</span><span class="token punctuation">,</span> <span class="token string-property property">"post_date"</span> <span class="token operator">:</span> <span class="token string">"2009-11-15T14:12:13"</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token string">"My username is similar to @kimchy!"</span><span class="token punctuation">}</span>
</code></pre> 
<p>发送一个验证查询:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> twitter<span class="token operator">/</span>_validate<span class="token operator">/</span>query<span class="token operator">?</span>q<span class="token operator">=</span>user<span class="token operator">:</span>foo
</code></pre> 
<p>也可以使用body形式:</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> twitter<span class="token operator">/</span>_validate<span class="token operator">/</span>query
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"bool"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"must"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"query_string"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token string">"*:*"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"filter"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"term"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"user"</span> <span class="token operator">:</span> <span class="token string">"kimchy"</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6_explain_2737"></a>6、调试（_explain）</h3> 
<p>调试API(_explain)可以查看查询和特定文档计算分数的细 节。无论文档是否匹配特定查询，这都可以提供有用的反馈。必须为 index参数提供单个索引。</p> 
<pre><code class="prism language-json"><span class="token comment">//语法</span>
<span class="token constant">GET</span> <span class="token operator">/</span><span class="token operator">&lt;</span>index<span class="token operator">&gt;</span><span class="token operator">/</span>_explain<span class="token operator">/</span><span class="token operator">&lt;</span>id<span class="token operator">&gt;</span> 
<span class="token constant">POST</span> <span class="token operator">/</span><span class="token operator">&lt;</span>index<span class="token operator">&gt;</span><span class="token operator">/</span>_explain<span class="token operator">/</span><span class="token operator">&lt;</span>id<span class="token operator">&gt;</span>
</code></pre> 
<p>示例：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>twitter<span class="token operator">/</span>_explain<span class="token operator">/</span><span class="token number">0</span>
<span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"query"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token string">"elasticsearch"</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>返回：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"_index"</span><span class="token operator">:</span><span class="token string">"twitter"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"_type"</span><span class="token operator">:</span><span class="token string">"_doc"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"_id"</span><span class="token operator">:</span><span class="token string">"0"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"matched"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token string-property property">"explanation"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">1.6943598</span><span class="token punctuation">,</span>
      <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"weight(message:elasticsearch in 0) [PerFieldSimilarity], result of:"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span>
         <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">1.6943598</span><span class="token punctuation">,</span>
            <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"score(freq=1.0), computed as boost * idf * tf from:"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span>
               <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">2.2</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"boost"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
               <span class="token punctuation">}</span><span class="token punctuation">,</span>
               <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">1.3862944</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span>
                     <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"n, number of documents containing term"</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                     <span class="token punctuation">}</span><span class="token punctuation">,</span>
                     <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"N, total number of documents with field"</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                     <span class="token punctuation">}</span>
                  <span class="token punctuation">]</span>
               <span class="token punctuation">}</span><span class="token punctuation">,</span>
               <span class="token punctuation">{<!-- --></span>
                  <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">0.5555556</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:"</span><span class="token punctuation">,</span>
                  <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span>
                     <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">1.0</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"freq, occurrences of term within document"</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                     <span class="token punctuation">}</span><span class="token punctuation">,</span>
                     <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">1.2</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"k1, term saturation parameter"</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                     <span class="token punctuation">}</span><span class="token punctuation">,</span>
                     <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">0.75</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"b, length normalization parameter"</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                     <span class="token punctuation">}</span><span class="token punctuation">,</span>
                     <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">3.0</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"dl, length of field"</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                     <span class="token punctuation">}</span><span class="token punctuation">,</span>
                     <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"value"</span><span class="token operator">:</span><span class="token number">5.4</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"description"</span><span class="token operator">:</span><span class="token string">"avgdl, average length of field"</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"details"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                     <span class="token punctuation">}</span>
                  <span class="token punctuation">]</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/39de7c25b5fd7df2528f9447c3b2f844/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">软件工程（小小总结）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e7280dfc5a76af1082f3d47ae4067068/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Candence报错】Discrepancy #i in TASK</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>