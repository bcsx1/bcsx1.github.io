<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Faster-RCNN网络 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Faster-RCNN网络" />
<meta property="og:description" content="Faster-RCNN网络 学习目标
熟悉FasterRCNN目标检测的思想知道anchor（锚框）的思想掌握RPN网络是如何进行候选区域的生成的掌握ROIPooling的使用方法知道fasterRCNN的训练方法 在R-CNN和Fast RCNN的基础上，在2016年提出了Faster RCNN网络模型，在结构上，Faster RCNN已经将候选区域的生成，特征提取，目标分类及目标框的回归都整合在了一个网络中，综合性能有较大提高，在检测速度方面尤为明显。接下来我们给大家详细介绍fasterRCNN网络模型。网络基本结构如下图所示：
Faster RCNN可以看成是区域生成网络(RPN)与Fast RCNN的组合，其中区域生成网络(RPN)替代选择性搜索来生成候选区域，Fast RCNN用来进行目标检测。
网络工作流程 FasterRCNN的工作流程是：
1、特征提取：将整个图像缩放至固定的大小输入到CNN网络中进行特征提取，得到特征图。
2、候选区域提取：输入特征图，使用区域生成网络RPN，产生一些列的候选区域
3、ROIPooling: 与Fast RCNN网络中一样，使用最大池化固定候选区域的尺寸，送入后续网络中进行处理
4、目标分类和回归：与Fast RCNN网络中一样，使用两个同级层:K&#43;1个类别的SoftMax分类层和边框的回归层，来完成目标的分类和回归。
Faster R-CNN的流程与Fast R-CNN的区别不是很大，重要的改进是使用RPN网络来替代选择性搜索获取候选区域，所以我们可以将Faster R-CNN网络看做RPN和Fast R-CNN网络的结合。
接下来我们来看下该网络预训练模型的使用过程，模型源码位置：fasterRCNN中，如下图所示：
detection文件夹中是模型，数据的实现，weights中包含网络的预训练模型。接下来我们按照以下步骤进行目标检测：
1、获取数据和加载预训练网络
2、获取RPN网络生成的候选区域
3、获取网络的目标检测结果
首先导入相应的工具包：
# 获取VOC数据使用 from detection.datasets import pascal_voc # 绘图 import matplotlib.pyplot as plt import numpy as np # 模型构建 from detection.models.detectors import faster_rcnn import tensorflow as tf # 图像展示 import visualize 遇到的问题1：ModuleNotFoundError: No module named ‘cv2’
解决方法：pip install -i https://pypi." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/a10b587efd770574e9bf88fb50620719/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-02T17:43:15+08:00" />
<meta property="article:modified_time" content="2022-03-02T17:43:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Faster-RCNN网络</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="FasterRCNN_0"></a>Faster-RCNN网络</h2> 
<p><strong>学习目标</strong></p> 
<ul><li>熟悉FasterRCNN目标检测的思想</li><li>知道anchor（锚框）的思想</li><li>掌握RPN网络是如何进行候选区域的生成的</li><li>掌握ROIPooling的使用方法</li><li>知道fasterRCNN的训练方法</li></ul> 
<p><img src="https://images2.imgbox.com/f6/ce/1aR9Q7RA_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-1UdoCSjs-1646211351944)(笔记图片/image-20200914143645050-16461195891481.png)]"></p> 
<p>在R-CNN和Fast RCNN的基础上，在2016年提出了Faster RCNN网络模型，在结构上，Faster RCNN已经将候选区域的生成，特征提取，目标分类及目标框的回归都整合在了一个网络中，综合性能有较大提高，在检测速度方面尤为明显。接下来我们给大家详细介绍fasterRCNN网络模型。网络基本结构如下图所示：</p> 
<p><img src="https://images2.imgbox.com/06/8d/rhDK6LM5_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-QUsfQfIJ-1646211351945)(笔记图片/image-20200914161108604.png)]"></p> 
<p>Faster RCNN可以看成是区域生成网络(RPN)与Fast RCNN的组合，其中区域生成网络(RPN)替代选择性搜索来生成候选区域，Fast RCNN用来进行目标检测。</p> 
<h3><a id="_20"></a>网络工作流程</h3> 
<p>FasterRCNN的工作流程是：</p> 
<p><img src="https://images2.imgbox.com/8b/1e/Yw50MsX9_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-kaa5OxJX-1646211351945)(笔记图片/image-20201230100055563.png)]"></p> 
<p>1、<strong>特征提取</strong>：将整个图像缩放至固定的大小输入到CNN网络中进行特征提取，得到特征图。</p> 
<p>2、<strong>候选区域提取</strong>：输入特征图，使用区域生成网络RPN，产生一些列的候选区域</p> 
<p>3、<strong>ROIPooling</strong>: 与Fast RCNN网络中一样，使用最大池化固定候选区域的尺寸，送入后续网络中进行处理</p> 
<p>4、<strong>目标分类和回归</strong>：与Fast RCNN网络中一样，使用两个同级层:K+1个类别的SoftMax分类层和边框的回归层，来完成目标的分类和回归。</p> 
<p>Faster R-CNN的流程与Fast R-CNN的区别不是很大，重要的改进是使用RPN网络来替代选择性搜索获取候选区域，所以我们可以将Faster R-CNN网络看做RPN和Fast R-CNN网络的结合。</p> 
<p>接下来我们来看下该网络预训练模型的使用过程，模型源码位置：fasterRCNN中，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/89/78/3P4NbN5S_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-oFFSwLds-1646211351946)(笔记图片/image-20201230104009045.png)]"></p> 
<p>detection文件夹中是模型，数据的实现，weights中包含网络的预训练模型。接下来我们按照以下步骤进行目标检测：</p> 
<p>1、获取数据和加载预训练网络</p> 
<p>2、获取RPN网络生成的候选区域</p> 
<p>3、获取网络的目标检测结果</p> 
<p>首先导入相应的工具包：</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取VOC数据使用</span>
<span class="token keyword">from</span> detection<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> pascal_voc
<span class="token comment"># 绘图</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token comment"># 模型构建</span>
<span class="token keyword">from</span> detection<span class="token punctuation">.</span>models<span class="token punctuation">.</span>detectors <span class="token keyword">import</span> faster_rcnn
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token comment"># 图像展示</span>
<span class="token keyword">import</span> visualize
</code></pre> 
<p>遇到的问题1：ModuleNotFoundError: No module named ‘cv2’</p> 
<p>解决方法：pip install -i https://pypi.tuna.tsinghua.edu.cn/simple opencv-python</p> 
<p>遇到问题2：ModuleNotFoundError: No module named ‘skimage’</p> 
<p>解决办法：pip install scikit-image</p> 
<p>另外每次pip install 都会特别慢，我找到一些办法可以参考：</p> 
<p>https://blog.csdn.net/yang5915/article/details/83175804</p> 
<p>https://waple.blog.csdn.net/article/details/104574277</p> 
<p>确实下载快了许多！！！</p> 
<h4><a id="_81"></a>数据加载</h4> 
<p>加载voc数据集中的一张图片进行网络预测：</p> 
<pre><code class="prism language-python"><span class="token comment"># 实例化voc数据集的类，获取送入网络中的一张图片</span>
pascal <span class="token operator">=</span> pascal_voc<span class="token punctuation">.</span>pascal_voc<span class="token punctuation">(</span><span class="token string">"train"</span><span class="token punctuation">)</span>
<span class="token comment"># image：送入网络中的数据，imagemeta:图像的yuan'x</span>
image<span class="token punctuation">,</span>imagemeta<span class="token punctuation">,</span>bbox<span class="token punctuation">,</span>label <span class="token operator">=</span> pascal<span class="token punctuation">[</span><span class="token number">218</span><span class="token punctuation">]</span>
</code></pre> 
<p>在将图像送入网络之前，我们对其进行了尺度的调整，标准化等处理，获取可展示的图像：</p> 
<pre><code class="prism language-python"><span class="token comment"># 图像的均值和标准差</span>
img_mean <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">122.7717</span><span class="token punctuation">,</span> <span class="token number">115.9465</span><span class="token punctuation">,</span> <span class="token number">102.9801</span><span class="token punctuation">)</span>
img_std <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token comment"># RGB图像</span>
rgd_image<span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>image<span class="token operator">+</span>img_mean<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
</code></pre> 
<p>获取原始图像，进行比较：</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取原始图像</span>
<span class="token keyword">from</span> detection<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>utils <span class="token keyword">import</span> get_original_image
ori_img <span class="token operator">=</span> get_original_image<span class="token punctuation">(</span>image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>imagemeta<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>img_mean<span class="token punctuation">)</span>
</code></pre> 
<p>将图像进行对比显示：</p> 
<pre><code class="prism language-python"><span class="token comment"># 展示原图像和送入网络中图像</span>
rgd_image<span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>image<span class="token operator">+</span>img_mean<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
fig<span class="token punctuation">,</span>axes<span class="token operator">=</span>plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>nrows<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ncols<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dpi<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>ori_img<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'uint8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"原图像"</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>rgd_image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
axes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">"送入网络中的图像"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1f/db/KSNohjGg_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-R8BZI7Ec-1646211351946)(笔记图片/image-20201230112653308.png)]"></p> 
<p>将原图像的长边缩放为1216，短边按相应比例进行调整后，并按照均值进行填充</p> 
<pre><code class="prism language-python"><span class="token comment"># 原图像的大小</span>
ori_img<span class="token punctuation">.</span>shape
</code></pre> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token number">375</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 送入网络中图像的大小</span>
image<span class="token punctuation">.</span>shape
</code></pre> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1216</span><span class="token punctuation">,</span> <span class="token number">1216</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> 
<p>imagemeta中的信息是：原图像大小，图像缩放后的大小，送入网络中图像的大小，图像缩放比例，图像是否翻转（未使用）。</p> 
<pre><code class="prism language-python"><span class="token comment"># 原始图像和送入网络中图像的信息imagemeta</span>
</code></pre> 
<pre><code class="prism language-python">array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">375</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span>  <span class="token number">500</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span>    <span class="token number">3</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span>  <span class="token number">912</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span> <span class="token number">1216</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span>    <span class="token number">3</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span>        <span class="token number">1216</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span> <span class="token number">1216</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span>    <span class="token number">3</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span>    <span class="token number">2.432</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">.</span>   <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_156"></a>模型加载</h4> 
<p>加载使用coco数据集预训练的模型，对图像进行预测。</p> 
<pre><code class="prism language-python"><span class="token comment"># coco数据集的class，共80个类别：人，自行车，火车，。。。</span>
classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'bg'</span><span class="token punctuation">,</span> <span class="token string">'person'</span><span class="token punctuation">,</span> <span class="token string">'bicycle'</span><span class="token punctuation">,</span> <span class="token string">'car'</span><span class="token punctuation">,</span> <span class="token string">'motorcycle'</span><span class="token punctuation">,</span> <span class="token string">'airplane'</span><span class="token punctuation">,</span> <span class="token string">'bus'</span><span class="token punctuation">,</span> <span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'truck'</span><span class="token punctuation">,</span> <span class="token string">'boat'</span><span class="token punctuation">,</span> <span class="token string">'traffic light'</span><span class="token punctuation">,</span> <span class="token string">'fire hydrant'</span><span class="token punctuation">,</span> <span class="token string">'stop sign'</span><span class="token punctuation">,</span> <span class="token string">'parking meter'</span><span class="token punctuation">,</span> <span class="token string">'bench'</span><span class="token punctuation">,</span> <span class="token string">'bird'</span><span class="token punctuation">,</span> <span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">,</span> <span class="token string">'horse'</span><span class="token punctuation">,</span> <span class="token string">'sheep'</span><span class="token punctuation">,</span> <span class="token string">'cow'</span><span class="token punctuation">,</span> <span class="token string">'elephant'</span><span class="token punctuation">,</span> <span class="token string">'bear'</span><span class="token punctuation">,</span> <span class="token string">'zebra'</span><span class="token punctuation">,</span> <span class="token string">'giraffe'</span><span class="token punctuation">,</span> <span class="token string">'backpack'</span><span class="token punctuation">,</span> <span class="token string">'umbrella'</span><span class="token punctuation">,</span> <span class="token string">'handbag'</span><span class="token punctuation">,</span> <span class="token string">'tie'</span><span class="token punctuation">,</span> <span class="token string">'suitcase'</span><span class="token punctuation">,</span> <span class="token string">'frisbee'</span><span class="token punctuation">,</span> <span class="token string">'skis'</span><span class="token punctuation">,</span> <span class="token string">'snowboard'</span><span class="token punctuation">,</span> <span class="token string">'sports ball'</span><span class="token punctuation">,</span> <span class="token string">'kite'</span><span class="token punctuation">,</span> <span class="token string">'baseball bat'</span><span class="token punctuation">,</span> <span class="token string">'baseball glove'</span><span class="token punctuation">,</span> <span class="token string">'skateboard'</span><span class="token punctuation">,</span> <span class="token string">'surfboard'</span><span class="token punctuation">,</span>
           <span class="token string">'tennis racket'</span><span class="token punctuation">,</span> <span class="token string">'bottle'</span><span class="token punctuation">,</span> <span class="token string">'wine glass'</span><span class="token punctuation">,</span> <span class="token string">'cup'</span><span class="token punctuation">,</span> <span class="token string">'fork'</span><span class="token punctuation">,</span> <span class="token string">'knife'</span><span class="token punctuation">,</span> <span class="token string">'spoon'</span><span class="token punctuation">,</span> <span class="token string">'bowl'</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'sandwich'</span><span class="token punctuation">,</span> <span class="token string">'orange'</span><span class="token punctuation">,</span> <span class="token string">'broccoli'</span><span class="token punctuation">,</span> <span class="token string">'carrot'</span><span class="token punctuation">,</span> <span class="token string">'hot dog'</span><span class="token punctuation">,</span> <span class="token string">'pizza'</span><span class="token punctuation">,</span> <span class="token string">'donut'</span><span class="token punctuation">,</span> <span class="token string">'cake'</span><span class="token punctuation">,</span> <span class="token string">'chair'</span><span class="token punctuation">,</span> <span class="token string">'couch'</span><span class="token punctuation">,</span> <span class="token string">'potted plant'</span><span class="token punctuation">,</span> <span class="token string">'bed'</span><span class="token punctuation">,</span> <span class="token string">'dining table'</span><span class="token punctuation">,</span> <span class="token string">'toilet'</span><span class="token punctuation">,</span> <span class="token string">'tv'</span><span class="token punctuation">,</span> <span class="token string">'laptop'</span><span class="token punctuation">,</span> <span class="token string">'mouse'</span><span class="token punctuation">,</span> <span class="token string">'remote'</span><span class="token punctuation">,</span> <span class="token string">'keyboard'</span><span class="token punctuation">,</span> <span class="token string">'cell phone'</span><span class="token punctuation">,</span> <span class="token string">'microwave'</span><span class="token punctuation">,</span> <span class="token string">'oven'</span><span class="token punctuation">,</span> <span class="token string">'toaster'</span><span class="token punctuation">,</span> <span class="token string">'sink'</span><span class="token punctuation">,</span> <span class="token string">'refrigerator'</span><span class="token punctuation">,</span> <span class="token string">'book'</span><span class="token punctuation">,</span> <span class="token string">'clock'</span><span class="token punctuation">,</span> <span class="token string">'vase'</span><span class="token punctuation">,</span> <span class="token string">'scissors'</span><span class="token punctuation">,</span> <span class="token string">'teddy bear'</span><span class="token punctuation">,</span> <span class="token string">'hair drier'</span><span class="token punctuation">,</span> <span class="token string">'toothbrush'</span><span class="token punctuation">]</span>
</code></pre> 
<p>实例化faster-RCNN模型：</p> 
<pre><code class="prism language-python"><span class="token comment"># 实例化模型</span>
model <span class="token operator">=</span> faster_rcnn<span class="token punctuation">.</span>FasterRCNN<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>加载预训练模型，由于fasterRCNN不是按照model的子类构建，所以无法通过h5文件直接加载模型结构，我们将结构实例化后，在加载权重获取整个预训练模型。</p> 
<pre><code class="prism language-python">model<span class="token punctuation">(</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span>imagemeta<span class="token punctuation">,</span>bbox<span class="token punctuation">,</span>label<span class="token punctuation">)</span><span class="token punctuation">,</span>training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># 加载训练好的weights</span>
model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span><span class="token string">"weights/faster_rcnn.h5"</span><span class="token punctuation">)</span>
</code></pre> 
<p>通过model.summary()查看网络架构，如下：</p> 
<p><img src="https://images2.imgbox.com/26/ea/docqLOuU_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-L57sv2aF-1646211351947)(笔记图片/image-20201230114319613.png)]"></p> 
<h4><a id="_186"></a>模型预测过程</h4> 
<p>模型的预测分为两部分：RPN生成候选区域和Fast RCNN进行目标的分类与回归</p> 
<h5><a id="RPN_190"></a>RPN获取候选区域</h5> 
<pre><code class="prism language-python"><span class="token comment"># RPN获取候选区域：输入图像和对应的元信息，输出是候选的位置信息proposals = model.simple_test_rpn(image[0],imagemeta[0])</span>
</code></pre> 
<p>候选区域的结果如下所示：对于上述图像共产生1533个候选区域，每个候选区域使用相对于输入网络中图像归一化后的左上角坐标和右下角坐标。</p> 
<pre><code class="prism language-python"><span class="token operator">&lt;</span>tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1533</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">,</span> numpy<span class="token operator">=</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.20729761</span><span class="token punctuation">,</span> <span class="token number">0.00852748</span><span class="token punctuation">,</span> <span class="token number">0.748096</span>  <span class="token punctuation">,</span> <span class="token number">0.46975034</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0.42213044</span><span class="token punctuation">,</span> <span class="token number">0.5887971</span> <span class="token punctuation">,</span> <span class="token number">0.7810232</span> <span class="token punctuation">,</span> <span class="token number">0.9806169</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0.40125194</span><span class="token punctuation">,</span> <span class="token number">0.4384725</span> <span class="token punctuation">,</span> <span class="token number">0.48458642</span><span class="token punctuation">,</span> <span class="token number">0.47913405</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0.25977597</span><span class="token punctuation">,</span> <span class="token number">0.435113</span>  <span class="token punctuation">,</span> <span class="token number">0.27290097</span><span class="token punctuation">,</span> <span class="token number">0.4483906</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0.38884488</span><span class="token punctuation">,</span> <span class="token number">0.41798416</span><span class="token punctuation">,</span> <span class="token number">0.41393432</span><span class="token punctuation">,</span> <span class="token number">0.4339822</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span><span class="token number">0.5885266</span> <span class="token punctuation">,</span> <span class="token number">0.65331775</span><span class="token punctuation">,</span> <span class="token number">0.62330776</span><span class="token punctuation">,</span> <span class="token number">0.6913476</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span><span class="token operator">&gt;</span>
</code></pre> 
<p>我们将这些候选区域绘制在图像上，需要获取绝对位置：</p> 
<pre><code class="prism language-python"><span class="token comment"># 绘制在图像上(将proposal绘制在图像上)visualize.draw_boxes(rgd_image[0],boxes=proposals[:,:4]*1216)plt.show()</span>
</code></pre> 
<p>如下图所示：</p> 
<p><img src="https://images2.imgbox.com/39/96/aywPtX8E_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="FastRCNN_214"></a>FastRCNN进行目标检测</h5> 
<p>我们将获取的候选区域送入到Fast RCNN网络中进行检测：</p> 
<pre><code class="prism language-python"><span class="token comment"># rcnn进行预测,得到的是原图像的检测结果：</span>
<span class="token comment"># 输入：要检测的送入网络中的图像，图像的元信息，RPN产生的候选区域</span>
<span class="token comment"># 输出：目标检测结果：检测框(相对于原图像)，类别，置信度</span>
res <span class="token operator">=</span> model<span class="token punctuation">.</span>simple_test_bboxes<span class="token punctuation">(</span>image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>imagemeta<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>proposals<span class="token punctuation">)</span>
</code></pre> 
<p>res是一个字典，其结果如下所示：rois是目标框，class_ids是所属的类别，scores是置信度。</p> 
<pre><code class="prism language-python"><span class="token punctuation">{<!-- --></span><span class="token string">'rois'</span><span class="token punctuation">:</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">95.65208</span>   <span class="token punctuation">,</span>   <span class="token number">8.963474</span>  <span class="token punctuation">,</span> <span class="token number">370.8639</span>    <span class="token punctuation">,</span> <span class="token number">224.11072</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">57.620296</span>  <span class="token punctuation">,</span> <span class="token number">226.60101</span>   <span class="token punctuation">,</span> <span class="token number">159.39307</span>   <span class="token punctuation">,</span> <span class="token number">310.5221</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">86.15405</span>   <span class="token punctuation">,</span> <span class="token number">323.98065</span>   <span class="token punctuation">,</span> <span class="token number">369.12762</span>   <span class="token punctuation">,</span> <span class="token number">497.70337</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">83.67178</span>   <span class="token punctuation">,</span> <span class="token number">170.96815</span>   <span class="token punctuation">,</span> <span class="token number">135.69716</span>   <span class="token punctuation">,</span> <span class="token number">221.05861</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">74.37474</span>   <span class="token punctuation">,</span> <span class="token number">327.855</span>     <span class="token punctuation">,</span> <span class="token number">210.86298</span>   <span class="token punctuation">,</span> <span class="token number">422.48798</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">73.24604</span>   <span class="token punctuation">,</span>   <span class="token number">0.97371644</span><span class="token punctuation">,</span> <span class="token number">206.86272</span>   <span class="token punctuation">,</span>  <span class="token number">47.992523</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">63.968616</span>  <span class="token punctuation">,</span> <span class="token number">256.5716</span>    <span class="token punctuation">,</span> <span class="token number">192.52466</span>   <span class="token punctuation">,</span> <span class="token number">365.3871</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">67.055145</span>  <span class="token punctuation">,</span>  <span class="token number">88.534515</span>  <span class="token punctuation">,</span> <span class="token number">137.3221</span>    <span class="token punctuation">,</span> <span class="token number">130.74608</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">227.8164</span>    <span class="token punctuation">,</span> <span class="token number">291.93015</span>   <span class="token punctuation">,</span> <span class="token number">370.9528</span>    <span class="token punctuation">,</span> <span class="token number">434.4086</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">147.73048</span>   <span class="token punctuation">,</span> <span class="token number">218.15501</span>   <span class="token punctuation">,</span> <span class="token number">177.35306</span>   <span class="token punctuation">,</span> <span class="token number">260.56738</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span> <span class="token number">82.44483</span>   <span class="token punctuation">,</span>  <span class="token number">40.140255</span>  <span class="token punctuation">,</span> <span class="token number">133.15623</span>   <span class="token punctuation">,</span> <span class="token number">107.72627</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">122.62652</span>   <span class="token punctuation">,</span> <span class="token number">239.552</span>     <span class="token punctuation">,</span> <span class="token number">141.19394</span>   <span class="token punctuation">,</span> <span class="token number">272.06354</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">154.03288</span>   <span class="token punctuation">,</span> <span class="token number">115.91441</span>   <span class="token punctuation">,</span> <span class="token number">372.5167</span>    <span class="token punctuation">,</span> <span class="token number">426.57187</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">218.90562</span>   <span class="token punctuation">,</span> <span class="token number">364.88345</span>   <span class="token punctuation">,</span> <span class="token number">247.20554</span>   <span class="token punctuation">,</span> <span class="token number">419.03842</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">248.15126</span>   <span class="token punctuation">,</span> <span class="token number">407.61325</span>   <span class="token punctuation">,</span> <span class="token number">373.63068</span>   <span class="token punctuation">,</span> <span class="token number">479.57568</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">139.69551</span>   <span class="token punctuation">,</span> <span class="token number">248.66753</span>   <span class="token punctuation">,</span> <span class="token number">154.51906</span>   <span class="token punctuation">,</span> <span class="token number">264.16055</span>   <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">212.88734</span>   <span class="token punctuation">,</span> <span class="token number">195.23204</span>   <span class="token punctuation">,</span> <span class="token number">238.25243</span>   <span class="token punctuation">,</span> <span class="token number">209.22202</span>   <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">'class_ids'</span><span class="token punctuation">:</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       dtype<span class="token operator">=</span>int32<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">'scores'</span><span class="token punctuation">:</span> array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.99917287</span><span class="token punctuation">,</span> <span class="token number">0.992269</span>  <span class="token punctuation">,</span> <span class="token number">0.99193186</span><span class="token punctuation">,</span> <span class="token number">0.98929125</span><span class="token punctuation">,</span> <span class="token number">0.986894</span>  <span class="token punctuation">,</span>
        <span class="token number">0.98671734</span><span class="token punctuation">,</span> <span class="token number">0.98594207</span><span class="token punctuation">,</span> <span class="token number">0.97716457</span><span class="token punctuation">,</span> <span class="token number">0.97271395</span><span class="token punctuation">,</span> <span class="token number">0.97136974</span><span class="token punctuation">,</span>
        <span class="token number">0.9637522</span> <span class="token punctuation">,</span> <span class="token number">0.9585419</span> <span class="token punctuation">,</span> <span class="token number">0.9218482</span> <span class="token punctuation">,</span> <span class="token number">0.8920589</span> <span class="token punctuation">,</span> <span class="token number">0.85597926</span><span class="token punctuation">,</span>
        <span class="token number">0.81343234</span><span class="token punctuation">,</span> <span class="token number">0.78660023</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre> 
<p>将检测结果展示在图像上：</p> 
<pre><code class="prism language-python"><span class="token comment"># 将检测结果绘制在图像上visualize.display_instances(ori_img,res['rois'],res['class_ids'],classes,res['scores'])plt.show()</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0b/79/BEmaK2dO_o.png" alt="在这里插入图片描述"></p> 
<p>上述我们介绍了Faster RCNN的工作流程并且给大家展示了网络的检测结果。那接下来我们解决以下几个问题：</p> 
<p>1、网络中的每一部分是怎么构建，怎么完成相应的功能的？</p> 
<p>2、怎么训练fastrcnn网络去完成我们自己的任务？</p> 
<p>那接下来我们就解决上述问题。</p> 
<h3><a id="_272"></a>模型结构详解</h3> 
<p>Faster RCNN的网络结构如下图所示：</p> 
<p><img src="https://images2.imgbox.com/07/d5/oydxOXfm_o.png" alt="在这里插入图片描述"></p> 
<p>我们依然将网络分为四部分：</p> 
<ul><li><strong>Backbone</strong>：Backbone由CNN卷积神经网络构成，常用的是VGG和resnet, 用来提取图像中的特征，获取图像的特征图。该特征图被共享用于后续RPN层生成候选区域和ROIPooling层中。</li><li><strong>RPN网络</strong>：RPN网络用于生成候选区域，用于后续的目标检测。</li><li><strong>Roi Pooling</strong>: 该部分收集图像的特征图和RPN网络提取的候选区域位置，综合信息后获取固定尺寸的特征，送入后续全连接层判定目标类别和确定目标位置。</li><li><strong>目标分类与回归</strong>: 该部分利用ROIpooling输出特征向量计算候选区域的类别，并通过回归获得检测框最终的精确位置。</li></ul> 
<p>接下来我们就从这四个方面来详细分析fasterRCNN网络的构成，并结合源码理解每一部分实现的功能。</p> 
<h4><a id="backbone_289"></a>backbone</h4> 
<p>backbone一般为VGG，ResNet等网络构成，主要进行特征提取，将最后的全连接层舍弃，得到特征图送入后续网络中进行处理。</p> 
<p><img src="https://images2.imgbox.com/28/ca/4mgtOZb9_o.png" alt="在这里插入图片描述"></p> 
<p>在源码中使用ResNet + FPN 结构来提取特征。与普通的 FasterRCNN 只需要将一个特征图输入到后续网络中不同，由于加入 FPN结构，需要将多个特征图逐个送入到后续网络中，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/fc/5d/fFV8u3ry_o.png" alt="在这里插入图片描述"></p> 
<p>Resnet进行特征提取，FPN结构作用是当前层的特征图会融合未来层的特征进行上采样，并加以利用。因为有了这样一个结构，当前的特征图就可以获取未来层的信息，也就将低阶特征与高阶特征就有机融合起来了，提升检测精度。如下图所示：</p> 
<p><img src="https://images2.imgbox.com/08/39/TdoWFTEC_o.png" alt="在这里插入图片描述"></p> 
<p>在这里ResNet和FPN的完整结构如下图所示:Resnet进行特征提取，FPN网络进行特征融合获取多个特征图后，输入到RPN网络中的特征图是[p2,p3,p4,p5,p6] ，而作为后续目标检测网络FastRCNN的输入则是 [p2,p3,p4,p5] 。</p> 
<p><img src="https://images2.imgbox.com/97/94/sNqzekG4_o.png" alt="在这里插入图片描述"></p> 
<p>我们看下源码实现的内容：</p> 
<p>1、resnet特征提取的结果</p> 
<pre><code class="prism language-python"><span class="token comment"># 使用backbone获取特征图C2,C3,C4,C5 = model.backbone(image,training=False)</span>
</code></pre> 
<p>C2,C3,C4,C5是resnet进行特征提取的结果，送入网络中图像大小为（1216，1216，3），经过特征提取后特征图的大小为：</p> 
<pre><code class="prism language-python"><span class="token comment"># C2.shape:1216/4 TensorShape([1, 304, 304, 256])# C3.shape:1216/8TensorShape([1, 152, 152, 512])# C4.shape:1216/16TensorShape([1, 76, 76, 1024])# C5.shape:1216/32TensorShape([1, 38, 38, 2048])</span>
</code></pre> 
<p>2、FPN特征融合的结果</p> 
<pre><code class="prism language-python"><span class="token comment"># FPN网络融合：C2,C3,C4,C5是resnet提取的特征结果P2,P3,P4,P5,P6 = model.neck([C2,C3,C4,C5],training=False)</span>
</code></pre> 
<p>P2,P3,P4,P5,P6是特征融合之后的结果，送入后续网络中，其特征图的大小：</p> 
<pre><code class="prism language-python"><span class="token comment"># P2.shape:1216/4 </span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">304</span><span class="token punctuation">,</span> <span class="token number">304</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># P3.shape:1216/8</span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># P4.shape:1216/16</span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># P5.shape:1216/32</span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># P6.shape:1216/64</span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>那网络的整体架构表示成：</p> 
<p><img src="https://images2.imgbox.com/1a/d9/aDMGhehl_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-tRL6sg9m-1646211351952)(笔记图片/image-20201020144728158.png)]"></p> 
<h4><a id="RPN_355"></a>RPN网络</h4> 
<p>经典的检测方法生成检测框都非常耗时，如overfeat中使用滑动窗口生成检测框；或如R-CNN使用选择性搜索方法生成检测框。而Faster RCNN则抛弃了传统的滑动窗口和选择性搜索的方法，直接使用RPN生成候选区域，能极大提升检测速度。</p> 
<p><img src="https://images2.imgbox.com/50/8a/bkx7Q75y_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Fa7jfor6-1646211351952)(笔记图片/image-20200914165619471.png)]"></p> 
<p>RPN网络的主要流程是：</p> 
<p>1、生成一系列的固定参考框anchors,覆盖图像的任意位置，然后送入后续网络中进行分类和回归</p> 
<p>2、分类分支：通过softmax分类判断anchor中是否包含目标</p> 
<p>3、回归分支：计算目标框对于anchors的偏移量，以获得精确的候选区域</p> 
<p>4、最后的Proposal层则负责综合含有目标的anchors和对应bbox回归偏移量获取候选区域，同时剔除太小和超出边界的候选区域。</p> 
<h5><a id="anchors_372"></a>anchors</h5> 
<p>nchor在目标检测中表示 固定的参考框 ，首先预设一组不同尺度不同长宽比的固定参考框，覆盖几乎所有位置， 每个参考框负责检测与其交并比大于阈值 (训练预设值，常用0.5或0.7) 的目标 ，anchor技术将候选区域生成问题转换为 “这个固定参考框中有没有目标，目标框偏离参考框多远” ，不再需要多尺度遍历滑窗，真正实现了又好又快。</p> 
<p>在FastRCNN中框出多尺度、多种长宽比的anchors,如下图所示：下图中分别是尺度为32，64，128，长宽比为1：1，1:2，2：1的一组anchors,我们利用这组anchor在特征图上进行滑动，并对应到原图上即可获取一系列的固定参考框。</p> 
<p><img src="https://images2.imgbox.com/41/06/tBbqGc2D_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-DGFPl4KG-1646211351952)(笔记图片/image-20201230161949225.png)]"></p> 
<p>由于有 FPN 网络，所以会在多个不同尺度特征图中生成anchor，假设某一个特征图大小为hxw，首先会计算这个特征相对于输入图像的下采样倍数 stride：</p> 
<p><img src="https://images2.imgbox.com/c2/59/2R79YYzG_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-CVDUSclK-1646211351953)(笔记图片/image-20200917181250070.png)]"></p> 
<p>如下图所示：</p> 
<p><img src="https://images2.imgbox.com/e6/64/PiliUTbE_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-DXURxDsg-1646211351953)(笔记图片/image-20200917181349548.png)]"></p> 
<p>每一个尺度特征图上生成不同比列的anchor:</p> 
<p><img src="https://images2.imgbox.com/64/a9/5anSd94k_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-7HzOOyd2-1646211351953)(笔记图片/image-20201230162534596.png)]"></p> 
<p>得到一系列的anchors后就可送入后续网络中进行分类和回归。</p> 
<p>在源码中我们可生成一幅图像对应的anchors:</p> 
<pre><code class="prism language-python"><span class="token comment"># 产生anchor：输入图像元信息即可，输出anchor对应于原图的坐标值anchors,valid_flags = model.rpn_head.generator.generate_pyramid_anchors(imagemeta)</span>
</code></pre> 
<p>对于1216x1216的图像生成的anchor的数量为：</p> 
<pre><code class="prism language-python"><span class="token comment"># anchors.shape：#304*304*3+152*152*3+76*76*3+38*38*3+19*19*3=369303TensorShape([369303, 4])</span>
</code></pre> 
<p>anchor的取值为：</p> 
<pre><code class="prism language-python"><span class="token operator">&lt;</span>tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">369303</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">,</span> numpy<span class="token operator">=</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">22.627417</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">11.313708</span><span class="token punctuation">,</span>   <span class="token number">22.627417</span><span class="token punctuation">,</span>   <span class="token number">11.313708</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">.</span>      <span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">.</span>      <span class="token punctuation">,</span>   <span class="token number">16</span><span class="token punctuation">.</span>      <span class="token punctuation">,</span>   <span class="token number">16</span><span class="token punctuation">.</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">11.313708</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">22.627417</span><span class="token punctuation">,</span>   <span class="token number">11.313708</span><span class="token punctuation">,</span>   <span class="token number">22.627417</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span> <span class="token number">789.9613</span>  <span class="token punctuation">,</span>  <span class="token number">970.98065</span> <span class="token punctuation">,</span> <span class="token number">1514.0387</span>  <span class="token punctuation">,</span> <span class="token number">1333.0193</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span> <span class="token number">896</span><span class="token punctuation">.</span>      <span class="token punctuation">,</span>  <span class="token number">896</span><span class="token punctuation">.</span>      <span class="token punctuation">,</span> <span class="token number">1408</span><span class="token punctuation">.</span>      <span class="token punctuation">,</span> <span class="token number">1408</span><span class="token punctuation">.</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token punctuation">[</span> <span class="token number">970.98065</span> <span class="token punctuation">,</span>  <span class="token number">789.9613</span>  <span class="token punctuation">,</span> <span class="token number">1333.0193</span>  <span class="token punctuation">,</span> <span class="token number">1514.0387</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span><span class="token operator">&gt;</span>
</code></pre> 
<p>我们将前10000个anchor绘制在图像上：</p> 
<pre><code class="prism language-python"><span class="token comment"># 绘制在图像上(将anchor绘制在图像上)visualize.draw_boxes(rgd_image[0],boxes=anchors[:10000,:4])plt.show()</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/97/a6/QTfzi1CQ_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-IgEP9H8q-1646211351953)(笔记图片/image-20201230163402232.png)]"></p> 
<h5><a id="RPN_425"></a>RPN分类</h5> 
<p>一副MxN大小的矩阵送入Faster RCNN网络后，经过backbone特征提取到RPN网络变为HxW大小的特征图。如下图所示，是RPN进行分类的网络结构：(k=9)</p> 
<p><img src="https://images2.imgbox.com/66/49/hQpQVzPZ_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-SJLdGoUn-1646211351954)(笔记图片/image-20200914170316205.png)]"></p> 
<p>先做一个1x1的卷积，得到[batchsize,H,W,18]的特征图，然后进行变形,将特征图转换为[batchsize,9xH,W,2]的特征图后，送入softmax中进行分类，得到分类结果后，再进行reshape最终得到[batchsize,H,W,18]大小的结果,18表示k=9个anchor是否包含目标的概率值。</p> 
<p><img src="https://images2.imgbox.com/15/cf/wBMJqCVz_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-X3XcTpHI-1646211351955)(笔记图片/image-20200914170637421.png)]"></p> 
<h5><a id="RPN_437"></a>RPN回归</h5> 
<p>RPN回归的结构如下图所示：(k=9)</p> 
<p><img src="https://images2.imgbox.com/d3/63/pG4g9E9G_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-WuQsrmrW-1646211351955)(笔记图片/image-20200914173518689.png)]"></p> 
<p>经过该卷积输出特征图为为[1, H, W,4x9]，这里相当于feature maps每个点都有9个anchors，每个anchors又都有4个用于回归的:</p> 
<p><img src="https://images2.imgbox.com/cd/25/odKKndPs_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-UMs4iNmm-1646211351955)(笔记图片/image-20200914173617857.png)]"></p> 
<p>变换量。</p> 
<p>该变换量预测的是anchor与真实值之间的平移量和尺度因子：</p> 
<p><img src="https://images2.imgbox.com/a6/b6/wIy2ct4Y_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-IW1JXeCe-1646211351956)(笔记图片/image-20200914174033826.png)]"></p> 
<p>利用源码我们可以获得对anchors的分类和回归结果：</p> 
<pre><code class="prism language-python"><span class="token comment"># RPN网络的输入:FPN网络获取的特征图rpn_feature_maps = [P2,P3,P4,P5,P6]# RPN网络预测，返回：logits送入softmax之前的分数，包含目标的概率，对框的修正结果rpn_class_logits,rpn_probs,rpn_deltas = model.rpn_head(rpn_feature_maps,training = False)</span>
</code></pre> 
<p>结果分析：</p> 
<pre><code class="prism language-python"><span class="token comment"># rpn_class_logits.shape,每一个anchor都进行了分类分析TensorShape([1, 369303, 2])# rpn_probs.shape：softmax输出的概率值TensorShape([1, 369303, 2])# rpn_deltas.shape ：回归结果TensorShape([1, 369303, 4])</span>
</code></pre> 
<p>其中 rpn_probs的取值为：</p> 
<pre><code class="prism language-python"><span class="token operator">&lt;</span>tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">369303</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">,</span> numpy<span class="token operator">=</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">9.94552910e-01</span><span class="token punctuation">,</span> <span class="token number">5.44707105e-03</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">9.97310877e-01</span><span class="token punctuation">,</span> <span class="token number">2.68914248e-03</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">9.95540321e-01</span><span class="token punctuation">,</span> <span class="token number">4.45961533e-03</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">9.99888301e-01</span><span class="token punctuation">,</span> <span class="token number">1.11637215e-04</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">9.99961257e-01</span><span class="token punctuation">,</span> <span class="token number">3.87872169e-05</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">[</span><span class="token number">9.99820888e-01</span><span class="token punctuation">,</span> <span class="token number">1.79159630e-04</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span><span class="token operator">&gt;</span>
</code></pre> 
<p>我们获取一些分类置信度较高的结果，将这些anchor绘制在图像上：</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取分类结果中包含目标的概率值rpn_probs_tmp = rpn_probs[0,:,1]# 获取前100个较高的anchorlimit = 100ix = tf.nn.top_k(rpn_probs_tmp,k=limit).indices[::-1]# 获取对应的anchor绘制图像上，那这些anchor就有很大概率生成候选区域visualize.draw_boxes(rgd_image[0],tf.gather(anchors,ix).numpy())</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0b/c7/DQG6PTft_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-iYXud2SY-1646211351956)(笔记图片/image-20201230165534951.png)]"></p> 
<h5><a id="Proposal_483"></a>Proposal层</h5> 
<p>Proposal层负责综合RPN网络对anchors分类和回归的结果，利用回归的结果对包含目标的anchors进行修正，计算出候选区域，送入后续RoI Pooling层中。</p> 
<p>Proposal层处理流程如下：</p> 
<ol><li>利用RPN网络回归的结果<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          [ 
         
         
         
           d 
          
         
           x 
          
         
        
          ( 
         
        
          A 
         
        
          ) 
         
        
          , 
         
         
         
           d 
          
         
           y 
          
         
        
          ( 
         
        
          A 
         
        
          ) 
         
        
          , 
         
         
         
           d 
          
         
           w 
          
         
        
          ( 
         
        
          A 
         
        
          ) 
         
        
          , 
         
         
         
           d 
          
         
           h 
          
         
        
          ( 
         
        
          A 
         
        
          ) 
         
        
          ] 
         
        
       
         \left[d_{x}(A), d_{y}(A), d_{w}(A), d_{h}(A)\right] 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.03611em; vertical-align: -0.286108em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">[</span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">A</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03588em;" class="mord mathdefault mtight">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286108em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">A</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.02691em;" class="mord mathdefault mtight">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">A</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">A</span><span class="mclose">)</span><span class="mclose delimcenter" style="top: 0em;">]</span></span></span></span></span></span>对所有的anchors进行修正，得到修正后的检测框</li><li>根据RPN网络分类的softmax输出的概率值由大到小对检测框进行排序，提取前6000个结果，即提取修正位置后的检测框</li><li>限定超出图像边界的检测框为图像边界，防止后续roi pooling时候选区域超出图像边界。</li></ol> 
<p><img src="https://images2.imgbox.com/d0/38/HxbvTQpt_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-uUICKc5T-1646211351956)(笔记图片/image-20200914174724293.png)]"></p> 
<ol start="4"><li> <p>对剩余的检测框进行非极大值抑制NMS</p> </li><li> <p>Proposal层的输出是对应输入网络图像尺度的归一化后的坐标值[x1, y1, x2, y2]。</p> </li></ol> 
<p>到此RPN网络的工作就结束了。</p> 
<p>Proposal层有3个输入：RPN分类和回归结果，以及图像的元信息。</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取候选区域</span>
proposals_list <span class="token operator">=</span> model<span class="token punctuation">.</span>rpn_head<span class="token punctuation">.</span>get_proposals<span class="token punctuation">(</span>rpn_probs<span class="token punctuation">,</span>rpn_deltas<span class="token punctuation">,</span>imagemeta<span class="token punctuation">)</span>
</code></pre> 
<p>结果为：</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token operator">&lt;</span>tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1533</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">,</span> numpy<span class="token operator">=</span>
 array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.20729761</span><span class="token punctuation">,</span> <span class="token number">0.00852748</span><span class="token punctuation">,</span> <span class="token number">0.748096</span>  <span class="token punctuation">,</span> <span class="token number">0.46975034</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0.42213044</span><span class="token punctuation">,</span> <span class="token number">0.5887971</span> <span class="token punctuation">,</span> <span class="token number">0.7810232</span> <span class="token punctuation">,</span> <span class="token number">0.9806169</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0.40125194</span><span class="token punctuation">,</span> <span class="token number">0.4384725</span> <span class="token punctuation">,</span> <span class="token number">0.48458642</span><span class="token punctuation">,</span> <span class="token number">0.47913405</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0.25977597</span><span class="token punctuation">,</span> <span class="token number">0.435113</span>  <span class="token punctuation">,</span> <span class="token number">0.27290097</span><span class="token punctuation">,</span> <span class="token number">0.4483906</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0.38884488</span><span class="token punctuation">,</span> <span class="token number">0.41798416</span><span class="token punctuation">,</span> <span class="token number">0.41393432</span><span class="token punctuation">,</span> <span class="token number">0.4339822</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0.5885266</span> <span class="token punctuation">,</span> <span class="token number">0.65331775</span><span class="token punctuation">,</span> <span class="token number">0.62330776</span><span class="token punctuation">,</span> <span class="token number">0.6913476</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
</code></pre> 
<p>将其绘制在图像上</p> 
<pre><code class="prism language-python"><span class="token comment"># 绘制在图像上(将proposal绘制在图像上)</span>
visualize<span class="token punctuation">.</span>draw_boxes<span class="token punctuation">(</span>rgd_image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>boxes<span class="token operator">=</span>proposals_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">1216</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/4e/c6/sUsoH0Wk_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-8PvwJkl4-1646211351957)(笔记图片/image-20201230171056236.png)]"></p> 
<h4><a id="ROIPooling_533"></a>ROIPooling</h4> 
<p>RoI Pooling层则负责收集RPN网络生成的候选区域，并将其映射到特征图中并固定维度，送入后续网络中进行分类和回归。</p> 
<p><img src="https://images2.imgbox.com/d4/6e/peKAeF1Y_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-bTdxQYm8-1646211351957)(笔记图片/image-20201021100152187.png)]"></p> 
<p>RoI Pooling 的作用过程，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/ff/3c/HsBAVk44_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-nk41pLhS-1646211351958)(笔记图片/image-20201021101351332.png)]"></p> 
<p>RoIpooling使用最大池化将任何有效的RoI区域内的特征转换成具有pool_H×pool_W的固定空间范围的小的特征图，其中pool_H和pool_W是超参数，比如设置为7x7, 它们独立于任何特定的RoI,如下图所示：</p> 
<p><img src="https://images2.imgbox.com/da/a4/CkdtZrrL_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-0QABuEYQ-1646211351958)(笔记图片/image-20201021100421465.png)]"></p> 
<p>在实现过程中，FPN网络产生了多个尺度特征图，那候选区域要映射到哪个特征图中呢？</p> 
<p><img src="https://images2.imgbox.com/91/2d/D6hPE9jU_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-5fNDGHbx-1646211351959)(笔记图片/image-20201021101441266.png)]"></p> 
<p>在这里，不同尺度的ROI使用不同特征层作为ROI pooling层的输入，大尺度ROI就用后面一些的金字塔层，比如P5；小尺度ROI就用前面一点的特征层，比如P3，我们使用下面的公式确定ROI所在的特征层：</p> 
<p><img src="https://images2.imgbox.com/d0/6d/Krx1TQRc_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-K3rGLrTT-1646211351959)(笔记图片/image-20201021102107570.png)]"></p> 
<p>其中，224是ImageNet的标准输入，k0是基准值，设置为4，w和h是ROI区域的长和宽，假设ROI是112x112的大小，那么k = k0-1 = 4-1 = 3，意味着该ROI应该使用P3的特征层。k值会做取整处理，防止结果不是整数，而且为了保证k值在2-5之间，还会做截断处理。</p> 
<pre><code class="prism language-python"><span class="token comment"># ROI Pooling层实现:输入是候选区域，特征图，图像的元信息</span>
pool_region_list <span class="token operator">=</span> model<span class="token punctuation">.</span>roi_align<span class="token punctuation">(</span><span class="token punctuation">(</span>proposals_list<span class="token punctuation">,</span>rcnn_feature_maps<span class="token punctuation">,</span>imagemeta<span class="token punctuation">)</span><span class="token punctuation">,</span>training <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出结果为：每一个候选区域都被固定为7x7大小</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token operator">&lt;</span>tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1533</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">,</span> numpy<span class="token operator">=</span>
 array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6.26428795e+00</span><span class="token punctuation">,</span>  <span class="token number">3.55317879e+00</span><span class="token punctuation">,</span>  <span class="token number">3.37260556e+00</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
            <span class="token number">6.22574663e+00</span><span class="token punctuation">,</span>  <span class="token number">3.75851846e+00</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2.49103808e+00</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">9.01443863e+00</span><span class="token punctuation">,</span>  <span class="token number">7.67611027e-01</span><span class="token punctuation">,</span>  <span class="token number">7.18744850e+00</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
            <span class="token number">6.20492172e+00</span><span class="token punctuation">,</span>  <span class="token number">4.09835625e+00</span><span class="token punctuation">,</span>  <span class="token number">6.05924249e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">7.43907213e+00</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.76329374e+00</span><span class="token punctuation">,</span>  <span class="token number">5.01457691e+00</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
            <span class="token number">6.22656918e+00</span><span class="token punctuation">,</span>  <span class="token number">1.19414163e+00</span><span class="token punctuation">,</span>  <span class="token number">3.06410480e+00</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span> <span class="token number">1.39127302e+00</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.71078873e+00</span><span class="token punctuation">,</span>  <span class="token number">4.01916075e+00</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
            <span class="token number">5.94641972e+00</span><span class="token punctuation">,</span>  <span class="token number">3.63194764e-01</span><span class="token punctuation">,</span>  <span class="token number">2.91014194e+00</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5.21681070e+00</span><span class="token punctuation">,</span>  <span class="token number">2.39917469e+00</span><span class="token punctuation">,</span>  <span class="token number">2.49682212e+00</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
            <span class="token number">5.92232943e+00</span><span class="token punctuation">,</span>  <span class="token number">3.01222801e+00</span><span class="token punctuation">,</span>  <span class="token number">1.63518691e+00</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1.26697767e+00</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">6.90211892e-01</span><span class="token punctuation">,</span>  <span class="token number">4.50919747e-01</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
            <span class="token number">1.97156405e+00</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.07467103e+00</span><span class="token punctuation">,</span>  <span class="token number">4.54943466e+00</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<h4><a id="_586"></a>目标分类与回归</h4> 
<p>该部分利用获得的候选区域的特征图，通过全连接层与softmax计算每个候选区域具体属于的类别（如人，车，电视等），输出概率值；同时再次利用回归方法获得每个候选区域的位置偏移量，用于回归更加精确的目标检测框。该部分网络结构如下所示：</p> 
<p><img src="https://images2.imgbox.com/d7/40/dKR3nRGE_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-HqNYDSHF-1646211351960)(笔记图片/image-20200914175906233.png)]"></p> 
<p>从RoI Pooling层获取到固定大小的特征图后，送入后续网络，可以看到做了如下2件事：</p> 
<ol><li>通过全连接和softmax对候选区域进行分类</li><li>再次对候选区域进行回归修正，获取更高精度的检测框</li></ol> 
<p>实现流程如下：</p> 
<p>首先获取网络分类和回归的结果：</p> 
<pre><code class="prism language-python"><span class="token comment"># RCNN网络的预测:输入是ROIPooling层的特征，输出：类别的score,类别的概率值，回归结果rcnn_class_logits,rcnn_class_probs,rcnn_deltas_list = model.bbox_head(pool_region_list,training=False）</span>
</code></pre> 
<p>利用结果对候选区域进行修正：</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取预测结果:输入：rcnn返回的分类和回归结果，候选区域，图像元信息，输出：目标检测结果detection_list = model.bbox_head.get_bboxes(rcnn_class_probs,rcnn_deltas_list,proposals_list,imagemeta)</span>
</code></pre> 
<p>结果为：一共检测出17个目标，每个目标右目标位置，目标类别id，目标类别置信度6个值构成。</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token operator">&lt;</span>tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">,</span> numpy<span class="token operator">=</span>
 array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2.3262584e+02</span><span class="token punctuation">,</span> <span class="token number">2.1799168e+01</span><span class="token punctuation">,</span> <span class="token number">9.0194098e+02</span><span class="token punctuation">,</span> <span class="token number">5.4503723e+02</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.9917287e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">1.4013255e+02</span><span class="token punctuation">,</span> <span class="token number">5.5109363e+02</span><span class="token punctuation">,</span> <span class="token number">3.8764392e+02</span><span class="token punctuation">,</span> <span class="token number">7.5518970e+02</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.9226898e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">2.0952664e+02</span><span class="token punctuation">,</span> <span class="token number">7.8792090e+02</span><span class="token punctuation">,</span> <span class="token number">8.9771838e+02</span><span class="token punctuation">,</span> <span class="token number">1.2104146e+03</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.9193186e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">2.0348978e+02</span><span class="token punctuation">,</span> <span class="token number">4.1579453e+02</span><span class="token punctuation">,</span> <span class="token number">3.3001547e+02</span><span class="token punctuation">,</span> <span class="token number">5.3761450e+02</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.8929125e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">1.8087936e+02</span><span class="token punctuation">,</span> <span class="token number">7.9734338e+02</span><span class="token punctuation">,</span> <span class="token number">5.1281873e+02</span><span class="token punctuation">,</span> <span class="token number">1.0274907e+03</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.8689401e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">1.7813437e+02</span><span class="token punctuation">,</span> <span class="token number">2.3680782e+00</span><span class="token punctuation">,</span> <span class="token number">5.0309012e+02</span><span class="token punctuation">,</span> <span class="token number">1.1671781e+02</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.8671734e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">1.5557167e+02</span><span class="token punctuation">,</span> <span class="token number">6.2398212e+02</span><span class="token punctuation">,</span> <span class="token number">4.6821997e+02</span><span class="token punctuation">,</span> <span class="token number">8.8862134e+02</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.8594207e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">1.6307811e+02</span><span class="token punctuation">,</span> <span class="token number">2.1531593e+02</span><span class="token punctuation">,</span> <span class="token number">3.3396735e+02</span><span class="token punctuation">,</span> <span class="token number">3.1797446e+02</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.7716457e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">5.5404950e+02</span><span class="token punctuation">,</span> <span class="token number">7.0997412e+02</span><span class="token punctuation">,</span> <span class="token number">9.0215717e+02</span><span class="token punctuation">,</span> <span class="token number">1.0564817e+03</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.7271395e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3.5928052e+02</span><span class="token punctuation">,</span> <span class="token number">5.3055298e+02</span><span class="token punctuation">,</span> <span class="token number">4.3132263e+02</span><span class="token punctuation">,</span> <span class="token number">6.3369983e+02</span><span class="token punctuation">,</span>
         <span class="token number">4.6000000e+01</span><span class="token punctuation">,</span> <span class="token number">9.7136974e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">2.0050583e+02</span><span class="token punctuation">,</span> <span class="token number">9.7621101e+01</span><span class="token punctuation">,</span> <span class="token number">3.2383597e+02</span><span class="token punctuation">,</span> <span class="token number">2.6199030e+02</span><span class="token punctuation">,</span>
         <span class="token number">1.0000000e+00</span><span class="token punctuation">,</span> <span class="token number">9.6375221e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">2.9822769e+02</span><span class="token punctuation">,</span> <span class="token number">5.8259045e+02</span><span class="token punctuation">,</span> <span class="token number">3.4338364e+02</span><span class="token punctuation">,</span> <span class="token number">6.6165851e+02</span><span class="token punctuation">,</span>
         <span class="token number">4.6000000e+01</span><span class="token punctuation">,</span> <span class="token number">9.5854193e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3.7460797e+02</span><span class="token punctuation">,</span> <span class="token number">2.8190384e+02</span><span class="token punctuation">,</span> <span class="token number">9.0596057e+02</span><span class="token punctuation">,</span> <span class="token number">1.0374227e+03</span><span class="token punctuation">,</span>
         <span class="token number">6.1000000e+01</span><span class="token punctuation">,</span> <span class="token number">9.2184818e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">5.3237848e+02</span><span class="token punctuation">,</span> <span class="token number">8.8739655e+02</span><span class="token punctuation">,</span> <span class="token number">6.0120386e+02</span><span class="token punctuation">,</span> <span class="token number">1.0191014e+03</span><span class="token punctuation">,</span>
         <span class="token number">4.6000000e+01</span><span class="token punctuation">,</span> <span class="token number">8.9205891e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">6.0350385e+02</span><span class="token punctuation">,</span> <span class="token number">9.9131537e+02</span><span class="token punctuation">,</span> <span class="token number">9.0866974e+02</span><span class="token punctuation">,</span> <span class="token number">1.1663280e+03</span><span class="token punctuation">,</span>
         <span class="token number">5.7000000e+01</span><span class="token punctuation">,</span> <span class="token number">8.5597926e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">3.3973947e+02</span><span class="token punctuation">,</span> <span class="token number">6.0475940e+02</span><span class="token punctuation">,</span> <span class="token number">3.7579034e+02</span><span class="token punctuation">,</span> <span class="token number">6.4243842e+02</span><span class="token punctuation">,</span>
         <span class="token number">4.5000000e+01</span><span class="token punctuation">,</span> <span class="token number">8.1343234e-01</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">5.1774200e+02</span><span class="token punctuation">,</span> <span class="token number">4.7480432e+02</span><span class="token punctuation">,</span> <span class="token number">5.7942987e+02</span><span class="token punctuation">,</span> <span class="token number">5.0882794e+02</span><span class="token punctuation">,</span>
         <span class="token number">4.0000000e+01</span><span class="token punctuation">,</span> <span class="token number">7.8660023e-01</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
</code></pre> 
<p>可以将其绘制在图像上：</p> 
<pre><code class="prism language-python"><span class="token comment"># 绘制在图像上</span>
visualize<span class="token punctuation">.</span>draw_boxes<span class="token punctuation">(</span>rgd_image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>boxes<span class="token operator">=</span>detection_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span>）
</code></pre> 
<p><img src="https://images2.imgbox.com/92/df/hEz8Yyoo_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-g7amx6pB-1646211351961)(笔记图片/image-20201230173439116.png)]"></p> 
<p>到这我们就完成了整个网络的介绍。</p> 
<h3><a id="FasterRCNN_665"></a>FasterRCNN的训练</h3> 
<p>Faster R-CNN的训练分为两部分，即RPN网络和检测网络fastRCNN的训练：</p> 
<p><img src="https://images2.imgbox.com/a6/d6/Mxrj4vKU_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-mOQUwzp2-1646211351961)(笔记图片/image-20200914180529313.png)]"></p> 
<p>整个训练过程分为四步：</p> 
<ul><li>第一步：RPN网络的训练，使用ImageNet预训练的模型初始化，并端到端微调用于区域建议任务。</li><li>第二步：利用第一步的RPN生成的建议框，由Fast R-CNN训练一个单独的检测网络，这个检测网络同样是由ImageNet预训练的模型初始化的，这时候两个网络还没有共享卷积层。</li><li>第三步：用检测网络初始化RPN训练，但是固定共享的卷积层，并且只微调RPN独有的层，现在两个网络共享卷积层了。</li><li>第四步：保持共享的卷积层固定，微调Fast R-CNN的fc层。这样，两个网络共享相同的卷积层，构成一个统一的网络。</li></ul> 
<p><img src="https://images2.imgbox.com/6b/26/CcdFPk5m_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-hjXER8WM-1646211351962)(笔记图片/image-20200914180732315.png)]"></p> 
<p>接下来我们分别介绍各个训练步骤。</p> 
<h4><a id="RPN_684"></a>RPN网络的训练</h4> 
<p>RPN网络的作用从众多的anchors中提取包含目标的，并且经过回归调整的候选区域。为了训练RPN，给每个anchor分配是否包含目标的标签，也就是正负样本的标记，然后进行训练。</p> 
<h5><a id="_688"></a>正负样本标记</h5> 
<ul><li>与真实框ground truth（GT）交并比IOU大于0.7的anchor是正样本，即anchor中包含目标，目标值设为1</li><li>与真实框ground truth（GT）交并比IOU小于0.3的anchor是负样本，即anchor中不包含目标，目标值设为-1</li><li>其他的anchor舍弃，不参与网络的训练，目标值设为0</li></ul> 
<h5><a id="RPN_694"></a>RPN网络的损失函数</h5> 
<p>RPN网络的损失函数是：</p> 
<p><img src="https://images2.imgbox.com/ec/ca/wrgAB5t7_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-gKMensMt-1646211351962)(笔记图片/image-20200915095837059.png)]"></p> 
<p>其中</p> 
<ul><li>i表示anchor的索引</li><li>pi是第i个anchor 预测为目标的可能性，pi*为ground-truth标签。如果这个anchor是positive的，则ground-truth标签为1，否则为0。（即当第i个anchor与GT间IoU&gt;0.7，认为是该anchor是positive，标签为1；反之IoU&lt;0.3时，认为是该anchor是negative，标签为0）</li><li>ti表示表示正样本anchor到预测区域bounding box的4个参数化预测结果,ti*是这个positive anchor对应的ground-truth box的偏移，如下所示：</li></ul> 
<p>预测值：</p> 
<p><img src="https://images2.imgbox.com/36/56/y2pUOu9R_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-N9PKkRRI-1646211351962)(笔记图片/image-20200915101257709.png)]"></p> 
<p>真实值：</p> 
<p><img src="https://images2.imgbox.com/3c/c9/yqr2F1KX_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-vWMEZ1Gm-1646211351963)(笔记图片/image-20200915101314285.png)]"></p> 
<p>其中，x，y，w，h表示窗口中心坐标和窗口的宽度和高度，变量x， xa和x* 分别表示预测窗口、anchor窗口和Ground Truth的坐标（y，w，h同理）</p> 
<p>整个Loss分为两部分：分类和回归的损失</p> 
<ul><li>Lcls分类的损失（classification loss），是一个二分类器的softmax loss。</li></ul> 
<p><img src="https://images2.imgbox.com/83/b9/LPZRYQz9_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-jTFvo6m7-1646211351964)(笔记图片/image-20200915100858122.png)]"></p> 
<ul><li>Lreg是回归损失，为smooth(x)损失,并且只有正样本才参与回归损失计算</li></ul> 
<p><img src="https://images2.imgbox.com/c9/40/xKj9heoc_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-TlHJQK6y-1646211351964)(笔记图片/image-20200915100839788.png)]"></p> 
<ul><li>Ncls和Nreg分别用来标准化分类损失项Lcls和回归损失项Lreg，默认用batch size设置Ncls，用anchor位置数目~2000初始化Nreg</li><li>Ncls和Nreg相差过大，用参数λ来平衡两者，一般取值为Nreg和Ncls的比值10即可。</li></ul> 
<h5><a id="_734"></a>训练过程</h5> 
<p>在训练时每次迭代的正负样本是由一幅图像的正负样本组成的：</p> 
<ul><li>随机采样256个anchor，计算损失函数，其中采样的正负anchor的比例是1:1。</li><li>通过从零均值标准差为0.01的高斯分布中获取的权重来随机初始化所有新层（最后一个卷积层其后的层），所有其他层（即共享的卷积层）是通过对ImageNet分类预训练的模型来初始化的</li><li>采用带动量的随机梯度下降算法对网络进行训练</li></ul> 
<h5><a id="_742"></a>实现</h5> 
<h6><a id="_744"></a>正负样本设置</h6> 
<p>将产生的369303个anchor与目标真实值的计算交并比设置正负样本：</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取对应的目标值：输入：要设置正负样本的anchors，anchor在有效区域的标识，样本标记的bbox及类别label；输出：rpn的分类目标值，RPN的回归目标值</span>
rpn_target_matchs<span class="token punctuation">,</span>rpn_target_deltas <span class="token operator">=</span> model<span class="token punctuation">.</span>rpn_head<span class="token punctuation">.</span>anchor_target<span class="token punctuation">.</span>build_targets<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span>valid_flags<span class="token punctuation">,</span>bbox<span class="token punctuation">,</span>label<span class="token punctuation">)</span>
</code></pre> 
<p>所有的anchor都设置了分类的目标值，回归的目标值只有正负样本设置了目标值，一共有369303个Anchor，参与训练的有256个anchor。</p> 
<pre><code class="prism language-python"><span class="token comment"># rpn_target_matchs.shape</span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">369303</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># rpn_target_deltas.shape</span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>获取正样本：正样本是包含目标的anchor，其目标值设为1，正样本的个数是29个</p> 
<pre><code class="prism language-python"><span class="token comment"># 属于正样本的anchors，与GT交并比较大的anchor,目标值设为1</span>
positive_anchors <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span>tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>equal<span class="token punctuation">(</span>rpn_target_matchs<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 正样本的个数：一共使用29个属于正样本的anchor</span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>我们将这些正样本绘制在图像上：可以看出这些anchor与目标还是非常接近的</p> 
<p><img src="https://images2.imgbox.com/7a/3b/oIMKxjRd_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Fo5muquD-1646211351964)(笔记图片/image-20201231095921098.png)]"></p> 
<p>接下来，我们看下负样本的结果，负样本的目标值是-1，负样本的个数是227，与29个正样本一共是256个anchor参与网络训练，其余的不参与网络训练。</p> 
<pre><code class="prism language-python"><span class="token comment"># 负样本</span>
negtivate_anchors <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span>tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>equal<span class="token punctuation">(</span>rpn_target_matchs<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># negtivate_anchors.shape</span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">227</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>同样我们也将负样本展示在图像上，从图像可以看出这些负样本的anchor与目标差距还是很大的。</p> 
<p><img src="https://images2.imgbox.com/5b/30/1vVlm9W9_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-wB4KNZ56-1646211351965)(笔记图片/image-20201231100516539.png)]"></p> 
<h6><a id="_790"></a>损失函数</h6> 
<p>损失函数计算是将网络预测结果和真实值进行比较，获取两者之间的差别。损失函数由两部分组成：分类和回归</p> 
<pre><code class="prism language-python"><span class="token comment"># RPN网络的损失函数# 输入：rpn的分类结果rpn_class_logits，rpn的回归结果，bbox标注框，label是目标累呗，imagemera图像元信息# 输出：分类损失和回归损失rpn_class_loss, rpn_bbox_loss = model.rpn_head.loss(                rpn_class_logits, rpn_deltas, bbox, label, imagemeta)# 分类损失：rpn_bbox_loss&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.20614956&gt;# 回归损失：rpn_class_loss&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.034301624&gt;</span>
</code></pre> 
<p>接下来我们使用梯度下降算法对网络进行训练就可以了</p> 
<h4><a id="FastRCNN_800"></a>FastRCNN网络的训练</h4> 
<p>使用RPN网络收集到的候选区域和imageNet预训练的卷积网络提取的特征对检测的FastRCNN网络进行训练。</p> 
<h5><a id="_804"></a>正负样本标记</h5> 
<p>在FastRCNN网络训练时：</p> 
<ul><li>首先将与真实框ground truth（GT）交并比IOU大于0.5的候选区域设为正样本，类别的目标值是GT的类别</li><li>将与真实框ground truth（GT）交并比IOU小于0.5的候选区域设为负样本，类别的目标值是0</li></ul> 
<h5><a id="FastRCNN_811"></a>FastRCNN的损失函数</h5> 
<p>FastRCNN的输出由两部分组成：一部分是softmax层进行分类，输出类别有K个类别加上”背景”类，另一部分是回归bounding box regressor。也就是：</p> 
<ul><li>一部分输出在K+1个类别上的离散概率分布（每个候选区域），p=(p0,p1,…,pk)。通常，通过全连接层的K+1个输出上的Softmax来计算p。</li><li>另一部分输出对于由K个类别中的每一个检测框回归偏移，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           t 
          
         
           k 
          
         
        
          = 
         
         
         
           ( 
          
          
          
            t 
           
          
            x 
           
          
            k 
           
          
         
           , 
          
          
          
            t 
           
          
            y 
           
          
            k 
           
          
         
           , 
          
          
          
            t 
           
          
            w 
           
          
            k 
           
          
         
           , 
          
          
          
            t 
           
          
            h 
           
          
            k 
           
          
         
           ) 
          
         
        
       
         t^{k}=\left(t_{x}^{k}, t_{y}^{k}, t_{w}^{k}, t_{h}^{k}\right) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.23311em; vertical-align: -0.383108em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03588em;" class="mord mathdefault mtight">y</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.383108em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.02691em;" class="mord mathdefault mtight">w</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -2.41689em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.283108em;"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size1">)</span></span></span></span></span></span></span>。其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           t 
          
         
           k 
          
         
        
       
         t^{k} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span></span></span></span></span></span></span></span></span>指定相对于候选框的尺度不变转换和对数空间高度/宽度移位，与在RPN网络中是一样的。</li></ul> 
<p>每个训练的候选区域用 <strong>分类目标值u和检测框回归目标值v标记</strong> 。背景样本用u=0来表示，对每个标记的候选区域使用多任务损失L以联合训练分类和检测框回归：</p> 
<p><img src="https://images2.imgbox.com/09/ff/uBlVR6Kk_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-QZe8AlLU-1646211351965)(笔记图片/image-20200915111032596.png)]"></p> 
<p>其中Lcls(p,u)=−logpu，表示交叉熵损失，第二个损失Lloc，是定义目标值和预测检测框的四元组之间的损失使用smoothL1损失计算，同样是只有正样本（非背景）的候选区域才计算回归损失，参数λ设为1。</p> 
<h5><a id="_825"></a>训练过程</h5> 
<p>FastRCNN的训练获取每张图片中的正负样本：</p> 
<ul><li>对所有正样本根据IOU值进行排序，每张图片取前256个区域，将这些区域的坐标保存下来，作为该图片的训练样本</li><li>用于Softmax分类和检测框回归的全连接层的权重分别使用具有方差0.01和0.001的零均值高斯分布初始化，偏置初始化为0，特征提取网络使用ImageNet的预训练网络</li><li>使用梯度下降算法进行优化</li></ul> 
<h5><a id="_833"></a>实现</h5> 
<h6><a id="_835"></a>正负样本设置</h6> 
<p>将proposal层产生的候选区域与目标真实值的计算交并比设置正负样本：</p> 
<pre><code class="prism language-python"><span class="token comment"># fastRCNN的正负样本设置# 输入：RPN网络生成的候选区域，bbox是标记框，label是目标类别# 输出：参与训练的候选区域rois_list,候选区域分类的目标值rcnn_target_matchs_list，回归的目标值rcnn_target_deltas_listrois_list, rcnn_target_matchs_list, rcnn_target_deltas_list = \                model.bbox_target.build_targets(                    proposals_list,bbox, label, imagemeta)</span>
</code></pre> 
<p>获取正样本：正样本是负责目标检测的候选区域，其目标值不是0，正样本的个数是64个</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取正样本：positive_proposal = tf.gather(rois_list[0], tf.where(    tf.not_equal(rcnn_target_matchs_list, 0))[:, 1])# positive_proposal.shapeTensorShape([64, 4])</span>
</code></pre> 
<p>将其展示在图像上：可以这些框跟真实值是非常接近的</p> 
<pre><code class="prism language-python"><span class="token comment"># 显示visualize.draw_boxes(rgd_image[0],positive_proposal.numpy()*1216)plt.show()</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/60/f1/kzWRYqMH_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-5zZmN65b-1646211351966)(笔记图片/image-20201231104448218.png)]"></p> 
<p>同样我们也可以获取负样本（背景），并绘制在图像上：</p> 
<pre><code class="prism language-python"><span class="token comment"># 负样本</span>
negtivate_proposal <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>rois_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>
    tf<span class="token punctuation">.</span>equal<span class="token punctuation">(</span>rcnn_target_matchs_list<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># negtivate_proposal.shape</span>
TensorShape<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 显示</span>
visualize<span class="token punctuation">.</span>draw_boxes<span class="token punctuation">(</span>rgd_image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>negtivate_proposal<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1216</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6b/49/1JpofI4A_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-QFbXuzWd-1646211351966)(笔记图片/image-20201231104707698.png)]"></p> 
<h6><a id="_874"></a>损失函数</h6> 
<p>损失函数计算是将网络预测结果和真实值进行比较，获取两者之间的差别。在这里我们需要将参与网络训练的候选区域进行ROIPooling后送入网络中训练。损失函数由两部分组成：分类和回归：</p> 
<pre><code class="prism language-python"><span class="token comment"># 将参与网络训练的候选区域rois_list送入到ROIpooling层中进行维度固定pooled_regions_list = model.roi_align(            (rois_list, rcnn_feature_maps, imagemeta), training=True）# 送入网络中进行预测，得到预测结果rcnn_class_logits_list, rcnn_probs_list, rcnn_deltas_list = \            model.bbox_head(pooled_regions_list, training=True)# 计算损失函数：分类和回归# 输入：网络的预测结果和目标值rcnn_class_loss, rcnn_bbox_loss = model.bbox_head.loss(                rcnn_class_logits_list, rcnn_deltas_list,                 rcnn_target_matchs_list, rcnn_target_deltas_list)  # 分类损失rcnn_class_loss&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.56958425&gt;# 回归损失rcnn_bbox_loss&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.28708345&gt;</span>
</code></pre> 
<p>接下来使用梯度下降算法进行预测即可</p> 
<h4><a id="_884"></a>共享卷积训练</h4> 
<p>用fastRCNN检测网络初始化RPN训练，但是固定共享的卷积层，并且只微调RPN独有的层，现在两个网络共享卷积层了，接下来保持共享的卷积层固定，微调Fast R-CNN的fc层。这样，RPN网络和Fast R-CNN网络共享相同的卷积层，构成一个统一的网络。</p> 
<p>Faster R-CNN还有一种端到端的训练方式，可以一次完成训练，将RPN loss与Fast RCNN loss相加，然后进行梯度下降优化，更新参数。</p> 
<h3><a id="_890"></a>端到端训练</h3> 
<p>前面我们已经介绍了网络模型架构和预测结果，在网络预测前我们需要对网络进行训练，接下来使用端到端的方式进行模型训练，基本步骤是：</p> 
<p>1、加载数据集：我们在这里使用VOC数据集，所以需要加载VOC数据集</p> 
<p>2、模型实例化：加载faster RCNN模型</p> 
<p>3、模型训练：计算损失函数，使用反向传播算法对模型进行训练</p> 
<p>完成网络的训练。首先导入相关的工具包：</p> 
<pre><code class="prism language-python"><span class="token comment"># 数据集加载</span>
<span class="token keyword">from</span> detection<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> pascal_voc
<span class="token comment"># 深度学习框架</span>
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token comment"># 绘图</span>
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token comment"># 要训练的模型</span>
<span class="token keyword">from</span> detection<span class="token punctuation">.</span>models<span class="token punctuation">.</span>detectors <span class="token keyword">import</span> faster_rcnn
</code></pre> 
<h4><a id="_914"></a>数据加载</h4> 
<pre><code class="prism language-python"><span class="token comment"># 加载数据集</span>
train_dataset <span class="token operator">=</span> pascal_voc<span class="token punctuation">.</span>pascal_voc<span class="token punctuation">(</span><span class="token string">'train'</span><span class="token punctuation">)</span>
<span class="token comment"># 数据的类别： train_dataset.classes</span>
<span class="token punctuation">[</span><span class="token string">'background'</span><span class="token punctuation">,</span>
 <span class="token string">'person'</span><span class="token punctuation">,</span>
 <span class="token string">'aeroplane'</span><span class="token punctuation">,</span>
 <span class="token string">'bicycle'</span><span class="token punctuation">,</span>
 <span class="token string">'bird'</span><span class="token punctuation">,</span>
 <span class="token string">'boat'</span><span class="token punctuation">,</span>
 <span class="token string">'bottle'</span><span class="token punctuation">,</span>
 <span class="token string">'bus'</span><span class="token punctuation">,</span>
 <span class="token string">'car'</span><span class="token punctuation">,</span>
 <span class="token string">'cat'</span><span class="token punctuation">,</span>
 <span class="token string">'chair'</span><span class="token punctuation">,</span>
 <span class="token string">'cow'</span><span class="token punctuation">,</span>
 <span class="token string">'diningtable'</span><span class="token punctuation">,</span>
 <span class="token string">'dog'</span><span class="token punctuation">,</span>
 <span class="token string">'horse'</span><span class="token punctuation">,</span>
 <span class="token string">'motorbike'</span><span class="token punctuation">,</span>
 <span class="token string">'pottedplant'</span><span class="token punctuation">,</span>
 <span class="token string">'sheep'</span><span class="token punctuation">,</span>
 <span class="token string">'sofa'</span><span class="token punctuation">,</span>
 <span class="token string">'train'</span><span class="token punctuation">,</span>
 <span class="token string">'tvmonitor'</span><span class="token punctuation">]</span>
<span class="token comment"># 数据类别数量：21</span>
num_classes <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_dataset<span class="token punctuation">.</span>classes<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_945"></a>模型实例化</h4> 
<pre><code class="prism language-python"><span class="token comment"># 指定数据集中类别个数</span>
model <span class="token operator">=</span> faster_rcnn<span class="token punctuation">.</span>FasterRCNN<span class="token punctuation">(</span>num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_952"></a>模型训练</h4> 
<p>模型训练也就是要使用损失函数，进行反向传播，利用优化器进行参数更新，训练的流程是：</p> 
<p>1、指定优化器：在这里我们使用加动量的SGD方法</p> 
<p>2、设置epoch，进行遍历获取batch数据送入网络中进行预测</p> 
<p>3、计算损失函数，使用反向传播更新参数，我们使用tf.GradientTape实现：</p> 
<ul><li>定义上下文环境：tf.GradientTape</li><li>计算损失函数loss</li><li>使用 <code>tape.gradient(loss,model.trainable_variables)</code> 自动计算梯度，loss是损失结果，trainable_variables为所有需要训练的变量。</li><li>使用 <code>optimizer.apply_gradients(zip(grads,model.trainable_variables))</code> 自动更新模型参数，zip(grads, trainable_variables)将梯度和参数关联起来，然后apply_gradients会自动的利用梯度对参数进行更新。</li></ul> 
<p>接下来我们按照这个流程完成模型训练。</p> 
<pre><code class="prism language-python"><span class="token comment"># 1.定义优化器</span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>optimizers<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> nesterov<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment"># 模型优化</span>
loss_his <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment"># 2.设置epoch，进行遍历获取batch数据送入网络中进行预测</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取索引</span>
    indices <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>train_dataset<span class="token punctuation">.</span>num_gtlabels<span class="token punctuation">)</span>
    <span class="token comment"># 打乱</span>
    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>indices<span class="token punctuation">)</span>
    <span class="token comment"># 迭代次数</span>
    <span class="token builtin">iter</span> <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>train_dataset<span class="token punctuation">.</span>num_gtlabels<span class="token operator">/</span>train_dataset<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    <span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取batch数据索引</span>
        idx <span class="token operator">=</span> indices<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token comment"># 获取batch_size</span>
        batch_image<span class="token punctuation">,</span>batch_metas<span class="token punctuation">,</span>batch_bboxes<span class="token punctuation">,</span>batch_label <span class="token operator">=</span> train_dataset<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token comment"># 3.模型训练，计算损失函数，使用反向传播更新参数</span>
        <span class="token comment"># 3.1 定义作用域</span>
        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>GradientTape<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tape<span class="token punctuation">:</span>
            <span class="token comment"># 3.2 计算损失函数</span>
            rpn_class_loss<span class="token punctuation">,</span>rpn_bbox_loss<span class="token punctuation">,</span>rcnn_class_loss<span class="token punctuation">,</span>rcnn_bbox_loss <span class="token operator">=</span> model<span class="token punctuation">(</span><span class="token punctuation">(</span>batch_image<span class="token punctuation">,</span>batch_metas<span class="token punctuation">,</span>batch_bboxes<span class="token punctuation">,</span>batch_label<span class="token punctuation">)</span><span class="token punctuation">,</span>training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token comment"># 总损失</span>
            loss <span class="token operator">=</span> rpn_class_loss<span class="token operator">+</span>rpn_bbox_loss<span class="token operator">+</span>rcnn_class_loss<span class="token operator">+</span>rcnn_bbox_loss
            <span class="token comment"># 3.3 计算梯度</span>
            grads <span class="token operator">=</span> tape<span class="token punctuation">.</span>gradient<span class="token punctuation">(</span>loss<span class="token punctuation">,</span>model<span class="token punctuation">.</span>trainable_variables<span class="token punctuation">)</span>
            <span class="token comment"># 3.4 更新参数值</span>
            optimizer<span class="token punctuation">.</span>apply_gradients<span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>grads<span class="token punctuation">,</span>model<span class="token punctuation">.</span>trainable_variables<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch:%d,batch:%d,loss:%f"</span><span class="token operator">%</span><span class="token punctuation">(</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>idx<span class="token punctuation">,</span>loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
            loss_his<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>
</code></pre> 
<p>结果为：</p> 
<pre><code class="prism language-python">epoch：<span class="token number">1</span><span class="token punctuation">,</span> loss：<span class="token number">147.117371</span>
epoch：<span class="token number">2</span><span class="token punctuation">,</span> loss：<span class="token number">72.580498</span>
epoch：<span class="token number">3</span><span class="token punctuation">,</span> loss：<span class="token number">79.347351</span>
epoch：<span class="token number">4</span><span class="token punctuation">,</span> loss：<span class="token number">41.220577</span>
epoch：<span class="token number">5</span><span class="token punctuation">,</span> loss：<span class="token number">5.238140</span>
epoch：<span class="token number">6</span><span class="token punctuation">,</span> loss：<span class="token number">2.924250</span>
epoch：<span class="token number">7</span><span class="token punctuation">,</span> loss：<span class="token number">5.287500</span>
</code></pre> 
<p>损失函数的变换如下图所示：</p> 
<pre><code class="prism language-python"><span class="token comment"># 绘制损失函数变化的曲线</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>loss_his<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span>loss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> loss <span class="token keyword">in</span> loss_his<span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0a/63/Vhj5wtKM_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-t9X7I9NO-1646211351967)(笔记图片/image-20200921164738442.png)]"></p> 
<p>当我们训练好模型后，就可以使用训练好的模型进行预测了。</p> 
<h3><a id="_1027"></a>总结</h3> 
<ul><li>熟悉FasterRCNN目标检测的思想</li></ul> 
<p>利用CNN网络进行特征提取，利用RPN生成候选区域，最后进行分类和回归</p> 
<ul><li>知道anchor的思想</li></ul> 
<p>anchor技术将检测问题转换为**“这个固定参考框中有没有目标，目标框偏离参考框多远”**，不再需要多尺度遍历滑窗</p> 
<ul><li>掌握RPN网络是如何进行候选区域的生成的</li></ul> 
<p>通过softmax判断anchors属于positive或者negative，再利用bounding box regression修正anchors获得精确的proposals</p> 
<ul><li>掌握ROIPooling的使用方法</li></ul> 
<p>RoIpooling使用最大池化将任何有效的RoI区域内的特征转换成具有H×W的固定空间范围的小feature map</p> 
<ul><li>知道fasterRCNN的训练方法</li></ul> 
<p>分步训练：RPN网络，fastrcnn训练，共享网络训练，端到端的网络训练</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/980e5dc96f929afed361292f53da3db0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">模拟客户端和服务端</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/81772e15658540d6f7665b204a1b315d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于ClickHouse数据迁移备份解决方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>