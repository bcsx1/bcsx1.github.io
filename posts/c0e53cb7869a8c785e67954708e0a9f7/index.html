<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kaggle手势识别第一名代码解析 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kaggle手势识别第一名代码解析" />
<meta property="og:description" content="Kaggle Google - Isolated Sign Language Recognition竞赛链接Kaggle
第一名比赛方案链接Link
Train 笔记 下载轮子 !pip install -q /kaggle/input/tensorflow-2120/tensorflow-2.12.0-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl !pip install -q tensorflow-addons==0.20.0 !pip install -q git&#43;https://github.com/hoyso48/tf-utils@main 加载要用到的库 import numpy as np import pandas as pd import tensorflow as tf import tensorflow_addons as tfa import matplotlib.pyplot as plt import matplotlib as mpl import tensorflow.keras.mixed_precision as mixed_precision from tqdm.autonotebook import tqdm import sklearn from tf_utils.schedules import OneCycleLR, ListedLR from tf_utils.callbacks import Snapshot, SWA from tf_utils." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/c0e53cb7869a8c785e67954708e0a9f7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-25T15:10:28+08:00" />
<meta property="article:modified_time" content="2023-05-25T15:10:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kaggle手势识别第一名代码解析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>Kaggle Google - Isolated Sign Language Recognition竞赛链接<a href="https://www.kaggle.com/competitions/asl-signs/overview" rel="nofollow">Kaggle</a><br> 第一名比赛方案链接<a href="https://www.kaggle.com/competitions/asl-signs/discussion/406684" rel="nofollow">Link</a></p> 
<h2><a id="Train__3"></a>Train 笔记</h2> 
<h3><a id="_4"></a>下载轮子</h3> 
<pre><code class="prism language-python">!pip install <span class="token operator">-</span>q <span class="token operator">/</span>kaggle<span class="token operator">/</span><span class="token builtin">input</span><span class="token operator">/</span>tensorflow<span class="token operator">-</span><span class="token number">2120</span><span class="token operator">/</span>tensorflow<span class="token operator">-</span><span class="token number">2.12</span><span class="token number">.0</span><span class="token operator">-</span>cp38<span class="token operator">-</span>cp38<span class="token operator">-</span>manylinux_2_17_x86_64<span class="token punctuation">.</span>manylinux2014_x86_64<span class="token punctuation">.</span>whl
!pip install <span class="token operator">-</span>q tensorflow<span class="token operator">-</span>addons<span class="token operator">==</span><span class="token number">0.20</span><span class="token number">.0</span>
!pip install <span class="token operator">-</span>q git<span class="token operator">+</span>https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>hoyso48<span class="token operator">/</span>tf<span class="token operator">-</span>utils@main
</code></pre> 
<h3><a id="_10"></a>加载要用到的库</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> tensorflow_addons <span class="token keyword">as</span> tfa 
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> matplotlib <span class="token keyword">as</span> mpl
<span class="token keyword">import</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>mixed_precision <span class="token keyword">as</span> mixed_precision

<span class="token keyword">from</span> tqdm<span class="token punctuation">.</span>autonotebook <span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> sklearn

<span class="token keyword">from</span> tf_utils<span class="token punctuation">.</span>schedules <span class="token keyword">import</span> OneCycleLR<span class="token punctuation">,</span> ListedLR
<span class="token keyword">from</span> tf_utils<span class="token punctuation">.</span>callbacks <span class="token keyword">import</span> Snapshot<span class="token punctuation">,</span> SWA
<span class="token keyword">from</span> tf_utils<span class="token punctuation">.</span>learners <span class="token keyword">import</span> FGM<span class="token punctuation">,</span> AWP <span class="token comment">#</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> math
<span class="token keyword">import</span> random
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> gc
<span class="token keyword">import</span> glob
<span class="token keyword">import</span> datetime

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Tensorflow Version: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tf<span class="token punctuation">.</span>__version__<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Python Version: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>sys<span class="token punctuation">.</span>version<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre> 
<p>这段代码主要是用于设置随机数种子和获取分布式策略。其中，seed_everything函数用于设置所有随机数生成器的种子，以确保结果的可重复性。get_strategy函数用于获取分布式策略，根据设备类型选择不同的策略，包括TPU、GPU和CPU。最后返回策略、副本数和是否使用TPU的标志。</p> 
<pre><code class="prism language-python"><span class="token comment"># Seed all random number generators</span>
<span class="token keyword">def</span> <span class="token function">seed_everything</span><span class="token punctuation">(</span>seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'PYTHONHASHSEED'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>set_seed<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">get_strategy</span><span class="token punctuation">(</span>device<span class="token operator">=</span><span class="token string">'TPU-VM'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token keyword">if</span> <span class="token string">"TPU"</span> <span class="token keyword">in</span> device<span class="token punctuation">:</span>
        tpu <span class="token operator">=</span> <span class="token string">'local'</span> <span class="token keyword">if</span> device<span class="token operator">==</span><span class="token string">'TPU-VM'</span> <span class="token keyword">else</span> <span class="token boolean">None</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"connecting to TPU..."</span><span class="token punctuation">)</span>
        tpu <span class="token operator">=</span> tf<span class="token punctuation">.</span>distribute<span class="token punctuation">.</span>cluster_resolver<span class="token punctuation">.</span>TPUClusterResolver<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>tpu<span class="token operator">=</span>tpu<span class="token punctuation">)</span>
        strategy <span class="token operator">=</span> tf<span class="token punctuation">.</span>distribute<span class="token punctuation">.</span>TPUStrategy<span class="token punctuation">(</span>tpu<span class="token punctuation">)</span>
        IS_TPU <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">if</span> device <span class="token operator">==</span> <span class="token string">"GPU"</span>  <span class="token keyword">or</span> device<span class="token operator">==</span><span class="token string">"CPU"</span><span class="token punctuation">:</span>
        ngpu <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>list_physical_devices<span class="token punctuation">(</span><span class="token string">'GPU'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> ngpu<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Using multi GPU"</span><span class="token punctuation">)</span>
            strategy <span class="token operator">=</span> tf<span class="token punctuation">.</span>distribute<span class="token punctuation">.</span>MirroredStrategy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> ngpu<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Using single GPU"</span><span class="token punctuation">)</span>
            strategy <span class="token operator">=</span> tf<span class="token punctuation">.</span>distribute<span class="token punctuation">.</span>get_strategy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Using CPU"</span><span class="token punctuation">)</span>
            strategy <span class="token operator">=</span> tf<span class="token punctuation">.</span>distribute<span class="token punctuation">.</span>get_strategy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            CFG<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token string">"CPU"</span>

    <span class="token keyword">if</span> device <span class="token operator">==</span> <span class="token string">"GPU"</span><span class="token punctuation">:</span> 
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Num GPUs Available: "</span><span class="token punctuation">,</span> ngpu<span class="token punctuation">)</span> 

    AUTO     <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span>AUTOTUNE 
    REPLICAS <span class="token operator">=</span> strategy<span class="token punctuation">.</span>num_replicas_in_sync 
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'REPLICAS: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>REPLICAS<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span> 
    
    <span class="token keyword">return</span> strategy<span class="token punctuation">,</span> REPLICAS<span class="token punctuation">,</span> IS_TPU 

STRATEGY<span class="token punctuation">,</span> N_REPLICAS<span class="token punctuation">,</span> IS_TPU <span class="token operator">=</span> get_strategy<span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre> 
<pre><code class="prism language-python">TRAIN_FILENAMES <span class="token operator">=</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'/kaggle/input/islr-5fold/*.tfrecords'</span><span class="token punctuation">)</span>   
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>TRAIN_FILENAMES<span class="token punctuation">)</span><span class="token punctuation">)</span>   
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># Train DataFrame</span>
train_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'/kaggle/input/asl-signs/train.csv'</span><span class="token punctuation">)</span>
display<span class="token punctuation">(</span>train_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
display<span class="token punctuation">(</span>train_df<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> re
<span class="token keyword">def</span> <span class="token function">count_data_items</span><span class="token punctuation">(</span>filenames<span class="token punctuation">)</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r"-([0-9]*)\."</span><span class="token punctuation">)</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span>filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> filename <span class="token keyword">in</span> filenames<span class="token punctuation">]</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>count_data_items<span class="token punctuation">(</span>TRAIN_FILENAMES<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_df<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> count_data_items<span class="token punctuation">(</span>TRAIN_FILENAMES<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_df<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">ROWS_PER_FRAME <span class="token operator">=</span> <span class="token number">543</span>
MAX_LEN <span class="token operator">=</span> <span class="token number">384</span>
CROP_LEN <span class="token operator">=</span> MAX_LEN
NUM_CLASSES  <span class="token operator">=</span> <span class="token number">250</span>
PAD <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">.</span>
NOSE<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">98</span><span class="token punctuation">,</span><span class="token number">327</span>
<span class="token punctuation">]</span>
LNOSE <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">98</span><span class="token punctuation">]</span>
RNOSE <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">327</span><span class="token punctuation">]</span>
LIP <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">,</span> 
    <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">185</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token number">267</span><span class="token punctuation">,</span> <span class="token number">269</span><span class="token punctuation">,</span> <span class="token number">270</span><span class="token punctuation">,</span> <span class="token number">409</span><span class="token punctuation">,</span>
    <span class="token number">291</span><span class="token punctuation">,</span> <span class="token number">146</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">181</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">314</span><span class="token punctuation">,</span> <span class="token number">405</span><span class="token punctuation">,</span> <span class="token number">321</span><span class="token punctuation">,</span> <span class="token number">375</span><span class="token punctuation">,</span>
    <span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">191</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">312</span><span class="token punctuation">,</span> <span class="token number">311</span><span class="token punctuation">,</span> <span class="token number">310</span><span class="token punctuation">,</span> <span class="token number">415</span><span class="token punctuation">,</span>
    <span class="token number">95</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">178</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">317</span><span class="token punctuation">,</span> <span class="token number">402</span><span class="token punctuation">,</span> <span class="token number">318</span><span class="token punctuation">,</span> <span class="token number">324</span><span class="token punctuation">,</span> <span class="token number">308</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
LLIP <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">84</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">,</span><span class="token number">91</span><span class="token punctuation">,</span><span class="token number">146</span><span class="token punctuation">,</span><span class="token number">61</span><span class="token punctuation">,</span><span class="token number">185</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">39</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">87</span><span class="token punctuation">,</span><span class="token number">178</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">95</span><span class="token punctuation">,</span><span class="token number">78</span><span class="token punctuation">,</span><span class="token number">191</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">81</span><span class="token punctuation">,</span><span class="token number">82</span><span class="token punctuation">]</span>
RLIP <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">314</span><span class="token punctuation">,</span><span class="token number">405</span><span class="token punctuation">,</span><span class="token number">321</span><span class="token punctuation">,</span><span class="token number">375</span><span class="token punctuation">,</span><span class="token number">291</span><span class="token punctuation">,</span><span class="token number">409</span><span class="token punctuation">,</span><span class="token number">270</span><span class="token punctuation">,</span><span class="token number">269</span><span class="token punctuation">,</span><span class="token number">267</span><span class="token punctuation">,</span><span class="token number">317</span><span class="token punctuation">,</span><span class="token number">402</span><span class="token punctuation">,</span><span class="token number">318</span><span class="token punctuation">,</span><span class="token number">324</span><span class="token punctuation">,</span><span class="token number">308</span><span class="token punctuation">,</span><span class="token number">415</span><span class="token punctuation">,</span><span class="token number">310</span><span class="token punctuation">,</span><span class="token number">311</span><span class="token punctuation">,</span><span class="token number">312</span><span class="token punctuation">]</span>

POSE <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">502</span><span class="token punctuation">,</span> <span class="token number">504</span><span class="token punctuation">,</span> <span class="token number">501</span><span class="token punctuation">,</span> <span class="token number">503</span><span class="token punctuation">,</span> <span class="token number">505</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">513</span><span class="token punctuation">]</span>
LPOSE <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">513</span><span class="token punctuation">,</span><span class="token number">505</span><span class="token punctuation">,</span><span class="token number">503</span><span class="token punctuation">,</span><span class="token number">501</span><span class="token punctuation">]</span>
RPOSE <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">,</span><span class="token number">504</span><span class="token punctuation">,</span><span class="token number">502</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">]</span>

REYE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">163</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">,</span> <span class="token number">145</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">154</span><span class="token punctuation">,</span> <span class="token number">155</span><span class="token punctuation">,</span> <span class="token number">133</span><span class="token punctuation">,</span>
    <span class="token number">246</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">159</span><span class="token punctuation">,</span> <span class="token number">158</span><span class="token punctuation">,</span> <span class="token number">157</span><span class="token punctuation">,</span> <span class="token number">173</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span> 
LEYE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">263</span><span class="token punctuation">,</span> <span class="token number">249</span><span class="token punctuation">,</span> <span class="token number">390</span><span class="token punctuation">,</span> <span class="token number">373</span><span class="token punctuation">,</span> <span class="token number">374</span><span class="token punctuation">,</span> <span class="token number">380</span><span class="token punctuation">,</span> <span class="token number">381</span><span class="token punctuation">,</span> <span class="token number">382</span><span class="token punctuation">,</span> <span class="token number">362</span><span class="token punctuation">,</span>
    <span class="token number">466</span><span class="token punctuation">,</span> <span class="token number">388</span><span class="token punctuation">,</span> <span class="token number">387</span><span class="token punctuation">,</span> <span class="token number">386</span><span class="token punctuation">,</span> <span class="token number">385</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> <span class="token number">398</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span> 

LHAND <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">468</span><span class="token punctuation">,</span> <span class="token number">489</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
RHAND <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">522</span><span class="token punctuation">,</span> <span class="token number">543</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

POINT_LANDMARKS <span class="token operator">=</span> LIP <span class="token operator">+</span> LHAND <span class="token operator">+</span> RHAND <span class="token operator">+</span> NOSE <span class="token operator">+</span> REYE <span class="token operator">+</span> LEYE <span class="token comment">#+POSE</span>

NUM_NODES <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>POINT_LANDMARKS<span class="token punctuation">)</span>
CHANNELS <span class="token operator">=</span> <span class="token number">6</span><span class="token operator">*</span>NUM_NODES 

<span class="token keyword">print</span><span class="token punctuation">(</span>NUM_NODES<span class="token punctuation">)</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span>CHANNELS<span class="token punctuation">)</span> 

<span class="token keyword">def</span> <span class="token function">interp1d_</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> target_len<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''这是一段Python代码，使用了TensorFlow库。
    函数名为interp1d_，作用是对输入的坐标信息进行插值处理。
    参数x为输入的坐标信息，target_len为目标长度，method为插值方法。
    首先使用tf.shape函数获取坐标信息的长度，然后使用tf.maximum函数确保目标长度不小于1。
    如果method为'random'，则使用tf.random.uniform函数生成两个随机数，
    如果第一个随机数小于0.33，则使用双线性插值方法对坐标信息进行插值处理；
    否则，如果第二个随机数小于0.5，则使用三次插值方法对坐标信息进行插值处理；
    否则，使用最近邻插值方法对坐标信息进行插值处理。
    如果method不为'random'，则直接使用指定的插值方法对坐标信息进行插值处理。
    最终返回插值处理后的坐标信息。'''</span>
    length <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 
    target_len <span class="token operator">=</span> tf<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>target_len<span class="token punctuation">)</span>  
    <span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">'random'</span><span class="token punctuation">:</span>  
        <span class="token keyword">if</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.33</span><span class="token punctuation">:</span>  <span class="token comment"># 用于从均匀分布中输出随机值。</span>
            x <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span>target_len<span class="token punctuation">,</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'bilinear'</span><span class="token punctuation">)</span>   <span class="token comment"># 双线性插值</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span> 
            <span class="token keyword">if</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span> 
                x <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span>target_len<span class="token punctuation">,</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'bicubic'</span><span class="token punctuation">)</span>   <span class="token comment"># 三次插值</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span> 
                x <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span>target_len<span class="token punctuation">,</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'nearest'</span><span class="token punctuation">)</span>  <span class="token comment"># 最近邻插值</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span> 
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span>target_len<span class="token punctuation">,</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>method<span class="token punctuation">)</span>  
    <span class="token keyword">return</span> x 

<span class="token triple-quoted-string string">'''这两段代码是用于计算张量中的NaN值的平均值和标准差。
第一段代码中，tf.where()函数用于将NaN值替换为0，
然后使用tf.reduce_sum()函数计算元素之和，最后除以非NaN值的数量来计算平均值。 
第二段代码中，如果中心值为None，则使用第一段代码中的函数计算中心值。 
然后计算差值并使用tf_nan_mean()函数计算平均值，最后使用tf.math.sqrt()函数计算标准差。'''</span>

<span class="token keyword">def</span> <span class="token function">tf_nan_mean</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#tf.reduce_sum()作用是按一定方式计算张量中元素之和</span>
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>reduce_sum<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>math<span class="token punctuation">.</span>is_nan<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span>axis<span class="token punctuation">,</span> keepdims<span class="token operator">=</span>keepdims<span class="token punctuation">)</span> <span class="token operator">/</span> tf<span class="token punctuation">.</span>reduce_sum<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>math<span class="token punctuation">.</span>is_nan<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span>axis<span class="token punctuation">,</span> keepdims<span class="token operator">=</span>keepdims<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">tf_nan_std</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> center<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token keyword">if</span> center <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>  <span class="token comment"># 如果中心是None</span>
        center <span class="token operator">=</span> tf_nan_mean<span class="token punctuation">(</span>x<span class="token punctuation">,</span> axis<span class="token operator">=</span>axis<span class="token punctuation">,</span>  keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment">#返回center</span>
    d <span class="token operator">=</span> x <span class="token operator">-</span> center 
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>tf_nan_mean<span class="token punctuation">(</span>d <span class="token operator">*</span> d<span class="token punctuation">,</span> axis<span class="token operator">=</span>axis<span class="token punctuation">,</span> keepdims<span class="token operator">=</span>keepdims<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''
这段代码定义了一个名为Preprocess的类，继承自tf.keras.layers.Layer。
该类的作用是对输入进行预处理，包括截取、标准化、差分等操作。
其中，max_len和point_landmarks是该类的两个参数，用于控制截取和差分的长度和位置。
call方法是该类的核心方法，用于实现具体的预处理操作。
具体实现包括对输入进行维度处理、计算均值和标准差、截取、差分、拼接等操作。
最后，使用tf.where函数将NaN值替换为0。
'''</span>

<span class="token keyword">class</span> <span class="token class-name">Preprocess</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#当我们需要函数接收带关键字的参数作为输入的时候，应当使用**kwargs</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_len<span class="token operator">=</span>MAX_LEN<span class="token punctuation">,</span> point_landmarks<span class="token operator">=</span>POINT_LANDMARKS<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>max_len <span class="token operator">=</span> max_len 
        self<span class="token punctuation">.</span>point_landmarks <span class="token operator">=</span> point_landmarks  

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>   
        <span class="token keyword">if</span> tf<span class="token punctuation">.</span>rank<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>  <span class="token comment">#tf.rank返回维度  </span>
            x <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>    
        <span class="token keyword">else</span><span class="token punctuation">:</span> 
            x <span class="token operator">=</span> inputs
        <span class="token comment">#tf.gather(该接口的作用：就是抽取出params的第axis维度上在indices里面所有的index</span>
        mean <span class="token operator">=</span> tf_nan_mean<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> 
        mean <span class="token operator">=</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>math<span class="token punctuation">.</span>is_nan<span class="token punctuation">(</span>mean<span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> mean<span class="token punctuation">)</span>
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>point_landmarks<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">#N,T,P,C</span>
        std <span class="token operator">=</span> tf_nan_std<span class="token punctuation">(</span>x<span class="token punctuation">,</span> center<span class="token operator">=</span>mean<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        x <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> mean<span class="token punctuation">)</span><span class="token operator">/</span>std 

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>max_len <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span> 
            x <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>max_len<span class="token punctuation">]</span> <span class="token comment">#截取</span>
        length <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> 
        x <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

        dx <span class="token operator">=</span> tf<span class="token punctuation">.</span>cond<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">lambda</span><span class="token punctuation">:</span>tf<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">lambda</span><span class="token punctuation">:</span>tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>

        dx2 <span class="token operator">=</span> tf<span class="token punctuation">.</span>cond<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token keyword">lambda</span><span class="token punctuation">:</span>tf<span class="token punctuation">.</span>pad<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">lambda</span><span class="token punctuation">:</span>tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>

        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>
            tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>length<span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>point_landmarks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>dx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>length<span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>point_landmarks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>dx2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>length<span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>point_landmarks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>math<span class="token punctuation">.</span>is_nan<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span>tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span>x<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span>x<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> x
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">decode_tfrec</span><span class="token punctuation">(</span>record_bytes<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token triple-quoted-string string">'''这段代码是用来解析TensorFlow记录文件（TFRecord）中的数据。
    具体来说，它将记录字节解析为一个包含两个特征的字典：一个是名为“coordinates”的字符串特征，另一个是名为“sign”的整数特征。
    然后，它使用TensorFlow的解码函数将“coordinates”特征中的原始字节解码为浮点数，并将其重新形状为一个三维张量。
    最后，它将解码后的特征和整数特征打包成一个字典并返回。'''</span>
    features <span class="token operator">=</span> tf<span class="token punctuation">.</span>io<span class="token punctuation">.</span>parse_single_example<span class="token punctuation">(</span>record_bytes<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'coordinates'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FixedLenFeature<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>string<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token string">'sign'</span><span class="token punctuation">:</span> tf<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FixedLenFeature<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int64<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
    out <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  
    out<span class="token punctuation">[</span><span class="token string">'coordinates'</span><span class="token punctuation">]</span>  <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>io<span class="token punctuation">.</span>decode_raw<span class="token punctuation">(</span>features<span class="token punctuation">[</span><span class="token string">'coordinates'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>ROWS_PER_FRAME<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    out<span class="token punctuation">[</span><span class="token string">'sign'</span><span class="token punctuation">]</span> <span class="token operator">=</span> features<span class="token punctuation">[</span><span class="token string">'sign'</span><span class="token punctuation">]</span> 
    <span class="token keyword">return</span> out

<span class="token keyword">def</span> <span class="token function">filter_nans_tf</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> ref_point<span class="token operator">=</span>POINT_LANDMARKS<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">'''这是一段Python代码，使用了TensorFlow库。函数名为filter_nans_tf，
    作用是过滤掉输入张量x中在参考点ref_point处存在NaN值的样本。
    具体实现是通过tf.gather函数获取x张量在ref_point处的值，
    然后使用tf.math.is_nan函数判断是否为NaN值，
    再使用tf.reduce_all函数判断是否所有样本都存在NaN值，
    最后使用tf.boolean_mask函数过滤掉存在NaN值的样本。'''</span>
    
    <span class="token comment">#tf.math.logical_not()x和y两个张量在相应位置上做非（!）操作。</span>
    mask <span class="token operator">=</span> tf<span class="token punctuation">.</span>math<span class="token punctuation">.</span>logical_not<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>reduce_all<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>math<span class="token punctuation">.</span>is_nan<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>x<span class="token punctuation">,</span>ref_point<span class="token punctuation">,</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>boolean_mask<span class="token punctuation">(</span>x<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> x

<span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> max_len<span class="token operator">=</span>MAX_LEN<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">'''这是一段Python代码，使用了TensorFlow库。
    函数名为preprocess，作用是对输入数据进行预处理。
    首先从输入数据x中获取坐标信息，然后使用filter_nans_tf函数过滤掉存在NaN值的样本。
    如果augment参数为True，则使用augment_fn函数对坐标信息进行增强处理。
    接着使用tf.ensure_shape函数确保坐标信息的形状为(None,ROWS_PER_FRAME,3)，其中None表示样本数量不确定。
    最后使用Preprocess(max_len=max_len)对坐标信息进行预处理，并将处理后的结果转换为tf.float32类型的张量，
    同时将标签信息转换为one-hot编码的形式。'''</span>
    
    coord <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token string">'coordinates'</span><span class="token punctuation">]</span>
    coord <span class="token operator">=</span> filter_nans_tf<span class="token punctuation">(</span>coord<span class="token punctuation">)</span>
    <span class="token keyword">if</span> augment<span class="token punctuation">:</span>
        coord <span class="token operator">=</span> augment_fn<span class="token punctuation">(</span>coord<span class="token punctuation">,</span> max_len<span class="token operator">=</span>max_len<span class="token punctuation">)</span>
    coord <span class="token operator">=</span> tf<span class="token punctuation">.</span>ensure_shape<span class="token punctuation">(</span>coord<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span>ROWS_PER_FRAME<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>Preprocess<span class="token punctuation">(</span>max_len<span class="token operator">=</span>max_len<span class="token punctuation">)</span><span class="token punctuation">(</span>coord<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token string">'sign'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> NUM_CLASSES<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">flip_lr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">'''这段代码是一个函数，用于将输入的张量沿着最后一个维度进行翻转。
    具体实现是先将输入张量按照最后一个维度进行拆分，然后将第一个元素取反，
    再将拆分后的张量重新组合起来，最后按照指定的索引位置进行交换。
    其中，tf.gather用于按照指定的索引位置获取张量中的元素，
    tf.tensor_scatter_nd_update用于按照指定的索引位置更新张量中的元素。'''</span>
    
    x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z <span class="token operator">=</span> tf<span class="token punctuation">.</span>unstack<span class="token punctuation">(</span>x<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">-</span>x
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#将new_x改为（y,x,z）</span>
    lhand <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> LHAND<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    rhand <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> RHAND<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">#tf.tensor_scatter_nd_update(对应位置的索引赋值</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>LHAND<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rhand<span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>RHAND<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> lhand<span class="token punctuation">)</span>
    llip <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> LLIP<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    rlip <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> RLIP<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>LLIP<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rlip<span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>RLIP<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> llip<span class="token punctuation">)</span>
    lpose <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> LPOSE<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    rpose <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> RPOSE<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>LPOSE<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rpose<span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>RPOSE<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> lpose<span class="token punctuation">)</span>
    leye <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> LEYE<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    reye <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> REYE<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>LEYE<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reye<span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>REYE<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> leye<span class="token punctuation">)</span>
    lnose <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> LNOSE<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    rnose <span class="token operator">=</span> tf<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> RNOSE<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>LNOSE<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rnose<span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>RNOSE<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> lnose<span class="token punctuation">)</span>
    new_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>new_x<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">#将new_x再改为（x,y,z)</span>
    <span class="token keyword">return</span> new_x <span class="token comment">#左右翻转图像</span>

<span class="token keyword">def</span> <span class="token function">resample</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">'''这段代码是一个函数，名为resample，它的作用是对输入的x进行重采样。
    重采样的比例在0.8到1.2之间随机生成。
    函数中使用了TensorFlow的函数tf.random.uniform来生成随机数，
    使用了tf.shape获取x的长度，使用了tf.cast进行类型转换，
    使用了interp1d_函数对x进行插值得到新的重采样后的x。最后返回新的x。'''</span>
    
    rate <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    length <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    new_size <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>rate<span class="token operator">*</span>tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>length<span class="token punctuation">,</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span> <span class="token comment">#tf.cast()函数用于执行tensorflow中张量数据类型转换</span>
    new_x <span class="token operator">=</span> interp1d_<span class="token punctuation">(</span>x<span class="token punctuation">,</span> new_size<span class="token punctuation">)</span> <span class="token comment">#进行插值操作</span>
    <span class="token keyword">return</span> new_x

<span class="token keyword">def</span> <span class="token function">spatial_random_affine</span><span class="token punctuation">(</span>xyz<span class="token punctuation">,</span>
    scale  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">1.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    shear <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.15</span><span class="token punctuation">,</span><span class="token number">0.15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    shift  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    degree <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''这段代码是一个用于进行空间随机仿射变换的函数。
    其中包含了对输入的三维坐标进行缩放、剪切、旋转和平移等操作。
    具体实现中使用了 TensorFlow 的一些函数和运算符，
    如 tf.constant、tf.random.uniform、tf.identity、@ 运算符和 tf.concat 等。
    其中，通过 @ 运算符可以方便地实现矩阵相乘，
    而 tf.identity 则用于创建一个恒等矩阵。
    此外，代码中还使用了 numpy 库中的 np.pi 常量。'''</span>
    center <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> scale <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        scale <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span>scale<span class="token punctuation">)</span>
        xyz <span class="token operator">=</span> scale<span class="token operator">*</span>xyz

    <span class="token keyword">if</span> shear <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment">#Numpy 中 a[::,1] 等价于 a[...,1]</span>
        xy <span class="token operator">=</span> xyz<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        z <span class="token operator">=</span> xyz<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> 
        shear_x <span class="token operator">=</span> shear_y <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span>shear<span class="token punctuation">)</span>  
        <span class="token keyword">if</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">:</span>  
            shear_x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span> 
        <span class="token keyword">else</span><span class="token punctuation">:</span> 
            shear_y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span> 
            <span class="token comment">#tf.identity在计算图内部创建了两个节点，send / recv节点，用来发送和接受两个变量，如果两个变量在不同的设备上，比如 CPU 和 GPU，那么将会复制变量，如果在一个设备上，将会只是一个引用。</span>
        shear_mat <span class="token operator">=</span> tf<span class="token punctuation">.</span>identity<span class="token punctuation">(</span><span class="token punctuation">[</span> 
            <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span>shear_x<span class="token punctuation">]</span><span class="token punctuation">,</span> 
            <span class="token punctuation">[</span>shear_y<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">]</span> 
        <span class="token punctuation">]</span><span class="token punctuation">)</span> 
        xy <span class="token operator">=</span> xy @ shear_mat <span class="token comment">#通过@运算符可以方便的实现矩阵相乘，还可以通过tf.matmul(a, b)实现</span>
        center <span class="token operator">=</span> center <span class="token operator">+</span> <span class="token punctuation">[</span>shear_y<span class="token punctuation">,</span> shear_x<span class="token punctuation">]</span> 
        xyz <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>xy<span class="token punctuation">,</span>z<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> degree <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        xy <span class="token operator">=</span> xyz<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        z <span class="token operator">=</span> xyz<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        xy <span class="token operator">-=</span> center
        degree <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span>degree<span class="token punctuation">)</span>
        radian <span class="token operator">=</span> degree<span class="token operator">/</span><span class="token number">180</span><span class="token operator">*</span>np<span class="token punctuation">.</span>pi
        c <span class="token operator">=</span> tf<span class="token punctuation">.</span>math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>radian<span class="token punctuation">)</span>
        s <span class="token operator">=</span> tf<span class="token punctuation">.</span>math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>radian<span class="token punctuation">)</span>
        rotate_mat <span class="token operator">=</span> tf<span class="token punctuation">.</span>identity<span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token punctuation">[</span>c<span class="token punctuation">,</span>s<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token operator">-</span>s<span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        xy <span class="token operator">=</span> xy @ rotate_mat
        xy <span class="token operator">=</span> xy <span class="token operator">+</span> center
        xyz <span class="token operator">=</span> tf<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>xy<span class="token punctuation">,</span>z<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> shift <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        shift <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span>shift<span class="token punctuation">)</span>
        xyz <span class="token operator">=</span> xyz <span class="token operator">+</span> shift

    <span class="token keyword">return</span> xyz

<span class="token keyword">def</span> <span class="token function">temporal_crop</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> length<span class="token operator">=</span>MAX_LEN<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''这段代码是一个函数，名为temporal_crop，它的作用是对输入的x进行裁剪，使其长度为length。
    如果没有指定length，则默认为MAX_LEN。
    具体实现是先获取x的长度l，然后生成一个随机数offset，范围在[0, l-length]之间，
    最后将x从offset开始裁剪，长度为length。
    裁剪后的x作为函数的返回值。
    这段代码使用了TensorFlow库中的一些函数，如tf.shape、tf.random.uniform和tf.clip_by_value。'''</span>
    l <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    offset <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>clip_by_value<span class="token punctuation">(</span>l<span class="token operator">-</span>length<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
    x <span class="token operator">=</span> x<span class="token punctuation">[</span>offset<span class="token punctuation">:</span>offset<span class="token operator">+</span>length<span class="token punctuation">]</span>
    <span class="token keyword">return</span> x

<span class="token keyword">def</span> <span class="token function">temporal_mask</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask_value<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'nan'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''这段代码是一个用于生成时间掩码的函数，主要用于在训练神经网络时对输入数据进行随机掩码处理，以增强模型的鲁棒性。
    函数的输入参数x是一个张量，size是一个元组，表示掩码的大小范围，mask_value是掩码的值。
    函数首先获取输入张量的长度l，然后随机生成掩码的大小mask_size，并将其转换为整数类型。
    接着，随机生成掩码的偏移量mask_offset，并使用tf.tensor_scatter_nd_update函数将掩码应用到输入张量的相应位置上。
    最后，函数返回处理后的张量。'''</span>
    l <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    mask_size <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>size<span class="token punctuation">)</span>
    mask_size <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>l<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token operator">*</span> mask_size<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
    mask_offset <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>clip_by_value<span class="token punctuation">(</span>l<span class="token operator">-</span>mask_size<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>tensor_scatter_nd_update<span class="token punctuation">(</span>x<span class="token punctuation">,</span>tf<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span>mask_offset<span class="token punctuation">,</span> mask_offset<span class="token operator">+</span>mask_size<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span>tf<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token punctuation">[</span>mask_size<span class="token punctuation">,</span><span class="token number">543</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>mask_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> x

<span class="token keyword">def</span> <span class="token function">spatial_mask</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask_value<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'nan'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">'''这段代码是一个用于生成空间掩码的函数。
    它使用了TensorFlow库中的随机数生成函数，生成了一个随机的掩码位置和大小，并将掩码应用于输入张量x的第一和第二维。
    掩码的值为NaN，即将掩码位置的值替换为NaN。
    最后，函数返回处理后的张量x。'''</span>
    
    mask_offset_y <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    mask_offset_x <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    mask_size <span class="token operator">=</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>size<span class="token punctuation">)</span>
    mask_x <span class="token operator">=</span> <span class="token punctuation">(</span>mask_offset_x<span class="token operator">&lt;</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> mask_offset_x <span class="token operator">+</span> mask_size<span class="token punctuation">)</span>
    mask_y <span class="token operator">=</span> <span class="token punctuation">(</span>mask_offset_y<span class="token operator">&lt;</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> mask_offset_y <span class="token operator">+</span> mask_size<span class="token punctuation">)</span>
    mask <span class="token operator">=</span> mask_x <span class="token operator">&amp;</span> mask_y
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>where<span class="token punctuation">(</span>mask<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mask_value<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> x

<span class="token keyword">def</span> <span class="token function">augment_fn</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> always<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> max_len<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">'''这是一段Python代码，作用是对输入的坐标信息进行增强处理。
    函数名为augment_fn，参数x为输入的坐标信息，always为是否总是进行增强处理的标志，
    max_len为最大长度。首先使用tf.random.uniform函数生成一个随机数，
    如果小于0.8或always为True，则使用resample函数对坐标信息进行重采样。
    接着再次生成一个随机数，如果小于0.5或always为True，则使用flip_lr函数对坐标信息进行左右翻转。
    如果max_len不为None，则使用temporal_crop函数对坐标信息进行时间裁剪。
    再次生成一个随机数，如果小于0.75或always为True，则使用spatial_random_affine函数对坐标信息进行空间仿射变换。
    接着再次生成一个随机数，如果小于0.5或always为True，则使用temporal_mask函数对坐标信息进行时间遮盖。
    最后再次生成一个随机数，如果小于0.5或always为True，则使用spatial_mask函数对坐标信息进行空间遮盖。
    最终返回增强处理后的坐标信息。'''</span>
    
    <span class="token keyword">if</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.8</span> <span class="token keyword">or</span> always<span class="token punctuation">:</span>
        x <span class="token operator">=</span> resample<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.5</span> <span class="token keyword">or</span> always<span class="token punctuation">:</span>
        x <span class="token operator">=</span> flip_lr<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">if</span> max_len <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> temporal_crop<span class="token punctuation">(</span>x<span class="token punctuation">,</span> max_len<span class="token punctuation">)</span>
    <span class="token keyword">if</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.75</span> <span class="token keyword">or</span> always<span class="token punctuation">:</span>
        x <span class="token operator">=</span> spatial_random_affine<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">if</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.5</span> <span class="token keyword">or</span> always<span class="token punctuation">:</span>
        x <span class="token operator">=</span> temporal_mask<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">if</span> tf<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.5</span> <span class="token keyword">or</span> always<span class="token punctuation">:</span>
        x <span class="token operator">=</span> spatial_mask<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> x

<span class="token keyword">def</span> <span class="token function">get_tfrec_dataset</span><span class="token punctuation">(</span>tfrecords<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> max_len<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> drop_remainder<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Initialize dataset with TFRecords</span>
    
    <span class="token triple-quoted-string string">'''这段代码定义了一个函数，用于从TFRecords文件中读取数据集并进行预处理。
    函数的参数包括TFRecords文件路径、批次大小、最大长度、是否丢弃剩余数据、是否进行数据增强、是否打乱数据、是否重复数据等。
    函数首先使用TFRecordDataset初始化数据集，然后使用decode_tfrec函数解码数据，再使用preprocess函数进行预处理。
    如果需要重复数据，则使用repeat函数，如果需要打乱数据，则使用shuffle函数，
    并设置options.experimental_deterministic为False以确保每次打乱的结果不同。
    最后，使用padded_batch函数将数据集分成批次，并使用prefetch函数提前加载数据以提高性能。函数返回处理后的数据集。'''</span>
    
    ds <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>TFRecordDataset<span class="token punctuation">(</span>tfrecords<span class="token punctuation">,</span> num_parallel_reads<span class="token operator">=</span>tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>AUTOTUNE<span class="token punctuation">,</span> compression_type<span class="token operator">=</span><span class="token string">'GZIP'</span><span class="token punctuation">)</span>
    ds <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>decode_tfrec<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>AUTOTUNE<span class="token punctuation">)</span>
    ds <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> preprocess<span class="token punctuation">(</span>x<span class="token punctuation">,</span> augment<span class="token operator">=</span>augment<span class="token punctuation">,</span> max_len<span class="token operator">=</span>max_len<span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>AUTOTUNE<span class="token punctuation">)</span>

    <span class="token keyword">if</span> repeat<span class="token punctuation">:</span> 
        ds <span class="token operator">=</span> ds<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    <span class="token keyword">if</span> shuffle<span class="token punctuation">:</span>
        ds <span class="token operator">=</span> ds<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>shuffle<span class="token punctuation">)</span>
        options <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Options<span class="token punctuation">(</span><span class="token punctuation">)</span>
        options<span class="token punctuation">.</span>experimental_deterministic <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        ds <span class="token operator">=</span> ds<span class="token punctuation">.</span>with_options<span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> batch_size<span class="token punctuation">:</span>
        ds <span class="token operator">=</span> ds<span class="token punctuation">.</span>padded_batch<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> padding_values<span class="token operator">=</span>PAD<span class="token punctuation">,</span> padded_shapes<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">[</span>max_len<span class="token punctuation">,</span>CHANNELS<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>NUM_CLASSES<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drop_remainder<span class="token operator">=</span>drop_remainder<span class="token punctuation">)</span>

    ds <span class="token operator">=</span> ds<span class="token punctuation">.</span>prefetch<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>AUTOTUNE<span class="token punctuation">)</span>
        
    <span class="token keyword">return</span> ds

ds <span class="token operator">=</span> get_tfrec_dataset<span class="token punctuation">(</span>TRAIN_FILENAMES<span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''这段代码的作用是从TRAIN_FILENAMES中获取TFRecord数据集，并进行数据增强，每个batch的大小为1024。
然后通过for循环遍历数据集，将第一个batch的数据赋值给temp_train。'''</span>

<span class="token keyword">for</span> x <span class="token keyword">in</span> ds<span class="token punctuation">:</span>
    temp_train <span class="token operator">=</span> x
    <span class="token keyword">break</span>
</code></pre> 
<p>这段代码主要是用于可视化人体姿态估计的结果。首先导入了IPython.display和matplotlib.animation模块。然后定义了一个函数filter_nans用于过滤掉帧中存在NaN值的部分。接着使用tf.data.TFRecordDataset读取数据集，并使用decode_tfrec函数对数据进行解码。然后通过循环遍历数据集，找到第一个包含左手的帧。接着定义了一个edges列表，用于表示人体骨架的连接关系。最后定义了两个函数plot_frame和animate_frames，用于绘制单个帧和多个帧的动画。其中plot_frame函数用于绘制单个帧，包括人体关键点的坐标和骨架的连接关系；animate_frames函数用于绘制多个帧的动画，使用matplotlib.animation模块中的FuncAnimation函数实现。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> IPython<span class="token punctuation">.</span>display <span class="token keyword">import</span> HTML <span class="token comment">#要在Jupyter Notebook中打印HTML文本并以HTML格式显示，可以使用IPython.display模块中的HTML类</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>animation <span class="token keyword">as</span> animation
<span class="token keyword">from</span> matplotlib<span class="token punctuation">.</span>animation <span class="token keyword">import</span> FuncAnimation

<span class="token keyword">def</span> <span class="token function">filter_nans</span><span class="token punctuation">(</span>frames<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> frames<span class="token punctuation">[</span><span class="token operator">~</span>np<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>frames<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

ds <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>TFRecordDataset<span class="token punctuation">(</span>TRAIN_FILENAMES<span class="token punctuation">,</span> num_parallel_reads<span class="token operator">=</span>tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>AUTOTUNE<span class="token punctuation">,</span> compression_type<span class="token operator">=</span><span class="token string">'GZIP'</span><span class="token punctuation">)</span>
ds <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>decode_tfrec<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>AUTOTUNE<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>ds<span class="token punctuation">)</span>
<span class="token keyword">for</span> x <span class="token keyword">in</span> ds<span class="token punctuation">:</span>
    temp <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token string">'coordinates'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">len</span><span class="token punctuation">(</span>filter_nans<span class="token punctuation">(</span>temp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>LHAND<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span> 
    
edges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">plot_frame</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> edges<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> idxs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        
    frame<span class="token punctuation">[</span>np<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
    x <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>frame<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    y <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>frame<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>idxs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        idxs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'dodgerblue'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ax<span class="token punctuation">.</span>text<span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> idxs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        
    <span class="token keyword">for</span> edge <span class="token keyword">in</span> edges<span class="token punctuation">:</span>
        ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span>edge<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span>edge<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>y<span class="token punctuation">[</span>edge<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span>edge<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'salmon'</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_xticklabels<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>set_yticklabels<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">animate_frames</span><span class="token punctuation">(</span>frames<span class="token punctuation">,</span> edges<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> idxs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    anim <span class="token operator">=</span> FuncAnimation<span class="token punctuation">(</span>fig<span class="token punctuation">,</span> <span class="token keyword">lambda</span> frame<span class="token punctuation">:</span> plot_frame<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> edges<span class="token punctuation">,</span> idxs<span class="token punctuation">)</span><span class="token punctuation">,</span> frames<span class="token operator">=</span>frames<span class="token punctuation">,</span> interval<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HTML<span class="token punctuation">(</span>anim<span class="token punctuation">.</span>to_jshtml<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># Animate the frames</span>
animate_frames<span class="token punctuation">(</span>filter_nans<span class="token punctuation">(</span>temp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>LHAND<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>edges<span class="token operator">=</span>edges<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f8/86/Qz2D0Nzx_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">animate_frames<span class="token punctuation">(</span>filter_nans<span class="token punctuation">(</span>augment_fn<span class="token punctuation">(</span>temp<span class="token punctuation">,</span>always<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>RHAND<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>edges<span class="token operator">=</span>edges<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3d/cb/VpQ62mMI_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">animate_frames<span class="token punctuation">(</span>filter_nans<span class="token punctuation">(</span>temp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>POINT_LANDMARKS<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8e/0f/abyDVbgV_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">animate_frames<span class="token punctuation">(</span>filter_nans<span class="token punctuation">(</span>augment_fn<span class="token punctuation">(</span>temp<span class="token punctuation">,</span>always<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>POINT_LANDMARKS<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> idxs<span class="token operator">=</span>POINT_LANDMARKS<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d9/7d/ogsoeGDJ_o.png" alt="在这里插入图片描述"></p> 
<p>这里给出了三个自定义的Keras层，分别是ECA、LateDropout和CausalDWConv1D。其中ECA是一种基于通道注意力机制的卷积神经网络层，用于增强模型的特征提取能力；LateDropout是一种在训练过程中逐渐增加dropout比例的dropout层，用于防止过拟合；CausalDWConv1D是一种因果卷积层，用于处理时间序列数据。同时，还给出了一个Conv1DBlock函数，用于构建一个高效的卷积块。这些层和函数的具体实现细节可以参考代码块中的注释。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ECA</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>supports_masking <span class="token operator">=</span> <span class="token boolean">True</span>
        self<span class="token punctuation">.</span>kernel_size <span class="token operator">=</span> kernel_size
        <span class="token comment">#tf.keras.layers.Conv1D(1,1个过滤器</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Conv1D<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>kernel_size<span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">"same"</span><span class="token punctuation">,</span> use_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> mask<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
        nn <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>GlobalAveragePooling1D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> mask<span class="token operator">=</span>mask<span class="token punctuation">)</span>  <span class="token comment">#时间数据的全局平均池化操作</span>
        nn <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>nn<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
        nn <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>nn<span class="token punctuation">)</span> 
        nn <span class="token operator">=</span> tf<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>nn<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
        nn <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>nn<span class="token punctuation">)</span> 
        nn <span class="token operator">=</span> nn<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment">#增加维度</span>
        <span class="token keyword">return</span> inputs <span class="token operator">*</span> nn  

<span class="token keyword">class</span> <span class="token class-name">LateDropout</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>   
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rate<span class="token punctuation">,</span> noise_shape<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> start_step<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>  
        self<span class="token punctuation">.</span>supports_masking <span class="token operator">=</span> <span class="token boolean">True</span> 
        self<span class="token punctuation">.</span>rate <span class="token operator">=</span> rate 
        self<span class="token punctuation">.</span>start_step <span class="token operator">=</span> start_ste0p
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>rate<span class="token punctuation">,</span> noise_shape<span class="token operator">=</span>noise_shape<span class="token punctuation">)</span> 
        <span class="token triple-quoted-string string">'''tf.keras.layers.Dropout()參數
    

    rate 在 0 和 1 之間浮點數。要刪除的輸入單位的分數。
    noise_shape 一維整數張量，表示將與輸入相乘的二進製 dropout 掩碼的形狀。例如，如果您的輸入具有 (batch_size, timesteps, features) 形狀，並且您希望所有時間步的 dropout 掩碼都相同，則可以使用 noise_shape=(batch_size, 1, features) 。
    seed 用作隨機種子的 Python 整數。

Dropout 層在訓練期間的每一步以 rate 的頻率將輸入單元隨機設置為 0，這有助於防止過度擬合。未設置為 0 的輸入按 1/(1 - 比率) 放大，以使所有輸入的總和保持不變。

請注意，Dropout 層僅在 training 設置為 True 時適用，這樣在推理期間不會丟棄任何值。使用 model.fit , training 時會自動適當地設置為 True，在其他情況下，您可以在調用層時將 kwarg 顯式設置為 True。

(這與為 Dropout 層設置 trainable=False 形成對比。trainable 不會影響層的行為，因為 Dropout 沒有任何可以在訓練期間凍結的變量/權重。)'''</span>
      
    <span class="token keyword">def</span> <span class="token function">build</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span>input_shape<span class="token punctuation">)</span>
        agg <span class="token operator">=</span> tf<span class="token punctuation">.</span>VariableAggregation<span class="token punctuation">.</span>ONLY_FIRST_REPLICA
        self<span class="token punctuation">.</span>_train_counter <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">"int64"</span><span class="token punctuation">,</span> aggregation<span class="token operator">=</span>agg<span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> training<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>cond<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_train_counter <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>start_step<span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span>inputs<span class="token punctuation">,</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>inputs<span class="token punctuation">,</span> training<span class="token operator">=</span>training<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> training<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_train_counter<span class="token punctuation">.</span>assign_add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x

<span class="token keyword">class</span> <span class="token class-name">CausalDWConv1D</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> 
        kernel_size<span class="token operator">=</span><span class="token number">17</span><span class="token punctuation">,</span>
        dilation_rate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        use_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        depthwise_initializer<span class="token operator">=</span><span class="token string">'glorot_uniform'</span><span class="token punctuation">,</span>
        name<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>causal_pad <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>ZeroPadding1D<span class="token punctuation">(</span><span class="token punctuation">(</span>dilation_rate<span class="token operator">*</span><span class="token punctuation">(</span>kernel_size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_pad'</span><span class="token punctuation">)</span>
        <span class="token comment">#一維輸入的零填充層(例如時間序列)</span>
        <span class="token comment">#深度可分离卷积</span>
        self<span class="token punctuation">.</span>dw_conv <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>DepthwiseConv1D<span class="token punctuation">(</span>
                            kernel_size<span class="token punctuation">,</span>
                            strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
                            dilation_rate<span class="token operator">=</span>dilation_rate<span class="token punctuation">,</span>
                            padding<span class="token operator">=</span><span class="token string">'valid'</span><span class="token punctuation">,</span>
                            use_bias<span class="token operator">=</span>use_bias<span class="token punctuation">,</span>
                            depthwise_initializer<span class="token operator">=</span>depthwise_initializer<span class="token punctuation">,</span>
                            name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_dwconv'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>supports_masking <span class="token operator">=</span> <span class="token boolean">True</span>
        
    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>causal_pad<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dw_conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x

<span class="token keyword">def</span> <span class="token function">Conv1DBlock</span><span class="token punctuation">(</span>channel_size<span class="token punctuation">,</span>
          kernel_size<span class="token punctuation">,</span>
          dilation_rate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
          drop_rate<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
          expand_ratio<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
          se_ratio<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>
          activation<span class="token operator">=</span><span class="token string">'swish'</span><span class="token punctuation">,</span>
          name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    efficient conv1d block, @hoyso48
    '''</span>
    <span class="token keyword">if</span> name <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>get_uid<span class="token punctuation">(</span><span class="token string">"mbblock"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Expansion phase</span>
    <span class="token keyword">def</span> <span class="token function">apply</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        channels_in <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>int_shape<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        channels_expand <span class="token operator">=</span> channels_in <span class="token operator">*</span> expand_ratio

        skip <span class="token operator">=</span> inputs

        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>
            channels_expand<span class="token punctuation">,</span>
            use_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            activation<span class="token operator">=</span>activation<span class="token punctuation">,</span>
            name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_expand_conv'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>

        <span class="token comment"># Depthwise Convolution</span>
        x <span class="token operator">=</span> CausalDWConv1D<span class="token punctuation">(</span>kernel_size<span class="token punctuation">,</span>
            dilation_rate<span class="token operator">=</span>dilation_rate<span class="token punctuation">,</span>
            use_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_dwconv'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>BatchNormalization<span class="token punctuation">(</span>momentum<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_bn'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x  <span class="token operator">=</span> ECA<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>
            channel_size<span class="token punctuation">,</span>
            use_bias<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_project_conv'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token keyword">if</span> drop_rate <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>drop_rate<span class="token punctuation">,</span> noise_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_drop'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>channels_in <span class="token operator">==</span> channel_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> skip<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span>name <span class="token operator">+</span> <span class="token string">'_add'</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> x

    <span class="token keyword">return</span> <span class="token builtin">apply</span>
</code></pre> 
<p>这段代码定义了一个多头自注意力层（MultiHeadSelfAttention）和一个Transformer块（TransformerBlock）。</p> 
<p>MultiHeadSelfAttention层的作用是对输入进行多头自注意力计算，其中dim表示每个头的维度，num_heads表示头的数量，dropout表示dropout的比例。在call方法中，首先通过一个全连接层（self.qkv）将输入映射到三个维度为dim的向量q、k、v，然后将这三个向量分别拆分成num_heads个头，进行多头自注意力计算，最后将计算结果通过一个全连接层（self.proj）映射回dim维度。</p> 
<p>TransformerBlock块由两个子层组成，分别是多头自注意力层和前馈神经网络层。其中dim表示每个头的维度，num_heads表示头的数量，expand表示前馈神经网络层中间层的扩展倍数，attn_dropout表示多头自注意力层的dropout比例，drop_rate表示前馈神经网络层的dropout比例，activation表示前馈神经网络层的激活函数。在apply方法中，首先对输入进行批量归一化，然后通过多头自注意力层进行计算，再进行dropout和残差连接。接着再进行批量归一化，通过前馈神经网络层进行计算，再进行dropout和残差连接，最后返回计算结果。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MultiHeadSelfAttention</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_heads<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dim <span class="token operator">=</span> dim
        self<span class="token punctuation">.</span>scale <span class="token operator">=</span> self<span class="token punctuation">.</span>dim <span class="token operator">**</span> <span class="token operator">-</span><span class="token number">0.5</span>
        self<span class="token punctuation">.</span>num_heads <span class="token operator">=</span> num_heads
        self<span class="token punctuation">.</span>qkv <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> dim<span class="token punctuation">,</span> use_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>drop1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>proj <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>dim<span class="token punctuation">,</span> use_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>supports_masking <span class="token operator">=</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> mask<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        qkv <span class="token operator">=</span> self<span class="token punctuation">.</span>qkv<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        qkv <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Permute<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dim <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">//</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>qkv<span class="token punctuation">)</span><span class="token punctuation">)</span>
        q<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v <span class="token operator">=</span> tf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>qkv<span class="token punctuation">,</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>dim <span class="token operator">//</span> self<span class="token punctuation">.</span>num_heads<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        attn <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>q<span class="token punctuation">,</span> k<span class="token punctuation">,</span> transpose_b<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>scale

        <span class="token keyword">if</span> mask <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            mask <span class="token operator">=</span> mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

        attn <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Softmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>attn<span class="token punctuation">,</span> mask<span class="token operator">=</span>mask<span class="token punctuation">)</span>
        attn <span class="token operator">=</span> self<span class="token punctuation">.</span>drop1<span class="token punctuation">(</span>attn<span class="token punctuation">)</span>

        x <span class="token operator">=</span> attn @ v
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>dim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Permute<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>proj<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x


<span class="token keyword">def</span> <span class="token function">TransformerBlock</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_heads<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> attn_dropout<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'swish'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">apply</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> inputs
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>BatchNormalization<span class="token punctuation">(</span>momentum<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> MultiHeadSelfAttention<span class="token punctuation">(</span>dim<span class="token operator">=</span>dim<span class="token punctuation">,</span>num_heads<span class="token operator">=</span>num_heads<span class="token punctuation">,</span>dropout<span class="token operator">=</span>attn_dropout<span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>drop_rate<span class="token punctuation">,</span> noise_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>inputs<span class="token punctuation">,</span> x<span class="token punctuation">]</span><span class="token punctuation">)</span>
        attn_out <span class="token operator">=</span> x

        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>BatchNormalization<span class="token punctuation">(</span>momentum<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>dim<span class="token operator">*</span>expand<span class="token punctuation">,</span> use_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> activation<span class="token operator">=</span>activation<span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>dim<span class="token punctuation">,</span> use_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>drop_rate<span class="token punctuation">,</span> noise_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>attn_out<span class="token punctuation">,</span> x<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
    <span class="token keyword">return</span> <span class="token builtin">apply</span>
</code></pre> 
<p>这段代码定义了一个函数get_model，用于构建一个神经网络模型。该模型包含了多个卷积层和Transformer层，以及一些其他的层，最终输出一个分类结果。具体来说，该模型的输入是一个形状为(max_len,CHANNELS)的张量，其中max_len表示输入序列的最大长度，CHANNELS表示每个时间步的特征维度。该张量首先经过一个Masking层，将输入序列中的PAD值进行mask，然后经过一个Dense层和BatchNormalization层，将输入序列的特征维度转换为dim。接下来，该张量经过多个Conv1DBlock层和TransformerBlock层的堆叠，用于提取输入序列的特征。最后，该张量经过一个全局平均池化层和一个LateDropout层，最终输出一个形状为(NUM_CLASSES,)的张量，表示输入序列的分类结果。在代码的最后，使用该模型对一个样本进行预测，并计算其损失值。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_model</span><span class="token punctuation">(</span>max_len<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> dropout_step<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">192</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    inp <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>Input<span class="token punctuation">(</span><span class="token punctuation">(</span>max_len<span class="token punctuation">,</span>CHANNELS<span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Masking<span class="token punctuation">(</span>mask_value<span class="token operator">=</span>PAD<span class="token punctuation">,</span>input_shape<span class="token operator">=</span><span class="token punctuation">(</span>max_len<span class="token punctuation">,</span>CHANNELS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>inp<span class="token punctuation">)</span>
    ksize <span class="token operator">=</span> <span class="token number">17</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>dim<span class="token punctuation">,</span> use_bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'stem_conv'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>BatchNormalization<span class="token punctuation">(</span>momentum<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'stem_bn'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> TransformerBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>expand<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> TransformerBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>expand<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    <span class="token keyword">if</span> dim <span class="token operator">==</span> <span class="token number">384</span><span class="token punctuation">:</span> <span class="token comment">#for the 4x sized model</span>
        x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> TransformerBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>expand<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> Conv1DBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>drop_rate<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> TransformerBlock<span class="token punctuation">(</span>dim<span class="token punctuation">,</span>expand<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>dim<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span>activation<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'top_conv'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>GlobalAveragePooling1D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> LateDropout<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span> start_step<span class="token operator">=</span>dropout_step<span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span>NUM_CLASSES<span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'classifier'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>Model<span class="token punctuation">(</span>inp<span class="token punctuation">,</span> x<span class="token punctuation">)</span>

model <span class="token operator">=</span> get_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> model<span class="token punctuation">(</span>temp_train<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>CategoricalCrossentropy<span class="token punctuation">(</span>from_logits<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">(</span>temp_train<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>y<span class="token punctuation">)</span>
</code></pre> 
<p>这段代码是用来检查模型中的每一层是否支持掩码操作。对于每一层，如果不支持掩码操作，则打印出该层的名称和支持掩码操作的状态</p> 
<pre><code class="prism language-python"><span class="token comment">#check supports_masking</span>
<span class="token keyword">for</span> x <span class="token keyword">in</span> model<span class="token punctuation">.</span>layers<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> x<span class="token punctuation">.</span>supports_masking<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>supports_masking<span class="token punctuation">,</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> 
<p>这段代码是一个用于训练模型的函数，其中包含了一些数据预处理、模型构建、优化器设置、回调函数等步骤。具体来说，该函数会根据传入的参数进行数据集的划分，然后使用给定的模型构建函数构建模型，并使用给定的优化器和回调函数进行模型训练。训练过程中还会进行一些其他的设置，如设置学习率、权重衰减、梯度累积等。最终，该函数会返回训练好的模型、交叉验证结果和训练历史记录。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train_fold</span><span class="token punctuation">(</span>CFG<span class="token punctuation">,</span> fold<span class="token punctuation">,</span> train_files<span class="token punctuation">,</span> valid_files<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> strategy<span class="token operator">=</span>STRATEGY<span class="token punctuation">,</span> summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    seed_everything<span class="token punctuation">(</span>CFG<span class="token punctuation">.</span>seed<span class="token punctuation">)</span>
    tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    gc<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
    tf<span class="token punctuation">.</span>config<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>set_jit<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
    <span class="token keyword">if</span> CFG<span class="token punctuation">.</span>fp16<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            policy <span class="token operator">=</span> mixed_precision<span class="token punctuation">.</span>Policy<span class="token punctuation">(</span><span class="token string">'mixed_bfloat16'</span><span class="token punctuation">)</span>
            mixed_precision<span class="token punctuation">.</span>set_global_policy<span class="token punctuation">(</span>policy<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            policy <span class="token operator">=</span> mixed_precision<span class="token punctuation">.</span>Policy<span class="token punctuation">(</span><span class="token string">'mixed_float16'</span><span class="token punctuation">)</span>
            mixed_precision<span class="token punctuation">.</span>set_global_policy<span class="token punctuation">(</span>policy<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        policy <span class="token operator">=</span> mixed_precision<span class="token punctuation">.</span>Policy<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
        mixed_precision<span class="token punctuation">.</span>set_global_policy<span class="token punctuation">(</span>policy<span class="token punctuation">)</span>

    <span class="token keyword">if</span> fold <span class="token operator">!=</span> <span class="token string">'all'</span><span class="token punctuation">:</span>
        train_ds <span class="token operator">=</span> get_tfrec_dataset<span class="token punctuation">(</span>train_files<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>CFG<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> max_len<span class="token operator">=</span>CFG<span class="token punctuation">.</span>max_len<span class="token punctuation">,</span> drop_remainder<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token number">32768</span><span class="token punctuation">)</span>
        valid_ds <span class="token operator">=</span> get_tfrec_dataset<span class="token punctuation">(</span>valid_files<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>CFG<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> max_len<span class="token operator">=</span>CFG<span class="token punctuation">.</span>max_len<span class="token punctuation">,</span> drop_remainder<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        train_ds <span class="token operator">=</span> get_tfrec_dataset<span class="token punctuation">(</span>train_files<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>CFG<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> max_len<span class="token operator">=</span>CFG<span class="token punctuation">.</span>max_len<span class="token punctuation">,</span> drop_remainder<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> augment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> repeat<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token number">32768</span><span class="token punctuation">)</span>
        valid_ds <span class="token operator">=</span> <span class="token boolean">None</span>
        valid_files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    num_train <span class="token operator">=</span> count_data_items<span class="token punctuation">(</span>train_files<span class="token punctuation">)</span>
    num_valid <span class="token operator">=</span> count_data_items<span class="token punctuation">(</span>valid_files<span class="token punctuation">)</span>
    steps_per_epoch <span class="token operator">=</span> num_train<span class="token operator">//</span>CFG<span class="token punctuation">.</span>batch_size
    <span class="token keyword">with</span> strategy<span class="token punctuation">.</span>scope<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        dropout_step <span class="token operator">=</span> CFG<span class="token punctuation">.</span>dropout_start_epoch <span class="token operator">*</span> steps_per_epoch
        model <span class="token operator">=</span> get_model<span class="token punctuation">(</span>max_len<span class="token operator">=</span>CFG<span class="token punctuation">.</span>max_len<span class="token punctuation">,</span> dropout_step<span class="token operator">=</span>dropout_step<span class="token punctuation">,</span> dim<span class="token operator">=</span>CFG<span class="token punctuation">.</span>dim<span class="token punctuation">)</span>

        schedule <span class="token operator">=</span> OneCycleLR<span class="token punctuation">(</span>CFG<span class="token punctuation">.</span>lr<span class="token punctuation">,</span> CFG<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> warmup_epochs<span class="token operator">=</span>CFG<span class="token punctuation">.</span>epoch<span class="token operator">*</span>CFG<span class="token punctuation">.</span>warmup<span class="token punctuation">,</span> steps_per_epoch<span class="token operator">=</span>steps_per_epoch<span class="token punctuation">,</span> resume_epoch<span class="token operator">=</span>CFG<span class="token punctuation">.</span>resume<span class="token punctuation">,</span> decay_epochs<span class="token operator">=</span>CFG<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> lr_min<span class="token operator">=</span>CFG<span class="token punctuation">.</span>lr_min<span class="token punctuation">,</span> decay_type<span class="token operator">=</span>CFG<span class="token punctuation">.</span>decay_type<span class="token punctuation">,</span> warmup_type<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">)</span>
        decay_schedule <span class="token operator">=</span> OneCycleLR<span class="token punctuation">(</span>CFG<span class="token punctuation">.</span>lr<span class="token operator">*</span>CFG<span class="token punctuation">.</span>weight_decay<span class="token punctuation">,</span> CFG<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> warmup_epochs<span class="token operator">=</span>CFG<span class="token punctuation">.</span>epoch<span class="token operator">*</span>CFG<span class="token punctuation">.</span>warmup<span class="token punctuation">,</span> steps_per_epoch<span class="token operator">=</span>steps_per_epoch<span class="token punctuation">,</span> resume_epoch<span class="token operator">=</span>CFG<span class="token punctuation">.</span>resume<span class="token punctuation">,</span> decay_epochs<span class="token operator">=</span>CFG<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> lr_min<span class="token operator">=</span>CFG<span class="token punctuation">.</span>lr_min<span class="token operator">*</span>CFG<span class="token punctuation">.</span>weight_decay<span class="token punctuation">,</span> decay_type<span class="token operator">=</span>CFG<span class="token punctuation">.</span>decay_type<span class="token punctuation">,</span> warmup_type<span class="token operator">=</span><span class="token string">'linear'</span><span class="token punctuation">)</span>
                
        awp_step <span class="token operator">=</span> CFG<span class="token punctuation">.</span>awp_start_epoch <span class="token operator">*</span> steps_per_epoch
        <span class="token keyword">if</span> CFG<span class="token punctuation">.</span>fgm<span class="token punctuation">:</span>
            model <span class="token operator">=</span> FGM<span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span> model<span class="token punctuation">.</span>output<span class="token punctuation">,</span> delta<span class="token operator">=</span>CFG<span class="token punctuation">.</span>awp_lambda<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> start_step<span class="token operator">=</span>awp_step<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> CFG<span class="token punctuation">.</span>awp<span class="token punctuation">:</span>
            model <span class="token operator">=</span> AWP<span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">,</span> model<span class="token punctuation">.</span>output<span class="token punctuation">,</span> delta<span class="token operator">=</span>CFG<span class="token punctuation">.</span>awp_lambda<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> start_step<span class="token operator">=</span>awp_step<span class="token punctuation">)</span>

        opt <span class="token operator">=</span> tfa<span class="token punctuation">.</span>optimizers<span class="token punctuation">.</span>RectifiedAdam<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span>schedule<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>decay_schedule<span class="token punctuation">,</span> sma_threshold<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">#, clipvalue=1.)</span>
        opt <span class="token operator">=</span> tfa<span class="token punctuation">.</span>optimizers<span class="token punctuation">.</span>Lookahead<span class="token punctuation">(</span>opt<span class="token punctuation">,</span>sync_period<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>

        model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>
            optimizer<span class="token operator">=</span>opt<span class="token punctuation">,</span>
            loss<span class="token operator">=</span><span class="token punctuation">[</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>CategoricalCrossentropy<span class="token punctuation">(</span>from_logits<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> label_smoothing<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">#[tf.keras.losses.CategoricalCrossentropy(from_logits=True)],</span>
            metrics<span class="token operator">=</span><span class="token punctuation">[</span>
                <span class="token punctuation">[</span>
                tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>CategoricalAccuracy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            steps_per_execution<span class="token operator">=</span>steps_per_epoch<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> summary<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>train_ds<span class="token punctuation">,</span> valid_ds<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        schedule<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        init<span class="token operator">=</span><span class="token boolean">False</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'---------fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">---------'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'train:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num_train<span class="token punctuation">}</span></span><span class="token string"> valid:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>num_valid<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> CFG<span class="token punctuation">.</span>resume<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'resume from epoch</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>resume<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>output_dir<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>comment<span class="token punctuation">}</span></span><span class="token string">-fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">-last.h5'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> train_ds <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            model<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>train_ds<span class="token punctuation">.</span>take<span class="token punctuation">(</span>steps_per_epoch<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> valid_ds <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            model<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>valid_ds<span class="token punctuation">)</span>

    logger <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span>CSVLogger<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>output_dir<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>comment<span class="token punctuation">}</span></span><span class="token string">-fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">-logs.csv'</span></span><span class="token punctuation">)</span>
    sv_loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span>ModelCheckpoint<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>output_dir<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>comment<span class="token punctuation">}</span></span><span class="token string">-fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">-best.h5'</span></span><span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                save_weights_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'min'</span><span class="token punctuation">,</span> save_freq<span class="token operator">=</span><span class="token string">'epoch'</span><span class="token punctuation">)</span>
    snap <span class="token operator">=</span> Snapshot<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>output_dir<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>comment<span class="token punctuation">}</span></span><span class="token string">-fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> CFG<span class="token punctuation">.</span>snapshot_epochs<span class="token punctuation">)</span>
    swa <span class="token operator">=</span> SWA<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>output_dir<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>comment<span class="token punctuation">}</span></span><span class="token string">-fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> CFG<span class="token punctuation">.</span>swa_epochs<span class="token punctuation">,</span> strategy<span class="token operator">=</span>strategy<span class="token punctuation">,</span> train_ds<span class="token operator">=</span>train_ds<span class="token punctuation">,</span> valid_ds<span class="token operator">=</span>valid_ds<span class="token punctuation">,</span> valid_steps<span class="token operator">=</span><span class="token operator">-</span><span class="token punctuation">(</span>num_valid<span class="token operator">//</span><span class="token operator">-</span>CFG<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> CFG<span class="token punctuation">.</span>save_output<span class="token punctuation">:</span>
        callbacks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>logger<span class="token punctuation">)</span>
        callbacks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>snap<span class="token punctuation">)</span>
        callbacks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>swa<span class="token punctuation">)</span>
        <span class="token keyword">if</span> fold <span class="token operator">!=</span> <span class="token string">'all'</span><span class="token punctuation">:</span>
            callbacks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>sv_loss<span class="token punctuation">)</span>
        
    history <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>
        train_ds<span class="token punctuation">,</span>
        epochs<span class="token operator">=</span>CFG<span class="token punctuation">.</span>epoch<span class="token operator">-</span>CFG<span class="token punctuation">.</span>resume<span class="token punctuation">,</span>
        steps_per_epoch<span class="token operator">=</span>steps_per_epoch<span class="token punctuation">,</span>
        callbacks<span class="token operator">=</span>callbacks<span class="token punctuation">,</span>
        validation_data<span class="token operator">=</span>valid_ds<span class="token punctuation">,</span>
        verbose<span class="token operator">=</span>CFG<span class="token punctuation">.</span>verbose<span class="token punctuation">,</span>
        validation_steps<span class="token operator">=</span><span class="token operator">-</span><span class="token punctuation">(</span>num_valid<span class="token operator">//</span><span class="token operator">-</span>CFG<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">if</span> CFG<span class="token punctuation">.</span>save_output<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            model<span class="token punctuation">.</span>load_weights<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>output_dir<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>CFG<span class="token punctuation">.</span>comment<span class="token punctuation">}</span></span><span class="token string">-fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">-best.h5'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
    <span class="token keyword">if</span> fold <span class="token operator">!=</span> <span class="token string">'all'</span><span class="token punctuation">:</span>
        cv <span class="token operator">=</span> model<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>valid_ds<span class="token punctuation">,</span>verbose<span class="token operator">=</span>CFG<span class="token punctuation">.</span>verbose<span class="token punctuation">,</span>steps<span class="token operator">=</span><span class="token operator">-</span><span class="token punctuation">(</span>num_valid<span class="token operator">//</span><span class="token operator">-</span>CFG<span class="token punctuation">.</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        cv <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">return</span> model<span class="token punctuation">,</span> cv<span class="token punctuation">,</span> history

<span class="token keyword">def</span> <span class="token function">train_folds</span><span class="token punctuation">(</span>CFG<span class="token punctuation">,</span> folds<span class="token punctuation">,</span> strategy<span class="token operator">=</span>STRATEGY<span class="token punctuation">,</span> summary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> fold <span class="token keyword">in</span> folds<span class="token punctuation">:</span>
        <span class="token keyword">if</span> fold <span class="token operator">!=</span> <span class="token string">'all'</span><span class="token punctuation">:</span>
            all_files <span class="token operator">=</span> TRAIN_FILENAMES
            train_files <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> all_files <span class="token keyword">if</span> <span class="token string-interpolation"><span class="token string">f'fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">not</span> <span class="token keyword">in</span> x<span class="token punctuation">]</span>
            valid_files <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> all_files <span class="token keyword">if</span> <span class="token string-interpolation"><span class="token string">f'fold</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">in</span> x<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            train_files <span class="token operator">=</span> TRAIN_FILENAMES
            valid_files <span class="token operator">=</span> <span class="token boolean">None</span>
        
        train_fold<span class="token punctuation">(</span>CFG<span class="token punctuation">,</span> fold<span class="token punctuation">,</span> train_files<span class="token punctuation">,</span> valid_files<span class="token punctuation">,</span> strategy<span class="token operator">=</span>strategy<span class="token punctuation">,</span> summary<span class="token operator">=</span>summary<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
</code></pre> 
<p>这段代码定义了一个名为CFG的类，其中包含了一些超参数和配置信息，用于训练一个模型。其中包括数据集划分数、是否保存输出、输出目录、随机种子、最大长度、学习率、权重衰减、训练轮数、批量大小等等。此外，还包括了一些特殊的训练技巧，如混合精度训练、对抗训练、自适应权重裁剪等。这些超参数和技巧的具体含义需要根据具体的模型和任务来理解</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CFG</span><span class="token punctuation">:</span>
    n_splits <span class="token operator">=</span> <span class="token number">5</span>
    save_output <span class="token operator">=</span> <span class="token boolean">True</span>
    output_dir <span class="token operator">=</span> <span class="token string">'/kaggle/working'</span>
    
    seed <span class="token operator">=</span> <span class="token number">42</span>
    verbose <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">#0) silent 1) progress bar 2) one line per epoch</span>
    
    max_len <span class="token operator">=</span> <span class="token number">384</span>
    replicas <span class="token operator">=</span> <span class="token number">8</span>
    lr <span class="token operator">=</span> <span class="token number">5e</span><span class="token operator">-</span><span class="token number">4</span> <span class="token operator">*</span> replicas
    weight_decay <span class="token operator">=</span> <span class="token number">0.1</span>
    lr_min <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">6</span>
    epoch <span class="token operator">=</span> <span class="token number">300</span> <span class="token comment">#400</span>
    warmup <span class="token operator">=</span> <span class="token number">0</span>
    batch_size <span class="token operator">=</span> <span class="token number">64</span> <span class="token operator">*</span> replicas
    snapshot_epochs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    swa_epochs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">#list(range(epoch//2,epoch+1))</span>
    
    fp16 <span class="token operator">=</span> <span class="token boolean">True</span>
    fgm <span class="token operator">=</span> <span class="token boolean">False</span>
    awp <span class="token operator">=</span> <span class="token boolean">True</span>
    awp_lambda <span class="token operator">=</span> <span class="token number">0.2</span>
    awp_start_epoch <span class="token operator">=</span> <span class="token number">15</span>
    dropout_start_epoch <span class="token operator">=</span> <span class="token number">15</span>
    resume <span class="token operator">=</span> <span class="token number">0</span>
    decay_type <span class="token operator">=</span> <span class="token string">'cosine'</span>
    dim <span class="token operator">=</span> <span class="token number">192</span>
    comment <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'islr-fp16-192-8-seed</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>seed<span class="token punctuation">}</span></span><span class="token string">'</span></span>
</code></pre> 
<pre><code class="prism language-python">train_folds<span class="token punctuation">(</span>CFG<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cf/9a/lzGCkp5k_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/5c/fe/BcpH37JL_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/0c/85/VWJzy86e_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/95fefab7665066ecadcc3e13223ef8c5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python3安装pyhanlp最佳解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a9f17d9d8d9eda3e8fca452cf5c53701/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">监听鼠标操作</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>