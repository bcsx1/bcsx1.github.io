<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>推荐系统入门（三）：矩阵分解MF&amp;因子分解机FM（附代码） - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="推荐系统入门（三）：矩阵分解MF&amp;因子分解机FM（附代码）" />
<meta property="og:description" content="推荐系统入门（三）：矩阵分解MF&amp;因子分解机FM（附代码） 目录 推荐系统入门（三）：矩阵分解MF&amp;因子分解机FM（附代码）一、 矩阵分解MF1. 隐含语义分析技术1.1 隐语义模型1.2 矩阵分解算法1.3 矩阵分解算法求解 2. Funk-SVD算法3. Bias SVD算法4. 编程实现思考 二、 因子分解机FM1. FM模型的引入1.1 逻辑回归模型及其缺点1.2 二阶交叉项的考虑及改进 2. FM公式的理解3. FM模型的应用4. 代码实践4.1 调包实现4.1.1 电影评分数据集实战4.1.2 分类任务实战 4.2 从零实现 思考 三、实战参考资料 相关系列笔记： 推荐系统入门（一）：概述 推荐系统入门（二）：协同过滤（附代码） 推荐系统入门（三）：矩阵分解MF&amp;因子分解机FM（附代码） 推荐系统入门（四）：Wide&amp;Deep（附代码） 推荐系统入门（五）：GBDT&#43;LR（附代码） 推荐系统入门（六）：新闻推荐实践1（附代码） 推荐系统入门（七）：新闻推荐实践2（附代码） 推荐系统入门（八）：新闻推荐实践3（附代码） 推荐系统入门（九）：新闻推荐实践4（附代码） 推荐系统入门（十）：新闻推荐实践5（附代码） 一、 矩阵分解MF 矩阵分解(Matrix Factorization，MF)技术实际上就是把用户-项目评分矩阵分解为若干个部分的组合，它在 Netfilx公司举办的推荐系统大赛上得到了广泛的应用，基于矩阵分解的推荐算法本质上是一种基于模型的协同过滤推荐算法。
基于矩阵分解的推荐算法,实现简单，预测准确度高,扩展性强，在一定程度上缓解了数据的稀疏性问题，但可解释性差。
1. 隐含语义分析技术 随着用户和项目数量的急剧增长,用户和项目之间评分矩阵的维度也在在急剧增加。而由此带来的问题是计算用户与用户、项目与项目之间相似度矩阵的速度越来越慢，计算问题成为推荐系统的瓶颈。此外，随着评分矩阵越来越稀疏，推荐精度也会受到严重的影响。
对推荐系统研究过程中有很多人提出给用户或项目进行分类，但是根据传统的推荐算法很难真正发掘出用户用户潜在的兴趣度。为了解决这个问题研究人员提出从数据出发，自动找出项目的分类信息和用户的兴趣度信息。因此，隐含语义分析技术(Latent Variable Analysis） 就出现了。
隐语义模型（Latent Factor Model，LFM) 这个概念是由Netflix Prize冠军Koren在2006年提出的。隐语义模型使用一种替代的法则来发现潜在的主题或分类。隐含语义分析技术从诞生至今产生了很多著名的模型和算法。其中和该项技术相关且耳熟能详的名词有隐含主题模型(latent topic model)24、矩阵分解(matrix factorization)、pLSA、LDA 等。
协同过滤算法的特点就是完全没有利用到物品本身或者是用户自身的属性，仅仅利用了用户与物品的交互信息就可以实现推荐，是一个可解释性很强，非常直观的模型，但是也存在一些问题， 第一个就是处理稀疏矩阵的能力比较弱，所以为了使得协同过滤更好处理稀疏矩阵问题， 增强泛化能力， 从协同过滤中衍生出矩阵分解模型或者叫隐语义模型, 两者差不多说的一个意思，就是在协同过滤共现矩阵的基础上， 使用更稠密的隐向量表示用户和物品，挖掘用户和物品的隐含兴趣和隐含特征，在一定程度上弥补协同过滤模型处理稀疏矩阵能力不足的问题。
1.1 隐语义模型 隐语义模型最早在文本领域被提出，用于找到文本的隐含语义。在2006年， 被用于推荐中， 它的核心思想是通过隐含特征（latent factor）联系用户兴趣和物品（item）， 基于用户的行为找出潜在的主题和分类， 然后对item进行自动聚类，划分到不同类别/主题(用户的兴趣)。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/53ec0cd4f0d0b85e299142766cdd6985/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-24T14:58:12+08:00" />
<meta property="article:modified_time" content="2020-10-24T14:58:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">推荐系统入门（三）：矩阵分解MF&amp;因子分解机FM（附代码）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="MFFM_0"></a>推荐系统入门（三）：矩阵分解MF&amp;因子分解机FM（附代码）</h2> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#MFFM_0" rel="nofollow">推荐系统入门（三）：矩阵分解MF&amp;因子分解机FM（附代码）</a></li><li><ul><li><a href="#%09MF_14" rel="nofollow">一、 矩阵分解MF</a></li><li><ul><li><a href="#1__17" rel="nofollow">1. 隐含语义分析技术</a></li><li><ul><li><a href="#11__25" rel="nofollow">1.1 隐语义模型</a></li><li><a href="#12__77" rel="nofollow">1.2 矩阵分解算法</a></li><li><a href="#13__88" rel="nofollow">1.3 矩阵分解算法求解</a></li></ul> 
    </li><li><a href="#2_FunkSVD_92" rel="nofollow">2. Funk-SVD算法</a></li><li><a href="#3_Bias_SVD_151" rel="nofollow">3. Bias SVD算法</a></li><li><a href="#4__170" rel="nofollow">4. 编程实现</a></li><li><a href="#_256" rel="nofollow">思考</a></li></ul> 
   </li><li><a href="#%09FM_266" rel="nofollow">二、 因子分解机FM</a></li><li><ul><li><a href="#1_FM_270" rel="nofollow">1. FM模型的引入</a></li><li><ul><li><a href="#11__271" rel="nofollow">1.1 逻辑回归模型及其缺点</a></li><li><a href="#12__275" rel="nofollow">1.2 二阶交叉项的考虑及改进</a></li></ul> 
    </li><li><a href="#2_FM_288" rel="nofollow">2. FM公式的理解</a></li><li><a href="#3_FM_320" rel="nofollow">3. FM模型的应用</a></li><li><a href="#4__332" rel="nofollow">4. 代码实践</a></li><li><ul><li><a href="#41__333" rel="nofollow">4.1 调包实现</a></li><li><ul><li><a href="#411__405" rel="nofollow">4.1.1 电影评分数据集实战</a></li><li><a href="#412__460" rel="nofollow">4.1.2 分类任务实战</a></li></ul> 
     </li><li><a href="#42__499" rel="nofollow">4.2 从零实现</a></li></ul> 
    </li><li><a href="#_511" rel="nofollow">思考</a></li></ul> 
   </li><li><a href="#_513" rel="nofollow">三、实战</a></li><li><a href="#_843" rel="nofollow">参考资料</a></li></ul> 
 </li></ul> 
</div> 
<br> 
<font size="5" face="隶书" color="red">相关系列笔记：</font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/109120489">推荐系统入门（一）：概述</a></font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/109207970">推荐系统入门（二）：协同过滤（附代码）</a></font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/109258437">推荐系统入门（三）：矩阵分解MF&amp;因子分解机FM（附代码）</a></font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/109296736">推荐系统入门（四）：Wide&amp;Deep（附代码）</a></font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/109337381">推荐系统入门（五）：GBDT+LR（附代码）</a></font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/110095168">推荐系统入门（六）：新闻推荐实践1（附代码）</a></font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/110247858">推荐系统入门（七）：新闻推荐实践2（附代码）</a></font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/110389789">推荐系统入门（八）：新闻推荐实践3（附代码）</a></font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/110391355">推荐系统入门（九）：新闻推荐实践4（附代码）</a></font> 
<br> 
<font size="4" face="隶书" color="blue"><a href="https://blog.csdn.net/weixin_42691585/article/details/110678326">推荐系统入门（十）：新闻推荐实践5（附代码）</a></font> 
<p></p> 
<h3><a id="%09MF_14"></a>一、 矩阵分解MF</h3> 
<blockquote> 
 <p>  <mark>矩阵分解(Matrix Factorization，MF)技术</mark>实际上就是把用户-项目评分矩阵分解为若干个部分的组合，它在 <strong>Netfilx公司</strong>举办的推荐系统大赛上得到了广泛的应用，<mark>基于矩阵分解的推荐算法本质上是一种基于模型的协同过滤推荐算法</mark>。<br>   基于矩阵分解的推荐算法,实<strong>现简单，预测准确度高,扩展性强，在一定程度上缓解了数据的稀疏性问题，但可解释性差</strong>。</p> 
</blockquote> 
<h4><a id="1__17"></a>1. 隐含语义分析技术</h4> 
<p>  随着用户和项目数量的急剧增长,用户和项目之间评分矩阵的维度也在在急剧增加。而由此带来的问题是<strong>计算用户与用户、项目与项目之间相似度矩阵</strong>的速度越来越慢，<mark>计算问题</mark>成为推荐系统的瓶颈。此外，随着评分矩阵越来越稀疏，<mark>推荐精度</mark>也会受到严重的影响。</p> 
<p>  对推荐系统研究过程中有很多人提出给<strong>用户或项目进行分类</strong>，但是根据传统的推荐算法很难真正发掘出用户用户潜在的兴趣度。为了解决这个问题研究人员提出从数据出发，自动找出项目的分类信息和用户的兴趣度信息。因此，<mark>隐含语义分析技术(Latent Variable Analysis）</mark> 就出现了。</p> 
<p>  <mark>隐语义模型（Latent Factor Model，LFM)</mark> 这个概念是由Netflix Prize冠军Koren在2006年提出的。隐语义模型使用一种替代的法则来<strong>发现潜在的主题或分类</strong>。隐含语义分析技术从诞生至今产生了很多著名的模型和算法。其中和该项技术相关且耳熟能详的名词有<strong>隐含主题模型(latent topic model)24、矩阵分解(matrix factorization)、pLSA、LDA</strong> 等。</p> 
<p>  <mark>协同过滤算法的特点就是完全没有利用到物品本身或者是用户自身的属性，仅仅利用了用户与物品的交互信息就可以实现推荐</mark>，是一个可解释性很强，非常直观的模型，但是也存在一些问题， 第一个就是处理稀疏矩阵的能力比较弱，所以<strong>为了使得协同过滤更好处理稀疏矩阵问题， 增强泛化能力</strong>， 从协同过滤中衍生出矩阵分解模型或者叫隐语义模型, 两者差不多说的一个意思，就是<strong>在协同过滤共现矩阵的基础上， 使用更稠密的隐向量表示用户和物品，挖掘用户和物品的隐含兴趣和隐含特征，在一定程度上弥补协同过滤模型处理稀疏矩阵能力不足的问题</strong>。</p> 
<h5><a id="11__25"></a>1.1 隐语义模型</h5> 
<p>  <mark>隐语义模型</mark>最早在文本领域被提出，用于找到文本的隐含语义。在2006年， 被用于推荐中， 它的核心思想是<strong>通过隐含特征（latent factor）联系用户兴趣和物品（item）， 基于用户的行为找出潜在的主题和分类， 然后对item进行自动聚类，划分到不同类别/主题(用户的兴趣)</strong>。</p> 
<p>  这么说可能有点抽象，所以下面拿**项亮老师《推荐系统实践》**里面的那个例子看一下：</p> 
<blockquote> 
 <p>  如果我们知道了用户A和用户B两个用户<strong>在豆瓣的读书列表</strong>， 从他们的阅读列表可以看出，用户A的兴趣涉及侦探小说、科普图书以及一些计算机技术书， 而用户B的兴趣比较集中在数学和机器学习方面。 那么如何给A和B推荐图书呢？</p> 
</blockquote> 
<blockquote> 
 <p>  先说说协同过滤算法， 这样好对比不同：</p> 
 <ul><li>对于<mark>UserCF</mark>，首先需要找到和他们看了同样书的其他用户（兴趣相似的用户），然后给他们推荐那些用户喜欢的其他书。</li><li>对于<mark>ItemCF</mark>，需要给他们推荐和他们已经看的书相似的书，比如作者B看了很多关于数据挖掘的书，可以给他推荐机器学习或者模式识别方面的书。</li></ul> 
</blockquote> 
<blockquote> 
 <p>  而如果是<strong>隐语义模型</strong>的话， 它会先通过一些角度把用户兴趣和这些书归一下类， 当来了用户之后， 首先得到他的兴趣分类， 然后从这个分类中挑选他可能喜欢的书籍。</p> 
</blockquote> 
<p>  这里就看到了<strong>隐语义模型和协同过滤的不同，</strong> 这里说的角度其实就是这个隐含特征， 比如书籍的话它的内容、作者、年份、主题等都可以算隐含特征，如果这个例子还不是很清晰的话，那么下面再举个更为具体的例子，看看是如何通过隐含特征来划分开用户兴趣和物品的。但是在这之前，相信通过上面这个例子，我们已经隐隐约约感受到了协同过滤和隐语义模型的区别了，下面放上<strong>王喆老师《深度学习推荐系统》</strong> 的一个原理图作为对比，区别简直一目了然：</p> 
<p><img src="https://images2.imgbox.com/20/1c/v68qYMMf_o.png" alt="在这里插入图片描述"><br>   我们下面拿一个<strong>音乐评分</strong>的例子来具体看一下隐特征矩阵的含义。</p> 
<p>  假设每个用户都有自己的听歌偏好， 比如A喜欢带有<strong>小清新的， 吉他伴奏的</strong>， 王菲的歌曲，如果一首歌正好<strong>是王菲唱的， 并且是吉他伴奏的小清新， 那么就可以将这首歌推荐给这个用户。 也就是说是小清新， 吉他伴奏</strong>， 王菲这些元素连接起了用户和歌曲。 当然每个用户对不同的元素偏好不同， 每首歌包含的元素也不一样， 所以我们就希望找到下面的<strong>两个矩阵</strong>：</p> 
<p>  1）<mark>潜在因子—— 用户矩阵Q</mark><br>   这个矩阵表示不同用户对于不同元素的偏好程度， 1代表很喜欢， 0代表不喜欢， 比如下面这样：</p> 
<p><img src="https://images2.imgbox.com/31/d7/0kKFfw64_o.png" alt="在这里插入图片描述"><br>   2）<mark>潜在因子——音乐矩阵P</mark><br>   表示每种音乐含有各种元素的成分，比如下表中，音乐A是一个偏小清新的音乐， 含有小清新的Latent Factor的成分是0.9，重口味的成分是0.1，优雅成分0.2…</p> 
<p><img src="https://images2.imgbox.com/a3/70/4can7kZA_o.png" alt="在这里插入图片描述"></p> 
<p>  <strong>利用上面的这两个矩阵， 我们就能得出张三对音乐A的喜欢程度</strong>：</p> 
<blockquote> 
 <p>  张三对小清新的偏好 * 音乐A含有小清新的成分 + 张三对重口味的偏好 * 音乐A含有重口味的成分 + 张三对优雅的偏好 * 音乐A含有优雅的成分…,</p> 
</blockquote> 
<p>  下面是对应的<strong>两个隐向量</strong>：</p> 
<p><img src="https://images2.imgbox.com/6b/11/TvgUfftn_o.png" alt="在这里插入图片描述"><br>   根据隐向量其实就可以得到张三对音乐A的打分，即：</p> 
<blockquote> 
 <p>  0.6∗0.9+0.8∗0.1+0.1∗0.2+0.1∗0.4+0.7∗0=0.69</p> 
</blockquote> 
<p>  按照这个计算方式， 每个用户对每首歌其实都可以得到这样的分数，最后就得到了我们的<strong>评分矩阵</strong>：</p> 
<p><img src="https://images2.imgbox.com/67/c8/FluIOoOA_o.png" alt="在这里插入图片描述"><br>   这里的<strong>红色表示用户没有打分</strong>，我们通过隐向量计算得到的。</p> 
<p>  上面例子中的小清晰、 重口味、 优雅这些就可以看做是<strong>隐含特征</strong>， 而通过这个隐含特征就可以把用户的兴趣和音乐的进行一个分类，其实就是找到了每个用户每个音乐的一个<strong>隐向量</strong>表达形式（embedding的原理其实也是这样，那里是找到每个词的隐向量表达），这个隐向量就可以反映出用户的兴趣和物品的风格，并能将相似的物品推荐给相似的用户等。<strong>有没有感觉到是把协同过滤算法进行了一种延伸，把用户的相似性和物品的相似性通过了一个叫做隐向量的方式进行表达</strong>。</p> 
<p>  但是，真实的情况下我们其实是没有上面那两个矩阵的，音乐那么多，用户那么多， 我们没有办法去找一些隐特征去表示出这些东西，另外一个问题就是即使能表示也不一定准，对于每个用户或者每个物品的风格，我们每个人都有不同的看法。所以事实上，我们有的只有用户的评分矩阵，也就是最后的结果，并且一般这种矩阵长这样：</p> 
<p><img src="https://images2.imgbox.com/42/92/LOWoHIUj_o.png" alt="在这里插入图片描述"><br>   这种矩阵非常的稀疏，如果直接基于用户相似性或者物品相似性去填充这个矩阵是不太容易的， 并且很容易出现长尾问题， 所以<mark>矩阵分解</mark>就可以比较容易的解决这个问题。</p> 
<p>  <mark>矩阵分解模型</mark>其实就是<strong>在想办法基于这个评分矩阵去找到上面例子中的那两个矩阵， 也就是用户兴趣和物品的隐向量表达， 然后就把这个评分矩阵分解成Q和P两个矩阵乘积的形式， 这时候就可以基于这两个矩阵去预测某个用户对某个物品的评分了</strong>。 然后基于这个评分去进行推荐。这就是<strong>矩阵分解算法的原理</strong>。</p> 
<h5><a id="12__77"></a>1.2 矩阵分解算法</h5> 
<p>  在矩阵分解的算法框架下， <strong>我们就可以通过分解协同过滤的共现矩阵来得到用户和物品的隐向量</strong>， 就是上面的用户矩阵Q和物品矩阵P，这也是“<mark>矩阵分解</mark>”名字的由来。</p> 
<p><img src="https://images2.imgbox.com/e1/42/82gcXRXe_o.png" alt="在这里插入图片描述"><br>   矩阵分解算法将 m×n 维的共享矩阵 R 分解成 m×k 维的用户矩阵 U 和 k×n 维的物品矩阵 V 相乘的形式。其中 m 是用户数量，n 是物品数量，k 是隐向量维度，也就是隐含特征个数，只不过这里的隐含特征变得不可解释了，即我们不知道具体含义了，要模型自己去学。k 的大小决定了隐向量表达能力的强弱，k 越大，表达信息就越强，理解起来就是把用户的兴趣和物品的分类划分的越具体。</p> 
<p>  那么如果有了用户矩阵和物品矩阵的话，我们就知道了如果想计算用户 u 对物品 i 的评分， 只需要</p> 
<p><img src="https://images2.imgbox.com/78/4d/K63eQWMd_o.png" alt="在这里插入图片描述"><br>   这里的 pu 就是用户 u 的隐向量， 就类似与上面的张三向量，注意这是列向量， qi 是物品 i 的隐向量，就类似于上面的音乐A向量， 这个也是列向量，所以才用了 pTuqi 得到了一个数，也就是用户的最终评分， 计算过程其实和上面例子中一样。这里的 pu,k 和 qi,k 是模型的参数， 也正是我们想办法要计算的，pu,k 度量的是用户 u 的兴趣和第 k 个隐类的关系，而 qi,k 度量了第 k 个隐类和物品 i 之间的关系。</p> 
<h5><a id="13__88"></a>1.3 矩阵分解算法求解</h5> 
<p>  谈到矩阵分解，最常用的方法是<strong>特征值分解(EVD)或者奇异值分解(SVD）</strong>，但是这两种方式在这里不适用。</p> 
<p>  首先是<mark>EVD</mark>，它要求<strong>分解的矩阵是方阵</strong>，显然用户-物品矩阵不满足这个要求，而传统的<mark>SVD</mark>分解，会要求<strong>原始矩阵是稠密的</strong>，而我们这里的这种矩阵一般情况下是非常稀疏的，如果想用奇异值分解，就必须对缺失的元素进行填充，而一旦补全，空间复杂度就会非常高，且补的不一定对。然后就是SVD分解计算复杂度非常高，而我们的用户-物品矩阵非常大，所以基本上无法使用。</p> 
<h4><a id="2_FunkSVD_92"></a>2. Funk-SVD算法</h4> 
<p>  2006年的Netflix Prize之后， Simon Funk公布了一个矩阵分解算法叫做<strong>Funk-SVD</strong>, 后来被Netflix Prize的冠军Koren称为<mark>Latent Factor Model ( LFM )</mark>。 Funk-SVD的思想很简单： <strong>把求解上面两个矩阵的参数问题转换成一个最优化问题， 可以通过训练集里面的观察值利用最小化来学习用户矩阵和物品矩阵</strong>。</p> 
<p>  我们上面已经知道了，如果有了用户矩阵和物品矩阵的话，我们就知道了如果想计算用户 u 对物品i的评分，只需要</p> 
<p><img src="https://images2.imgbox.com/96/d1/PznyodYj_o.png" alt="在这里插入图片描述"></p> 
<p>  而现在，我们有真实的 r<sub>u,i</sub>, 但是没有pT<sub>u</sub>q<sub>i</sub>, 那么我们可以初始化一个啊，随机初始化一个用户矩阵 U 和一个物品矩阵 V ，然后不就有pT<sub>u</sub>q<sub>i</sub>了？当然你说，随机初始化的肯定不准啊，但是，有了 pT<sub>u</sub>q<sub>i</sub>之后，我们就可以计算一个猜测的 ^r<sub>ui</sub> , 即</p> 
<p><img src="https://images2.imgbox.com/91/d6/75mXN6s7_o.png" alt="在这里插入图片描述"><br>   这时候，肯定是不准，那么这个猜测的和真实值之间就会有一个<strong>误差</strong>：</p> 
<p><img src="https://images2.imgbox.com/6f/f5/LmnTab9C_o.png" alt="在这里插入图片描述"><br>   有了误差，我们就可以计算出总的<strong>误差平方和</strong>：</p> 
<p><img src="https://images2.imgbox.com/c9/01/on9Tdg8m_o.png" alt="在这里插入图片描述"><br>   有了损失，我们就可以想办法进行训练，把SSE降到最小，那么我们的两个矩阵参数就可以算出来。所以就把这个问题转成了最优化的的问题，而我们的<strong>目标函数</strong>就是：</p> 
<p><img src="https://images2.imgbox.com/e8/88/2zQkqeeP_o.png" alt="在这里插入图片描述"><br>   这里的 K 表示所有用户评分样本的集合。</p> 
<p>  有了目标函数，那么我们就可以使用梯度下降算法来降低损失。那么我们需要对目标函数求偏导，得到梯度。我们的目标函数如果是上面的SSE，我们下面来推导一下最后的导数：</p> 
<p><img src="https://images2.imgbox.com/f9/5a/1IKRrENj_o.png" alt="在这里插入图片描述"></p> 
<p>  首先我们求SSE在 pu,k （也就是Q矩阵的第 u 行 k 列）的梯度：</p> 
<p><img src="https://images2.imgbox.com/7c/1a/KSKq3MZA_o.png" alt="在这里插入图片描述"><br>   然后求SSE在 q<sub>k,i</sub> 处(也就是V矩阵的第 k 行 i 列）的梯度：</p> 
<p><img src="https://images2.imgbox.com/c0/3b/pKbnPAw6_o.png" alt="在这里插入图片描述"><br>   为了让公式更为简单， 把前面的2给他越掉， 即可以令SSE等于：</p> 
<p><img src="https://images2.imgbox.com/3c/5a/sZukAvLF_o.png" alt="在这里插入图片描述"><br>   这时候， 梯度就没有前面的系数了，有了梯度，接下来我们就可以用梯度下降算法更新梯度了：</p> 
<p><img src="https://images2.imgbox.com/42/29/ehjMTaCd_o.png" alt="在这里插入图片描述"><br>   这里的 η 是学习率，控制步长用的，但上面这个有个问题就是当参数很多的时候， 就是两个矩阵很大的时候，往往容易陷入过拟合的困境，这时候，就需要在目标函数上面加上正则化的损失，就变成了<mark>RSVD</mark>，关于RSVD的详细内容，可以参考下面给出的链接，由于篇幅原因，这里不再过多的赘述。</p> 
<p>  但在实际中，单纯的 也是不够的，还要考虑其他的一些因素，比如一个评分系统，有些固有的属性和用户物品无关，而用户也有些属性和物品无关，物品也有些属性和用户无关。因此， Netfix Prize中提出了另一种<mark>LFM</mark>，在原来的基础上加了偏置项， 来消除用户和物品打分的偏差，即预测公式如下：</p> 
<p><img src="https://images2.imgbox.com/39/c1/kWSQzqUA_o.png" alt="在这里插入图片描述"><br>   这个预测公式加入了<strong>3项偏置 μ,bu,bi</strong> , 作用如下：</p> 
<blockquote> 
 <ul><li><mark>μ : 训练集中所有记录的评分的全局平均数</mark>。在不同网站中，因为网站定位和销售物品不同，网站的整体评分分布也会显示差异。比如有的网站中用户就喜欢打高分，有的网站中用户就喜欢打低分。而全局平均数可以表示网站本身对用户评分的影响。</li><li><mark>bu : 用户偏差系数</mark>，可以使用用户 u 给出的所有评分的均值，也可以当做训练参数。这一项表示了用户的评分习惯中和物品没有关系的那种因素。比如有些用户比较苛刻，对什么东西要求很高，那么他评分就会偏低，而有些用户比较宽容，对什么东西都觉得不错，那么评分就偏高</li><li><mark>bi : 物品偏差系数</mark>， 可以使用物品 i 收到的所有评分的均值， 也可以当做训练参数。 这一项表示了物品接受的评分中和用户没有关系的因素。 比如有些物品本身质量就很高， 因此获得的评分相对比较高， 有的物品本身质量很差， 因此获得的评分相对较低。</li></ul> 
</blockquote> 
<p>  加了用户和物品的打分偏差之后， 矩阵分解得到的隐向量更能反映不同用户对不同物品的“真实”态度差异， 也就更容易捕捉评价数据中有价值的信息， 从而避免推荐结果有偏。 注意此时的SSE会发生变化：</p> 
<p><img src="https://images2.imgbox.com/b3/60/9fVFKlOA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/39/c5/iLSTV3uW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9c/16/gR3rLx0k_o.png" alt="在这里插入图片描述"><br>   此时如果把 bu 和 bi 当做训练参数的话， 那么它俩的梯度是：</p> 
<p><img src="https://images2.imgbox.com/2e/82/ZmVUOrXr_o.png" alt="在这里插入图片描述"><br>   更新公式为：</p> 
<p><img src="https://images2.imgbox.com/08/51/7Iy7LYDs_o.png" alt="在这里插入图片描述"><br>   而对于 pu,k 和 pk,i ， 导数没有变化， 更新公式也没有变化。</p> 
<h4><a id="3_Bias_SVD_151"></a>3. Bias SVD算法</h4> 
<p>  <mark>Bias SVD算法</mark>是在 LFM的预测评分公式中加入<strong>基准预测评分</strong>，从而组成的一种新算法。<strong>该算法是考虑到在推荐系统应用中，用户（项目）的某些属性与项目（用户)是无关的，同时，也需要考虑该推荐系统整体的一个评分水平，将这些影响因子考虑进去后</strong>，可得基准预测评分的公式为:</p> 
<p><img src="https://images2.imgbox.com/0f/6d/8FaMMOx8_o.png" alt="在这里插入图片描述"><br>   其中，u代表的是全局评分的平均值，表明全局评分会对预测评分产生一定的作用; bu是用户u的偏置向量，代表用户的属性因子，例如有的用户擅长打高分，有的用户则比较追求完美，打的分都比较低;bi是项目i的偏置向量，代表项目的属性因子，例如有的项目本身很优秀，则不管什么用户给的评分都相对高，但是也有的项目的质量本身就十分的劣质，那么用户就会给出很低的评分。</p> 
<p>  将基准预测信息加入隐语义模型的预测模型后，得到 <strong>Bias SVD算法预测模型</strong>。其预测公式如下式所示:</p> 
<p><img src="https://images2.imgbox.com/c5/d0/bXiSaUSd_o.png" alt="在这里插入图片描述"><br>   对该公式进行求解的过程，同<strong>隐语义模型</strong>相同，首先需要最小化损失函数，该算法的损失函数为:</p> 
<p><img src="https://images2.imgbox.com/f2/fc/I8dBRbqg_o.png" alt="在这里插入图片描述"><br>   需要求解的参数有puf 、qif、bu和bi，故采用梯度下降法时，需要对这四个参数求偏导数，即:</p> 
<p><img src="https://images2.imgbox.com/ed/fd/XYDKhBBN_o.png" alt="在这里插入图片描述"><br>   从上面的公式可以得到puf 、qif、bu和bi的最快下降递推公式为:</p> 
<p><img src="https://images2.imgbox.com/5a/00/7eTa1Y4d_o.png" alt="在这里插入图片描述"><br>   其中，α为puf、qif、bu和bi的学习率。</p> 
<h4><a id="4__170"></a>4. 编程实现</h4> 
<p>  我们这里用代码实现一下上面的算法来预测上一篇文章里面的那个预测Alice对物品5的评分， 看看矩阵分解到底是怎么进行预测或者是推荐的。 我把之前的例子拿过来：</p> 
<p><img src="https://images2.imgbox.com/24/f2/Lb58Jsks_o.png" alt="在这里插入图片描述"><br>   任务就是根据这个评分矩阵， <strong>猜测Alice</strong>对物品5的打分。</p> 
<p>  在实现SVD之前， 先来回忆一下<mark>ItemCF和UserCF</mark>对于这个问题的做法， 首先<strong>ItemCF的做法</strong>，根据已有的用户打分计算物品之间的相似度，得到物品的相似度矩阵， 根据这个相似度矩阵，选择出前K个与物品5最相似的物品，然后基于Alice对这K个物品的得分，猜测Alice对物品5的得分，有一个加权的计算公式。 <strong>UserCF的做法</strong>是根据用户对其他物品的打分，计算用户之间的相似度，选择出与Alice最相近的K个用户， 然后基于那K个用户对物品5的打分计算出Alice对物品5的打分。但是，这两种方式有个问题， 就是如果矩阵非常稀疏的话，当然这个例子是个特例，一般矩阵都是非常稀疏的， 那么预测效果就不好，因为两个相似用户对同一物品打分的概率以及Alice同时对两个相似物品打分的概率可能都比较小。另外，这两种方法显然没有考虑到全局的物品或者用户，只是基于了最相似的例子，很可能有偏。</p> 
<p>  那么<mark>SVD</mark>在解决这个问题上是这么做的： <strong>1. 首先，它会先初始化用户矩阵P和物品矩阵Q， P的维度是[users_num, F], Q的维度是[item_nums, F]</strong>，这个F是隐向量的维度。 也就是把通过隐向量的方式把用户的兴趣和F的特点关联了起来。初始化这两个矩阵的方式很多， 但根据经验， 随机数需要和1/sqrt(F)成正比下面代码中会发现。 <strong>2. 有了两个矩阵之后，我就可以根据用户已经打分的数据去更新参数，这就是训练模型的过程</strong>，方法很简单，就是遍历用户，对于每个用户，遍历它打分的物品，这样就拿到了该用户和物品的隐向量， 然后两者相乘加上偏置就是预测的评分， 这时候与真实评分有个差距， 根据上面的梯度下降就可以进行参数的更新</p> 
<p>  这样训练完之后，我们就可以得到用户Alice和物品5的隐向量，根据这个就可以预测Alice对物品5的打分。下面的代码的逻辑就是上面这两步，这里使用<strong>带有偏置项和正则项的那个SVD算法</strong>：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">SVD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rating_data<span class="token punctuation">,</span> F<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> lmbda<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> max_iter<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>F <span class="token operator">=</span> F           <span class="token comment"># 这个表示隐向量的维度</span>
        self<span class="token punctuation">.</span>P <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment">#  用户矩阵P  大小是[users_num, F]</span>
        self<span class="token punctuation">.</span>Q <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment"># 物品矩阵Q  大小是[item_nums, F]</span>
        self<span class="token punctuation">.</span>bu <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 用户偏差系数</span>
        self<span class="token punctuation">.</span>bi <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 物品偏差系数</span>
        self<span class="token punctuation">.</span>mu <span class="token operator">=</span> <span class="token number">0.0</span>        <span class="token comment"># 全局偏差系数</span>
        self<span class="token punctuation">.</span>alpha <span class="token operator">=</span> alpha   <span class="token comment"># 学习率</span>
        self<span class="token punctuation">.</span>lmbda <span class="token operator">=</span> lmbda    <span class="token comment"># 正则项系数</span>
        self<span class="token punctuation">.</span>max_iter <span class="token operator">=</span> max_iter    <span class="token comment"># 最大迭代次数</span>
        self<span class="token punctuation">.</span>rating_data <span class="token operator">=</span> rating_data <span class="token comment"># 评分矩阵</span>
        
        <span class="token comment"># 初始化矩阵P和Q, 方法很多， 一般用随机数填充， 但随机数大小有讲究， 根据经验， 随机数需要和1/sqrt(F)成正比</span>
        cnt <span class="token operator">=</span> <span class="token number">0</span>    <span class="token comment"># 统计总的打分数， 初始化mu用</span>
        <span class="token keyword">for</span> user<span class="token punctuation">,</span> items <span class="token keyword">in</span> self<span class="token punctuation">.</span>rating_data<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>P<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>F<span class="token punctuation">)</span>  <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>bu<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
            cnt <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span> 
            <span class="token keyword">for</span> item<span class="token punctuation">,</span> rating <span class="token keyword">in</span> items<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> item <span class="token operator">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>F<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">]</span>
                    self<span class="token punctuation">.</span>bi<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>mu <span class="token operator">/=</span> cnt
        
    <span class="token comment"># 有了矩阵之后， 就可以进行训练, 这里使用随机梯度下降的方式训练参数P和Q</span>
    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> user<span class="token punctuation">,</span> items <span class="token keyword">in</span> self<span class="token punctuation">.</span>rating_data<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> item<span class="token punctuation">,</span> rui <span class="token keyword">in</span> items<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    rhat_ui <span class="token operator">=</span> self<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>user<span class="token punctuation">,</span> item<span class="token punctuation">)</span>   <span class="token comment"># 得到预测评分</span>
                    <span class="token comment"># 计算误差</span>
                    e_ui <span class="token operator">=</span> rui <span class="token operator">-</span> rhat_ui
                    
                    self<span class="token punctuation">.</span>bu<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>alpha <span class="token operator">*</span> <span class="token punctuation">(</span>e_ui <span class="token operator">-</span> self<span class="token punctuation">.</span>lmbda <span class="token operator">*</span> self<span class="token punctuation">.</span>bu<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>bi<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>alpha <span class="token operator">*</span> <span class="token punctuation">(</span>e_ui <span class="token operator">-</span> self<span class="token punctuation">.</span>lmbda <span class="token operator">*</span> self<span class="token punctuation">.</span>bi<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token comment"># 随机梯度下降更新梯度</span>
                    <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>F<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>P<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>alpha <span class="token operator">*</span> <span class="token punctuation">(</span>e_ui<span class="token operator">*</span>self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>lmbda <span class="token operator">*</span> self<span class="token punctuation">.</span>P<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>alpha <span class="token operator">*</span> <span class="token punctuation">(</span>e_ui<span class="token operator">*</span>self<span class="token punctuation">.</span>P<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>lmbda <span class="token operator">*</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    
            self<span class="token punctuation">.</span>alpha <span class="token operator">*=</span> <span class="token number">0.1</span>    <span class="token comment"># 每次迭代步长要逐步缩小</span>
    
    <span class="token comment"># 预测user对item的评分， 这里没有使用向量的形式</span>
    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>P<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>F<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>bu<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>bi<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>mu   
</code></pre> 
<p>  下面我建立一个<strong>字典</strong>来存放数据，之所以用字典，是<strong>因为很多时候矩阵非常的稀疏</strong>，如果用pandas的话，会出现很多Nan的值，反而不好处理。</p> 
<pre><code class="prism language-python"><span class="token comment"># 定义数据集， 也就是那个表格， 注意这里我们采用字典存放数据， 因为实际情况中数据是非常稀疏的， 很少有情况是现在这样</span>
<span class="token keyword">def</span> <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rating_data<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
           <span class="token number">2</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
           <span class="token number">3</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
           <span class="token number">4</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
           <span class="token number">5</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rating_data
 
<span class="token comment"># 接下来就是训练和预测</span>
rating_data <span class="token operator">=</span> loadData<span class="token punctuation">(</span><span class="token punctuation">)</span>
basicsvd <span class="token operator">=</span> SVD<span class="token punctuation">(</span>rating_data<span class="token punctuation">,</span> F<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
basicsvd<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> item <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'E'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> basicsvd<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">)</span>
 
<span class="token comment">## 结果：</span>
E <span class="token number">3.252210242858994</span>
</code></pre> 
<p>  通过这个方式，得到的预测评分是3.25，这个和隐向量的维度，训练次数和训练方式有关，这里只说一下这个东西应该怎么用，具体结果可以不用纠结。</p> 
<h4><a id="_256"></a>思考</h4> 
<p>  <strong>1.矩阵分解算法后续有哪些改进呢?针对这些改进，是为了解决什么的问题呢？请大家自行探索RSVD，消除用户和物品打分偏差等</strong>。</p> 
<p>  2.<strong>矩阵分解的优缺点分析</strong></p> 
<blockquote> 
 <p>o 优点：</p> 
 <ul><li>泛化能力强：一定程度上解决了稀疏问题</li><li>空间复杂度低：由于用户和物品都用隐向量的形式存放，少了用户和物品相似度矩阵，空间复杂度由n^2降到了(n+m)*f</li><li>更好的扩展性和灵活性：矩阵分解的最终产物是用户和物品隐向量，这个深度学习的embedding思想不谋而合，因此矩阵分解的结果非常便于与其他特征进行组合和拼接，并可以与深度学习无缝结合。</li></ul> 
</blockquote> 
<blockquote> 
 <p>  但是，矩阵分解算法依然是只用到了评分矩阵，没有考虑到用户特征，物品特征和上下文特征，这使得矩阵分解丧失了利用很多有效信息的机会，同时在缺乏用户历史行为的时候，无法进行有效的推荐。所以为了解决这个问题，<strong>逻辑回归模型及后续的因子分解机模型</strong>，凭借其天然的融合不同特征的能力，逐渐在推荐系统领域得到了更广泛的应用。</p> 
</blockquote> 
<h3><a id="%09FM_266"></a>二、 因子分解机FM</h3> 
<p>  <mark>因子分解机（Factorization Machines）</mark> 是<strong>由 Steffen Rendle于2010年提出一种因子分解模型</strong>，其目的是解决传统的因子分解模型的一些<strong>缺点</strong>:<strong>首先，传统的因子模型,每遇到一种新问题,都需要在矩阵分解的基础上建立一个新模型(例如上一节的SVD)，推导出新的参数学习算法，并在学习参数过程中调节各种参数</strong>。以至于这些因子分解模型对于那些对因子分解模型的使用不是很熟悉的人来说是费事、耗力、易错的。<strong>其次，传统的因子分解模型不能很好地利用特征工程法（ feature engineering）来完成学习任务</strong>。在实际的机器学习任务中，常用的方法是<strong>首先用特征向量来表示数据，然后用一些开源工具 LibSVM或Weka等工具进行学习，方便地完成分类或决策任务</strong>。</p> 
<p>  <mark>FM的优势</mark>在于它<strong>能够通过特征向量去模拟因子分解模型它既结合了特征工程法的普遍性和适用性，又能够利用因子分解模型对不同类别的变量之间的交互作用（interaction)进行建模估计，借助开源实现工具 libFM，能够快速地完成学习任务，取得很好的精度</strong>。将这一模型命名为<mark>因子分解机</mark>，作者正是希望<strong>该模型能像支撑向量机那样简单、易用、高精度</strong>。</p> 
<h4><a id="1_FM_270"></a>1. FM模型的引入</h4> 
<h5><a id="11__271"></a>1.1 逻辑回归模型及其缺点</h5> 
<p>  <mark>FM模型</mark>其实是一种思路，具体的应用稍少。一般来说做<strong>推荐CTR预估时最简单的思路就是将特征做线性组合（逻辑回归LR），传入sigmoid中得到一个概率值</strong>，本质上这就是一个线性模型，因为sigmoid是单调增函数不会改变里面的线性模型的CTR预测顺序，因此逻辑回归模型效果会比较差。也就是L<strong>R的缺点</strong>有：</p> 
<blockquote> 
 <ul><li>是一个线性模型</li><li>每个特征对最终输出结果独立，需要手动特征交叉（xi*xj），比较麻烦</li></ul> 
</blockquote> 
<h5><a id="12__275"></a>1.2 二阶交叉项的考虑及改进</h5> 
<p>  LR模型的上述缺陷（主要是手动做特征交叉比较麻烦），干脆就考虑所有的二阶交叉项，也就是将<strong>目标函数</strong>由原来的</p> 
<p><img src="https://images2.imgbox.com/c7/36/DTOLgPNy_o.png" alt="在这里插入图片描述"><br>   变为</p> 
<p><img src="https://images2.imgbox.com/47/22/YZONcwZ6_o.png" alt="在这里插入图片描述"><br>   但这个式子有一个问题，只有当xi与xj均不为0时这个二阶交叉项才会生效，后面这个特征交叉项本质是和多项式核SVM等价的，为了解决这个问题，我们的FM登场了！</p> 
<p>  <mark>FM模型</mark>使用了如下的<strong>优化函数</strong>：</p> 
<p><img src="https://images2.imgbox.com/4b/75/OW987YTa_o.png" alt="在这里插入图片描述"><br>   事实上做的唯一改动就是<strong>把 wij 替换成了 &lt;vi,vj&gt;</strong> ，大家应该就看出来了，这实际上就有深度学习的意味在里面了，<strong>实质上就是给每个 xi 计算一个embedding，然后将两个向量之间的embedding做内积得到之前所谓的 wij 好处就是这个模型泛化能力强</strong> ，即使两个特征之前从未在训练集中同时出现，我们也不至于像之前一样训练不出 wij ，事实上只需要 xi 和其他的 xk 同时出现过就可以计算出 xi 的embedding！</p> 
<h4><a id="2_FM_288"></a>2. FM公式的理解</h4> 
<p>  从公式来看，模型前半部分就是普通的<strong>LR线性组合</strong>，后半部分的交叉项：<strong>特征组合</strong>。首先，单从模型表达能力上来看，FM是要强于LR的，至少它不会比LR弱，当交叉项参数wij全为0的时候，整个模型就退化为普通的LR模型。对于有n个特征的模型，特征组合的参数数量共有<strong>1+2+3+⋯+n−1=n(n−1)/2</strong>个，并且任意两个参数之间是独立的。所以说特征数量比较多的时候，特征组合之后，维度自然而然就高了。</p> 
<blockquote> 
 <p>  定理：<mark>任意一个实对称矩阵（正定矩阵） W 都存在一个矩阵 V ，使得 W=V.VT 成立</mark>。</p> 
</blockquote> 
<p>  类似地，所有二次项参数 ωij 可以组成一个对称阵 W （为了方便说明FM的由来，对角元素可以设置为正实数），那么这个矩阵就可以分解为 W=VTV ， V 的第 j 列( vj )便是第 j 维特征( xj )的隐向量。</p> 
<p><img src="https://images2.imgbox.com/65/3a/GYuZYPET_o.png" alt="在这里插入图片描述"><br>   需要估计的参数有 ω0∈R ， ωi∈R ， V∈R ， &lt;⋅,⋅&gt; 是长度为 k 的两个向量的点乘，公式如下：</p> 
<p><img src="https://images2.imgbox.com/3c/dc/TQBFk57x_o.png" alt="在这里插入图片描述"><br>   上面的公式中：</p> 
<blockquote> 
 <ul><li>ω0 为全局偏置；</li><li>ωi 是模型第 i 个变量的权重;</li><li>ωij=&lt;vi,vj&gt; 特征 i 和 j 的交叉权重;</li><li>vi 是第 i 维特征的隐向量;</li><li>&lt;⋅,⋅&gt; 代表向量点积;</li><li>k(k&lt;&lt;n) 为隐向量的长度，包含 k 个描述特征的因子。</li></ul> 
</blockquote> 
<p>  FM模型中二次项的参数数量减少为 kn 个，远少于多项式模型的参数数量。另外，参数因子化使得xhxi 的参数和 xixj 的参数不再是相互独立的，因此我们可以在样本稀疏的情况下相对合理地估计FM的二次项参数。具体来说，xhxi和 xixj 的系数分别为 &lt;vh,vi&gt; 和 &lt;vi,vj&gt; ，它们之间有共同项 vi 。也就是说，所有包含“ xi 的非零组合特征”（存在某个 j≠i ，使得 xixj≠0 ）的样本都可以用来学习隐向量 vi ，这很大程度上避免了数据稀疏性造成的影响。而在多项式模型中, whi 和 wij 是相互独立的。</p> 
<p>  显而易见，<strong>FM的公式是一个通用的拟合方程，可以采用不同的损失函数用于解决regression、classification等问题</strong>，比如可以<strong>采用MSE（Mean Square Error）loss function来求解回归问题</strong>，也可以<strong>采用Hinge/Cross-Entropy loss来求解分类问题</strong>。当然，在进行二元分类时，FM的输出需要使用sigmoid函数进行变换，该原理与LR是一样的。直观上看，FM的复杂度是O(kn2) 。但是FM的二次项可以化简，其复杂度可以优化到 O(kn) 。由此可见，FM可以在线性时间对新样本作出预测。</p> 
<p>  证明：</p> 
<p><img src="https://images2.imgbox.com/b8/fd/5T7TRiHM_o.png" alt="在这里插入图片描述">  解释：</p> 
<blockquote> 
 <ul><li>vi,f是一个具体的值；</li><li>第1个等号：对称矩阵 W 对角线上半部分；</li><li>第2个等号：把向量内积 vi,vj 展开成累加和的形式；</li><li>第3个等号：提出公共部分；</li><li>第4个等号：i 和 j 相当于是一样的，表示成平方过程。</li></ul> 
</blockquote> 
<h4><a id="3_FM_320"></a>3. FM模型的应用</h4> 
<p>  最直接的想法就是直接<strong>把FM得到的结果放进sigmoid中输出一个概率值，由此做<mark>CTR预估</mark></strong>，事实上我们也可以做召回。</p> 
<p>  由于FM模型是利用两个特征的Embedding做内积得到<strong>二阶特征交叉的权重</strong>，那么我们可以将训练好的FM特征取出离线存好，之后用来做<strong>KNN向量检索</strong>。</p> 
<p>  工业应用的具体操作步骤：</p> 
<blockquote> 
 <ul><li>离线训练好FM模型（学习目标可以是CTR）</li><li>将训练好的FM模型Embedding取出</li><li>将每个uid对应的Embedding做avg pooling（平均）形成该用户最终的Embedding，item也做同样的操作</li><li>将所有的Embedding向量放入Faiss等</li><li>线上uid发出请求，取出对应的user embedding，进行检索召回</li></ul> 
</blockquote> 
<h4><a id="4__332"></a>4. 代码实践</h4> 
<h5><a id="41__333"></a>4.1 调包实现</h5> 
<p>  <mark>调包版</mark></p> 
<p>  直接看Github官方仓库：<a href="https://github.com/coreylynch/pyFM">https://github.com/coreylynch/pyFM</a>，里面有介绍如何安装以及使用，下面搬运一遍：</p> 
<p>  <strong>安装</strong><br>   方法一：<mark>直接pip install</mark></p> 
<pre><code class="prism language-python">pip install git<span class="token operator">+</span>https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>coreylynch<span class="token operator">/</span>pyFM
</code></pre> 
<p>  方法二：<mark>手动安装</mark></p> 
<p>  输入上面这行代码应能下载这个包并安装，如果安装失败可能是网络原因，这时可以考虑手动下载这个包然后手动<strong>python setup.py install</strong>安装，这时候通常会报错，去掉<strong>setup.py</strong>文件里面的libraries=[“m”]一行再重新安装即可</p> 
<p>  具体操作是：</p> 
<blockquote> 
 <ul><li>在<a href="https://github.com/coreylynch/pyFM">https://github.com/coreylynch/pyFM</a>中手动下载包</li><li>将包解压，更改里面的setup.py文件，去掉setup.py文件里面的libraries=[“m”]一行</li><li>cd到当前文件夹下python setup.py install</li></ul> 
</blockquote> 
<p>  <strong>测试</strong><br>   这部分主要作为简单上手让读者了解如何使用这个包~<br>   第一步：<mark>导包</mark></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> pyfm <span class="token keyword">import</span> pylibfm 
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_extraction <span class="token keyword">import</span> DictVectorizer 
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
</code></pre> 
<p>  第二步：<mark>创建训练集并转换成one-hot编码的特征形式</mark></p> 
<pre><code class="prism language-python">train <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> <span class="token string">"43"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">33</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> <span class="token string">"20"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">55</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> <span class="token string">"10"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
v <span class="token operator">=</span> DictVectorizer<span class="token punctuation">(</span><span class="token punctuation">)</span>
X <span class="token operator">=</span> v<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>train<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>X<span class="token punctuation">.</span>toarray<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>  看看结果，对比一下维度是否符合预期：</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">55</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">0</span><span class="token punctuation">.</span>  <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>  第三步：<mark>创建标签</mark><br>   这里简单创建了一个全1的标签：</p> 
<pre><code class="prism language-python">y <span class="token operator">=</span> np<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span>X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
y

array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>  第四步：<mark>训练并预测</mark><br>   就和调用sklearn的包是一样的用法：</p> 
<pre><code class="prism language-python">fm <span class="token operator">=</span> pylibfm<span class="token punctuation">.</span>FM<span class="token punctuation">(</span><span class="token punctuation">)</span>
fm<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
fm<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>v<span class="token punctuation">.</span>transform<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"user"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> <span class="token string">"10"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="411__405"></a>4.1.1 电影评分数据集实战</h6> 
<p>  数据集在这里下载，数据集本地具体保存路径读者自行阅读代码找找： <a href="http://www.grouplens.org/system/files/ml-100k.zip" rel="nofollow">http://www.grouplens.org/system/files/ml-100k.zip</a></p> 
<p>  <strong>导包，并定义一个导入指定格式数据集的函数</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_extraction <span class="token keyword">import</span> DictVectorizer
<span class="token keyword">from</span> pyfm <span class="token keyword">import</span> pylibfm

<span class="token comment"># Read in data</span>
<span class="token keyword">def</span> <span class="token function">loadData</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span>path<span class="token operator">=</span><span class="token string">"ml-100k/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    users<span class="token operator">=</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    items<span class="token operator">=</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token operator">+</span>filename<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
            <span class="token punctuation">(</span>user<span class="token punctuation">,</span>movieid<span class="token punctuation">,</span>rating<span class="token punctuation">,</span>ts<span class="token punctuation">)</span><span class="token operator">=</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
            data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"movie_id"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>movieid<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            y<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>rating<span class="token punctuation">)</span><span class="token punctuation">)</span>
            users<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
            items<span class="token punctuation">.</span>add<span class="token punctuation">(</span>movieid<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> users<span class="token punctuation">,</span> items<span class="token punctuation">)</span>
</code></pre> 
<p>  <strong>导入训练集和测试集，并转换格式</strong></p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> train_users<span class="token punctuation">,</span> train_items<span class="token punctuation">)</span> <span class="token operator">=</span> loadData<span class="token punctuation">(</span><span class="token string">"ua.base"</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>test_data<span class="token punctuation">,</span> y_test<span class="token punctuation">,</span> test_users<span class="token punctuation">,</span> test_items<span class="token punctuation">)</span> <span class="token operator">=</span> loadData<span class="token punctuation">(</span><span class="token string">"ua.test"</span><span class="token punctuation">)</span>
v <span class="token operator">=</span> DictVectorizer<span class="token punctuation">(</span><span class="token punctuation">)</span>
X_train <span class="token operator">=</span> v<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>train_data<span class="token punctuation">)</span>
X_test <span class="token operator">=</span> v<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span>
</code></pre> 
<p>  <strong>训练模型并测试</strong></p> 
<pre><code class="prism language-python"><span class="token comment"># Build and train a Factorization Machine</span>
fm <span class="token operator">=</span> pylibfm<span class="token punctuation">.</span>FM<span class="token punctuation">(</span>num_factors<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> num_iter<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> task<span class="token operator">=</span><span class="token string">"regression"</span><span class="token punctuation">,</span> initial_learning_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> learning_rate_schedule<span class="token operator">=</span><span class="token string">"optimal"</span><span class="token punctuation">)</span>
fm<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span>y_train<span class="token punctuation">)</span>
</code></pre> 
<p>  <strong>预测结果打印误差</strong></p> 
<pre><code class="prism language-python">preds <span class="token operator">=</span> fm<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"FM MSE: %.4f"</span> <span class="token operator">%</span> mean_squared_error<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span>preds<span class="token punctuation">)</span><span class="token punctuation">)</span>

FM MSE<span class="token punctuation">:</span> <span class="token number">0.8873</span>
</code></pre> 
<h6><a id="412__460"></a>4.1.2 分类任务实战</h6> 
<p>  <strong>导入数据</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_extraction <span class="token keyword">import</span> DictVectorizer
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>cross_validation <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> pyfm <span class="token keyword">import</span> pylibfm

<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> make_classification

X<span class="token punctuation">,</span> y <span class="token operator">=</span> make_classification<span class="token punctuation">(</span>n_samples<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>n_features<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> n_clusters_per_class<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token punctuation">{<!-- --></span>v<span class="token punctuation">:</span> k <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token keyword">for</span> i <span class="token keyword">in</span> X<span class="token punctuation">]</span>

X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>data<span class="token punctuation">,</span> y<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

v <span class="token operator">=</span> DictVectorizer<span class="token punctuation">(</span><span class="token punctuation">)</span>
X_train <span class="token operator">=</span> v<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span>
X_test <span class="token operator">=</span> v<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>
</code></pre> 
<p>  <strong>建模型</strong></p> 
<p>  我们可以看到主要改变的参数是num_factors和tasks，读者可以想想为什么</p> 
<pre><code class="prism language-python">fm <span class="token operator">=</span> pylibfm<span class="token punctuation">.</span>FM<span class="token punctuation">(</span>num_factors<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> num_iter<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> task<span class="token operator">=</span><span class="token string">"classification"</span><span class="token punctuation">,</span> initial_learning_rate<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> learning_rate_schedule<span class="token operator">=</span><span class="token string">"optimal"</span><span class="token punctuation">)</span>
fm<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span>y_train<span class="token punctuation">)</span>
</code></pre> 
<p>  由于是分类任务，误差函数肯定不一样</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> log_loss
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Validation log loss: %.4f"</span> <span class="token operator">%</span> log_loss<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span>fm<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

Validation log loss<span class="token punctuation">:</span> <span class="token number">1.3678</span>
</code></pre> 
<h5><a id="42__499"></a>4.2 从零实现</h5> 
<p>  <strong>数据集介绍</strong></p> 
<p>  <mark>criteo</mark>：criteo是非常经典的<strong>点击率预估数据集</strong>，其中连续特征有13个，类别型特征有26个，没有提供特征的具体名称，特征分别如下：</p> 
<pre><code class="prism language-python">dense_feats：<span class="token string">'I1'</span><span class="token punctuation">,</span> <span class="token string">'I2'</span><span class="token punctuation">,</span> <span class="token string">'I3'</span><span class="token punctuation">,</span> <span class="token string">'I4'</span><span class="token punctuation">,</span> <span class="token string">'I5'</span><span class="token punctuation">,</span> <span class="token string">'I6'</span><span class="token punctuation">,</span> <span class="token string">'I7'</span><span class="token punctuation">,</span> <span class="token string">'I8'</span><span class="token punctuation">,</span> <span class="token string">'I9'</span><span class="token punctuation">,</span> <span class="token string">'I10'</span><span class="token punctuation">,</span><span class="token string">'I11'</span><span class="token punctuation">,</span> <span class="token string">'I12'</span><span class="token punctuation">,</span> <span class="token string">'I13'</span>
sparse_feats<span class="token punctuation">:</span>  <span class="token string">'C1'</span><span class="token punctuation">,</span> <span class="token string">'C2'</span><span class="token punctuation">,</span> <span class="token string">'C3'</span><span class="token punctuation">,</span> <span class="token string">'C4'</span><span class="token punctuation">,</span> <span class="token string">'C5'</span><span class="token punctuation">,</span> <span class="token string">'C6'</span><span class="token punctuation">,</span> <span class="token string">'C7'</span><span class="token punctuation">,</span> <span class="token string">'C8'</span><span class="token punctuation">,</span> <span class="token string">'C9'</span><span class="token punctuation">,</span> <span class="token string">'C10'</span><span class="token punctuation">,</span> <span class="token string">'C11'</span><span class="token punctuation">,</span> <span class="token string">'C12'</span><span class="token punctuation">,</span> <span class="token string">'C13'</span><span class="token punctuation">,</span> <span class="token string">'C14'</span><span class="token punctuation">,</span> <span class="token string">'C15'</span><span class="token punctuation">,</span> <span class="token string">'C16'</span><span class="token punctuation">,</span> <span class="token string">'C17'</span><span class="token punctuation">,</span> <span class="token string">'C18'</span><span class="token punctuation">,</span> <span class="token string">'C19'</span><span class="token punctuation">,</span> <span class="token string">'C20'</span><span class="token punctuation">,</span> <span class="token string">'C21'</span><span class="token punctuation">,</span> <span class="token string">'C22'</span><span class="token punctuation">,</span> <span class="token string">'C23'</span><span class="token punctuation">,</span> <span class="token string">'C24'</span><span class="token punctuation">,</span> <span class="token string">'C25'</span><span class="token punctuation">,</span> <span class="token string">'C26'</span>
</code></pre> 
<p>  代码参考源代码文档中的<mark>FM.py</mark></p> 
<h4><a id="_511"></a>思考</h4> 
<p>  <strong>请大家思考一下FM存在的问题， 以及可以从哪些地方再进行改进？</strong></p> 
<h3><a id="_513"></a>三、实战</h3> 
<p>  <mark>MF.py</mark></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> warnings
<span class="token keyword">import</span> random<span class="token punctuation">,</span> math<span class="token punctuation">,</span> os
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>callbacks <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend <span class="token keyword">as</span> K

<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> LabelEncoder
<span class="token keyword">import</span> faiss
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>

<span class="token comment"># 评价指标</span>
<span class="token comment"># 推荐系统推荐正确的商品数量占用户实际点击的商品数量</span>
<span class="token keyword">def</span> <span class="token function">Recall</span><span class="token punctuation">(</span>Rec_dict<span class="token punctuation">,</span> Val_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    Rec_dict: 推荐算法返回的推荐列表, 形式:{uid: {item1, item2,...}, uid: {item1, item2,...}, ...} 
    Val_dict: 用户实际点击的商品列表, 形式:{uid: {item1, item2,...}, uid: {item1, item2,...}, ...}
    '''</span>
    hit_items <span class="token operator">=</span> <span class="token number">0</span>
    all_items <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> uid<span class="token punctuation">,</span> items <span class="token keyword">in</span> Val_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rel_set <span class="token operator">=</span> items
        rec_set <span class="token operator">=</span> Rec_dict<span class="token punctuation">[</span>uid<span class="token punctuation">]</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> rec_set<span class="token punctuation">:</span>
            <span class="token keyword">if</span> item <span class="token keyword">in</span> rel_set<span class="token punctuation">:</span>
                hit_items <span class="token operator">+=</span> <span class="token number">1</span>
        all_items <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rel_set<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token builtin">round</span><span class="token punctuation">(</span>hit_items <span class="token operator">/</span> all_items <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 推荐系统推荐正确的商品数量占给用户实际推荐的商品数</span>
<span class="token keyword">def</span> <span class="token function">Precision</span><span class="token punctuation">(</span>Rec_dict<span class="token punctuation">,</span> Val_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    Rec_dict: 推荐算法返回的推荐列表, 形式:{uid: {item1, item2,...}, uid: {item1, item2,...}, ...} 
    Val_dict: 用户实际点击的商品列表, 形式:{uid: {item1, item2,...}, uid: {item1, item2,...}, ...}
    '''</span>
    hit_items <span class="token operator">=</span> <span class="token number">0</span>
    all_items <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> uid<span class="token punctuation">,</span> items <span class="token keyword">in</span> Val_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rel_set <span class="token operator">=</span> items
        rec_set <span class="token operator">=</span> Rec_dict<span class="token punctuation">[</span>uid<span class="token punctuation">]</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> rec_set<span class="token punctuation">:</span>
            <span class="token keyword">if</span> item <span class="token keyword">in</span> rel_set<span class="token punctuation">:</span>
                hit_items <span class="token operator">+=</span> <span class="token number">1</span>
        all_items <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rec_set<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token builtin">round</span><span class="token punctuation">(</span>hit_items <span class="token operator">/</span> all_items <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 所有被推荐的用户中,推荐的商品数量占这些用户实际被点击的商品数量</span>
<span class="token keyword">def</span> <span class="token function">Coverage</span><span class="token punctuation">(</span>Rec_dict<span class="token punctuation">,</span> Trn_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    Rec_dict: 推荐算法返回的推荐列表, 形式:{uid: {item1, item2,...}, uid: {item1, item2,...}, ...} 
    Trn_dict: 训练集用户实际点击的商品列表, 形式:{uid: {item1, item2,...}, uid: {item1, item2,...}, ...}
    '''</span>
    rec_items <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    all_items <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> uid <span class="token keyword">in</span> Rec_dict<span class="token punctuation">:</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> Trn_dict<span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">:</span>
            all_items<span class="token punctuation">.</span>add<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> Rec_dict<span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">:</span>
            rec_items<span class="token punctuation">.</span>add<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>rec_items<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_items<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 使用平均流行度度量新颖度,如果平均流行度很高(即推荐的商品比较热门),说明推荐的新颖度比较低</span>
<span class="token keyword">def</span> <span class="token function">Popularity</span><span class="token punctuation">(</span>Rec_dict<span class="token punctuation">,</span> Trn_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    Rec_dict: 推荐算法返回的推荐列表, 形式:{uid: {item1, item2,...}, uid: {item1, item2,...}, ...} 
    Trn_dict: 训练集用户实际点击的商品列表, 形式:{uid: {item1, item2,...}, uid: {item1, item2,...}, ...}
    '''</span>
    pop_items <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> uid <span class="token keyword">in</span> Trn_dict<span class="token punctuation">:</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> Trn_dict<span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> item <span class="token operator">not</span> <span class="token keyword">in</span> pop_items<span class="token punctuation">:</span>
                pop_items<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
            pop_items<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    
    pop<span class="token punctuation">,</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
    <span class="token keyword">for</span> uid <span class="token keyword">in</span> Rec_dict<span class="token punctuation">:</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> Rec_dict<span class="token punctuation">[</span>uid<span class="token punctuation">]</span><span class="token punctuation">:</span>
            pop <span class="token operator">+=</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>pop_items<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 物品流行度分布满足长尾分布,取对数可以使得平均值更稳定</span>
            num <span class="token operator">+=</span> <span class="token number">1</span>  
    <span class="token keyword">return</span> <span class="token builtin">round</span><span class="token punctuation">(</span>pop <span class="token operator">/</span> num<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment"># 将几个评价指标指标函数一起调用</span>
<span class="token keyword">def</span> <span class="token function">rec_eval</span><span class="token punctuation">(</span>val_rec_items<span class="token punctuation">,</span> val_user_items<span class="token punctuation">,</span> trn_user_items<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'recall:'</span><span class="token punctuation">,</span>Recall<span class="token punctuation">(</span>val_rec_items<span class="token punctuation">,</span> val_user_items<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'precision'</span><span class="token punctuation">,</span>Precision<span class="token punctuation">(</span>val_rec_items<span class="token punctuation">,</span> val_user_items<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'coverage'</span><span class="token punctuation">,</span>Coverage<span class="token punctuation">(</span>val_rec_items<span class="token punctuation">,</span> trn_user_items<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Popularity'</span><span class="token punctuation">,</span>Popularity<span class="token punctuation">(</span>val_rec_items<span class="token punctuation">,</span> trn_user_items<span class="token punctuation">)</span><span class="token punctuation">)</span> 


<span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>root_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取数据时，定义的列名</span>
    rnames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">,</span><span class="token string">'movie_id'</span><span class="token punctuation">,</span><span class="token string">'rating'</span><span class="token punctuation">,</span><span class="token string">'timestamp'</span><span class="token punctuation">]</span>
    data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_path<span class="token punctuation">,</span> <span class="token string">'ratings.dat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'::'</span><span class="token punctuation">,</span> engine<span class="token operator">=</span><span class="token string">'python'</span><span class="token punctuation">,</span> names<span class="token operator">=</span>rnames<span class="token punctuation">)</span>

    lbe <span class="token operator">=</span> LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
    data<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> lbe<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    data<span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> lbe<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 

    <span class="token comment"># 直接这么分是不是可能会存在验证集中的用户或者商品不在训练集合中呢？那这种的操作一半是怎么进行划分</span>
    trn_data_<span class="token punctuation">,</span> val_data_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>data<span class="token punctuation">,</span> data<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span>

    trn_data <span class="token operator">=</span> trn_data_<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    val_data <span class="token operator">=</span> val_data_<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>

    trn_user_items <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    val_user_items <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    
    <span class="token comment"># 将数组构造成字典的形式{user_id: [item_id1, item_id2,...,item_idn]}</span>
    <span class="token keyword">for</span> user<span class="token punctuation">,</span> movies <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>trn_data<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>trn_data<span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        trn_user_items<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>movies<span class="token punctuation">)</span>

    <span class="token keyword">for</span> user<span class="token punctuation">,</span> movies <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>val_data<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>val_data<span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        val_user_items<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>movies<span class="token punctuation">)</span>

    <span class="token keyword">return</span> trn_user_items<span class="token punctuation">,</span> val_user_items<span class="token punctuation">,</span> trn_data_<span class="token punctuation">,</span> val_data_<span class="token punctuation">,</span> data

<span class="token comment"># 矩阵分解模型</span>
<span class="token keyword">def</span> <span class="token function">MF</span><span class="token punctuation">(</span>n_users<span class="token punctuation">,</span> n_items<span class="token punctuation">,</span> embedding_dim<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    K<span class="token punctuation">.</span>clear_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    input_users <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
    users_emb <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>n_users<span class="token punctuation">,</span> embedding_dim<span class="token punctuation">)</span><span class="token punctuation">(</span>input_users<span class="token punctuation">)</span>
    
    input_movies <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
    movies_emb <span class="token operator">=</span> Embedding<span class="token punctuation">(</span>n_items<span class="token punctuation">,</span> embedding_dim<span class="token punctuation">)</span><span class="token punctuation">(</span>input_movies<span class="token punctuation">)</span>
    
    users <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>users_emb<span class="token punctuation">)</span>
    users <span class="token operator">=</span> Reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>embedding_dim<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span>
    
    movies <span class="token operator">=</span> BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>movies_emb<span class="token punctuation">)</span>
    movies <span class="token operator">=</span> Reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>embedding_dim<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>movies<span class="token punctuation">)</span>
    
    output <span class="token operator">=</span> Dot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>users<span class="token punctuation">,</span> movies<span class="token punctuation">]</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span><span class="token punctuation">[</span>input_users<span class="token punctuation">,</span> input_movies<span class="token punctuation">]</span><span class="token punctuation">,</span> outputs<span class="token operator">=</span>output<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span><span class="token string">'mse'</span><span class="token punctuation">,</span> optimizer<span class="token operator">=</span><span class="token string">'adam'</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 为了方便获取模型中的某些层，进行如下属性设置</span>
    model<span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span><span class="token string">'user_input'</span><span class="token punctuation">,</span> input_users<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span><span class="token string">'user_embedding'</span><span class="token punctuation">,</span> users_emb<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span><span class="token string">'movie_input'</span><span class="token punctuation">,</span> input_movies<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>__setattr__<span class="token punctuation">(</span><span class="token string">'movie_embedding'</span><span class="token punctuation">,</span> movies_emb<span class="token punctuation">)</span>

    <span class="token keyword">return</span> model


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment"># K表示最终给用户推荐的商品数量，N表示候选推荐商品为用户交互过的商品相似商品的数量</span>
    k <span class="token operator">=</span> <span class="token number">80</span>
    N <span class="token operator">=</span> <span class="token number">10</span>

    <span class="token comment"># 读取数据</span>
    root_path <span class="token operator">=</span> <span class="token string">'./data/ml-1m/'</span>
    trn_user_items<span class="token punctuation">,</span> val_user_items<span class="token punctuation">,</span> trn_data<span class="token punctuation">,</span> val_data<span class="token punctuation">,</span> data <span class="token operator">=</span> get_data<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span>

    <span class="token comment"># 模型保存的名称</span>
    <span class="token comment"># 定义模型训练时监控的相关参数</span>
    model_path <span class="token operator">=</span> <span class="token string">'mf.h5'</span>
    checkpoint <span class="token operator">=</span> ModelCheckpoint<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> save_best_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
                                 mode<span class="token operator">=</span><span class="token string">'min'</span><span class="token punctuation">,</span> save_weights_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    reduce_lr <span class="token operator">=</span> ReduceLROnPlateau<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> min_lr<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    earlystopping <span class="token operator">=</span> EarlyStopping<span class="token punctuation">(</span>monitor<span class="token operator">=</span><span class="token string">'val_loss'</span><span class="token punctuation">,</span> min_delta<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> patience<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'min'</span><span class="token punctuation">)</span>
    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>checkpoint<span class="token punctuation">,</span> reduce_lr<span class="token punctuation">,</span> earlystopping<span class="token punctuation">]</span>

    <span class="token comment"># 计算user和item的数量</span>
    n_users <span class="token operator">=</span> trn_data<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
    n_items <span class="token operator">=</span> trn_data<span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
    embedding_dim <span class="token operator">=</span> <span class="token number">64</span> <span class="token comment"># 用户及商品的向量维度</span>
    model <span class="token operator">=</span> MF<span class="token punctuation">(</span>n_users<span class="token punctuation">,</span> n_items<span class="token punctuation">,</span> embedding_dim<span class="token punctuation">)</span> <span class="token comment"># 训练模型</span>

    <span class="token comment"># 模型的输入是user_id和movie_id</span>
    hist <span class="token operator">=</span> model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span><span class="token punctuation">[</span>trn_data<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> trn_data<span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">]</span><span class="token punctuation">,</span> 
                    trn_data<span class="token punctuation">[</span><span class="token string">'rating'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> validation_split<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
                    callbacks<span class="token operator">=</span>callbacks<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># 获取模型的Embedding层</span>
    user_embedding_model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>model<span class="token punctuation">.</span>user_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>model<span class="token punctuation">.</span>user_embedding<span class="token punctuation">)</span>
    item_embedding_model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>model<span class="token punctuation">.</span>movie_input<span class="token punctuation">,</span> outputs<span class="token operator">=</span>model<span class="token punctuation">.</span>movie_embedding<span class="token punctuation">)</span>
    
    <span class="token comment"># 将验证集中的user_id进行排序,方便与faiss搜索的结果进行对应</span>
    val_uids <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>val_data<span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    trn_items <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>trn_data<span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 获取训练数据的实际索引与相对索引，</span>
    <span class="token comment"># 实际索引指的是数据中原始的user_id</span>
    <span class="token comment"># 相对索引指的是，排序后的位置索引，这个对应的是faiss库搜索得到的结果索引</span>
    trn_items_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>trn_items<span class="token punctuation">)</span><span class="token punctuation">:</span>
        trn_items_dict<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> item

    <span class="token comment"># 获取训练集中的所有的商品，由于数据进行了训练和验证集的划分，所以实际的训练集中的商品可能不包含整个数据集中的所有商品</span>
    <span class="token comment"># 但是为了在向量索引的时候方便与原始索引相对应</span>
    items_dict <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>trn_data<span class="token punctuation">[</span><span class="token string">'movie_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    user_embs <span class="token operator">=</span> user_embedding_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>val_uids<span class="token punctuation">]</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    item_embs <span class="token operator">=</span> item_embedding_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>trn_items<span class="token punctuation">]</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 使用向量搜索库进行最近邻搜索</span>
    index <span class="token operator">=</span> faiss<span class="token punctuation">.</span>IndexFlatIP<span class="token punctuation">(</span>embedding_dim<span class="token punctuation">)</span>
    index<span class="token punctuation">.</span>add<span class="token punctuation">(</span>item_embs<span class="token punctuation">)</span>
    <span class="token comment"># ascontiguousarray函数将一个内存不连续存储的数组转换为内存连续存储的数组，使得运行速度更快。</span>
    D<span class="token punctuation">,</span> I <span class="token operator">=</span> index<span class="token punctuation">.</span>search<span class="token punctuation">(</span>np<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>user_embs<span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span>

    <span class="token comment"># 将推荐结果转换成可以计算评价指标的格式</span>
    <span class="token comment"># 选择最相似的TopN个item</span>
    val_rec <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> u <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>val_uids<span class="token punctuation">)</span><span class="token punctuation">:</span>
        items <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> trn_items_dict<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>I<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 先将相对索引转换成原数据中的user_id</span>
        items <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">not</span> <span class="token keyword">in</span> trn_user_items<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>N<span class="token punctuation">]</span> <span class="token comment"># 过滤掉用户在训练集中交互过的商品id，并选择相似度最高的前N个</span>
        val_rec<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span> <span class="token comment"># 将结果转换成统一的形式，便于计算模型的性能指标</span>

    <span class="token comment"># 计算评价指标</span>
    rec_eval<span class="token punctuation">(</span>val_rec<span class="token punctuation">,</span> val_user_items<span class="token punctuation">,</span> trn_user_items<span class="token punctuation">)</span>

</code></pre> 
<p>  <mark>FM.py</mark></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np 

<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>callbacks <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>backend <span class="token keyword">as</span> K

<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> LabelEncoder
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

<span class="token comment"># dense特征取对数　　sparse特征进行类别编码</span>
<span class="token keyword">def</span> <span class="token function">process_feat</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> dense_feats<span class="token punctuation">,</span> sparse_feats<span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> data<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># dense</span>
    df_dense <span class="token operator">=</span> df<span class="token punctuation">[</span>dense_feats<span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> f <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>dense_feats<span class="token punctuation">)</span><span class="token punctuation">:</span>
        df_dense<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">=</span> df_dense<span class="token punctuation">[</span>f<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> x<span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">else</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token comment"># sparse</span>
    df_sparse <span class="token operator">=</span> df<span class="token punctuation">[</span>sparse_feats<span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token string">'-1'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> f <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>sparse_feats<span class="token punctuation">)</span><span class="token punctuation">:</span>
        lbe <span class="token operator">=</span> LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        df_sparse<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">=</span> lbe<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df_sparse<span class="token punctuation">[</span>f<span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    df_new <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>df_dense<span class="token punctuation">,</span> df_sparse<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> df_new

<span class="token comment"># FM 特征组合层</span>
<span class="token keyword">class</span> <span class="token class-name">crossLayer</span><span class="token punctuation">(</span>layers<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>input_dim<span class="token punctuation">,</span> output_dim<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>crossLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>input_dim <span class="token operator">=</span> input_dim
        self<span class="token punctuation">.</span>output_dim <span class="token operator">=</span> output_dim
        <span class="token comment"># 定义交叉特征的权重</span>
        self<span class="token punctuation">.</span>kernel <span class="token operator">=</span> self<span class="token punctuation">.</span>add_weight<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'kernel'</span><span class="token punctuation">,</span> 
                                     shape<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>input_dim<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_dim<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     initializer<span class="token operator">=</span><span class="token string">'glorot_uniform'</span><span class="token punctuation">,</span>
                                     trainable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 对照上述公式中的二次项优化公式一起理解</span>
        a <span class="token operator">=</span> K<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>K<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>kernel<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> K<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>K<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> K<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>kernel<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0.5</span> <span class="token operator">*</span> K<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>a<span class="token operator">-</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 定义FM模型</span>
<span class="token keyword">def</span> <span class="token function">FM</span><span class="token punctuation">(</span>feature_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
    inputs <span class="token operator">=</span> Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">(</span>feature_dim<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 一阶特征</span>
    linear <span class="token operator">=</span> Dense<span class="token punctuation">(</span>units<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
                   kernel_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                   bias_regularizer<span class="token operator">=</span>regularizers<span class="token punctuation">.</span>l2<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
    
    <span class="token comment"># 二阶特征</span>
    cross <span class="token operator">=</span> crossLayer<span class="token punctuation">(</span>feature_dim<span class="token punctuation">)</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
    add <span class="token operator">=</span> Add<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>linear<span class="token punctuation">,</span> cross<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 将一阶特征与二阶特征相加构建FM模型</span>
    
    pred <span class="token operator">=</span> Activation<span class="token punctuation">(</span><span class="token string">'sigmoid'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>inputs<span class="token punctuation">,</span> outputs<span class="token operator">=</span>pred<span class="token punctuation">)</span>
    
    model<span class="token punctuation">.</span>summary<span class="token punctuation">(</span><span class="token punctuation">)</span>    
    model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>loss<span class="token operator">=</span><span class="token string">'binary_crossentropy'</span><span class="token punctuation">,</span>
                  optimizer<span class="token operator">=</span>optimizers<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  metrics<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'binary_accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> model    


<span class="token comment"># 读取数据</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'loading data...'</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'./data/kaggle_train.csv'</span><span class="token punctuation">)</span>

<span class="token comment"># dense 特征开头是I，sparse特征开头是C，Label是标签</span>
cols <span class="token operator">=</span> data<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>values
dense_feats <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> cols <span class="token keyword">if</span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'I'</span><span class="token punctuation">]</span>
sparse_feats <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> cols <span class="token keyword">if</span> f<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'C'</span><span class="token punctuation">]</span>

<span class="token comment"># 对dense数据和sparse数据分别处理</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'processing features'</span><span class="token punctuation">)</span>
feats <span class="token operator">=</span> process_feat<span class="token punctuation">(</span>data<span class="token punctuation">,</span> dense_feats<span class="token punctuation">,</span> sparse_feats<span class="token punctuation">)</span>

<span class="token comment"># 划分训练和验证数据</span>
x_trn<span class="token punctuation">,</span> x_tst<span class="token punctuation">,</span> y_trn<span class="token punctuation">,</span> y_tst <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>feats<span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Label'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2020</span><span class="token punctuation">)</span>

<span class="token comment"># 定义模型</span>
model <span class="token operator">=</span> FM<span class="token punctuation">(</span>feats<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 训练模型</span>
model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>x_trn<span class="token punctuation">,</span> y_trn<span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span> validation_data<span class="token operator">=</span><span class="token punctuation">(</span>x_tst<span class="token punctuation">,</span> y_tst<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>  结果：<br> <img src="https://images2.imgbox.com/23/3b/c1uO1zTi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bc/d0/zwCY8RQ9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_843"></a>参考资料</h3> 
<ol><li>Datawhale组队学习：<a href="https://github.com/datawhalechina/team-learning-rs/tree/master/RecommendationSystemFundamentals">推荐系统基础</a></li><li>张川. 基于矩阵分解的协同过滤推荐算法研究[D].吉林大学,2013.</li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e7cbf5361ca8a2e820e88e467a39289a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python数据解析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e3b9e984e709dffc8ae8c49d8f7d636d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">用了这么多年分页PageHelper，才发现自己一直用错了！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>