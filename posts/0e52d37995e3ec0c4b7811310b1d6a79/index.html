<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HCIP-7.5交换机RSTP快速生成树协议原理 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="HCIP-7.5交换机RSTP快速生成树协议原理" />
<meta property="og:description" content="HCIP-7.5交换机RSTP快速生成树协议原理 1、RSTP快速生成树（rapid spanning Tree Protocol2、RSTP基本计算过程3、RSTP端口状态描述3.1、交换机端口状态（五转三）去掉了侦听状态3.2、P/A机制(Proposal/Agreement机制) 4、RSTP的报文5、RSTP与STP变化6、配置RSTP－基本配置7、RSTP如何实现快速收敛7.1、STP的收敛机制7.2、RSTP的收敛机制 8、RSTP对STP保护机制 1、RSTP快速生成树（rapid spanning Tree Protocol RSTP（802.1w）是STP的升级版本。最根本的原因是BPDU的变化。最早在IEEE 802.1W-2001中提出，这种协议在网络结构发生变化时，能更快的收敛网络。它比802.1d多了一种端口类型：备份端口（backup port）类型，用来做指定端口的备份。
RSTP的主要功能：
1、 发现并生成局域网的一个最佳树型拓扑结构；
2、 发现拓扑故障并随之进行恢复，自动更新网络拓扑结构，启用备份链路，同时保持最佳树型结构。
2、RSTP基本计算过程 选举预备端口和备份端口
DP(指定端口)用来发送或者中继最优的BPDU。
SWC E0/1为DP中继BPDU --&gt;LANA 云 --&gt;SWD 同时也通过LANA 云–&gt;E0/2 给自己。
Backup备份端口：这种由于学习到自己发送的配置BPDU报文而阻塞的端口。
上图中，E0/2在RSTP网络中作为备份端口。阻止接收到自己发送的配置BPDU报文。E0/1和E0/2口同时接入到以太网的同一网段，E0/1为指定端口，E0/2优先级低，则E0/2端口为备份端口。
Alternate预备端口：是由于学习到其它网桥发送的配置BPDU报文而阻塞的端口。
上图中，SWC学习到SWB发送的置BPDU报文，在进行计算后，为防止环路形成而阻塞的端口。与STP一样。
可以发现交换机端口角色-增加了Backup备份端口角色。
RSTP中的端口
端口角色描述Root Port 根端口是所在交换机上离根交换机最近的端口，稳定时处于转发状态。Designated Port指定端口转发所连接的网段发往根交换机方向的数据和从交换机方向发往所连接的网段的数据，稳定时处于转发状态。Backup备份端口不处于转发状态，所属交换机为端口所连网段的指定交换机。指定端口的备份端口。Alternate预备端口不处于转发状态，所属交换机不是端口所连网段的指定交换机。 边缘端口的引入
边缘端口（Edge Port）是指不直接与任何交换机连接，也不通过端口所连接的网络间接与任何交换机相连的端口。 当把一个交换机端口配置成为边缘端口之后，一旦端口被启用，则端口立即成为指定端口（Designated Port） ，立即进入转发状态。 和STP的配置命令相同但是在STP中是补丁，而在RSTP 是定义。
每次边缘端口PC关机后，由末节交换机将TCN上报到根桥，又由根桥发送TC扩散到全网二层网络，每个交换机都要刷新MAC地址。定义了边缘端口可以防止这一现象产生，并拒绝接入BPDU。
总结：边缘端口不参与RSTP运算，可以由Disable直接转到Forwarding状态，且不经历时延，就像在端口上将STP禁用。
3、RSTP端口状态描述 3.1、交换机端口状态（五转三）去掉了侦听状态 在RSTP中只有三种端口状态，Discarding、Learning和Forwarding。802.1D中的禁止端口，监听端口，阻塞端口在802.1W中统一合并为禁止端口。
端口状态描述Discarding丢弃状态此状态下端口对接收到的数据做丢弃处理，端口不转发数据帧，不学习MAC地址表。Learning学习状态此状态下端口不转发数据帧，但是学习MAC地址表，参与计算生成树，接收并发送BPDU。Forwarding转发状态此状态下端口正常转发数据帧，学习MAC地址表，参与计算生成树，接收并发送BPDU。 端口状态迁移原则
在没有临时环路风险的情况下，使原本处于不转发状态下的端口在成为指定端口或根端口之后，尽可能快的进入Forwarding状态，加快收敛速度。
存在环路风险，需要等待其他交换机完成计算。
因此，如何确认网络中有没有环路风险是RSTP的重要内容。
3.2、P/A机制(Proposal/Agreement机制) Proposal－Agreement” 提议和同意。
当SWD成为根桥后，SWD的E0/1由阻塞端口变成指定端口，正处于Discarding或Learning状态的时候，向SWC的E0/1发出传递Proposal位被置位的BPDU。这条BPDU作用提议是SWC的E0/1指定端口希望进入Forwarding状态。
当下游交设备SWC的E0/1端口收到这条被置位的BPDU后，将其它其他端口(如果端口是非边缘)的E0/2指定端口变成禁止端口则会进入Discarding状态，防止产生环路。然后会设置自己的synced变量，然后传回其中Agreement位被置位的BPDU。这时SWC的E0/1端口由原来的指定端口转化为根端口。
SWD收到Agreement位被置位的BPDU，SWD的E0/1马上转入Forwarding状态。
SWC的E0/2端口由禁止端口变成指定端口，从Discarding状态正处于Discarding或Learning状态的时候，向SWA的E0/1发出传递Proposal位被置位的BPDU。
SWA状态和上面一样忽略。
协商机制的前提－点到点链路
使用“Proposal－Agreement”的前提 是泛洪这两种消息的链路均为点到点链路，点到点链路是指两个交换机直接相连的链路。之所以必须使用点到点链路，是因为点到多点链路有环路风险。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/0e52d37995e3ec0c4b7811310b1d6a79/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-30T23:57:07+08:00" />
<meta property="article:modified_time" content="2023-06-30T23:57:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HCIP-7.5交换机RSTP快速生成树协议原理</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>HCIP-7.5交换机RSTP快速生成树协议原理</h4> 
 <ul><li><a href="#1RSTPrapid_spanning_Tree_Protocol_1" rel="nofollow">1、RSTP快速生成树（rapid spanning Tree Protocol</a></li><li><a href="#2RSTP_8" rel="nofollow">2、RSTP基本计算过程</a></li><li><a href="#3RSTP_38" rel="nofollow">3、RSTP端口状态描述</a></li><li><ul><li><a href="#31_39" rel="nofollow">3.1、交换机端口状态（五转三）去掉了侦听状态</a></li><li><a href="#32PAProposalAgreement_55" rel="nofollow">3.2、P/A机制(Proposal/Agreement机制)</a></li></ul> 
  </li><li><a href="#4RSTP_94" rel="nofollow">4、RSTP的报文</a></li><li><a href="#5RSTPSTP_122" rel="nofollow">5、RSTP与STP变化</a></li><li><a href="#6RSTP_142" rel="nofollow">6、配置RSTP－基本配置</a></li><li><a href="#7RSTP_245" rel="nofollow">7、RSTP如何实现快速收敛</a></li><li><ul><li><a href="#71STP_246" rel="nofollow">7.1、STP的收敛机制</a></li><li><a href="#72RSTP_264" rel="nofollow">7.2、RSTP的收敛机制</a></li></ul> 
  </li><li><a href="#8RSTPSTP_289" rel="nofollow">8、RSTP对STP保护机制</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1RSTPrapid_spanning_Tree_Protocol_1"></a>1、RSTP快速生成树（rapid spanning Tree Protocol</h2> 
<p>RSTP（802.1w）是STP的升级版本。最根本的原因是BPDU的变化。最早在IEEE 802.1W-2001中提出，这种协议在网络结构发生变化时，能更快的收敛网络。它比802.1d多了一种端口类型：备份端口（backup port）类型，用来做指定端口的备份。</p> 
<p>RSTP的主要功能：<br> 1、 发现并生成局域网的一个最佳树型拓扑结构；<br> 2、 发现拓扑故障并随之进行恢复，自动更新网络拓扑结构，启用备份链路，同时保持最佳树型结构。</p> 
<h2><a id="2RSTP_8"></a>2、RSTP基本计算过程</h2> 
<p>选举<strong>预备端口</strong>和<strong>备份端口</strong><br> DP(指定端口)用来发送或者中继最优的BPDU。<br> <img src="https://images2.imgbox.com/34/65/PVSC1s7i_o.png" alt="RSTP基本计算过程" width="500" height="260"><br> SWC E0/1为DP中继BPDU --&gt;LANA 云 --&gt;SWD 同时也通过LANA 云–&gt;E0/2 给自己。</p> 
<p><code>Backup备份端口</code>：这种由于学习到自己发送的配置BPDU报文而阻塞的端口。</p> 
<p>上图中，E0/2在RSTP网络中作为备份端口。阻止接收到自己发送的配置BPDU报文。E0/1和E0/2口同时接入到以太网的同一网段，E0/1为指定端口，E0/2优先级低，则E0/2端口为备份端口。</p> 
<p><code>Alternate预备端口</code>：是由于学习到其它网桥发送的配置BPDU报文而阻塞的端口。</p> 
<p>上图中，SWC学习到SWB发送的置BPDU报文，在进行计算后，为防止环路形成而阻塞的端口。与STP一样。</p> 
<p>可以发现交换机端口角色-增加了<code>Backup备份端口</code>角色。<br> RSTP中的端口</p> 
<table><thead><tr><th align="left">端口角色</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">Root Port 根端口</td><td align="left">是所在交换机上离根交换机最近的端口，稳定时处于转发状态。</td></tr><tr><td align="left">Designated Port指定端口</td><td align="left">转发所连接的网段发往根交换机方向的数据和从交换机方向发往所连接的网段的数据，稳定时处于转发状态。</td></tr><tr><td align="left">Backup备份端口</td><td align="left">不处于转发状态，所属交换机为端口所连网段的指定交换机。指定端口的备份端口。</td></tr><tr><td align="left">Alternate预备端口</td><td align="left">不处于转发状态，所属交换机不是端口所连网段的指定交换机。</td></tr></tbody></table> 
<p><strong>边缘端口的引入</strong></p> 
<p><code>边缘端口</code>（Edge Port）是指不直接与任何交换机连接，也不通过端口所连接的网络间接与任何交换机相连的端口。 当把一个交换机端口配置成为边缘端口之后，一旦端口被启用，则端口立即成为<strong>指定端口</strong>（Designated Port） ，立即进入转发状态。 和STP的配置命令相同但是在STP中是补丁，而在RSTP 是定义。</p> 
<p>每次边缘端口PC关机后，由末节交换机将TCN上报到根桥，又由根桥发送TC扩散到全网二层网络，每个交换机都要刷新MAC地址。定义了边缘端口可以防止这一现象产生，并拒绝接入BPDU。</p> 
<p>总结：边缘端口不参与RSTP运算，可以由Disable直接转到Forwarding状态，且不经历时延，就像在端口上将STP禁用。</p> 
<h2><a id="3RSTP_38"></a>3、RSTP端口状态描述</h2> 
<h3><a id="31_39"></a>3.1、交换机端口状态（五转三）去掉了侦听状态</h3> 
<p>在RSTP中只有三种端口状态，Discarding、Learning和Forwarding。802.1D中的禁止端口，监听端口，<strong>阻塞端口</strong>在802.1W中统一合并为<strong>禁止端口</strong>。</p> 
<table><thead><tr><th align="left">端口状态</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">Discarding丢弃状态</td><td align="left">此状态下端口对接收到的数据做丢弃处理，端口<code>不转发</code>数据帧，<code>不学习</code>MAC地址表。</td></tr><tr><td align="left">Learning学习状态</td><td align="left">此状态下端口<code>不转发</code>数据帧，但是学习MAC地址表，参与计算生成树，接收并发送BPDU。</td></tr><tr><td align="left">Forwarding转发状态</td><td align="left">此状态下端口<code>正常转发</code>数据帧，学习MAC地址表，参与计算生成树，接收并发送BPDU。</td></tr></tbody></table> 
<p><strong>端口状态迁移原则</strong></p> 
<ul><li> <p>在没有临时环路风险的情况下，使原本处于不转发状态下的端口在成为指定端口或根端口之后，尽可能快的进入Forwarding状态，加快收敛速度。</p> </li><li> <p>存在环路风险，需要等待其他交换机完成计算。</p> </li></ul> 
<p>因此，如何确认网络中有没有环路风险是RSTP的重要内容。</p> 
<h3><a id="32PAProposalAgreement_55"></a>3.2、P/A机制(Proposal/Agreement机制)</h3> 
<p>Proposal－Agreement” 提议和同意。<br> <img src="https://images2.imgbox.com/3c/4c/fFHJqL1F_o.png" alt="提议和同意." width="600" height="340"></p> 
<p>当SWD成为根桥后，SWD的E0/1由阻塞端口变成指定端口，正处于Discarding或Learning状态的时候，向SWC的E0/1发出传递Proposal位被置位的BPDU。这条BPDU作用提议是SWC的E0/1指定端口希望进入Forwarding状态。</p> 
<p>当下游交设备SWC的E0/1端口收到这条被置位的BPDU后，将其它<strong>其他</strong>端口(如果端口是非边缘)的E0/2指定端口变成禁止端口则会进入Discarding状态，防止产生环路。然后会设置自己的synced变量，然后传回其中Agreement位被置位的BPDU。这时SWC的E0/1端口由原来的指定端口转化为根端口。</p> 
<p>SWD收到Agreement位被置位的BPDU，SWD的E0/1马上转入Forwarding状态。</p> 
<p>SWC的E0/2端口由禁止端口变成指定端口，从Discarding状态正处于Discarding或Learning状态的时候，向SWA的E0/1发出传递Proposal位被置位的BPDU。</p> 
<p>SWA状态和上面一样忽略。</p> 
<p><strong>协商机制的前提－点到点链路</strong><br> 使用“Proposal－Agreement”的前提 是泛洪这两种消息的链路均为点到点链路，点到点链路是指两个交换机直接相连的链路。之所以必须使用点到点链路，是因为点到多点链路有环路风险。</p> 
<p>点到多点链路有环路风险。<br> <img src="https://images2.imgbox.com/9f/e2/ow7fnjO8_o.png" alt="环路风险" width="600" height="340"></p> 
<p>如图所示，SWA向外发出一个Proposal提议之后，由于SWC是网络边缘，因此迅速返回一个Agreement，使SWA的新指定端口进入转发状态，但是此时SWB、 SWD和SWE等尚未完成Proposal－ Agreement的泛洪过程，因此，网络中存在环路风险。</p> 
<p>STP端口状态的切换必须被动的等待时间的超时。而RSTP端口状态的切换却是一种<strong>主动的协商</strong>。STP中的非根网桥只能被动的中继BPDU。而RSTP中的非根网桥对BPDU的中继具有一定的主动性。</p> 
<p>RSTP（快速生成树协议）是生成树协议的一种改进版，旨在提高生成树协议的收敛速度。RSTP的基本计算包括以下几个方面：</p> 
<pre><code>桥优先级（Bridge Priority）：RSTP中，每个桥都有一个桥优先级，其默认值为32768。桥优先级用于确定生成树算法中根桥的位置和生成树的根端口。桥的优先级越低，就越有可能成为根桥。

端口优先级（Port Priority）：RSTP中，每个端口都有一个端口优先级，其默认值为128。端口优先级用于确定在每个桥中将成为根端口和设计端口的端口。端口优先级越低，就越有可能成为根端口或者设计端口。

端口状态：RSTP中，每个端口都有一个状态，其包括两个状态码：指定端口（designated port）和非指定端口（non-designated port）。指定端口是指在某个时刻被选为某个网段的活动端口，而非指定端口则是被堵塞或处于备份状态。

转发延迟时间：RSTP中，每个端口在状态转移时会有一个转发延迟时间，其默认值为2秒。这个时间用于等待其他端口是否有更优的路径，以免产生环路。

最大转发延迟时间：RSTP中，每个桥会有一个最大转发延迟时间，其默认值为15秒。如果一个端口的转发延迟时间超过了15秒，就会被认为是断开的。
</code></pre> 
<p>基于以上的基本计算，RSTP可以实现快速的收敛和恢复。在RSTP中，当一个端口或者桥状态改变时，可以快速计算出新的生成树，从而保证网络的高可靠性和高性能。</p> 
<h2><a id="4RSTP_94"></a>4、RSTP的报文</h2> 
<p><img src="https://images2.imgbox.com/82/0b/TrAytBCW_o.png" alt="RSTP的报文"></p> 
<p>Version： 协议版本，STP为0x00，<strong>RSTP为0x02</strong>，MSTP为0x03。</p> 
<p>Message type： BPDU类型：</p> 
<ul><li>0x00：STP的Configuration BPDU</li><li>0x80：STP的TCN BPDU（Topology Change Notification BPDU）</li><li>0x02：<strong>RST BPDU</strong>（Rapid Spanning-Tree BPDU）或者MST BPDU（Multiple Spanning-Tree BPDU）</li></ul> 
<p>Flag： 标志位，只使用了最低位和最高位，最低为TC标志，最高为TCA标志。</p> 
<ul><li>Bit7：TCA (Topology Change Acknowledgement)</li><li>Bit6：<code>Agreement</code></li><li>Bit5：Forwarding</li><li>Bit4：Learning</li><li>Bit3和Bit2：端口角色<br> 00：未知<br> 01(低位为1高位为0)：Alternate / Backup<br> 10(低位为0高位为1)：根端口<br> 11：指定端口</li><li>Bit1：<code>Proposal</code></li><li>Bit0：TC (Topology Change)</li></ul> 
<p><img src="https://images2.imgbox.com/5b/ff/y7fcbDrE_o.png" alt="RSTP的报文抓包" width="600" height="300"><br> Version 1 Length：Version1 BPDU的长度，值固定为0。只在RSTP和MSTP的BPDU中出现，STP的BPDU没有此字段。</p> 
<h2><a id="5RSTPSTP_122"></a>5、RSTP与STP变化</h2> 
<ul><li>由802.1D升级到802.1w</li><li>最重要的区别即快速收敛（本质在于BPDU结构的变化）</li><li>端口角色的增加（RP、DP、AP，现在增加一个backup备份端口）</li><li>端口状态的变迁（5种变为3种，disable和LIS被去掉）</li><li>边缘端口的定义（在802.1D是补丁，在802.1w是定义的边缘端口，命令是一样的）</li><li>RSTP的proposal提议和aggrement同意机制（发生在点到点链路）</li><li>配置BPDU报文的发送方式<br> RSTP在拓扑稳定后，无论非根桥设备是否接收到根桥传来的配置BPDU报文，非根桥设备仍然按照hello time规定的时间间隔发送配置BPDU，该行为完全由每台设备自主进行。</li><li>更短的BPDU超时计时<br> 如果一个端口连续3个Hello Time时间内没有收上游设备发送过来的配置BPDU，那么该设备认为与此邻居之间的协商失败。而不像STP那样需要先等待一个Max Age。</li><li>BPDU进行比较<br> 如果该端口存储的RST BPDU的优先级高于收到的RST BPDU，那么该端口会直接丢弃收到的RSTP BPDU，立即回应自身存储的RSTP BPDU。当上游设备收到下游设备回应的RSTP BPDU后，上游设备会根据收到的RSTP BPDU报文中相应的字段立即更新自己存储的RSTP BPDU。</li><li>维持树<br> rstp 中每台非根桥都会以自己的hello time时间间隔向其他非根桥发送 BPDU，以确认树的存在。<br> 如果突然某个拓扑结构发生了改变，如一个端口down掉了，那么该交换机会向其他交换机发送，TC BPDU来清空各个交换机的MAC地址表。</li></ul> 
<p><strong>STP兼容</strong><br> 如果某个树结构中，两台交换机用RSTP协议，第三台使用STP协议，那么两台交换机与第三台连接的端口会向下兼容使用STP工作模式。</p> 
<h2><a id="6RSTP_142"></a>6、配置RSTP－基本配置</h2> 
<p><img src="https://images2.imgbox.com/eb/99/3odUhBKa_o.png" alt="配置RSTP" width="600" height="340"></p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span><span class="token class-name">Huawei</span><span class="token punctuation">]</span>sysn s1
<span class="token punctuation">[</span>S1<span class="token punctuation">]</span>stp mode rstp 
<span class="token punctuation">[</span>S1<span class="token punctuation">]</span>stp priority <span class="token number">4096</span>

<span class="token punctuation">[</span>S2<span class="token punctuation">]</span>stp mode rstp 
<span class="token punctuation">[</span>S2<span class="token punctuation">]</span>stp priority <span class="token number">8192</span>

<span class="token punctuation">[</span>SW3<span class="token punctuation">]</span>stp mode rstp
<span class="token punctuation">[</span>SW4<span class="token punctuation">]</span>stp mode rstp
</code></pre> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>s1<span class="token punctuation">]</span>dis stp bri
 MSTID  <span class="token class-name">Port</span>                        <span class="token class-name">Role</span>  STP <span class="token class-name">State</span>     <span class="token class-name">Protection</span>
   <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>        ROOT  FORWARDING      NONE
   <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">2</span>        DESI  FORWARDING      NONE
</code></pre> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>s1<span class="token punctuation">&gt;</span></span>dis stp <span class="token keyword">int</span> g0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>
<span class="token generics"><span class="token punctuation">&lt;</span>s1<span class="token punctuation">&gt;</span></span>dis stp <span class="token keyword">int</span> g0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span>CIST <span class="token class-name">Global</span> <span class="token class-name">Info</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">Mode</span> RSTP<span class="token punctuation">]</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
CIST <span class="token class-name">Bridge</span>         <span class="token operator">:</span><span class="token number">4096</span> <span class="token number">.4</span>c1f<span class="token operator">-</span>cc6a<span class="token operator">-</span><span class="token number">7d</span><span class="token number">23</span>   CIST <span class="token class-name">Bridge</span>是交换机自己的ID
<span class="token class-name">Config</span> <span class="token class-name">Times</span>        <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">MaxHop</span> <span class="token number">20</span>
<span class="token class-name">Active</span> <span class="token class-name">Times</span>        <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">MaxHop</span> <span class="token number">20</span>
CIST <span class="token class-name">Root</span><span class="token operator">/</span>ERPC      <span class="token operator">:</span><span class="token number">4096</span> <span class="token number">.4</span>c1f<span class="token operator">-</span>cc6a<span class="token operator">-</span><span class="token number">7d</span><span class="token number">23</span> <span class="token operator">/</span> <span class="token number">0</span>     CIST <span class="token class-name">Root</span>是根交换机的ID
CIST <span class="token class-name">RegRoot</span><span class="token operator">/</span>IRPC   <span class="token operator">:</span><span class="token number">4096</span> <span class="token number">.4</span>c1f<span class="token operator">-</span>cc6a<span class="token operator">-</span><span class="token number">7d</span><span class="token number">23</span> <span class="token operator">/</span> <span class="token number">0</span>
CIST <span class="token class-name">RootPortId</span>     <span class="token operator">:</span><span class="token number">0.0</span>
BPDU<span class="token operator">-</span><span class="token class-name">Protection</span>     <span class="token operator">:</span><span class="token class-name">Disabled</span>
TC or TCN received  <span class="token operator">:</span><span class="token number">35</span>
TC count per hello  <span class="token operator">:</span><span class="token number">0</span>
STP <span class="token class-name">Converge</span> <span class="token class-name">Mode</span>   <span class="token operator">:</span><span class="token class-name">Normal</span> 
<span class="token class-name">Time</span> since last TC  <span class="token operator">:</span><span class="token number">0</span> days <span class="token number">0</span>h<span class="token operator">:</span><span class="token number">0</span>m<span class="token operator">:</span><span class="token number">42</span>s
<span class="token class-name">Number</span> of TC        <span class="token operator">:</span><span class="token number">35</span>
<span class="token class-name">Last</span> TC occurred    <span class="token operator">:</span><span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">[</span><span class="token class-name">Port1</span><span class="token punctuation">(</span><span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>FORWARDING<span class="token punctuation">]</span><span class="token operator">--</span><span class="token operator">--</span>
 <span class="token class-name">Port</span> <span class="token class-name">Protocol</span>       <span class="token operator">:</span><span class="token class-name">Enabled</span>
 <span class="token class-name">Port</span> <span class="token class-name">Role</span>           <span class="token operator">:</span><span class="token class-name">Designated</span> <span class="token class-name">Port</span>
 <span class="token class-name">Port</span> <span class="token class-name">Priority</span>       <span class="token operator">:</span><span class="token number">128</span>
 <span class="token class-name">Port</span> <span class="token class-name">Cost</span><span class="token punctuation">(</span><span class="token class-name">Dot1T</span> <span class="token punctuation">)</span>   <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span>auto <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span><span class="token number">20000</span>
 <span class="token class-name">Designated</span> <span class="token class-name">Bridge</span><span class="token operator">/</span><span class="token class-name">Port</span>   <span class="token operator">:</span><span class="token number">4096.4</span>c1f<span class="token operator">-</span>cc6a<span class="token operator">-</span><span class="token number">7d</span><span class="token number">23</span> <span class="token operator">/</span> <span class="token number">128.1</span>
 <span class="token class-name">Port</span> <span class="token class-name">Edged</span>          <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span><span class="token keyword">default</span> <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span>disabled
 <span class="token class-name">Point</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span>point      <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span>auto <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span><span class="token boolean">true</span>
 <span class="token class-name">Transit</span> <span class="token class-name">Limit</span>       <span class="token operator">:</span><span class="token number">147</span> packets<span class="token operator">/</span>hello<span class="token operator">-</span>time
 <span class="token class-name">Protection</span> <span class="token class-name">Type</span>     <span class="token operator">:</span><span class="token class-name">None</span>
 <span class="token class-name">Port</span> STP <span class="token class-name">Mode</span>       <span class="token operator">:</span>RSTP 
 <span class="token class-name">Port</span> <span class="token class-name">Protocol</span> <span class="token class-name">Type</span>  <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span>auto <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span>dot1s
 BPDU <span class="token class-name">Encapsulation</span>  <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span>stp <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span>stp
 <span class="token class-name">PortTimes</span>           <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">RemHop</span> <span class="token number">20</span>
 TC or TCN send      <span class="token operator">:</span><span class="token number">1</span>
 TC or TCN received  <span class="token operator">:</span><span class="token number">0</span>
 BPDU <span class="token class-name">Sent</span>           <span class="token operator">:</span><span class="token number">54</span>             
          TCN<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> RST<span class="token operator">:</span> <span class="token number">54</span><span class="token punctuation">,</span> MST<span class="token operator">:</span> <span class="token number">0</span>
 BPDU <span class="token class-name">Received</span>       <span class="token operator">:</span><span class="token number">1</span>             
          TCN<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> RST<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> MST<span class="token operator">:</span> <span class="token number">0</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>s1<span class="token punctuation">]</span>dis stp
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span>CIST <span class="token class-name">Global</span> <span class="token class-name">Info</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">Mode</span> RSTP<span class="token punctuation">]</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
CIST <span class="token class-name">Bridge</span>         <span class="token operator">:</span><span class="token number">4096</span> <span class="token number">.4</span>c1f<span class="token operator">-</span>cc6a<span class="token operator">-</span><span class="token number">7d</span><span class="token number">23</span>          交换机自己的ID
<span class="token class-name">Config</span> <span class="token class-name">Times</span>        <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">MaxHop</span> <span class="token number">20</span>
<span class="token class-name">Active</span> <span class="token class-name">Times</span>        <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">MaxHop</span> <span class="token number">20</span>
CIST <span class="token class-name">Root</span><span class="token operator">/</span>ERPC      <span class="token operator">:</span><span class="token number">4096</span> <span class="token number">.4</span>c1f<span class="token operator">-</span>cc6a<span class="token operator">-</span><span class="token number">7d</span><span class="token number">23</span> <span class="token operator">/</span> <span class="token number">0</span>      根交换机的ID   <span class="token number">0</span>代表自己
CIST <span class="token class-name">RegRoot</span><span class="token operator">/</span>IRPC   <span class="token operator">:</span><span class="token number">4096</span> <span class="token number">.4</span>c1f<span class="token operator">-</span>cc6a<span class="token operator">-</span><span class="token number">7d</span><span class="token number">23</span> <span class="token operator">/</span> <span class="token number">0</span>      <span class="token number">0</span>自已的MAC和优先级
CIST <span class="token class-name">RootPortId</span>     <span class="token operator">:</span><span class="token number">0.0</span>                         根的<span class="token class-name">PortId</span>
BPDU<span class="token operator">-</span><span class="token class-name">Protection</span>     <span class="token operator">:</span><span class="token class-name">Disabled</span>
TC or TCN received  <span class="token operator">:</span><span class="token number">26</span>
TC count per hello  <span class="token operator">:</span><span class="token number">0</span>
STP <span class="token class-name">Converge</span> <span class="token class-name">Mode</span>   <span class="token operator">:</span><span class="token class-name">Normal</span> 
<span class="token class-name">Time</span> since last TC  <span class="token operator">:</span><span class="token number">0</span> days <span class="token number">0</span>h<span class="token operator">:</span><span class="token number">0</span>m<span class="token operator">:</span><span class="token number">49</span>s
<span class="token class-name">Number</span> of TC        <span class="token operator">:</span><span class="token number">22</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>s3<span class="token punctuation">&gt;</span></span>dis stp bri
 MSTID  <span class="token class-name">Port</span>                        <span class="token class-name">Role</span>  STP <span class="token class-name">State</span>     <span class="token class-name">Protection</span>
   <span class="token number">0</span>    <span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>               DESI  FORWARDING      NONE
   <span class="token number">0</span>    <span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">2</span>               ROOT  FORWARDING      NONE
   <span class="token number">0</span>    <span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3</span>               DESI  FORWARDING      NONE
   <span class="token number">0</span>    <span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">4</span>               BACK  DISCARDING      NONE
</code></pre> 
<p>s3上出现3种端口，E0/0/1、E0/0/3为Designated Port指定端口，处于转发状态FORWARDING；E0/0/2为Root Port 根端口，处于处于转发状态；E0/0/4为<code>Backup备份端口</code>，不处于转发状态，所属交换机为端口所连网段的指定交换机。</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>s4<span class="token punctuation">&gt;</span></span>dis stp bri
 MSTID  <span class="token class-name">Port</span>                        <span class="token class-name">Role</span>  STP <span class="token class-name">State</span>     <span class="token class-name">Protection</span>
   <span class="token number">0</span>    <span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>               DESI  FORWARDING      NONE
   <span class="token number">0</span>    <span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">2</span>               ROOT  FORWARDING      NONE
   <span class="token number">0</span>    <span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3</span>               ALTE  DISCARDING      NON
</code></pre> 
<p>s4上Ethernet0/0/3为<code>Alternate预备端口</code>，不处于转发状态，所属交换机不是端口所连网段的指定交换机。</p> 
<p>配置边缘端口<br> 生成树的计算主要发生在交换机互连的链路之.上，而连接PC的端口没有必要参与 生成树计算，为了优化网络，降低生成树计算对终端设备的影响，现在网络管理员把交换机上连接PC的接口配置为边缘端口。</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>SW4<span class="token punctuation">]</span><span class="token keyword">interface</span> <span class="token class-name">Ethernet</span> <span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">[</span>SW4<span class="token operator">-</span><span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span>stp edged<span class="token operator">-</span>port enable
</code></pre> 
<h2><a id="7RSTP_245"></a>7、RSTP如何实现快速收敛</h2> 
<h3><a id="71STP_246"></a>7.1、STP的收敛机制</h3> 
<p>在802.1D中，只有当SW从根端口收到BPDU时，非根桥才能转发BPDU。只有根桥才会发送BPDU，其它非根桥只是转发，每隔2S就发送一次，如果20秒收不到就进入Learning状态。如果线路发生改变，根端口就发送消息给根桥，通知拓扑表出问题，根桥加快转发/过滤表的老化速度从300秒变到15秒，根桥再发送消息给其它非根桥。</p> 
<p>STP的初次收敛，STP的收敛时间(30s-50s)：<br> <img src="https://images2.imgbox.com/62/55/3DlgMqNu_o.png" alt="STP的初次收敛"></p> 
<ul><li>初始阶段Disable未启用状态，启动交换机，三台交换机的端口都<strong>阻塞状态</strong>，防止环路，然后转入<strong>侦听状态</strong>，等待根桥发送BPDU，然后入经过20s最大存活时间后，没有收到根桥发送BPDU；</li><li>三台交换机都认为自己是根桥，将端口转变成为指定端口，发送以自己为根桥的BPDU，于是S1发送给S2，比根桥ID中的优先级、再比根桥ID中的MAC地址。S2发送给S3作比较，S3发送给S1作比较。这时选出了根桥。这时交换机端口处于<strong>Learning学习状态</strong>；</li><li>根桥选出后，进行选举根端口、和选举指定端口，这时交换机端口处于处于<strong>Forwarding转发状态</strong>。<br> Blocking–&gt;20s Listening–&gt;15s Learnin–&gt;15s Forwarding<br> <img src="https://images2.imgbox.com/db/54/DCPnn2E2_o.png" alt="STP的收敛机制"></li></ul> 
<p><strong>拓扑变更机制</strong><br> 在802.1D中，只有当SW从根端口收到BPDU时，非根桥才能转发BPDU。如果线路发生改变，根端口就发送消息给根桥，通知拓扑表出问题，根桥加快转发/过滤表的老化速度从300秒变到15秒，根桥再发送消息给其它非根桥。</p> 
<p>在STP中，已经选举出根桥的交换机出现链路故障从初始状态到收敛状态至少需要30s。</p> 
<h3><a id="72RSTP_264"></a>7.2、RSTP的收敛机制</h3> 
<p>在802.1w中，每个SW(交换机)都会每隔2S就发送一次包含当前信息的BPDU。</p> 
<p>RSTP端口状态：3种：</p> 
<ul><li> <p>Discarding丢弃状态，Learning学习状态，Forwarding转发状态。<br> RSTP实现快速收敛关键在于引入了Proposal/Agreement机制、根端口快速切换机制、边缘端口。<br> <img src="https://images2.imgbox.com/f8/5a/sBv32tVs_o.png" alt="STP的初次收敛"></p> </li><li> <p>初始阶段Discarding丢弃状态，启动交换机，1、3两个端口马上都先成为指定端口，发送RST BPDU。</p> </li><li> <p>S2收到RST BPDU进行比较将3端口变成为根端口，停止发送RST BPDU。</p> </li><li> <p>S1的1端口进入Discarding丢弃状态，发送RST BPDU中把Proposal和Agreement置1，提议1端口进入转发状态。</p> </li><li> <p>S2的3端口收到根桥发送来的携带Proposal的RST BPDU，S2开始将自己的所有端口进入sync变量置位，（即同步变量：临时阻塞除边缘端口外的其他端口）。</p> </li><li> <p>4端口进入Discarding状态，3端口进入Forwarding状态并向S1返回Agreement位置位的回应RST BPDU。3端口由原来的指定端口转化为根端口。</p> </li><li> <p>S1收到回应RST BPDU，1端口马上进入Forwarding状态。</p> </li></ul> 
<p>RSTP不用像STP一样为避免环路，需要等待至少一个Forward Delay所有端口才能进行转发。</p> 
<p><strong>拓扑变更机制的优化</strong></p> 
<p>在802.1w中，不存在TCN BPDU，因为RSTP域内状态的同步无需由Root Bridge发起。Topology Change（TC）的通告发生在毗邻Bridge之间，每个SW(交换机)都会每隔2S就发送一次包含当前信息的BPDU。</p> 
<p>当某个端口由阻塞状态变成转发状态，该端口就会启动PA机制检查机制，发出提议对此接口进入Forwarding状态，等待对端进行同步。</p> 
<h2><a id="8RSTPSTP_289"></a>8、RSTP对STP保护机制</h2> 
<p><strong>1.根端口保护</strong>：如果黑客用一台优先级比较高的交换机连接到树里或者错误配置，网络中合法根桥有可能会收到优先级更高的RST BPDU，使得合法根桥失去根地位，从而引起网络拓扑结构的错误变动。这种不合法的拓扑变化，会导致原来应该通过高速链路的流量被牵引到低速链路上，造成网络拥塞。为了防止交换机的端口角色发生改变，可以在交换机里配置根保护，配置了根保护的交换机的某个端口如果收到比现有根桥更忧的BPDU会主动把端口状态置为 discading 直到黑客的交换机撤离。<br> <img src="https://images2.imgbox.com/07/38/ZNRW9ELm_o.png" alt="在这里插入图片描述" width="600" height="400"></p> 
<p>实现原理： 一旦启用Root保护功能的指定端口收到优先级更高的RST BPDU时，端口状态将进入Discarding状态，不再转发报文。在经过一段时间，如果端口一直没有再收到优先级较高的RST BPDU，端口会自动恢复到正常的Forwarding状态。（Root保护功能只能在指定端口上配置生效。）</p> 
<p>配置：<br> Root保护功能一般只在<strong>根桥的端口</strong>上配置。配置了Root保护的端口，不可以配置环路保护。</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>s1<span class="token punctuation">]</span><span class="token keyword">int</span> g0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">[</span>s1<span class="token operator">-</span><span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span>stp root<span class="token operator">-</span>protection
</code></pre> 
<p><strong>2.边缘端口保护</strong>：如果对交换机的某个端口设置了边缘端口，而这个边缘端口却收到了BPDU会导致边缘端口的功能失效，甚至从边缘端口发来一些TC报文来刷新网络交换机的MAC地址攻击网络，为了防止这一情况，可以对边缘端口做保护配置，相当于绑定边缘端口。保护后收到BPDU的边缘端口就会直接置为 err-down （直接关闭，需要管路员手动恢复） 。因此不能再非边缘端口配置此保护。<br> <img src="https://images2.imgbox.com/32/1d/jhbkpwJt_o.png" alt="边缘端口保护"></p> 
<p>当攻击者发送的RST BPDU报文中的桥优先级高于现有网络中根桥优先级时会改变当前网络拓扑，可能会导致业务流量中断。这是网络中一种简单的拒绝服务DoS（Denial of Service）攻击方式。</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>SW2<span class="token punctuation">]</span><span class="token keyword">interface</span> <span class="token class-name">Ethernet</span> <span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>                         
<span class="token punctuation">[</span>SW2<span class="token operator">-</span><span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span>stp edged<span class="token operator">-</span>port enable            <span class="token comment">//接口下配置边缘端口</span>
<span class="token punctuation">[</span>SW2<span class="token operator">-</span><span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span>q
<span class="token punctuation">[</span>SW2<span class="token punctuation">]</span>stp bpdu<span class="token operator">-</span>protection            <span class="token comment">//全局下配置交换设备边缘端口的BPDU保护功能。</span>
</code></pre> 
<p>一旦接口进入保护状态后，需要执行undo shutdown命令手动恢复，也可以在接口视图下执行restart命令重启接口。<br> 配置使能端口自动恢复功能，并设置延迟时间。</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>SW4<span class="token punctuation">]</span>error<span class="token operator">-</span>down auto<span class="token operator">-</span>recovery cause bpdu<span class="token operator">-</span>protection interval <span class="token number">10</span>
</code></pre> 
<p><strong>3.环路保护</strong>：如果阻塞端口可以发BPDU 却一直收不到别人的BPDU，这样会导致BPDU超时，从而使得阻塞状态转变成转发状态，从而造成树结构有转变成环形结构。因此可以在AP端口配置环路保护，配置环路保护后AP端口如果持续收不到 BPDU 就会认为链路故障单方向故障，从而使端口状态保持 discarding。</p> 
<p><img src="https://images2.imgbox.com/a9/79/NAkwphXB_o.png" alt="环路保护"></p> 
<p>如果S1–&gt;S2之间由于链路拥塞或者单向链路故障，导致S2的3端口收不到上游交换设备的RST BPDU时，会重新选择根端口。原先的4端口会转变为指定端口，由原先的阻塞端口会迁移到转发状态，从而造成交换网络中可能产生环路。</p> 
<p>在启动了环路保护功能后，如果根端口或Alternate端口长时间收不到来自上游设备的BPDU报文，则向网管发出通知信息（此时根端口会进入Discarding状态，角色切换为指定端口），而Alternate端口则会一直保持在阻塞状态（角色也会切换为指定端口），不转发报文，从而不会在网络中形成环路。直到链路不再拥塞或单向链路故障恢复，端口重新收到BPDU报文进行协商，并恢复到链路拥塞或者单向链路故障前的角色和状态。</p> 
<p>配置：</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>SW2<span class="token punctuation">]</span><span class="token keyword">interface</span> <span class="token class-name">Ethernet</span> <span class="token number">0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>                         
<span class="token punctuation">[</span>SW2<span class="token operator">-</span><span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span>stp loop<span class="token operator">-</span>protection            <span class="token comment">//配置交换设备根端口或Alternate端口的环路保护功能</span>
</code></pre> 
<p>注意：配置了根保护的端口，不可以配置环路保护。</p> 
<p><strong>4.TC BPDU泛洪保护</strong><br> 交换机在接收到TC-BPDU报文后，会执行MAC地址表项的删除操作。如果有人伪造TC-BPDU报文恶意攻击交换机时，交换机短时间内会收到很多TC-BPDU报文，频繁的删除操作会给设备造成很大的负担，给网络的稳定带来很大隐患。</p> 
<p>启用防TC-BPDU报文攻击功能后，在单位时间内，RSTP进程处理TC类型BPDU报文的次数可配置（缺省的单位时间是2秒，缺省的处理次数是3次）。如果在单位时间内，RSTP进程在收到TC类型BPDU报文数量大于配置的阈值，那么RSTP进程只会处理阈值指定的次数；对于其他超出阈值的TC类型BPDU报文，定时器到期后，RSTP进程只对其统一处理一次。这样可以避免频繁的删除MAC地址表项，从而达到保护交换机的目的。</p> 
<p>配置：</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>SW2<span class="token punctuation">]</span>stp tc<span class="token operator">-</span>protection interval <span class="token number">10</span>   <span class="token comment">//设备处理阈值指定数量的拓扑变化报文所需的时间。</span>
<span class="token punctuation">[</span>SW2<span class="token punctuation">]</span>stp tc<span class="token operator">-</span>protection threshold <span class="token number">5</span>   <span class="token comment">//处理拓扑变化报文的最大数量是5。</span>
</code></pre> 
<p>在10秒内只会处理最开始收到的5个拓扑变化报文，对于后面收到的报文则会等10秒超时后再统一处理。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d2f5ee3788fd4596bec0d09211537d52/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue3将参数发送到路由而不将它们添加到url</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/92a8f870cc8dd7b894c76889b90ee428/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C专家编程 —— 运行时数据结构</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>