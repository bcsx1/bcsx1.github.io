<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>react18 学习（一） - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="react18 学习（一）" />
<meta property="og:description" content="前言1：适用会用Vue或React的人，手撸源码。
前言2：作者也是一步步学习，把自己学习的过程记录下来复习用，可能有没弄明白的地方在文档上写的不清楚，另外我每个写的文档都会自己重新看几遍去做些优化，所以如果有问题和建议欢迎大家在评论区留言，一起进步。
react18 学习（一） 开始创建入口文件实现jsx怎么编译jsx创建虚拟DOM 根节点和根fiber创建根节点fiber为什么需要有fiber？什么是fiber？ 创建根fiber创建队列 捋一下过程 开始 npm init -y 初始化一个项目
npm i vite @vitejs/plugin-react --save 下载 vite 和 编译 加载react语法的插件
新建 vite.config.js 文件，初始化配置，引用react插件。
// 当以命令方式运行 vite 时，vite 会自动解析项目根目录下 vite.config.js 的文件。 import { defineConfig } from &#34;vite&#34;; import react from &#34;@vitejs/plugin-react&#34;; export default defineConfig({ plugins: [react()], // 配置需要使用的插件列表 }); 创建入口文件 index.html
&lt;div id=&#34;root&#34;&gt;&lt;/div&gt; &lt;script type=&#34;module&#34; src=&#34;./src/main.jsx&#34;&gt;&lt;/script&gt; src/main.jsx
console.log(&#34;main&#34;); pakeage.json
{ &#34;scripts&#34;: { &#34;dev&#34;: &#34;vite&#34; } } npm run dev 运行" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/02cc86db1b46475c6bdf2e01ed9a08bf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-07T00:19:26+08:00" />
<meta property="article:modified_time" content="2023-04-07T00:19:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">react18 学习（一）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>前言1：适用会用Vue或React的人，手撸源码。</p> 
</blockquote> 
<blockquote> 
 <p>前言2：作者也是一步步学习，把自己学习的过程记录下来复习用，可能有没弄明白的地方在文档上写的不清楚，另外我每个写的文档都会自己重新看几遍去做些优化，所以如果有问题和建议欢迎大家在评论区留言，一起进步。</p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>react18 学习（一）</h4> 
 <ul><li><ul><li><a href="#_5" rel="nofollow">开始</a></li><li><a href="#_22" rel="nofollow">创建入口文件</a></li><li><a href="#jsx_52" rel="nofollow">实现jsx</a></li><li><ul><li><a href="#jsx_53" rel="nofollow">怎么编译jsx</a></li><li><a href="#DOM_102" rel="nofollow">创建虚拟DOM</a></li></ul> 
   </li><li><a href="#fiber_223" rel="nofollow">根节点和根fiber</a></li><li><ul><li><a href="#_231" rel="nofollow">创建根节点</a></li><li><a href="#fiber_295" rel="nofollow">fiber</a></li><li><ul><li><a href="#fiber_297" rel="nofollow">为什么需要有fiber？</a></li><li><a href="#fiber_305" rel="nofollow">什么是fiber？</a></li></ul> 
    </li><li><a href="#fiber_323" rel="nofollow">创建根fiber</a></li><li><a href="#_429" rel="nofollow">创建队列</a></li></ul> 
   </li><li><a href="#_454" rel="nofollow">捋一下过程</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_5"></a>开始</h3> 
<p><code>npm init -y</code> 初始化一个项目</p> 
<p><code>npm i vite @vitejs/plugin-react --save</code> 下载 vite 和 编译 加载react语法的插件</p> 
<p>新建 <code>vite.config.js</code> 文件，初始化配置，引用react插件。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 当以命令方式运行 vite 时，vite 会自动解析项目根目录下 vite.config.js 的文件。</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vite"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> react <span class="token keyword">from</span> <span class="token string">"@vitejs/plugin-react"</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 配置需要使用的插件列表</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_22"></a>创建入口文件</h3> 
<p>index.html</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./src/main.jsx<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>src/main.jsx</p> 
<pre><code class="prism language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>pakeage.json</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"dev"</span><span class="token operator">:</span> <span class="token string">"vite"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>npm run dev</code> 运行</p> 
<p><img src="https://images2.imgbox.com/2f/3d/bmZZhwBk_o.png" alt="在这里插入图片描述"></p> 
<p>这样初始化项目就完成了。</p> 
<h3><a id="jsx_52"></a>实现jsx</h3> 
<h4><a id="jsx_53"></a>怎么编译jsx</h4> 
<p>先在main.jsx里用jsx语法定义一个虚拟dom <code>element</code></p> 
<pre><code class="prism language-javascript"><span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>hello<span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>world<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们打印一下 element，现在如果在 main.jsx 里面用 jsx 语法创建 element, 就会报错</p> 
<p><img src="https://images2.imgbox.com/bb/57/TcKuE9hB_o.png" alt="在这里插入图片描述"></p> 
<p>这是因为通过 vite 编译之后引用了 react 创建 <code>虚拟dom</code> 的语法，但是现在还没有 react 文件夹。所以接下来要一步步实现 react 框架。</p> 
<p>先来了解一下在react17以前babel编译用的是下面这个 <code>classic</code> 方法。</p> 
<blockquote> 
 <p>大家可以在 <a href="https://www.babeljs.cn/repl" rel="nofollow">这里</a> 输入一些jsx语法去试一下</p> 
</blockquote> 
<pre><code class="prism language-javascript">React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"h1"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"span"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'red'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>react18编译是这样的。<code>automatic</code>，注意这部分代码，下一步可以视为是把这一串代码运行。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">var</span> _jsxRuntime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"react/jsx-runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _jsxRuntime<span class="token punctuation">.</span>jsxs<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"h1"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _jsxRuntime<span class="token punctuation">.</span>jsx<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">"span"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'red'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token string">"world"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><code>automatic</code>结构相比<code>classic</code>来说更清晰，子节点都在<code>children</code>属性里</li><li>不用手动引入全局变量React</li></ul> 
<p>写的jsx ==&gt; babel编译 ==&gt; 浏览器运行(虚拟dom)<br> <img src="https://images2.imgbox.com/28/96/oRTaGEkH_o.png" alt="在这里插入图片描述"></p> 
<p>接下来试着实现一下react的jsx转换DOM。(预计3章左右)</p> 
<h4><a id="DOM_102"></a>创建虚拟DOM</h4> 
<p>在<code>src</code>下创建文件夹<code>react</code> (就是模拟正常开发引入的 react 库)，并新建一个<code>jsx-dev-runtime.js</code>，再根据引入语句新建对应引入的文件。(下同，尽量把代码阅读顺序用数字标上去)</p> 
<blockquote> 
 <p>每个引入的文件需要自己单独创建，这里不截图文件目录结构。因为是1比1还原目录结构，所以结构会很复杂。</p> 
</blockquote> 
<p>jsx-dev-runtime.js</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 转换jsx的方法</span>
<span class="token keyword">export</span> <span class="token punctuation">{<!-- --></span> jsxDEV <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./src/jsx/ReactJSXElement'</span>
</code></pre> 
<p>ReactJSXElement.js</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 把 Object.hasOwnProperty 分离出去减轻代码体积</span>
<span class="token keyword">import</span> hasOwnProperty <span class="token keyword">from</span> <span class="token string">"shared/hasOwnProperty"</span><span class="token punctuation">;</span>
<span class="token comment">// dom类型</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> <span class="token constant">REACT_ELEMENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"shared/ReactSymbols"</span><span class="token punctuation">;</span>

<span class="token comment">// 3. 保留的属性 (不会放到props上)</span>
<span class="token keyword">const</span> <span class="token constant">RESERVED_PROPS</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">__self</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">__source</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 2.</span>
<span class="token keyword">function</span> <span class="token function">hasValidKey</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> config<span class="token punctuation">.</span>key <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">hasValidRef</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> config<span class="token punctuation">.</span>ref <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4. </span>
<span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 这就是React元素, 也就是虚拟DOM</span>
    $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">,</span>
    type<span class="token punctuation">,</span> <span class="token comment">// h1 / span</span>
    key<span class="token punctuation">,</span> <span class="token comment">// 唯一标识</span>
    ref<span class="token punctuation">,</span> <span class="token comment">// 用来获取真实DOM元素的</span>
    props<span class="token punctuation">,</span> <span class="token comment">// 属性 children / style .....</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 1.
 * @param {*} type 标签名 h1/span
 * @param {*} config 标签属性 style/children
 * @returns 虚拟dom
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">jsxDEV</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// let propName; // 属性名</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 属性对象</span>
  <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 每个虚拟dom都有一个可选的key, 用于区分父节点下不同的子节点</span>
  <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 引入, 后面可以通过这个实现获取DOM</span>
  <span class="token comment">// 2. 判定是否是合法的key和ref</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasValidKey</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    key <span class="token operator">=</span> config<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasValidRef</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    ref <span class="token operator">=</span> config<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> propName <span class="token keyword">in</span> config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 3. 是传过来的属性并且不在保留属性里, 就赋值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> propName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token constant">RESERVED_PROPS</span><span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 4. </span>
  <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>注：上面这个文件就是把上一步编译后的代码运行转换成虚拟dom。</p> 
</blockquote> 
<p>hasOwnProperty.js</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 分离出这个方法</span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> hasOwnProperty <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> hasOwnProperty<span class="token punctuation">;</span>
</code></pre> 
<p>ReactSymbols.js</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 表示此虚拟DOM类型是React元素</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">REACT_ELEMENT_TYPE</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"react.element"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在 <code>vite.config.js</code> 配置里再加一个属性，并配置引入路径</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span>
<span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token literal-property property">react</span><span class="token operator">:</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/react"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string-property property">"react-dom"</span><span class="token operator">:</span>path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/react-dom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string-property property">"react-reconciler"</span><span class="token operator">:</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/react-reconciler"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">scheduler</span><span class="token operator">:</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/scheduler"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">shared</span><span class="token operator">:</span> path<span class="token punctuation">.</span>posix<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/shared"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<p>和对应的 jsconfig.json，这个是 vscode 可以点击进对应的文件夹</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"baseUrl"</span><span class="token operator">:</span> <span class="token string">"./"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"paths"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"react/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src/react/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"react-dom/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src/react-dom/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"react-reconciler/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src/react-reconciler/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"scheduler/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"scheduler/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"shared/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src/shared/*"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"exclude"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules"</span><span class="token punctuation">,</span> <span class="token string">"dist"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来看效果，对应的虚拟DOM已经出来了。<br> <img src="https://images2.imgbox.com/17/e3/36NfJH1R_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="fiber_223"></a>根节点和根fiber</h3> 
<ul><li>需要给react提供一个根节点，之后每个节点都是渲染在根节点内部的。</li></ul> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>根fiber可以通俗理解为一个装着所有虚拟dom的容器，每个虚拟dom又单独对应一个fiber，</li><li>渲染可以以单个fiber为单位暂停 / 恢复。</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            需要创建两个根 
           
          
            f 
           
          
            i 
           
          
            b 
           
          
            e 
           
          
            r 
           
          
            去相互替换展示。 
           
          
         
        
       
         \color{#F00}{需要创建两个根fiber去相互替换展示。} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord" style="color: rgb(255, 0, 0);"><span class="mord cjk_fallback" style="color: rgb(255, 0, 0);">需要创建两个根</span><span class="mord mathnormal" style="margin-right: 0.1076em; color: rgb(255, 0, 0);">f</span><span class="mord mathnormal" style="color: rgb(255, 0, 0);">ib</span><span class="mord mathnormal" style="margin-right: 0.0278em; color: rgb(255, 0, 0);">er</span><span class="mord cjk_fallback" style="color: rgb(255, 0, 0);">去相互替换展示。</span></span></span></span></span></span></li></ul> 
<h4><a id="_231"></a>创建根节点</h4> 
<p>更改<code>main.jsx</code></p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> createRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-dom/client"</span>

<span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>hello<span class="token operator">&lt;</span>span style<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>world<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createRoot</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>首先要建一个<code>FiberRootNode</code>根节点，也就是所有DOM的根，本质就是 div#root。</p> 
<p>根节点 和 根fiber 的关系：<br> <img src="https://images2.imgbox.com/38/8f/lojYqFiZ_o.png" alt="在这里插入图片描述"><br> client.js</p> 
<pre><code class="prism language-javascript"><span class="token keyword">export</span> <span class="token punctuation">{<!-- --></span> createRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./src/client/ReactDOMRoot"</span><span class="token punctuation">;</span>
</code></pre> 
<p>ReactDOMRoot.js</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> createContainer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-reconciler/src/ReactFiberReconciler"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">ReactDOMRoot</span><span class="token punctuation">(</span><span class="token parameter">internalRoot</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> internalRoot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建一个根 实际就是一个被包装过的真实DOM节点</span>
<span class="token comment">// container: div#root</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 创建容器   6. 接收到有#root的容器</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 7. 容器传给 ReactDOMRoot</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ReactFiberReconciler.js</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> createFiberRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./ReactFiberRoot"</span><span class="token punctuation">;</span>
<span class="token comment">// 创建容器 containerInfo: 容器信息</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token parameter">containerInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 2</span>
  <span class="token keyword">return</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ReactFiberRoot.js</p> 
<pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">FiberRootNode</span><span class="token punctuation">(</span><span class="token parameter">containerInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 4. 把DOM节点放到容器</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>containerInfo <span class="token operator">=</span> containerInfo
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token parameter">containerInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 3. 创建根容器</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 这个位置在下一步要创建 FiberRoot</span>
  <span class="token comment">// 5. 把容器返回出去</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>分这么多文件的主要是因为很多其他逻辑要处理，暂时都给省略了。虽然比较绕，但其实本质就是把div#root做了几层包装。</p> 
<p>现在根节点FiberRootNode创建好了，最后<code>root</code>的打印结果：</p> 
<p><img src="https://images2.imgbox.com/64/75/1EuECuw3_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="fiber_295"></a>fiber</h4> 
<p>在创建根fiber之前先了解一下fiber</p> 
<h5><a id="fiber_297"></a>为什么需要有fiber？</h5> 
<ul><li>react以前没有fiber整个计算过程不能暂停，会导致时间过长</li><li>浏览器刷新频率为 60Hz,大概 16.6 毫秒渲染一次，而 JS 线程和渲染线程是互斥的，所以如果 JS 线程执行任务时间超过 16.6ms 的话，就会导致掉帧、卡顿，解决方案就是 React 利用空闲的时间进行更新，不影响渲染进行的渲染</li><li>把一个耗时任务切分成一个个小任务，分布在每一帧里。这个的方式就叫时间切片</li></ul> 
<blockquote> 
 <p>我们需要把渲染变成一个可中断，可暂停，可恢复的过程。<br> 注：可以去搜一下 <code>requestIdleCallback API</code> ，react封装了一个类似的方法让每帧时间固定 <code>5ms</code>。</p> 
</blockquote> 
<h5><a id="fiber_305"></a>什么是fiber？</h5> 
<ul><li>Fiber 是一个执行单元</li></ul> 
<blockquote> 
 <p>Fiber 是一个执行单元,每次执行完一个执行单元，React 就会检查现在还剩多少时间，如果没有时间就将控制权让出去。<br> react 中一帧的过程：<img src="https://images2.imgbox.com/b9/1f/msEmuNbD_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<ul><li>Fiber 是一种数据结构</li></ul> 
<blockquote> 
 <p>React 目前的做法是使用链表, 每个虚拟节点内部表示为一个Fiber<br> 从顶点开始遍历<br> 如果有第一个儿子，先遍历第一个儿子<br> 如果没有第一个儿子，标志着此节点遍历完成<br> 如果有弟弟遍历弟弟<br> 如果有没有下一个弟弟，返回父节点标识完成父节点遍历，如果有叔叔遍历叔叔<br> 没有父节点遍历结束</p> 
</blockquote> 
<blockquote> 
 <p>遍历结构：<img src="https://images2.imgbox.com/7f/3b/BRYgnA5w_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<blockquote> 
 <p>遍历过程：<br> <img src="https://images2.imgbox.com/5e/7d/nEiBxlca_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h4><a id="fiber_323"></a>创建根fiber</h4> 
<p>真实DOM需要一个根容器，fiber同样需要一个根fiber。</p> 
<blockquote> 
 <p>相当于每个虚拟DOM都会创建一个对应的Fiber，再创建真实DOM<br> 虚拟DOM =&gt; Fiber =&gt; 真实DOM</p> 
</blockquote> 
<p>在刚刚创建<code>FiberRootNode</code>的函数里去创建<code>HostRootFiber</code>并互相指向对方。</p> 
<p><img src="https://images2.imgbox.com/08/0a/TpEqwcor_o.png" alt="在这里插入图片描述"></p> 
<p>ReactFiberRoot.js</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> createHostRootFiber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./ReactFiber"</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">FiberRootNode</span><span class="token punctuation">(</span><span class="token parameter">containerInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>containerInfo <span class="token operator">=</span> containerInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token parameter">containerInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 之前创建的根节点容器</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 1. 创建根fiber. hostRoot就是根节点dev#root</span>
  <span class="token comment">// 未初始化的fiber</span>
  <span class="token keyword">const</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 当前渲染页面的fiber.</span>
  <span class="token comment">// 6. 根容器的current指向当前的根fiber</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>
  <span class="token comment">// 这个fiber指向的节点就是根dom容器</span>
  uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ReactFiber.js</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 3. 工作标签</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> HostRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./ReactWorkTags"</span><span class="token punctuation">;</span>
<span class="token comment">// 5. 副作用标识</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> NoFlags <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./ReactFiberFlags"</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 4. 
 * @param {*} tag fiber类型 (函数组件0, 类组件1, 原生组件5, 根元素3) "./ReactWorkTags"
 * @param {*} pendingProps 等待处理的属性
 * @param {*} key 唯一标识
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// fiber类型, 来自于虚拟DOM节点的type   (span h1 p)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 此fiber对应的真实DOM节点</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 指向父节点</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 指向第一个子节点</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 指向弟弟</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span> <span class="token comment">// 等待生效的属性</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 已经生效的属性</span>
  <span class="token comment">// 虚拟DOM会提供pendingProps给创建fiber的属性，等处理完复制给memoizedProps</span>

  <span class="token comment">// 每个fiber还会有自己的状态，每一种fiber状态存的类型都不一样</span>
  <span class="token comment">// 比如：类组件对应的fiber存的就是实例的状态，HostRoot存的就是要渲染的元素</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 每个fiber可能还有自己的更新队列</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 5. "./ReactFiberFlags"</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span> <span class="token comment">// 副作用标识，表示对此fiber节点进行何种操作</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>subtreeFlags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span> <span class="token comment">// 子节点对应的副作用标识</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 轮替 (缓存了另一个fiber节点实例) diff时用</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建Fiber</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiber</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 4. fiber节点</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FiberNode</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 2. 创建一个fiber节点，因为是根的Fiber所以后面俩是null</span>
  <span class="token keyword">return</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>HostRoot<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><code>alternate</code> 就是之前提到的两个根fiber替换显示</p> 
</blockquote> 
<p>ReactWorkTags.js</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 每种虚拟DOM都会对应自己的fiber的类型</span>
<span class="token comment">// 根Fiber的Tag</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostRoot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 根节点</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostComponent <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// 原生节点 span div p</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostText <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// 纯文本节点</span>
<span class="token comment">// ...</span>
</code></pre> 
<p>ReactFiberFlags.js <code>二进制表示不同操作类型, 方便计算</code></p> 
<pre><code class="prism language-javascript"><span class="token comment">// 没有任何操作</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> NoFlags <span class="token operator">=</span> <span class="token number">0b000000000000000000000000000000</span><span class="token punctuation">;</span>
<span class="token comment">// 插入</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Placement <span class="token operator">=</span> <span class="token number">0b000000000000000000000000000010</span><span class="token punctuation">;</span>
<span class="token comment">// 更新</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Update <span class="token operator">=</span> <span class="token number">0b000000000000000000000000000100</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre> 
<p>看最后root的打印结果：根fiber和节点容器互相指向<br> <img src="https://images2.imgbox.com/1d/8d/CkqxyE2Z_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/fc/63/LfJwFL1Z_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>current指的是当前根容器正在显示或者已经渲染好的fiber树</p> 
</blockquote> 
<p>react采用了双缓存区的技术，可以把将要显示的图片绘制在缓存区中，需要展示的时候直接拿来替换掉。 <code>alternate</code> 轮替。<br> <img src="https://images2.imgbox.com/85/54/WLd4eqlm_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_429"></a>创建队列</h4> 
<p>打开<code>ReactFiberRoot.js</code>文件，在return root之前加一行代码，给根fiber加上一个更新队列，之后更新渲染任务都是放到这个队列里面。</p> 
<p>ReactFiberRoot.js</p> 
<pre><code class="prism language-javascript"><span class="token operator">+</span> <span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> initialUpdateQueue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./ReactFiberClassUpdateQueue"</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token operator">+</span> <span class="token function">initialUpdateQueue</span><span class="token punctuation">(</span>uninitializedFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
</code></pre> 
<p>ReactFiberClassUpdateQueue.js</p> 
<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initialUpdateQueue</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 创建一个新的更新队列</span>
  <span class="token comment">// pending是循环链表</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 共享</span>
    <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">pending</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_454"></a>捋一下过程</h3> 
<ul><li>最开始通过安装的 vite 运行<code>npm run dev</code>会以<code>index.html</code>为入口，有个脚本module找到文件<code>main.jsx</code>，通过 vite 编译后的jsx会调用<code>jsxDEV</code>文件的方法，然后通过<code>react/runtime</code>生成虚拟DOM。</li><li>渲染过程是<code>虚拟DOM -&gt; Fiber -&gt; 真实DOM</code>，所以需要有<code>根节点</code>和其对应的<code>根fiber</code>，并且互相指向对方，因为渲染dom是要通过fiber进行的，所以要先创建他们俩。</li><li>创建好之后要根据<code>虚拟DOM</code>创建对应的<code>fiber节点</code>，放在<code>FiberRoot</code>里。</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6557ef1b5f2ca5b23df06a986b9d2b87/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">编译正点原子STM32MP157开发板uboot源码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4ecd7bdf9ba91d5f126c068db53be51d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">什么是开发环境、测试环境、UAT环境、仿真环境、生产环境？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>