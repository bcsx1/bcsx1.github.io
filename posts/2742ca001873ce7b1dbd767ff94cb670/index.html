<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>从0开始，精通Go语言Rest微服务架构和开发 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="从0开始，精通Go语言Rest微服务架构和开发" />
<meta property="og:description" content="说在前面 现在拿到offer超级难，甚至连面试电话，一个都搞不到。
尼恩的技术社区中（50&#43;），很多小伙伴凭借 “左手云原生&#43;右手大数据”的绝活，拿到了offer，并且是非常优质的offer，据说年终奖都足足18个月。
第二个案例就是：前段时间，一个2年小伙伴希望涨薪到18K， 尼恩把GO 语言的项目架构，给他写入了简历，导致他的简历金光闪闪，脱胎换骨，完全可以去拿头条、腾讯等30K的offer， 年薪可以直接多 20W。
第三个案例就是：一个6年小伙伴凭借Java&#43;go双语言云原生架构，年薪60W。
从Java高薪岗位和就业岗位来看，云原生、K8S、GO 现在对于 高级工程师/架构师来说，越来越重要。
所以，尼恩从架构师视角出发，基于尼恩 3高架构知识宇宙，写一本《GO学习圣经》
《GO学习圣经》已经完成的内容有：
Go学习圣经：0基础精通GO开发与高并发架构 Go学习圣经：队列削峰&#43;批量写入 超高并发原理和实操 《GO学习圣经》PDF的最终目标
咱们的目标，不仅仅在于 GO 应用编程自由，更在于 GO 架构自由。
另外，前面尼恩的云原生是没有涉及GO的，但是，没有GO的云原生是不完整的。
所以， GO语言、GO架构学习完了之后，咱们再去打个回马枪，完成云原生的第二部分: 《Istio &#43; K8S CRD的架构与开发实操》 , 帮助大家彻底穿透云原生。
文章目录 说在前面基于 Gin 框架的 Rest微服务架构与选型回顾：java&#43;go 多语言 云原生微服务架构 Gin 框架 简介Gin 框架的安装和使用使用 Gin 框架编写 Hello Worldmain.go的执行过程 Gin Rest微服务的模块设计Gin Rest微服务目录结构 Gin框架WEB开发入门基本安装Rest请求路由的配置和使用Rest请求路径的设置router.GET方法的源码分析Gin配置路由的七个主要方法路由分组 大规模路由的多文件配置获取参数获取路径参数获取URL参数获取Post方法URL参数和Post参数的获取案例 文件上传表单验证设置校验的规则content-type绑定 Gin 数据返回类型Gin 重定向异步执行会话控制cookie相关session相关token相关 Gin中间件默认Gin中间件自定义Gin中间件中间件控制的方法局部中间件 Gin的路由框架：httprouter框架前缀树和基数树（radix tree）的区别：gin框架路由原理gin注册路由过程： 微服务统一配置管理为什么需要分布式配置中心分布式配置中心技术选型Spring Cloud NacosSpring Cloud Eureka： golang的土著配置组件viper 通过 viper实现统一配置管理功能1、viper的介绍2、viper的安装和使用2.1 Viper对象的创建2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2742ca001873ce7b1dbd767ff94cb670/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-16T12:21:29+08:00" />
<meta property="article:modified_time" content="2023-06-16T12:21:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">从0开始，精通Go语言Rest微服务架构和开发</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_6"></a>说在前面</h3> 
<p>现在<strong>拿到offer超级难</strong>，甚至连面试电话，一个都搞不到。</p> 
<p>尼恩的技术社区中（50+），很多小伙伴凭借 “左手云原生+右手大数据”的绝活，拿到了offer，并且是非常优质的offer，<strong>据说年终奖都足足18个月</strong>。</p> 
<p>第二个案例就是：前段时间，一个2年小伙伴希望涨薪到18K， 尼恩把GO 语言的项目架构，给他写入了简历，导致他的简历金光闪闪，脱胎换骨，完全可以去拿头条、腾讯等30K的offer， 年薪可以直接多 20W。</p> 
<p>第三个案例就是：<strong>一个6年小伙伴凭借Java+go双语言云原生架构，年薪60W</strong>。</p> 
<p>从Java高薪岗位和就业岗位来看，云原生、K8S、GO 现在对于 高级工程师/架构师来说，越来越重要。</p> 
<p>所以，尼恩从架构师视角出发，基于尼恩 3高架构知识宇宙，写一本《GO学习圣经》</p> 
<p><strong>《GO学习圣经》已经完成的内容有：</strong></p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/130803296">Go学习圣经：0基础精通GO开发与高并发架构 </a></p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/130854308">Go学习圣经：队列削峰+批量写入 超高并发原理和实操 </a></p> 
<p><strong>《GO学习圣经》PDF的最终目标</strong></p> 
<p>咱们的目标，不仅仅在于 GO 应用编程自由，更在于 GO 架构自由。</p> 
<p>另外，前面尼恩的云原生是没有涉及GO的，但是，没有GO的云原生是不完整的。</p> 
<p>所以， GO语言、GO架构学习完了之后，咱们再去打个回马枪，完成云原生的第二部分: <strong>《Istio + K8S CRD的架构与开发实操》</strong> , 帮助大家彻底穿透云原生。</p> 
<img src="https://images2.imgbox.com/e0/5a/Fy49k6xk_o.jpg" width="400"> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_6" rel="nofollow">说在前面</a></li><li><a href="#_Gin__Rest_43" rel="nofollow">基于 Gin 框架的 Rest微服务架构与选型</a></li><li><ul><li><a href="#javago___45" rel="nofollow">回顾：java+go 多语言 云原生微服务架构</a></li></ul> 
   </li><li><a href="#Gin___67" rel="nofollow">Gin 框架 简介</a></li><li><a href="#Gin__87" rel="nofollow">Gin 框架的安装和使用</a></li><li><ul><li><a href="#_Gin__Hello_World_148" rel="nofollow">使用 Gin 框架编写 Hello World</a></li><li><a href="#maingo_208" rel="nofollow">main.go的执行过程</a></li></ul> 
   </li><li><a href="#Gin_Rest_270" rel="nofollow">Gin Rest微服务的模块设计</a></li><li><ul><li><a href="#Gin_Rest_276" rel="nofollow">Gin Rest微服务目录结构</a></li></ul> 
   </li><li><a href="#GinWEB_311" rel="nofollow">Gin框架WEB开发入门</a></li><li><ul><li><a href="#_313" rel="nofollow">基本安装</a></li><li><a href="#Rest_325" rel="nofollow">Rest请求路由的配置和使用</a></li><li><a href="#Rest_331" rel="nofollow">Rest请求路径的设置</a></li><li><a href="#routerGET_394" rel="nofollow">router.GET方法的源码分析</a></li><li><a href="#Gin_445" rel="nofollow">Gin配置路由的七个主要方法</a></li><li><a href="#_487" rel="nofollow">路由分组</a></li></ul> 
   </li><li><a href="#_554" rel="nofollow">大规模路由的多文件配置</a></li><li><a href="#_671" rel="nofollow">获取参数</a></li><li><ul><li><a href="#_673" rel="nofollow">获取路径参数</a></li><li><a href="#URL_733" rel="nofollow">获取URL参数</a></li><li><a href="#Post_748" rel="nofollow">获取Post方法</a></li><li><a href="#URLPost_767" rel="nofollow">URL参数和Post参数的获取案例</a></li></ul> 
   </li><li><a href="#_819" rel="nofollow">文件上传</a></li><li><a href="#_886" rel="nofollow">表单验证</a></li><li><ul><li><a href="#_1019" rel="nofollow">设置校验的规则</a></li><li><a href="#contenttype_1042" rel="nofollow">content-type绑定</a></li></ul> 
   </li><li><a href="#Gin__1122" rel="nofollow">Gin 数据返回类型</a></li><li><a href="#Gin__1152" rel="nofollow">Gin 重定向</a></li><li><a href="#_1172" rel="nofollow">异步执行</a></li><li><a href="#_1198" rel="nofollow">会话控制</a></li><li><ul><li><a href="#cookie_1204" rel="nofollow">cookie相关</a></li><li><a href="#session_1247" rel="nofollow">session相关</a></li><li><a href="#token_1303" rel="nofollow">token相关</a></li></ul> 
   </li><li><a href="#Gin_1402" rel="nofollow">Gin中间件</a></li><li><ul><li><a href="#Gin_1426" rel="nofollow">默认Gin中间件</a></li><li><a href="#Gin_1446" rel="nofollow">自定义Gin中间件</a></li><li><a href="#_1490" rel="nofollow">中间件控制的方法</a></li><li><a href="#_1530" rel="nofollow">局部中间件</a></li></ul> 
   </li><li><a href="#Ginhttprouter_1606" rel="nofollow">Gin的路由框架：httprouter框架</a></li><li><ul><li><a href="#radix_tree_1614" rel="nofollow">前缀树和基数树（radix tree）的区别：</a></li><li><a href="#gin_1624" rel="nofollow">gin框架路由原理</a></li><li><a href="#gin_1654" rel="nofollow">gin注册路由过程：</a></li></ul> 
   </li><li><a href="#_1691" rel="nofollow">微服务统一配置管理</a></li><li><ul><li><a href="#_1695" rel="nofollow">为什么需要分布式配置中心</a></li><li><a href="#_1703" rel="nofollow">分布式配置中心技术选型</a></li><li><ul><li><a href="#Spring_Cloud_Nacos_1729" rel="nofollow">Spring Cloud Nacos</a></li><li><a href="#Spring_Cloud_Eureka_1745" rel="nofollow">Spring Cloud Eureka：</a></li></ul> 
    </li><li><a href="#golangviper_1767" rel="nofollow">golang的土著配置组件viper</a></li></ul> 
   </li><li><a href="#_viper_1779" rel="nofollow">通过 viper实现统一配置管理功能</a></li><li><ul><li><a href="#1viper_1783" rel="nofollow">1、viper的介绍</a></li><li><a href="#2viper_1821" rel="nofollow">2、viper的安装和使用</a></li><li><ul><li><a href="#21__Viper_1833" rel="nofollow">2.1 Viper对象的创建</a></li><li><a href="#22__1904" rel="nofollow">2.2 预设一些默认配置</a></li><li><a href="#23_key_1924" rel="nofollow">2.3 key大小写问题</a></li><li><a href="#24__1939" rel="nofollow">2.4 从配置文件读取</a></li><li><a href="#25__2048" rel="nofollow">2.5 支持哪些文件格式</a></li></ul> 
    </li><li><a href="#3_2065" rel="nofollow">3、写配置文件</a></li><li><a href="#4_2117" rel="nofollow">4、从环境变量读取</a></li><li><a href="#5Flags_2188" rel="nofollow">5、从命令行工具的选项参数Flags读取</a></li><li><ul><li><a href="#viper__pflag__2208" rel="nofollow">viper + pflag 结合使用</a></li><li><a href="#Go__flag__2231" rel="nofollow">Go 语言标准库中的 flag 包</a></li><li><a href="#flag_2295" rel="nofollow">flag包绑定解析参数有三种定义方式</a></li><li><a href="#viper__flag__2420" rel="nofollow">viper + flag 结合使用</a></li></ul> 
    </li><li><a href="#6keyvalue_2472" rel="nofollow">6、从远程key/value存储读取</a></li><li><a href="#7_2541" rel="nofollow">7、监听配置变化</a></li><li><ul><li><a href="#71___2553" rel="nofollow">7.1 监听本地配置文件变化</a></li><li><a href="#72___2581" rel="nofollow">7.2 监听远程配置变化</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_Nacos_2614" rel="nofollow">通过 Nacos实现统一配置管理功能</a></li><li><ul><li><a href="#SpringCloud__2618" rel="nofollow">SpringCloud 分布式配置中心选型</a></li><li><a href="#javago____2648" rel="nofollow">用java+go 多语言 云原生微服务架构中配置中心的 位置</a></li></ul> 
   </li><li><a href="#Nacos_2664" rel="nofollow">Nacos作为配置中心使用</a></li><li><ul><li><a href="#Nacos_2666" rel="nofollow">为什么使用Nacos</a></li><li><a href="#Nacos_2673" rel="nofollow">Nacos是什么？</a></li><li><a href="#Nacos_2681" rel="nofollow">Nacos的结构和组件</a></li><li><a href="#Nacos_2729" rel="nofollow">Nacos的安装和使用</a></li><li><a href="#NamespaceGroupData_ID_2753" rel="nofollow">配置数据的三个核心概念：Namespace、Group、Data ID</a></li><li><ul><li><a href="#Namespace__2755" rel="nofollow">命名空间(Namespace) ：环境隔离</a></li><li><a href="#Group_2775" rel="nofollow">配置分组（Group）：项目隔离</a></li><li><a href="#_Data_ID_2787" rel="nofollow">配置集( Data ID）：功能隔离</a></li><li><a href="#_2805" rel="nofollow">配置集包含一个一个的配置项</a></li></ul> 
    </li><li><a href="#go_nacos_sdk__2819" rel="nofollow">go nacos sdk 的使用</a></li><li><ul><li><a href="#nacossdkgo_demo_2849" rel="nofollow">nacos-sdk-go 的官方demo</a></li><li><a href="#go_nacos_2960" rel="nofollow">示例：go nacos实现配置读取与监听配置变化</a></li></ul> 
    </li><li><a href="#nacos_go_3041" rel="nofollow">nacos go动态配置</a></li></ul> 
   </li><li><a href="#Golang__5W_3140" rel="nofollow">《Golang 圣经》还有 5W字待发布</a></li><li><a href="#_3148" rel="nofollow">参考资料</a></li><li><a href="#_3164" rel="nofollow">推荐阅读：</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_Gin__Rest_43"></a>基于 Gin 框架的 Rest微服务架构与选型</h3> 
<h4><a id="javago___45"></a>回顾：java+go 多语言 云原生微服务架构</h4> 
<p>上个月尼恩指导 一个6年小伙伴简历，使用java+go 多语言 云原生微服务架构，</p> 
<p>这个架构，非常牛掰， <strong>帮助 6年小伙，收了一个60W年薪优质offer</strong></p> 
<p>主要的架构图图如下：</p> 
<p><img src="https://images2.imgbox.com/ad/a0/oWTaJXT3_o.png" alt=""></p> 
<p>GO BFF 在技术架构上， 使用 RestFull Api服务层 + Dubbo RPC 消费层的双层架构。</p> 
<p>RestFull Api服务层 ，对前端提供 Rest 服务</p> 
<p>Dubbo RPC 消费层 , 对后端实现 Dubbo 高性能远程调用。</p> 
<p>在这个架构中， 用java+go 多语言 云原生微服务架构中的分布式 配置中心 ，是nacos</p> 
<p>而go 中的viper框架，没有对 nacos 提供支持 所以，咱们自己实现，对 nacos 的支持</p> 
<h3><a id="Gin___67"></a>Gin 框架 简介</h3> 
<p>Gin 是一个基于 Go 语言的 Web 框架，它具有高性能、易学易用、轻量级等特点，被广泛应用于构建 RESTful API 和微服务等场景。</p> 
<p>Gin 框架提供了丰富的中间件支持，可以方便地实现请求路由、参数解析、日志记录、错误处理等功能。</p> 
<p>Gin 框架的设计灵感来自于 Martini 框架，但相比之下，Gin 框架更快、更稳定、更易用。</p> 
<p>Gin 具有类似于 Martini 的 API 风格，并且它使用了著名的开源项目 httprouter 的自定义版本作为路由基础，使得它的性能表现更高更好，相较 Martini 大约提高了 40 倍。</p> 
<p>另外 gin 除了快以外，还具备小巧、精美且易用的特性，目前广受 Go 语言开发者的喜爱，是最流行的 HTTP Web 框架</p> 
<p>从 Github Star 上来看, gin框架的趋势如下：</p> 
<p><img src="https://images2.imgbox.com/c0/33/hRVuuce7_o.jpg" alt=""></p> 
<h3><a id="Gin__87"></a>Gin 框架的安装和使用</h3> 
<p>要安装 Gin 框架，你需要先安装 Go 语言环境，并设置好 GOPATH 和 PATH 环境变量。然后可以使用以下命令安装 Gin：</p> 
<pre><code class="prism language-bash">go get -u github.com/gin-gonic/gin
</code></pre> 
<p>这将从 GitHub 下载 Gin 框架的最新版本并安装到你的 GOPATH 目录下。</p> 
<p>在安装完毕后，我们可以看到项目根目录下的 go.mod 文件也会发生相应的改变.</p> 
<p>打开 go.mod 文件，查看如下：</p> 
<pre><code class="prism language-go">module github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>programming<span class="token operator">-</span>tour<span class="token operator">-</span>book<span class="token operator">/</span>blog<span class="token operator">-</span>service
<span class="token keyword">go</span> <span class="token number">1.14</span>
require <span class="token punctuation">(</span>
    github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin v1<span class="token punctuation">.</span><span class="token number">9.0</span> <span class="token comment">// indirect</span>
    github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>playground<span class="token operator">/</span>universal<span class="token operator">-</span>translator v0<span class="token punctuation">.</span><span class="token number">18.1</span> <span class="token comment">// indirect</span>
    <span class="token operator">...</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>这些正正就是 gin 所相关联的所有模块包.</p> 
<p>大家可能会好奇，为什么 <code>github.com/gin-gonic/gin</code> 后面会出现 indirect 标识，</p> 
<p>在执行命令<code>go get </code>时，Go module 会自动整理<code>go.mod</code> 文件，如果有必要会在部分依赖包的后面增加<code>// indirect</code>注释。</p> 
<p>一般而言，被添加<code>// indirect</code> 注释的包,肯定是间接依赖的包，</p> 
<p>而没有添加<code>// indirect</code>注释的包则是直接依赖的包，什么叫做直接依赖呢 ？ 即明确的出现在某个<code>import</code>语句中。</p> 
<p>然而，需要着重强调的是：**并不是所有的间接依赖都会出现在 <code>go.mod</code>文件中。**间接依赖出现在<code>go.mod</code>文件的情况，可能符合下面所列场景的一种或多种：</p> 
<ul><li>直接依赖未启用 Go module</li><li>直接依赖go.mod 文件中缺失部分依赖</li></ul> 
<p>回到上面的 go.mod 文件，查看如下：</p> 
<pre><code class="prism language-go">module github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>programming<span class="token operator">-</span>tour<span class="token operator">-</span>book<span class="token operator">/</span>blog<span class="token operator">-</span>service
<span class="token keyword">go</span> <span class="token number">1.14</span>
require <span class="token punctuation">(</span>
    github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin v1<span class="token punctuation">.</span><span class="token number">9.0</span> <span class="token comment">// indirect</span>
    github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>playground<span class="token operator">/</span>universal<span class="token operator">-</span>translator v0<span class="token punctuation">.</span><span class="token number">18.1</span> <span class="token comment">// indirect</span>
    <span class="token operator">...</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>它明明是我们直接通过调用 <code>go get</code> 引用的， 为啥加了 <code>// indirect</code>注释 ？</p> 
<p>是因为在我们安装时，这个项目模块还没有真正的去使用它所导致的（还没哟在某个<code>import</code>语句中 出现 ）。</p> 
<p>另外你会注意到，在 go.mod 文件中有类似 <code>go 1.14</code> 这样的标识位，主要与你创建 Go modules 时的 Go 版本有关。</p> 
<h4><a id="_Gin__Hello_World_148"></a>使用 Gin 框架编写 Hello World</h4> 
<p>在完成前置动作后，在本节我们先将一个 Demo 运行起来，看看一个最简单的 HTTP 服务运行起来是怎么样的，</p> 
<p>使用 Gin 框架编写 Web 应用程序非常简单，以下是一个简单的示例：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"net/http"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个应用程序创建了一个简单的 HTTP 服务器，监听本地的 8080 端口，并在访问根路径时返回 “Hello, World!”。</p> 
<p>你可以使用 <code>go run</code> 命令运行这个应用程序：</p> 
<pre><code class="prism language-bash">go run main.go
</code></pre> 
<p>也可以在goland 工具中直接启动 ，具体如下：</p> 
<p><img src="https://images2.imgbox.com/4a/22/ERZXxSlT_o.png" alt=""></p> 
<p>然后在浏览器中访问 <a href="http://localhost:8080/" rel="nofollow">http://localhost:8080</a> 就可以看到 “Hello, World!” 的响应了。</p> 
<p><img src="https://images2.imgbox.com/ea/63/9XDWbYo7_o.png" alt=""></p> 
<p>当然，这只是 Gin 框架的一个简单示例，你可以根据自己的需求编写更复杂的 Web 应用程序。</p> 
<h4><a id="maingo_208"></a>main.go的执行过程</h4> 
<p>接下来我们运行 main.go 文件，查看运行结果，如下：</p> 
<pre><code class="prism language-bash"> - using env:   <span class="token builtin class-name">export</span> <span class="token assign-left variable">GIN_MODE</span><span class="token operator">=</span>release
 - using code:  gin.SetMode<span class="token punctuation">(</span>gin.ReleaseMode<span class="token punctuation">)</span>

<span class="token punctuation">[</span>GIN-debug<span class="token punctuation">]</span> GET    /                         --<span class="token operator">&gt;</span> main.main.func1 <span class="token punctuation">(</span><span class="token number">3</span> handlers<span class="token punctuation">)</span>
<span class="token punctuation">[</span>GIN-debug<span class="token punctuation">]</span> <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> You trusted all proxies, this is NOT safe. We recommend you to <span class="token builtin class-name">set</span> a value.
Please check https://pkg.go.dev/github.com/gin-gonic/gin<span class="token comment">#readme-don-t-trust-all-proxies for details.</span>
<span class="token punctuation">[</span>GIN-debug<span class="token punctuation">]</span> Listening and serving HTTP on :8080
</code></pre> 
<p>我们可以看到启动了服务后，输出了许多运行信息，</p> 
<p>在这里我们对运行信息做一个初步的概括分析，分为以下四大块：</p> 
<p>首先是gin的运行模式：当前为Release 模式。</p> 
<pre><code class="prism language-bash"> - using code:  gin.SetMode<span class="token punctuation">(</span>gin.ReleaseMode<span class="token punctuation">)</span>
</code></pre> 
<p>这是 Go 语言中使用 Gin 框架时，设置运行模式为 Release 模式的代码。</p> 
<p>在 Release 模式下，Gin 框架会关闭调试信息和堆栈跟踪，以提高性能和安全性。</p> 
<p>这个设置通常在应用程序的 main 函数或初始化代码中进行。</p> 
<p>并建议若在测试环境时切换为debug模式，gin.SetMode(gin.DebugMode) 切换为debug模式，</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gin<span class="token punctuation">.</span><span class="token function">SetMode</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>DebugMode<span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来，是请求的路由注册：注册了 <code>GET /ping</code> 的路由，并输出其调用方法的方法名。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>GIN-debug<span class="token punctuation">]</span> GET    /    --<span class="token operator">&gt;</span> main.main.func1 <span class="token punctuation">(</span><span class="token number">3</span> handlers<span class="token punctuation">)</span>
</code></pre> 
<p>接下来，是监听端口信息：本次启动时监听 8080 端口，由于没有设置端口号等信息，因此默认为 8080。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>GIN-debug<span class="token punctuation">]</span> Listening and serving HTTP on :8080
</code></pre> 
<h3><a id="Gin_Rest_270"></a>Gin Rest微服务的模块设计</h3> 
<p>在完成了初步的示例演示后，接下来就是进入具体的预备开发阶段，一般在正式进入业务开发前，我们会针对本次需求的迭代内容进行多类的设计和评审，无设计不开发。</p> 
<p>但是问题在于，我们目前还缺很多初始化的东西没有做，因此在本章节中，我们主要针对项目目录结构、接口方案、路由注册、数据库等设计进行思考和设计开发。</p> 
<h4><a id="Gin_Rest_276"></a>Gin Rest微服务目录结构</h4> 
<p>我们先将项目的标准目录结构创建起来，便于后续的开发，最终目录结构如下：</p> 
<pre><code class="prism language-bash">gin-rest
├── configs
├── docs
├── global
├── internal
│   ├── dao
│   ├── middleware
│   ├── model
│   ├── routers
│   └── <span class="token function">service</span>
├── pkg
├── storage
├── scripts
└── third_party
</code></pre> 
<ul><li>configs：配置文件。</li><li>docs：文档集合。</li><li>global：全局变量。</li><li>internal：内部模块。 
  <ul><li>dao：数据访问层（Database Access Object），所有与数据相关的操作都会在 dao 层进行，例如 MySQL、ElasticSearch 等。</li><li>middleware：HTTP 中间件。</li><li>model：模型层，用于存放 model 对象。</li><li>routers：路由相关逻辑处理。</li><li>service：项目核心业务逻辑。</li></ul> </li><li>pkg：项目相关的模块包。</li><li>storage：项目生成的临时文件。</li><li>scripts：各类构建，安装，分析等操作的脚本。</li><li>third_party：第三方的资源工具。</li></ul> 
<h3><a id="GinWEB_311"></a>Gin框架WEB开发入门</h3> 
<h4><a id="_313"></a>基本安装</h4> 
<p>1.首先需要安装Go（需要1.10+版本），然后可以使用下面的Go命令安装Gin。</p> 
<blockquote> 
 <p>go get -u github.com/gin-gonic/gin</p> 
</blockquote> 
<p>2.将其导入您的代码中：</p> 
<blockquote> 
 <p>import “github.com/gin-gonic/gin”</p> 
</blockquote> 
<h4><a id="Rest_325"></a>Rest请求路由的配置和使用</h4> 
<p>路由的本质是前缀树，利用前缀树来实现路由的功能。</p> 
<h4><a id="Rest_331"></a>Rest请求路径的设置</h4> 
<p>Gin框架的Rest路由使用非常简单，可以通过定义路由以及处理该路由对应的Handler来接收用户的Web请求。</p> 
<p>以下是一个使用Gin框架的路由示例：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"net/http"</span>

    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>gin.Default()</code> 表示：实例化一个GIN对象</p> 
<p><code>router.Run(":8080")</code> 表示：启动一个HTTP服务进程，默认监听在8080端口</p> 
<p><code>router.GET(...)</code> 是路由设置。</p> 
<p>router路由的路径设置，遵循Restful风格（采用URL定位，HTTP描述操作）, 下面是路由配置的几个例子：</p> 
<pre><code class="prism language-go"><span class="token comment">//定义handler方法, 类似于java中的 Controller</span>
<span class="token keyword">func</span> <span class="token function">getting</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
		<span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"getting"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//定义handler方法, 类似于java中的 Controller</span>
<span class="token keyword">func</span> <span class="token function">posting</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
		<span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"posting"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment">// 设置路由</span>
router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 第一个参数是：路径； 第二个参数是：具体操作 func(c *gin.Context)</span>
router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/Get"</span><span class="token punctuation">,</span> getting<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/Post"</span><span class="token punctuation">,</span> posting<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span><span class="token string">"/Put"</span><span class="token punctuation">,</span> putting<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span><span class="token string">"/Delete"</span><span class="token punctuation">,</span> deleting<span class="token punctuation">)</span>
<span class="token comment">// 默认启动的是 8080端口</span>
router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="routerGET_394"></a>router.GET方法的源码分析</h4> 
<p>router的GET方法，参数表中分别是路径和多个handler</p> 
<pre><code class="prism language-go"><span class="token comment">// GET is a shortcut for router.Handle("GET", path, handle).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>group <span class="token operator">*</span>RouterGroup<span class="token punctuation">)</span> <span class="token function">GET</span><span class="token punctuation">(</span>relativePath <span class="token builtin">string</span><span class="token punctuation">,</span> handlers <span class="token operator">...</span>HandlerFunc<span class="token punctuation">)</span> IRoutes <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> group<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> relativePath<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>处理器 handlerFunc的具体类型:</p> 
<pre><code class="prism language-go"><span class="token comment">// HandlerFunc defines the handler used by gin middleware as return value.</span>
<span class="token keyword">type</span> HandlerFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Context<span class="token punctuation">)</span>
</code></pre> 
<p>所以，定义处理器的时候，需要按照下面这种格式定义函数:</p> 
<pre><code class="prism language-go"><span class="token comment">//定义handler方法, 类似于java中的 Controller</span>
<span class="token keyword">func</span> <span class="token function">getting</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span>gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
		<span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"getting"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>JSON中的key是HTTP的状态码，JSON中的value是一个map。</p> 
<p>为啥呢？ 因为 gin.H 就是一个map:</p> 
<pre><code class="prism language-go"><span class="token comment">// H is a shortcut for map[string]interface{}</span>
<span class="token keyword">type</span> H <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any
</code></pre> 
<p>所以，按照下面的方式定义处理器，也是可以的:</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">pong</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span>
		<span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"pong"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Gin_445"></a>Gin配置路由的七个主要方法</h4> 
<p>Gin配置路由是为了处理HTTP请求。</p> 
<p>Gin框架中都有和HTTP请求相互对应的方法来定义路由。而HTTP请求包含不同方法，包括<code>GET</code>,<code>POST</code>,<code>PUT</code>,<code>PATCH</code>,<code>OPTIONS</code>,<code>HEAD</code>,<code>DELETE</code>等七种方法。</p> 
<p>下面是Gin一系列的 路由定义案例</p> 
<pre><code class="prism language-bash">router :<span class="token operator">=</span> gin.New<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
router.GET<span class="token punctuation">(</span><span class="token string">"/testGet"</span>,func<span class="token punctuation">(</span>c *gin.Context<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    //处理逻辑
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
router.POST<span class="token punctuation">(</span><span class="token string">"/testPost"</span>,func<span class="token punctuation">(</span>c *gin.Context<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    //处理逻辑
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
router.PUT<span class="token punctuation">(</span><span class="token string">"/testPut"</span>,func<span class="token punctuation">(</span>c *gin.Context<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    //处理逻辑
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
router.DELETE<span class="token punctuation">(</span><span class="token string">"/testDelete"</span>,func<span class="token punctuation">(</span>c *gin.Context<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    //处理逻辑
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
router.PATCH<span class="token punctuation">(</span><span class="token string">"/testPatch"</span>,func<span class="token punctuation">(</span>c *gin.Context<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    //处理逻辑
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
router.OPTIONS<span class="token punctuation">(</span><span class="token string">"/testOptions"</span>,func<span class="token punctuation">(</span>c *gin.Context<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    //处理逻辑
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
router.OPTIONS<span class="token punctuation">(</span><span class="token string">"/testHead"</span>,func<span class="token punctuation">(</span>c *gin.Context<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    //处理逻辑
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_487"></a>路由分组</h4> 
<p>Group是一个路由分组器，可以将一组路由规则组织在一起，方便管理和维护。</p> 
<p>Gin框架的路由分组可以通过Group函数实现。</p> 
<p>下面是没有使用Group方法进行路由配置的例子：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/goods/list"</span><span class="token punctuation">,</span>goodsList<span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/goods/add"</span><span class="token punctuation">,</span>createGoods<span class="token punctuation">)</span>
	
	<span class="token boolean">_</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用路由分组改写，与上面的代码是同样的效果:</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
	goodsGroup <span class="token operator">:=</span> router<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/goods"</span><span class="token punctuation">)</span>
	goodsGroup<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">,</span> goodsList<span class="token punctuation">)</span>
	goodsGroup<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/add"</span><span class="token punctuation">,</span> createGoods<span class="token punctuation">)</span>
 
	<span class="token boolean">_</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>很多的业务代码，会定义url的不同版本，在这种场景下，就可以使用版本号来分组：</p> 
<pre><code class="prism language-go"><span class="token comment">// 两个路由组，都可以访问，大括号是为了保证规范</span>
v1 <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/v1"</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 通过 localhost:8080/v1/hello访问，以此类推</span>
    v1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">,</span> sayHello<span class="token punctuation">)</span>
    v1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/world"</span><span class="token punctuation">,</span> sayWorld<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
v2 <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/v2"</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    v2<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">,</span> sayHello<span class="token punctuation">)</span>
    v2<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/world"</span><span class="token punctuation">,</span> sayWorld<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
</code></pre> 
<p>访问的时候，可以通过下面的方式，访问v1版本的地址：</p> 
<pre><code class="prism language-bash">localhost:8080/v1/hello
localhost:8080/v1/world
</code></pre> 
<p>访问的时候，可以通过下面的方式，访问v2版本的地址：</p> 
<pre><code class="prism language-bash">localhost:8080/v2/hello
localhost:8080/v2/world
</code></pre> 
<h3><a id="_554"></a>大规模路由的多文件配置</h3> 
<p>当我们的路由变得非常多的时候，那么建议遵循以下步骤：</p> 
<ol><li>建立<code>routers</code>包，将不同模块拆分到<code>多个go文件</code></li><li>每个go文件提供<code>一个路由配置方法</code>，该方法注册实现一个分组的所有的路由</li><li>之后main方法在调用文件的路由配置方法，实现路由注册</li></ol> 
<p>例子：第一个路由分组go文件：</p> 
<p><code>/src/../routers/apiRouter.go</code></p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> routers

<span class="token comment">// 这里是一个路由配置方法 ， routers包下某一个router对外开放的方法</span>
<span class="token keyword">func</span> <span class="token function">LoadRouter</span><span class="token punctuation">(</span>e <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    e<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        v1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/post"</span><span class="token punctuation">,</span> postHandler<span class="token punctuation">)</span>
  		v1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">,</span> getHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>例子：第二个路由分组go文件：</p> 
<p><code>/src/../routers/uaaRouter.go</code></p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> routers

<span class="token comment">// 这里是一个路由配置方法 ， 是routers包下某一个router对外开放的方法</span>
<span class="token keyword">func</span> <span class="token function">LoadUaaRouter</span><span class="token punctuation">(</span>e <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    e<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        v1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/post"</span><span class="token punctuation">,</span> postHandler<span class="token punctuation">)</span>
  		v1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">,</span> getHandler<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>main文件实现：</strong></p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 调用该方法实现注册</span>
    routers<span class="token punctuation">.</span><span class="token function">LoadRouter</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    routers<span class="token punctuation">.</span><span class="token function">LoadUaaRouter</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token comment">// 代表还有多个</span>
    r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>规模如果继续扩大也有更好的处理方式（建议别太大，将服务拆分好）：</strong></p> 
<p>项目规模更大的时候，我们可以遵循以下步骤：</p> 
<ul><li>1.建立<code>routers</code>包，内部划分模块（包），每个包有个<code>router.go</code>文件，负责该模块的路由注册</li><li>2.建立<code>setup_router.go</code>文件，并编写一个专用的路由初始化方法</li><li>3.main.go中按如下方式写入需要注册的路由，可进行路由的初始化</li></ul> 
<ol><li>建立<code>routers</code>包，内部划分模块（包），每个包有个<code>router.go</code>文件，负责该模块的路由注册</li></ol> 
<pre><code class="prism language-go">├── routers
│   │
│   ├── say
│   │   ├── sayWorld<span class="token punctuation">.</span><span class="token keyword">go</span>
│   │   └── router<span class="token punctuation">.</span><span class="token keyword">go</span>
│   │
│   ├── hello
│   │   ├── helloWorld<span class="token punctuation">.</span><span class="token keyword">go</span>
│   │   └── router<span class="token punctuation">.</span><span class="token keyword">go</span>
│   │
│   └── setup_router<span class="token punctuation">.</span><span class="token keyword">go</span>
│   
└── main<span class="token punctuation">.</span><span class="token keyword">go</span>
</code></pre> 
<ol start="2"><li>建立<code>setup_router.go</code>文件，并编写一个专用的路由初始化方法：</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Register <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Init</span><span class="token punctuation">(</span>routers <span class="token operator">...</span>Register<span class="token punctuation">)</span> <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 注册路由</span>
	rs <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Register<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> routers<span class="token operator">...</span><span class="token punctuation">)</span>

	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 遍历调用方法</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> register <span class="token operator">:=</span> <span class="token keyword">range</span> rs <span class="token punctuation">{<!-- --></span>
		<span class="token function">register</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> r
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>main.go中按如下方式写入需要注册的路由，可进行路由的初始化：</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置需要加载的路由配置</span>
    r <span class="token operator">:=</span> routers<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>
		say<span class="token punctuation">.</span>Routers<span class="token punctuation">,</span>
		hello<span class="token punctuation">.</span>Routers<span class="token punctuation">,</span> <span class="token comment">// 后面还可以有多个</span>
	<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_671"></a>获取参数</h3> 
<h4><a id="_673"></a>获取路径参数</h4> 
<p>可以通过匹配的方式，获取路径上的参数</p> 
<ul><li><code>:</code> 只能匹配1个</li><li><code>* </code>可以匹配任意个数</li></ul> 
<p>方式一,使用 <code>:</code> 只匹配1个参数</p> 
<p>例子：</p> 
<pre><code class="prism language-go"><span class="token comment">// 此规则能够匹配/user/xxx这种格式，但不能匹配/user/ 或 /user这种格式</span>
router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/user/:name"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Hello %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里name会作为参数，例如访问<code>http://localhost:8080/user/aaa</code>，name便等于aaa</p> 
<p>方式二,使用 <code>* </code>可以匹配任意个数</p> 
<pre><code class="prism language-go">router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/user/:name/*action"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
    action <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">"action"</span><span class="token punctuation">)</span>
    message <span class="token operator">:=</span> name <span class="token operator">+</span> <span class="token string">" is "</span> <span class="token operator">+</span> action
    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>规则：</p> 
<pre><code class="prism language-bash">/user/:name/*action
</code></pre> 
<p>此规则既能匹配 /user/aaa/ 格式，也能匹配 <code>/user/aaa/other1/other2</code> 这种格式</p> 
<pre><code class="prism language-bash"> localhost:8080/user/aaa/
</code></pre> 
<p><img src="https://images2.imgbox.com/f2/21/61fjiG2B_o.png" alt=""></p> 
<p>访问： <code>localhost:8080/user/aaa/other1/</code></p> 
<p><img src="https://images2.imgbox.com/a0/47/5bDNWy4o_o.png" alt=""></p> 
<p>访问： <code>localhost:8080/user/aaa/other1/other2/</code></p> 
<p><img src="https://images2.imgbox.com/4c/fd/JHLtHH5T_o.png" alt=""></p> 
<p>注意<code>* </code>只能在最后用</p> 
<h4><a id="URL_733"></a>获取URL参数</h4> 
<ul><li>获取URL参数可以通过DefaultQuery()或Query()方法获取</li><li>若参数不存在，DefaultQuery()返回默认值，Query()返回空串</li></ul> 
<pre><code class="prism language-go">r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//指定默认值</span>
    name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultQuery</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"normal"</span><span class="token punctuation">)</span>
    <span class="token comment">//获取具体值</span>
    age <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"hello %s, your age is %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="Post_748"></a>获取Post方法</h4> 
<pre><code class="prism language-go">r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/form"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置默认值</span>
    types <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultPostForm</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"post"</span><span class="token punctuation">)</span>
    username <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
    password <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
    <span class="token comment">// 还可以使用Query实现 Get + Post的结合</span>
    name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">,</span>
        <span class="token string">"types"</span><span class="token punctuation">:</span>    types<span class="token punctuation">,</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> 	name<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="URLPost_767"></a>URL参数和Post参数的获取案例</h4> 
<p>下面是 URL参数和Post参数的获取案例</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/welcome"</span><span class="token punctuation">,</span> welcome<span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> login<span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/post"</span><span class="token punctuation">,</span> getPost<span class="token punctuation">)</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 获取GET传参</span>
<span class="token keyword">func</span> <span class="token function">welcome</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	firstName <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultQuery</span><span class="token punctuation">(</span><span class="token string">"firstname"</span><span class="token punctuation">,</span> <span class="token string">"unknown"</span><span class="token punctuation">)</span>
	lastName <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultQuery</span><span class="token punctuation">(</span><span class="token string">"lastname"</span><span class="token punctuation">,</span> <span class="token string">"unknown"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
		<span class="token string">"first_name"</span><span class="token punctuation">:</span> firstName<span class="token punctuation">,</span>
		<span class="token string">"last_name"</span><span class="token punctuation">:</span>  lastName<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 获取POST传参</span>
<span class="token keyword">func</span> <span class="token function">login</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	username <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultPostForm</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span>
	password <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultPostForm</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
		<span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
		<span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 混合获取参数</span>
<span class="token keyword">func</span> <span class="token function">getPost</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取GET参数</span>
	id <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
	page <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultQuery</span><span class="token punctuation">(</span><span class="token string">"page"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span>
    <span class="token comment">// 获取POST参数</span>
	name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
	message <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">DefaultPostForm</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
		<span class="token string">"id"</span><span class="token punctuation">:</span>      id<span class="token punctuation">,</span>
		<span class="token string">"page"</span><span class="token punctuation">:</span>    page<span class="token punctuation">,</span>
		<span class="token string">"name"</span><span class="token punctuation">:</span>    name<span class="token punctuation">,</span>
		<span class="token string">"message"</span><span class="token punctuation">:</span> message<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_819"></a>文件上传</h3> 
<p><strong>单个文件获取：</strong></p> 
<p>在使用 Gin 框架时，可以使用 <code>c.FormFile()</code> 方法来获取上传文件。这个方法会返回一个 <code>*multipart.FileHeader</code> 对象，它包含了上传文件的信息，比如文件名、文件大小、文件类型等。你可以通过这个对象获取文件的内容，并进行相应的处理。</p> 
<p>以下是一个简单的示例代码，演示了如何使用 <code>c.FormFile()</code> 方法来上传文件：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">FormFile</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"上传文件失败: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 保存文件到本地</span>
    err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">SaveUploadedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"保存文件失败: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"文件 %s 上传成功"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的代码中，我们首先使用 <code>c.FormFile()</code> 方法获取上传文件。如果获取失败，我们会返回一个错误信息。如果获取成功，我们就可以使用 <code>c.SaveUploadedFile()</code> 方法将文件保存到本地。最后，我们返回一个成功上传的信息。</p> 
<p>在使用 <code>c.FormFile()</code> 方法时，需要注意的是，参数名应该与 HTML 表单中的文件上传控件的 <code>name</code> 属性相同。在上面的示例中，我们假设上传文件控件的 <code>name</code> 属性为 <code>"file"</code>。</p> 
<p>上传文件的时候，也可以通过限制大小，参考代码如下：</p> 
<pre><code class="prism language-go">r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 给表单限制上传大小 (默认 32 MiB)</span>
r<span class="token punctuation">.</span>MaxMultipartMemory <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span> <span class="token comment">// 8 MiB</span>
r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">FormFile</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"上传文件出错"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 上传到指定路径</span>
    c<span class="token punctuation">.</span><span class="token function">SaveUploadedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">"C:/desktop/"</span><span class="token operator">+</span>file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"fileName:"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>多个文件获取（只展示核心部分）：</strong></p> 
<pre><code class="prism language-go"><span class="token comment">// 获取MultipartForm</span>
form<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">MultipartForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"get err %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取所有文件</span>
files <span class="token operator">:=</span> form<span class="token punctuation">.</span>File<span class="token punctuation">[</span><span class="token string">"files"</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> file <span class="token operator">:=</span> <span class="token keyword">range</span> files <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 逐个存</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>Filename<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"upload ok %d files"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_886"></a>表单验证</h3> 
<p>GIN提供了两种方法来进行表单验证: Must Bind / Should Bind。“Must Bind” 和 “Should Bind” 是在编写程序时常用的两个概念。</p> 
<ul><li>“Must Bind” 意味着必须绑定某个变量或者参数，否则程序将无法正常运行。这种情况通常出现在必需的配置项或者必需的输入参数未被正确设置的情况下。</li><li>“Should Bind” 则表示建议绑定某个变量或者参数，但是如果未绑定也不会影响程序的正常运行。这种情况通常出现在可选的配置项或者可选的输入参数未被设置的情况下。</li></ul> 
<p>简而言之，“Must Bind” 表示必须绑定，否则程序无法正常运行；“Should Bind” 表示建议绑定，但不是必须的。</p> 
<p>在 Gin 框架中进行表单验证，可以使用 Gin 提供的 <code>binding</code> 包和 <code>validator</code> 包来实现。有3步骤：</p> 
<ul><li>1 导入 <code>binding</code> 和 <code>validator</code> 包</li><li>2 定义表单结构体，并使用 <code>binding:""</code> 和 <code>validate:""</code> 标记字段</li><li>3 在路由处理函数中使用 <code>ShouldBindWith</code> 方法解析请求参数，并使用 <code>validator</code> 包的 <code>ValidateStruct</code> 方法进行验证</li></ul> 
<p>具体步骤如下：</p> 
<ol><li>导入 <code>binding</code> 和 <code>validator</code> 包：</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/gin-gonic/gin"</span>
    <span class="token string">"github.com/gin-gonic/gin/binding"</span>
    <span class="token string">"gopkg.in/go-playground/validator.v9"</span>
<span class="token punctuation">)</span>
</code></pre> 
<ol start="2"><li>定义表单结构体，并使用 <code>binding:"required"</code> 和 <code>validate:""</code> 标记字段：</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">type</span> LoginForm <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    Username <span class="token builtin">string</span> <span class="token string">`json:"username" binding:"required" validate:"required"`</span>
    Password <span class="token builtin">string</span> <span class="token string">`json:"password" binding:"required" validate:"required"`</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中：</p> 
<ul><li><code>binding:"required"</code> 表示该字段在请求中必须存在，否则会返回 400 错误；</li><li><code>validate:"required"</code> 表示该字段必须有值，否则会返回 422 错误。</li></ul> 
<ol start="3"><li>在路由处理函数中使用 <code>ShouldBindWith</code> 方法解析请求参数，并使用 <code>validator</code> 包的 <code>ValidateStruct</code> 方法进行验证：</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">Login</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> form LoginForm
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindWith</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>form<span class="token punctuation">,</span> binding<span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    validate <span class="token operator">:=</span> validator<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> validate<span class="token punctuation">.</span><span class="token function">Struct</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnprocessableEntity<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// TODO: 处理登录逻辑</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中，有两个要点：</p> 
<ul><li><code>ShouldBindWith</code> 方法会根据请求头中的 <code>Content-Type</code> 自动解析请求参数，第二个参数指定了解析器类型，这里使用了 JSON 解析器；</li><li><code>ValidateStruct</code> 方法会根据表单结构体的标记进行验证，如果有错误则返回错误信息。</li></ul> 
<p>这样就可以在 Gin 框架中进行表单验证了。</p> 
<p>接收表单请求，获取用户名和密码:</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> LoginForm <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    Username <span class="token builtin">string</span> <span class="token string">`json:"username" binding:"required" validate:"required"`</span>
    Password <span class="token builtin">string</span> <span class="token string">`json:"password" binding:"required" validate:"required"`</span>
<span class="token punctuation">}</span>

 
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">var</span> loginForm LoginForm
		<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loginForm<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
				<span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
			<span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"login"</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用POST请求发送JSON数据</p> 
<pre><code class="prism language-bash">http://localhost:8080/login
</code></pre> 
<p><strong>验证失败</strong></p> 
<p>请求信息:</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"password"</span><span class="token operator">:</span><span class="token string">"123"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>请求的结果</p> 
<p><img src="https://images2.imgbox.com/03/f2/3Zyqz5LT_o.png" alt=""></p> 
<p><strong>验证成功</strong></p> 
<p>请求信息:</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"username"</span><span class="token operator">:</span><span class="token string">"David"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"password"</span><span class="token operator">:</span><span class="token string">"123"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>请求的结果</p> 
<p><img src="https://images2.imgbox.com/5c/1d/AS8xqwPf_o.png" alt=""></p> 
<h4><a id="_1019"></a>设置校验的规则</h4> 
<p>上面的案例，设置了 validate:“required” 。 如果<code>required</code>字段没有收到，错误日志会告知：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"error"</span><span class="token operator">:</span> <span class="token string">"Key: 'LoginForm.Username' Error:Field validation for 'Username' failed on the 'required' tag"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>除此之外，还可以有很多的校验。比如，通过tag设置范围校验，例如</p> 
<pre><code class="prism language-go">binding<span class="token punctuation">:</span><span class="token string">"required,gt=10"</span>  <span class="token operator">=</span>》 代表该值需要大于<span class="token number">10</span>
time_format<span class="token punctuation">:</span><span class="token string">"2006-01-02"</span> time_utc<span class="token punctuation">:</span><span class="token string">"1"</span>   <span class="token operator">=</span>》 时间格式 校验
</code></pre> 
<p>此外，还允许<strong>自定义校验方式</strong></p> 
<h4><a id="contenttype_1042"></a>content-type绑定</h4> 
<p>在 Gin 框架中，可以通过 <code>ShouldBindJSON()</code> 方法将请求体中的 Content-Type 是 application/json的数据与指定的结构体进行绑定。下面是一个使用 绑定请求体的示例：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Login <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    Username <span class="token builtin">string</span> <span class="token string">`json:"username" binding:"required"`</span>
    Password <span class="token builtin">string</span> <span class="token string">`json:"password" binding:"required"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> login Login
        <span class="token comment">// 将request的body中的数据，按照json格式解析到结构体</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果发送的不是json格式，那么输出：  "error": "invalid character '-' in numeric literal"</span>
            c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的示例中，我们定义了一个 <code>Login</code> 结构体，用于存储登录请求中的用户名和密码。</p> 
<p>在路由处理函数中，我们使用 <code>ShouldBindJSON()</code> 方法将请求体中的 JSON 数据与 <code>Login</code> 结构体进行绑定。</p> 
<p>如果绑定失败，我们将返回一个 400 错误响应，否则我们将继续处理登录逻辑。</p> 
<p>需要注意的是，这里使用了 <code>binding:"required"</code> 标签来指定 <code>Username</code> 和 <code>Password</code> 字段必须存在。如果请求体中缺少这些字段，绑定将失败，并返回一个错误响应。</p> 
<p>除了使用ShouldBindJSON，也可以使用<code>Bind</code>方法，参考代码如下：</p> 
<pre><code class="prism language-go">r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/loginJSON"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 声明接收的变量</span>
    <span class="token keyword">var</span> login Login

    <span class="token comment">// 默认绑定form格式</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据请求头中content-type自动推断</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 输出结果</span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
        <span class="token string">"status"</span><span class="token punctuation">:</span>   <span class="token string">"200"</span><span class="token punctuation">,</span>
        <span class="token string">"user"</span><span class="token punctuation">:</span>     login<span class="token punctuation">.</span>User<span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> login<span class="token punctuation">.</span>Password<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>Bind</code> 和 <code>ShouldBindJSON</code> 都是 Gin 框架中用于将请求体中的数据绑定到结构体中的方法。</p> 
<p>它们的区别在于，<code>Bind</code> 方法会根据请求头中的 Content-Type 自动选择绑定方法，而 <code>ShouldBindJSON</code> 方法则只会绑定 JSON 格式的请求体。</p> 
<p>举个例子，如果请求头中的 Content-Type 是 application/json，那么 <code>Bind</code> 方法和 <code>ShouldBindJSON</code> 方法都会将请求体中的 JSON 数据绑定到结构体中。但如果 Content-Type 是 application/xml，那么 <code>Bind</code> 方法会选择绑定 XML 格式的请求体，而 <code>ShouldBindJSON</code> 方法则会返回错误，因为它只能绑定 JSON 格式的请求体。</p> 
<p>因此，如果你确定请求体中的数据是 JSON 格式，可以直接使用 <code>ShouldBindJSON</code> 方法，否则建议使用 <code>Bind</code> 方法。</p> 
<p>在进行绑定时，可以使用 <code>Content-Type</code> 请求头来指定请求体的格式。</p> 
<h3><a id="Gin__1122"></a>Gin 数据返回类型</h3> 
<p>gin常见的三种响应数据：<code>JSON</code>、<code>XML</code>、<code>YAML</code></p> 
<pre><code class="prism language-go"><span class="token comment">// 1.JSON</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/someJSON"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
        <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Json"</span><span class="token punctuation">,</span>
        <span class="token string">"status"</span><span class="token punctuation">:</span>  <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 2.XML</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/someXML"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    c<span class="token punctuation">.</span><span class="token function">XML</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"abc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 3.YAML</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/someYAML"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    c<span class="token punctuation">.</span><span class="token function">YAML</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"zhangsan"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 4.protobuf</span>
r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/someProtoBuf"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    reps <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span>
    data <span class="token operator">:=</span> <span class="token operator">&amp;</span>protoexample<span class="token punctuation">.</span>Test<span class="token punctuation">{<!-- --></span>
        Reps<span class="token punctuation">:</span>  reps<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span><span class="token function">ProtoBuf</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="Gin__1152"></a>Gin 重定向</h3> 
<p>在 Gin 中，可以使用 <code>c.Redirect()</code> 方法进行重定向。该方法接受两个参数：重定向的目标 URL 和重定向的状态码。例如，以下代码将会将浏览器重定向到 <code>https://www.example.com</code>：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">redirectHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMovedPermanently<span class="token punctuation">,</span> <span class="token string">"https://www.example.com"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中，<code>http.StatusMovedPermanently</code> 是一个常量，表示 301 状态码。你也可以使用其他状态码，例如 <code>http.StatusFound</code>（302）。</p> 
<p>如果你想要在 URL 中包含查询参数，可以将它们添加到目标 URL 中。例如，以下代码将会将浏览器重定向到 <code>https://www.example.com?foo=bar</code>：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">redirectHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMovedPermanently<span class="token punctuation">,</span> <span class="token string">"https://www.example.com?foo=bar"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1172"></a>异步执行</h3> 
<p>在 Gin 中异步执行可以使用 Go 语言的协程（goroutine）来实现。在处理请求的处理函数中，可以使用 <code>go</code> 关键字来启动一个新的协程，使得处理函数可以立即返回，并且新的协程可以在后台继续执行。</p> 
<p>举个例子，如果我们需要在处理函数中执行一个比较耗时的操作，可以这样写：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 需要搞一个副本</span>
    copyContext <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 启动一个新的协程来执行耗时操作</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 执行耗时操作</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
        <span class="token comment">// 操作完成后，可以通过 c.Writer 写入响应数据</span>
        copyContext<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"耗时操作完成"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>在这个例子中，我们使用了匿名函数来启动一个新的协程，该协程会执行一个耗时操作，然后在操作完成后通过 <code>c.Writer</code> 写入响应数据。</p> 
<p>需要注意的是，在协程中访问 Gin 的上下文对象 <code>c</code> 时，需要使用闭包，以避免竞态条件。此外，还需要注意协程的数量，避免过多的协程导致系统资源耗尽。</p> 
<h3><a id="_1198"></a>会话控制</h3> 
<ul><li>cookie相关</li><li>session相关</li><li>token相关</li></ul> 
<h4><a id="cookie_1204"></a>cookie相关</h4> 
<ul><li>可以通过 <code>GetCookie</code> 方法获取客户端请求中携带的 cookie</li><li>可以通过 <code>SetCookie</code> 方法设置 cookie</li></ul> 
<p>在 Gin 中，可以通过 <code>SetCookie</code> 方法设置 cookie，例如：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/set-cookie"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"johndoe"</span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Cookie has been set"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的例子中，我们使用 <code>SetCookie</code> 方法设置了一个名为 “username” 的 cookie，它的值为 “johndoe”，过期时间为 3600 秒，路径为 “/”，域名为 “localhost”，不启用安全标志，启用 HTTPOnly 标志。在客户端可以通过 <code>document.cookie</code> 属性读取该 cookie。</p> 
<p>另外，可以通过 <code>GetCookie</code> 方法获取客户端请求中携带的 cookie，例如：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/get-cookie"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        username<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadRequest<span class="token punctuation">,</span> <span class="token string">"Cookie not found"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Hello "</span><span class="token operator">+</span>username<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的例子中，我们使用 <code>Cookie</code> 方法获取客户端请求中名为 “username” 的 cookie 的值，并将其作为字符串拼接到响应中。如果客户端请求中没有携带该 cookie，则返回 “Cookie not found”。</p> 
<h4><a id="session_1247"></a>session相关</h4> 
<p>Session 是一种在客户端和服务器之间保存状态的机制，它可以用来存储用户的登录信息、购物车信息等。Gin 提供了一个中间件 gin-contrib/sessions，它可以帮助我们在 Gin 中使用 Session。</p> 
<p>要使用 Gin Session，我们需要先安装 gin-contrib/sessions 包。可以使用以下命令进行安装：</p> 
<pre><code class="prism language-bash">go get github.com/gin-contrib/sessions
</code></pre> 
<p>安装完成后，我们需要在代码中引入 gin-contrib/sessions 包，并创建一个 Session 存储引擎。Gin 支持多种 Session 存储引擎，包括内存存储、Cookie 存储、Redis 存储等。以下是一个使用 Cookie 存储的示例：</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/gin-contrib/sessions"</span>
    <span class="token string">"github.com/gin-contrib/sessions/cookie"</span>
    <span class="token string">"github.com/gin-gonic/gin"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 设置 Session 中间件</span>
    store <span class="token operator">:=</span> cookie<span class="token punctuation">.</span><span class="token function">NewStore</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>sessions<span class="token punctuation">.</span><span class="token function">Sessions</span><span class="token punctuation">(</span><span class="token string">"mysession"</span><span class="token punctuation">,</span> store<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 设置路由</span>
    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/set"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        session <span class="token operator">:=</span> sessions<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        session<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"johndoe"</span><span class="token punctuation">)</span>
        session<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Session saved"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/get"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        session <span class="token operator">:=</span> sessions<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        username <span class="token operator">:=</span> session<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的示例中，我们首先创建了一个 Cookie 存储引擎，并将其作为 Session 中间件添加到 Gin 中。然后，我们定义了两个路由，一个用于设置 Session，另一个用于获取 Session。</p> 
<p>在设置 Session 的路由中，我们使用 sessions.Default© 获取当前请求的 Session 对象，并使用 session.Set() 方法设置一个键值对。</p> 
<p>在获取 Session 的路由中，我们同样使用 sessions.Default© 获取当前请求的 Session 对象，并使用 session.Get() 方法获取之前设置的键值对。</p> 
<p>需要注意的是，Session 中间件需要在路由之前添加，这样才能在路由中使用 Session。</p> 
<p>另外，Session 存储引擎中的 secret 参数应该是一个随机字符串，用于加密 Session 数据。</p> 
<h4><a id="token_1303"></a>token相关</h4> 
<p>通常为了分布式和安全性，我们会采取更好的方式，比如使用Token 认证，来实现跨域访问，避免 CSRF 攻击，还能在多个服务间共享。</p> 
<p>Token 是一种用于身份验证和授权的机制，通常用于保护 Web 应用程序中的敏感资源。</p> 
<p>在 Gin 中，可以使用 JWT（JSON Web Token）作为 Token 机制。</p> 
<p>使用 Gin 和 JWT 实现 Token 鉴权的步骤如下：</p> 
<ol><li>在用户登录成功后，生成一个 JWT Token，并将其返回给客户端。</li><li>客户端在每次请求中将 Token 作为请求头发送给服务器。</li><li>服务器在接收到请求后，解析 Token，验证其有效性和正确性。</li><li>如果 Token 有效，则允许用户访问相应的资源；否则，返回错误信息。</li></ol> 
<p>在 Gin 中，可以使用第三方库如 jwt-go 来实现 JWT 的生成和解析。具体实现方式可以参考以下代码：</p> 
<pre><code class="prism language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/gin-gonic/gin"</span>
    <span class="token string">"github.com/dgrijalva/jwt-go"</span>
<span class="token punctuation">)</span>

<span class="token comment">// 生成 JWT Token</span>
<span class="token keyword">func</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>userId <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    token <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>SigningMethodHS256<span class="token punctuation">)</span>
    claims <span class="token operator">:=</span> token<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>MapClaims<span class="token punctuation">)</span>
    claims<span class="token punctuation">[</span><span class="token string">"userId"</span><span class="token punctuation">]</span> <span class="token operator">=</span> userId
    tokenString<span class="token punctuation">,</span> err <span class="token operator">:=</span> token<span class="token punctuation">.</span><span class="token function">SignedString</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> tokenString<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 鉴权中间件</span>
<span class="token keyword">func</span> <span class="token function">authMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tokenString <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> tokenString <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
            c<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        token<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>tokenString<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>token <span class="token operator">*</span>jwt<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> token<span class="token punctuation">.</span>Method<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>jwt<span class="token punctuation">.</span>SigningMethodHMAC<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Unexpected signing method: %v"</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">"alg"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"secret"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            c<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> claims<span class="token punctuation">,</span> ok <span class="token operator">:=</span> token<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>MapClaims<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span>Valid <span class="token punctuation">{<!-- --></span>
            userId <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>claims<span class="token punctuation">[</span><span class="token string">"userId"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
            c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            c<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Unauthorized"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 示例路由</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 登录路由</span>
    r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 模拟登录成功</span>
        userId <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>
        token<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">generateToken</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            c<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Internal Server Error"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"token"</span><span class="token punctuation">:</span> token<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 需要鉴权的路由</span>
    r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/protected"</span><span class="token punctuation">,</span> <span class="token function">authMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userId <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">MustGet</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span><span class="token string">"userId"</span><span class="token punctuation">:</span> userId<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的示例中，我们定义了一个生成 JWT Token 的函数 generateToken 和一个鉴权中间件 authMiddleware。</p> 
<p>在登录成功后，我们将生成的 Token 返回给客户端。</p> 
<p>在需要鉴权的路由中，我们使用 authMiddleware 作为中间件来验证 Token 的有效性:</p> 
<ul><li>如果 Token 有效，则将用户的 userId 存储到上下文中</li><li>否则返回错误信息。</li></ul> 
<h3><a id="Gin_1402"></a>Gin中间件</h3> 
<p>gin<code>中间件</code>，类似spring mvc 的拦截器 、过滤器。</p> 
<p>gin<code>中间件</code>作用就是在处理具体的route请求时，提前做一些业务，还可以在业务执行完后执行一些操作。比如身份校验、日志打印等操作。</p> 
<p>中间件分为：<strong>全局中间件</strong> 和 <strong>路由中间件</strong>，区别在于前者会作用于所有路由。</p> 
<blockquote> 
 <p>其实使用<code>router := gin.Default()</code>定义route时，默认带了<code>Logger()</code>和<code>Recovery()</code>。</p> 
</blockquote> 
<p>看看 gin.Default() 源码就了解了：</p> 
<pre><code class="prism language-go"><span class="token comment">// Default returns an Engine instance with the Logger and Recovery middleware already attached.</span>
<span class="token keyword">func</span> <span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Engine <span class="token punctuation">{<!-- --></span>
	<span class="token function">debugPrintWARNINGDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	engine <span class="token operator">:=</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	engine<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Recovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> engine
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Gin_1426"></a>默认Gin中间件</h4> 
<p>Gin本身也提供了一些中间件给我们使用：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">BasicAuth</span><span class="token punctuation">(</span>accounts Accounts<span class="token punctuation">)</span> HandlerFunc <span class="token comment">// 身份认证</span>
<span class="token keyword">func</span> <span class="token function">BasicAuthForRealm</span><span class="token punctuation">(</span>accounts Accounts<span class="token punctuation">,</span> realm <span class="token builtin">string</span><span class="token punctuation">)</span> HandlerFunc
<span class="token keyword">func</span> <span class="token function">Bind</span><span class="token punctuation">(</span>val <span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> HandlerFunc <span class="token comment">//拦截请求参数并进行绑定</span>
<span class="token keyword">func</span> <span class="token function">ErrorLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> HandlerFunc       <span class="token comment">//错误日志处理</span>
<span class="token keyword">func</span> <span class="token function">ErrorLoggerT</span><span class="token punctuation">(</span>typ ErrorType<span class="token punctuation">)</span> HandlerFunc <span class="token comment">//自定义类型的错误日志处理</span>
<span class="token keyword">func</span> <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> HandlerFunc <span class="token comment">//日志记录</span>
<span class="token keyword">func</span> <span class="token function">LoggerWithConfig</span><span class="token punctuation">(</span>conf LoggerConfig<span class="token punctuation">)</span> HandlerFunc
<span class="token keyword">func</span> <span class="token function">LoggerWithFormatter</span><span class="token punctuation">(</span>f LogFormatter<span class="token punctuation">)</span> HandlerFunc
<span class="token keyword">func</span> <span class="token function">LoggerWithWriter</span><span class="token punctuation">(</span>out io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> notlogged <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> HandlerFunc
<span class="token keyword">func</span> <span class="token function">Recovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> HandlerFunc
<span class="token keyword">func</span> <span class="token function">RecoveryWithWriter</span><span class="token punctuation">(</span>out io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> HandlerFunc
<span class="token keyword">func</span> <span class="token function">WrapF</span><span class="token punctuation">(</span>f http<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">)</span> HandlerFunc <span class="token comment">//将http.HandlerFunc包装成中间件</span>
<span class="token keyword">func</span> <span class="token function">WrapH</span><span class="token punctuation">(</span>h http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> HandlerFunc <span class="token comment">//将http.Handler包装成中间件</span>
</code></pre> 
<h4><a id="Gin_1446"></a>自定义Gin中间件</h4> 
<p>自定义中间件的方式很简单，我们只需要实现一个函数，返回<code>gin.HandlerFunc</code>类型的参数即可：</p> 
<pre><code class="prism language-go"><span class="token comment">// HandlerFunc 本质就是一个函数，入参为 *gin.Context</span>
<span class="token comment">// HandlerFunc defines the handler used by gin middleware as return value.</span>
<span class="token keyword">type</span> HandlerFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>Context<span class="token punctuation">)</span>
</code></pre> 
<p>自定义Gin中间件 用于检查token ,示例代码：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">TokenRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">var</span> token <span class="token builtin">string</span>
		<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Header <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> k <span class="token operator">==</span> <span class="token string">"x-token"</span> <span class="token punctuation">{<!-- --></span>
				token <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">,</span> token<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> token <span class="token operator">!=</span> <span class="token string">"test"</span> <span class="token punctuation">{<!-- --></span>
			c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
				<span class="token string">"msg"</span><span class="token punctuation">:</span> <span class="token string">"login failed"</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
			c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">TokenRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/ping"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{<!-- --></span>
			<span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"pong"</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1490"></a>中间件控制的方法</h4> 
<p>在 Gin 框架中，中间件的顺序非常重要，因为它们按照添加的顺序依次执行。如果您希望中间件以特定的顺序执行，可以使用 Gin 框架提供的 Use() 方法来添加中间件。例如，如果您希望在日志中记录请求之前先执行身份验证中间件，则应该先添加身份验证中间件，然后再添加日志中间件，如下所示：</p> 
<pre><code class="prism language-go">router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 添加身份验证中间件</span>
router<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>authMiddleware<span class="token punctuation">)</span>

<span class="token comment">// 添加日志中间件</span>
router<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>loggerMiddleware<span class="token punctuation">)</span>

<span class="token comment">// 添加路由处理函数</span>
router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span>
</code></pre> 
<p>在这个例子中，authMiddleware 会在 loggerMiddleware 之前执行，因为它先被添加到 Gin 的中间件处理链中。</p> 
<p>另外，gin提供了两个函数<code>Abort()</code>和<code>Next()</code>，二者区别在于：</p> 
<blockquote> 
 <ol><li>next()函数会跳过当前中间件中next()后的逻辑，当<strong>下一个中间件执行完成后</strong>再执行剩余的逻辑</li><li>abort()函数执行终止当前中间件以后的中间件执行，<strong>但是会执行当前中间件的后续逻辑</strong></li></ol> 
</blockquote> 
<p>举例子更好理解：我们注册中间件顺序为<code>m1</code>、<code>m2</code>、<code>m3</code>，如果采用<code>next()</code> 执行顺序就是</p> 
<blockquote> 
 <ol><li><code>m1的next()前面</code>、<code>m2的next()前面</code>、<code>m3的next()前面</code>、</li><li><code>业务逻辑</code></li><li><code>m3的next()后续</code>、<code>m2的next()后续</code>、<code>m1的next()后续</code>。</li></ol> 
</blockquote> 
<p>那如果<code>m2</code>中间调用了<code>Abort()</code>，则<code>m3</code>和<code>业务逻辑</code>不会执行，只会执行<code>m2的next()后续</code>、<code>m1的next()后续</code>。</p> 
<p>40岁老架构师尼恩提示：</p> 
<blockquote> 
 <p>这个流程，和java的过滤器责任链模式，何其一致</p> 
</blockquote> 
<h4><a id="_1530"></a>局部中间件</h4> 
<p>Gin 框架中有两种类型的中间件：</p> 
<ul><li>全局中间件</li><li>局部中间件。</li></ul> 
<p>全局中间件是在 Gin 实例创建时添加的，它们将应用于所有的路由请求。</p> 
<p>全局中间件可以通过 <code>Use()</code> 方法添加到 Gin 实例中，例如：</p> 
<pre><code class="prism language-go">router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>在上面的代码中，<code>Logger()</code> 函数是一个全局中间件，它将在所有请求之前打印请求的信息。</p> 
<p>局部中间件只会应用于某些路由请求。</p> 
<ul><li>可以在路由设置的时候，设置局部中间件</li><li>可以使用 <code>Group</code> 方法创建一个路由组，然后在这个路由组上设置局部中间件</li></ul> 
<p>在路由设置的时候，设置局部中间件：</p> 
<pre><code class="prism language-go">router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 添加全局中间件</span>
router<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 通过 Handle()添加局部中间件</span>
router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/posts"</span><span class="token punctuation">,</span> <span class="token function">Auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GetPosts<span class="token punctuation">)</span>
</code></pre> 
<p>在上面的代码中，<code>Auth()</code> 函数是一个局部中间件，它只会在 <code>/posts</code> 路由请求中应用。</p> 
<p>在 Gin 中，可以使用 <code>Group</code> 方法创建一个路由组，然后在这个路由组上设置局部中间件。</p> 
<p>例如，以下代码创建了一个路由组 <code>/api</code>，并在这个路由组上设置了一个局部中间件 <code>authMiddleware</code>：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">authMiddleware</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查用户是否已经登录</span>
    <span class="token comment">// 如果用户已经登录，则继续处理请求</span>
    <span class="token comment">// 如果用户未登录，则返回 401 Unauthorized 错误</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    api <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/api"</span><span class="token punctuation">)</span>
    api<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>authMiddleware<span class="token punctuation">)</span>

    api<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 处理 GET /api/users 请求</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    api<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 处理 POST /api/users 请求</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的代码中，<code>authMiddleware</code> 函数是一个中间件函数，用于检查用户是否已经登录。<code>api</code> 是一个路由组，表示所有以 <code>/api</code> 开头的请求都会进入这个路由组。<code>api.Use(authMiddleware)</code> 表示在这个路由组上使用 <code>authMiddleware</code> 中间件。</p> 
<p>这样，所有以 <code>/api</code> 开头的请求都会先进入 <code>authMiddleware</code> 中间件函数进行身份验证，如果身份验证通过，则继续处理请求，否则返回 401 Unauthorized 错误。</p> 
<h3><a id="Ginhttprouter_1606"></a>Gin的路由框架：httprouter框架</h3> 
<p>Gin比Martini的效率高好多,</p> 
<p>究其原因是：因为Gin使用了httprouter这个路由框架, httprouter的git地址是: <a href="https://github.com/julienschmidt/httprouter">httprouter源码</a>.</p> 
<p>httprouter其实就是使用了一个radix tree(前缀树)来管理请求的URL,</p> 
<h4><a id="radix_tree_1614"></a>前缀树和基数树（radix tree）的区别：</h4> 
<p>trie又叫前缀树，是一个多叉树，广泛应用于字符串搜索，每个树节点存储一个字符，从根节点到任意一个叶子结点串起来就是一个字符串；radix tree是优化之后的前缀树，对空间进一步压缩。</p> 
<p>下图左侧是字符串 sex,seed,sleep,son 四个字段串的Trie数据结构表示. 可用看到sleep这个字符串需要5个节点表示. 其实e后面只跟一个p, 也就是只有一个子节点, 是完全可以和父节点压缩合并的. 右侧是优化后的数据结构, 节省了空间,同时也提高了查询效率(左边字符串sleep查询需要5步, 右边只需要3步), 这就是radix tree.</p> 
<p><img src="https://images2.imgbox.com/37/b6/tFvTfoby_o.png" alt=""></p> 
<h4><a id="gin_1624"></a>gin框架路由原理</h4> 
<p>httprouter是一个高性能路由分发器，它负责将不同方法的多个路径分别注册到各个handle函数，当收到请求时，负责快速查找请求的路径是否有相对应的处理函数，并且进行下一步业务逻辑处理。golang的gin框架采用了httprouter进行路由匹配，httprouter 是通过radix tree来进行高效的路径查找；同时路径还支持两种通配符匹配。</p> 
<p>httprouter会对每种http方法（post、get等）都会生成一棵基数树，其中树节点node结构如下：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> nodestruct <span class="token punctuation">{<!-- --></span>
    path    <span class="token builtin">string</span>     <span class="token comment">//该节点对应的path</span>
    indices   <span class="token builtin">string</span>  <span class="token comment">//子节点path的第一个byte的集合</span>
    wildChild   <span class="token builtin">bool</span>   <span class="token comment">//是否通配符</span>
    nType    nodeType <span class="token comment">//节点类型</span>
    priority   <span class="token builtin">uint32</span>  
    children  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node  <span class="token comment">//子节点</span>
    handlers  HandlersChain   <span class="token comment">//handle如果不为nil，则说明是一个路径字符串的终点!!!</span>
    fullPath   <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> nodeType   <span class="token builtin">uint8</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
  static nodeType <span class="token operator">=</span><span class="token boolean">iota</span> <span class="token comment">// default  普通节点</span>
  root  <span class="token comment">//根节点</span>
  param <span class="token comment">//参数节点 /user/{id}，id 就是一个参数节点</span>
  catchAll <span class="token comment">//通配符</span>
<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="gin_1654"></a>gin注册路由过程：</h4> 
<p>如下左边是/sex,/sleep,/son的内部呈现, 右边是插入/seed 后内部的呈现:</p> 
<p><img src="https://images2.imgbox.com/28/5a/UAucANp9_o.png" alt=""></p> 
<p>gin路由</p> 
<p>简单的来说每一个注册的 url 都会通过 / 切分为 n 个树节点（httprouter 会有一些区别，会存在根分裂），然后挂到相应 method 树上去，所以业务中有几种不同的 method 接口，就会产生对应的前缀树。</p> 
<p>在 httprouter 中，节点被分为 4 种类型：</p> 
<ul><li>static - 静态节点，/user /api 这种</li><li>root - 根结点</li><li>param - 参数节点 /user/{id}，id 就是一个参数节点</li><li>catchAll - 通配符</li></ul> 
<p>其实整个匹配的过程也比较简单，通过对应的 method 拿到前缀树，然后开始进行一个广度优先的匹配。</p> 
<p>这里值得学习的一点是，httprouter 对下级节点的查找进行了优化，简单来说就是把当前节点的下级节点的首字母维护在本身，匹配时先进行索引的查找。</p> 
<p><img src="https://images2.imgbox.com/3c/43/Qjao0N7g_o.png" alt=""></p> 
<p><strong>注意：</strong></p> 
<p>gin中相同http方法的路由树中，参数结点和静态结点是冲突的，也就是:</p> 
<p>get 方法，如果存在了 /user/:name这样的路径，就不能再添加/user/getName这样的静态路径，否则会报冲突；</p> 
<h3><a id="_1691"></a>微服务统一配置管理</h3> 
<p>在应用程序的运行生命周期中，最直接的关系之一就是应用的配置读取和更新。</p> 
<h4><a id="_1695"></a>为什么需要分布式配置中心</h4> 
<p>分布式配置中心的优势在于它可以将多个模块系统的各配置文件，全部配置在配置中心统一管理，无需重启服务器即可动态刷新加载配置信息。</p> 
<p>此外，分布式配置中心还可以实现不同环境配置隔离(开发、测试、预发布、灰度/线上),高性能、高可用性，请求量多、高并发等特性。</p> 
<h4><a id="_1703"></a>分布式配置中心技术选型</h4> 
<ul><li><strong>目前主流的分布式配置中心</strong>：spring cloud config、apollo和nacos；spring cloud config属于java的spring体系，我们就考虑apollo和nacos</li><li>apollo和nacos：apollo是携程开源、nacos是阿里开源 
  <ul><li>a、apollo大而全，功能完善；nacos小而全，可以对比成django和flask的区别</li><li>b、部署nacos更加简单</li><li>c、nacos不止支持配置中心还支持服务注册和发现</li><li>d、都支持各种语言，不过apollo是第三方支持的，nacos是官方支持各种语言</li></ul> </li><li><strong>nacos官网</strong>：https://nacos.io/zh-cn/</li><li><strong>apollo的git地址</strong>：https://github.com/apolloconfig/apollo</li><li><strong>apollo和nacos功能对比</strong></li></ul> 
<table><thead><tr><th>功能点</th><th>apollo</th><th>nacos</th></tr></thead><tbody><tr><td>开源时间</td><td>2016.5</td><td>2018.6</td></tr><tr><td>配置实时推送</td><td>支持(http长轮询)</td><td>支持(http长轮询)</td></tr><tr><td>配置回滚</td><td>支持</td><td>支持</td></tr><tr><td>灰度发布</td><td>支持</td><td>待支持</td></tr><tr><td>权限管理</td><td>支持</td><td>支持</td></tr><tr><td>多集群</td><td>支持</td><td>支持</td></tr><tr><td>监听查询</td><td>支持</td><td>支持</td></tr><tr><td>多语言</td><td>主流语言</td><td>主流语言（官方支持）</td></tr><tr><td>通讯协议</td><td>http</td><td>http</td></tr></tbody></table> 
<h5><a id="Spring_Cloud_Nacos_1729"></a>Spring Cloud Nacos</h5> 
<p><strong>优点</strong>：</p> 
<p>1）开箱即用，适用于dubbo，spring cloud等</p> 
<p>2）AP模型，数据最终一致性</p> 
<p>3）注册中心，配置中心二合一(二合一也不一定是优点)，提供控制台管理</p> 
<p>4）纯国产，各种有中文文档，久经双十一考验</p> 
<p><strong>缺点</strong>：</p> 
<p>1）刚刚开源不久，社区热度不够，依然存在bug</p> 
<h5><a id="Spring_Cloud_Eureka_1745"></a>Spring Cloud Eureka：</h5> 
<p><strong>优点</strong>：</p> 
<p>1）Spring Cloud 官方推荐</p> 
<p>2）AP模型，数据最终一致性</p> 
<p>3）开箱即用，具有控制台管理</p> 
<p><strong>缺点</strong>：</p> 
<p>1）客户端注册服务上报所有信息，节点多的情况下，网络，服务端压力过大，且浪费内存</p> 
<p>2）客户端更新服务信息通过简单的轮询机制，当服务数量巨大时，服务器压力过大。</p> 
<p>3）集群伸缩性不强，服务端集群通过广播式的复制，增加服务器压力</p> 
<p>4）Eureka2.0 闭源（Spring Cloud最新版本还是使用的1.X版本的Eureka）</p> 
<h4><a id="golangviper_1767"></a>golang的土著配置组件viper</h4> 
<p>除了分布式微服务的配置中心nacos、eureka这些。</p> 
<p>golang中，也自己的土著配置中心 viper ，这个使用评率很高。</p> 
<p>可以说，viper 是golang的土著配置组件中，使用率非常高的一个。</p> 
<p>viper 结合 consul等组件，也能具备分布式配置管理能力。</p> 
<h3><a id="_viper_1779"></a>通过 viper实现统一配置管理功能</h3> 
<h4><a id="1viper_1783"></a>1、viper的介绍</h4> 
<p>viper是go一个强大的流行的配置解决方案的库。有大量项目都使用该库，比如hugo, docker等。</p> 
<p>Viper 是一个完整的 Go 应用程序配置解决方案，优势就在于开发项目中你不必去操心配置文件的格式而是让你腾出手来专注于项目的开发。</p> 
<p>viper 其特性如下：</p> 
<ul><li>支持 JSON/TOML/YAML/HCL/envfile/Java properties 等多种格式的配置文件；</li><li>可以设置监听配置文件的修改，修改时自动加载新的配置；</li><li>从环境变量、命令行选项和io.Reader中读取配置；</li><li>从远程配置系统中读取和监听修改，如 etcd/Consul；</li><li>代码逻辑中显示设置键值</li></ul> 
<p><strong>注：Viper让需要重启服务器才能使配置生效的日子一去不复返</strong>！！！这才是VIper最大的魅力</p> 
<p>它基本上可以处理所有类型的配置需求和格式, viper支持功能</p> 
<ul><li>设置默认配置</li><li>支持各种配置文件，如JSON，TOML, YAML, HCL, envfile和Java属性配置文件</li><li>支持监听文件变化以及重新读取配置</li><li>支持从环境变量读取配置</li><li>支持从远程配置系统(etcd或Consul)读取配置，并能监听远程配置修改</li><li>支持从命令行标志Flag读取配置，比如搭配cobra使用</li><li>支持读取缓冲区数据</li></ul> 
<p>Viper主要为我们做以下工作:</p> 
<ul><li>查找、加载和解组JSON、TOML、YAML、HCL、INI、envfile或Java属性格式的配置文件。</li><li>提供一种机制来为不同的配置选项设置默认值。</li><li>提供一种机制来为通过命令行标志指定的选项设置覆盖值。</li><li>提供别名系统，以便在不破坏现有代码的情况下轻松重命名参数。</li><li>当用户提供了与默认值相同的命令行或配置文件时，很容易区分它们。</li></ul> 
<h4><a id="2viper_1821"></a>2、viper的安装和使用</h4> 
<p>viepr的安装很简单，直接再工程中使用go get命令安装即可</p> 
<pre><code class="prism language-bash">$ go get github.com/spf13/viper
</code></pre> 
<h5><a id="21__Viper_1833"></a>2.1 Viper对象的创建</h5> 
<p>使用<code>viper.New()</code>函数创建一个Viper Struct，如：</p> 
<pre><code class="prism language-go">viper <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>Viper的是viper库的主要实现对象, viper提供了下面的方法可以获取Viper实例：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">GetViper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Viper
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Viper
<span class="token keyword">func</span> <span class="token function">NewWithOptions</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token operator">*</span>Viper
<span class="token keyword">func</span> <span class="token function">Sub</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Viper
</code></pre> 
<p>使用<code>viper.GetViper()</code>获取的为全局的Viper实例对象，默认使用viper包使用也是该全局Viper实例。</p> 
<p>查看viper的源码，可以看到viper默认提供了一个全局的Viper实例：</p> 
<pre><code class="prism language-go"><span class="token keyword">var</span> v <span class="token operator">*</span>Viper
 
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	v <span class="token operator">=</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// New returns an initialized Viper instance.</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Viper <span class="token punctuation">{<!-- --></span>
	v <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Viper<span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>keyDelim <span class="token operator">=</span> <span class="token string">"."</span>
	v<span class="token punctuation">.</span>configName <span class="token operator">=</span> <span class="token string">"config"</span>
	v<span class="token punctuation">.</span>configPermissions <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">FileMode</span><span class="token punctuation">(</span><span class="token number">0o644</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>fs <span class="token operator">=</span> afero<span class="token punctuation">.</span><span class="token function">NewOsFs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>override <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>defaults <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>kvstore <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>pflags <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>FlagValue<span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>env <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>aliases <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span>typeByDefValue <span class="token operator">=</span> <span class="token boolean">false</span>
	v<span class="token punctuation">.</span>logger <span class="token operator">=</span> jwwLogger<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
 
	v<span class="token punctuation">.</span><span class="token function">resetEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
	<span class="token keyword">return</span> v
<span class="token punctuation">}</span>
</code></pre> 
<p>New和NewWithOptions为我们提供了创建实例的方法</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">New1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>viper<span class="token punctuation">.</span>Viper <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">func</span> <span class="token function">New2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>viper<span class="token punctuation">.</span>Viper <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> viper<span class="token punctuation">.</span><span class="token function">NewWithOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Sub为我们读取子配置项提供了一个新的实例Viper</p> 
<pre><code class="prism language-go">v <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"db"</span><span class="token punctuation">)</span>
url <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"mysql url:%s\n"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="22__1904"></a>2.2 预设一些默认配置</h5> 
<p>通过SetDefault 防范，可以 配置默认值</p> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"key1"</span><span class="token punctuation">,</span><span class="token string">"value1"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"key2"</span><span class="token punctuation">,</span><span class="token string">"value2"</span><span class="token punctuation">)</span>


viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"ContentDir"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"Taxonomies"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"tag"</span><span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token punctuation">,</span> <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"categories"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
 
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"redis.port"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"mysql.url"</span><span class="token punctuation">,</span> <span class="token string">"root:root@tcp(127.0.0.1:3306)/stock?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="23_key_1924"></a>2.3 key大小写问题</h5> 
<p>viper的配置的key值是不区分大小写，如：</p> 
<pre><code class="prism language-go"># 小写的key
viper<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"this is a test value"</span><span class="token punctuation">)</span>
# 大写的key，也可以读到值
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"TEST"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//输出"this is a test value"</span>
</code></pre> 
<h5><a id="24__1939"></a>2.4 从配置文件读取</h5> 
<p>直接指定文件路径</p> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">"./config.yaml"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>多路径查找</p> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">)</span>     <span class="token comment">// 配置文件名，不需要后缀名</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yml"</span><span class="token punctuation">)</span>            <span class="token comment">// 配置文件格式</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"/etc/appname/"</span><span class="token punctuation">)</span>  <span class="token comment">// 查找配置文件的路径</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"$HOME/.appname"</span><span class="token punctuation">)</span> <span class="token comment">// 查找配置文件的路径</span>
viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>              <span class="token comment">// 查找配置文件的路径</span>
err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment">// 查找并读取配置文件</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>                       <span class="token comment">// 处理错误</span>
    <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fatal error config file: %w n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>读取配置文件时，可能会出现错误，如果我们想判断是否是因为找不到文件而报错的，可以判断err是否为<code>ConfigFileNotFoundError</code>。</p> 
<pre><code class="prism language-go"><span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span>ConfigFileNotFoundError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{<!-- --></span>
		
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面我们看一下操作实例， 先看我们的配置文件app.yml文件：</p> 
<pre><code class="prism language-bash">app:
  name: viper-test
  mode: dev
 
db:
  mysql:
    url: <span class="token string">"root:root@tcp(127.0.0.1:3306)/stock?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span>
  redis:
    host: <span class="token number">127.0</span>.0.1
    port:  <span class="token number">6067</span>
    db: <span class="token number">0</span>
    passwd: <span class="token number">123456</span>
</code></pre> 
<p>初始化配置</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">InitConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>viper<span class="token punctuation">.</span>Viper<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  v <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  v<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>					<span class="token comment">// 添加配置文件搜索路径，点号为当前目录</span>
  v<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"./configs"</span><span class="token punctuation">)</span>		<span class="token comment">// 添加多个搜索目录</span>
  v<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yaml"</span><span class="token punctuation">)</span>				<span class="token comment">// 如果配置文件没有后缀，可以不用配置</span>
  v<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">"app.yml"</span><span class="token punctuation">)</span>			<span class="token comment">// 文件名，没有后缀</span>
	
    <span class="token comment">// v.SetConfigFile("configs/app.yml")</span>
  
  <span class="token comment">// 读取配置文件</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"use config file -&gt; %s\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">ConfigFileUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span>err
	<span class="token punctuation">}</span>
  <span class="token keyword">return</span> v<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先这里我们添加一个配置文件搜索路径，点号表示当前路径，搜索路径可以添加多个然后设置了配置文件类型，这里我们设置文件类型为yaml，</p> 
<p>接着我们设置了配置文件名称，这个文件可以从配置的搜索路径从查找。</p> 
<p>最后我们通过提供的<code>ReadInConfig()</code>函数读取配置文件</p> 
<p>读取配置文件</p> 
<pre><code class="prism language-go"><span class="token comment">// 通过.号来区分不同层级，来获取配置值</span>
log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"app.mode=%s\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"app.mode"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"db.mysql.url=%s\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"db.mysql.url"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"db.redis.host=%s\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"db.redis.host"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"db.redis.port=%d\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">"db.redis.port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
<span class="token comment">// 使用Sub获取子配置，然后获取配置值</span>
v2 <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"db"</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"db.mysql.url:%s\n"</span><span class="token punctuation">,</span> v2<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"db.redis.host:%s\n"</span><span class="token punctuation">,</span> v2<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"redis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"db.redis.port:%s\n"</span><span class="token punctuation">,</span> v2<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"redis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>viper还提供了如下获取类型获取配置项值：</p> 
<p><img src="https://images2.imgbox.com/6d/f6/IxJiDEUs_o.png" alt=""></p> 
<p><strong>注： 其中重要的一个函数IsSet可以用来判断某个key是否被设置</strong></p> 
<h5><a id="25__2048"></a>2.5 支持哪些文件格式</h5> 
<p>我们一直在说，viper支持多种不同格式的配置文件，到底是哪些格式呢？如下：</p> 
<ul><li>json</li><li>toml</li><li>yaml</li><li>yml</li><li>properties</li><li>props</li><li>prop</li><li>hcl</li><li>tfvars</li><li>dotenv</li><li>env</li><li>ini</li></ul> 
<h4><a id="3_2065"></a>3、写配置文件</h4> 
<p>除了读取配置文件外，viper也支持将配置值写入配置文件，viper提供了四个函数，用于将配置写回文件。四个函数如下：</p> 
<ul><li>WriteConfig</li></ul> 
<p>WriteConfig函数会将配置写入预先设置好路径的配置文件中，如果配置文件存在，则覆盖，如果没有，则创建。</p> 
<ul><li>SafeWriteConfig</li></ul> 
<p>SafeWriterConfig与WriteConfig函数唯一的不同是如果配置文件存在，则会返回一个错误。</p> 
<ul><li>WriteConfigAs</li></ul> 
<p>WriteConfigAs与WriteConfig函数的不同是需要传入配置文件保存路径，viper会根据文件后缀判断写入格式。</p> 
<ul><li>SafeWriteConfigAs</li></ul> 
<p>SafeWriteConfigAs与WriteConfigAs的唯一不同是如果配置文件存在，则返回一个错误。</p> 
<p>使用SafeWriteConfig()和WriteConfig()时，可以先设定SetConfigFile()设定配置文件的路径。</p> 
<p>下面是一个配置写入的示例：</p> 
<pre><code class="prism language-go">v <span class="token operator">:=</span> <span class="token function">New1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
v<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">"./hello.yml"</span><span class="token punctuation">)</span>
 
log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"config path:%+v\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">ConfigFileUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 
v<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"CKeen"</span><span class="token punctuation">)</span>
v<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">,</span> <span class="token string">"ck@gmail.com"</span><span class="token punctuation">)</span>
 
v<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">)</span>
 
v<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"slice"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span><span class="token string">"slice1"</span><span class="token punctuation">,</span><span class="token string">"slice2"</span><span class="token punctuation">,</span><span class="token string">"slice3"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
 
v<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"test.web"</span><span class="token punctuation">,</span> <span class="token string">"https://ckeen.cn"</span><span class="token punctuation">)</span>
 
v<span class="token punctuation">.</span><span class="token function">WriteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
<span class="token comment">//v.WriteConfigAs("./hello.yml")</span>
</code></pre> 
<p>如果使用<code>SafeWriteConfigAs()</code>或者<code>WriteConfigAs()</code>方法，则直接传入配置文件路径即可。</p> 
<h4><a id="4_2117"></a>4、从环境变量读取</h4> 
<p>viper支持环境变量的函数：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">AutomaticEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 开启绑定环境变量</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">BindEnv</span><span class="token punctuation">(</span>input <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>		<span class="token comment">// 绑定系统中某个环境变量</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">SetEnvKeyReplacer</span><span class="token punctuation">(</span>r <span class="token operator">*</span>strings<span class="token punctuation">.</span>Replacer<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">SetEnvPrefix</span><span class="token punctuation">(</span>in <span class="token builtin">string</span><span class="token punctuation">)</span>
</code></pre> 
<p>要让viper读取环境变量，有两种方式：</p> 
<ul><li>方式一：调用AutomaticEnv函数，开启环境变量读取</li></ul> 
<pre><code class="prism language-go">fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//开始读取环境变量，如果没有调用这个函数，则下面无法读取到path的值</span>
viper<span class="token punctuation">.</span><span class="token function">AutomaticEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//会从环境变量读取到该值，注意不用区分大小写</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>方式二：使用BindEnv绑定某个环境变量</li></ul> 
<pre><code class="prism language-go"><span class="token comment">//将p绑定到环境变量PATH,注意这里第二个参数是环境变量，这里是区分大小写的</span>
viper<span class="token punctuation">.</span><span class="token function">BindEnv</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"PATH"</span><span class="token punctuation">)</span>
<span class="token comment">//错误绑定方式，path为小写，无法读取到PATH的值</span>
<span class="token comment">//viper.BindEnv("p","path")</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//通过p可以读取PATH的值</span>
</code></pre> 
<p>使用函数SetEnvPrefix可以为所有环境变量设置一个前缀，这个前缀会影响<code>AutomaticEnv</code>和<code>BindEnv</code>函数</p> 
<pre><code class="prism language-go">os<span class="token punctuation">.</span><span class="token function">Setenv</span><span class="token punctuation">(</span><span class="token string">"TEST_PATH"</span><span class="token punctuation">,</span><span class="token string">"test"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetEnvPrefix</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">AutomaticEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//无法读取path的值，因为此时加上前缀，viper会去读取TEST_PATH这个环境变量的值</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//输出:nil</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"test_path"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//输出：test</span>
</code></pre> 
<p>环境变量大多是使用下划号(_)作为分隔符的，如果想替换，可以使用<code>SetEnvKeyReplacer</code>函数，如：</p> 
<pre><code class="prism language-go"><span class="token comment">//设置一个环境变量</span>
os<span class="token punctuation">.</span><span class="token function">Setenv</span><span class="token punctuation">(</span><span class="token string">"USER_NAME"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span>
<span class="token comment">//将下线号替换为-和.</span>
viper<span class="token punctuation">.</span><span class="token function">SetEnvKeyReplacer</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">NewReplacer</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//读取环境变量</span>
viper<span class="token punctuation">.</span><span class="token function">AutomaticEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"user.name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//通过.访问</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"user-name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//通过-访问</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"user_name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//原来的下划线也可以访问</span>
</code></pre> 
<p>默认的情况下，如果读取到的环境变量值为空(注意，不是环境变量不存在，而是其值为空)，会继续向优化级更低数据源去查找配置，如果想阻止这一行为，让空的环境变量值有效，则可以调用<code>AllowEmptyEnv</code>函数：</p> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span>
<span class="token comment">//默认是AllowEmptyEnv(false)，这里设置为true</span>
viper<span class="token punctuation">.</span><span class="token function">AllowEmptyEnv</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">BindEnv</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span><span class="token function">Setenv</span><span class="token punctuation">(</span><span class="token string">"USERNAME"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//输出为空，因为环境变量USERNAME空</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//输出：123456</span>
</code></pre> 
<h4><a id="5Flags_2188"></a>5、从命令行工具的选项参数Flags读取</h4> 
<p>viper主要提供了以下四个方法，可以绑定行参数的输出的选项值：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">BindFlagValue</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> flag FlagValue<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">BindFlagValues</span><span class="token punctuation">(</span>flags FlagValueSet<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">BindPFlag</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token operator">*</span>pflag<span class="token punctuation">.</span>Flag<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">BindPFlags</span><span class="token punctuation">(</span>flags <span class="token operator">*</span>pflag<span class="token punctuation">.</span>FlagSet<span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre> 
<p>viper可以和解析命令行库相关flag库一起工作，从命令行读取配置，两种方式：</p> 
<ul><li>viper内置了对pflag库的支持</li><li>viper留有接口让我们可以支持扩展其他的flag库</li></ul> 
<h5><a id="viper__pflag__2208"></a>viper + pflag 结合使用</h5> 
<p>pflag 是一个 Go 语言的<strong>命令行参数解析库</strong>，它可以方便地解析命令行参数并将其转换为 Go 语言中的变量。</p> 
<p>相比标准库中的 flag 包，pflag 包提供了更多的功能和选项，例如支持短选项、长选项、默认值、必选参数、可选参数等。</p> 
<p>pflag 包的使用方法和 flag 包类似，但更加灵活和方便。</p> 
<p>你可以使用 <code>go get</code> 命令来安装 pflag 包：</p> 
<pre><code class="prism language-bash">go get github.com/spf13/pflag
</code></pre> 
<p>viper + pflag 结合使用的案例如下：</p> 
<pre><code class="prism language-go">pflag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">,</span> <span class="token string">"server http port"</span><span class="token punctuation">)</span>
pflag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">BindPFlags</span><span class="token punctuation">(</span>pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//输出8080</span>
</code></pre> 
<h5><a id="Go__flag__2231"></a>Go 语言标准库中的 flag 包</h5> 
<p>如果我们没有使用pflag库，但又想让viper帮我们读取命令行参数呢？</p> 
<p>Go 语言标准库中的 flag 包提供了命令行参数解析的功能。</p> 
<p>flag 包 可以方便地解析命令行参数并将其转换为 Go 语言中的变量。</p> 
<p>flag 包支持短选项和长选项，还可以设置默认值和解析必选参数。</p> 
<p>使用 flag 包非常简单，你只需要在程序中定义需要解析的参数，然后调用 flag.Parse() 函数进行解析即可。</p> 
<p>以下是一个示例：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> name <span class="token builtin">string</span>
    <span class="token keyword">var</span> age <span class="token builtin">int</span>
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">,</span> <span class="token string">"a string"</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">IntVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>age<span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"an int"</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Hello, %s! You are %d years old.\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的例子中，我们定义了两个需要解析的参数 name 和 age，分别是字符串类型和整数类型。</p> 
<p>使用 <code>flag.StringVar()</code> 和 <code>flag.IntVar()</code> 函数将参数与变量绑定，并设置默认值和说明信息。</p> 
<p>最后调用 <code>flag.Parse()</code> 函数进行解析，即可获取命令行参数并输出结果。</p> 
<p>如何测试呢？</p> 
<p>测试的方式之一： 通过命令行</p> 
<pre><code class="prism language-bash">go run main.go -name <span class="token operator">=</span>张三  -age<span class="token operator">=</span><span class="token number">30</span>
</code></pre> 
<p>测试的方式之一： 通过goland</p> 
<p><img src="https://images2.imgbox.com/19/e5/xsspwztE_o.png" alt=""></p> 
<p>执行结果：</p> 
<p><img src="https://images2.imgbox.com/50/4d/Y7II4Pzr_o.png" alt=""></p> 
<h5><a id="flag_2295"></a>flag包绑定解析参数有三种定义方式</h5> 
<p><strong>方式一：flag.xxx()</strong></p> 
<p>例如：flag.Int, flag.String, 返回解析变量类型的指针</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    host <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"请输入host地址"</span><span class="token punctuation">)</span>
    port <span class="token operator">:=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">"请输入端口号"</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 解析参数</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s:%d\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token operator">*</span>port<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行: <strong>go run main.go -host=127.0.0.1 -port=3306</strong></p> 
<p>输出：<strong>127.0.0.1:3306</strong></p> 
<p>当然你也可以直接执行go run main.go, 这时候就会使用你的默认值</p> 
<p><strong>方式二： flag.XxxVar()</strong></p> 
<p>在方式一后面多了个Var</p> 
<p>例如：flag.IntVar, flag.StringVar</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>
<span class="token keyword">var</span> host <span class="token builtin">string</span>
<span class="token keyword">var</span> port <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 每个文件会自动执行的函数</span>
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>host<span class="token punctuation">,</span> <span class="token string">"host"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token string">"请输入host地址"</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">IntVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>port<span class="token punctuation">,</span> <span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">"请输入端口号"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 解析参数</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s:%d\n"</span><span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行结果同上</p> 
<p><strong>3.自定义参数解析flag.Var(),</strong></p> 
<p>我们可以看下flag.go源码:</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">Var</span><span class="token punctuation">(</span>value Value<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">,</span> usage <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    CommandLine<span class="token punctuation">.</span><span class="token function">Var</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> name<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用flag.Var函数第一个参数我们需要传入一个Value类型的值，Value是一个接口类型，定义了两个方法，</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Value <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> 
    <span class="token function">Set</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>  <span class="token comment">//Set接口决定了如何解析flag的值</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来我们去实现这两个方法：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token comment">// 自定义类型</span>
<span class="token keyword">type</span> HandsomeBoys <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

<span class="token comment">// 实现String()方法</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HandsomeBoys<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%v"</span><span class="token punctuation">,</span> <span class="token operator">*</span>h<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 实现Set方法,  Set接口决定了如何解析flag的值</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HandsomeBoys<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>h <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>h<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义一个HandsomeBoys类型的变量</span>
<span class="token keyword">var</span> boys HandsomeBoys

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 绑定变量boys</span>
    flag<span class="token punctuation">.</span><span class="token function">Var</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>boys<span class="token punctuation">,</span> <span class="token string">"boys"</span><span class="token punctuation">,</span> <span class="token string">"请输入一组帅气的男孩名称：-boys=彭于晏,吴彦祖"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>boys<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行代码： <strong>go run main.go -boys=彭于晏,吴彦祖</strong></p> 
<h5><a id="viper__flag__2420"></a>viper + flag 结合使用</h5> 
<p>flag 和 viper 都是 Go 语言中常用的命令行参数解析库，它们可以方便地解析命令行参数并将其转换为 Go 语言中的变量。通常情况下，我们可以使用 flag 包来解析命令行参数，而使用 viper 包来解析配置文件。在实际开发中，我们可能会同时使用命令行参数和配置文件来配置程序，这时就可以将 flag 和 viper 结合起来使用。</p> 
<p>下面是一个示例程序，演示了如何使用 flag 和 viper 结合使用：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"flag"</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"github.com/spf13/viper"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 定义命令行参数</span>
    <span class="token keyword">var</span> name <span class="token builtin">string</span>
    <span class="token keyword">var</span> age <span class="token builtin">int</span>
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"a string"</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">IntVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>age<span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"an int"</span><span class="token punctuation">)</span>

    <span class="token comment">// 解析命令行参数</span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 加载配置文件</span>
    viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">)</span> <span class="token comment">// 配置文件名</span>
    viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>      <span class="token comment">// 配置文件路径</span>
    err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error reading config file:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取配置文件中的参数</span>
    viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span>
    viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
    age <span class="token operator">=</span> viper<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span>

    <span class="token comment">// 输出结果</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Hello, %s! You are %d years old.\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在上面的例子中，我们首先定义了命令行参数 name 和 age，并使用 flag 包解析命令行参数。</p> 
<p>然后使用 viper 包加载配置文件，并读取配置文件中的参数。</p> 
<p>注意，我们使用 <code>viper.SetDefault()</code> 函数设置了默认值，以防配置文件中没有定义相应的参数。</p> 
<p>最后输出结果。这样，我们就可以通过命令行参数和配置文件来配置程序了。</p> 
<h4><a id="6keyvalue_2472"></a>6、从远程key/value存储读取</h4> 
<p>在Viper中启用远程支持，需要在代码中匿名导入<code>viper/remote</code>这个包。</p> 
<pre><code class="prism language-go"><span class="token boolean">_</span> <span class="token string">"github.com/spf13/viper/remote"</span>
</code></pre> 
<p>Viper将读取从Key/Value存储中的路径检索到的配置字符串（如<code>JSON</code>、<code>TOML</code>、<code>YAML</code>格式）。</p> 
<p>viper目前支持Consul/Etcd/firestore三种Key/Value的存储系统。</p> 
<p>下面我来演示从etcd读取配置：</p> 
<ul><li>首先我们安装crypt的工具</li></ul> 
<pre><code class="prism language-bash">go get github.com/bketelsen/crypt/bin/crypt
</code></pre> 
<ul><li>使用crypt的命令，将app.yml的文件添加到etcd</li></ul> 
<pre><code class="prism language-bash">crypt <span class="token builtin class-name">set</span> --endpoint<span class="token operator">=</span>http://127.0.0.1:2379 -plaintext /config/app.yml /Users/ckeen/viper/configs/app.yml
        
上面的命令，设置本地的文件，到etcd
crypt <span class="token builtin class-name">set</span> --endpoint<span class="token operator">=</span>etcd 集群地址  -plaintext etcd路径  本地文件
</code></pre> 
<ul><li>添加viper的操作远程资源的配置</li></ul> 
<pre><code class="prism language-bash">_ <span class="token string">"github.com/spf13/viper/remote"</span>
</code></pre> 
<ul><li>实现从远程读取配置</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">InitConfigFromRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>viper<span class="token punctuation">.</span>Viper<span class="token punctuation">,</span><span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    v <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 远程配置</span>
    v<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">"etcd"</span><span class="token punctuation">,</span><span class="token string">"http://127.0.0.1:2379"</span><span class="token punctuation">,</span><span class="token string">"config/app.yml"</span><span class="token punctuation">)</span>
    <span class="token comment">//v.SetConfigType("json")</span>
    v<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">"app.yml"</span><span class="token punctuation">)</span>
    v<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yml"</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"use config file -&gt; %s\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">ConfigFileUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> v<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    v<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">InitConfigFromRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"read remote error:%+v\n"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"remote read app.mode=%+v\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"app.mode"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"remote read db.mysql.url=%+v\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"db.mysql.url"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>测试打印结果<br> <img src="https://images2.imgbox.com/17/0a/m2h1BrNV_o.png" alt=""></li></ul> 
<h4><a id="7_2541"></a>7、监听配置变化</h4> 
<p>viper提供如下两种监听配置的函数，一个是本地的监听和一个远程监听的：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">WatchRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token function">WatchRemoteConfigOnChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre> 
<h5><a id="71___2553"></a>7.1 监听本地配置文件变化</h5> 
<p>我们主要看一下监听本地文件变更的示例</p> 
<pre><code class="prism language-go">v<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">InitConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"viper读取失败, error:%+v\n"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 监听到文件变化后的回调</span>
v<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>e fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Config file changed:"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"db.redis.passwd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
v<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
<span class="token comment">// 阻塞进程退出</span>
time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</code></pre> 
<p>我们使用前面的InitConfig()方法来初始化本地文件读取配置，然后设定了监听函数，最后使用WatchConfig()开启本地文件监听。</p> 
<p>当我们修改本地配置configs/app.yml的db.redis.passwd的值，然后保存后，我们可以看到控制台有打印最新修改后的值，不要我们重新去获取。</p> 
<h5><a id="72___2581"></a>7.2 监听远程配置变化</h5> 
<p>除了能够监听本地的配置变化，viper 支持监听远程配置变化。</p> 
<p>Viper 提供了一个 <code>RemoteConfig</code> 方法，可以用来加载远程配置文件，例如从一个 HTTP 或者 ETCD 等远程配置中心加载配置文件。</p> 
<p>在加载远程配置文件之后，你可以使用 <code>WatchRemoteConfig</code> 方法来监视配置文件的变化，当远程配置文件发生变化时，Viper 会自动重新加载配置文件，并触发相应的回调函数。</p> 
<p>下面是一个示例代码：</p> 
<pre><code class="prism language-go">viper<span class="token punctuation">.</span><span class="token function">AddRemoteProvider</span><span class="token punctuation">(</span><span class="token string">"etcd"</span><span class="token punctuation">,</span> <span class="token string">"http://localhost:2379"</span><span class="token punctuation">,</span> <span class="token string">"/config/app.yaml"</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yaml"</span><span class="token punctuation">)</span>

err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadRemoteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 处理错误</span>
<span class="token punctuation">}</span>

viper<span class="token punctuation">.</span><span class="token function">WatchRemoteConfigOnChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>在这个示例代码中，我们使用了 <code>AddRemoteProvider</code> 方法来添加一个 ETCD 远程配置中心作为 Viper 的配置源，并指定了要加载的配置文件路径。</p> 
<p>然后使用 <code>ReadRemoteConfig</code> 方法来加载远程配置文件。</p> 
<p>最后使用 <code>WatchRemoteConfigOnChannel</code> 方法来监视配置文件的变化，当配置文件发生变化时，Viper 会自动重新加载配置文件，并触发相应的回调函数。</p> 
<h3><a id="_Nacos_2614"></a>通过 Nacos实现统一配置管理功能</h3> 
<h4><a id="SpringCloud__2618"></a>SpringCloud 分布式配置中心选型</h4> 
<p>目前最主流的分布式配置中心主要有</p> 
<ul><li>spring cloud config</li><li>apollo</li><li>nacos</li></ul> 
<p>etcd 和zookeeper ， 也作为配置中心使用，但是没有 nacos 普通。</p> 
<p>一般而言，在spring cloud属于spring体系, 就考虑apollo(携程)和nacos(阿里),都是目前比较流行且维护活跃的2个配置中心;</p> 
<p>a . apollo大而全, 功能完善, nacos小而全;</p> 
<p>b . 部署nacos更加简单;</p> 
<p>c .nacos不止支持配置中心，还支持服务注册和发现;</p> 
<p>d . 都支持各种语言, 不过apollo是第三方支持的,nacos是官方支持各种语言;</p> 
<p>nacos很活跃, 不过看的出来nacos想要构建的生态野心更大, 不过收费意图明显;</p> 
<p><img src="https://images2.imgbox.com/37/28/ykD49AA4_o.png" alt=""></p> 
<p>另外，nacos 属于 SpringCloud alibaba 框架的核心组件。</p> 
<h4><a id="javago____2648"></a>用java+go 多语言 云原生微服务架构中配置中心的 位置</h4> 
<p>上个月尼恩指导 一个6年小伙伴简历，使用java+go 多语言 云原生微服务架构，帮助 6年小伙，收60W年薪</p> 
<p>主要的架构图图如下：</p> 
<p><img src="https://images2.imgbox.com/75/2b/o70ceRJS_o.png" alt=""></p> 
<p>在这个架构中， 用java+go 多语言 云原生微服务架构中的分布式 配置中心 ，是nacos</p> 
<p>而go 中的viper框架，没有对 nacos 提供支持 所以，咱们自己实现，对 nacos 的支持</p> 
<h3><a id="Nacos_2664"></a>Nacos作为配置中心使用</h3> 
<h4><a id="Nacos_2666"></a>为什么使用Nacos</h4> 
<p>“因为现在主流公司已经开始推荐使用nacos了，nacos的两大主要作用：</p> 
<ul><li>一个是服务注册发现，</li><li>一个是配置管理。</li></ul> 
<h4><a id="Nacos_2673"></a>Nacos是什么？</h4> 
<p>Nacos是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</p> 
<p>它提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理 。</p> 
<h4><a id="Nacos_2681"></a>Nacos的结构和组件</h4> 
<p>Nacos的结构和组件包括：</p> 
<ul><li><strong>服务管理</strong>：实现服务CRUD,域名CRUD,服务健康状态检查，服务权重管理等功能。</li><li><strong>配置管理</strong>：实现配置管CRUD,版本管理，灰度管理，监听管理，推送轨迹，聚合数据等功能。</li><li><strong>元数据管理</strong>：提供元数据CURD 和打标能力。</li><li><strong>插件机制</strong>：实现三个模块可分可合能力，实现扩展点SPI机制。</li><li><strong>事件机制</strong>：实现异步化事件通知，sdk数据变化异步通知等逻辑。</li><li><strong>日志模块</strong>：管理日志分类，日志级别，日志可移植性(尤其避免冲突),日志格式，异常码+帮助文档。</li><li><strong>回调机制</strong>：sdk通知数据，通过统一的模式回调用户处理。</li></ul> 
<p><img src="https://images2.imgbox.com/02/13/DgXIVN7u_o.png" alt=""></p> 
<ul><li><strong>服务管理</strong>：实现服务CRUD，域名CRUD，服务健康状态检查，服务权重管理等功能</li><li><strong>配置管理</strong>：实现配置管CRUD，版本管理，灰度管理，监听管理，推送轨迹，聚合数据等功能</li><li><strong>元数据管理</strong>：提供元数据CURD 和打标能力</li><li><strong>插件机制</strong>：实现三个模块可分可合能力，实现扩展点SPI机制</li><li><strong>事件机制</strong>：实现异步化事件通知，sdk数据变化异步通知等逻辑</li><li><strong>日志模块</strong>：管理日志分类，日志级别，日志可移植性（尤其避免冲突），日志格式，异常码+帮助文档</li><li><strong>回调机制</strong>：sdk通知数据，通过统一的模式回调用户处理。接口和数据结构需要具备可扩展性</li><li><strong>寻址模式</strong>：解决ip，域名，nameserver、广播等多种寻址模式，需要可扩展</li><li><strong>推送通道</strong>：解决server与存储、server间、server与sdk间推送性能问题</li><li><strong>容量管理</strong>：管理每个租户，分组下的容量，防止存储被写爆，影响服务可用性</li><li><strong>流量管理</strong>：按照租户，分组等多个维度对请求频率，长链接个数，报文大小，请求流控进行控制</li><li><strong>缓存机制</strong>：容灾目录，本地缓存，server缓存机制。容灾目录使用需要工具</li><li><strong>启动模式</strong>：按照单机模式，配置模式，服务模式，dns模式，或者all模式，启动不同的程序+UI</li><li><strong>一致性协议</strong>：解决不同数据，不同一致性要求情况下，不同一致性机制</li><li><strong>存储模块</strong>：解决数据持久化、非持久化存储，解决数据分片问题</li><li><strong>Nameserver</strong>：解决namespace到clusterid的路由问题，解决用户环境与nacos物理环境映射问题</li><li><strong>CMDB</strong>：解决元数据存储，与三方cmdb系统对接问题，解决应用，人，资源关系</li><li><strong>Metrics</strong>：暴露标准metrics数据，方便与三方监控系统打通</li><li><strong>Trace</strong>：暴露标准trace，方便与SLA系统打通，日志白平化，推送轨迹等能力，并且可以和计量计费系统打通</li><li><strong>接入管理</strong>：相当于阿里云开通服务，分配身份、容量、权限过程</li><li><strong>用户管理</strong>：解决用户管理，登录，sso等问题</li><li><strong>权限管理</strong>：解决身份识别，访问控制，角色管理等问题</li><li><strong>审计系统</strong>：扩展接口方便与不同公司审计系统打通</li><li><strong>通知系统</strong>：核心数据变更，或者操作，方便通过SMS系统打通，通知到对应人数据变更</li><li><strong>OpenAPI</strong>：暴露标准Rest风格HTTP接口，简单易用，方便多语言集成</li><li><strong>Console</strong>：易用控制台，做服务管理、配置管理等操作</li><li><strong>SDK</strong>：多语言sdk</li><li><strong>Agent</strong>：dns-f类似模式，或者与mesh等方案集成</li><li><strong>CLI</strong>：命令行对产品进行轻量化管理，像git一样好用</li></ul> 
<h4><a id="Nacos_2729"></a>Nacos的安装和使用</h4> 
<p>安装和部署特别简单，支持单机部署和集群部署，详情可参考nacos的官网。</p> 
<p>部署完成之后，登录进入</p> 
<p>可以看到配置管理里边的配置列表，页面长这个样子：</p> 
<p><img src="https://images2.imgbox.com/27/9e/QFQOPY45_o.png" alt=""></p> 
<p>可以看到配置管理里边的配置列表的一个详情，页面长这个样子：</p> 
<p><img src="https://images2.imgbox.com/59/bc/UGZy0IFK_o.png" alt=""></p> 
<h4><a id="NamespaceGroupData_ID_2753"></a>配置数据的三个核心概念：Namespace、Group、Data ID</h4> 
<h5><a id="Namespace__2755"></a>命名空间(Namespace) ：环境隔离</h5> 
<p>Namespace 的常用场景之一是不同环境的配置隔离。例如</p> 
<ul><li>开发环境</li><li>测试环境</li><li>生产环境的资源（如配置、服务）隔离等。</li></ul> 
<p>不同的命名空间下，可以存在相同的 Group 或 Data ID 的配置。</p> 
<p>不同的命名空间下，可以存在相同名称的配置分组(Group)或配置集。</p> 
<p>当然，这个不是绝对的。。</p> 
<p>也可以用来进行租户隔离。</p> 
<h5><a id="Group_2775"></a>配置分组（Group）：项目隔离</h5> 
<p>配置分组的常见场景：不同的应用或组件使用了相同的配置类型，如 database_url 配置和 MQ_topic 配置。</p> 
<p>配置分组就是对配置集进行分组。Nacos中的一组配置集，是组织配置的维度之一。</p> 
<p>通过一个有意义的字符串（如 Buy 或 Trade ）对配置集进行分组，从而区分 Data ID 相同的配置集。</p> 
<p>当您在 Nacos 上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用 <code>DEFAULT_GROUP</code>。</p> 
<h5><a id="_Data_ID_2787"></a>配置集( Data ID）：功能隔离</h5> 
<p>一组相关或者不相关的配置项的集合称为配置集。Data ID 通常用于组织划分系统的配置集。</p> 
<p>每个配置集都可以被一个有意义的名称标识，就是配置集的ID即Data ID。</p> 
<p>配置集( Data ID）的常见场景 ： 功能隔离。</p> 
<p>在系统中，一个配置文件通常就是一个配置集，包含了系统各个方面的配置。</p> 
<p>例如，一个配置集可能包含了数据源、线程池、日志级别等配置项。</p> 
<p>从功能视角，可以隔离出： 数据源配置集， 线程池配置集，等等。</p> 
<p><img src="https://images2.imgbox.com/d6/63/oaQySqev_o.png" alt=""></p> 
<h5><a id="_2805"></a>配置集包含一个一个的配置项</h5> 
<p>配置集中包含的一个个配置内容就是配置项。</p> 
<p>一个具体的可配置的参数与其值域，通常以 <code>param-key=param-value</code> 的形式存在。</p> 
<p>例如我们常配置系统的日志输出级别（<code>logLevel=INFO|WARN|ERROR</code>） 就是一个配置项。</p> 
<p><img src="https://images2.imgbox.com/61/a4/47MqdSXY_o.png" alt=""></p> 
<h4><a id="go_nacos_sdk__2819"></a>go nacos sdk 的使用</h4> 
<p>Nacos-sdk-go是Nacos的Go语言客户端sdk ，它实现了服务发现和动态配置的功能</p> 
<ul><li><strong>nacos-sdk-go地址</strong>：https://github.com/nacos-group/nacos-sdk-go</li><li><strong>nacos-sdk-go中文文档地址</strong>：https://github.com/nacos-group/nacos-sdk-go/blob/master/README_CN.md</li><li>go nacos需求分析 
  <ul><li>①.能获取到配置</li><li>②.能监听到配置文件的修改</li><li>③.nacos即是一个配置中心，也是一个注册中心</li></ul> </li></ul> 
<p>Nacos-sdk-go 客户端组件的安装</p> 
<p>使用<code>go get</code>安装SDK：</p> 
<pre><code class="prism language-bash">$ go get -u github.com/nacos-group/nacos-sdk-go/v2
</code></pre> 
<p>Nacos-sdk-go 客户端组件的使用限制</p> 
<ul><li>支持Go&gt;=v1.15版本</li><li>支持Nacos&gt;2.x版本</li></ul> 
<h5><a id="nacossdkgo_demo_2849"></a>nacos-sdk-go 的官方demo</h5> 
<p>nacos-sdk-go 的官方demo</p> 
<p><strong>第一步</strong>： 配合 nacos服务器，创建 serverConfig 对象</p> 
<pre><code class="prism language-go"><span class="token comment">// 创建serverConfig 的例子</span>
serverConfigs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>constant<span class="token punctuation">.</span>ServerConfig<span class="token punctuation">{<!-- --></span>
    <span class="token operator">*</span>constant<span class="token punctuation">.</span><span class="token function">NewServerConfig</span><span class="token punctuation">(</span>
        <span class="token string">"console1.nacos.io"</span><span class="token punctuation">,</span>
        <span class="token number">80</span><span class="token punctuation">,</span>
        constant<span class="token punctuation">.</span><span class="token function">WithScheme</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        constant<span class="token punctuation">.</span><span class="token function">WithContextPath</span><span class="token punctuation">(</span><span class="token string">"/nacos"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">*</span>constant<span class="token punctuation">.</span><span class="token function">NewServerConfig</span><span class="token punctuation">(</span>
        <span class="token string">"console2.nacos.io"</span><span class="token punctuation">,</span>
        <span class="token number">80</span><span class="token punctuation">,</span>
        constant<span class="token punctuation">.</span><span class="token function">WithScheme</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        constant<span class="token punctuation">.</span><span class="token function">WithContextPath</span><span class="token punctuation">(</span><span class="token string">"/nacos"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>


<span class="token comment">// 创建serverConfig 的第2个例子</span>
serverConfigs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>constant<span class="token punctuation">.</span>ServerConfig<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span>
        IpAddr<span class="token punctuation">:</span>      <span class="token string">"console1.nacos.io"</span><span class="token punctuation">,</span>
        ContextPath<span class="token punctuation">:</span> <span class="token string">"/nacos"</span><span class="token punctuation">,</span>
        Port<span class="token punctuation">:</span>        <span class="token number">80</span><span class="token punctuation">,</span>
        Scheme<span class="token punctuation">:</span>      <span class="token string">"http"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
    	IpAddr<span class="token punctuation">:</span>      <span class="token string">"console2.nacos.io"</span><span class="token punctuation">,</span>
    	ContextPath<span class="token punctuation">:</span> <span class="token string">"/nacos"</span><span class="token punctuation">,</span>
    	Port<span class="token punctuation">:</span>        <span class="token number">80</span><span class="token punctuation">,</span>
        Scheme<span class="token punctuation">:</span>      <span class="token string">"http"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>第二步</strong>： 配合 nacos 客户端，创建 clientConfig对象</p> 
<pre><code class="prism language-go"><span class="token comment">// 创建clientConfig</span>
clientConfig <span class="token operator">:=</span> constant<span class="token punctuation">.</span>ClientConfig<span class="token punctuation">{<!-- --></span>
	NamespaceId<span class="token punctuation">:</span>         <span class="token string">"e525eafa-f7d7-4029-83d9-008937f9d468"</span><span class="token punctuation">,</span> <span class="token comment">// 如果需要支持多namespace，我们可以创建多个client,它们有不同的NamespaceId。当namespace是public时，此处填空字符串。</span>
	TimeoutMs<span class="token punctuation">:</span>           <span class="token number">5000</span><span class="token punctuation">,</span>
	NotLoadCacheAtStart<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	LogDir<span class="token punctuation">:</span>              <span class="token string">"/tmp/nacos/log"</span><span class="token punctuation">,</span>
	CacheDir<span class="token punctuation">:</span>            <span class="token string">"/tmp/nacos/cache"</span><span class="token punctuation">,</span>
	LogLevel<span class="token punctuation">:</span>            <span class="token string">"debug"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建clientConfig的另一种方式</span>
clientConfig <span class="token operator">:=</span> <span class="token operator">*</span>constant<span class="token punctuation">.</span><span class="token function">NewClientConfig</span><span class="token punctuation">(</span>
    constant<span class="token punctuation">.</span><span class="token function">WithNamespaceId</span><span class="token punctuation">(</span><span class="token string">"e525eafa-f7d7-4029-83d9-008937f9d468"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//当namespace是public时，此处填空字符串。</span>
    constant<span class="token punctuation">.</span><span class="token function">WithTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    constant<span class="token punctuation">.</span><span class="token function">WithNotLoadCacheAtStart</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    constant<span class="token punctuation">.</span><span class="token function">WithLogDir</span><span class="token punctuation">(</span><span class="token string">"/tmp/nacos/log"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    constant<span class="token punctuation">.</span><span class="token function">WithCacheDir</span><span class="token punctuation">(</span><span class="token string">"/tmp/nacos/cache"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    constant<span class="token punctuation">.</span><span class="token function">WithLogLevel</span><span class="token punctuation">(</span><span class="token string">"debug"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<p><strong>第三步</strong>：创建动态配置客户端</p> 
<pre><code class="prism language-go"><span class="token comment">// 创建动态配置客户端</span>
<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> clients<span class="token punctuation">.</span><span class="token function">CreateConfigClient</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
	<span class="token string">"serverConfigs"</span><span class="token punctuation">:</span> serverConfigs<span class="token punctuation">,</span>
	<span class="token string">"clientConfig"</span><span class="token punctuation">:</span>  clientConfig<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 创建动态配置客户端的另一种方式 (推荐)</span>
configClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> clients<span class="token punctuation">.</span><span class="token function">NewConfigClient</span><span class="token punctuation">(</span>
    vo<span class="token punctuation">.</span>NacosClientParam<span class="token punctuation">{<!-- --></span>
        ClientConfig<span class="token punctuation">:</span>  <span class="token operator">&amp;</span>clientConfig<span class="token punctuation">,</span>
        ServerConfigs<span class="token punctuation">:</span> serverConfigs<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>和配置客户端类似，服务发现客户端也是这么干的</p> 
<pre><code class="prism language-go"><span class="token comment">// 创建服务发现客户端</span>
<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> clients<span class="token punctuation">.</span><span class="token function">CreateNamingClient</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
	<span class="token string">"serverConfigs"</span><span class="token punctuation">:</span> serverConfigs<span class="token punctuation">,</span>
	<span class="token string">"clientConfig"</span><span class="token punctuation">:</span>  clientConfig<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// 创建服务发现客户端的另一种方式 (推荐)</span>
namingClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> clients<span class="token punctuation">.</span><span class="token function">NewNamingClient</span><span class="token punctuation">(</span>
    vo<span class="token punctuation">.</span>NacosClientParam<span class="token punctuation">{<!-- --></span>
        ClientConfig<span class="token punctuation">:</span>  <span class="token operator">&amp;</span>clientConfig<span class="token punctuation">,</span>
        ServerConfigs<span class="token punctuation">:</span> serverConfigs<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="go_nacos_2960"></a>示例：go nacos实现配置读取与监听配置变化</h5> 
<p>示例功能：</p> 
<ul><li>go nacos实现配置读取</li><li>监听配置变化</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/nacos-group/nacos-sdk-go/v2/clients"</span>
	<span class="token string">"github.com/nacos-group/nacos-sdk-go/v2/common/constant"</span>
	<span class="token string">"github.com/nacos-group/nacos-sdk-go/v2/vo"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	sc <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>constant<span class="token punctuation">.</span>ServerConfig<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">{<!-- --></span>
			IpAddr<span class="token punctuation">:</span> <span class="token string">"192.168.56.121"</span><span class="token punctuation">,</span>
			Port<span class="token punctuation">:</span>   <span class="token number">8848</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 创建clientConfig</span>
	cc <span class="token operator">:=</span> constant<span class="token punctuation">.</span>ClientConfig<span class="token punctuation">{<!-- --></span>
		NamespaceId<span class="token punctuation">:</span>         <span class="token string">"dubbo"</span><span class="token punctuation">,</span> <span class="token comment">// 如果需要支持多namespace，我们可以场景多个client,它们有不同的NamespaceId。当namespace是public时，此处填空字符串。</span>
		TimeoutMs<span class="token punctuation">:</span>           <span class="token number">5000</span><span class="token punctuation">,</span>
		NotLoadCacheAtStart<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		LogDir<span class="token punctuation">:</span>              <span class="token string">"tmp/nacos/log"</span><span class="token punctuation">,</span> <span class="token comment">//去掉tmp前面的/，这样就会默认保存到当前项目目录下</span>
		CacheDir<span class="token punctuation">:</span>            <span class="token string">"tmp/nacos/cache"</span><span class="token punctuation">,</span>
		LogLevel<span class="token punctuation">:</span>            <span class="token string">"debug"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	configClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> clients<span class="token punctuation">.</span><span class="token function">CreateConfigClient</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span>
		<span class="token string">"serverConfigs"</span><span class="token punctuation">:</span> sc<span class="token punctuation">,</span>
		<span class="token string">"clientConfig"</span><span class="token punctuation">:</span>  cc<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	content<span class="token punctuation">,</span> err <span class="token operator">:=</span> configClient<span class="token punctuation">.</span><span class="token function">GetConfig</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span>ConfigParam<span class="token punctuation">{<!-- --></span>
		DataId<span class="token punctuation">:</span> <span class="token string">"crazymaker-common-dev.yml"</span><span class="token punctuation">,</span>
		Group<span class="token punctuation">:</span>  <span class="token string">"DEFAULT_GROUP"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token comment">//字符串 - yaml</span>

	<span class="token comment">//监听配置修改</span>
	err <span class="token operator">=</span> configClient<span class="token punctuation">.</span><span class="token function">ListenConfig</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span>ConfigParam<span class="token punctuation">{<!-- --></span>
		DataId<span class="token punctuation">:</span> <span class="token string">"crazymaker-common-dev.yml"</span><span class="token punctuation">,</span>
		Group<span class="token punctuation">:</span>  <span class="token string">"DEFAULT_GROUP"</span><span class="token punctuation">,</span>
		OnChange<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> group<span class="token punctuation">,</span> dataId<span class="token punctuation">,</span> data <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"配置文件变化"</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"group:"</span> <span class="token operator">+</span> group <span class="token operator">+</span> <span class="token string">", dataId:"</span> <span class="token operator">+</span> dataId <span class="token operator">+</span> <span class="token string">", data:"</span> <span class="token operator">+</span> data<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3000</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行代码，输入了配置文件里边的内容</p> 
<p><img src="https://images2.imgbox.com/13/f5/JIE739do_o.png" alt=""></p> 
<p>CacheDir的作用：</p> 
<ul><li>配置了CacheDir的时候，本地项目下会生成CacheDir的目录</li><li>一旦nacos不可用，无法访问nacos；如果我们有配置CachaDir，那么就会读取本地配置信息</li></ul> 
<p><img src="https://images2.imgbox.com/15/89/1dY6UCob_o.png" alt=""></p> 
<h4><a id="nacos_go_3041"></a>nacos go动态配置</h4> 
<p>类似于 数据库的 crud，以及变化通知</p> 
<ul><li><strong>发布配置</strong>：PublishConfig</li></ul> 
<p>使用nacos go动态发布配置</p> 
<pre><code class="prism language-go">success<span class="token punctuation">,</span> err <span class="token operator">:=</span> configClient<span class="token punctuation">.</span><span class="token function">PublishConfig</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span>ConfigParam<span class="token punctuation">{<!-- --></span>
    DataId<span class="token punctuation">:</span>  <span class="token string">"dataId"</span><span class="token punctuation">,</span>
    Group<span class="token punctuation">:</span>   <span class="token string">"group"</span><span class="token punctuation">,</span>
    Content<span class="token punctuation">:</span> <span class="token string">"hello world!222222"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><strong>删除配置</strong>：DeleteConfig</li></ul> 
<p>使用nacos go动态删除配置</p> 
<pre><code class="prism language-go">success<span class="token punctuation">,</span> err <span class="token operator">=</span> configClient<span class="token punctuation">.</span><span class="token function">DeleteConfig</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span>ConfigParam<span class="token punctuation">{<!-- --></span>
    DataId<span class="token punctuation">:</span> <span class="token string">"dataId"</span><span class="token punctuation">,</span>
    Group<span class="token punctuation">:</span>  <span class="token string">"group"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><strong>获取配置</strong>：GetConfig</li></ul> 
<p>使用nacos go动态删除配置</p> 
<pre><code class="prism language-go">content<span class="token punctuation">,</span> err <span class="token operator">:=</span> configClient<span class="token punctuation">.</span><span class="token function">GetConfig</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span>ConfigParam<span class="token punctuation">{<!-- --></span>
    DataId<span class="token punctuation">:</span> <span class="token string">"dataId"</span><span class="token punctuation">,</span>
    Group<span class="token punctuation">:</span>  <span class="token string">"group"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><strong>监听配置变化</strong>：ListenConfig</li></ul> 
<p>使用nacos go动态监听配置变化</p> 
<pre><code class="prism language-go">err <span class="token operator">:=</span> configClient<span class="token punctuation">.</span><span class="token function">ListenConfig</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span>ConfigParam<span class="token punctuation">{<!-- --></span>
    DataId<span class="token punctuation">:</span> <span class="token string">"dataId"</span><span class="token punctuation">,</span>
    Group<span class="token punctuation">:</span>  <span class="token string">"group"</span><span class="token punctuation">,</span>
    OnChange<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> group<span class="token punctuation">,</span> dataId<span class="token punctuation">,</span> data <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"group:"</span> <span class="token operator">+</span> group <span class="token operator">+</span> <span class="token string">", dataId:"</span> <span class="token operator">+</span> dataId <span class="token operator">+</span> <span class="token string">", data:"</span> <span class="token operator">+</span> data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><strong>取消配置监听</strong>：CancelListenConfig</li></ul> 
<p>使用nacos go取消配置监听</p> 
<pre><code class="prism language-go">err <span class="token operator">:=</span> configClient<span class="token punctuation">.</span><span class="token function">CancelListenConfig</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span>ConfigParam<span class="token punctuation">{<!-- --></span>
    DataId<span class="token punctuation">:</span> <span class="token string">"dataId"</span><span class="token punctuation">,</span>
    Group<span class="token punctuation">:</span>  <span class="token string">"group"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>搜索配置: SearchConfig</li></ul> 
<p>使用nacos go搜索配置</p> 
<pre><code class="prism language-go">configPage<span class="token punctuation">,</span>err <span class="token operator">:=</span> configClient<span class="token punctuation">.</span><span class="token function">SearchConfig</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span>SearchConfigParam<span class="token punctuation">{<!-- --></span>
    Search<span class="token punctuation">:</span>   <span class="token string">"blur"</span><span class="token punctuation">,</span>
    DataId<span class="token punctuation">:</span>   <span class="token string">""</span><span class="token punctuation">,</span>
    Group<span class="token punctuation">:</span>    <span class="token string">""</span><span class="token punctuation">,</span>
    PageNo<span class="token punctuation">:</span>   <span class="token number">1</span><span class="token punctuation">,</span>
    PageSize<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>监听配置变化演示：</p> 
<p>上面的案例里边，已经有了 监听配置变化代码</p> 
<p>在nacos 控制台，修改一下配置文件</p> 
<p><img src="https://images2.imgbox.com/00/83/jQHIHYDw_o.png" alt=""></p> 
<p>发布一波,</p> 
<p>咱们程序的控制台，就可以看到 ， 监听到的数据</p> 
<p><img src="https://images2.imgbox.com/32/31/cY3rBy5D_o.png" alt=""></p> 
<p>要注意的是：</p> 
<p>这里返回的是整个的数据集，而不仅仅是变化了的那个数据项</p> 
<h3><a id="Golang__5W_3140"></a>《Golang 圣经》还有 5W字待发布</h3> 
<p>本文，仅仅是《Golang 圣经》 的第3部分。《Golang 圣经》后面的内容 更加精彩，涉及到<strong>高并发、分布式微服务架构、 WEB开发架构</strong>，具体请关注进展，请关注《技术自由圈》 公众号。</p> 
<p>如果需要领取 《Golang 圣经》， 请关注《技术自由圈》 公众号，发送暗号 “领电子书” 。</p> 
<p>最后，如果学习过程中遇到问题，可以来尼恩的 万人高并发社群《技术自由圈》中交流。</p> 
<h3><a id="_3148"></a>参考资料</h3> 
<ul><li><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection#Na.C3.AFve_mark-and-sweep" rel="nofollow">Tracing Garbage Collection - wikipedia</a></li><li><a href="http://www.cs.utexas.edu/users/mckinley/395Tmm/talks/Mar-30-Dijkstra.pdf" rel="nofollow">On-the-fly Garbage Collection: an exercise in cooperation.</a></li><li><a href="https://en.wikipedia.org/wiki/Garbage_collection_%28computer_science%29" rel="nofollow">Garbage Collection</a></li><li><a href="https://en.wikipedia.org/wiki/Tracing_garbage_collection" rel="nofollow">Tracing Garbage Collection</a></li><li><a href="https://www.youtube.com/watch?v=P1rU_9IB414" rel="nofollow">Copying Garbage Collection</a></li><li><a href="https://www.youtube.com/watch?v=pJHISaOW6Vc" rel="nofollow">Generational Garbage Collection</a></li><li><a href="https://github.com/KeKe-Li/book/blob/master/Go/go-gc.pdf">Golang Gc Talk</a></li><li><a href="https://github.com/golang/proposal/blob/master/design/17503-eliminate-rescan.md">Eliminate Rescan</a></li></ul> 
<h3><a id="_3164"></a>推荐阅读：</h3> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129482349">Docker圣经：大白话说Docker底层原理，6W字实现Docker自由</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/130073643">K8S学习圣经：大白话说K8S底层原理，14W字实现K8S自由</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129559428">SpringCloud Alibaba 学习圣经，10万字实现SpringCloud 自由</a>》</p> 
<p>尼恩 架构笔记、面试题 的PDF文件更新，▼请到下面【技术自由圈】公号取 ▼</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9cbd99a4dbf93edfc74884640119af00/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CSS中高度塌陷问题以及解决办法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/50d56cf01c3215d54acf25ca6818ef34/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">微信小程序获取用户手机号</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>