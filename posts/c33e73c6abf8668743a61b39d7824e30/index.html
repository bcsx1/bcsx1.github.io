<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flink state,checkpoint详解 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flink state,checkpoint详解" />
<meta property="og:description" content="目录
目录
背景
（1）介绍，实现方式分类
（2） 使用Manage State，Flink自动实现state保存和恢复
（3） 自定义state 自行实现实现checkpoint接口
借鉴文章
背景
Flink相对于Storm和Spark Stream比较大的一个优势就是State，pipline中可以保存状态，这对于解决业务是有巨大的帮助，否则将需要借助三方工具来时间状态的存储和访问。
正文 State
什么是State(状态)？
某task/operator在某时刻的一个中间结果
快照(shapshot)
在flink中状态可以理解为一种数据结构
举例
对输入源为&lt;key,value&gt;的数据,计算其中某key的最大值，如果使用HashMap，也可以进行计算，但是每次都需要重新遍历，使用状态的话，可以获取最近的一次计算结果，减少了系统的计算次数
程序一旦crash，恢复
程序扩容
State类型
总的来说，state分为两种，operator state和key state，key state专门对keystream使用，所包含的Sate种类也更多，可理解为dataStream.keyBy()之后的Operator State,Operator State是对每一个Operator的状态进行记录，而key State则是在dataSteam进行keyBy()后，记录相同keyId的keyStream上的状态key State提供的数据类型：ValueState&lt;T&gt;、ListState&lt;T&gt;、ReducingState&lt;T&gt;、MapState&lt;T&gt;。
operator state种类只有一种就是ListState&lt;T&gt; ，flink官方文档用kafka的消费者举例，认为kafka消费者的partitionId和offset类似flink的operator state
State理解
state分为operator state和key state两种，都属于manage state，优势是可以结合checkpoint，实现自动存储状态和异常恢复功能，但是state不一定要使用manage state，在source、windows和sink中自己声明一个int都可以作为状态进行使用，只不过需要自己实现快照状态保存和恢复。
State实战
import org.apache.flink.api.common.functions.RichFlatMapFunction;
import org.apache.flink.api.common.state.ValueState;
import org.apache.flink.api.common.state.ValueStateDescriptor;
import org.apache.flink.api.common.typeinfo.TypeHint;
import org.apache.flink.api.common.typeinfo.TypeInformation;
import org.apache.flink.api.java.tuple.Tuple2;
import org.apache.flink.configuration.Configuration;
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.util.Collector;
/**
* Created by authoe on 2018/9/12." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/c33e73c6abf8668743a61b39d7824e30/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-22T14:55:31+08:00" />
<meta property="article:modified_time" content="2019-07-22T14:55:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flink state,checkpoint详解</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>目录</p> 
<p>目录</p> 
<p>背景</p> 
<p>  </p> 
<p>（1）介绍，实现方式分类</p> 
<p>（2） 使用Manage State，Flink自动实现state保存和恢复</p> 
<p>（3） 自定义state 自行实现实现checkpoint接口</p> 
<p>借鉴文章</p> 
<p> <br> 背景</p> 
<p>           Flink相对于Storm和Spark Stream比较大的一个优势就是State，pipline中可以保存状态，这对于解决业务是有巨大的帮助，否则将需要借助三方工具来时间状态的存储和访问。<br>  <br> 正文         <br> State<br> 什么是State(状态)？</p> 
<p>    某task/operator在某时刻的一个中间结果<br>     快照(shapshot)<br>     在flink中状态可以理解为一种数据结构<br>     举例<br>     对输入源为&lt;key,value&gt;的数据,计算其中某key的最大值，如果使用HashMap，也可以进行计算，但是每次都需要重新遍历，使用状态的话，可以获取最近的一次计算结果，减少了系统的计算次数<br>     程序一旦crash，恢复<br>     程序扩容</p> 
<p>State类型</p> 
<p>      总的来说，state分为两种，operator state和key state，key state专门对keystream使用，所包含的Sate种类也更多，可理解为dataStream.keyBy()之后的Operator State,Operator State是对每一个Operator的状态进行记录，而key State则是在dataSteam进行keyBy()后，记录相同keyId的keyStream上的状态key State提供的数据类型：ValueState&lt;T&gt;、ListState&lt;T&gt;、ReducingState&lt;T&gt;、MapState&lt;T&gt;。</p> 
<p>      operator state种类只有一种就是ListState&lt;T&gt;   ，flink官方文档用kafka的消费者举例，认为kafka消费者的partitionId和offset类似flink的operator state</p> 
<p><br> State理解</p> 
<p>        state分为operator state和key state两种，都属于manage state，优势是可以结合checkpoint，实现自动存储状态和异常恢复功能，但是state不一定要使用manage state，在source、windows和sink中自己声明一个int都可以作为状态进行使用，只不过需要自己实现快照状态保存和恢复。<br> State实战</p> 
<p>    import org.apache.flink.api.common.functions.RichFlatMapFunction;<br>     import org.apache.flink.api.common.state.ValueState;<br>     import org.apache.flink.api.common.state.ValueStateDescriptor;<br>     import org.apache.flink.api.common.typeinfo.TypeHint;<br>     import org.apache.flink.api.common.typeinfo.TypeInformation;<br>     import org.apache.flink.api.java.tuple.Tuple2;<br>     import org.apache.flink.configuration.Configuration;<br>     import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;<br>     import org.apache.flink.util.Collector;<br>      <br>     /**<br>      * Created by authoe on 2018/9/12.<br>      */<br>     public class StateTest {<!-- --><br>         public static void main(String[] args) throws Exception{<!-- --><br>             StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();<br>             env.setParallelism(4).fromElements(Tuple2.of(1L,1L),Tuple2.of(2L,2L),Tuple2.of(3L,2L),Tuple2.of(4L,3L))<br>                     .keyBy(0).flatMap(new RichFlatMapFunction&lt;Tuple2&lt;Long,Long&gt;, Object&gt;() {<!-- --><br>                 private transient ValueState&lt;Tuple2&lt;Long,Long&gt;&gt; sum;<br>                 @Override<br>                 public void flatMap(Tuple2&lt;Long, Long&gt; longLongTuple2, Collector&lt;Object&gt; collector) throws Exception {<!-- --><br>      <br>                     Tuple2&lt;Long,Long&gt; curSum = sum.value();<br>                     curSum.f0+=1;<br>                     curSum.f1+=longLongTuple2.f1;<br>                     System.out.println("+");<br>                     sum.update(curSum);<br>                     if(curSum.f0&gt;0){<!-- --><br>                         System.out.println("-");<br>                         collector.collect(Tuple2.of(curSum.f0,curSum.f1));<br>                         sum.clear();<br>                     }<br>      <br>                 }<br>      <br>                 @Override<br>                 public void open(Configuration parameters) throws Exception {<!-- --><br>                     ValueStateDescriptor&lt;Tuple2&lt;Long,Long&gt;&gt; descriptor = new ValueStateDescriptor&lt;Tuple2&lt;Long, Long&gt;&gt;("avg", TypeInformation.of(<br>                             new TypeHint&lt;Tuple2&lt;Long, Long&gt;&gt;() {}),Tuple2.of(0L,0L));<br>                     sum = getRuntimeContext().getState(descriptor);<br>                 }<br>             }).print();<br>             env.execute();<br>      <br>         }<br>     }</p> 
<p> <br> CheckPointing<br> （1）介绍，实现方式分类</p> 
<p>           checkpoint可以保存窗口和算子的执行状态，在出现异常之后重启计算任务，并保证已经执行和不会再重复执行，检查点可以分为两种，托管的和自定义的，托管检查点会自动的进行存储到指定位置：内存、磁盘和分布式存储中，自定义就需要自行实现保存相关，实现checkpoint有如下两种方式：</p> 
<p>    使用托管State变量<br>     使用自定义State变量实现CheckpointedFunction接口或者ListCheckpoint&lt;T extends Serializable&gt;接口</p> 
<p>    下面将会给出两种方式的使用代码<br> （2） 使用Manage State，Flink自动实现state保存和恢复</p> 
<p>         下面先给出托管状态变量（manage stata）使用代码，后面给出了代码执行的打印日志。</p> 
<p> 代码分析：</p> 
<p>                  代码每隔2s发送10条记录，所有数据key=1,会发送到统一窗口进行计数，发送超过100条是，抛出异常，模拟异常<br>                   窗口中统计收到的消息记录数，当异常发生时，查看windows是否会从state中获取历史数据，即checkpoint是否生效<br>                   注释已经添加进代码中，有个问题有时，state.value()在open（）方法中调用的时候，会抛出null异常，而在apply中                  使用就不会抛出异常。</p> 
<p>Console日志输出分析：</p> 
<p>                  四个open调用，因为我本地代码默认并行度为4，所以会有4个windows函数被实例化出来，调用各自open函数<br>                   source发送记录到达100抛出异常<br>                   source抛出异常之后，count发送统计数丢失，重新从0开始<br>                   windows函数，重启后调用open函数，获取state数据，处理记录数从checkpoint中获取恢复，所以从100开始</p> 
<p>总结：</p> 
<p>         source没有使用manage state状态丢失，windows使用manage state，异常状态不丢失</p> 
<p>    package per.test;<br>      <br>     import org.apache.flink.api.common.state.ValueState;<br>     import org.apache.flink.api.common.state.ValueStateDescriptor;<br>     import org.apache.flink.api.common.typeinfo.TypeHint;<br>     import org.apache.flink.api.common.typeinfo.TypeInformation;<br>     import org.apache.flink.api.java.tuple.Tuple;<br>     import org.apache.flink.api.java.tuple.Tuple3;<br>     import org.apache.flink.configuration.Configuration;<br>     import org.apache.flink.runtime.state.filesystem.FsStateBackend;<br>     import org.apache.flink.streaming.api.CheckpointingMode;<br>     import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;<br>     import org.apache.flink.streaming.api.functions.source.SourceFunction;<br>     import org.apache.flink.streaming.api.functions.windowing.RichWindowFunction;<br>     import org.apache.flink.streaming.api.windowing.assigners.TumblingProcessingTimeWindows;<br>     import org.apache.flink.streaming.api.windowing.time.Time;<br>     import org.apache.flink.streaming.api.windowing.windows.TimeWindow;<br>     import org.apache.flink.util.Collector;<br>      <br>      <br>     /**<br>      * Created by betree on 2018/9/14.<br>      */<br>     public class StateCheckPoint {<!-- --><br>         public static void main(String[] args) throws Exception{<!-- --><br>             StreamExecutionEnvironment env =  StreamExecutionEnvironment.getExecutionEnvironment();<br>      <br>             //打开并设置checkpoint<br>             // 1.设置checkpoint目录，这里我用的是本地路径，记得本地路径要file开头<br>             // 2.设置checkpoint类型，at lease onece or EXACTLY_ONCE<br>             // 3.设置间隔时间，同时打开checkpoint功能<br>             //<br>             env.setStateBackend(new FsStateBackend("file:///Users/username/Documents/程序数据/Flink/state_checkpoint/"));<br>             env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);<br>             env.getCheckpointConfig().setCheckpointInterval(1000);<br>      <br>      <br>             //添加source 每个2s 发送10条数据，key=1，达到100条时候抛出异常<br>             env.addSource(new SourceFunction&lt;Tuple3&lt;Integer,String,Integer&gt;&gt;() {<!-- --><br>                 private Boolean isRunning = true;<br>                 private int count = 0;<br>                 @Override<br>                 public void run(SourceContext&lt;Tuple3&lt;Integer, String, Integer&gt;&gt; sourceContext) throws Exception {<!-- --><br>                     while(isRunning){<!-- --><br>      <br>                         for (int i = 0; i &lt; 10; i++) {<!-- --><br>                             sourceContext.collect(Tuple3.of(1,"ahah",count));<br>                             count++;<br>                         }<br>                         if(count&gt;100){<!-- --><br>                             System.out.println("err_________________");<br>                             throw new Exception("123");<br>                         }<br>                         System.out.println("source:"+count);<br>                         Thread.sleep(2000);<br>                     }<br>      <br>                 }<br>      <br>                 @Override<br>                 public void cancel() {<!-- --><br>      <br>                 }<br>             }).keyBy(0)<br>      <br>                     .window(TumblingProcessingTimeWindows.of(Time.seconds(2)))<br>      <br>                     //窗口函数，比如是richwindowsfunction 否侧无法使用manage state<br>                     .apply(new RichWindowFunction&lt;Tuple3&lt;Integer,String,Integer&gt;, Integer, Tuple, TimeWindow&gt;() {<!-- --><br>                         private transient ValueState&lt;Integer&gt; state;<br>                         private int count = 0;<br>                         @Override<br>                         public void apply(Tuple tuple, TimeWindow timeWindow, Iterable&lt;Tuple3&lt;Integer, String, Integer&gt;&gt; iterable, Collector&lt;Integer&gt; collector) throws Exception {<!-- --><br>                             //从state中获取值<br>                             count=state.value();<br>                             for(Tuple3&lt;Integer, String, Integer&gt; item : iterable){<!-- --><br>                                 count++;<br>                             }<br>                             //更新state值<br>                             state.update(count);<br>                             System.out.println("windows:"+tuple.toString()+"  "+count+"   state count:"+state.value());<br>                             collector.collect(count);<br>                         }<br>      <br>      <br>                         //获取state<br>                         @Override<br>                         public void open(Configuration parameters) throws Exception {<!-- --><br>                             System.out.println("##open");<br>                             ValueStateDescriptor&lt;Integer&gt; descriptor =<br>                                     new ValueStateDescriptor&lt;Integer&gt;(<br>                                             "average", // the state name<br>                                             TypeInformation.of(new TypeHint&lt;Integer&gt;() {}), // type information<br>                                             0);<br>                             state = getRuntimeContext().getState(descriptor);<br>      <br>      <br>      <br>      <br>                         }<br>                     }).print();<br>             env.execute();<br>         }<br>     }</p> 
<p>给出日志打印结果：</p> 
<p>    /Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/bin/java "-javaagent:/Applications/IntelliJ IDEA CE.app/Contents/lib/idea_rt.jar=59422:/Applications/IntelliJ IDEA CE.app/Contents/bin" -Dfile.encoding=UTF-8 -classpath /Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/charsets.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/deploy.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/cldrdata.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/dnsns.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/jaccess.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/jfxrt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/localedata.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/nashorn.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/sunec.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/sunjce_provider.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/sunpkcs11.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/zipfs.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/javaws.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jce.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jfr.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jfxswt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jsse.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/management-agent.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/plugin.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/resources.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/rt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/ant-javafx.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/dt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/javafx-mx.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/jconsole.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/packager.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/sa-jdi.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/tools.jar:/Users/wangqi/Documents/code/workplace/flink_t/target/classes:/Users/wangqi/.m2/repository/org/apache/flink/flink-java/1.6.0/flink-java-1.6.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-core/1.6.0/flink-core-1.6.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-annotations/1.6.0/flink-annotations-1.6.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-metrics-core/1.6.0/flink-metrics-core-1.6.0.jar:/Users/wangqi/.m2/repository/com/esotericsoftware/kryo/kryo/2.24.0/kryo-2.24.0.jar:/Users/wangqi/.m2/repository/com/esotericsoftware/minlog/minlog/1.2/minlog-1.2.jar:/Users/wangqi/.m2/repository/org/objenesis/objenesis/2.1/objenesis-2.1.jar:/Users/wangqi/.m2/repository/commons-collections/commons-collections/3.2.2/commons-collections-3.2.2.jar:/Users/wangqi/.m2/repository/org/apache/commons/commons-compress/1.4.1/commons-compress-1.4.1.jar:/Users/wangqi/.m2/repository/org/tukaani/xz/1.0/xz-1.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-shaded-asm/5.0.4-4.0/flink-shaded-asm-5.0.4-4.0.jar:/Users/wangqi/.m2/repository/org/apache/commons/commons-lang3/3.3.2/commons-lang3-3.3.2.jar:/Users/wangqi/.m2/repository/org/apache/commons/commons-math3/3.5/commons-math3-3.5.jar:/Users/wangqi/.m2/repository/org/slf4j/slf4j-api/1.7.7/slf4j-api-1.7.7.jar:/Users/wangqi/.m2/repository/com/google/code/findbugs/jsr305/1.3.9/jsr305-1.3.9.jar:/Users/wangqi/.m2/repository/org/apache/flink/force-shading/1.6.0/force-shading-1.6.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-streaming-java_2.11/1.6.0/flink-streaming-java_2.11-1.6.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-runtime_2.11/1.6.0/flink-runtime_2.11-1.6.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-queryable-state-client-java_2.11/1.6.0/flink-queryable-state-client-java_2.11-1.6.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-hadoop-fs/1.6.0/flink-hadoop-fs-1.6.0.jar:/Users/wangqi/.m2/repository/commons-io/commons-io/2.4/commons-io-2.4.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-shaded-netty/4.1.24.Final-4.0/flink-shaded-netty-4.1.24.Final-4.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-shaded-jackson/2.7.9-4.0/flink-shaded-jackson-2.7.9-4.0.jar:/Users/wangqi/.m2/repository/org/javassist/javassist/3.19.0-GA/javassist-3.19.0-GA.jar:/Users/wangqi/.m2/repository/org/scala-lang/scala-library/2.11.12/scala-library-2.11.12.jar:/Users/wangqi/.m2/repository/com/typesafe/akka/akka-actor_2.11/2.4.20/akka-actor_2.11-2.4.20.jar:/Users/wangqi/.m2/repository/com/typesafe/config/1.3.0/config-1.3.0.jar:/Users/wangqi/.m2/repository/org/scala-lang/modules/scala-java8-compat_2.11/0.7.0/scala-java8-compat_2.11-0.7.0.jar:/Users/wangqi/.m2/repository/com/typesafe/akka/akka-stream_2.11/2.4.20/akka-stream_2.11-2.4.20.jar:/Users/wangqi/.m2/repository/org/reactivestreams/reactive-streams/1.0.0/reactive-streams-1.0.0.jar:/Users/wangqi/.m2/repository/com/typesafe/ssl-config-core_2.11/0.2.1/ssl-config-core_2.11-0.2.1.jar:/Users/wangqi/.m2/repository/org/scala-lang/modules/scala-parser-combinators_2.11/1.0.4/scala-parser-combinators_2.11-1.0.4.jar:/Users/wangqi/.m2/repository/com/typesafe/akka/akka-protobuf_2.11/2.4.20/akka-protobuf_2.11-2.4.20.jar:/Users/wangqi/.m2/repository/com/typesafe/akka/akka-slf4j_2.11/2.4.20/akka-slf4j_2.11-2.4.20.jar:/Users/wangqi/.m2/repository/org/clapper/grizzled-slf4j_2.11/1.0.2/grizzled-slf4j_2.11-1.0.2.jar:/Users/wangqi/.m2/repository/com/github/scopt/scopt_2.11/3.5.0/scopt_2.11-3.5.0.jar:/Users/wangqi/.m2/repository/org/xerial/snappy/snappy-java/1.1.4/snappy-java-1.1.4.jar:/Users/wangqi/.m2/repository/com/twitter/chill_2.11/0.7.4/chill_2.11-0.7.4.jar:/Users/wangqi/.m2/repository/com/twitter/chill-java/0.7.4/chill-java-0.7.4.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-shaded-guava/18.0-4.0/flink-shaded-guava-18.0-4.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-clients_2.11/1.6.0/flink-clients_2.11-1.6.0.jar:/Users/wangqi/.m2/repository/org/apache/flink/flink-optimizer_2.11/1.6.0/flink-optimizer_2.11-1.6.0.jar:/Users/wangqi/.m2/repository/commons-cli/commons-cli/1.3.1/commons-cli-1.3.1.jar per.test.StateCheckPoint<br>     objc[34882]: Class JavaLaunchHelper is implemented in both /Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/bin/java (0x10b8bc4c0) and /Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/libinstrument.dylib (0x10b9404e0). One of the two will be used. Which one is undefined.<br>     SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".<br>     SLF4J: Defaulting to no-operation (NOP) logger implementation<br>     SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.<br>     source:10<br>     ##open<br>     ##open<br>     ##open<br>     ##open<br>     err##<br>     err##<br>     err##<br>     err##<br>     windows:(1)  10   state count:10<br>     3&gt; 10<br>     source:20<br>     source:30<br>     windows:(1)  30   state count:30<br>     3&gt; 30<br>     source:40<br>     windows:(1)  40   state count:40<br>     3&gt; 40<br>     source:50<br>     windows:(1)  50   state count:50<br>     3&gt; 50<br>     source:60<br>     source:70<br>     windows:(1)  70   state count:70<br>     3&gt; 70<br>     source:80<br>     windows:(1)  80   state count:80<br>     3&gt; 80<br>     source:90<br>     windows:(1)  90   state count:90<br>     3&gt; 90<br>     source:100<br>     err_________________<br>     windows:(1)  110   state count:110<br>     3&gt; 110<br>     source:10<br>     ##open<br>     err##<br>     ##open<br>     err##<br>     ##open<br>     ##open<br>     err##<br>     err##<br>     windows:(1)  10   state count:10<br>     3&gt; 10<br>     windows:(1)  20   state count:20<br>     3&gt; 20<br>     source:20<br>      <br>     Process finished with exit code 130 (interrupted by signal 2: SIGINT)</p> 
<p> <br> （3） 自定义state 自行实现实现checkpoint接口</p> 
<p>    实现CheckpointedFunction接口或者ListCheckpoint&lt;T extends Serializable&gt;接口</p> 
<p>分析说明：</p> 
<p>         因为需要实现ListCheckpoint接口，所以source和windows处理代码，单独写成了JAVA类的形似，实现逻辑和验证方法跟manage state相似，但是在如下代码中，Source和Window都实现了ListCheckpoint接口，也就是说，Source抛出异常的时候，Source和Window都将可以从checkpoint中获取历史状态，从而达到不丢失状态的能力。</p> 
<p>代码列表：</p> 
<p>AutoSourceWithCp.java           Source代码</p> 
<p>WindowStatisticWithChk.java     windows apply函数代码</p> 
<p>CheckPointMain.java             主程序，调用</p> 
<p>代码清单：</p> 
<p>AutoSourceWithCp.java</p> 
<p>    package per.test.flink;<br>      <br>     import org.apache.flink.api.common.state.ListState;<br>     import org.apache.flink.api.java.tuple.Tuple4;<br>     import org.apache.flink.streaming.api.checkpoint.ListCheckpointed;<br>     import org.apache.flink.streaming.api.functions.source.RichSourceFunction;<br>     import org.apache.flink.streaming.api.functions.source.SourceFunction;<br>     import per.test.bean.UserState;<br>      <br>      <br>     import java.util.ArrayList;<br>     import java.util.List;<br>     import java.util.Random;<br>      <br>     /**<br>      * Created by betree on 2018/9/13.<br>      */<br>     public class AutoSourceWithCp extends RichSourceFunction&lt;Tuple4&lt;Integer,String,String,Integer&gt;&gt; implements ListCheckpointed&lt;UserState&gt; {<!-- --><br>         private int count = 0;<br>         private boolean is_running = true;<br>      <br>         @Override<br>         public void run(SourceContext sourceContext) throws Exception {<!-- --><br>             Random random = new Random();<br>             while(is_running){<!-- --><br>                 for (int i = 0; i &lt; 10; i++) {<!-- --><br>                     sourceContext.collect(Tuple4.of(1, "hello-" + count, "alphabet", count));<br>                     count++;<br>                 }<br>                 System.out.println("source:"+count);<br>                 Thread.sleep(2000);<br>      <br>                 if(count&gt;100){<!-- --><br>                     throw new Exception("exception made by ourself!");<br>                 }<br>             }<br>         }<br>      <br>         @Override<br>         public void cancel() {<!-- --><br>             is_running = false;<br>         }<br>      <br>         @Override<br>         public List&lt;UserState&gt; snapshotState(long l, long l1) throws Exception {<!-- --><br>             List&lt;UserState&gt; listState= new ArrayList&lt;&gt;();<br>             UserState state = new UserState(count);<br>             listState.add(state);<br>             System.out.println("#############  check point :"+listState.get(0).getCount());<br>             return listState;<br>         }<br>      <br>         @Override<br>         public void restoreState(List&lt;UserState&gt; list) throws Exception {<!-- --><br>      <br>             count = list.get(0).getCount();<br>             System.out.println("AutoSourceWithCp restoreState:"+count);<br>      <br>         }<br>     }</p> 
<p>WindowStatisticWithChk.java</p> 
<p>    package per.test.flink;<br>      <br>     import org.apache.flink.api.java.tuple.Tuple;<br>     import org.apache.flink.api.java.tuple.Tuple4;<br>     import org.apache.flink.streaming.api.checkpoint.ListCheckpointed;<br>     import org.apache.flink.streaming.api.functions.windowing.WindowFunction;<br>     import org.apache.flink.streaming.api.windowing.windows.TimeWindow;<br>     import org.apache.flink.streaming.api.windowing.windows.Window;<br>     import org.apache.flink.util.Collector;<br>     import per.test.bean.UserState;<br>      <br>     import java.util.ArrayList;<br>     import java.util.List;<br>      <br>      <br>     /**<br>      * Created by betree on 2018/9/13.<br>      */<br>     public class WindowStatisticWithChk implements WindowFunction&lt;Tuple4&lt;Integer,String,String,Integer&gt;,Integer,Tuple,TimeWindow&gt; ,ListCheckpointed&lt;UserState&gt; {<!-- --><br>         private int total = 0;<br>         @Override<br>         public List&lt;UserState&gt; snapshotState(long l, long l1) throws Exception {<!-- --><br>      <br>             List&lt;UserState&gt; listState= new ArrayList&lt;&gt;();<br>             UserState state = new UserState(total);<br>             listState.add(state);<br>             return listState;<br>         }<br>      <br>         @Override<br>         public void restoreState(List&lt;UserState&gt; list) throws Exception {<!-- --><br>             total = list.get(0).getCount();<br>         }<br>      <br>         @Override<br>         public void apply(Tuple tuple, TimeWindow timeWindow, Iterable&lt;Tuple4&lt;Integer, String, String, Integer&gt;&gt; iterable, Collector&lt;Integer&gt; collector) throws Exception {<!-- --><br>             int count  =  0;<br>             for(Tuple4&lt;Integer, String, String, Integer&gt; data : iterable){<!-- --><br>                 count++;<br>                 System.out.println("apply key"+tuple.toString()+" count:"+data.f3+"     "+data.f0);<br>             }<br>             total = total+count;<br>            System.out.println("windows  total:"+total+"  count:"+count+"   ");<br>             collector.collect(count);<br>         }<br>     }</p> 
<p>CheckPointMain.java</p> 
<p>    package per.test.flink;<br>      <br>     import org.apache.flink.api.java.tuple.Tuple4;<br>     import org.apache.flink.runtime.state.filesystem.FsStateBackend;<br>     import org.apache.flink.streaming.api.CheckpointingMode;<br>     import org.apache.flink.streaming.api.datastream.DataStream;<br>     import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;<br>     import org.apache.flink.streaming.api.windowing.assigners.SlidingProcessingTimeWindows;<br>     import org.apache.flink.streaming.api.windowing.assigners.TumblingProcessingTimeWindows;<br>     import org.apache.flink.streaming.api.windowing.time.Time;<br>      <br>      <br>     /**<br>      * Created by betree on 2018/9/13.<br>      */<br>     public class CheckPointMain {<!-- --><br>         public static void main(String[] args) throws Exception{<!-- --><br>             StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();<br>             env.setStateBackend(new FsStateBackend("file:///Users/username/Documents/程序数据/Flink/checkpoint/"));<br>             env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);<br>      <br>             env.getCheckpointConfig().setCheckpointInterval(1000);<br>      <br>             DataStream&lt;Tuple4&lt;Integer,String,String,Integer&gt;&gt; data = env.setParallelism(4).addSource(new AutoSourceWithCp());<br>             env.setParallelism(4);<br>             data.keyBy(0)<br>                     .window(TumblingProcessingTimeWindows.of(Time.seconds(2)))<br>                     .apply(new WindowStatisticWithChk())<br>                     .print();<br>      <br>             env.execute();<br>         }<br>     }</p> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4991b3c405c0e483e0df3f228e462047/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python字典数据在循环当中删除元素</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/10702906c0d1a38d90e50570b644c02e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">fgets 函数用法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>