<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>arduino2048小游戏源代码解析（超详细） - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="arduino2048小游戏源代码解析（超详细）" />
<meta property="og:description" content="文章目录 2048游戏规则简要思路游戏界面该如何显示开始界面游戏界面结算界面 代码分析杂项board类属性方法summon方法init方法isOver方法isWon方法isChanged方法getScore方法LeftOne等方法move方法setNum方法updateDisplay方法 getKey函数setup：开机时的准备工作loop：游戏主循环 源代码在上一篇文章里（传送门），此处不放出完整源代码。
本篇代码中用于测试的部分（例如CHEAT宏定义和TEST_MODE宏定义）被移除，以方便讲解。
2048游戏规则 2048游戏棋盘上共有4x4=16个格子，初始时存在两个初始数字，其中一个是2，另一个有30%的几率为4，70%的几率为2。
手指向一个方向滑动，所有格子会向那个方向运动。
相同数字的两个格子，相撞时数字会相加。
每次有效滑动后，空白处会随机刷新出一个格子，有30%的几率为4，70%的几率为2。
当界面不可运动时（当界面全部被数字填满时），游戏结束；当界面中最大数字是2048时，游戏胜利。
简要思路 使用4x4的二维数组模拟2048的游戏棋盘，从左上角(0,0)开始标号：
数组的每个元素就代表此处格子的数字。
用0表示此处没有数字。
游戏界面该如何显示 开始界面 “2048”字样选择了u8g2_font_maniac_tr字体。
“Start”字样选择了u8g2_font_7x14B_mr字体。
游戏界面 屏幕左侧的棋盘大概类似这样：
每个格子里显示一个数字。
可是，翻遍u8g2的字体库，仍找不到一款能显示得开四位数2048并且可读性令我满意的一款字体。
但是，为什么一定要用字体呢？
每个含有数字的格子放一张代表这个数字的位图不也行吗？
我另辟蹊径，用Ps为从2到2048的所有所需数字绘制了14x14大小的位图，通过取字模网站转换为字模，发现显示效果非常不错。
附：绘制的位图（已上传到[github](https://github.com/blackpancake/arduino2048/tree/main/Number model)）：
结算界面 “Game Over”字样和“You Win!”仍然是u8g2_font_maniac_tr字体。
“Your score: xxx”字样是u8g2_font_crox4t_tr字体。
代码分析 杂项 首先是头文件引入，没什么好说的，time.h用于获取时间为随机数提供种子，U8g2lib.h是u8g2库的头文件，用于在LCD12864上绘图。
#include &lt;time.h&gt; #include &lt;U8g2lib.h&gt; 然后是实例化一个u8g2绘图对象，这里由于搭建电路时LCD12864反向摆放，所以画面标志位由原本的U8G2_R0改为U8G2_R2。
10号管脚是CS片选，12号管脚是显示屏的RST复位。（详见上一篇博客）
U8G2_ST7920_128X64_F_HW_SPI u8g2(U8G2_R2, /* CS=*/10, /* reset=*/12); 接下来是Number.h的引入，待会再讲。
#include &#34;Number.h&#34; 接下来是4个方向的轻触按钮所连管脚的宏定义：
#define Up 4 #define Down 5 #define Left 6 #define Right 7 这里定义了一个内联函数int getRand(int a, int b)，作用是获取 [ a , b ] [a,b] [a,b] 之间的一个随机整数。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/e55831dffc750f4f47a936cd4acaf9a5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-18T15:44:55+08:00" />
<meta property="article:modified_time" content="2021-08-18T15:44:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">arduino2048小游戏源代码解析（超详细）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#2048_5" rel="nofollow">2048游戏规则</a></li><li><a href="#_17" rel="nofollow">简要思路</a></li><li><a href="#_28" rel="nofollow">游戏界面该如何显示</a></li><li><ul><li><a href="#_30" rel="nofollow">开始界面</a></li><li><a href="#_38" rel="nofollow">游戏界面</a></li><li><a href="#_60" rel="nofollow">结算界面</a></li></ul> 
  </li><li><a href="#_72" rel="nofollow">代码分析</a></li><li><ul><li><a href="#_74" rel="nofollow">杂项</a></li><li><a href="#board_129" rel="nofollow">board类</a></li><li><ul><li><a href="#_166" rel="nofollow">属性</a></li><li><a href="#_190" rel="nofollow">方法</a></li><li><ul><li><a href="#summon_192" rel="nofollow">summon方法</a></li><li><a href="#init_271" rel="nofollow">init方法</a></li><li><a href="#isOver_293" rel="nofollow">isOver方法</a></li><li><a href="#isWon_334" rel="nofollow">isWon方法</a></li><li><a href="#isChanged_355" rel="nofollow">isChanged方法</a></li><li><a href="#getScore_365" rel="nofollow">getScore方法</a></li><li><a href="#LeftOne_375" rel="nofollow">LeftOne等方法</a></li><li><a href="#move_510" rel="nofollow">move方法</a></li><li><a href="#setNum_639" rel="nofollow">setNum方法</a></li><li><a href="#updateDisplay_721" rel="nofollow">updateDisplay方法</a></li></ul> 
   </li></ul> 
   </li><li><a href="#getKey_788" rel="nofollow">getKey函数</a></li><li><a href="#setup_843" rel="nofollow">setup：开机时的准备工作</a></li><li><a href="#loop_860" rel="nofollow">loop：游戏主循环</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<blockquote> 
 <p>源代码在上一篇文章里（<a href="https://blog.csdn.net/Cykinter/article/details/119758207">传送门</a>），此处不放出完整源代码。</p> 
 <p>本篇代码中用于测试的部分（例如<code>CHEAT</code>宏定义和<code>TEST_MODE</code>宏定义）被移除，以方便讲解。</p> 
</blockquote> 
<h2><a id="2048_5"></a>2048游戏规则</h2> 
<p>2048游戏棋盘上共有4x4=16个格子，初始时存在两个初始数字，其中一个是2，另一个有30%的几率为4，70%的几率为2。</p> 
<ul><li> <p>手指向一个方向滑动，所有格子会向那个方向运动。</p> </li><li> <p>相同数字的两个格子，相撞时数字会相加。</p> </li><li> <p>每次有效滑动后，空白处会随机刷新出一个格子，有30%的几率为4，70%的几率为2。</p> </li><li> <p>当界面不可运动时（当界面全部被数字填满时），游戏结束；当界面中最大数字是2048时，游戏胜利。</p> </li></ul> 
<h2><a id="_17"></a>简要思路</h2> 
<p>使用4x4的二维数组模拟2048的游戏棋盘，从左上角(0,0)开始标号：</p> 
<p><img src="https://images2.imgbox.com/b3/3d/5kU1pvJz_o.png" alt="image-20210817164938259"></p> 
<p>数组的每个元素就代表此处格子的数字。</p> 
<p>用0表示此处没有数字。</p> 
<h2><a id="_28"></a>游戏界面该如何显示</h2> 
<h3><a id="_30"></a>开始界面</h3> 
<p>“2048”字样选择了<code>u8g2_font_maniac_tr</code>字体。</p> 
<p>“Start”字样选择了<code>u8g2_font_7x14B_mr</code>字体。</p> 
<p><img src="https://images2.imgbox.com/9a/aa/ENXUr8qU_o.png" alt="IMG_20210818_155610.jpg_new"></p> 
<h3><a id="_38"></a>游戏界面</h3> 
<p>屏幕左侧的棋盘大概类似这样：</p> 
<p><img src="https://images2.imgbox.com/81/a2/hktq2v6x_o.png" alt="image-20210817224627482"></p> 
<p>每个格子里显示一个数字。</p> 
<p>可是，翻遍<a href="https://github.com/olikraus/u8g2/wiki/fntlistall">u8g2的字体库</a>，仍找不到一款能显示得开四位数2048并且可读性令我满意的一款字体。</p> 
<p>但是，为什么一定要用字体呢？</p> 
<p>每个含有数字的格子放一张代表这个数字的位图不也行吗？</p> 
<p>我另辟蹊径，用Ps为从2到2048的所有所需数字绘制了14x14大小的位图，通过<a href="http://tools.clz.me" rel="nofollow">取字模网站</a>转换为字模，发现显示效果非常不错。</p> 
<blockquote> 
 <p>附：绘制的位图（已上传到[github](https://github.com/blackpancake/arduino2048/tree/main/Number model)）：</p> 
 <p><img src="https://images2.imgbox.com/88/eb/HKtqljQI_o.png" alt="image-20210817225345550"></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/7a/68/8xtYCWb1_o.png" alt="IMG_20210818_155355.jpg_new"></p> 
<h3><a id="_60"></a>结算界面</h3> 
<p>“Game Over”字样和“You Win!”仍然是<code>u8g2_font_maniac_tr</code>字体。</p> 
<p><img src="https://images2.imgbox.com/b2/27/Oz2VoQwe_o.png" alt="IMG_20210818_155521.jpg_new"></p> 
<p><img src="https://images2.imgbox.com/ac/0e/5hBOjMqt_o.png" alt="new"></p> 
<p>“Your score: xxx”字样是<code>u8g2_font_crox4t_tr</code>字体。</p> 
<p><img src="https://images2.imgbox.com/d8/79/sCnrnqYW_o.png" alt="IMG_20210818_155511.jpg_new"></p> 
<h2><a id="_72"></a>代码分析</h2> 
<h3><a id="_74"></a>杂项</h3> 
<p>首先是头文件引入，没什么好说的，<code>time.h</code>用于获取时间为随机数提供种子，<code>U8g2lib.h</code>是u8g2库的头文件，用于在LCD12864上绘图。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;U8g2lib.h&gt;</span></span>
</code></pre> 
<p>然后是实例化一个u8g2绘图对象，这里由于搭建电路时LCD12864反向摆放，所以画面标志位由原本的<code>U8G2_R0</code>改为<code>U8G2_R2</code>。</p> 
<p>10号管脚是CS片选，12号管脚是显示屏的RST复位。（详见上一篇博客）</p> 
<pre><code class="prism language-cpp">U8G2_ST7920_128X64_F_HW_SPI <span class="token function">u8g2</span><span class="token punctuation">(</span>U8G2_R2<span class="token punctuation">,</span> <span class="token comment">/* CS=*/</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">/* reset=*/</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>接下来是<code>Number.h</code>的引入，待会再讲。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Number.h"</span></span>
</code></pre> 
<p>接下来是4个方向的轻触按钮所连管脚的宏定义：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Up</span> <span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Down</span> <span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Left</span> <span class="token expression"><span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Right</span> <span class="token expression"><span class="token number">7</span></span></span>
</code></pre> 
<p>这里定义了一个内联函数<code>int getRand(int a, int b)</code>，作用是获取 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         [ 
        
       
         a 
        
       
         , 
        
       
         b 
        
       
         ] 
        
       
      
        [a,b] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">b</span><span class="mclose">]</span></span></span></span></span> 之间的一个随机整数。</p> 
<p>原理基于c++内置的<code>rand()</code>函数，具体请自行百度。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">getRand</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里定义了四个方向的枚举变量，之后在<code>move</code>函数上会用到。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">enum</span> <span class="token class-name">DIRECTION</span>
<span class="token punctuation">{<!-- --></span>
    LEFT<span class="token punctuation">,</span>
    RIGHT<span class="token punctuation">,</span>
    UP<span class="token punctuation">,</span>
    DOWN
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="board_129"></a>board类</h3> 
<p>接下来就是重头戏了，棋盘类<code>board</code>的定义，待会会分开对每个方法进行分析：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">board</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> map<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> score<span class="token punctuation">;</span>
    <span class="token keyword">using</span> PtrToMemberFunc <span class="token operator">=</span> <span class="token keyword">bool</span> <span class="token punctuation">(</span>board<span class="token operator">::</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    PtrToMemberFunc Moves<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">&amp;</span>board<span class="token operator">::</span>LeftOne<span class="token punctuation">,</span> <span class="token operator">&amp;</span>board<span class="token operator">::</span>RightOne<span class="token punctuation">,</span> <span class="token operator">&amp;</span>board<span class="token operator">::</span>UpOne<span class="token punctuation">,</span> <span class="token operator">&amp;</span>board<span class="token operator">::</span>DownOne<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> changed<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">summon</span><span class="token punctuation">(</span><span class="token keyword">bool</span> noFour <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">isOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">isWon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">isChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> changed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> score<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">LeftOne</span><span class="token punctuation">(</span><span class="token keyword">int</span> ro<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">RightOne</span><span class="token punctuation">(</span><span class="token keyword">int</span> ro<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">UpOne</span><span class="token punctuation">(</span><span class="token keyword">int</span> ro<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">DownOne</span><span class="token punctuation">(</span><span class="token keyword">int</span> ro<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span>DIRECTION di<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">updateDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">setNum</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_166"></a>属性</h4> 
<p>首先来看私有的一些属性：</p> 
<p>模拟地图：</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">int</span> map<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>存分数（这里保险起见，用了long存分数）：</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">long</span> score<span class="token punctuation">;</span>
</code></pre> 
<p>下面的两行先跳过，待会在讲<code>move</code>函数时会讲。</p> 
<p>棋盘是否在移动后被改变了的标志位：</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">bool</span> changed<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_190"></a>方法</h4> 
<h5><a id="summon_192"></a>summon方法</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> board<span class="token operator">::</span><span class="token function">summon</span><span class="token punctuation">(</span><span class="token keyword">bool</span> noFour<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">block</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> x<span class="token punctuation">;</span>
        <span class="token keyword">int</span> y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> blanks<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>blanks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>blanks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                blanks<span class="token punctuation">[</span>ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>i<span class="token punctuation">,</span> j<span class="token punctuation">}</span><span class="token punctuation">;</span>
    block <span class="token operator">&amp;</span>sele <span class="token operator">=</span> blanks<span class="token punctuation">[</span><span class="token function">getRand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ptr <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>noFour<span class="token punctuation">)</span>
        map<span class="token punctuation">[</span>sele<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>sele<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        map<span class="token punctuation">[</span>sele<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>sele<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getRand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法用于在棋盘上空白位置生成一个数字，在开局时和每次有效滑动后被调用。</p> 
<p>在解释方法如何运行之前，先谈谈生成数字的思路吧！</p> 
<p>这里采用的思路是，遍历整个棋盘，将所有空白位置记录下来到队列里，</p> 
<p>然后从队列中随机选取一个空白位置，将棋盘的这个位置放上数字。</p> 
<p>方法内部定义了表示一个空白位置的结构体<code>block</code>，它拥有两个成员，分别记录某个空白格子在棋盘上的坐标，并顺便创建了一个长16的（因为棋盘上最多只可能有16个空白位置）<code>block</code>类型的数组<code>blanks</code>。</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">struct</span> <span class="token class-name">block</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> x<span class="token punctuation">;</span>
        <span class="token keyword">int</span> y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> blanks<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>之后利用<code>memset</code>将队列清零（初始化），并定义了一个用于自增的指针<code>ptr</code>，初始时指向队列首位元素。</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                blanks<span class="token punctuation">[</span>ptr<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>i<span class="token punctuation">,</span> j<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>两个for循环遍历数组，if判断该格是否为空，是则加入队列。</p> 
<p>注意，<code>ptr++</code>实际上是返回现在的<code>ptr</code>之后，再将<code>ptr</code>自增。赋值号右侧是花括号形式的结构体赋值。</p> 
<p>显然，遍历完成之后，<code>ptr</code>指向队尾元素的下一个位置，不难看出，只需要在 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         [ 
        
       
         0 
        
       
         , 
        
       
         p 
        
       
         t 
        
       
         r 
        
       
         − 
        
       
         1 
        
       
         ] 
        
       
      
        [0,ptr-1] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 中随机选择一个整数作为<code>blanks</code>数组的下标，就相当于随机选取了一个空白格。</p> 
<p>于是便有了下面这行代码：</p> 
<pre><code class="prism language-cpp">block <span class="token operator">&amp;</span>sele <span class="token operator">=</span> blanks<span class="token punctuation">[</span><span class="token function">getRand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ptr <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>此处为了节省内存，创建了一个对被选择了的空白格的引用，方便后续从它身上获取数据。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>noFour<span class="token punctuation">)</span>
        map<span class="token punctuation">[</span>sele<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>sele<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        map<span class="token punctuation">[</span>sele<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>sele<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getRand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">;</span>
</code></pre> 
<p>因为我们有“不许生成4”的需求（在开局时有一个初始数字只能为2），所以加入了<code>noFour</code>标志位作为函数的参数，它为<code>true</code>时就代表此时的<code>summon</code>方法不会生成4。</p> 
<p>这里使用了“在1到10之间随机选择一个数看是否大于3”的方法来模拟三七分的生成概率。</p> 
<h5><a id="init_271"></a>init方法</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> board<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token function">memset</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">summon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">summon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此函数对整个棋盘对象进行初始化，在开始游戏和重新游戏时被调用。</p> 
<p>使用<code>memset</code>内置函数对棋盘数组清零后调用两次<code>summon</code>方法生成两个初始数字。</p> 
<p>注意，第二次调用<code>summon</code>时，为了防止出现“双4开局”的情况，将<code>noFour</code>标志位置位。</p> 
<p><code>changed</code>被设为<code>true</code>，以便让游戏主循环调用<code>updateDisplay</code>方法，进行屏幕的首次刷新。</p> 
<h5><a id="isOver_293"></a>isOver方法</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> board<span class="token operator">::</span><span class="token function">isOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> map<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法返回游戏是否结束，每次移动后，游戏主循环就会调用它以检测是否因为这次移动而导致游戏的终结。</p> 
<p>判断思路：</p> 
<p>首先可以肯定的是，对于给定的一个2048游戏局面，只要棋盘上还存在空位，那就说明游戏还没有结束。</p> 
<p>假如没有空位了呢？</p> 
<p>那就检测是否有能够合并的。</p> 
<p>从左上角(0,0)开始遍历，对于某一个格子，若它右侧或者下方有相同的格子，就代表它还可以合并，也代表着游戏还没结束。</p> 
<p>为什么不检测左侧和上方？</p> 
<p>事实上，如果向右滑动棋盘时某个格子会被合并，那么即使向左滑动棋盘，它仍然会被合并，两个滑动方向在这个问题上是等价的。向上向下滑也是同理。因此只检测右侧和下方就够了。</p> 
<p>需要注意的是，为了防止数组越界（例如在棋盘最右边试图寻找更右侧的格子），加入了坐标上的限定。即对于最右侧的格子不检测其右侧，对于最下方的格子不检测其下方。</p> 
<h5><a id="isWon_334"></a>isWon方法</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> board<span class="token operator">::</span><span class="token function">isWon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token number">2048</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法返回游戏是否胜利，即棋盘中是否含有2048这个数字。</p> 
<p>原理很简单，两个for循环遍历棋盘，查找是否存在2048即可。</p> 
<p><code>map[i][j] &gt;= 2048</code>中的<code>&gt;=</code>也可以换成<code>==</code>。</p> 
<h5><a id="isChanged_355"></a>isChanged方法</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">isChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> changed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>内联接口，用于从外部获取<code>changed</code>属性的值。</p> 
<h5><a id="getScore_365"></a>getScore方法</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> score<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>内联接口，用于从外部获取<code>score</code>属性的值。</p> 
<h5><a id="LeftOne_375"></a>LeftOne等方法</h5> 
<blockquote> 
 <p><code>RightOne</code>、<code>UpOne</code>、<code>DownOne</code>等方法与<code>LeftOne</code>方法的代码极其相似，所以此处只放出<code>LeftOne</code>方法的代码。</p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> board<span class="token operator">::</span><span class="token function">LeftOne</span><span class="token punctuation">(</span><span class="token keyword">int</span> ro<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">bool</span> fail <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            nextc<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            fail <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span><span class="token punctuation">;</span>
            map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">==</span> map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            fail <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            score <span class="token operator">+=</span> map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>
            map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">++</span>c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fail<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个方法是2048游戏的核心所在，它负责移动和合并一行（列）的数字。</p> 
<p>在解释方法如何运行之前，先谈谈移动与合并的思路吧！</p> 
<blockquote> 
 <p>此处的逻辑思路参考了<a href="https://blog.csdn.net/weixin_42751067/article/details/81139575">这篇博客</a></p> 
</blockquote> 
<p>不难发现，在向某个方向滑动棋盘时，该方向上的行（列）是互不干扰的。即，对于每行 （列）所进行的操作是相同的。</p> 
<p>因此我们可以把问题规模缩小，缩小到如何在一行（列）上实现移动+合并。</p> 
<p>此处的思路如下（暂时以向左滑动为例）：</p> 
<p><img src="https://images2.imgbox.com/3c/62/QPP2Muf8_o.png" alt="image-20210817185659611"></p> 
<ol><li>首先将c指针指向最左边的元素</li><li>在c的左侧向右寻找第一个非0元素，将nextc指向它（这是第2步）</li><li>如果找到了 
  <ol><li>如果c指向的值是0 
    <ol><li>让nextc和c所指向的格子交换它们的值</li></ol> </li><li>如果c指向的值等于nextc指向的值 
    <ol><li>将c指向的值乘2</li><li>分数加上c指向的值</li><li>将nextc指向的值置0</li></ol> </li><li>c指向下一个元素，若已经完成该行（列）上所有元素的遍历，否则回到第2步</li></ol> </li><li>否则 
  <ol><li>结束过程</li></ol> </li></ol> 
<p>这个过程结束后就能在一行（列）上同时完成移动和合并两大任务。</p> 
<p>对四个行（列）各进行一遍这样的操作，一次棋盘的滑动就完成了。</p> 
<p>讲完思路，再看代码就很容易看懂了。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span>
</code></pre> 
<p>这行代码让c在完成所有元素的遍历后自动退出循环。</p> 
<pre><code class="prism language-cpp">        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            nextc<span class="token operator">++</span><span class="token punctuation">;</span>
</code></pre> 
<p>这些代码让nextc从c的右侧开始寻找非零格，<code>nextc &lt; 4</code>让循环在找不到非零格时自动退出寻找的循环。</p> 
<pre><code class="prism language-cpp">        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<p>这些代码让找不到非零格时退出移动-合并的过程。</p> 
<pre><code class="prism language-cpp">        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            fail <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span><span class="token punctuation">;</span>
            map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">==</span> map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            fail <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            score <span class="token operator">+=</span> map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>
            map<span class="token punctuation">[</span>ro<span class="token punctuation">]</span><span class="token punctuation">[</span>nextc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>和上述的思路基本一一对应，就不解释了。</p> 
<pre><code class="prism language-cpp"><span class="token operator">++</span>c<span class="token punctuation">;</span>
</code></pre> 
<p>这行代码让c指向下一个元素。</p> 
<p>这时你可能会注意，为什么代码里有一个变量<code>fail</code>？</p> 
<p>此时，我们要引入两个概念：<strong>有效移动</strong>和<strong>有效滑动</strong>。</p> 
<p>对于一行（列）来说，如果在进行一次上述的移动-合并操作后，这一次移动-合并操作起了效果（即这一行（列）发生了变化，比如位置移动了，或者发生了合并），那么就称这次移动-合并操作是一次<strong>有效移动</strong>。</p> 
<p>对于一个棋盘来说，如果在对四行（列）分别进行四次上述的移动-合并操作后，棋盘的状态发生了变化，那么就称这四次移动-合并操作是一次<strong>有效滑动</strong>。</p> 
<p>那么，在<code>LeftOne</code>方法里，<code>fail</code>就代表着这次移动-合并操作是否不是一次有效移动，或者更通俗一点，这次移动-合并操作是否失败。</p> 
<p>函数最开始时将<code>fail</code>设为<code>true</code>，在循环中，如果发生移动（<code>if (map[ro][c] == 0)</code>）或合并（<code>else if (map[ro][c] == map[ro][nextc])</code>），就把<code>fail</code>设为<code>false</code>，最后将<code>fail</code>返回。</p> 
<p>需要注意的是，函数的参数<code>ro</code>，表示对第<code>ro</code>行（列）进行移动-合并操作。</p> 
<p>另外，虽然此处只展示了向左的移动-合并操作，但其实其他三个方向的原理也是相同的，此处就不放出代码了。</p> 
<h5><a id="move_510"></a>move方法</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> board<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>DIRECTION di<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">bool</span> fail <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">bool</span> tmp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token operator">*</span>Moves<span class="token punctuation">[</span>di<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fail <span class="token operator">&amp;=</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    changed <span class="token operator">=</span> <span class="token operator">!</span>fail<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fail<span class="token punctuation">)</span>
        <span class="token function">summon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此方法的代码虽短，但也是代码中的关键所在。</p> 
<p>先把<code>fail</code>相关的代码暂时去掉，此时该方法就只剩下两行代码了：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token operator">*</span>Moves<span class="token punctuation">[</span>di<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>没错，这两行就是关键。</p> 
<p>在研究这两行之前，先给出<code>move</code>方法的意义吧：<code>move(X)</code>使棋盘向<code>X</code>方向滑动。这里的<code>X</code>是枚举类型<code>DIRECTION</code>的，这意味着它可以有四个取值：<code>LEFT</code>、<code>RIGHT</code>、<code>UP</code>、<code>DOWN</code>，分别是<code>0</code>、<code>1</code>、<code>2</code>、<code>3</code>的别名。</p> 
<p>要想使棋盘向某个方向滑动，就对四个行（列）分别调用对应的<code>XXXOne</code>方法进行移动-合并操作。</p> 
<p>例如想让整个棋盘向左滑动，就要执行以下代码：</p> 
<pre><code class="prism language-cpp"><span class="token function">LeftOne</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//对第一行进行移动-合并操作。</span>
<span class="token function">LeftOne</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//本行及以下同上</span>
<span class="token function">LeftOne</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">LeftOne</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这太臃肿了！</p> 
<p>你一定会想到用for循环简化：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token function">LeftOne</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>好了，现在向左滑动只需要两行代码了。可是，向右呢，向上向下呢？也要写一遍这样的for循环然后用if根据<code>di</code>判断用哪个吗？</p> 
<p>不行，这太臃肿了，不符合*DRY(Don’t Repeat Yourself)*原则！</p> 
<p>怎样才能让<code>di</code>直接动态的与四个方法联系起来呢？</p> 
<p>用函数指针！</p> 
<p>更确切地，是用成员函数指针数组。</p> 
<p>将四个指向各方向的移动-合并操作方法的指针组织成一个数组，用<code>di</code>作数组的下标就可以实现了。</p> 
<p>于是便有了在前文中提到的：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">using</span> PtrToMemberFunc <span class="token operator">=</span> <span class="token keyword">bool</span> <span class="token punctuation">(</span>board<span class="token operator">::</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PtrToMemberFunc Moves<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">&amp;</span>board<span class="token operator">::</span>LeftOne<span class="token punctuation">,</span> <span class="token operator">&amp;</span>board<span class="token operator">::</span>RightOne<span class="token punctuation">,</span> <span class="token operator">&amp;</span>board<span class="token operator">::</span>UpOne<span class="token punctuation">,</span> <span class="token operator">&amp;</span>board<span class="token operator">::</span>DownOne<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>第一行使用了C++11独有的（没错，arduino<s>部分</s>支持C++11！）<code>using type_New = type_Old</code>的语法来给“指向各方向的移动-合并操作方法的指针”这一类型取了一个别名<code>PtrToMemberFunc</code>。</p> 
<p>此处在<code>*</code>号前加<code>board::</code>是因为成员函数指针前面要有类名的指定否则会编译不过。</p> 
<p>第二行定义了一个长度为<code>4</code>的（因为是4个方向的成员函数嘛）元素类型为<code>PtrToMemberFunc</code>的数组，四个元素初始化为指向四个成员函数的函数指针。</p> 
<p>其实第二行的<code>&amp;board::</code>是可以去掉的，但是会有警告，为了满足强迫症，还是加上了。</p> 
<p>定义完了成员函数指针数组，该怎么用它调用成员函数呢？</p> 
<p>你可能会脱口而出：</p> 
<pre><code class="prism language-cpp">Moves<span class="token punctuation">[</span>di<span class="token punctuation">]</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//i是参数</span>
</code></pre> 
<p>很抱歉，编译失败。</p> 
<p>然后，你可能会抱着试一试的心态敲下：</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">(</span><span class="token operator">*</span>Moves<span class="token punctuation">[</span>di<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//i是参数</span>
</code></pre> 
<p>很抱歉，编译失败。</p> 
<p>经过一番尝试和查阅资料，真相终于大白：</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token operator">*</span>Moves<span class="token punctuation">[</span>di<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>为什么这里会有<code>this-&gt;</code>？说实话，我也不知道，但是加上就编译成功了（摊手）。</p> 
<p>无论如何，<code>move</code>方法的核心两行代码终于理解了：</p> 
<p>对于棋盘的每一行（列），根据传入的方向参数<code>di</code>，调用对应方向的移动-合并操作方法。</p> 
<p>接下来就是<code>move</code>方法中的<code>fail</code>了。</p> 
<p>这里的<code>fail</code>的意义和移动-合并操作方法中的<code>fail</code>意义差不多，但又有所区别，它代表着这次对棋盘的滑动是否不是一次棋盘上的有效滑动，或者更通俗一点，这次滑动是否失败。</p> 
<p>再来想一下，已知四个行（列）上的移动-合并是否失败，能否得出整次滑动是否失败？</p> 
<p>容易得出，除非四个行（列）上的移动-合并全部失败才算失败，只要有一行（列）成功，就算成功。</p> 
<p>也就是说，将四次移动-合并的返回值全部进行<code>&amp;</code>与操作，得到的结果就是整次滑动是否失败。</p> 
<p><code>fail</code>的初始值只能是<code>1</code>，毕竟如果是<code>0</code>的话，无论再<code>&amp;</code>与多少个<code>1</code>，结果还是<code>0</code>，这肯定不是我们想要的。</p> 
<p>另外，因为每次移动（调用<code>move</code>方法）都存在使棋盘局面改变的可能~~（这不废话吗？）~~，因此我们需要在滑动未失败时（<code>fail==0</code>）将<code>changed</code>置位。</p> 
<p>比<code>if(fail==0) changed=1;</code>更简洁的写法是<code>changed=!fail;</code>，所以这里采用了后者。</p> 
<p>另外，根据游戏规则，我们需要在滑动未失败时（<code>fail==0</code>），在空白处生成新数字，这点需要注意。</p> 
<h5><a id="setNum_639"></a>setNum方法</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> board<span class="token operator">::</span><span class="token function">setNum</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> num <span class="token operator">=</span> map<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawXBMP</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> a <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">+</span> b <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token function">GET_NUM_DATA</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法用于将棋盘给定位置的数字在屏幕上绘制出来。</p> 
<p><code>setNum(a,b)</code>将会在屏幕上的对应位置绘制出<code>map[a][b]</code>里的数字。</p> 
<p>在讲解该方法之前，我们需要先看一下<code>Number.h</code>的内容：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_NUMBER_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_NUMBER_H</span></span>
<span class="token comment">// width: 14, height: 14</span>
<span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> NUMs<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> U8X8_PROGMEM <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0xf3</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x3e</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x3e</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x3e</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x2e</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x2e</span><span class="token punctuation">,</span> <span class="token number">0xfd</span><span class="token punctuation">,</span> <span class="token number">0x2e</span><span class="token punctuation">,</span> <span class="token number">0xfd</span><span class="token punctuation">,</span> <span class="token number">0x2e</span><span class="token punctuation">,</span> <span class="token number">0xfd</span><span class="token punctuation">,</span> <span class="token number">0x2e</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0xdd</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0xdd</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0xdd</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0xc1</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x19</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x19</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x7b</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0x7b</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0x7b</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0x1b</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x1b</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0xdb</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0xdb</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0xdb</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0xd7</span><span class="token punctuation">,</span> <span class="token number">0x3d</span><span class="token punctuation">,</span> <span class="token number">0xd7</span><span class="token punctuation">,</span> <span class="token number">0x3d</span><span class="token punctuation">,</span> <span class="token number">0xd7</span><span class="token punctuation">,</span> <span class="token number">0x3d</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x7d</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0x7d</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0x7d</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">,</span> <span class="token number">0x7d</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0x7d</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0x7d</span><span class="token punctuation">,</span> <span class="token number">0x2f</span><span class="token punctuation">,</span> <span class="token number">0x71</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">,</span> <span class="token number">0x71</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x3b</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x3b</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x3b</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0x31</span><span class="token punctuation">,</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xe3</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xe3</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xe7</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xe7</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xfb</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xfb</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0xdb</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xdb</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xc3</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GET_NUM_DATA</span><span class="token expression"><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">(</span>NUMs<span class="token punctuation">[</span><span class="token function">__builtin_ctz</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// _NUMBER_H</span></span>

</code></pre> 
<p><code>Number.h</code>定义了一个二维数组，用于存放从2到2048十一个游戏里会用到的数字的字模。</p> 
<p>正如前文所提到的，程序采用绘制位图字模的方式来显示一个含有数字的格子。</p> 
<p>为了方便动态地取出字模数据，需要使用二维数组存放字模数据。</p> 
<p>这样，<code>NUMs[0]</code>就是指向存放<code>2</code>的字模数据数组的指针（没错，一个指向数组的指针）。</p> 
<p>同理，<code>NUMs[1]</code>可以取出<code>4</code>的字模数据，<code>NUMs[10]</code>可以取出<code>2048</code>的字模数据……</p> 
<p>但是，我们从棋盘上得知的是该格子包含的数字，例如<code>2</code>、<code>16</code>、<code>512</code>这样的整数，怎么才能把它们转换成二维数组的第一维的下标呢？</p> 
<p>换句话说，怎么才能把序列 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         2 
        
       
         , 
        
       
         4 
        
       
         , 
        
       
         8 
        
       
         , 
        
       
         16 
        
       
         , 
        
       
         ⋯ 
         
       
         , 
        
       
         1024 
        
       
         , 
        
       
         2048 
        
       
      
        2,4,8,16,\cdots,1024,2048 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83888em; vertical-align: -0.19444em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mord">6</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">4</span><span class="mord">8</span></span></span></span></span> 映射为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         0 
        
       
         , 
        
       
         1 
        
       
         , 
        
       
         2 
        
       
         , 
        
       
         3 
        
       
         , 
        
       
         … 
        
       
         , 
        
       
         9 
        
       
         , 
        
       
         10 
        
       
      
        0,1,2,3,\ldots,9,10 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.83888em; vertical-align: -0.19444em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mord">0</span></span></span></span></span> 这个序列呢？</p> 
<p>显然可以用对数运算。假如我们想要绘制数字 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
      
        x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">x</span></span></span></span></span> 的字模，则 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           log 
          
         
           ⁡ 
          
         
        
          2 
         
        
       
         x 
        
       
         − 
        
       
         1 
        
       
      
        \log_2x-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.93858em; vertical-align: -0.24414em;"></span><span class="mop"><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.206968em;"><span class="" style="top: -2.45586em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.24414em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span> 就是它在<code>NUMs</code>数组第一维的下标。</p> 
<p>事实上，有一个比对数运算更高效的方法：</p> 
<p><s>avr</s>gcc编译器有一个内建函数<code>__built_in_ctz</code>，<code>__built_in_ctz(p)</code>返回<code>p</code>在二进制下尾随零的个数，如果<code>p</code>只取2的幂，那么它和 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
         
         
           log 
          
         
           ⁡ 
          
         
        
          2 
         
        
       
         x 
        
       
      
        \log_2x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.93858em; vertical-align: -0.24414em;"></span><span class="mop"><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.206968em;"><span class="" style="top: -2.45586em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.24414em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">x</span></span></span></span></span>的结果是一样的。</p> 
<p>所以就有了<code>Number.h</code>中的宏定义：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GET_NUM_DATA</span><span class="token expression"><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">(</span>NUMs<span class="token punctuation">[</span><span class="token function">__builtin_ctz</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span></span>
</code></pre> 
<p><code>GET_NUM_DATA(num)</code>返回指向存放<code>num</code>这个数字对应的字模数据的数组的指针。</p> 
<p>于是就有了以下的绘制语句：</p> 
<pre><code class="prism language-cpp">u8g2<span class="token punctuation">.</span><span class="token function">drawXBMP</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> a <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">+</span> b <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token function">GET_NUM_DATA</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>drawXBMP</code>方法的前两个参数分别是要绘制出的位图的左上角的坐标，因为正如前文所提到的，棋盘上一个空格的大小是14x14，所以可以用<code>map</code>数组下标<code>a</code>和<code>b</code>推算偏移值从而得知坐标。</p> 
<p>之后的两个参数是位图的长宽，在这里是一个空格的大小14x14。</p> 
<p>之后就是上文中的<code>GET_NUM_DATA</code>，根据<code>num</code>获取其字模数据。</p> 
<p>需要注意的是，为了节省RAM，将存字模的二维数组用<code>U8X8_PROGMEM</code>（其实用<code>PROGMEM</code>宏也是一样的，因为<code>U8X8_PROGMEM</code>是<code>PROGMEM</code>宏的别名）存入了PROGMEM里，所以绘制字模是使用的是支持PROGMEM的<code>drawXBMP</code>而不是<code>drawXBM</code>。</p> 
<h5><a id="updateDisplay_721"></a>updateDisplay方法</h5> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> board<span class="token operator">::</span><span class="token function">updateDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8g2<span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    u8g2<span class="token punctuation">.</span><span class="token function">drawFrame</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawHLine</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawHLine</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawHLine</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawVLine</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawVLine</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawVLine</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span>u8g2_font_crox4t_tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token string">"Score:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> score_str<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">itoa</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> score_str<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> score_str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">setNum</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">sendBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方法负责按照<code>map</code>数组的内容在LCD12864上绘制（更新）棋盘，同时更新分数。</p> 
<p>棋盘的边框是由一个空心矩形内部画上横三竖三的直线形成的。</p> 
<pre><code class="prism language-cpp">    u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token string">"Score:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> score_str<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">itoa</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> score_str<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> score_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这是负责更新分数的部分，首先绘制“Score:”字样，然后创建了一个局部变量的数组用于缓存<code>itoa</code>方法转换出的字符串数据。</p> 
<p><code>itoa</code>内置函数将整数在给定进制下转换为字符串形式。</p> 
<p>第一个参数是要转换的整数，在这里是分数。</p> 
<p>第二个参数是转换结果的缓冲区。</p> 
<p>第三个参数是整数的进制，这里当然需要使用10进制。</p> 
<p>虽然<code>itoa</code>是非标准的，但arduino还是支持了。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">setNum</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>两个for循环用于遍历棋盘，对于非空的格子，调用<code>setNum</code>方法将其绘制出来。</p> 
<p>需要注意的是，由于屏幕的绘制模式采用的是<code>full_buffer</code>模式，所以对屏幕的每一次更新都要放在两句代码之间，两句代码的意义从字面也不难看出：</p> 
<pre><code class="prism language-cpp">u8g2<span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
u8g2<span class="token punctuation">.</span><span class="token function">sendBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="getKey_788"></a>getKey函数</h3> 
<pre><code class="prism language-cpp"><span class="token keyword">char</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">digitalRead</span><span class="token punctuation">(</span>Up<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Down<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Left<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
    <span class="token keyword">bool</span> U <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Up<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> D <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Down<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> L <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> R <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">digitalRead</span><span class="token punctuation">(</span>Up<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Down<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Left<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>D<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">'d'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>L<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">'w'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>R<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">'s'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">'x'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该函数独立于board类，用于阻塞地获取玩家点击的按钮方向。</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">digitalRead</span><span class="token punctuation">(</span>Up<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Down<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Left<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
</code></pre> 
<p>这行代码意思是“持续等待，直到四个方向的按钮中任意一个被按下”。</p> 
<p>因为是阻塞式地获取，所以在发生按按钮事件之前需要一直等待下去。</p> 
<p>当按下按钮的事件发生，就用四个变量缓存一下当前四个按钮的按下与否。</p> 
<p>切忌不能此时就返回结果，因为如果这样会造成玩家一直按着就会一直发生移动，而我们期望的行为是“在玩家松开按钮后再进行移动”，于是就有了下面的代码：</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">digitalRead</span><span class="token punctuation">(</span>Up<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Down<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Left<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
</code></pre> 
<p>这行代码意思是“持续等待，直到四个方向的按钮全部松开”。</p> 
<p>当松开的事件发生后，就可以返回结果了。</p> 
<p>因为LCD12864是反向摆放，所以需要进行反转和镜像，所以加入一个中间层（wasd）用来抹除屏幕旋转带来的方向改变。</p> 
<p>需要注意的是，不同的按钮电路连接也会造成该层UDLR和wasd的对应关系不同，所以实际制作时需要在这个地方反复调试直到方向对应正确为止。</p> 
<p><code>return 'x'</code>是可以去掉的，只是保险起见加上，换成别的除wasd以外的字符也可以。</p> 
<h3><a id="setup_843"></a>setup：开机时的准备工作</h3> 
<pre><code class="prism language-cpp">board Game<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">analogRead</span><span class="token punctuation">(</span>A0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在实例化了一个board类的对象<code>Game</code>后，接下来就是熟悉的、每个arduino程序都有的函数——setup函数了。</p> 
<p><code>srand</code>用于设定接下来随机数序列的种子，这里就用到了<code>time.h</code>里的<code>time</code>函数获取时间戳，同时为了增加随机数的随机性，把时间和<code>analogRead</code>读取一个未<code>pinMode</code>设置过的、悬空的模拟端口得到的数字（具体数字主要受环境中的电磁噪声影响）加在了一起。</p> 
<p>然后调用了u8g2<code>begin</code>方法进行了绘图库的初始化。</p> 
<h3><a id="loop_860"></a>loop：游戏主循环</h3> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8g2<span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span>u8g2_font_maniac_tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">"2048"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span>u8g2_font_7x14B_mr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token string">"Start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawFrame</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">sendBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Game<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>Game<span class="token punctuation">.</span><span class="token function">isOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Game<span class="token punctuation">.</span><span class="token function">isWon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Game<span class="token punctuation">.</span><span class="token function">isChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            Game<span class="token punctuation">.</span><span class="token function">updateDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> cmd <span class="token operator">=</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token string">'w'</span><span class="token operator">:</span>
            Game<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'a'</span><span class="token operator">:</span>
            Game<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'s'</span><span class="token operator">:</span>
            Game<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'d'</span><span class="token operator">:</span>
            Game<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>RIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    Game<span class="token punctuation">.</span><span class="token function">updateDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span>u8g2_font_maniac_tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Game<span class="token punctuation">.</span><span class="token function">isWon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">"You"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">,</span> <span class="token string">"Win!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">"Game"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">,</span> <span class="token string">"Over"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    u8g2<span class="token punctuation">.</span><span class="token function">sendBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span>u8g2_font_crox4t_tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> score_str<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">itoa</span><span class="token punctuation">(</span>Game<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> score_str<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token string">"Your score:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">drawStr</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> score_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8g2<span class="token punctuation">.</span><span class="token function">sendBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>众所周知，arduino的loop函数会不断地重复执行下去。在本程序中，loop的一次重复，就是一个完整的游戏生命周期，从开始界面到结算界面。</p> 
<p>首先夹在<code>u8g2.clearBuffer();</code>和<code>u8g2.sendBuffer();</code>中的是开始界面的绘制，没什么好说的，主要是边框的绘制一定要放在“Start”字样的绘制之后，否则“Start”字样字体的透明像素会覆盖掉边框的一部分，让边框出现一个豁口。</p> 
<p>之后的一次丢弃返回值的<code>getKey</code>函数的调用是为了模拟“按任意键开始”的效果，它是阻塞的，也就是说在按下任意键之前将会一直停留在开始界面。</p> 
<p>之后调用<code>Game</code>对象的<code>init</code>方法，进行棋盘和游戏数据的初始化。</p> 
<p>接下来是一个较大的while循环：</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>Game<span class="token punctuation">.</span><span class="token function">isOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Game<span class="token punctuation">.</span><span class="token function">isWon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Game<span class="token punctuation">.</span><span class="token function">isChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            Game<span class="token punctuation">.</span><span class="token function">updateDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> cmd <span class="token operator">=</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token string">'w'</span><span class="token operator">:</span>
            Game<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'a'</span><span class="token operator">:</span>
            Game<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'s'</span><span class="token operator">:</span>
            Game<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'d'</span><span class="token operator">:</span>
            Game<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>RIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>每次运行循环中的内容前都会先检测是否终局或者获胜，游戏没有结束的话，就判断棋盘状态是否变更，若是，则更新棋盘的绘制。</p> 
<p>之后阻塞地获取玩家按下的按钮，存入<code>cmd</code>变量中。</p> 
<p>switch语句对于不同的中间层（wasd）数据对应地改变<code>move</code>方法的参数并调用。</p> 
<p>等到while循环退出之后，就说明游戏结束了（终局或获胜），此时开始结算。</p> 
<p>需要注意的是，在开始结算之前，需要再次更新一次棋盘绘制，否则玩家无法看见死亡时棋盘的状态。</p> 
<p>2秒后进入结算页面，首先根据是否获胜显示对应的语句（“GameOver”或“YouWin!”）。</p> 
<p>1.5秒之后显示分数，逻辑和更新棋盘绘制时的逻辑显示，就不赘述了。</p> 
<p>再过2秒，loop函数返回，进入新的一次游戏生命周期。</p> 
<p>至此，Arduino2048游戏的实现逻辑已全部讲述完毕。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4ac15ed51d2df4e0796606d451a8cbfd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">阿里云oss文件分片、断点续传上传</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/abb42e71762b123a8f9d4c0d9b7ce65d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">什么是ELK（小白简单快速的认识什么是ELK）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>