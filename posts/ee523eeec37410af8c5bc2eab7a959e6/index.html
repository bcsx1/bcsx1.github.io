<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>èŠé€spring @Configurationé…ç½®ç±» - ç¼–ç¨‹éšæƒ³</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="èŠé€spring @Configurationé…ç½®ç±»" />
<meta property="og:description" content="æœ¬ç« èŠ‚æˆ‘ä»¬æ¥æ¢ç´¢Springä¸­ä¸€ä¸ªå¸¸ç”¨çš„æ³¨è§£@Configurationã€‚æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹è¯¥æ³¨è§£çš„ä½œç”¨æ˜¯ï¼šç”¨æ¥å®šä¹‰å½“å‰ç±»ä¸ºé…ç½®ç±»ã€‚
é‚£å•¥æ˜¯é…ç½®ç±»å•Šï¼Œæœ‰å•¥ç”¨å•Šã€‚è¿™ä¸ªæˆ‘ä»¬å¾—ç»“åˆå®é™…ä½¿ç”¨åœºæ™¯æ¥è¯´ï¼Œé€šå¸¸æƒ…å†µä¸‹ã€‚åŠ äº†@Configurationçš„é…ç½®ç±»å†…éƒ¨ï¼Œéƒ½ä¼šåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª@Beanæ³¨è§£çš„æ–¹æ³•ã€‚
ä¸ºäº†ç®€åŒ–å®šä¹‰ï¼Œåœ¨åç»­æˆ‘ä»¬ç§°@Beanæ³¨è§£çš„æ–¹æ³•ä¸ºå·¥å‚æ–¹æ³•ã€‚
é…ç½®ç±»çš„å¥¥ç§˜å°±åœ¨è¿™é‡Œï¼ŒSpringä¼šä¿è¯å¤šæ¬¡è°ƒç”¨@Beanæ ‡æ³¨çš„å·¥å‚æ–¹æ³•ï¼Œä¸ä¼šé‡å¤äº§ç”Ÿæ–°çš„å¯¹è±¡ï¼Œå§‹ç»ˆæ˜¯åŒä¸€ä¸ªï¼Œè¿™ä¹Ÿè´¯å½»äº†Springçš„å•ä¾‹å“²å­¦ã€‚
å¤šæ¬¡è°ƒç”¨åˆ›å»ºæ–¹æ³•ï¼Œäº§ç”Ÿçš„ç«Ÿç„¶æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™è²Œä¼¼è¿èƒŒäº†ç¼–ç¨‹çš„åŸºç¡€åŸç†ã€‚æ€ä¹ˆå¯èƒ½ğŸ˜±ï¼Œä¸€å®šæ˜¯Springåšäº†ä»€ä¹ˆï¼Œé‚£å°±è·Ÿéšç€è´°å¸ˆå…„çš„è„šæ­¥ä¸€èµ·è§£å¼€@Configurationçš„ç¥ç§˜é¢çº±å§ã€‚
è¿™é‡Œå¤§å®¶å¾ˆå®¹æ˜“äº§ç”Ÿä¸€ä¸ªè¯¯è§£ï¼Œè®¤ä¸ºåªæœ‰åœ¨åŠ äº†@Configurationçš„é…ç½®ç±»ä¸­ï¼Œä½¿ç”¨@Beanï¼Œæ‰èƒ½å°†è‡ªå®šä¹‰åˆ›å»ºçš„å¯¹è±¡æ”¾å…¥Springå®¹å™¨ä¸­ã€‚å…¶å®ä¸ç„¶ï¼Œåœ¨Springä¸­ï¼šä¸‡ç‰©çš†ä¸ºé…ç½®ç±»ã€‚åœ¨ä»»ä½•èƒ½å¤Ÿè¢«Springç®¡ç†çš„ç±»(æ¯”å¦‚åŠ äº†@Componentçš„ç±»)ä¸­ï¼Œå®šä¹‰@Beanæ–¹æ³•ï¼Œéƒ½èƒ½å°†è‡ªå®šä¹‰å¯¹è±¡æ”¾å…¥åˆ°Springå®¹å™¨ï¼Œ@Beanæœ¬èº«çš„èƒ½åŠ›å’Œ@Configurationæ— å…³å“¦ã€‚
1. @Configurationçš„ä½œç”¨ æˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ï¼Œçœ‹ä¸€ä¸‹@Configurationçš„ä½œç”¨ã€‚
éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼š@Configurationç»§æ‰¿äº†@Componentï¼Œè¿™æ„å‘³ç€@Configurationæ‹¥æœ‰@Componentçš„å…¨éƒ¨åŠŸèƒ½ï¼Œè¿™ä¹Ÿæ­£æ˜¯åªåŠ @Configurationï¼Œä¹Ÿèƒ½è¢«Springæ‰«æå¹¶å¤„ç†çš„åŸå› ã€‚
æƒ…å†µä¸€ï¼šè¢«@Componentæ ‡è¯† @Component public class MarkedByComponent { @Bean public A a(){ return new A(); } @Bean public B b(){ a(); return new B(); } } // è¾“å‡ºä¿¡æ¯ï¼š // A created... // A created... // B created... å¤åˆ¶ä»£ç  æƒ…å†µäºŒï¼šè¢«@Configurationæ ‡è¯† @Configuration public class MarkedByConfiguration { @Bean public A a(){ return new A(); } @Bean public B b(){ a(); return new B(); } } // è¾“å‡ºä¿¡æ¯ï¼š // A created." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/ee523eeec37410af8c5bc2eab7a959e6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-30T14:20:08+08:00" />
<meta property="article:modified_time" content="2023-01-30T14:20:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹éšæƒ³" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹éšæƒ³</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">èŠé€spring @Configurationé…ç½®ç±»</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>â€ƒæœ¬ç« èŠ‚æˆ‘ä»¬æ¥æ¢ç´¢Springä¸­ä¸€ä¸ªå¸¸ç”¨çš„æ³¨è§£<code>@Configuration</code>ã€‚æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹è¯¥æ³¨è§£çš„ä½œç”¨æ˜¯ï¼š<code>ç”¨æ¥å®šä¹‰å½“å‰ç±»ä¸ºé…ç½®ç±»</code>ã€‚</p> 
<p>â€ƒé‚£å•¥æ˜¯é…ç½®ç±»å•Šï¼Œæœ‰å•¥ç”¨å•Šã€‚è¿™ä¸ªæˆ‘ä»¬å¾—ç»“åˆå®é™…ä½¿ç”¨åœºæ™¯æ¥è¯´ï¼Œé€šå¸¸æƒ…å†µä¸‹ã€‚åŠ äº†<code>@Configuration</code>çš„é…ç½®ç±»å†…éƒ¨ï¼Œéƒ½ä¼š<code>åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª@Beanæ³¨è§£çš„æ–¹æ³•</code>ã€‚</p> 
<blockquote> 
 <p>ä¸ºäº†ç®€åŒ–å®šä¹‰ï¼Œåœ¨åç»­æˆ‘ä»¬ç§°@Beanæ³¨è§£çš„æ–¹æ³•ä¸ºå·¥å‚æ–¹æ³•ã€‚</p> 
</blockquote> 
<p>â€ƒé…ç½®ç±»çš„å¥¥ç§˜å°±åœ¨è¿™é‡Œï¼ŒSpringä¼šä¿è¯å¤šæ¬¡è°ƒç”¨@Beanæ ‡æ³¨çš„å·¥å‚æ–¹æ³•ï¼Œ<code>ä¸ä¼šé‡å¤äº§ç”Ÿæ–°çš„å¯¹è±¡ï¼Œå§‹ç»ˆæ˜¯åŒä¸€ä¸ª</code>ï¼Œè¿™ä¹Ÿè´¯å½»äº†Springçš„å•ä¾‹å“²å­¦ã€‚</p> 
<p>â€ƒå¤šæ¬¡è°ƒç”¨åˆ›å»ºæ–¹æ³•ï¼Œäº§ç”Ÿçš„ç«Ÿç„¶æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™è²Œä¼¼è¿èƒŒäº†ç¼–ç¨‹çš„åŸºç¡€åŸç†ã€‚æ€ä¹ˆå¯èƒ½ğŸ˜±ï¼Œä¸€å®šæ˜¯Springåšäº†ä»€ä¹ˆï¼Œé‚£å°±è·Ÿéšç€è´°å¸ˆå…„çš„è„šæ­¥ä¸€èµ·è§£å¼€<code>@Configuration</code>çš„ç¥ç§˜é¢çº±å§ã€‚</p> 
<blockquote> 
 <p>è¿™é‡Œå¤§å®¶å¾ˆå®¹æ˜“äº§ç”Ÿä¸€ä¸ªè¯¯è§£ï¼Œè®¤ä¸ºåªæœ‰åœ¨åŠ äº†@Configurationçš„é…ç½®ç±»ä¸­ï¼Œä½¿ç”¨@Beanï¼Œæ‰èƒ½å°†è‡ªå®šä¹‰åˆ›å»ºçš„å¯¹è±¡æ”¾å…¥Springå®¹å™¨ä¸­ã€‚å…¶å®ä¸ç„¶ï¼Œåœ¨Springä¸­ï¼š<strong>ä¸‡ç‰©çš†ä¸ºé…ç½®ç±»</strong>ã€‚<code>åœ¨ä»»ä½•èƒ½å¤Ÿè¢«Springç®¡ç†çš„ç±»</code>(æ¯”å¦‚åŠ äº†@Componentçš„ç±»)ä¸­ï¼Œ<code>å®šä¹‰@Beanæ–¹æ³•ï¼Œéƒ½èƒ½å°†è‡ªå®šä¹‰å¯¹è±¡æ”¾å…¥åˆ°Springå®¹å™¨ï¼Œ@Beanæœ¬èº«çš„èƒ½åŠ›å’Œ@Configurationæ— å…³å“¦</code>ã€‚</p> 
</blockquote> 
<h2>1. @Configurationçš„ä½œç”¨</h2> 
<p>â€ƒæˆ‘ä»¬å…ˆé€šè¿‡ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ï¼Œçœ‹ä¸€ä¸‹@Configurationçš„ä½œç”¨ã€‚</p> 
<blockquote> 
 <p>éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼š<code>@Configurationç»§æ‰¿äº†@Component</code>ï¼Œè¿™æ„å‘³ç€@Configurationæ‹¥æœ‰@Componentçš„å…¨éƒ¨åŠŸèƒ½ï¼Œè¿™ä¹Ÿæ­£æ˜¯åªåŠ @Configurationï¼Œä¹Ÿèƒ½è¢«Springæ‰«æå¹¶å¤„ç†çš„åŸå› ã€‚</p> 
</blockquote> 
<ul><li><strong>æƒ…å†µä¸€ï¼šè¢«@Componentæ ‡è¯†</strong></li></ul> 
<pre><code>@Component
public class MarkedByComponent {
    @Bean
    public A a(){
        return new A();
    }

    @Bean
    public B b(){
        a();
        return new B();
    }
}

// è¾“å‡ºä¿¡æ¯ï¼š
// A created...
// A created...
// B created...
å¤åˆ¶ä»£ç </code></pre> 
<ul><li><strong>æƒ…å†µäºŒï¼šè¢«@Configurationæ ‡è¯†</strong></li></ul> 
<pre><code>@Configuration
public class MarkedByConfiguration {
    @Bean
    public A a(){
        return new A();
    }

    @Bean
    public B b(){
        a();
        return new B();
    }
}

// è¾“å‡ºä¿¡æ¯ï¼š
// A created...
// B created...
å¤åˆ¶ä»£ç </code></pre> 
<ul><li><strong>ç»“è®º</strong><br> â€ƒé€šè¿‡ä¸Šè¿°è¾“å‡ºæˆ‘ä»¬å‘ç°ï¼šåœ¨å¤šæ¬¡è°ƒç”¨a()çš„æƒ…å†µä¸‹ï¼Œè¢«@Componentæ ‡è¯†çš„ç±»ï¼ŒAä¼šè¢«åˆ›å»ºå¤šæ¬¡ã€‚è€Œè¢«@Configurationæ ‡è¯†çš„é…ç½®ç±»ï¼ŒAåªä¼šè¢«åˆ›å»ºä¸€æ¬¡ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥å¤§èƒ†çŒœæµ‹ï¼š<code>åœ¨@Configurationæ ‡è¯†çš„é…ç½®ç±»ä¸­ï¼Œé‡å¤è°ƒç”¨@Beanæ ‡è¯†çš„å·¥å‚æ–¹æ³•ï¼ŒSpringä¼šå¯¹åˆ›å»ºçš„å¯¹è±¡è¿›è¡Œç¼“å­˜ã€‚ä»…åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨æ—¶ï¼Œæ‰ä¼šé€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»ºå¯¹è±¡ã€‚åç»­é‡å¤è°ƒç”¨å·¥å‚æ–¹æ³•åˆ›å»ºå¯¹è±¡ï¼Œå…ˆå»ç¼“å­˜ä¸­æ‰¾ï¼Œä¸ç›´æ¥åˆ›å»ºå¯¹è±¡</code>ã€‚</li></ul> 
<blockquote> 
 <p>è¿™é‡Œå°ä¼™ä¼´å¯èƒ½æœ‰ä¸ªç–‘æƒ‘ï¼Œa()åªåœ¨b()è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸ºä»€ä¹ˆè¯´å¤šæ¬¡å‘¢ï¼Œå…¶å®é™¤äº†åœ¨b()ä¸­å£°æ˜å¼è°ƒç”¨ï¼Œç”±äºa()è¢«@Beanæ ‡è¯†ï¼ŒSpringä¹Ÿä¼šä¸»åŠ¨è°ƒç”¨ä¸€æ¬¡çš„å“¦ã€‚</p> 
</blockquote> 
<h2>2. @Configurationçš„åŸç†åˆ†æ</h2> 
<p>â€ƒä¸Šä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ï¼Œäº†è§£@Configurationçš„ä½œç”¨ï¼š<code>ä½¿@Beanæ ‡è¯†çš„å·¥å‚æ–¹æ³•ï¼Œä¸ä¼šé‡å¤åˆ›å»ºbeanå¯¹è±¡</code>ã€‚åŒæ—¶ä¹Ÿå¤§èƒ†çŒœæµ‹äº†ï¼ŒSpringå¯¹@Configurationæ ‡è¯†çš„é…ç½®ç±»ï¼Œåšäº†ç¼“å­˜å¤„ç†ï¼Œä»è€Œè®©@Beanå·¥å‚æ–¹æ³•ï¼Œæœ‰äº†<code>"å¹‚ç­‰çš„èƒ½åŠ›"</code>ã€‚æœ¬ç« èŠ‚æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ä¸€ä¸‹ï¼Œè¿™ä¸ªå¢å¼ºçš„ç¼“å­˜é€»è¾‘ï¼Œæ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿ</p> 
<p>â€ƒ è¦å¯¹ä¸€ä¸ªç±»çš„åŠŸèƒ½è¿›è¡Œå¢å¼ºã€‚<strong><code>ä»£ç†</code></strong> è¿™ä¸ªè¯æ˜¯ä¸æ˜¯å·²ç»åœ¨è„‘æµ·ä¸­å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œæ˜¯çš„ï¼Œå°±æ˜¯ä»£ç†ã€‚Springå¯¹@Configurationæ ‡è¯†çš„ç±»åšäº†ä»£ç†ï¼Œä»è€Œè¿›è¡ŒåŠŸèƒ½çš„å¢å¼ºã€‚</p> 
<p>â€ƒå½“ç„¶ï¼Œç°åœ¨æˆ‘ä»¬ç¦»ç›´æ¥åˆ†æä»£ç†åŠŸèƒ½è¿˜æœ‰ç‚¹é¥è¿œï¼Œæ¯•ç«Ÿæ­¥å­ä¸èƒ½è¿ˆçš„å¤ªå¤§ï¼Œä¸ç„¶å®¹æ˜“æ‰¯ç€è›‹ã€‚ä¸€æ­¥æ­¥æ¥ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆçœ‹çœ‹Springæ˜¯å¦‚ä½•è§£æ@Configurationæ³¨è§£çš„ï¼Œæ¯•ç«Ÿéœ€è¦å…ˆæ‰¾å‡ºæ¥ï¼Œæ‰èƒ½ä»£ç†å¢å¼ºå˜›ã€‚</p> 
<h3>2.1 @Configurationè§£æ</h3> 
<p>â€ƒ å¯¹@Configurationçš„è§£æè¿‡ç¨‹æ˜¯åœ¨<code>springæ‰«æç±»çš„æ—¶å€™è¿›è¡Œçš„</code>ã€‚è¿™é‡Œéœ€è¦ä»‹ç»ä¸€ä¸‹ï¼ŒSpringæŠŠåŠ äº†@Configurationæ³¨è§£çš„ç§°ä¸ºå…¨é…ç½®ç±»ï¼Œå…¶ä»–çš„ç§°ä¸ºåŠé…ç½®ç±»ï¼Œä¸¤è€…åˆ¤åˆ«æ ‡å‡†æ˜¯ï¼šæ˜¯å¦åŠ äº†@Configurationæ³¨è§£ã€‚</p> 
<pre><code>// ConfigurationClassParser.java
@Nullable
protected final SourceClass doProcessConfigurationClass(
      ConfigurationClass configClass, SourceClass sourceClass, Predicate&lt;String&gt; filter) throws IOException {
    //... çœç•¥éƒ¨åˆ†éç›¸å…³ä»£ç 

    // è§£ææ˜¯å¦åŠ äº†@ComponentScan, å¹¶è¿›è¡Œæ‰«æ
    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(
          sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);
    if (!componentScans.isEmpty() &amp;&amp;
          !this.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) {
       for (AnnotationAttributes componentScan : componentScans) {

          // 1: è§£æComponentScané…ç½®ä¿¡æ¯,å®Œæˆæ‰«æ(æ‰«æå‡ºæ¥çš„ç±»åœ¨beanDefinitionMapä¸­)
          Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =
                this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());

          // 2: éå†æ‰«æå‡ºæ¥çš„ç±»,æ£€æŸ¥æ˜¯ä¸æ˜¯é…ç½®ç±»ï¼ˆé…ç½®ç±»éœ€è¦ç»§ç»­é€’å½’è§£æï¼‰
          for (BeanDefinitionHolder holder : scannedBeanDefinitions) {
             BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();
             if (bdCand == null) {
                bdCand = holder.getBeanDefinition();
             }
             // é‡ç‚¹ï¼šåˆ¤æ–­ç±»æ˜¯ä¸æ˜¯é…ç½®ç±», å¹¶æ ‡æ³¨ç±»å±æ€§ä¿¡æ¯(æ˜¯å¦ä¸ºå…¨é…ç½®ç±»ã€@Orderå€¼ç­‰)
             if (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, this.metadataReaderFactory)) {
                // 3 å¦‚æœæ‰«æå‡ºæ¥çš„ç±»,æ˜¯é…ç½®ç±»,è¿˜éœ€è¦é€’å½’å¤„ç†æ‰«æå‡ºæ¥çš„é…ç½®ç±»
                parse(bdCand.getBeanClassName(), holder.getBeanName());
             }
          }
       }
    }
    //... çœç•¥éƒ¨åˆ†éç›¸å…³ä»£ç 

}

//ConfigurationClassUtils.java
// å…¨é…ç½®ç±»æ ‡è®°å€¼
public static final String CONFIGURATION_CLASS_FULL = "full";
// åŠé…ç½®ç±»æ ‡è®°å€¼
public static final String CONFIGURATION_CLASS_LITE = "lite";

public static boolean checkConfigurationClassCandidate(
      BeanDefinition beanDef, MetadataReaderFactory metadataReaderFactory) {
     //... çœç•¥éƒ¨åˆ†éç›¸å…³ä»£ç 
      
    // 2.1 ä»æ³¨è§£ä¿¡æ¯ä¸­, è·å–@Configurationçš„æ³¨è§£ä¿¡æ¯(å¦‚å­˜åœ¨ï¼Œæ ‡è®°ä¸ºä¸ºå…¨é…ç½®ç±»)
    Map&lt;String, Object&gt; config = metadata.getAnnotationAttributes(Configuration.class.getName());
    if (config != null &amp;&amp; !Boolean.FALSE.equals(config.get("proxyBeanMethods"))) {
       beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_FULL);
    }
    
    // æœ‰@Componentï¼Œ@ComponentScanï¼Œ@Importï¼Œ@ImportResourceæ³¨è§£,è¢«æ ‡è®°æˆåŠé…ç½®ç±»
    else if (config != null || isConfigurationCandidate(metadata)) {
       beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_LITE);
    }
    else {
       return false;
    }

    //... çœç•¥éƒ¨åˆ†éç›¸å…³ä»£ç 
}
å¤åˆ¶ä»£ç </code></pre> 
<p>â€ƒ æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹è¿™éƒ¨åˆ†ä»£ç çš„é€»è¾‘ï¼š</p> 
<ol><li>è·å–é…ç½®ç±»ä¸Š<code>@ComponentScan(basePackages="xxx")</code>æ³¨è§£ï¼Œäº¤ç»™ç»„ä»¶<code>componentScanParser</code>è§£æï¼Œè¯¥ç»„ä»¶ä¼šæ‰«æå‡ºå¯¹åº”åŒ…è·¯å¾„ä¸‹éœ€è¦Springå¤„ç†çš„ç±»ï¼Œå¹¶å°è£…æˆ<code>BeanDefinition</code>ï¼ŒåŒæ—¶è¿”å›æ‰«æçš„ç±»å®šä¹‰ä¿¡æ¯ã€‚</li><li>éå†æ‰«æå‡ºçš„ç±»ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºé…ç½®ç±»ï¼Œé…ç½®ç±»éœ€è¦ç»§ç»­è§£æ(é…ç½®ç±»å¯èƒ½æœ‰éœ€è¦å¤„ç†çš„SpringåŠŸèƒ½)ã€‚</li><li>åœ¨åˆ¤æ–­æ˜¯å¦ä¸ºé…ç½®ç±»æ—¶ï¼Œä¹Ÿä¼šç»™ç±»æ‰“ä¸Šæ ‡ç­¾ï¼ŒåŠ äº†@Configurationçš„æ ‡è®°ä¸º<code>å…¨é…ç½®ç±»</code>ï¼Œå…¶ä»–çš„æ ‡è®°ä¸º<code>åŠé…ç½®ç±»</code>ã€‚æ ‡è¯†çš„æ–¹å¼å°±æ˜¯åœ¨<code>BeanDefinition</code>çš„<code>attributes</code>å±æ€§ä¸­åŠ å…¥<code>XX.configurationClass:full</code>æ ‡è¯†ã€‚</li></ol> 
<blockquote> 
 <p>åˆ¤æ–­æ˜¯å¦ä¸ºé…ç½®ç±»æ—¶ï¼Œä¸ä»…ä»…åªæ˜¯åŠ äº†<code>@Configuration</code>çš„ä¸ºé…ç½®ç±»ï¼ŒåŠ äº†<code>@Component</code>ï¼Œ<code>@ComponentScan</code>ï¼Œ<code>@Import</code>ï¼Œ<code>@ImportResource</code>ç­‰æ³¨è§£çš„ï¼Œä¹Ÿæ˜¯é…ç½®ç±»ï¼Œåªæ˜¯ä¸ºåŠé…ç½®ç±»è€Œå·²ã€‚</p> 
 <p>ä¸Šè¿°æˆ‘ä»¬è¯´@Configurationçš„ä½œç”¨æ˜¯æ ‡è®°ä¸ºé…ç½®ç±»ï¼Œè¿™é‡Œçœ‹å…¶å®æ˜¯ä¸å‡†ç¡®çš„ï¼Œå‡†ç¡®è¯´åº”è¯¥æ˜¯æ ‡è®°ä¸ºå…¨é…ç½®ç±»ã€‚ä½†æ˜¯è¿™æ˜¯æ›´å†…éƒ¨çš„é€»è¾‘ï¼Œé€šå¸¸æ¥è¯´ï¼Œ@Configurationæ ‡è®°çš„å°±æ˜¯é…ç½®ç±»ï¼Œå…¶ä»–æ ‡è®°çš„ä¸ºæ™®é€šç±»ã€‚</p> 
</blockquote> 
<p>â€ƒ æ€»ç»“ä¸€ä¸‹ï¼Œ<code>åœ¨æ‰«æé˜¶æ®µï¼ŒSpringä¼šå¯¹æ‰«æå‡ºæ¥çš„ç±»è¿›è¡Œå…¨é…ç½®ç±»è¿˜æ˜¯åŠé…ç½®ç±»çš„æ ‡è¯†</code>ã€‚å½“ç„¶è¿™é‡Œä¹Ÿä»…ä»…æ˜¯æ ‡è¯†å‡ºæ¥ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œè¿™æ˜¯åœ¨ç»™åé¢ç”Ÿæˆä»£ç†å¯¹è±¡åšå‡†å¤‡ã€‚</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/6b/3a/dzZt10ko_o.png"></p> 
<blockquote> 
 <p>è¿™é‡Œæˆ‘ä»¬ä¸å¾—ä¸åæ§½ä¸€ä¸‹ï¼Œä½œä¸ºä¸šç•Œæ ‡æ†çš„Springï¼Œåœ¨æ–¹æ³•å‘½åä¸Šä¹Ÿå¦‚æ­¤æ··ä¹±ï¼Œåœ¨checkConfigurationClassCandidate()è¿™ä¸ªè¡¨æ˜checkåŠ¨ä½œçš„æ–¹æ³•é‡Œï¼Œåšäº†å¾ˆå¤šBeanDefinitionå±æ€§è§£æèµ‹å€¼çš„æ“ä½œï¼Œç®€ç›´æ˜¯åœ¨æ··æ·†è§†å¬å•Šæœ‰æ²¡æœ‰ã€‚çœ‹æ¥å‘½åç¡®å®æ˜¯ç¼–ç¨‹ç•Œæœ€å¤§çš„éš¾é¢˜å•Šã€‚</p> 
</blockquote> 
<h3>2.2 å…¨é…ç½®ç±»å¢å¼º</h3> 
<p>â€ƒ åœ¨ä¸Šä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬åˆ†æäº†Springå¯¹æ ‡æ³¨äº†@Configurationé…ç½®ç±»çš„æŸ¥æ‰¾å’Œè§£æè¿‡ç¨‹ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ï¼šåˆ¤æ–­ç±»ä¸Šæ˜¯å¦æœ‰@Configurationæ³¨è§£ï¼Œæœ‰å°±æ˜¯å…¨é…ç½®ç±»ï¼Œæ²¡æœ‰å°±æ˜¯åŠé…ç½®ç±»ã€‚å¯¹äºå…¨é…ç½®çš„å¢å¼ºï¼Œæˆ‘ä»¬ä¹Ÿåå¤æåˆ°è¿‡ï¼Œæ˜¯å€ŸåŠ©ä»£ç†æ¥å®ç°çš„ã€‚å…·ä½“çš„çš„è°ƒç”¨é€»è¾‘æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ã€‚</p> 
<pre><code>//ConfigurationClassPostProcessor.java
public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {
   //...çœç•¥éƒ¨åˆ†ä»£ç 
   // å¯¹å…¨é…ç½®ç±»è¿›è¡Œå¢å¼º
   this.enhanceConfigurationClasses(beanFactory);
}


public void enhanceConfigurationClasses(ConfigurableListableBeanFactory beanFactory) {
   Map&lt;String, AbstractBeanDefinition&gt; configBeanDefs = new LinkedHashMap&lt;&gt;();
   // 1: æŸ¥æ‰¾éœ€è¦å¢å¼ºçš„é…ç½®ç±»
   // éå†å·²ç»æ³¨å†Œå¤šçš„beanName
   for (String beanName : beanFactory.getBeanDefinitionNames()) {
      // ...çœç•¥éƒ¨åˆ†ä»£ç 
      // 1.2 æŸ¥æ‰¾å…¨é…ç½®ç±»,æ”¾å…¥configBeanDefs
      if (ConfigurationClassUtils.CONFIGURATION_CLASS_FULL.equals(configClassAttr)) {
         // ...çœç•¥éƒ¨åˆ†ä»£ç 
         // å°†ç¬¦åˆæ¡ä»¶çš„,æ”¾å…¥configBeanDefsä¸­
         configBeanDefs.put(beanName, (AbstractBeanDefinition) beanDef);
      }
   }

   // 2: å¯¹å…¨é…ç½®ç±»è¿›è¡Œå¢å¼º
   // 2.1 åˆ›å»ºä¸€ä¸ªé…ç½®ç±»çš„å¢å¼ºå™¨
   ConfigurationClassEnhancer enhancer = new ConfigurationClassEnhancer();
   for (Map.Entry&lt;String, AbstractBeanDefinition&gt; entry : configBeanDefs.entrySet()) {
      AbstractBeanDefinition beanDef = entry.getValue();
      beanDef.setAttribute(AutoProxyUtils.PRESERVE_TARGET_CLASS_ATTRIBUTE, Boolean.TRUE);
      Class&lt;?&gt; configClass = beanDef.getBeanClass();
      // 2.2 å¯¹ç±»è¿›è¡Œå¢å¼º,ä½¿ç”¨cglibå•ä¾‹
      Class&lt;?&gt; enhancedClass = enhancer.enhance(configClass, this.beanClassLoader);
      if (configClass != enhancedClass) {
         if (this.logger.isTraceEnabled()) {
            this.logger.trace(String.format("Replacing bean definition '%s' existing class '%s' with " +
                  "enhanced class '%s'", entry.getKey(), configClass.getName(), enhancedClass.getName()));
         }
         // 2.3 ä¿®æ”¹BeanClassä¸ºåŠ å¼ºç±»,è¿™é‡Œä¹‹æ‰€ä»¥ä¸ä½¿ç”¨åŠ å¼ºå¯¹è±¡,æ˜¯å› ä¸ºè¿˜éœ€è¦å°†åŠ å¼ºç±»äº¤ç»™springå®ä¾‹åŒ–
         beanDef.setBeanClass(enhancedClass);
      }
   }
}
å¤åˆ¶ä»£ç </code></pre> 
<p>â€ƒ æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹è¿™éƒ¨åˆ†ä»£ç çš„é€»è¾‘ï¼š</p> 
<ol><li>æŸ¥æ‰¾éœ€è¦å¢å¼ºçš„é…ç½®ç±»ï¼Œè¿™é‡Œç›´æ¥æ‰¾å‡ºç±»<code>BeanDefinition</code>çš„<code>attributes</code>å±æ€§ä¸­<code>XX.configurationClass</code>æ ‡è¯†å€¼ä¸º<code>full</code>çš„å³å¯ã€‚</li><li>å¯¹é…ç½®ç±»ç”Ÿæˆä»£ç†ï¼Œè¿›è¡ŒåŠŸèƒ½å¢å¼ºã€‚</li><li>ä¿®æ”¹<code>BeanDefinition</code>çš„beanClasså±æ€§ä¸ºä»£ç†ç±»ï¼Œåç»­Springåœ¨äº§ç”Ÿå®ä¾‹æ—¶ï¼Œä½¿ç”¨çš„å°±æ˜¯ä»£ç†ç±»äº†ã€‚</li></ol> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c3/34/X5XgUnay_o.png"></p> 
<p>â€ƒè¿™é‡Œæœ‰ä¸ªé‡ç‚¹ï¼Œå°±æ˜¯ç”Ÿæˆä»£ç†ç±»ï¼ŒSpringé‡‡ç”¨çš„æ˜¯CGLIBå¢å¼ºçš„æ–¹å¼ï¼Œä¸‹é¢æˆ‘ä»¬é¡ºè—¤æ‘¸ç“œï¼Œçœ‹çœ‹Springæ˜¯æ€ä¹ˆæ“ä½œçš„ã€‚</p> 
<h3>2.3 ç”Ÿæˆä»£ç†ç±»</h3> 
<pre><code>// ConfigurationClassEnhancer.java
// å›è°ƒå™¨åˆ—è¡¨
private static final Callback[] CALLBACKS = new Callback[] {
      new BeanMethodInterceptor(),
      new BeanFactoryAwareMethodInterceptor(),
      NoOp.INSTANCE
};

// å›è°ƒè¿‡æ»¤å™¨
private static final ConditionalCallbackFilter CALLBACK_FILTER = new ConditionalCallbackFilter(CALLBACKS);


//ä¸ºåŸå§‹ç±»ç”Ÿæˆä»£ç†ç±»
public Class&lt;?&gt; enhance(Class&lt;?&gt; configClass, @Nullable ClassLoader classLoader) {
   // 1: newEnhancer() ç”Ÿæˆç”ŸæˆCGLIBå®ä¾‹
   // createClass() ç”Ÿæˆä»£ç†ç±»
   Class&lt;?&gt; enhancedClass = createClass(newEnhancer(configClass, classLoader));

   // 2: è¿”å›å¢å¼ºåçš„ç±»
   return enhancedClass;
}

// ç”ŸæˆCGLIBå®ä¾‹
private Enhancer newEnhancer(Class&lt;?&gt; configSuperClass, @Nullable ClassLoader classLoader) {
   Enhancer enhancer = new Enhancer();
   enhancer.setSuperclass(configSuperClass);
   // è®¾ç½®æ¥å£ä¸ºEnhancedConfiguration
   enhancer.setInterfaces(new Class&lt;?&gt;[] {EnhancedConfiguration.class});
   enhancer.setUseFactory(false);
   enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);
   // ç»™ä»£ç†ç±»ç”Ÿæˆä¸€ä¸ª$$beanFactoryå­—æ®µ
   enhancer.setStrategy(new BeanFactoryAwareGeneratorStrategy(classLoader));
   // è®¾ç½®å›è°ƒè¿‡æ»¤å™¨ä¸ºEnhancedConfigurationï¼Œèƒ½æ ¹æ®ä¼ å…¥
   enhancer.setCallbackFilter(CALLBACK_FILTER);
   enhancer.setCallbackTypes(CALLBACK_FILTER.getCallbackTypes());
   return enhancer;
}

// ç”Ÿæˆä»£ç†ç±»
private Class&lt;?&gt; createClass(Enhancer enhancer) {
   Class&lt;?&gt; subclass = enhancer.createClass();
   // å¢åŠ æ‹¦æˆªå™¨
   Enhancer.registerStaticCallbacks(subclass, CALLBACKS);
   return subclass;
}
å¤åˆ¶ä»£ç </code></pre> 
<p>â€ƒ æˆ‘ä»¬ç›´æ¥æ¥çœ‹ä»£ç ï¼Œè¿™é‡Œå…¶å®å¤§é‡è¿ç”¨äº†CGLIBç›¸å…³çš„çŸ¥è¯†ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œç™¾åº¦è¡¥è¯¾ï¼Œä¸è¡¥ä¹Ÿæ²¡å…³ç³»ï¼Œè¿™é‡Œä¼šå¸¦å¤§å®¶ç®€å•äº†è§£ä¸€ä¸‹ï¼š</p> 
<ol><li>å…ˆæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¢å¼ºå™¨<code>Enhancer</code>ï¼Œä¸ºå¢å¼ºå™¨è®¾ç½®äº†ç›¸å…³å±æ€§ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ ¸å¿ƒå±æ€§ï¼š 
  <ul><li>superclass: çˆ¶ç±»ï¼Œä¹Ÿå°±æ˜¯è¢«ä»£ç†ç±»ï¼ŒCGLIBçš„åŸç†æ˜¯ä¸ºè¢«ä»£ç†ç±»ç”Ÿæˆå­ç±»ï¼Œä»è€Œå®ç°åŠŸèƒ½å¢å¼ºã€‚</li><li>interfaces: å®ç°çš„æ¥å£ï¼Œè¿™é‡Œç¡¬æ€§æŒ‡å®šä¸º<code>EnhancedConfiguration</code>ã€‚(åç»­ä¼šä½¿ç”¨è¯¥æ ‡è¯†)</li><li>namingPolicyï¼šè®¾ç½®ä»£ç†ç±»çš„åç§°ç­–ç•¥ï¼Œé»˜è®¤ä¸º<code>BySpringCGLIB</code>ï¼Œè¿™ä¹Ÿæ˜¯Springç”Ÿæˆçš„ä»£ç†ç±»ç±»å‹åŒ…å«xxBySpringCGLIBçš„åŸå› ã€‚</li><li>strategyï¼šç”Ÿæˆç­–ç•¥ï¼Œè¿™æ˜¯è®¾ç½®çš„BeanFactoryAwareGeneratorStrategyï¼Œé»˜è®¤é€»è¾‘æ˜¯ç»™ä»£ç†ç±»åŠ¨æ€å¢åŠ <code>$$beanFactory</code>å­—æ®µ(åç»­ä¼šä½¿ç”¨)ã€‚</li><li>callbackFilterï¼šå›è°ƒè¿‡æ»¤å™¨ï¼Œåœ¨CGLibå›è°ƒæ—¶å¯ä»¥è®¾ç½®ä¸åŒæ–¹æ³•æ‰§è¡Œä¸åŒçš„å›è°ƒé€»è¾‘ï¼Œæˆ–è€…æ ¹æœ¬ä¸æ‰§è¡Œå›è°ƒã€‚å›è°ƒè¿‡æ»¤å™¨çš„åŠŸèƒ½å°±æ˜¯å¯¹æ‰§è¡Œæ–¹æ³•é€‰æ‹©åˆé€‚çš„æ‹¦æˆªå™¨ã€‚è¿™é‡Œä¸€å®šè¦åŒºåˆ†æ¸…æ¥šæ‹¦æˆªå™¨å’Œå›è°ƒè¿‡æ»¤å™¨çš„åŠŸèƒ½ï¼š 
    <ul><li>æ‹¦æˆªå™¨<code>Callback</code>ï¼šåœ¨è°ƒç”¨ç›®æ ‡æ–¹æ³•æ—¶ï¼ŒCGLibä¼šè°ƒç”¨æ‹¦æˆªå™¨è¿›è¡Œè°ƒç”¨æ‹¦æˆªï¼Œæ¥å®ç°å¢å¼ºçš„ä»£ç†é€»è¾‘ï¼Œå½“ç„¶é‡Œé¢å¯ä»¥å¯¹åº”åŸå§‹æ–¹æ³•(åœ¨çˆ¶ç±»ä¸­)ã€‚</li><li>å›è°ƒè¿‡æ»¤å™¨<code>CallbackFilter</code>ï¼šä¸ºæ‰§è¡Œæ–¹æ³•é€‰æ‹©æ‹¦æˆªå™¨ï¼ŒCGLIBå¯ä»¥è®¾ç½®å¤šä¸ªæ‹¦æˆªå™¨ï¼Œç„¶åæ ¹æ®å…·ä½“æ‰§è¡Œçš„æ–¹æ³•å†è¿›è¡Œé€‰æ‹©åˆ†å‘ã€‚</li></ul></li></ul></li><li>å€ŸåŠ©å¢å¼ºå™¨<code>Enhancer</code>ï¼Œç”Ÿæˆä»£ç†ç±»ï¼Œå¹¶æ³¨å†Œæ‹¦æˆªå™¨ã€‚</li><li>è¿”å›ä»£ç†ç±»ã€‚</li></ol> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/9c/6d/1T32nfT4_o.png"></p> 
<h4>2.3.1 æ‹¦æˆªå™¨çš„é€‰æ‹©</h4> 
<p>â€ƒ åœ¨ä¸Šè¿°è¿‡ç¨‹ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“Springä¸ºæ ‡æ³¨äº†@Configurationé…ç½®ç±»ç”Ÿæˆäº†ä»£ç†ç±»ï¼Œå¹¶æŒ‡å®šäº†<code>å›è°ƒè¿‡æ»¤å™¨</code>å’Œ<code>æ‹¦æˆªå™¨</code>ï¼ŒåŒæ—¶å°†ç”Ÿæˆå¯¹è±¡çš„ç±»å‹ä¿®æ”¹ä¸ºäº†ä»£ç†ç±»ã€‚é‚£Springåœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œ<code>å®ä¾‹åŒ–çš„å°±æ˜¯ä»£ç†å¯¹è±¡</code>äº†ã€‚<code>åœ¨é…ç½®ç±»ä¸­å·¥å‚æ–¹æ³•(@Beanæ ‡æ³¨çš„æ–¹æ³•)è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå…ˆé€šè¿‡å›è°ƒè¿‡æ»¤å™¨é€‰æ‹©åˆé€‚çš„æ‹¦æˆªå™¨ï¼Œç„¶åå†ç”±æ‹¦æˆªå™¨è¿›è¡Œæ‹¦æˆªã€å¹¶å®ç°åŠŸèƒ½å¢å¼º</code>ã€‚</p> 
<pre><code>//ConfigurationClassEnhancer.ConditionalCallbackFilter.java

// æ ¹æ®æ–¹æ³•ä¿¡æ¯ï¼Œé€‰æ‹©æ‹¦æˆªå™¨
@Override
public int accept(Method method) {
  for (int i = 0; i &lt; this.callbacks.length; i++) {
     Callback callback = this.callbacks[i];
     // é‡ç‚¹ï¼šæ‹¦æˆªå™¨çš„é€‰æ‹©ï¼Œ BeanMethodInterceptorå’ŒBeanFactoryAwareMethodInterceptorç»§æ‰¿äº†ConditionalCallbackï¼ŒNoOp.INSTANCE æ²¡æœ‰ç»§æ‰¿
     if (!(callback instanceof ConditionalCallback) || ((ConditionalCallback) callback).isMatch(method)) {
        return i;
     }
  }
  throw new IllegalStateException("No callback available for method " + method.getName());
}


//ConfigurationClassEnhancer.BeanFactoryAwareMethodInterceptor.java
// åŒ¹é…é€»è¾‘: åªå¤„ç†setBeanFactoryæ–¹æ³•
@Override
public boolean isMatch(Method candidateMethod) {
   return isSetBeanFactory(candidateMethod);
}

public static boolean isSetBeanFactory(Method candidateMethod) {
   return (candidateMethod.getName().equals("setBeanFactory") &amp;&amp;
         candidateMethod.getParameterCount() == 1 &amp;&amp;
         BeanFactory.class == candidateMethod.getParameterTypes()[0] &amp;&amp;
         BeanFactoryAware.class.isAssignableFrom(candidateMethod.getDeclaringClass()));
}

//ConfigurationClassEnhancer.`BeanMethodInterceptor.java
// åŒ¹é…é€»è¾‘: åªå¤„ç†æ–¹æ³•ä¸ŠåŠ äº†@Beanæ³¨è§£çš„ï¼Œå¹¶ä¸”ä¸æ˜¯setBeanFactory()
@Override
public boolean isMatch(Method candidateMethod) {
   return (candidateMethod.getDeclaringClass() != Object.class &amp;&amp;
         !BeanFactoryAwareMethodInterceptor.isSetBeanFactory(candidateMethod) &amp;&amp;
         BeanAnnotationHelper.isBeanAnnotated(candidateMethod));
}
å¤åˆ¶ä»£ç </code></pre> 
<p>â€ƒ é€šè¿‡ä¸Šè¿°æºç ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ‰¾åˆ°å›è°ƒè¿‡æ»¤å™¨é€‰æ‹©æ‹¦æˆªå™¨çš„é€»è¾‘ï¼š <code>if (!(callback instanceof ConditionalCallback) || ((ConditionalCallback) callback).isMatch(method))</code>ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™ä¸ªåˆ¤æ–­çš„æ¡ä»¶ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼š</p> 
<ul><li>å¦‚æœæ˜¯ConditionalCallbackç±»å‹çš„æ‹¦æˆªå™¨ï¼Œç›´æ¥é€šè¿‡å›è°ƒå™¨isMatch()æ¥åˆ¤æ–­ã€‚</li><li>å¦‚æœä¸æ˜¯ConditionalCallbackç±»å‹çš„æ‹¦æˆªå™¨ï¼Œåˆ™ç›´æ¥åˆ¤æ–­ä¸ºåŒ¹é…æˆåŠŸã€‚</li></ul> 
<p>â€ƒ åˆçœ‹å¯èƒ½æœ‰ç‚¹æ‡µï¼Œæˆ‘ä»¬ç»“åˆä¼ é€’è¿›æ¥çš„æ‹¦æˆªå™¨æ¥çœ‹ï¼Œæ‹¦æˆªå™¨åˆ—è¡¨æ˜¯ï¼š<code>BeanMethodInterceptor</code>ã€<code>BeanFactoryAwareMethodInterceptor</code>ã€<code>NoOp.INSTANCE</code>ï¼Œå…¶ä¸­å‰ä¸¤ä¸ªéƒ½æ˜¯<code>ConditionalCallback</code>ç±»å‹çš„ï¼Œæœ€åä¸€ä¸ªåˆ™æ˜¯é»˜è®¤çš„ç©ºå®ç°ã€‚åŒæ—¶ä¼ é€’çš„å›è°ƒè¿‡æ»¤å™¨åˆ—è¡¨ï¼Œæ˜¯ä¸ªæœ‰åºæ•°ç»„ï¼Œæ‰€ä»¥ä¼šä¼˜å…ˆåŒ¹é…<code>BeanMethodInterceptor</code>å’Œ<code>BeanFactoryAwareMethodInterceptor</code>ï¼Œå¦‚æœè¿™ä¸¤ä¸ªéƒ½ä¸èƒ½åŒ¹é…ï¼Œåˆ™é»˜è®¤åŒ¹é…åˆ°ç©ºå®ç°<code>NoOp.INSTANCE</code>ã€‚</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/66/96/7eAdQwiq_o.png"></p> 
<blockquote> 
 <p>å…³äº<code>BeanMethodInterceptor</code>ã€<code>BeanFactoryAwareMethodInterceptor</code>çš„åŒ¹é…é€»è¾‘ï¼Œåœ¨ä»£ç æ³¨é‡Šä¸­å·²ç»æœ‰æ˜ç¡®çš„è¯´æ˜ï¼Œæ¯”è¾ƒæ¸…æ™°ï¼Œå¤§å®¶æ³¨æ„çœ‹å“¦ã€‚</p> 
</blockquote> 
<h4>2.3.2 æ‹¦æˆªå™¨çš„åŠŸèƒ½</h4> 
<p>â€ƒ ç»è¿‡ä¸Šè¿°çš„ä¸åŒå…¶çƒ¦çš„å•°å—¦ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒSpringä¸ºæ ‡æ³¨äº†@Configurationé…ç½®ç±»ç”Ÿæˆäº†ä»£ç†ç±»ï¼Œåœ¨è°ƒç”¨é…ç½®ç±»çš„æ–¹æ³•æ—¶ï¼Œä¼šå…ˆé€šè¿‡å›è°ƒè¿‡æ»¤å™¨é€‰æ‹©æ‹¦æˆªå™¨ï¼Œç„¶åç”±æ‹¦æˆªå™¨å¯¹æ–¹æ³•è¿›è¡Œå¢å¼ºã€‚åŒæ—¶ä¹Ÿæ¸…æ¥šä¸»è¦æ˜¯é <code>BeanMethodInterceptor</code>å’Œ<code>BeanFactoryAwareMethodInterceptor</code>è¿™ä¸¤ä¸ªæ‹¦æˆªå™¨å™¨å‘æŒ¥ä½œç”¨ï¼Œæœ¬ç« èŠ‚æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ‹¦æˆªå™¨çš„åŠŸèƒ½ã€‚</p> 
<p>â€ƒ åœ¨åˆ†æè¿™ä¸¤ä¸ªæ‹¦æˆªå™¨çš„åŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å›å¿†ä¸€ä¸‹@Configurationé…ç½®ç±»çš„ä½œç”¨ï¼Œè®©åŠ äº†@Beançš„æ–¹æ³•æœ‰äº†<code>"å¹‚ç­‰çš„èƒ½åŠ›"</code>ï¼Œä¸ä¼šé‡å¤åˆ›å»ºå¯¹è±¡ã€‚</p> 
<blockquote> 
 <p>è¿™é‡Œå°ä¼™ä¼´éœ€è¦æ³¨æ„å“¦ï¼Œ@Beanæ³¨è§£æœ¬èº«çš„èƒ½åŠ›å°±æ˜¯æŠŠæˆ‘ä»¬è‡ªå·±äº§ç”Ÿçš„å¯¹è±¡ï¼Œæ”¾å…¥åˆ°Springå®¹å™¨ä¸­ï¼Œä¾¿äºæˆ‘ä»¬ä¾èµ–æ³¨å…¥ï¼Œè¿™ä¸ª@Configurationæ— å…³ï¼Œåœ¨åŠé…ç½®ç±»ä¸‹è¯¥åŠŸèƒ½ä¹Ÿæ˜¯æ­£å¸¸çš„å“¦ã€‚@Configurationçš„åŠ æŒï¼Œåªæ˜¯ä½¿å…¶æœ‰äº†å¹‚ç­‰æ€§å“¦ã€‚</p> 
</blockquote> 
<p>â€ƒ ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“@Configurationçš„ä½œç”¨ï¼Œå®ç°åŸç†æˆ‘ä»¬ä¹Ÿæ¸…æ¥šï¼Œé€šè¿‡CGLIBç”Ÿæˆä»£ç†å­ç±»ï¼Œå…·ä½“çš„å®ç°æˆ‘ä»¬çŒœæƒ³æ˜¯ï¼š<code>æŠŠ@Beanå·¥å‚æ–¹æ³•ç”Ÿæˆçš„å¯¹è±¡å…ˆæ”¾å…¥åˆ°Springå®¹å™¨ä¸­ç¼“å­˜ï¼Œé‡å¤è°ƒç”¨çš„æ—¶å€™ï¼Œä»ç¼“å­˜ä¸­ç›´æ¥è·å–</code>ã€‚å®é™…ä¸Šä¹Ÿç¡®å®å¦‚æ­¤ï¼ŒSpringå°±æ˜¯è¿™ä¹ˆåšçš„ã€‚</p> 
<p>â€ƒOKï¼Œç°åœ¨ä¸€åˆ‡éƒ½çœŸç›¸å¤§ç™½ï¼Œåªå‰©ä¸‹æœ€åä¸€å±‚ç¥ç§˜çš„é¢çº±æ²¡æœ‰è§£å¼€ï¼Œå°±æ˜¯Springæ€ä¹ˆåšåˆ°çš„ã€‚è¦æƒ³è¾¾åˆ°è¿™æ ·çš„æ•ˆæœï¼Œå…¶å®æœ‰ä¸¤ä¸ªé—®é¢˜éœ€è¦å…ˆè§£å†³ï¼š</p> 
<ol><li>å¯¹@Beançš„å·¥å‚æ–¹æ³•äº§ç”Ÿçš„å¯¹è±¡ï¼Œèƒ½å¤Ÿå»Springå®¹å™¨ä¸­æŸ¥é‡ï¼Œä¸å­˜åœ¨åˆ™ç”Ÿæˆå¯¹è±¡ï¼Œå­˜åˆ™åœ¨ç›´æ¥è·å–çš„ã€‚</li><li>æ³¨å…¥Springå®¹å™¨ï¼Œä¹Ÿå°±æ˜¯<code>beanFactory</code>ï¼Œå› ä¸ºéœ€è¦åˆ°å®¹å™¨ä¸­æŸ¥é‡ã€è·å–ï¼Œæ‰€ä»¥éœ€è¦å…ˆå®¹å™¨å¯¹è±¡ã€‚</li></ol> 
<p>â€ƒSpringæ­£æ˜¯ç”¨<code>BeanMethodInterceptor</code>ã€<code>BeanFactoryAwareMethodInterceptor</code>è¿™ä¸¤ä¸ªæ‹¦æˆªå™¨ï¼Œæ¥è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜çš„ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹æ³¨å…¥Springå®¹å™¨beanFactoryçš„å®ç°ã€‚</p> 
<p>2.3.2.1 ç»™ä»£ç†ç±»æ³¨å…¥beanå®¹å™¨</p> 
<p>â€ƒä¸ºäº†å®ç°@Beanæ–¹æ³•çš„"å¹‚ç­‰"ï¼Œæˆ‘ä»¬éœ€è¦ä¾èµ–beanFactoryï¼Œå¯æ˜¯æ²¡æœ‰å•Šï¼Œæ€ä¹ˆåŠå‘¢ï¼Œè¦æ±‚ç¨‹åºå‘˜ä½¿ç”¨<code>@Autowired BeanFactory </code>æ‰‹åŠ¨æ”¾ä¸€ä¸ªï¼Ÿæ‰‹åŠ¨æ˜¯ä¸å¯èƒ½ï¼Œè¿™è¾ˆå­éƒ½æ˜¯ä¸å¯èƒ½çš„ï¼Œä¸»è¦æ˜¯ä¸¢ä¸èµ·è¿™ä¸ªäººã€‚æ‰‹åŠ¨ä¸è¡Œï¼Œé‚£å°±è‡ªåŠ¨æ”¾è¿›æ¥å§ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆSpringåœ¨ç”Ÿäº§çš„ä»£ç†ç±»ä¸­,å¼ºè¡ŒåŠ äº†ä¸€ä¸ªbeanFactoryå±æ€§çš„åŸå› ã€‚</p> 
<ul><li><strong>ä¸ºä»£ç†ç±»å¢åŠ beanFactoryå±æ€§</strong></li></ul> 
<pre><code>//ConfigurationClassEnhancer.java
private Enhancer newEnhancer(Class&lt;?&gt; configSuperClass, @Nullable ClassLoader classLoader) {
   Enhancer enhancer = new Enhancer();
   // ...çœç•¥å…¶ä»–å­—æ®µçš„èµ‹å€¼
   // ç»™ä»£ç†ç±»ç”Ÿæˆä¸€ä¸ª$$beanFactoryå­—æ®µ
   enhancer.setStrategy(new BeanFactoryAwareGeneratorStrategy(classLoader));
   return enhancer;
}


private static class BeanFactoryAwareGeneratorStrategy extends
      ClassLoaderAwareGeneratorStrategy {

   public BeanFactoryAwareGeneratorStrategy(@Nullable ClassLoader classLoader) {
      super(classLoader);
   }

   @Override
   protected ClassGenerator transform(ClassGenerator cg) throws Exception {
      // åŠ¨æ€æ·»åŠ å­—æ®µ"$$beanFactory"
      ClassEmitterTransformer transformer = new ClassEmitterTransformer() {
         @Override
         public void end_class() {
            declare_field(Constants.ACC_PUBLIC, BEAN_FACTORY_FIELD, Type.getType(BeanFactory.class), null);
            super.end_class();
         }
      };
      return new TransformingClassGenerator(cg, transformer);
   }
}
å¤åˆ¶ä»£ç </code></pre> 
<p>â€ƒé€šè¿‡æºç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç”Ÿæˆå­ç±»å­—èŠ‚ç çš„æ—¶å€™ï¼Œå°±å€ŸåŠ©CGLIBçš„èƒ½åŠ›ï¼Œç»™ä»£ç†ç±»åŠ¨æ€å¢åŠ äº†ä¸€ä¸ªå±æ€§<code>$$beanFactory</code>ï¼Œå…¶ç±»å‹æ­£æ˜¯<code>BeanFactory</code>ç±»å‹ï¼Œè¿™å°±æ˜¯è‡ªåŠ¨æ”¾å…¥çš„ã€‚</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c0/6a/GE5YVkdj_o.png"></p> 
<ul><li><strong>ä½¿ç”¨æ‹¦æˆªå™¨BeanFactoryAwareMethodInterceptorç»™beanFactoryå±æ€§èµ‹å€¼</strong> â€ƒä¸Šè¿°è¿‡ç¨‹åªæ˜¯å¢åŠ äº†å±æ€§<code>$$beanFactory</code>ï¼Œè¿˜æ²¡æœ‰èµ‹å€¼å‘¢ã€‚å…¶å®åœ¨å±æ€§å¡«å……çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œèµ‹å€¼ã€‚æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•èµ‹å€¼çš„ã€‚</li></ul> 
<pre><code>private static class BeanFactoryAwareMethodInterceptor implements MethodInterceptor, ConditionalCallback {
   // ç»™$$beanFactoryå­—æ®µèµ‹å€¼
   public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
      // ä»£ç†ç±»ä¸­éœ€è¦å­˜åœ¨å­—æ®µ: $$beanFactory
      Field field = ReflectionUtils.findField(obj.getClass(), BEAN_FACTORY_FIELD);
      Assert.state(field != null, "Unable to find generated BeanFactory field");
      // é€šè¿‡åå°„API,ä¸ºè¯¥å­—æ®µæ³¨å…¥springå®¹å™¨beanFactory
      field.set(obj, args[0]);
      
      if (BeanFactoryAware.class.isAssignableFrom(ClassUtils.getUserClass(obj.getClass().getSuperclass()))) {
         // å¦‚æœæ³¨è§£é…ç½®ç±»çš„çˆ¶ç±»å®ç°äº†BeanFactoryAware,ä¼ å…¥å‚æ•°BeanFactory,å¹¶æ‰§è¡Œçˆ¶ç±»æ–¹æ³•
         return proxy.invokeSuper(obj, args);
      }
      return null;
   }
}
å¤åˆ¶ä»£ç </code></pre> 
<p>â€ƒé€šè¿‡æºç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç›´æ¥é€šè¿‡åå°„ç»™$$beanFactoryå­—æ®µèµ‹å€¼ï¼Œé‚£ä¹ˆåœ¨åç»­å…¶ä»–æµç¨‹ä¸­ï¼Œå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼Œso happyã€‚</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/3f/4a/qCOXaURK_o.png"></p> 
<blockquote> 
 <p>å…¶å®è¿™é‡Œå¹¶ä¸happyï¼ŒåŸç†å’Œå®ç°ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“äº†ï¼Œä½†æ˜¯å¤§å®¶æœ‰æ²¡æœ‰ç–‘æƒ‘ï¼Œè¿™ä¸ªæ‹¦æˆªå™¨ä¸­ç›´æ¥ä»å‚æ•°args[0]è·å–äº†beanFactoryï¼Œä¸ºä»€ä¹ˆï¼Ÿä¼ é€’è¿›æ¥çš„å‚æ•°åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿåˆæ˜¯ä»€ä¹ˆæ—¶å€™å›è°ƒè¿™ä¸ªæ‹¦æˆªå™¨çš„ã€‚ç¬”è€…åœ¨ç½‘ä¸Šæœäº†ä¸å°‘æ–‡ç« ï¼Œå¥½åƒå¹¶æ²¡æœ‰äººæåŠæˆ–è€…è¯´æ¸…è¿™ä¸ªäº‹æƒ…ï¼Œå¯èƒ½ç¡®å®æœ‰ç‚¹éš¾åº¦å§ï¼Œè´°å¸ˆå…„ä»”ç»†ç ”ç©¶äº†ä¸‹ï¼Œé™äºç¯‡å¹…å’Œå¯¹Springæ•´ä½“ä½“ç³»çš„é™åˆ¶ï¼Œæœ¬èŠ‚æˆ‘ä»¬ä¸å±•å¼€ï¼Œæœ«å°¾å†™ä¸ªé€‰è¯»å§ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå†³å®šæ˜¯å¦æŒ‘æˆ˜ä¸€ä¸‹å“¦ã€‚</p> 
</blockquote> 
<p>2.3.2.2 ä¿è¯@Beanå·¥å‚æ–¹æ³•"å†¥ç­‰"</p> 
<pre><code>// æµ‹è¯•ä»£ç 
@Configuration
public class MarkedByConfiguration {
    @Bean
    public A a(){
        return new A();
    }

    @Bean
    public B b(){
        a();
        return new B();
    }
}
å¤åˆ¶ä»£ç </code></pre> 
<p>â€ƒæˆ‘ä»¬æ ¹æ®æµ‹è¯•æ¡ˆä¾‹ä¸­ä»£ç <code>b()-&gt;a()</code>æ¥çœ‹ä¸€ä¸‹æ‹¦æˆªå™¨<code>BeanMethodInterceptor</code>æ˜¯å¦‚ä½•ä¿è¯å¹‚ç­‰çš„ã€‚æˆ‘ä»¬è¿˜æ˜¯å…ˆçœ‹æºç ï¼Œæœ‰ä¸ªæ•´ä½“å°è±¡ï¼š</p> 
<pre><code>private static class BeanMethodInterceptor implements MethodInterceptor, ConditionalCallback {

   public Object intercept(Object enhancedConfigInstance, Method beanMethod, Object[] beanMethodArgs,
            MethodProxy cglibMethodProxy) throws Throwable {

      // ä»å¢å¼ºåçš„æ³¨è§£é…ç½®ç±»å®ä¾‹ä¸­,è·å–BeanFactory(ä¹Ÿå°±æ˜¯æˆå‘˜å˜é‡$$beanFactory)
      ConfigurableBeanFactory beanFactory = getBeanFactory(enhancedConfigInstance);

      // â‘  åˆ¤æ–­å½“å‰è°ƒç”¨åˆ°çš„æ–¹æ³•ï¼Œæ˜¯å¦æ˜¯æ­£åœ¨æ‰§è¡Œåˆ›å»ºçš„@Beanå·¥å‚æ–¹æ³•
      if (isCurrentlyInvokedFactoryMethod(beanMethod)) {
         // å¦‚æœå½“å‰æ‰§è¡Œçš„æ˜¯å·¥å‚æ–¹æ³•æ¥å®ä¾‹åŒ–bean,é‚£å°±æ‰§è¡Œçˆ¶ç±»ä¸­çš„æ–¹æ³•
         return cglibMethodProxy.invokeSuper(enhancedConfigInstance, beanMethodArgs);
      }

      // â‘¡ å¦‚æœå½“å‰æ‰§è¡Œçš„æ–¹æ³•ä¸æ˜¯å·¥å‚æ–¹æ³•,æ­¤æ—¶å°±å»springå®¹å™¨ä¸­è·å–@Beanå¯¹åº”çš„beanå®ä¾‹
      return resolveBeanReference(beanMethod, beanMethodArgs, beanFactory, beanName);
   }
   
   private boolean isCurrentlyInvokedFactoryMethod(Method method) {
       // è·å–æ‰§è¡Œä¸­çš„@Beanæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œ@Beanæ–¹æ³•çš„åˆ›å»ºæ—¶ï¼Œä¼šå°†å½“å‰@Beanæ–¹æ³•æ”¾å…¥ThreadLocalä¸­ï¼Œè¿™é‡Œå†å–å‡ºæ¥
       Method currentlyInvoked = SimpleInstantiationStrategy.getCurrentlyInvokedFactoryMethod();
       // åˆ¤æ–­æ‰§è¡Œçš„@Beanæ–¹æ³•ï¼Œå’Œæ­£åœ¨å›è°ƒçš„æ–¹æ³•æ˜¯å¦ç›¸åŒ
       return (currentlyInvoked != null &amp;&amp; method.getName().equals(currentlyInvoked.getName()) &amp;&amp;
         Arrays.equals(method.getParameterTypes(), currentlyInvoked.getParameterTypes()));
    }

}
å¤åˆ¶ä»£ç </code></pre> 
<p>â€ƒè¿™é‡Œæˆ‘ä»¬åªåˆ†ææ ¸å¿ƒæ–¹æ³•ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯<code> if (isCurrentlyInvokedFactoryMethod(beanMethod))</code>è¿™ä¸ªåˆ¤æ–­é€»è¾‘:</p> 
<ol><li>è·å–å½“å‰æ‰§è¡Œçš„å·¥å‚æ–¹æ³•(@Beanæ–¹æ³•)ã€‚åœ¨Springæ‰§è¡Œb()å·¥å‚æ–¹æ³•æ—¶ï¼Œå°±ä¼š<code>å°†b()æ”¾å…¥åˆ°ThreadLocalä¸­</code>ï¼Œæ ‡è¯†è¯¥å·¥å‚æ–¹æ³•æ­£åœ¨åˆ›å»ºä¸­ã€‚</li><li>åŒ¹é…<code>å½“å‰æ­£åœ¨æ‰§è¡Œçš„å·¥å‚æ–¹æ³•ï¼Œå’Œå½“å‰æ‰§è¡Œçš„æ–¹æ³•ï¼Œæ˜¯å¦æ˜¯åŒä¸€ä¸ªæ–¹æ³•</code>ã€‚è¿™é‡Œéœ€è¦æ³¨æ„åŒºåˆ«ï¼Œæ¯”å¦‚åœ¨æ‰§è¡Œb()æ—¶ï¼Œæ‰§è¡Œåˆ°ç¬¬ä¸€è¡Œa()çš„è°ƒç”¨äº†ï¼Œè¿›å…¥a()æ–¹æ³•åï¼Œå½“å‰æ‰§è¡Œçš„æ–¹æ³•æ˜¯a()ï¼Œæ­£åœ¨æ‰§è¡Œçš„@Beanå·¥å‚æ–¹å¼ä»ç„¶æ˜¯b()ï¼Œä¸¤è€…è‚¯å®šä¸æ˜¯åŒä¸€ä¸ªæ–¹æ³•ï¼Œè¿”å›çš„å°±æ˜¯falseã€‚</li></ol> 
<p>â€ƒç†è§£äº†è¿™ä¸ªæ–¹æ³•çš„åˆ¤æ–­é€»è¾‘ï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥åˆ†ææ‰§è¡Œb()çš„å…·ä½“æµç¨‹ï¼š</p> 
<ol><li>æ‰§è¡Œåˆ°bæ–¹æ³•æ—¶ï¼Œ<code>å°†b()æ”¾å…¥åˆ°ThreadLoaclä¸­ï¼Œæ ‡è¯†æ­£åœ¨åˆ›å»º</code>ã€‚</li><li>æ‰§è¡Œb()ï¼Œç”±äºæ­¤æ—¶b()æ‰€åœ¨çš„é…ç½®ç±»ï¼Œå·²ç»ä¸ºä»£ç†ç±»å®ä¾‹äº†ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œæ‹¦æˆªå™¨çš„å›è°ƒï¼Œä¸”b()æ˜¯@Beanä¿®é¥°çš„å·¥å‚æ–¹æ³•ï¼Œå›è°ƒè¿‡æ»¤å™¨ä¼šé€‰æ‹©<code>BeanMethodInterceptor</code>ï¼Œå¹¶æ‰§è¡Œintercept()æ‹¦æˆªé€»è¾‘ã€‚</li><li>æ‰§è¡ŒisCurrentlyInvokedFactoryMethod()åˆ¤æ–­ï¼Œä¹Ÿå°±æ˜¯â‘ çš„ä»£ç ï¼Œæ­¤æ—¶ThreadLocalä¸­æ˜¯b()ï¼Œæ­£åœ¨æ‰§è¡Œçš„ä¹Ÿæ˜¯b()ï¼Œ<code>äºŒè€…ç›¸åŒï¼Œæ¡ä»¶æˆç«‹</code>ï¼Œéœ€è¦æ‰§è¡Œâ‘¡å¤„çš„ä»£ç ã€‚</li><li><code>å¼€å§‹æ‰§è¡Œçˆ¶ç±»ä¸­çš„æ–¹æ³•</code>ï¼Œä¹Ÿå°±æ˜¯åŸå§‹çš„ï¼Œæˆ‘ä»¬è‡ªå·±ç¼–å†™çš„æ–¹æ³•ã€‚æ³¨æ„ï¼šæ­¤æ—¶å·²ç»ä»æ‹¦æˆªå™¨çš„æ–¹æ³•ä¸­è·³å‡ºæ¥äº†ï¼Œæ‰§è¡Œçš„æ˜¯åŸå§‹çš„ä»£ç ã€‚æ ¹æ®æ‰§è¡Œçš„é¡ºåºï¼Œé¦–å…ˆæ‰§è¡Œçš„å°±æ˜¯a()çš„åˆ›å»ºã€‚</li><li>æ‰§è¡Œa(),ç”±äºæ­¤æ—¶a()æ‰€åœ¨çš„é…ç½®ç±»ï¼Œä¹Ÿæ˜¯ä»£ç†ç±»å®ä¾‹ï¼Œä¸”ä¸ºè¢«@Beanæ ‡è¯†çš„å·¥å‚ï¼Œæ‰€ä»¥<code>ä¹Ÿä¼šè¢«BeanMethodInterceptoræ‹¦æˆªï¼Œæ­¤æ—¶ä¹Ÿä¼šæ‰§è¡ŒisCurrentlyInvokedFactoryMethod()åˆ¤æ–­ï¼Œä½†æ˜¯ç”±äºæ­¤æ—¶ThreadLocalä¸­è·å–åˆ°çš„æ–¹æ³•è¿˜æ˜¯b()ï¼Œè€Œæ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•æ˜¯a()ï¼ŒäºŒè€…ä¸åŒ</code>ï¼Œéœ€è¦æ‰§è¡Œâ‘¢å¤„çš„ä»£ç ã€‚</li><li>â‘¢å¤„çš„ä»£ç é€»è¾‘ï¼Œä¸»è¦æ˜¯<code>å»å®¹å™¨ä¸­è·å–beanå®ä¾‹</code>ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œä¼šå…ˆåˆ›å»ºbeanï¼Œæ”¾å…¥å®¹å™¨åè¿”å›ã€‚è¿™ä¸æ˜¯æˆ‘ä»¬è®¨è®ºçš„æ ¸å¿ƒé—®é¢˜ï¼Œæˆ‘ä»¬å‡è®¾a()ä¹‹å‰å·²ç»æ‰§è¡Œè¿‡äº†ï¼Œåœ¨å®¹å™¨ä¸­æ˜¯å­˜åœ¨çš„ï¼Œæ­¤æ—¶ç›´æ¥è¿”å›äº†aå¯¹è±¡ï¼Œå¹¶æ²¡æœ‰å†æ¬¡åˆ›å»ºã€‚</li><li>ç»§ç»­æ‰§è¡ŒåŸå§‹a()çš„ç¬¬äºŒè¡ŒåŠåé¢çš„ä»£ç ï¼Œæ— å…³æˆ‘ä»¬çš„åˆ†æï¼Œå¯ä»¥å¿½ç•¥ã€‚</li></ol> 
<p>â€ƒ æˆ‘ä»¬åœ¨ä»£ç ä¸­åŠ å…¥æ³¨é‡Šï¼Œè®©å¤§å®¶åŠ æ·±ä¸€ä¸‹å°è±¡ï¼š</p> 
<pre><code>private static class BeanMethodInterceptor implements MethodInterceptor, ConditionalCallback {

   public Object intercept(Object enhancedConfigInstance, Method beanMethod, Object[] beanMethodArgs,
            MethodProxy cglibMethodProxy) throws Throwable {

      // ä»å¢å¼ºåçš„æ³¨è§£é…ç½®ç±»å®ä¾‹ä¸­,è·å–BeanFactory(ä¹Ÿå°±æ˜¯æˆå‘˜å˜é‡$$beanFactory)
      ConfigurableBeanFactory beanFactory = getBeanFactory(enhancedConfigInstance);

      // â‘  åˆ¤æ–­å½“å‰è°ƒç”¨åˆ°çš„æ–¹æ³•ï¼Œæ˜¯å¦æ˜¯æ­£åœ¨æ‰§è¡Œåˆ›å»ºçš„@Beanå·¥å‚æ–¹æ³•
      // 1.1: b()æ‰§è¡Œæ—¶,å·²ç»å°†yæ”¾å…¥ThreadLocalä¸­,è¿™é‡Œè·å–åˆ°çš„æ˜¯b,æ¡ä»¶æˆç«‹
      // 2.1 æ‰§è¡Œåˆ°b()è°ƒç”¨a()äº†,a()ä¹Ÿè¢«ä»£ç†äº†,ä¹Ÿä¼šæ‰§è¡Œåˆ°è¿™é‡Œ,æ­¤æ—¶ThreadLocalä¸­æ˜¯y,æ¡ä»¶ä¸æˆç«‹,æ‰§è¡Œâ‘¡
      if (isCurrentlyInvokedFactoryMethod(beanMethod)) {
         // 1.2 æ‰§è¡Œçˆ¶ç±»ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯@Beanå·¥å‚æ–¹æ³•çš„é€»è¾‘ï¼Œä¼šè°ƒç”¨a()æ–¹æ³•å‘¢
         return cglibMethodProxy.invokeSuper(enhancedConfigInstance, beanMethodArgs);
      }

      // â‘¡ å¦‚æœå½“å‰æ‰§è¡Œçš„æ–¹æ³•ä¸æ˜¯å·¥å‚æ–¹æ³•,æ­¤æ—¶å°±å»springå®¹å™¨ä¸­è·å–@Beanå¯¹åº”çš„beanå®ä¾‹
      // 2.2 å»Springå®¹å™¨ä¸­æŸ¥æ‰¾aå¯¹è±¡ï¼Œä¸å­˜åœ¨ä¼šå®ä¾‹åŒ–çš„ï¼Œè¿™ä¸ªå¯ä»¥è¿”å›
      return resolveBeanReference(beanMethod, beanMethodArgs, beanFactory, beanName);
   }

}
å¤åˆ¶ä»£ç </code></pre> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/0c/09/oqCx0IAb_o.png"></p> 
<p>â€ƒåœ¨ä¸Šé¢çš„æµç¨‹åˆ†ææ—¶ã€‚æˆ‘ä»¬å‘ç°ï¼Œè¯¥æ‹¦æˆªå™¨ç¡®å®åšåˆ°äº†ä¸ä¼šé‡å¤åˆ›å»º@Beanå·¥å‚æ–¹æ³•äº§ç”Ÿçš„beanï¼Œæ ¸å¿ƒåŸç†æ˜¯å¯¹@Beanæ–¹æ³•çš„æ¯æ¬¡è°ƒç”¨éƒ½ä¼šæ‹¦æˆªï¼Œç„¶åå…ˆå»å®¹å™¨æŸ¥é‡ï¼Œå­˜åœ¨ç›´æ¥è¿”å›ã€‚æ­£æ˜¯è¿™ä¸ªæ“ä½œï¼Œä¿è¯äº†@Beanå·¥å‚æ–¹æ³•çš„å¹‚ç­‰ã€‚</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/4b/5d/ppwn3f2p_o.png"></p> 
<p>â€ƒè‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ˜ç™½äº†åœ¨@Configurationé…ç½®ç±»çš„åŠ æŒä¸‹ï¼Œä¸ºä»€ä¹ˆ@Beanå·¥å‚æ–¹æ³•å¯ä»¥ä¿æŒå¹‚ç­‰çš„ç§˜å¯†ã€‚å¸Œæœ›å°ä¼™ä¼´ä»¬èƒ½æœ‰æ‰€æ”¶è·ï¼Œè¿™æ˜¯å¯¹è´°å¸ˆå…„æœ€å¤§çš„å®‰æ…°å“ˆã€‚</p> 
<h2>3. å¢å¼ºä»£ç çš„è°ƒç”¨(é€‰è¯»)</h2> 
<h3>3.1 BeanFactoryAwareMethodInterceptorçš„è°ƒç”¨</h3> 
<p>â€ƒ ä¸Šè¿°åœ¨æåˆ°ä»£ç†ç±»ä¸­ï¼ŒåŠ¨æ€æ·»åŠ çš„å±æ€§<code>$$beanFactory</code>æ˜¯é€šè¿‡æ‹¦æˆªå™¨BeanFactoryAwareMethodInterceptoråå°„èµ‹å€¼çš„ã€‚å¹¶ä¸”åœ¨æ‹¦æˆªå™¨BeanMethodInterceptorç›´æ¥ä½¿ç”¨äº†ã€‚ä½†æ˜¯æ²¡æœ‰ææåŠBeanFactoryAwareMethodInterceptorçš„è¢«è°ƒç”¨æ—¶æœºå’Œè°ƒç”¨å‚æ•°ï¼ŒåŸå› æ˜¯éœ€è¦å°ä¼™ä¼´å¯¹Springçš„ç”Ÿå‘½å‘¨æœŸå’ŒBeançš„ç”Ÿå‘½å‘¨æœŸéœ€è¦æ¯”è¾ƒç†Ÿæ‚‰çš„ç†è§£ã€‚å¤§å®¶éœ€è¦è¡¥å……å¯¹åº”çš„çŸ¥è¯†ã€‚</p> 
<blockquote> 
 <p>å…³äºBeançš„ç”Ÿå‘½å‘¨æœŸï¼Œ<a href="https://juejin.cn/post/7155884227714613285" rel="nofollow" title="èŠé€Spring beançš„ç”Ÿå‘½å‘¨æœŸ">èŠé€Spring beançš„ç”Ÿå‘½å‘¨æœŸ</a>æœ‰ç€æ¯”è¾ƒè¯¦ç»†çš„åˆ†æã€‚ä½†æ˜¯å¯¹Springçš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿˜æ²¡æœ‰æ¥å¾—åŠåˆ†æï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´ï¼Œå¯ä»¥ç•™è¨€å‚¬æ›´å“¦ã€‚</p> 
</blockquote> 
<ul><li><strong>æ³¨å†ŒBeanPostProcessorï¼Œè§¦å‘æ‹¦æˆªå™¨</strong></li></ul> 
<p>â€ƒ åœ¨ä¸Šè¿°çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå¯¹äºå…¨é…ç½®ç±»ç”Ÿæˆä»£ç†å­ç±»çš„é€»è¾‘åœ¨<code>ConfigurationClassPostProcessor#postProcessBeanFactory()</code>ä¸­ï¼Œè¯¥æ–¹æ³•é™¤äº†ç”Ÿæˆä»£ç†ç±»å¤–ï¼Œè¿˜æ‰‹åŠ¨<code>æ·»åŠ äº†ImportAwareBeanPostProcessorè¿™ä¸ªBeançš„åç½®å¤„ç†å™¨ï¼Œè¯¥åç½®å¤„ç†å™¨çš„ä½œç”¨å°±æ˜¯è°ƒç”¨setBeanFactoryæ–¹æ³•(ä¼šè¢«æ‹¦æˆªå™¨BeanFactoryAwareMethodInterceptoræ‹¦æˆªï¼Œè¿›è€Œæ‰§è¡Œæ‹¦æˆªå™¨çš„å†…å®¹)ï¼Œæœ€åä¸ºå±æ€§$$beanFactoryèµ‹å€¼</code>ã€‚</p> 
<pre><code>//ConfigurationClassPostProcessor.java
@Override
public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {
   // ...å…¶ä»–ä»£ç 
   // å¯¹å…¨é…ç½®ç±»è¿›è¡Œå¢å¼º
   enhanceConfigurationClasses(beanFactory);
   // æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªBeanPostProcessor,ç”¨æ¥è®¾ç½®setBeanFactory
   beanFactory.addBeanPostProcessor(new ImportAwareBeanPostProcessor(beanFactory));
}


private static class ImportAwareBeanPostProcessor extends InstantiationAwareBeanPostProcessorAdapter {
    @Override
    public PropertyValues postProcessProperties(@Nullable PropertyValues pvs, Object bean, String beanName) {
        // è°ƒç”¨setBeanFactory()
        if (bean instanceof EnhancedConfiguration) {
            ((EnhancedConfiguration) bean).setBeanFactory(this.beanFactory);
        }
        return pvs;
    }
}
å¤åˆ¶ä»£ç </code></pre> 
<p>â€ƒ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥åç½®å¤„ç†å™¨postProcessProperties()çš„é€»è¾‘å°±æ˜¯è°ƒç”¨setBeanFactory(),å¹¶ä¸”åªè°ƒç”¨ç±»å‹æ˜¯EnhancedConfigurationå­ç±»çš„å“¦ã€‚å°ä¼™ä¼´ä»¬è¿˜è®°ä¸è®°å¾—ï¼ŒSpringä¸ºå…¨é…ç½®ç±»ç”Ÿæˆçš„ä»£ç†ç±»ï¼Œæ‰‹åŠ¨åŠ äº†å®ç°EnhancedConfigurationæ¥å£çš„å“¦ï¼Œè¿™ä¸å°±å¯¹ä¸Šäº†å˜›ï¼Œä½ è¯´å·§ä¸å·§ğŸ˜ã€‚</p> 
<p>â€ƒ è¿˜æœ‰å°ä¼™ä¼´éœ€è¦æ³¨æ„ï¼Œè¯¥åç½®å¤„ç†å™¨ä¸€æ—¦è°ƒç”¨ï¼Œæ‰§è¡Œåˆ°setBeanFactory()æ—¶ï¼Œå°±ä¼šè¢«BeanFactoryAwareMethodInterceptoræ‹¦æˆªï¼Œæ­¤æ—¶ä¼ é€’çš„å‚æ•°æ˜¯<code>this.beanFactory</code>ï¼Œä¹Ÿå°±æ˜¯Springçš„beanå®¹å™¨ï¼Œæ‰€ä»¥åœ¨æ‹¦æˆªå™¨ç›´æ¥args[0]åå°„èµ‹å€¼ï¼Œæ‰æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p> 
<ul><li><strong>ImportAwareBeanPostProcessoråç½®å¤„ç†å™¨çš„è°ƒç”¨</strong> â€ƒ ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“é€šè¿‡åç½®å¤„ç†å™¨ImportAwareBeanPostProcessorè¿›è¡ŒsetBeanFactory()çš„å›è°ƒï¼Œä¹ŸçŸ¥é“ä¼ é€’çš„å‚æ•°æ˜¯Springçš„beanå®¹å™¨ã€‚é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œè¿™ä¸ªåç½®å¤„ç†å™¨æ˜¯ä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼Œæ¯•ç«Ÿä»–è°ƒç”¨äº†ï¼Œæ‹¦æˆªå™¨æ‰èƒ½æ‰§è¡Œï¼Œå±æ€§$$beanFactoryæ‰èƒ½è¢«èµ‹å€¼å•Šã€‚</li></ul> 
<p>â€ƒå¥½çƒ¦å•Šï¼Œæœ‰æ²¡æœ‰ï¼Œæ²¡åŠæ³•ï¼ŒSpringçš„ä»£ç å°±æ˜¯è¿™æ ·ï¼ŒåŠŸèƒ½å®ç°çš„é“¾è·¯å¾ˆé•¿ï¼Œä¹Ÿå¾ˆåˆ†æ•£ï¼Œä¸€ç¯æ‰£ä¸€ç¯ï¼Œæƒ³ä¸²è”èµ·æ¥å¾ˆéš¾ï¼Œè¿™ä¹Ÿæ˜¯ç¬”è€…å†™è¿™ä¸ªç³»åˆ—æ–‡ç« çš„åˆè¡·ï¼Œæƒ³ç»™å¤§å®¶æ•´åˆèµ·æ¥ï¼Œæ˜ç™½æ¥é¾™å»è„‰ï¼Œè¿™æ ·ä¸€æ¥æ–‡ç« ç¯‡å¹…åŠ¿å¿…å¾ˆé•¿ï¼Œæ²¡åŠæ³•çš„ï¼Œå¤§å®¶å¿è€ä¸€ä¸‹ã€‚å¥½äº†ï¼Œä¸å•°å—¦äº†ï¼Œæˆ‘ä»¬ç»§ç»­ã€‚</p> 
<p>â€ƒ ä»”ç»†çœ‹ç¬”è€…<a href="https://link.juejin.cn/?target=https%3A%2F%2Fjuejin.cn%2Fpost%2F7155884227714613285" rel="nofollow" title="èŠé€Spring beançš„ç”Ÿå‘½å‘¨æœŸ">èŠé€Spring beançš„ç”Ÿå‘½å‘¨æœŸ</a>è¿™ç¯‡æ–‡ç« çš„å°ä¼™ä¼´å¯èƒ½æœ‰å°è±¡ï¼Œåœ¨å±æ€§å¡«å……è¿™ä¸€æ­¥ï¼Œå›è°ƒçš„åç½®å¤„ç†å™¨ï¼Œæœ‰ImportAwareBeanPostProcessorï¼Œæˆ‘ä»¬åœ¨ä¸€èµ·çœ‹ä¸€ä¸‹ï¼š</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/bf/23/FLEsmRhe_o.png"></p> 
<p>â€ƒ OKï¼Œç°åœ¨è¿™ä¸ªè¿™ä¸ªé“¾è·¯ä¹Ÿæ¸…æ™°äº†ï¼Œæˆ‘ä»¬ä¸€èµ·æ€»ç»“ä¸€ä¸‹ï¼š</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/6f/72/HSWarbMI_o.png"></p> 
<h3>3.2 BeanMethodInterceptorçš„è°ƒç”¨</h3> 
<p>â€ƒ å…³äº@Beanå·¥å‚æ–¹æ³•çš„è°ƒç”¨æ—¶æœºï¼Œå…¶å®æ˜¯åœ¨beançš„ç”Ÿå‘½å‘¨æœŸçš„<code>åˆå§‹åŒ–beané˜¶æ®µ</code>ï¼Œä¸æ¸…æ¥šçš„å°ä¼™ä¼´è‡ªè¡ŒæŸ¥çœ‹å§ã€‚å•°å—¦ä¸åŠ¨äº†ã€‚</p> 
<p>â€ƒ ç”±äºBeanFactoryAwareMethodInterceptoræ‹¦æˆªå™¨çš„è°ƒç”¨åœ¨beançš„ç”Ÿå‘½å‘¨æœŸçš„<code>å±æ€§å¡«å……é˜¶æ®µ</code>ï¼ŒBeanMethodInterceptorçš„è°ƒç”¨åœ¨<code>åˆå§‹åŒ–beané˜¶æ®µ</code>ï¼Œæ‰€ä»¥æ˜¯èƒ½ä¿è¯<code>BeanFactoryAwareMethodInterceptor</code>æ‹¦æˆªå™¨çš„è§¦å‘æ—©äº<code>BeanMethodInterceptor</code>æ‹¦æˆªå™¨çš„ï¼Œè¿™ä¹Ÿæ˜¯<code>BeanMethodInterceptor</code>èƒ½å¤Ÿç›´æ¥ä½¿ç”¨çš„åŸå› ã€‚</p> 
<p>â€ƒæœ€åæˆ‘ä»¬ä¸€èµ·æ€»ç»“ä¸€ä¸‹å§ï¼Œå¸Œæœ›å¤§å®¶å¤šå­¦ä¹ ï¼Œå¤šè¿›æ­¥ï¼Œæœ€åç¥å¤§å®¶æ–°å¹´å¿«ä¹ï¼Œå‘å¤§è´¢ã€‚</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/0f/4f/YFOn2MXq_o.png"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4ed61f89047decf753e0cf9c23188b04/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Android10 å¼€æœºå‘å¯¼æµç¨‹</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7fc964deaf070df6b2e689d5509869cf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">dockerè¿è¡Œnginx</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 ç¼–ç¨‹éšæƒ³.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>