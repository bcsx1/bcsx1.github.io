<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flink教程（26）- Flink多语言开发 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flink教程（26）- Flink多语言开发" />
<meta property="og:description" content="文章目录 01 引言02 Scala-Flink2.1 需求2.2 准备工作2.3 代码实现2.3.1 入口类-数据解析2.3.2 数据预处理2.3.3 实时频道热点2.3.4 实时频道PV/UV 03 Py-Flink3.1 环境准备3.2 官方文档3.3 示例代码 04 文末 01 引言 在前面的博客，我们学习了Flink的高级特性了，有兴趣的同学可以参阅下：
《Flink教程（01）- Flink知识图谱》《Flink教程（02）- Flink入门》《Flink教程（03）- Flink环境搭建》《Flink教程（04）- Flink入门案例》《Flink教程（05）- Flink原理简单分析》《Flink教程（06）- Flink批流一体API（Source示例）》《Flink教程（07）- Flink批流一体API（Transformation示例）》《Flink教程（08）- Flink批流一体API（Sink示例）》《Flink教程（09）- Flink批流一体API（Connectors示例）》《Flink教程（10）- Flink批流一体API（其它）》《Flink教程（11）- Flink高级API（Window）》《Flink教程（12）- Flink高级API（Time与Watermaker）》《Flink教程（13）- Flink高级API（状态管理）》《Flink教程（14）- Flink高级API（容错机制）》《Flink教程（15）- Flink高级API（并行度）》《Flink教程（16）- Flink Table与SQL》《Flink教程（17）- Flink Table与SQL（案例与SQL算子）》《Flink教程（18）- Flink阶段总结》《Flink教程（19）- Flink高级特性（BroadcastState）》《Flink教程（20）- Flink高级特性（双流Join）》《Flink教程（21）- Flink高级特性（End-to-End Exactly-Once）》《Flink教程（22）- Flink高级特性（异步IO）》《Flink教程（23）- Flink高级特性（Streaming File Sink）》《Flink教程（24）- Flink高级特性（File Sink）》《Flink教程（25）- Flink高级特性（FlinkSQL整合Hive）》 本文主要讲解Flink多语言开发。
参考：https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/scala_api_extensions.html
02 Scala-Flink 2.1 需求 使用Flink从Kafka接收对电商点击流日志数据并进行实时处理:
数据预处理:对数据进行拓宽处理,也就是将数据变为宽表,方便后续分析分析实时频道热点分析实时频道PV/UV 2.2 准备工作 kafka：
查看主题: /export/servers/kafka/bin/kafka-topics.sh --list --zookeeper node01:2181 创建主题: /export/servers/kafka/bin/kafka-topics." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/4f9332d8f23ad8946484e95e4462baa9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-09T09:36:14+08:00" />
<meta property="article:modified_time" content="2022-03-09T09:36:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flink教程（26）- Flink多语言开发</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#font_colorpurple01_font_2" rel="nofollow"><font color="purple">01 引言</font></a></li><li><a href="#font_colorpurple02__ScalaFlinkfont_34" rel="nofollow"><font color="purple">02 Scala-Flink</font></a></li><li><ul><li><a href="#font_colorpurple21_font_35" rel="nofollow"><font color="purple">2.1 需求</font></a></li><li><a href="#font_colorpurple22_font_41" rel="nofollow"><font color="purple">2.2 准备工作</font></a></li><li><a href="#font_colorpurple23_font_63" rel="nofollow"><font color="purple">2.3 代码实现</font></a></li><li><ul><li><a href="#font_colorpurple231_font_64" rel="nofollow"><font color="purple">2.3.1 入口类-数据解析</font></a></li><li><a href="#font_colorpurple232_font_184" rel="nofollow"><font color="purple">2.3.2 数据预处理</font></a></li><li><a href="#font_colorpurple233_font_355" rel="nofollow"><font color="purple">2.3.3 实时频道热点</font></a></li><li><a href="#font_colorpurple234__PVUVfont_414" rel="nofollow"><font color="purple">2.3.4 实时频道PV/UV</font></a></li></ul> 
  </li></ul> 
  </li><li><a href="#font_colorpurple03__PyFlinkfont_512" rel="nofollow"><font color="purple">03 Py-Flink</font></a></li><li><ul><li><a href="#font_colorpurple31__font_514" rel="nofollow"><font color="purple">3.1 环境准备</font></a></li><li><a href="#font_colorpurple32__font_522" rel="nofollow"><font color="purple">3.2 官方文档</font></a></li><li><a href="#font_colorpurple33__font_528" rel="nofollow"><font color="purple">3.3 示例代码</font></a></li></ul> 
  </li><li><a href="#font_colorpurple04__font_596" rel="nofollow"><font color="purple">04 文末</font></a></li></ul> 
</div> 
<p></p> 
<h2><a id="font_colorpurple01_font_2"></a><font color="purple">01 引言</font></h2> 
<p>在前面的博客，我们学习了<code>Flink</code>的高级特性了，有兴趣的同学可以参阅下：</p> 
<ul><li><a href="https://blog.csdn.net/qq_20042935/article/details/123266428">《Flink教程（01）- Flink知识图谱》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123270241" rel="nofollow">《Flink教程（02）- Flink入门》</a></li><li><a href="https://blog.csdn.net/qq_20042935/article/details/123301415">《Flink教程（03）- Flink环境搭建》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123320012" rel="nofollow">《Flink教程（04）- Flink入门案例》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123328970" rel="nofollow">《Flink教程（05）- Flink原理简单分析》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123330057" rel="nofollow">《Flink教程（06）- Flink批流一体API（Source示例）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123331326" rel="nofollow">《Flink教程（07）- Flink批流一体API（Transformation示例）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123333251" rel="nofollow">《Flink教程（08）- Flink批流一体API（Sink示例）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123333805" rel="nofollow">《Flink教程（09）- Flink批流一体API（Connectors示例）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123335379" rel="nofollow">《Flink教程（10）- Flink批流一体API（其它）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123335880" rel="nofollow">《Flink教程（11）- Flink高级API（Window）》</a></li><li><a href="https://blog.csdn.net/qq_20042935/article/details/123336792">《Flink教程（12）- Flink高级API（Time与Watermaker）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123342631" rel="nofollow">《Flink教程（13）- Flink高级API（状态管理）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123344815" rel="nofollow">《Flink教程（14）- Flink高级API（容错机制）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123347021" rel="nofollow">《Flink教程（15）- Flink高级API（并行度）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123347418" rel="nofollow">《Flink教程（16）- Flink Table与SQL》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123352194" rel="nofollow">《Flink教程（17）- Flink Table与SQL（案例与SQL算子）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123356206" rel="nofollow">《Flink教程（18）- Flink阶段总结》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123365438" rel="nofollow">《Flink教程（19）- Flink高级特性（BroadcastState）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123365662" rel="nofollow">《Flink教程（20）- Flink高级特性（双流Join）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123365902" rel="nofollow">《Flink教程（21）- Flink高级特性（End-to-End Exactly-Once）》</a></li><li><a href="https://blog.csdn.net/qq_20042935/article/details/123366226">《Flink教程（22）- Flink高级特性（异步IO）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123368281" rel="nofollow">《Flink教程（23）- Flink高级特性（Streaming File Sink）》</a></li><li><a href="https://yanglinwei.blog.csdn.net/article/details/123368637" rel="nofollow">《Flink教程（24）- Flink高级特性（File Sink）》</a></li><li><a href="https://blog.csdn.net/qq_20042935/article/details/123368760">《Flink教程（25）- Flink高级特性（FlinkSQL整合Hive）》</a></li></ul> 
<p>本文主要讲解<code>Flink</code>多语言开发。</p> 
<blockquote> 
 <p>参考：<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/scala_api_extensions.html" rel="nofollow">https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/scala_api_extensions.html</a></p> 
</blockquote> 
<h2><a id="font_colorpurple02__ScalaFlinkfont_34"></a><font color="purple">02 Scala-Flink</font></h2> 
<h3><a id="font_colorpurple21_font_35"></a><font color="purple">2.1 需求</font></h3> 
<p>使用Flink从Kafka接收对电商点击流日志数据并进行实时处理:</p> 
<ol><li>数据预处理:对数据进行拓宽处理,也就是将数据变为宽表,方便后续分析</li><li>分析实时频道热点</li><li>分析实时频道PV/UV</li></ol> 
<h3><a id="font_colorpurple22_font_41"></a><font color="purple">2.2 准备工作</font></h3> 
<p>kafka：</p> 
<pre><code class="prism language-bash">查看主题:
/export/servers/kafka/bin/kafka-topics.sh --list --zookeeper node01:2181

创建主题:
/export/servers/kafka/bin/kafka-topics.sh --create --zookeeper node01:2181 --replication-factor 2 --partitions 3 --topic pyg

再次查看主题:
/export/servers/kafka/bin/kafka-topics.sh --list --zookeeper node01:2181

启动控制台消费者
/export/servers/kafka/bin/kafka-console-consumer.sh --bootstrap-server node01:9092 --from-beginning --topic pyg

删除主题--不需要执行
/export/servers/kafka/bin/kafka-topics.sh --delete --zookeeper node01:2181 --topic pyg
</code></pre> 
<p>导入准备骨架代码：<br> <img src="https://images2.imgbox.com/0d/20/fHSZGU4V_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="font_colorpurple23_font_63"></a><font color="purple">2.3 代码实现</font></h3> 
<h4><a id="font_colorpurple231_font_64"></a><font color="purple">2.3.1 入口类-数据解析</font></h4> 
<p><img src="https://images2.imgbox.com/7f/f4/KbscFUXV_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-scala"><span class="token keyword">object</span> App <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//注意:TODO在开发中表示该步骤未完成,后续需要补全</span>
    <span class="token comment">//在这里仅仅为了使用不同的颜色区分步骤</span>
    <span class="token comment">//TODO 1.准备环境StreamExecutionEnvironment</span>
    <span class="token keyword">val</span> env<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token comment">//TODO 2.设置环境参数(Checkpoint/重启策略/是否使用事件时间...)</span>
    <span class="token comment">//=================建议必须设置的===================</span>
    <span class="token comment">//设置Checkpoint-State的状态后端为FsStateBackend,本地测试时使用本地路径,集群测试时使用传入的HDFS的路径</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>length<span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      env<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> FsStateBackend<span class="token punctuation">(</span><span class="token string">"file:///D:/ckp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
      env<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> FsStateBackend<span class="token punctuation">(</span>args<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//后续集群测试时传入hdfs://node01:8020/flink-checkpoint/checkpoint</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//设置Checkpointing时间间隔为1000ms,意思是做 2 个 Checkpoint 的间隔为1000ms。Checkpoint 做的越频繁，恢复数据时就越简单，同时 Checkpoint 相应的也会有一些IO消耗。</span>
    env<span class="token punctuation">.</span>enableCheckpointing<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token comment">//(默认情况下如果不设置时间checkpoint是没有开启的)</span>
    <span class="token comment">//设置两个Checkpoint 之间最少等待时间,如设置Checkpoint之间最少是要等 500ms(为了避免每隔1000ms做一次Checkpoint的时候,前一次太慢和后一次重叠到一起去了)</span>
    <span class="token comment">//如:高速公路上,每隔1s关口放行一辆车,但是规定了两车之前的最小车距为500m</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMinPauseBetweenCheckpoints<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token comment">//默认是0</span>
    <span class="token comment">//设置如果在做Checkpoint过程中出现错误，是否让整体任务失败：true是  false不是</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setFailOnCheckpointingErrors<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//默认是true</span>
    <span class="token comment">//设置是否清理检查点,表示 Cancel 时是否需要保留当前的 Checkpoint，默认 Checkpoint会在作业被Cancel时被删除</span>
    <span class="token comment">//ExternalizedCheckpointCleanup.DELETE_ON_CANCELLATION：true,当作业被取消时，删除外部的checkpoint(默认值)</span>
    <span class="token comment">//ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION：false,当作业被取消时，保留外部的checkpoint</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>enableExternalizedCheckpoints<span class="token punctuation">(</span>ExternalizedCheckpointCleanup<span class="token punctuation">.</span>RETAIN_ON_CANCELLATION<span class="token punctuation">)</span>
    <span class="token comment">//=================建议必须设置的===================</span>

    <span class="token comment">//=================直接使用默认的即可===============</span>
    <span class="token comment">//设置checkpoint的执行模式为EXACTLY_ONCE(默认),注意:得需要外部支持,如Source和Sink的支持</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointingMode<span class="token punctuation">(</span>CheckpointingMode<span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span>
    <span class="token comment">//设置checkpoint的超时时间,如果 Checkpoint在 60s内尚未完成说明该次Checkpoint失败,则丢弃。</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setCheckpointTimeout<span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token comment">//默认10分钟</span>
    <span class="token comment">//设置同一时间有多少个checkpoint可以同时执行</span>
    env<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span>setMaxConcurrentCheckpoints<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//默认为1</span>
    <span class="token comment">//=================直接使用默认的即可===============</span>


    <span class="token comment">//======================配置重启策略==============</span>
    <span class="token comment">//1.如果配置了Checkpoint,而没有配置重启策略,那么代码中出现了非致命错误时,程序会无限重启</span>
    <span class="token comment">//2.配置无重启策略</span>
    <span class="token comment">//env.setRestartStrategy(RestartStrategies.noRestart())</span>
    <span class="token comment">//3.固定延迟重启策略--开发中使用</span>
    <span class="token comment">//如下:如果有异常,每隔10s重启1次,最多3次</span>
    env<span class="token punctuation">.</span>setRestartStrategy<span class="token punctuation">(</span>RestartStrategies<span class="token punctuation">.</span>fixedDelayRestart<span class="token punctuation">(</span>
      <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 最多重启3次数</span>
      org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span> <span class="token comment">// 重启时间间隔</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//4.失败率重启策略--开发偶尔使用</span>
    <span class="token comment">//如下:5分钟内,最多重启3次,每次间隔10</span>
    <span class="token comment">/*env.setRestartStrategy(RestartStrategies.failureRateRestart(
      3, // 每个测量时间间隔最大失败次数
      Time.of(5, TimeUnit.MINUTES), //失败率测量的时间间隔
      Time.of(10, TimeUnit.SECONDS) // 两次连续重启的时间间隔
    ))*/</span>
    <span class="token comment">//======================配置重启策略==============</span>

    <span class="token comment">//TODO 3.Source-Kafka</span>
    <span class="token keyword">val</span> topic<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">"pyg"</span>
    <span class="token keyword">val</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> SimpleStringSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> props<span class="token operator">:</span>Properties <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span>CommonClientConfigs<span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span><span class="token string">"node1:9092"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span><span class="token string">"flink"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"auto.offset.reset"</span><span class="token punctuation">,</span><span class="token string">"latest"</span><span class="token punctuation">)</span><span class="token comment">//如果有记录偏移量从记录的位置开始消费,如果没有从最新的数据开始消费</span>
    props<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"flink.partition-discovery.interval-millis"</span><span class="token punctuation">,</span><span class="token string">"5000"</span><span class="token punctuation">)</span><span class="token comment">//动态分区检测,开一个后台线程每隔5s检查Kafka的分区状态</span>

    <span class="token keyword">val</span> kafkaSource<span class="token operator">:</span> FlinkKafkaConsumer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> FlinkKafkaConsumer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span>schema<span class="token punctuation">,</span>props<span class="token punctuation">)</span>
    kafkaSource<span class="token punctuation">.</span>setCommitOffsetsOnCheckpoints<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">//在执行Checkpoint的时候,会提交offset(一份在Checkpoint中,一份在默认主题)</span>

    <span class="token keyword">val</span> jsonStrDS<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>addSource<span class="token punctuation">(</span>kafkaSource<span class="token punctuation">)</span>
    <span class="token comment">//jsonStrDS.print()</span>
    <span class="token comment">// {"count":1,"message":"{\"browserType\":\"火狐\",\"categoryID\":20,\"channelID\":20,\"city\":\"ZhengZhou\",\"country\":\"china\",\"entryTime\":1577898060000,\"leaveTime\":1577898060000,\"network\":\"电信\",\"produceID\":15,\"province\":\"HeBei\",\"source\":\"直接输入\",\"userID\":2}","timeStamp":1598754734031}</span>

    <span class="token comment">//TODO 4.解析jsonStr数据为样例类Message</span>
    <span class="token keyword">val</span> messageDS<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> jsonStrDS<span class="token punctuation">.</span>map<span class="token punctuation">(</span>jsonStr <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> jsonObj<span class="token operator">:</span> JSONObject <span class="token operator">=</span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span>
      <span class="token keyword">val</span> count<span class="token operator">:</span> lang<span class="token punctuation">.</span><span class="token builtin">Long</span> <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> timeStamp<span class="token operator">:</span> lang<span class="token punctuation">.</span><span class="token builtin">Long</span> <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token string">"timeStamp"</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> clickLogStr<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> jsonObj<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> clickLog<span class="token operator">:</span> ClickLog <span class="token operator">=</span> JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>clickLogStr<span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>ClickLog<span class="token punctuation">]</span><span class="token punctuation">)</span>
      Message<span class="token punctuation">(</span>clickLog<span class="token punctuation">,</span> count<span class="token punctuation">,</span> timeStamp<span class="token punctuation">)</span>
      <span class="token comment">//不能使用下面偷懒的办法</span>
      <span class="token comment">//val message: Message = JSON.parseObject(jsonStr,classOf[Message])</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//messageDS.print()</span>
    <span class="token comment">//Message(ClickLog(10,10,3,china,HeBei,ZhengZhou,电信,360搜索跳转,谷歌浏览器,1577876460000,1577898060000,15),1,1598754740100)</span>

    <span class="token comment">//TODO 5.给数据添加Watermaker(或者放在第6步)</span>
    env<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>getConfig<span class="token punctuation">.</span>setAutoWatermarkInterval<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> watermakerDS<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> messageDS<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
      <span class="token keyword">new</span> BoundedOutOfOrdernessTimestampExtractor<span class="token punctuation">[</span>Message<span class="token punctuation">]</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> Message<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>timeStamp
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token comment">//TODO 6.数据预处理</span>
    <span class="token comment">//为了方便后续的指标统计,可以对上面解析处理的日志信息Message进行预处理,如拓宽字段</span>
    <span class="token comment">//预处理的代码可以写在这里,也可以单独抽取出一个方法来完成,也可以单独抽取一个object.方法来完成</span>
    <span class="token comment">//把DataStream[Message]拓宽为DataStream[ClickLogWide]</span>
    <span class="token keyword">val</span> clickLogWideDS<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>ClickLogWide<span class="token punctuation">]</span> <span class="token operator">=</span> ProcessTask<span class="token punctuation">.</span>process<span class="token punctuation">(</span>watermakerDS<span class="token punctuation">)</span>
    clickLogWideDS<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//ClickLogWide(18,9,10,china,HeNan,LuoYang,移动,百度跳转,谷歌浏览器,1577887260000,1577898060000,15,1,1598758614216,chinaHeNanLuoYang,202008,20200830,2020083011,0,0,0,0)</span>


    <span class="token comment">//TODO 7.实时指标统计分析-直接sink结果到HBase</span>
    <span class="token comment">//实时指标统计分析-实时频道热点</span>
    ChannelRealHotTask<span class="token punctuation">.</span>process<span class="token punctuation">(</span>clickLogWideDS<span class="token punctuation">)</span>
    <span class="token comment">//实时指标统计分析-实时频道分时段PV/UV</span>
    ChannelRealPvUvTask<span class="token punctuation">.</span>process<span class="token punctuation">(</span>clickLogWideDS<span class="token punctuation">)</span>


    <span class="token comment">//TODO 8.execute</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="font_colorpurple232_font_184"></a><font color="purple">2.3.2 数据预处理</font></h4> 
<p><img src="https://images2.imgbox.com/e1/60/QW94xUHz_o.png" alt="在这里插入图片描述"><br> 为了方便后续分析，我们需要对点击流日志，使用Flink进行实时预处理。在原有点击流日志的基础上添加一些字段，方便进行后续业务功能的统计开发。</p> 
<p>以下为Kafka中消费得到的原始点击流日志字段：</p> 
<p>字段名 说明<br> channelID 频道ID<br> categoryID 产品类别ID<br> produceID 产品ID<br> country 国家<br> province 省份<br> city 城市<br> network 网络方式<br> source 来源方式<br> browserType 浏览器类型<br> entryTime 进入网站时间<br> leaveTime 离开网站时间<br> userID 用户的ID</p> 
<p>我们需要在原有点击流日志字段基础上，再添加以下字段：<br> 字段名 说明<br> count 用户访问的次数<br> timestamp 用户访问的时间<br> address 国家省份城市（拼接）<br> yearMonth 年月<br> yearMonthDay 年月日<br> yearMonthDayHour 年月日时<br> isNew 是否为访问某个频道的新用户<br> isHourNew 在某一小时内是否为某个频道的新用户<br> isDayNew 在某一天是否为某个频道的新用户<br> isMonthNew 在某一个月是否为某个频道的新用户</p> 
<p>我们不能直接从点击流日志中，直接计算得到上述后4个字段的值。而是需要在hbase中有一个历史记录表，来保存用户的历史访问状态才能计算得到。<br> 该历史记录表(user_history表)结构如下：<br> 列名 说明 示例<br> rowkey 用户ID:频道ID 10:220<br> userid 用户ID 10<br> channelid 频道ID 220<br> lastVisitedTime 最后访问时间（时间戳） 1553653555</p> 
<pre><code class="prism language-scala"><span class="token comment">/**
 * Author itcast
 * Desc 数据预处理模块业务任务
 */</span>
<span class="token keyword">object</span> ProcessTask <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//将添加了水印的原始的用户行为日志数据根据需求转为宽表ClickLogWide并返回</span>
  <span class="token comment">//将DataStream[Message]转为DataStream[ClickLogWide]</span>
  <span class="token keyword">def</span> process<span class="token punctuation">(</span>watermakerDS<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Message<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> DataStream<span class="token punctuation">[</span>ClickLogWide<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_
    <span class="token keyword">val</span> clickLogWideDS<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>ClickLogWide<span class="token punctuation">]</span> <span class="token operator">=</span> watermakerDS<span class="token punctuation">.</span>map<span class="token punctuation">(</span>message <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">val</span> address<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>country <span class="token operator">+</span> message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>province <span class="token operator">+</span> message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>city
      <span class="token keyword">val</span> yearMonth<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span>parseTime<span class="token punctuation">(</span>message<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span> <span class="token string">"yyyyMM"</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> yearMonthDay<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span>parseTime<span class="token punctuation">(</span>message<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span> <span class="token string">"yyyyMMdd"</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> yearMonthDayHour<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span>parseTime<span class="token punctuation">(</span>message<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span> <span class="token string">"yyyyMMddHH"</span><span class="token punctuation">)</span>

      <span class="token keyword">val</span> <span class="token punctuation">(</span>isNew<span class="token punctuation">,</span> isHourNew<span class="token punctuation">,</span> isDayNew<span class="token punctuation">,</span> isMonthNew<span class="token punctuation">)</span> <span class="token operator">=</span> getIsNew<span class="token punctuation">(</span>message<span class="token punctuation">)</span>

      <span class="token keyword">val</span> clickLogWide <span class="token operator">=</span> ClickLogWide<span class="token punctuation">(</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>channelID<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>categoryID<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>produceID<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>country<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>province<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>city<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>network<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>source<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>browserType<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>entryTime<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>leaveTime<span class="token punctuation">,</span>
        message<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>userID<span class="token punctuation">,</span>

        message<span class="token punctuation">.</span>count<span class="token punctuation">,</span> <span class="token comment">//用户访问的次数</span>
        message<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span> <span class="token comment">//用户访问的时间</span>

        address<span class="token punctuation">,</span> <span class="token comment">//国家省份城市-拼接</span>
        yearMonth<span class="token punctuation">,</span> <span class="token comment">//年月</span>
        yearMonthDay<span class="token punctuation">,</span> <span class="token comment">//年月日</span>
        yearMonthDayHour<span class="token punctuation">,</span> <span class="token comment">//年月日时</span>

        isNew<span class="token punctuation">,</span> <span class="token comment">//是否为访问某个频道的新用户——0表示否，1表示是</span>
        isHourNew<span class="token punctuation">,</span> <span class="token comment">//在某一小时内是否为某个频道的新用户——0表示否，1表示是</span>
        isDayNew<span class="token punctuation">,</span> <span class="token comment">//在某一天是否为某个频道的新用户—0表示否，1表示是</span>
        isMonthNew <span class="token comment">//在某一个月是否为某个频道的新用户——0表示否，1表示是</span>
      <span class="token punctuation">)</span>
      clickLogWide
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    clickLogWideDS
  <span class="token punctuation">}</span>

  <span class="token comment">/*如:某用户,2020-08-30-11,第一次访问该频道
  那么这条日志
  isNew=1
  isHourNew=1
  isDayNew=1
  isMonthNew=1
  该用户2020-08-30-11,再次访问
  那么这条日志:
  isNew=0
  isHourNew=0
  isDayNew=0
  isMonthNew=0
  该用户2020-08-30-12,再次访问
  isNew=0
  isHourNew=1
  isDayNew=0
  isMonthNew=0
  该用户2020-08-31-09,再次访问
  isNew=0
  isHourNew=1
  isDayNew=1
  isMonthNew=0*/</span>
  <span class="token keyword">def</span> getIsNew<span class="token punctuation">(</span>msg<span class="token operator">:</span> Message<span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> isNew<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">//是否为访问某个频道的新用户——0表示否，1表示是</span>
    <span class="token keyword">var</span> isHourNew<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">//在某一小时内是否为某个频道的新用户——0表示否，1表示是</span>
    <span class="token keyword">var</span> isDayNew<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">//在某一天是否为某个频道的新用户—0表示否，1表示是</span>
    <span class="token keyword">var</span> isMonthNew<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token comment">//在某一个月是否为某个频道的新用户——0表示否，1表示是</span>

    <span class="token comment">//如何判断该用户是该频道的各个isxxNew?</span>
    <span class="token comment">//可以把上次 该用户 访问 该频道 的 访问时间 记录在外部介质中,如HBase中</span>
    <span class="token comment">//进来一条日志,先去HBase查该用户该频道的lastVisitTime</span>
    <span class="token comment">//没有结果--isxxNew全是1</span>
    <span class="token comment">//有结果--把这次访问时间和lastVisitTime进行比较</span>

    <span class="token comment">//1.定义一些HBase的常量,如表名,列族名,字段名</span>
    <span class="token keyword">val</span> tableName <span class="token operator">=</span> <span class="token string">"user_history"</span>
    <span class="token keyword">val</span> columnFamily <span class="token operator">=</span> <span class="token string">"info"</span>
    <span class="token keyword">val</span> rowkey <span class="token operator">=</span> msg<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>userID <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>clickLog<span class="token punctuation">.</span>channelID
    <span class="token keyword">val</span> queryColumn <span class="token operator">=</span> <span class="token string">"lastVisitTime"</span>

    <span class="token comment">//2.根据该用户的该频道去查lastVisitTime</span>
    <span class="token comment">//注意:记得修改resources/hbase-site.xml中的主机名,还得启动HBase</span>
    <span class="token keyword">val</span> lastVisitTime<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> HBaseUtil<span class="token punctuation">.</span>getData<span class="token punctuation">(</span>tableName<span class="token punctuation">,</span>rowkey<span class="token punctuation">,</span>columnFamily<span class="token punctuation">,</span>queryColumn<span class="token punctuation">)</span>

    <span class="token comment">//3.判断lastVisitTime是否有值</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span>isBlank<span class="token punctuation">(</span>lastVisitTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">//如果lastVisitTime为空,说明该用户之前没有访问过该频道,全设置为1即可</span>
      isNew <span class="token operator">=</span> <span class="token number">1</span>
      isHourNew <span class="token operator">=</span> <span class="token number">1</span>
      isDayNew <span class="token operator">=</span> <span class="token number">1</span>
      isMonthNew <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">//如果lastVisitTime不为空,说明该用户之前访问过该频道,那么isxxNew给根据情况来赋值</span>
      <span class="token comment">//如:lastVisitTime为2020-08-30-11,当前这一次访问时间为:2020-08-30-12,那么isHourNew=1,其他的为0</span>
      <span class="token comment">//如:lastVisitTime为2020-08-30,当前这一次访问时间为:2020-08-31,那么isDayNew=1,其他的为0</span>
      <span class="token comment">//如:lastVisitTime为2020-08,当前这一次访问时间为:2020-09,那么isMonthNew=1,其他的为0</span>
      isNew <span class="token operator">=</span> <span class="token number">0</span>
      isHourNew <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span>compareDate<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>lastVisitTime<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span><span class="token string">"yyyyMMddHH"</span><span class="token punctuation">)</span>
      isDayNew <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span>compareDate<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>lastVisitTime<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span><span class="token string">"yyyyMMdd"</span><span class="token punctuation">)</span>
      isMonthNew <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span>compareDate<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span>lastVisitTime<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span><span class="token string">"yyyyMM"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//不要忘了把这一次的访问时间作为lastVisitTime存入HBase</span>
    HBaseUtil<span class="token punctuation">.</span>putData<span class="token punctuation">(</span>tableName<span class="token punctuation">,</span>rowkey<span class="token punctuation">,</span>columnFamily<span class="token punctuation">,</span>queryColumn<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>timeStamp<span class="token punctuation">.</span>toString<span class="token punctuation">)</span>

    <span class="token punctuation">(</span>isNew<span class="token punctuation">,</span>isHourNew<span class="token punctuation">,</span>isDayNew<span class="token punctuation">,</span>isMonthNew<span class="token punctuation">)</span>

    <span class="token comment">//注意:</span>
    <span class="token comment">/*
    测试时先启动hbase
     /export/servers/hbase/bin/start-hbase.sh
    再登入hbase shell
     ./hbase shell
    查看hbase表
    list
    运行后会生成表,然后查看表数据
    scan "user_history",{LIMIT=&gt;10}
     */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="font_colorpurple233_font_355"></a><font color="purple">2.3.3 实时频道热点</font></h4> 
<p>频道热点，就是要统计频道被访问（点击）的数量。<br> 分析得到以下的数据：<br> <img src="https://images2.imgbox.com/12/33/CqWsFyYf_o.png" alt="在这里插入图片描述"><br> 需要将历史的点击数据进行累加</p> 
<pre><code class="prism language-scala"><span class="token keyword">object</span> ChannelRealHotTask <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//定义一个样例类,用来封装频道id和访问次数</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> ChannelRealHot<span class="token punctuation">(</span>channelId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> visited<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span>

  <span class="token comment">//根据传入的用户行为日志宽表,进行频道的访问次数统计分析,并将结果保存到HBase</span>
  <span class="token keyword">def</span> process<span class="token punctuation">(</span>clickLogWideDS<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>ClickLogWide<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_
    <span class="token comment">//1.取出我们需要的字段channelID和count,并封装为样例类</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>ChannelRealHot<span class="token punctuation">]</span> <span class="token operator">=</span> clickLogWideDS
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>clickLogWide <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        ChannelRealHot<span class="token punctuation">(</span>clickLogWide<span class="token punctuation">.</span>channelID<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">//2.分组</span>
      <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>channelId<span class="token punctuation">)</span>
      <span class="token comment">//3.窗口</span>
      <span class="token comment">//ize: Time, slide: Time</span>
      <span class="token comment">//需求:每隔10s统计一次各个频道的访问次数</span>
      <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//4.聚合</span>
      <span class="token punctuation">.</span>reduce<span class="token punctuation">(</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        ChannelRealHot<span class="token punctuation">(</span>c2<span class="token punctuation">.</span>channelId<span class="token punctuation">,</span> c1<span class="token punctuation">.</span>visited <span class="token operator">+</span> c2<span class="token punctuation">.</span>visited<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//5.结果存入HBase</span>
    result<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span><span class="token keyword">new</span> SinkFunction<span class="token punctuation">[</span>ChannelRealHot<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> invoke<span class="token punctuation">(</span>value<span class="token operator">:</span> ChannelRealHot<span class="token punctuation">,</span> context<span class="token operator">:</span> SinkFunction<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//在这里调用HBaseUtil将每条结果(每个频道的访问次数),保存到HBase</span>
        <span class="token comment">//-1.先查HBase该频道的上次的访问次数</span>
        <span class="token keyword">val</span> tableName <span class="token operator">=</span> <span class="token string">"channel_realhot"</span>
        <span class="token keyword">val</span> columnFamily <span class="token operator">=</span> <span class="token string">"info"</span>
        <span class="token keyword">val</span> queryColumn <span class="token operator">=</span> <span class="token string">"visited"</span>
        <span class="token keyword">val</span> rowkey <span class="token operator">=</span> value<span class="token punctuation">.</span>channelId
        <span class="token keyword">val</span> historyValueStr<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> HBaseUtil<span class="token punctuation">.</span>getData<span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> rowkey<span class="token punctuation">,</span> columnFamily<span class="token punctuation">,</span> queryColumn<span class="token punctuation">)</span>

        <span class="token keyword">var</span> currentFinalResult <span class="token operator">=</span> <span class="token number">0L</span>

        <span class="token comment">//-2.判断并合并结果</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span>isBlank<span class="token punctuation">(</span>historyValueStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//如果historyValueStr为空,直接让本次的次数作为本次最终的结果并保存</span>
          currentFinalResult <span class="token operator">=</span> value<span class="token punctuation">.</span>visited
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//如果historyValueStr不为空,本次的次数+历史值 作为本次最终的结果并保存</span>
          currentFinalResult <span class="token operator">=</span> value<span class="token punctuation">.</span>visited <span class="token operator">+</span> historyValueStr<span class="token punctuation">.</span>toLong
        <span class="token punctuation">}</span>

        <span class="token comment">//-3.存入本次最终的结果</span>
        HBaseUtil<span class="token punctuation">.</span>putData<span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> rowkey<span class="token punctuation">,</span> columnFamily<span class="token punctuation">,</span> queryColumn<span class="token punctuation">,</span> currentFinalResult<span class="token punctuation">.</span>toString<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="font_colorpurple234__PVUVfont_414"></a><font color="purple">2.3.4 实时频道PV/UV</font></h4> 
<p>PV(访问量) 即Page View，页面刷新一次算一次。<br> UV(独立访客) 即Unique Visitor，指定时间内相同的客户端只被计算一次</p> 
<p>统计分析后得到的数据如下所示：<br> <img src="https://images2.imgbox.com/e7/ad/xYc9biow_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-scala"><span class="token keyword">object</span> ChannelRealPvUvTask <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">case</span> <span class="token keyword">class</span> ChannelRealPvUv<span class="token punctuation">(</span>channelId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> monthDayHour<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> pv<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> uv<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> process<span class="token punctuation">(</span>clickLogWideDS<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>ClickLogWide<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_
    <span class="token comment">//注意:</span>
    <span class="token comment">// 每条宽表日志都有: yearMonth,yearMonthDay,yearMonthDayHour这3个字段,</span>
    <span class="token comment">// 根据需求我们需要把1条日志根据这3个字段,变成3条数据,方便后面统计分时段PV/UV</span>
    <span class="token comment">// 也就是说现在要将每1条数据变为3条数据!</span>
    <span class="token comment">//使用flatMap</span>
    <span class="token comment">//中国北京昌平张三</span>
    <span class="token comment">// --&gt;</span>
    <span class="token comment">//中国,张三</span>
    <span class="token comment">//中国北京,张三</span>
    <span class="token comment">//中国北京昌平,张三</span>

    <span class="token comment">//1.数据转换</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>ChannelRealPvUv<span class="token punctuation">]</span> <span class="token operator">=</span> clickLogWideDS<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>clickLogWide <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      List<span class="token punctuation">(</span>
        ChannelRealPvUv<span class="token punctuation">(</span>clickLogWide<span class="token punctuation">.</span>channelID<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>yearMonth<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>count<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>isMonthNew<span class="token punctuation">)</span><span class="token punctuation">,</span>
        ChannelRealPvUv<span class="token punctuation">(</span>clickLogWide<span class="token punctuation">.</span>channelID<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>yearMonthDay<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>count<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>isDayNew<span class="token punctuation">)</span><span class="token punctuation">,</span>
        ChannelRealPvUv<span class="token punctuation">(</span>clickLogWide<span class="token punctuation">.</span>channelID<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>yearMonthDayHour<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>count<span class="token punctuation">,</span> clickLogWide<span class="token punctuation">.</span>isHourNew<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//2.分组</span>
    <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token string">"channelId"</span><span class="token punctuation">,</span> <span class="token string">"monthDayHour"</span><span class="token punctuation">)</span>
    <span class="token comment">//3.窗口</span>
    <span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//4.聚合</span>
   <span class="token punctuation">.</span>reduce<span class="token punctuation">(</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      ChannelRealPvUv<span class="token punctuation">(</span>c2<span class="token punctuation">.</span>channelId<span class="token punctuation">,</span> c2<span class="token punctuation">.</span>monthDayHour<span class="token punctuation">,</span> c1<span class="token punctuation">.</span>pv <span class="token operator">+</span> c2<span class="token punctuation">.</span>pv<span class="token punctuation">,</span> c1<span class="token punctuation">.</span>uv <span class="token operator">+</span> c2<span class="token punctuation">.</span>uv<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//5.结果保存到HBase</span>
    <span class="token comment">//注意:如果课下测试的时候,HBase性能跟不上,可以直接print打印能看到结果即可,下面的sink能看懂就行!</span>
    <span class="token comment">//result.print()</span>
    result<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span><span class="token keyword">new</span> SinkFunction<span class="token punctuation">[</span>ChannelRealPvUv<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

      <span class="token keyword">override</span> <span class="token keyword">def</span> invoke<span class="token punctuation">(</span>value<span class="token operator">:</span> ChannelRealPvUv<span class="token punctuation">,</span> context<span class="token operator">:</span> SinkFunction<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//-1.查</span>
        <span class="token keyword">val</span> tableName <span class="token operator">=</span> <span class="token string">"channel_pvuv"</span>
        <span class="token keyword">val</span> columnFamily <span class="token operator">=</span> <span class="token string">"info"</span>
        <span class="token keyword">val</span> queryColumn1 <span class="token operator">=</span> <span class="token string">"pv"</span>
        <span class="token keyword">val</span> queryColumn2 <span class="token operator">=</span> <span class="token string">"uv"</span>
        <span class="token keyword">val</span> rowkey <span class="token operator">=</span> value<span class="token punctuation">.</span>channelId <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> value<span class="token punctuation">.</span>monthDayHour

        <span class="token keyword">val</span> map<span class="token operator">:</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> HBaseUtil<span class="token punctuation">.</span>getMapData<span class="token punctuation">(</span>tableName<span class="token punctuation">,</span>rowkey<span class="token punctuation">,</span>columnFamily<span class="token punctuation">,</span>List<span class="token punctuation">(</span>queryColumn1<span class="token punctuation">,</span>queryColumn2<span class="token punctuation">)</span><span class="token punctuation">)</span>

       <span class="token comment">/* val pvhistoryValueStr: String = map.getOrElse(queryColumn1,null)
        val uvhistoryValueStr: String = map.getOrElse(queryColumn2,null)

        //-2.合
        var currentFinalPv = 0L
        var currentFinalUv = 0L

        if(StringUtils.isBlank(pvhistoryValueStr)){
          //如果pvhistoryValueStr为空,直接将本次该频道该时段的pv 作为 该频道该时段的本次最终的结果
          currentFinalPv = value.pv
        }else{
          //如果pvhistoryValueStr不为空,将本次该频道该时段的pv + pvhistoryValueStr 作为 该频道该时段的本次最终的结果
          currentFinalPv = value.pv + pvhistoryValueStr.toLong
        }

        if(StringUtils.isBlank(uvhistoryValueStr)){
          //如果uvhistoryValueStr为空,直接将本次该频道该时段的uv 作为 该频道该时段的本次最终的结果
          currentFinalUv = value.uv
        }else{
          //如果uvhistoryValueStr不为空,将本次该频道该时段的uv + uvhistoryValueStr 作为 该频道该时段的本次最终的结果
          currentFinalUv = value.uv + uvhistoryValueStr.toLong
        }*/</span>

        <span class="token keyword">val</span> pvhistoryValueStr<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> map<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span>queryColumn1<span class="token punctuation">,</span><span class="token string">"0"</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> uvhistoryValueStr<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> map<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span>queryColumn2<span class="token punctuation">,</span><span class="token string">"0"</span><span class="token punctuation">)</span>

        <span class="token keyword">val</span> currentFinalPv <span class="token operator">=</span> value<span class="token punctuation">.</span>pv <span class="token operator">+</span> pvhistoryValueStr<span class="token punctuation">.</span>toLong
        <span class="token keyword">val</span> currentFinalUv <span class="token operator">=</span> value<span class="token punctuation">.</span>uv <span class="token operator">+</span> uvhistoryValueStr<span class="token punctuation">.</span>toLong

        <span class="token comment">//-3.存</span>
        HBaseUtil<span class="token punctuation">.</span>putMapData<span class="token punctuation">(</span>tableName<span class="token punctuation">,</span>rowkey<span class="token punctuation">,</span>columnFamily<span class="token punctuation">,</span>
          Map<span class="token punctuation">(</span>
            <span class="token punctuation">(</span>queryColumn1<span class="token punctuation">,</span>currentFinalPv<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>queryColumn2<span class="token punctuation">,</span>currentFinalUv<span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="font_colorpurple03__PyFlinkfont_512"></a><font color="purple">03 Py-Flink</font></h2> 
<p><img src="https://images2.imgbox.com/ea/7a/fpXWLP2o_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="font_colorpurple31__font_514"></a><font color="purple">3.1 环境准备</font></h3> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> apache-flink
</code></pre> 
<p>需要在网络环境好的条件下安装,估计用时2小时左右,因为需要下载很多其他的依赖</p> 
<h3><a id="font_colorpurple32__font_522"></a><font color="purple">3.2 官方文档</font></h3> 
<ul><li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream_tutorial.html" rel="nofollow">https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream_tutorial.html</a></li><li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table_api_tutorial.html" rel="nofollow">https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table_api_tutorial.html</a></li><li><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/api/python/" rel="nofollow">https://ci.apache.org/projects/flink/flink-docs-release-1.12/api/python/</a></li></ul> 
<h3><a id="font_colorpurple33__font_528"></a><font color="purple">3.3 示例代码</font></h3> 
<pre><code class="prism language-py"><span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization <span class="token keyword">import</span> SimpleStringEncoder
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo <span class="token keyword">import</span> Types
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream <span class="token keyword">import</span> StreamExecutionEnvironment
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>connectors <span class="token keyword">import</span> StreamingFileSink


<span class="token keyword">def</span> <span class="token function">tutorial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>get_execution_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>set_parallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    ds <span class="token operator">=</span> env<span class="token punctuation">.</span>from_collection<span class="token punctuation">(</span>
        collection<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"hadoop spark flink"</span><span class="token punctuation">,</span><span class="token string">"hadoop spark"</span><span class="token punctuation">,</span><span class="token string">"hadoop"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        type_info<span class="token operator">=</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    ds<span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    result <span class="token operator">=</span> ds<span class="token punctuation">.</span>flat_map<span class="token punctuation">(</span><span class="token keyword">lambda</span> line<span class="token punctuation">:</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result_type<span class="token operator">=</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> word<span class="token punctuation">:</span> <span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>output_type<span class="token operator">=</span>Types<span class="token punctuation">.</span>ROW<span class="token punctuation">(</span><span class="token punctuation">[</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span>key_by<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>key_type_info<span class="token operator">=</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\
        <span class="token punctuation">.</span><span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b<span class="token punctuation">:</span> a <span class="token operator">+</span> b<span class="token punctuation">)</span>

    result<span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    result<span class="token punctuation">.</span>add_sink<span class="token punctuation">(</span>StreamingFileSink
                <span class="token punctuation">.</span>for_row_format<span class="token punctuation">(</span><span class="token string">'data/output/result1'</span><span class="token punctuation">,</span> SimpleStringEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"tutorial_job"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    tutorial<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>dataset <span class="token keyword">import</span> ExecutionEnvironment
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table <span class="token keyword">import</span> TableConfig<span class="token punctuation">,</span> DataTypes<span class="token punctuation">,</span> BatchTableEnvironment
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>descriptors <span class="token keyword">import</span> Schema<span class="token punctuation">,</span> OldCsv<span class="token punctuation">,</span> FileSystem
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>expressions <span class="token keyword">import</span> lit

exec_env <span class="token operator">=</span> ExecutionEnvironment<span class="token punctuation">.</span>get_execution_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>
exec_env<span class="token punctuation">.</span>set_parallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
t_config <span class="token operator">=</span> TableConfig<span class="token punctuation">(</span><span class="token punctuation">)</span>
t_env <span class="token operator">=</span> BatchTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>exec_env<span class="token punctuation">,</span> t_config<span class="token punctuation">)</span>

t_env<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>FileSystem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">(</span><span class="token string">'data/input'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>with_format<span class="token punctuation">(</span>OldCsv<span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">'word'</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>with_schema<span class="token punctuation">(</span>Schema<span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">'word'</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>create_temporary_table<span class="token punctuation">(</span><span class="token string">'mySource'</span><span class="token punctuation">)</span>

t_env<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>FileSystem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">(</span><span class="token string">'/tmp/output'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>with_format<span class="token punctuation">(</span>OldCsv<span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span>field_delimiter<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">'word'</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>BIGINT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>with_schema<span class="token punctuation">(</span>Schema<span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">'word'</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>BIGINT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>create_temporary_table<span class="token punctuation">(</span><span class="token string">'mySink'</span><span class="token punctuation">)</span>

tab <span class="token operator">=</span> t_env<span class="token punctuation">.</span>from_path<span class="token punctuation">(</span><span class="token string">'mySource'</span><span class="token punctuation">)</span>
tab<span class="token punctuation">.</span>group_by<span class="token punctuation">(</span>tab<span class="token punctuation">.</span>word<span class="token punctuation">)</span> \
   <span class="token punctuation">.</span>select<span class="token punctuation">(</span>tab<span class="token punctuation">.</span>word<span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span> \
   <span class="token punctuation">.</span>execute_insert<span class="token punctuation">(</span><span class="token string">'mySink'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="font_colorpurple04__font_596"></a><font color="purple">04 文末</font></h2> 
<p>本文主要讲解了Flink的多语言开发的简单例子，谢谢大家的阅读，本文完！</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e23d725c190ded209f2ca1cfe1658912/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">捷宇高拍仪</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b2a558eafce9d9bb3bd9e0ad4e6e496f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">TensorFlow实践四步法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>