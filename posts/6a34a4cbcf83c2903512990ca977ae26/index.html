<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HCIP-7.4交换机STP生成树协议原理 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="HCIP-7.4交换机STP生成树协议原理" />
<meta property="og:description" content="HCIP-7.4交换机STP生成树协议原理 1、什么是交换机生成树？2、STP生成树2.1、标准生成树基本计算过程(802.1D)2.2、STP的基本概念2.3、 BPDU格式及字段说明2.4、 STP的选举原则2.4.1 配置案例说明2.4.2 华为设备的COST值 2.5、端口状态描述2.6、cost值修改2.6.1、非根桥设备接口下的cost值修改：2.6.2、根设备接口下的优先级修改：2.6.3、优先级发生改变可能的临时环路 2.7、BPDU（Configuration BPDU）桥接协议数据单元2.7.1、配置BPDU的作用2.7.2、TCN（拓扑改变通知） 1、什么是交换机生成树？ 在网络中交换机等交换设备会对广播数据帧进行泛洪操作。如果出现环路，网络就会产生大量不断无效，循环的广播流，发生了“广播风暴”。交换设备的负载迅速增加，导致正常的数据帧传输受到了抑制，便会导致信道的拥塞，其结果往往是延时或丢帧，甚至网络瘫痪。
生成树协议就是用来防止2层循环的，通过在网络上修剪出一棵无环的树形拓扑网来解决交换网络中的环路问题。
生成树协议的分类：
公有协议：STP、RSTP、MSTP。思科可用协议：PVST、PVST&#43;、RPVST、MST。STP约等于PVST、RSTP约等于RPVST 、MST=MST。 现在国内网络中主要使用的是MSTP，也是华为设备默认的生成树协议。在学习MSTP先要学习STP，STP是生成树协议的基础，包括大量基础的概念和理论。
2、STP生成树 STP（Spanning Tree Protocol，生成树协议）是根据IEEE 802.1D 标准建立的，用于在局域网中消除数据链路层物理环路的协议。运行该协议的设备通过彼此交互信息发现网络中的环路，并有选择的对某些端口进行阻塞，最终将环路网络结构修剪成无环路的树型网络结构，从而防止报文在环路网络中不断增生和无限循环，避免设备由于重复接收相同的报文所造成的报文处理能力下降的问题发生。
STP采用的协议报文是BPDU（Bridge Protocol Data Unit，桥协议数据单元），也称为配置消息，BPDU中包含了足够的信息来保证设备完成生成树的计算过程。STP即是通过在设备之间传递BPDU来确定网络的拓扑结构。
基本思想：就是要生成一个稳定的树形拓扑网。
2.1、标准生成树基本计算过程(802.1D) 树的根是一台称为根桥的交换机(Root Bridge,简称为根交换机)。
从根交换机开始，逐级形成一棵树，交换机为树的节点，链路为树枝。
根交换机定时发送配置报文，非根交换机接收配置报文并转发给下一级。
整个交换网络有且只有一个根交换机每个非根交换机有且只有一个根端口每个Lan（segment）有且只有一个指定端口其他接口称之为未指定端口（或者Alternative 端口）。
生成树基本计算过程－选举根交换机
信息和参数被封装在配置BPDU（Configuration Bridge Protocol Data Unit）中，在交换机之间（trunk模式）传递。
BPDU是指桥接协议数据单元，泛指交换机之间运行的协议交互信息时使用的数据单元。配置BPDU是BPDU的一种。根桥每间隔Hello Time（默认2秒）时间周期性发出BPDU。
生成树计算的第一步是选举根交换机，根交换机的选举基于交换机标识（Bridge ID）。
交换机标识由两部分组成：两字节长度的交换机优先级和六字节长度的MAC地址。
交换机优先级是可以配置的，取值范围是0～61440，默认值为32768。
网络中交换机标识最小的成为根交换机，首先比较优先级，如果优先级相同则比较MAC地址，值越小越优先。
Bridge ID BID=优先级&#43;MAC地址。
2.2、STP的基本概念 STP协议中定义根交换(Root Bridget)、根端口(Root Port)、指定端口(Designed Port)和路径开销(Path Cost)等概念，目的就在于通过构造一颗自然树的方法达到阻塞冗余环路的目的，同时实现链路备份和路径最优化。用于构造这棵树的算法称为生成树算法(Spanning Tree Algorithm)。
根桥（Root Bridge）：具有最小桥ID的交换机是根桥(Root Bridge,简称为根交换机)。请将环路中所有交换机当中最好的一台设置为根桥交换机，以保证能够提供最好的网络性能和可靠性。
桥ID（Bridge Identifier）：桥ID是桥的优先级和其MAC地址的综合数值，其中桥优先级是一个可以设定的参数。桥ID越低，则桥的优先级越高，这样可以增加其成为根桥的可能性。
指定桥（Designated Bridge）：在每个网段中，到根桥的路径开销最低的桥将成为指定桥，数据包将通过它转发到该网段。当所有的交换机具有相同的根路径开销时，具有最低的桥ID的交换机会被选为指定桥。
根路径开销（Root Path Cost）：一台交换机的根路径开销是根端口的路径开销与数据包经过的所有交换机的根路径开销之和。根桥的根路径开销是零。
桥优先级（Bridge Priority）：是一个用户可以设定的参数，数值范围从0到32768。设定的值越小，优先级越高。交换机的桥优先级越高，才越有可能成为根桥。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/6a34a4cbcf83c2903512990ca977ae26/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-30T13:09:05+08:00" />
<meta property="article:modified_time" content="2023-06-30T13:09:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HCIP-7.4交换机STP生成树协议原理</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>HCIP-7.4交换机STP生成树协议原理</h4> 
 <ul><li><a href="#1_1" rel="nofollow">1、什么是交换机生成树？</a></li><li><a href="#2STP_15" rel="nofollow">2、STP生成树</a></li><li><ul><li><a href="#218021D_22" rel="nofollow">2.1、标准生成树基本计算过程(802.1D)</a></li><li><a href="#22STP_43" rel="nofollow">2.2、STP的基本概念</a></li><li><a href="#23__BPDU_74" rel="nofollow">2.3、 BPDU格式及字段说明</a></li><li><a href="#24__STP_95" rel="nofollow">2.4、 STP的选举原则</a></li><li><ul><li><a href="#241__114" rel="nofollow">2.4.1 配置案例说明</a></li><li><a href="#242_COST_234" rel="nofollow">2.4.2 华为设备的COST值</a></li></ul> 
   </li><li><a href="#25_263" rel="nofollow">2.5、端口状态描述</a></li><li><a href="#26cost_310" rel="nofollow">2.6、cost值修改</a></li><li><ul><li><a href="#261cost_314" rel="nofollow">2.6.1、非根桥设备接口下的cost值修改：</a></li><li><a href="#262_330" rel="nofollow">2.6.2、根设备接口下的优先级修改：</a></li><li><a href="#263_335" rel="nofollow">2.6.3、优先级发生改变可能的临时环路</a></li></ul> 
   </li><li><a href="#27BPDUConfiguration_BPDU_340" rel="nofollow">2.7、BPDU（Configuration BPDU）桥接协议数据单元</a></li><li><ul><li><a href="#271BPDU_359" rel="nofollow">2.7.1、配置BPDU的作用</a></li><li><a href="#272TCN_397" rel="nofollow">2.7.2、TCN（拓扑改变通知）</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1_1"></a>1、什么是交换机生成树？</h2> 
<p>在网络中交换机等交换设备会对广播数据帧进行泛洪操作。如果出现<strong>环路</strong>，网络就会产生大量不断无效，循环的广播流，发生了“广播风暴”。交换设备的负载迅速增加，导致正常的数据帧传输受到了抑制，便会导致信道的拥塞，其结果往往是延时或丢帧，甚至网络瘫痪。<br> <img src="https://images2.imgbox.com/cb/a7/ps6OVWW3_o.png" alt="二层环路" width="300" height="200"></p> 
<p>生成树协议就是用来防止2层循环的，通过在网络上修剪出一棵无环的<strong>树形拓扑网</strong>来解决交换网络中的环路问题。</p> 
<p>生成树协议的分类：</p> 
<ul><li>公有协议：STP、RSTP、MSTP。</li><li>思科可用协议：PVST、PVST+、RPVST、MST。</li><li>STP约等于PVST、RSTP约等于RPVST 、MST=MST。</li></ul> 
<p>现在国内网络中主要使用的是MSTP，也是华为设备默认的生成树协议。在学习MSTP先要学习STP，STP是生成树协议的基础，包括大量基础的概念和理论。</p> 
<h2><a id="2STP_15"></a>2、STP生成树</h2> 
<p>STP（Spanning Tree Protocol，生成树协议）是根据IEEE 802.1D 标准建立的，用于在局域网中<code>消除</code>数据链路层物理<code>环路</code>的协议。运行该协议的设备通过彼此交互信息发现网络中的环路，并有选择的对某些端口进行阻塞，最终将环路网络结构修剪成无环路的树型网络结构，从而防止报文在环路网络中不断增生和无限循环，避免设备由于重复接收相同的报文所造成的报文处理能力下降的问题发生。</p> 
<p>STP采用的<code>协议报文</code>是BPDU（Bridge Protocol Data Unit，<code>桥协议数据单元</code>），也称为配置消息，BPDU中包含了足够的信息来保证设备完成生成树的计算过程。STP即是通过在设备之间传递BPDU来确定网络的拓扑结构。</p> 
<p>基本思想：就是要生成一个稳定的树形拓扑网。</p> 
<h3><a id="218021D_22"></a>2.1、标准生成树基本计算过程(802.1D)</h3> 
<p>树的根是一台称为根桥的交换机(Root Bridge,简称为根交换机)。<br> 从根交换机开始，逐级形成一棵树，交换机为树的节点，链路为树枝。<br> 根交换机定时发送配置报文，非根交换机接收配置报文并转发给下一级。</p> 
<p>整个交换网络有且<strong>只有一个根交换机</strong>每个非根交换机有且<strong>只有一个根端口</strong>每个Lan（segment）有且只有一个指定端口其他接口称之为未指定端口（或者Alternative 端口）。</p> 
<p>生成树基本计算过程－选举根交换机<br> 信息和参数被封装在配置BPDU（Configuration Bridge Protocol Data Unit）中，在交换机之间（<code>trunk模式</code>）传递。</p> 
<p>BPDU是指<code>桥接协议数据单元</code>，泛指交换机之间运行的协议交互信息时使用的数据单元。配置BPDU是BPDU的一种。根桥每间隔Hello Time（<strong>默认2秒</strong>）时间周期性发出BPDU。</p> 
<p>生成树计算的第一步是<strong>选举根交换机</strong>，根交换机的选举基于交换机标识（Bridge ID）。<br> 交换机标识由两部分组成：两字节长度的交换机优先级和六字节长度的MAC地址。</p> 
<p>交换机优先级是可以配置的，取值范围是0～61440，默认值为32768。</p> 
<p>网络中交换机标识最小的成为根交换机，首先比较优先级，如果优先级相同则比较MAC地址，值越小越优先。</p> 
<p>Bridge ID BID=优先级+MAC地址。</p> 
<h3><a id="22STP_43"></a>2.2、STP的基本概念</h3> 
<p>STP协议中定义根交换(Root Bridget)、根端口(Root Port)、指定端口(Designed Port)和路径开销(Path Cost)等概念，目的就在于通过构造一颗自然树的方法达到阻塞冗余环路的目的，同时实现链路备份和路径最优化。用于构造这棵树的算法称为生成树算法(Spanning Tree Algorithm)。</p> 
<p>根桥（Root Bridge）：具有<strong>最小桥ID</strong>的交换机是<code>根桥</code>(Root Bridge,简称为根交换机)。请将环路中所有交换机当中最好的一台设置为根桥交换机，以保证能够提供最好的网络性能和可靠性。</p> 
<p>桥ID（Bridge Identifier）：桥ID是桥的优先级和其MAC地址的综合数值，其中桥优先级是一个可以设定的参数。<strong>桥ID越低，则桥的优先级越高</strong>，这样可以增加其成为根桥的可能性。</p> 
<p>指定桥（Designated Bridge）：在每个网段中，到根桥的路径开销最低的桥将成为指定桥，数据包将通过它转发到该网段。当所有的交换机具有相同的根路径开销时，具有最低的桥ID的交换机会被选为指定桥。</p> 
<p>根路径开销（Root Path Cost）：一台交换机的根路径开销是根端口的路径开销与数据包经过的所有交换机的根路径开销之和。根桥的根路径开销是零。</p> 
<p>桥优先级（Bridge Priority）：是一个用户可以设定的参数，数值范围从0到32768。设定的<strong>值越小，优先级越高</strong>。交换机的桥优先级越高，才越有可能成为根桥。</p> 
<p>根端口（Root Port）：非根桥的交换机上<strong>离根桥最近的端口</strong>，负责与根桥进行通信，这个端口到根桥的路径开销最低。当多个端口具有相同的到根桥的路径开销时，具有最高端口优先级的端口会成为根端口。</p> 
<p>指定端口（Designated Port）：指定桥上向本交换机转发数据的端口，转发数据和BPDU。根交换机所有端口都是指定端口。</p> 
<p>非指定端口：是指开销比指定端口高的端口。非指定端口将被设置为阻塞状态，不能进行转发。</p> 
<p>端口优先级（Port Priority）：数值范围从0到255，值越小，端口的优先级就越高。端口的优先级越高，才越有可能成为根端口。 默认的端口优先级为128。</p> 
<p>路径开销（Path Cost）：STP协议用于选择链路的参考值。STP协议通过计算路径开销，选择较为“强壮”的链路，阻塞多余的链路，将网络修剪成无环路的树型网络结构。</p> 
<p>查看STP信息</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>sw3<span class="token punctuation">&gt;</span></span>display stp brief
 MSTID  <span class="token class-name">Port</span>                        <span class="token class-name">Role</span>  STP <span class="token class-name">State</span>     <span class="token class-name">Protection</span>
   <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>       DESI  FORWARDING      NONE
   <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">2</span>       DESI  FORWARDING      NONE 
</code></pre> 
<p>DESI指定端口（Designated Port）</p> 
<h3><a id="23__BPDU_74"></a>2.3、 BPDU格式及字段说明</h3> 
<p>标准生成树的BPDU帧格式及字段说明：<br> <img src="https://images2.imgbox.com/ef/e3/ENFvlTkN_o.png" alt="BPDU帧格式"></p> 
<p>Protocol identifier： 协议标识，总是为0x0000，2字节。<br> Version： 协议版本，STP为0x00，RSTP为0x02，MSTP为0x03，1字节。<br> Message type： BPDU类型 ，1字节。</p> 
<ul><li>0x00：STP的Configuration BPDU</li><li>0x80：STP的TCN BPDU（Topology Change Notification BPDU）</li><li>0x02：RST BPDU（Rapid Spanning-Tree BPDU）或者MST<br> Flag： 标志位，只使用了最低位和最高位，最低为TC标志，最高为TCA标志。1字节。<br> Root ID： 根桥ID，由两字节的优先级和6字节MAC地址构成，8字节。<br> Root path cost： 根路径开销，本端口累计到根桥的开销。4字节。<br> Bridge ID： 桥ID，表示发送BPDU的桥的ID，由2字节优先级和6字节MAC地址构成，8字节。<br> Port ID： 端口ID，标识发出BPDU的端口。2字节。<br> Message age： BPDU生存时间，2字节。<br> Maximum age： 当前BPDU的老化时间，即端口保存BPDU的最长时间，缺省值20s。2字节。<br> Hello time： 根桥发送BPDU的周期，缺省值2s。2字节<br> Forward delay： 表示在拓扑改变后，交换机在发送数据包前维持在监听和学习状态的时间，缺省值15s。2字节。</li></ul> 
<p><img src="https://images2.imgbox.com/09/6f/2fwcwdq0_o.png" alt="BPDU帧格式抓包图"></p> 
<h3><a id="24__STP_95"></a>2.4、 STP的选举原则</h3> 
<p>要点：比根桥ID，桥ID由2字节优先级和6字节MAC地址组成。<br> 1、<strong>选举根桥</strong><br> a. 先比根桥ID中的<code>优先级</code>，具有最小优先级的,此交换机定为根桥。<br> b. 假设优先级一样，再比根桥ID中的<code>MAC地址</code>。MAC地址最小的确定为根桥。</p> 
<p>2、<strong>选举根端口</strong>:按如下顺序选举，满足条件即停止。<br> A、计算非根交换机到达根桥的<code>链路开销</code>；<br> B、比较非根交换机的上行<code>交换机桥ID</code>（由优先级与MAC地址决定）；<br> C、比较端口上所连接的上行端口的端口标识（Port Id），越小越优先。</p> 
<p>3、选举指定端口：非根交换机与非根交换机之间连接线的两个端口中必定有一个端口为指定端口，此时比较两个非根交换机的根端口到达根桥的最低链路开销，将最低开销的非根交换机为准，其所在的连接线（为上面非根交换机与非根交换机之间连接线）的端口为指定端口，如果链路开销一样最后比较各自的桥ID即可。指定端口被标记为转发端口。可通过比较发送的BPDU；</p> 
<p>4、 选择根端口和指定端口的BPDU帧总是从根桥向外发；</p> 
<p>关闭与根桥要连的交换机两个端口中一个为了阻止交换环路的出现。先比带宽，如一样关闭端口号较高的那一条链路，设置为阻塞模式。</p> 
<p><img src="https://images2.imgbox.com/09/06/iUzmKkev_o.png" alt="STP的选举原则" width="400" height="200"></p> 
<h4><a id="241__114"></a>2.4.1 配置案例说明</h4> 
<p><strong>1、选举根桥</strong><br> 配置根桥优先级将sw3变为根桥。<br> 以4096的倍数来增长，0代表最大可能为根。</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>sw3<span class="token punctuation">]</span>stp mode stp             <span class="token comment">//生成树类型为stp</span>
<span class="token punctuation">[</span>sw3<span class="token punctuation">]</span>stp priority <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">61440</span><span class="token operator">&gt;</span>   <span class="token comment">//配置sw3的优先级，越小越优先。默认32768</span>
<span class="token punctuation">[</span>sw3<span class="token punctuation">]</span>stp root primary         <span class="token comment">//另一种配置直接把优先级设置为0 </span>
</code></pre> 
<p>使用stp root primary命令后查看接口配置<br> [sw3]dis curr int g0/0/1<br> stp intance 0 root primary 优先级配置</p> 
<p>为便于理解以皇帝，监军，将军来说明。皇帝接收监军，将军的奏折，监军代表皇帝监视将军行为。</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>sw1<span class="token punctuation">&gt;</span></span>dis stp
CIST <span class="token class-name">Root</span><span class="token operator">/</span>ERPC      <span class="token operator">:</span><span class="token number">32768.4</span>c1f<span class="token operator">-</span>cc09<span class="token operator">-</span><span class="token number">46</span>b3 <span class="token operator">/</span> <span class="token number">0</span>   <span class="token number">0</span>代表自己，自己是皇帝。
CIST <span class="token class-name">RegRoot</span><span class="token operator">/</span>IRPC   <span class="token operator">:</span><span class="token number">32768.4</span>c1f<span class="token operator">-</span>cc09<span class="token operator">-</span><span class="token number">46</span>b3 <span class="token operator">/</span> <span class="token number">0</span> （<span class="token keyword">this</span> bridge is the root）
</code></pre> 
<p>查看STP简要</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>sw1<span class="token punctuation">&gt;</span></span>dis stp bri    
 MSTID  <span class="token class-name">Port</span>                        <span class="token class-name">Role</span>  STP <span class="token class-name">State</span>     <span class="token class-name">Protection</span>
   <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>       DESI  FORWARDING      NONE   谕旨指定端口
   <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">2</span>       DESI  FORWARDING      NONE   谕旨指定端
</code></pre> 
<p>发送皇帝上的谕旨(BPDU帧)的部门的都是指定端口。指定端口为上对下。</p> 
<pre><code class="prism language-java"> <span class="token generics"><span class="token punctuation">&lt;</span>sw1<span class="token punctuation">&gt;</span></span>dis stp
CIST <span class="token class-name">Root</span><span class="token operator">/</span>ERPC      <span class="token operator">:</span><span class="token number">32768.4</span>c1f<span class="token operator">-</span>cc09<span class="token operator">-</span><span class="token number">46</span>b3 <span class="token operator">/</span> <span class="token number">10000</span>   根的MAC是<span class="token number">46</span>b3
CIST <span class="token class-name">RegRoot</span><span class="token operator">/</span>IRPC   <span class="token operator">:</span><span class="token number">32768.4</span>c1f<span class="token operator">-</span>cca5<span class="token operator">-</span><span class="token number">1</span>eb3 <span class="token operator">/</span> <span class="token number">0</span>   <span class="token number">0</span>代表自己，自己的
CIST <span class="token class-name">RootPortId</span>     <span class="token operator">:</span><span class="token number">128.1</span>      根端口ID
</code></pre> 
<p>sw1为非根桥，这时可以看根的MAC是46b3。</p> 
<p>查看根桥的生成树状态信息</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>HUAWEI<span class="token punctuation">&gt;</span></span> display stp bridge root
MSTID              <span class="token class-name">Root</span> ID  <span class="token class-name">Root</span> <span class="token class-name">Cost</span> <span class="token class-name">Hello</span> <span class="token class-name">Max</span> <span class="token class-name">Forward</span> <span class="token class-name">Root</span> <span class="token class-name">Port</span>               
                                       <span class="token class-name">Time</span> <span class="token class-name">Age</span>   <span class="token class-name">Delay</span>                         
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>       
    <span class="token number">0</span> <span class="token number">32768.4</span>c1f<span class="token operator">-</span>cc09<span class="token operator">-</span><span class="token number">46</span>b3          <span class="token number">0</span>     <span class="token number">2</span>  <span class="token number">20</span>      <span class="token number">15</span> 
</code></pre> 
<p>关闭STP<br> 关闭全局STP：</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>HUAWEI<span class="token punctuation">&gt;</span></span> system<span class="token operator">-</span>view
<span class="token punctuation">[</span>HUAWEI<span class="token punctuation">]</span> undo stp enable
</code></pre> 
<p>关闭接口STP</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>HUAWEI<span class="token punctuation">&gt;</span></span> system<span class="token operator">-</span>view
<span class="token punctuation">[</span>HUAWEI<span class="token punctuation">]</span> <span class="token keyword">interface</span> gigabitethernet <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">[</span>HUAWEI<span class="token operator">-</span><span class="token class-name">GigabitEthernet1</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span> undo stp enable
</code></pre> 
<p><strong>2、选举根端口RP的程序</strong><br> 发送监军，将军的奏折(BPDU)的部门为根端口，目的地是皇帝的指定端口。</p> 
<p>根端口是指从一个非根交换机到根交换机总开销最小的路径所经过的本地端口。这个最小的总开销值称为交换机的根路径开销RPC（Root Path Cost）。如果这样的端口有多个，则比较端口上所连接的上行交换机的交换机标识BRIDGR ID(交换机桥ID)，越小越优先，如果端口上所连接的上行交换机的交换机标识相同，则比较端口上所连接的上行端口的端口标识（Port Id），越小越优先。端口标识由两部分组成：一字节长度的端口优先级和一字节长度的端口号。一字节长度的端口优先级是可配置的，默认为128。<br> <img src="https://images2.imgbox.com/21/ae/ADs4pWLC_o.png" alt="在这里插入图片描述" width="300" height="200"></p> 
<p>监军上报奏折有两条线，一是直接上报，二是通过将军再上报。前种方式开销是1，第二种方式开销是2，所以选择直接上报。那么监军的上报部门为根端口。<br> <img src="https://images2.imgbox.com/d1/00/yAotiYov_o.png" alt="在这里插入图片描述" width="300" height="200"></p> 
<p>监军的上报部门有3个，多条线路总开销值一样，就比较Bridge ID（优先级+MAC地址），越小越好。三条路都一样，比较PORT ID端口ID，越小越好。最后确定只有一个上报部门来完成这件事。<br> <img src="https://images2.imgbox.com/4a/e6/HkkKc1gg_o.png" alt="根端口选择"></p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>sw1<span class="token punctuation">&gt;</span></span>dis stp bri
   <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">4</span>    DESI  FORWARDING      NONE 谕旨的中继端口
   <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3</span>    ROOT  FORWARDING      NONE 根端口，往皇帝传的出口
</code></pre> 
<p>ROOT根端口,DES指定端口。<br> PORT ID的组成：<br> 由端口优先级.该端口的系列号组成 128是默认端口优先级128.3 3是端口系列号。</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>sw1<span class="token punctuation">&gt;</span></span>dis stp
<span class="token class-name">Last</span> TC occurred    <span class="token operator">:</span><span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">3</span>
 <span class="token class-name">Port</span> <span class="token class-name">Protocol</span>       <span class="token operator">:</span><span class="token class-name">Enabled</span>
 <span class="token class-name">Port</span> <span class="token class-name">Role</span>           <span class="token operator">:</span><span class="token class-name">Disabled</span> <span class="token class-name">Port</span>
 <span class="token class-name">Port</span> <span class="token class-name">Priority</span>       <span class="token operator">:</span><span class="token number">128</span>
 <span class="token class-name">Port</span> <span class="token class-name">Cost</span><span class="token punctuation">(</span><span class="token class-name">Dot1T</span> <span class="token punctuation">)</span>   <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span>auto <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span><span class="token number">200000000</span>
 <span class="token class-name">Designated</span> <span class="token class-name">Bridge</span><span class="token operator">/</span><span class="token class-name">Port</span>   <span class="token operator">:</span><span class="token number">32768.4</span>c1f<span class="token operator">-</span>cc09<span class="token operator">-</span><span class="token number">46</span>b3 <span class="token operator">/</span> <span class="token number">128.3</span>
</code></pre> 
<p><strong>3、选举指定端口DP的规则</strong><br> 皇帝发布谕旨(BPDU)，需要从上往下传送到指定接收人，一种是直接是传送给接收人，一种是通过中间人再传送给接收人(转发数据BPDU)。传送谕旨(BPDU)部门就是指定端口。</p> 
<p>选举原则：<br> A、比较总开销值。 最小的成为指定端口。 消耗越少越好。<br> B、如果多条线路总开销值一样，比较Bridge ID（优先级+MAC地址），越小越好。<br> C、A和B都一样，比较PORT ID端口ID，越小越好。</p> 
<p>根桥（皇帝）所有端口都指定端口。</p> 
<p>根据A、B、C三原则比较选举指定端口，SW1的g0/0/21与SW3 g0/0/1比较<br> <img src="https://images2.imgbox.com/e0/c6/7ugHTz65_o.png" alt="选举指定端口" width="300" height="200"></p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>sw2<span class="token punctuation">&gt;</span></span>dis stp bri
 MSTID  <span class="token class-name">Port</span>                        <span class="token class-name">Role</span>  STP <span class="token class-name">State</span>     <span class="token class-name">Protection</span>
   <span class="token number">0</span>    <span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">6</span>               ALTE  DISCARDING      NONE 阻塞端口
   <span class="token number">0</span>    <span class="token class-name">Ethernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">5</span>               ROOT  FORWARDING      NONE 根端口，往皇帝传的出口 
</code></pre> 
<p>查看皇帝的BPDU传输，政令通畅。</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>sw3<span class="token punctuation">&gt;</span></span>dis stp <span class="token keyword">int</span> g0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>
<span class="token class-name">Config</span> <span class="token class-name">Times</span>        <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">MaxHop</span> <span class="token number">20</span>
<span class="token class-name">Active</span> <span class="token class-name">Times</span>        <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">MaxHop</span> <span class="token number">20</span>
BPDU <span class="token class-name">Sent</span>           <span class="token operator">:</span><span class="token number">3165</span>         发送       
          TCN<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token operator">:</span> <span class="token number">3165</span><span class="token punctuation">,</span> RST<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> MST<span class="token operator">:</span> <span class="token number">0</span>
 BPDU <span class="token class-name">Received</span>       <span class="token operator">:</span><span class="token number">3</span>           接收   
          TCN<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> RST<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> MST<span class="token operator">:</span> <span class="token number">0</span>
</code></pre> 
<p>通过比较选举指定端口，监军的端口4可以传送皇帝的谕旨，而将军不能传送，皇帝可以直接下达谕旨给将军进行管理，也可通过监军来直接下达谕旨给将军。皇帝不能通过将军传达谕旨给监军。从而避免环路。</p> 
<h4><a id="242_COST_234"></a>2.4.2 华为设备的COST值</h4> 
<p>STP为每个非根交换机选举根端口（Root Port）。交换机的每个端口都有一个端口开销（Port Cost）的参数，此参数表示数据从该端口发送时的开销值，也即出端口的开销。STP认为从一个端口接收数据是没有开销的。端口的开销和端口的带宽有关，带宽越高，开销越小，VRP平台中，百兆端口的开销值为200(华为私有)。从一个非根交换机到达根交换机的路径可能有多条，每一条路径都有一个总的开销值，此开销值是该路径上所有出端口的端口开销总和。</p> 
<p>802.1t。<br> stp pathcost-standard { dot1d-1998 | dot1t | legacy }命令用来配置指定交换机上路径开销值的标准。<br> 每个端口的路径开销也可以手动指定。此STP路径开销控制方法须谨慎使用，手动指定端口的路径开销可能会生成次优生成树拓扑。</p> 
<p>stp cost cost命令取决于路径开销计算方法：</p> 
<ul><li>使用华为的私有计算方法时，cost取值范围是1～200000。</li><li>使用IEEE 802.1d标准方法时，cost取值范围是1～65535。</li><li>使用IEEE 802.1t标准方法时，cost取值范围是1～200000000。默认</li></ul> 
<p>STP路径开销 cost（华为默认采用802.1t）入端口实际的开销之和。<br> <img src="https://images2.imgbox.com/08/73/9uum14Fs_o.png" alt="cost计算方法" width="400" height="240"></p> 
<p>百兆=200000、千兆=20000<br> 更改不同标准的cost值：</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>SW1<span class="token punctuation">]</span>stp pathcost<span class="token operator">-</span>standard <span class="token operator">?</span>
  dot1d<span class="token operator">-</span><span class="token number">1998</span>  IEEE <span class="token number">802.1D</span><span class="token operator">-</span><span class="token number">1998</span>
  dot1t       IEEE <span class="token number">802.1</span>T
  legacy      <span class="token class-name">Legacy</span>华为自定义
</code></pre> 
<p>[sw2]dis stp int g0/0/2<br> Port Protocol :Enabled<br> Port Role :Designated Port<br> Port Priority :128<br> Port Cost(Dot1T ) :Config=auto / Active=20000<br> 千兆Active=20000</p> 
<h3><a id="25_263"></a>2.5、端口状态描述</h3> 
<table><thead><tr><th align="left">端口状态</th><th align="left">描 述</th></tr></thead><tbody><tr><td align="left">Disable未启用</td><td align="left">此状态下端口不转发数据帧，不学习MAC地址表，不参与生成树计算。</td></tr><tr><td align="left">Blocking阻塞状态</td><td align="left">此状态下端口不转发数据帧，不学习MAC地址表，此状态下端口接收并处理BPDU，但是不向外发送BPDU。接收并处理BPDU是证明自己活着。</td></tr><tr><td align="left">Listening侦听状态</td><td align="left">此状态下端口不转发数据帧，不学习MAC地址表，只参与生成树计算，接收并发送BPDU。</td></tr><tr><td align="left">Learning学习状态</td><td align="left">此状态下端口不转发数据帧，但是学习MAC地址表，参与计算生成树，接收并发送BPDU。</td></tr><tr><td align="left">Forwarding转发状态</td><td align="left">此状态下端口正常转发数据帧，学习MAC地址表，参与计算生成树，接收并发送BPDU</td></tr></tbody></table> 
<p>关于时间：<br> Hello(根桥发送BPDU的周期) 2s<br> MaxAge(老化时间) 20s<br> FwDly(表示在拓扑改变后，交换机在发送数据包前维持在监听和学习状态的时间) 15s<br> MaxHop(合同延续期) 20 Blocking—&gt;Listening 20s<br> Blocking–&gt;20s Listening–&gt;15s Learnin–&gt;15s Forwarding</p> 
<p>查看stp接口信息</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>sw3<span class="token punctuation">&gt;</span></span>dis stp <span class="token keyword">int</span> g0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">2</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">[</span>CIST <span class="token class-name">Global</span>全局 <span class="token class-name">Info</span>信息<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">Mode</span> STP<span class="token punctuation">]</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
CIST <span class="token class-name">Bridge</span>         <span class="token operator">:</span><span class="token number">32768.4</span>c1f<span class="token operator">-</span>ccd6<span class="token operator">-</span><span class="token number">5878</span> 
<span class="token class-name">Config</span> <span class="token class-name">Times</span>        <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">MaxHop</span> <span class="token number">20</span>
<span class="token class-name">Active</span> <span class="token class-name">Times</span>        <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">MaxHop</span> <span class="token number">20</span>
CIST <span class="token class-name">Root</span><span class="token operator">/</span>ERPC      <span class="token operator">:</span><span class="token number">4096</span> <span class="token number">.4</span>c1f<span class="token operator">-</span>cc45<span class="token operator">-</span><span class="token number">0</span>ee4 <span class="token operator">/</span> <span class="token number">20000</span> 根桥的优先级
CIST <span class="token class-name">RegRoot</span><span class="token operator">/</span>IRPC   <span class="token operator">:</span><span class="token number">32768.4</span>c1f<span class="token operator">-</span>ccd6<span class="token operator">-</span><span class="token number">5878</span> <span class="token operator">/</span> <span class="token number">0</span>   自已MAC和优先级
CIST <span class="token class-name">RootPortId</span>     <span class="token operator">:</span><span class="token number">128.12</span>     根的<span class="token class-name">PortId</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">[</span><span class="token class-name">Port23</span><span class="token punctuation">(</span><span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span>DOWN<span class="token punctuation">]</span><span class="token operator">--</span><span class="token operator">--</span>端口g0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>信息
 <span class="token class-name">Port</span> <span class="token class-name">Protocol</span>       <span class="token operator">:</span><span class="token class-name">Enabled</span>
 <span class="token class-name">Port</span> <span class="token class-name">Role</span>           <span class="token operator">:</span> <span class="token class-name">Alternate</span> <span class="token class-name">Port</span>   AP
 <span class="token class-name">Port</span> <span class="token class-name">Priority</span>       <span class="token operator">:</span><span class="token number">128</span>             端口优先级
 <span class="token class-name">Port</span> <span class="token class-name">Cost</span><span class="token punctuation">(</span><span class="token class-name">Dot1T</span> <span class="token punctuation">)</span>   <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span>auto <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span><span class="token number">20000</span>  cost20000
 <span class="token class-name">Designated</span> <span class="token class-name">Bridge</span><span class="token operator">/</span><span class="token class-name">Port</span>   <span class="token operator">:</span><span class="token number">8192.4</span>c1f<span class="token operator">-</span>cc2d<span class="token operator">-</span><span class="token number">32</span>b8 <span class="token operator">/</span> <span class="token number">128.2</span> 指定端port id <span class="token number">128.2</span>
 <span class="token class-name">Port</span> <span class="token class-name">Edged</span>          <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span><span class="token keyword">default</span> <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span>disabled
 <span class="token class-name">Point</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span>point      <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span>auto <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span><span class="token boolean">false</span>
 <span class="token class-name">Transit</span> <span class="token class-name">Limit</span>       <span class="token operator">:</span><span class="token number">147</span> packets<span class="token operator">/</span>hello<span class="token operator">-</span>time
 <span class="token class-name">Protection</span> <span class="token class-name">Type</span>     <span class="token operator">:</span><span class="token class-name">None</span>
 <span class="token class-name">Port</span> STP <span class="token class-name">Mode</span>       <span class="token operator">:</span>stp         模式标准STP
 <span class="token class-name">Port</span> <span class="token class-name">Protocol</span> <span class="token class-name">Type</span>  <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span>auto <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span>dot1s  端口协议dot1s
 BPDU <span class="token class-name">Encapsulation</span>  <span class="token operator">:</span><span class="token class-name">Config</span><span class="token operator">=</span>stp <span class="token operator">/</span> <span class="token class-name">Active</span><span class="token operator">=</span>stp
 <span class="token class-name">PortTimes</span>           <span class="token operator">:</span><span class="token class-name">Hello</span> <span class="token number">2</span>s <span class="token class-name">MaxAge</span> <span class="token number">20</span>s <span class="token class-name">FwDly</span> <span class="token number">15</span>s <span class="token class-name">RemHop</span> <span class="token number">20</span>
TC or TCN send      <span class="token operator">:</span><span class="token number">0</span>          发送的BPDU为<span class="token number">0</span>
 TC or TCN received  <span class="token operator">:</span><span class="token number">34</span>
 BPDU <span class="token class-name">Sent</span>           <span class="token operator">:</span><span class="token number">2</span>             
          TCN<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> RST<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> MST<span class="token operator">:</span> <span class="token number">0</span>
 BPDU <span class="token class-name">Received</span>       <span class="token operator">:</span><span class="token number">925</span>        接收的BPDU925    只接收不发送  
          TCN<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token operator">:</span> <span class="token number">925</span><span class="token punctuation">,</span> RST<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> MST<span class="token operator">:</span> <span class="token number">0</span>
</code></pre> 
<h3><a id="26cost_310"></a>2.6、cost值修改</h3> 
<p><img src="https://images2.imgbox.com/5f/13/nlQrCM6s_o.png" alt="cost值修改" width="400" height="240"><br> 在有两台设备之间有多条链路冗余时，只能有一条是可用，其它的阻塞，但通过修改以下条件，可以选择哪条线路来作为可用链路。</p> 
<h4><a id="261cost_314"></a>2.6.1、非根桥设备接口下的cost值修改：</h4> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>sw2<span class="token punctuation">]</span><span class="token keyword">int</span> g0<span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">11</span>
<span class="token punctuation">[</span>sw2<span class="token operator">-</span><span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">11</span><span class="token punctuation">]</span>stp cost <span class="token number">10000</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>SW2<span class="token operator">-</span><span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">22</span><span class="token punctuation">]</span>dis stp bri
  <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">11</span>       ALTE  DISCARDING      NONE  原来DP现在变成AP
  <span class="token number">0</span>    <span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">22</span>       ROOT  DISCARDING      NONE  cost变小走这边
</code></pre> 
<p>BPDU从发送hello从指定端口发出，SW1SW2,从根桥出来的cost是0，到达SW2的g0/0/22的cost是20000（CIST Root/ERPC :4096 .4c1f-cc45-0ee4 / 20000）</p> 
<p>现在有两条线路SW1的g0/0/1–&gt;SW2 cost 20000<br> SW1的g0/0/22–&gt;SW2 修改后变成10000，越小越好，走这条线路<br> 防止环路产生，根桥出来的端口必须是DP，所以只能是SW2 0/0/11阻塞。</p> 
<h4><a id="262_330"></a>2.6.2、根设备接口下的优先级修改：</h4> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>sw1<span class="token operator">-</span><span class="token class-name">GigabitEthernet0</span><span class="token operator">/</span><span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">]</span>stp port priority <span class="token operator">?</span>
  INTEGER<span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">240</span><span class="token operator">&gt;</span>  <span class="token class-name">Port</span> priority<span class="token punctuation">,</span> in steps of <span class="token number">16</span>  以<span class="token number">16</span>的倍数设置。
</code></pre> 
<h4><a id="263_335"></a>2.6.3、优先级发生改变可能的临时环路</h4> 
<p><img src="https://images2.imgbox.com/e3/30/Y05qyDbs_o.png" alt="在这里插入图片描述" width="400" height="240"><br> 由于优先级发生改变或者其它原因，原SWA不再是根桥，SWC变成根桥。原来的SWD的E0/2由AP阻塞状态变成通信状态，变成DP，这时问题出在SWB上E0/2，由于时间关系，并没有立即从原DP转换为AP阻塞状态，还在转发数据，这时就形成环路。</p> 
<p>解决办法，延迟SWD的E0/2由阻塞状态变成通信状态得时间，先等SWD上的E0/2先阻塞后，再打开。</p> 
<h3><a id="27BPDUConfiguration_BPDU_340"></a>2.7、BPDU（Configuration BPDU）桥接协议数据单元</h3> 
<p>STP每隔2s会发送一次BPDU报文，非根桥连续三次没有收到BPDU，表示发生故障。</p> 
<p>BPDU分为两种，一种的配置BPDU；另一种是TCN（拓扑改变通知）。</p> 
<ul><li>配置 BPDU，类型字段：STP----0X00 RSTP----0X02-RST BPDU MSTP----0X02-MST BPDU； 
  <ul><li>配置 BPDU：周期发送，标记域的 TCA=0 TC=0；</li></ul> </li><li>TCN： BPDU 链路发生故障后发送，类型字段固定为0X80。</li></ul> 
<p><img src="https://images2.imgbox.com/a3/ff/kv8b5XDr_o.png" alt="BPDU报文格式" width="500" height="240">Root Identifier(根的ID)，Root Path Cost(根路径开销)，Bridge Identifier(桥ID)和Port Identifier(端口ID)四部分用于检测最优的配置BPDU，进行生成树计算。</p> 
<p><strong>Message age</strong> ：BPDU存活时间，根桥发送是为0，每经过一台交换机会增加，就是MaxHop 20；最大20跳。</p> 
<p><strong>Max age</strong>：BPDU老化时间，默认是20s，最大40s。每经过一台交换机Message age+1，当Message age=Max age，则认为该BPDU失效。则此配置BPDU被认为已经过期。</p> 
<p>合同延续期：MaxAge 20s Blocking–&gt;20s Listening 超过20秒就down。</p> 
<p><strong>Hello Time</strong>默认为2秒，也即在指定端口上，配置BPDU每隔两秒发送一次。</p> 
<p><strong>Forward Delay</strong>默认为15秒。</p> 
<h4><a id="271BPDU_359"></a>2.7.1、配置BPDU的作用</h4> 
<p>选举根桥、端口角色<br> 配置BPDU的目的MAC为组播：0180-c200-0000。<br> 当配置BPDU只用于计算生成树，不用于传递拓 扑改变信息的时候：<br> Protocol Identifier（协议标识），Protocol Version Identifier（协议版本标识）和BPDU Type（BPDU类型）Flags（标志）四部分设置为全0。<br> <img src="https://images2.imgbox.com/fb/66/w8yByEEr_o.png" alt="在这里插入图片描述">转发BPDU时会修改其SMAC为自身设备MAC，但DMAC不变（01:80:c2:00:00:00）</p> 
<p>STP模式下的交换网络，只有根桥发送BPDU，非根桥设备负责转发BPDU。<br> STP的配置BPDU发送方式：<br> 1、没有选举根桥前，所有设备都会发送配置BPDU，选举根桥后只有根桥会发送配置BPDU；<br> 2、其它非根桥设备在收到根桥发送过来的配置BPDU后，才会触发发出配置BPDU，不会主动发；<br> 3、非根网桥指定端口只有在接收到次优配置BPDU时，才会主动发送最优BPDU。</p> 
<p>STP初次收敛，BPDU的作用。<br> <img src="https://images2.imgbox.com/fc/40/fPTCIneO_o.png" alt="STP初次收敛" width="400" height="240"></p> 
<p><strong>1、初始状态</strong></p> 
<p>由于每个桥都认为自己是根桥，所以在每个端口所发出的BPDU中，根桥字段都是用各自的BID，Root Path Cost字段是累计的到根桥的开销，发送者BID是自己的BID，端口PID是发送该BPDU端口的端口ID。</p> 
<p>SWA收到SWB的配置消息，比较后发现自己的配置消息更优，于是将其丢弃。<br> SWA收到SWC的配置消息，比较后发现自己的配置消息更优，于是将其丢弃。<br> SWA的配置消息中的根桥和指定桥都是自己，于是认为自己就是根桥，各端口的配置消息都不作任何修改，此后便周期性地向外发送配置消息。</p> 
<p>SWB收到SWA的配置消息，发现其比自己的配置消息更优，于是更新自己的配置消息。<br> SWB收到SWC的配置消息，发现自己的配置消息更优，于是将其丢弃。</p> 
<p>SWB比较自己各端口的配置消息，发现3端口的配置消息最优，于是该端口被确定为根端口，其配置消息不变。4端口被确定为指定端口，其配置消息也被替换为计算出的配置消息，并周期性地向外发送。</p> 
<p>网络收敛后，根桥会按照一定的时间间隔产生并向外发送配置BPDU，其他设备收到该配置BPDU后，如果优先级比自己的配置BPDU高，则非根桥设备会根据收到的配置BPDU中携带的信息更新自己相应的端口存储的配置BPDU信息，否则会丢弃该配置BPDU。</p> 
<p><strong>2、根桥发生故障时，BPDU的作用。</strong><br> <img src="https://images2.imgbox.com/64/87/48qdCx38_o.png" alt="根桥发生故障" width="400" height="240"><br> 当根桥发生故障，SWA、C会因为RP端口断开而触发重新选举根桥，直接向外发送BPDU并标识自己为根桥。</p> 
<p>SWC原有一个阻塞端口，那么该端口需要经过20秒的老化时间转换成其它端口状态后再重新进行发送BPDU。</p> 
<p>经过两次转发延迟时间之后（30秒）如果没有收到比自己更优的BPDU，自己成为根桥。</p> 
<h4><a id="272TCN_397"></a>2.7.2、TCN（拓扑改变通知）</h4> 
<p>TCN一类简单非配置BPDU。TC和TCA是配置的置位flag的BPDU。</p> 
<p>网络发生故障类型：</p> 
<ul><li>根桥发生故障：</li><li>非根桥拓扑变化：增加或者减少非根桥</li></ul> 
<p>1、非根设备故障导致拓扑结构改变进而导致MAC地址表错误：<br> 默认情况下，MAC地址表中的动态表项生存期为300秒（5分钟）</p> 
<p>生成树拓扑发生改变，交换机的转发路径也会改变，当MAC地址表未及时老化将导致数据转发发生错误，因此需要及时更新MAC地址表项。</p> 
<p>解决问题的办法：当拓扑结构改变之后，通过一定的机制，使拓扑改变的信息在整网内泛洪，并修改MAC地址表的生存期为一个较短的数值，等拓扑结构稳定之后，再恢复MAC地址表的生存期。</p> 
<p>这里通过发送TCN BPDU报文来将MAC地址表项的<strong>老化时间缩短为15s</strong>，达到及时更新MAC地址表项的目的。<br> 非根桥拓扑变化：<br> <img src="https://images2.imgbox.com/8c/65/y3NBasAW_o.png" alt="非根桥拓扑变化" width="400" height="240"></p> 
<p>当SWB的3接口断开之后，4接口成为新的根端口，从SWC到达该PC 的目的地址应当修改为4，但是交换机不能检测到拓扑改变，导致MAC地址表错误，最长可导致5分钟的数据转发错误。</p> 
<p>在向整网拓扑改变信息的过程中，共涉及三种BPDU：<br> 1).<strong>拓扑改变通知BPDU</strong>：<code>TCN</code> (Topology Change Notification BPDU)。<code>非根桥</code>设备将以Hello间隔(2s)为准，定时向RP端口发送**STP组播(01:80:C2:00:00:00)**的TCN BPDU报文，直到收到上行交换机的 拓扑改变确认配置BPDU或者拓扑改变配置BPDU 。</p> 
<p>TCP BPDU【BPDU Type=0x80(TCN)，TCN报文不会有Flags等字段信息】<br> <img src="https://images2.imgbox.com/0c/cb/PxbTzcVP_o.png" alt="在这里插入图片描述"></p> 
<p>2). <strong>拓扑改变确认BPDU</strong>：<code>TCA</code>(Topology Change Acknowledgment Configuration BPDU)。配置BPDU的一种，和普通配置BPDU不同的是此配置 BPDU设置了一个Flag位。用于<code>非根交换机</code>在接收到拓扑改变通知BPDU的指定接口上向下行交换机发送拓扑改变通知的确认信息。</p> 
<p>标记域的TCA=1，TC=0（TCA BPDU）<br> 注意：根桥是不会发送TCA拓扑改变确认。</p> 
<p>3). <strong>拓扑改变BPDU</strong>：<code>TC</code>（Topology Change Configuration BPDU）。此配置BPDU设置了另外一个Flag位。用于从根交换机向整网泛洪拓扑改变信息，所有交换机都在自己所有的指定端口上 泛洪此BPDU。<br> 标记域的TCA=1，TC=1或者TCA=0，TC=1（TC BPDU）<br> <img src="https://images2.imgbox.com/cb/59/FSkU9HcF_o.png" alt="TC的报文" width="400" height="100"></p> 
<p><img src="https://images2.imgbox.com/ec/32/yeBaWsfv_o.png" alt="拓扑改变三种BPDU" width="500" height="240"></p> 
<p>TCN报文只向根桥，一级级向老总汇报，发生事故。<br> TCA报文由直接接收TCN的设备回复，第一个接收报警信息的上一级领导回复。<br> TC报文是老总向所有下属全部发时间缩短通知。</p> 
<p>TC拓扑变更消息–清空从此接口学到的MAC地址表----具体做法不是直接清空，而是通知下游设备把MAC地址表项的老化时间更改为Forward Delay时间（15s）。然后刷新MAC地址表。</p> 
<p>2、增加非根设备导致拓扑结构改变<br> <img src="https://images2.imgbox.com/b6/d4/l2BhciTd_o.png" alt="增加非根设备导致拓扑结构改变" width="500" height="240"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b80dc1c34c4f96b1b05c3f3c20348302/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">运算符的优先级记忆口诀</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/66d324fcd6a094f618cfec86ff1e0647/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【灾报警主机联网问题】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>