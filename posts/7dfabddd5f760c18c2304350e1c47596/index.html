<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用ComposeDesktop开发一款桌面端多功能APK工具 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用ComposeDesktop开发一款桌面端多功能APK工具" />
<meta property="og:description" content="前言 终于算是忙完了一个阶段！！！从4月份开始，工作内容以及职务上都进行了较大的变动，最直接的就是从海外项目组调到了国内项目组。国内项目组目前有两个应用在同时跑着，而且还有几个马甲包也要维护，不知道大家发版的时候复杂不复杂，反正我们每次发版的时候都需要经历–打包、加固、对齐、重签名、打渠道包、上传云存储、生成渠道推广链接、生成内更SQL、上传Mapping文件等等步骤(xN)，简直是折磨人啊。
所以首要任务就是做出一套自动化的基础设施来，最初直接考虑到的方案是【Jenkins&#43;Docker&#43;360命令行加固&#43;VasDolly&#43;Bugly等】的方案（下一篇文章会给大家分享该方案），整个过程下来基本能达到自动化的目的。就这么稳定的跑了一个多月，然而，在5月下旬的时候360加固发布了一个通知，大致内容就是免费版用户无法使用命令行的加固方式了，只能手动用工具加固。这就导致最初的方案直接垮掉，我花费了个把月学习Linux，Pipeline，Docker，还制作了各种镜像，结果突然不能用了，心塞。然而路还是要继续走下去的，在尽量不花钱的前提下，想到了开发桌面端工具的方案。
功能一览 接下来先给大家一览下桌面端工具的基本功能，我的电脑是Windows的，所以都是基于Windows平台下的build-tools相关工具进行开发的。首先大部分的功能都是基于jar或exe文件，那么在Java（Kotlin）中我们可以通过如下方式来调用这些外部程序，exec其实最终也是调用了ProcessBuilder，整体的原理就是如此：
//方式1 Runtime.getRuntime().exec(cmd) //方式2 ProcessBuilder(cmd) 多渠道打包 这是该工具最基本的功能，使用VasDolly方案对APK文件进行多渠道打包（当然该APK文件需要是签名好的）。
多渠道包命令行工具即 VasDolly.jar，该文件可以在上述GitHub仓库中找到，常用的命令如下：
// 获取指定APK的签名方式 java -jar VasDolly.jar get -s [源apk地址] // 获取指定APK的渠道信息 java -jar VasDolly.jar get -c [源apk地址] // 删除指定APK的渠道信息 java -jar VasDolly.jar remove -c [源apk地址] // 通过指定渠道字符串添加渠道信息 java -jar VasDolly.jar put -c &#34;channel1,channel2&#34; [源apk地址] [apk输出目录] // 通过指定某个渠道字符串添加渠道信息到目标APK java -jar VasDolly.jar put -c &#34;channel1&#34; [源apk地址] [输出apk地址] // 通过指定渠道文件添加渠道信息 java -jar VasDolly.jar put -c channel.txt [源apk地址] [apk输出目录] // 提供了FastMode，生成渠道包时不进行强校验，速度可提升10倍以上 java -jar VasDolly." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/7dfabddd5f760c18c2304350e1c47596/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-20T16:57:14+08:00" />
<meta property="article:modified_time" content="2022-07-20T16:57:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用ComposeDesktop开发一款桌面端多功能APK工具</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_2"></a>前言</h2> 
<p>终于算是忙完了一个阶段！！！从4月份开始，工作内容以及职务上都进行了较大的变动，最直接的就是从海外项目组调到了国内项目组。国内项目组目前有两个应用在同时跑着，而且还有几个马甲包也要维护，不知道大家发版的时候复杂不复杂，反正我们每次发版的时候都需要经历–打包、加固、对齐、重签名、打渠道包、上传云存储、生成渠道推广链接、生成内更SQL、上传Mapping文件等等步骤(xN)，简直是折磨人啊。</p> 
<p>所以首要任务就是做出一套自动化的基础设施来，最初直接考虑到的方案是【<strong>Jenkins+Docker+360命令行加固+VasDolly+Bugly等</strong>】的方案（下一篇文章会给大家分享该方案），整个过程下来基本能达到自动化的目的。就这么稳定的跑了一个多月，然而，在5月下旬的时候360加固发布了一个通知，大致内容就是免费版用户无法使用命令行的加固方式了，只能手动用工具加固。这就导致最初的方案直接垮掉，我花费了个把月学习Linux，Pipeline，Docker，还制作了各种镜像，结果突然不能用了，心塞。然而路还是要继续走下去的，在尽量不花钱的前提下，想到了开发桌面端工具的方案。</p> 
<h2><a id="_7"></a>功能一览</h2> 
<p>接下来先给大家一览下桌面端工具的基本功能，我的电脑是Windows的，所以都是基于Windows平台下的build-tools相关工具进行开发的。首先大部分的功能都是基于jar或exe文件，那么在Java（Kotlin）中我们可以通过如下方式来调用这些外部程序，exec其实最终也是调用了ProcessBuilder，整体的原理就是如此：</p> 
<pre><code class="prism language-java"><span class="token comment">//方式1</span>
<span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>

<span class="token comment">//方式2</span>
<span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_18"></a>多渠道打包</h3> 
<p>这是该工具最基本的功能，使用<a href="https://github.com/Tencent/VasDolly"><strong>VasDolly</strong></a>方案对APK文件进行多渠道打包（当然该APK文件需要是签名好的）。</p> 
<p><img src="https://images2.imgbox.com/c6/80/uF7TXXbb_o.png" alt="Snipaste_2022-06-29_20-41-40.png"></p> 
<p>多渠道包命令行工具即 VasDolly.jar，该文件可以在上述GitHub仓库中找到，常用的命令如下：</p> 
<pre><code class="prism language-java"><span class="token comment">// 获取指定APK的签名方式</span>
java <span class="token operator">-</span>jar <span class="token class-name">VasDolly</span><span class="token punctuation">.</span>jar get <span class="token operator">-</span>s <span class="token punctuation">[</span>源apk地址<span class="token punctuation">]</span>

<span class="token comment">// 获取指定APK的渠道信息</span>
java <span class="token operator">-</span>jar <span class="token class-name">VasDolly</span><span class="token punctuation">.</span>jar get <span class="token operator">-</span>c <span class="token punctuation">[</span>源apk地址<span class="token punctuation">]</span>

<span class="token comment">// 删除指定APK的渠道信息</span>
java <span class="token operator">-</span>jar <span class="token class-name">VasDolly</span><span class="token punctuation">.</span>jar remove <span class="token operator">-</span>c <span class="token punctuation">[</span>源apk地址<span class="token punctuation">]</span>

<span class="token comment">// 通过指定渠道字符串添加渠道信息</span>
java <span class="token operator">-</span>jar <span class="token class-name">VasDolly</span><span class="token punctuation">.</span>jar put <span class="token operator">-</span>c <span class="token string">"channel1,channel2"</span> <span class="token punctuation">[</span>源apk地址<span class="token punctuation">]</span> <span class="token punctuation">[</span>apk输出目录<span class="token punctuation">]</span>

<span class="token comment">// 通过指定某个渠道字符串添加渠道信息到目标APK</span>
java <span class="token operator">-</span>jar <span class="token class-name">VasDolly</span><span class="token punctuation">.</span>jar put <span class="token operator">-</span>c <span class="token string">"channel1"</span> <span class="token punctuation">[</span>源apk地址<span class="token punctuation">]</span> <span class="token punctuation">[</span>输出apk地址<span class="token punctuation">]</span>

<span class="token comment">// 通过指定渠道文件添加渠道信息</span>
java <span class="token operator">-</span>jar <span class="token class-name">VasDolly</span><span class="token punctuation">.</span>jar put <span class="token operator">-</span>c channel<span class="token punctuation">.</span>txt <span class="token punctuation">[</span>源apk地址<span class="token punctuation">]</span> <span class="token punctuation">[</span>apk输出目录<span class="token punctuation">]</span>

<span class="token comment">// 提供了FastMode，生成渠道包时不进行强校验，速度可提升10倍以上</span>
java <span class="token operator">-</span>jar <span class="token class-name">VasDolly</span><span class="token punctuation">.</span>jar put <span class="token operator">-</span>c channel<span class="token punctuation">.</span>txt <span class="token operator">-</span>f <span class="token punctuation">[</span>源apk地址<span class="token punctuation">]</span> <span class="token punctuation">[</span>apk输出目录<span class="token punctuation">]</span>

</code></pre> 
<h3><a id="_49"></a>对齐和签名</h3> 
<p>上传应用市场前，APK文件大部分会被市场要求进行加固，无论是使用腾讯乐固还是360加固等方式，加固后APK的签名信息总会被破坏，所以我们需要对加固后的APK文件重新进行签名。</p> 
<h4><a id="_52"></a>配置签名</h4> 
<p>首先我们需要准备好应用的签名信息，该工具支持导入签名文件，并保存相应的StorePass、KeyAlias、KeyPass信息，如下：</p> 
<p><img src="https://images2.imgbox.com/5f/a5/xz14Mcuv_o.png" alt="Snipaste_2022-06-29_20-52-49.png"></p> 
<p>当选择APK后，程序会判断选择的APK是否进行了签名，如果没有签名，那么就会弹窗提醒用户选择配置好的签名文件进行签名，签名之后才可进行多渠道打包的过程。</p> 
<p><img src="https://images2.imgbox.com/6b/2e/1LAlINxR_o.png" alt="Snipaste_2022-06-29_20-44-36.png"><br> 注：该功能现已升级，添加签名文件的时候绑定包名，选择apk后会自动获取到包名然后查找到对应的签名文件自动对齐签名处理，无需手动进行选择了。</p> 
<h4><a id="_62"></a>对齐</h4> 
<p>签名的过程则需要用到Android SDK中的两个文件，以Windows系统为例，一个是处理对齐的【build-tools\版本号\zipalign.exe】文件，另一个则是用来签名的【build-tools\版本号\lib\apksigner.jar】文件。</p> 
<p>我们先看下zipalign工具的官方说明：</p> 
<blockquote> 
 <p>zipalign is a zip archive alignment tool. It ensures that all uncompressed files in the archive are aligned relative to the start of the file. This allows those files to be accessed directly via <a href="https://man7.org/linux/man-pages/man2/mmap.2.html" rel="nofollow">mmap(2)</a>, removing the need to copy this data in RAM and reducing your app’s memory usage.<br> zipalign是一种zip归档对齐工具。它确保存档中所有未压缩的文件都与文件的开头对齐。这允许通过mmap直接访问这些文件，无需将这些数据复制到RAM中，并减少应用程序的内存使用。</p> 
 <p>zipalign should be used to optimize your APK file before distributing it to end-users. This is done automatically if you build with Android Studio. This documentation is for maintainers of custom build systems.<br> 在将APK文件分发给用户之前，应使用zipalign优化APK文件。如果您使用Android Studio进行构建，这将自动完成。本文档面向定制构建系统的维护人员。</p> 
</blockquote> 
<p>Google官方现在要求在使用apksigner对APK文件进行签名前需要先使用zipalign来优化APK文件，具体命令如下，以Windows下的zipalign.exe文件为例：</p> 
<pre><code class="prism language-java"><span class="token comment">//对齐APK</span>
zipalign<span class="token punctuation">.</span>exe <span class="token operator">-</span>p <span class="token operator">-</span>f <span class="token operator">-</span>v <span class="token number">4</span> <span class="token punctuation">[</span>源apk路径<span class="token punctuation">]</span> <span class="token punctuation">[</span>输出apk路径<span class="token punctuation">]</span>

<span class="token comment">//验证APK是否对齐</span>
zipalign<span class="token punctuation">.</span>exe <span class="token operator">-</span>c <span class="token operator">-</span>v <span class="token number">4</span> <span class="token punctuation">[</span>源apk路径<span class="token punctuation">]</span>
</code></pre> 
<p>其他相关的内容可以参阅官网 <a href="https://developer.android.google.cn/studio/command-line/zipalign" rel="nofollow">zipalign</a> 。</p> 
<h4><a id="_85"></a>签名</h4> 
<p>当APK文件对齐后，就可以给对齐后的APK进行签名操作了，签名的方法有两种，我们这里单说使用–ks选项指定密钥库的方式，具体命令如下：</p> 
<pre><code class="prism language-java">java <span class="token operator">-</span>jar apksigner<span class="token punctuation">.</span>jar sign
    <span class="token operator">--</span>verbose
    <span class="token operator">--</span>ks <span class="token punctuation">[</span><span class="token class-name">KeyStore</span>文件路径<span class="token punctuation">]</span>
    <span class="token operator">--</span>ks<span class="token operator">-</span>pass pass<span class="token operator">:</span><span class="token punctuation">[</span><span class="token class-name">KeyStorePass</span><span class="token punctuation">]</span>
    <span class="token operator">--</span>ks<span class="token operator">-</span>key<span class="token operator">-</span>alias <span class="token punctuation">[</span><span class="token class-name">KeyAlias</span><span class="token punctuation">]</span>
    <span class="token operator">--</span>key<span class="token operator">-</span>pass pass<span class="token operator">:</span><span class="token punctuation">[</span><span class="token class-name">KeyPass</span><span class="token punctuation">]</span>
    <span class="token operator">--</span>out <span class="token punctuation">[</span>输出apk路径<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>源apk路径<span class="token punctuation">]</span>
</code></pre> 
<p>命令本身很简单，别搞错参数就好，尤其是两个密码的参数，后面需要使用【pass:密码】。输入密码这里还支持其他格式，如果有需要请参阅官网 <a href="https://developer.android.google.cn/studio/command-line/apksigner?hl=en" rel="nofollow">apksigner</a> 。</p> 
<p>加固、对齐、重签名后，这个apk就可以进行多渠道打包的处理了，然后即可发布到相关市场和渠道。</p> 
<h3><a id="_103"></a>其他内容</h3> 
<p>在项目中还有很多其他的相关配置，比如发版的时候需要对APP进行应用内的更新通知。那么就需要我们填写发版的相关信息，版本名、版本号、更新日志等等内容都需要完善（可根据APK文件的命名来获取部分信息），然后通过这些信息生成应用内部更新的SQL语句，发送钉钉通知给相关后台人员处理。通知这一步又用到了钉钉的SDK，该工具支持配置钉钉机器人Webhook地址以及需要艾特的人员信息。</p> 
<p>打出来的这些包都需要统一上传到云存储上面，这一步使用了AWS的云存储SDK，可以配置云存储桶地址等信息，免去人工手动上传apk的烦恼。上传完毕后会根据文件名生成相应的下载链接并通知到钉钉群，以便市场人员获取到渠道最新的推广链接等。<br> <img src="https://images2.imgbox.com/aa/57/nl0KpL0v_o.png" alt="Snipaste_2022-06-29_20-45-40.png"></p> 
<h2><a id="_109"></a>桌面端开发</h2> 
<p>接下来就说下桌面端的开发过程，至于Compose MultiPlatform的介绍，请参阅<a href="https://www.jetbrains.com/lp/compose-mpp/" rel="nofollow">官网地址</a>。本文主要就描述下一些针对桌面端的相关需求。</p> 
<h3><a id="_112"></a>弹窗</h3> 
<p>关于弹窗，ComposeDesktop同样提供了Dialog可组合函数：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Composable</span>
<span class="token keyword">public</span> fun <span class="token class-name">Dialog</span><span class="token punctuation">(</span>
    onCloseRequest<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Unit</span><span class="token punctuation">,</span>
    state<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>compose<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>window<span class="token punctuation">.</span></span>DialogState</span><span class="token punctuation">,</span>
    visible<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Boolean</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>String</span><span class="token punctuation">,</span>
    icon<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>compose<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span>painter<span class="token punctuation">.</span></span>Painter</span><span class="token operator">?</span><span class="token punctuation">,</span>
    undecorated<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Boolean</span><span class="token punctuation">,</span>
    transparent<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Boolean</span><span class="token punctuation">,</span>
    resizable<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Boolean</span><span class="token punctuation">,</span>
    enabled<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Boolean</span><span class="token punctuation">,</span>
    focusable<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Boolean</span><span class="token punctuation">,</span>
    onPreviewKeyEvent<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>compose<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>input<span class="token punctuation">.</span>key<span class="token punctuation">.</span></span>KeyEvent</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Boolean</span><span class="token punctuation">,</span>
    onKeyEvent<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>compose<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>input<span class="token punctuation">.</span>key<span class="token punctuation">.</span></span>KeyEvent</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Boolean</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token annotation punctuation">@Composable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">DialogWindowScope</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Unit</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">kotlin<span class="token punctuation">.</span></span>Unit</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* compiled code */</span> <span class="token punctuation">}</span>

</code></pre> 
<p>大部分的参数都可以直接看出他的作用，主要看一下state参数，该参数可以控制弹窗的位置及大小，例如我们配置一个在屏幕中央，宽高为500*300dp的弹窗，那么示例代码如下：</p> 
<pre><code class="prism language-java">state <span class="token operator">=</span> <span class="token class-name">DialogState</span><span class="token punctuation">(</span>
            position <span class="token operator">=</span> <span class="token class-name">WindowPosition</span><span class="token punctuation">(</span><span class="token class-name">Alignment<span class="token punctuation">.</span>Center</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            size <span class="token operator">=</span> <span class="token class-name">DpSize</span><span class="token punctuation">(</span><span class="token number">500.d</span>p<span class="token punctuation">,</span> <span class="token number">300.d</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
</code></pre> 
<p>不过这个弹窗没有阴影，如果想添加的话可以内部套一层Surface来做出阴影效果：</p> 
<pre><code class="prism language-java"><span class="token class-name">Surface</span><span class="token punctuation">(</span>
    modifier <span class="token operator">=</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token number">20.d</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span>
    elevation <span class="token operator">=</span> <span class="token number">10.d</span>p<span class="token punctuation">,</span>
    shape <span class="token operator">=</span> <span class="token class-name">RoundedCornerShape</span><span class="token punctuation">(</span><span class="token number">16.d</span>p<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_154"></a>文件选择器</h3> 
<p>关于文件选择器这一块目前Compose还没有专门的函数，但是我们还是可以使用原有的方案：</p> 
<ul><li>javax.swing.JFileChooser</li><li>java.awt.FileDialog</li></ul> 
<p>个人还是更偏向于使用JFileChooser，因为使用第二种方案的话，在页面重组的情况下总是会莫名的弹出选择框来。一个简单的文件选择器如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> fun <span class="token function">showFileSelector</span><span class="token punctuation">(</span>
    suffixList<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    onFileSelected<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Unit</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">JFileChooser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>apply <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//设置页面风格</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            val lookAndFeel <span class="token operator">=</span> <span class="token class-name">UIManager</span><span class="token punctuation">.</span><span class="token function">getSystemLookAndFeelClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token class-name">UIManager</span><span class="token punctuation">.</span><span class="token function">setLookAndFeel</span><span class="token punctuation">(</span>lookAndFeel<span class="token punctuation">)</span>
            <span class="token class-name">SwingUtilities</span><span class="token punctuation">.</span><span class="token function">updateComponentTreeUI</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token class-name">Throwable</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        fileSelectionMode <span class="token operator">=</span> <span class="token class-name">JFileChooser</span><span class="token punctuation">.</span>FILES_ONLY
        isMultiSelectionEnabled <span class="token operator">=</span> <span class="token boolean">false</span>
        fileFilter <span class="token operator">=</span> <span class="token class-name">FileNameExtensionFilter</span><span class="token punctuation">(</span><span class="token string">"文件过滤"</span><span class="token punctuation">,</span> <span class="token operator">*</span>suffixList<span class="token punctuation">)</span>

        val result <span class="token operator">=</span> <span class="token function">showOpenDialog</span><span class="token punctuation">(</span><span class="token class-name">ComposeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token class-name">JFileChooser</span><span class="token punctuation">.</span>APPROVE_OPTION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            val dir <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentDirectory
            val file <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selectedFile
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Current apk dir: ${dir.absolutePath} ${dir.name}"</span><span class="token punctuation">)</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Current apk name: ${file.absolutePath} ${file.name}"</span><span class="token punctuation">)</span>
            <span class="token function">onFileSelected</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该方式在使用的过程中也有一定的缺陷，就是每次打开文件弹窗总是会卡顿一下，所以后续也是有了寻找其他高效选择文件方式的想法。</p> 
<h3><a id="_195"></a>文件拖拽</h3> 
<p>选择文件除了上面的弹窗选择方式，还有另一种神奇的方式 - 拖拽选择，本来也是没有头绪，然而在Slack闲逛的时候发现了Jim Sproch推荐了一篇相关的文章：<a href="https://dev.to/tkuenneth/from-swing-to-jetpack-compose-desktop-2-4a4h" rel="nofollow">https://dev.to/tkuenneth/from-swing-to-jetpack-compose-desktop-2-4a4h</a> 。看完后也是恍然大悟，但是在Compose Desktop中，window是整个窗口，如何让某一个指定的区域响应我们的文件拖拽事件呢？</p> 
<p>还记得在Android上有ComposeView吧，用来嵌套原来的那一套View体系。那么在这里我也是采用了类似的这么一种方式，实例一个空的JPanel控件然后给它安排到window中去。具体位置及大小的设置呢，在Compose中可以通过 <strong>onPlaced(onPlaced: (LayoutCoordinates) -&gt; Unit)</strong> 修饰符来获取到，示例代码如下所示：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span><span class="token class-name">ExperimentalComposeUiApi</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Composable</span>
fun <span class="token class-name">DropBoxPanel</span><span class="token punctuation">(</span>
    modifier<span class="token operator">:</span> <span class="token class-name">Modifier</span><span class="token punctuation">,</span>
    window<span class="token operator">:</span> <span class="token class-name">ComposeWindow</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> <span class="token class-name">JPanel</span> <span class="token operator">=</span> <span class="token class-name">JPanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    onFileDrop<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Unit</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    val dropBoundsBean <span class="token operator">=</span> remember <span class="token punctuation">{<!-- --></span>
        <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token class-name">DropBoundsBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Box</span><span class="token punctuation">(</span>
        modifier <span class="token operator">=</span> modifier<span class="token punctuation">.</span>onPlaced <span class="token punctuation">{<!-- --></span>
            dropBoundsBean<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token class-name">DropBoundsBean</span><span class="token punctuation">(</span>
                x <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">positionInWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span>
                y <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">positionInWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                width <span class="token operator">=</span> it<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
                height <span class="token operator">=</span> it<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LaunchedEffect</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            component<span class="token punctuation">.</span><span class="token function">setBounds</span><span class="token punctuation">(</span>
                dropBoundsBean<span class="token punctuation">.</span>value<span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token function">roundToInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                dropBoundsBean<span class="token punctuation">.</span>value<span class="token punctuation">.</span>y<span class="token punctuation">.</span><span class="token function">roundToInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                dropBoundsBean<span class="token punctuation">.</span>value<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
                dropBoundsBean<span class="token punctuation">.</span>value<span class="token punctuation">.</span>height
            <span class="token punctuation">)</span>
            window<span class="token punctuation">.</span>contentPane<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span>

            val target <span class="token operator">=</span> object <span class="token operator">:</span> <span class="token class-name">DropTarget</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> object <span class="token operator">:</span> <span class="token class-name">DropTargetAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                override fun <span class="token function">drop</span><span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token class-name">DropTargetDropEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                    event<span class="token punctuation">.</span><span class="token function">acceptDrop</span><span class="token punctuation">(</span><span class="token class-name">DnDConstants</span><span class="token punctuation">.</span>ACTION_REFERENCE<span class="token punctuation">)</span>
                    val dataFlavors <span class="token operator">=</span> event<span class="token punctuation">.</span>transferable<span class="token punctuation">.</span>transferDataFlavors
                    dataFlavors<span class="token punctuation">.</span>forEach <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> <span class="token class-name">DataFlavor</span><span class="token punctuation">.</span>javaFileListFlavor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            val list <span class="token operator">=</span> event<span class="token punctuation">.</span>transferable<span class="token punctuation">.</span><span class="token function">getTransferData</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> as <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span>

                            val pathList <span class="token operator">=</span> mutableListOf<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            list<span class="token punctuation">.</span>forEach <span class="token punctuation">{<!-- --></span> filePath <span class="token operator">-&gt;</span>
                                pathList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>filePath<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                            <span class="token function">onFileDrop</span><span class="token punctuation">(</span>pathList<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    event<span class="token punctuation">.</span><span class="token function">dropComplete</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">SideEffect</span> <span class="token punctuation">{<!-- --></span>
            component<span class="token punctuation">.</span><span class="token function">setBounds</span><span class="token punctuation">(</span>
                dropBoundsBean<span class="token punctuation">.</span>value<span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token function">roundToInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                dropBoundsBean<span class="token punctuation">.</span>value<span class="token punctuation">.</span>y<span class="token punctuation">.</span><span class="token function">roundToInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                dropBoundsBean<span class="token punctuation">.</span>value<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
                dropBoundsBean<span class="token punctuation">.</span>value<span class="token punctuation">.</span>height
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">DisposableEffect</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            onDispose <span class="token punctuation">{<!-- --></span>
                window<span class="token punctuation">.</span>contentPane<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实际运行效果如下，个人感觉基本还是能达到目的的：</p> 
<p><img src="https://images2.imgbox.com/50/8c/KiwB5tw0_o.gif" alt="GIF 2022-7-19 19-27-50.gif"></p> 
<h3><a id="_277"></a>数据的保存</h3> 
<p>最开始的时候，功能很少，每个配置的数据都是使用了txt文件来一行行保存，但是到了后来功能越来越复杂，单纯的按行来处理貌似有点捉襟见肘了，所以考虑使用json来保存复杂的类型数据。</p> 
<p>json数据的处理从原生JSON到FastJson，Gson，Moshi等都已经体验过了，于是乎便采用了之前未使用过的<a href="" rel="nofollow"><strong>Jackson</strong></a>。然而不得不说，就目前为止，jackson是我用过最简洁、优雅的一款解析库。</p> 
<p>假如我有一个List类型的列表数据，那么当我要把这个数据存储到文件的时候只需：</p> 
<pre><code class="prism language-java"><span class="token function">jacksonObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span><span class="token class-name">File</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
</code></pre> 
<p>而从文件中读取数据也是简单的狠啊：</p> 
<pre><code class="prism language-java"><span class="token comment">//方式1</span>
val list <span class="token operator">=</span> <span class="token function">jacksonObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readValue<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>jsonFile<span class="token punctuation">)</span>

<span class="token comment">//方式2</span>
val list <span class="token operator">:</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token operator">=</span> <span class="token function">jacksonObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>jsonFile<span class="token punctuation">)</span>
</code></pre> 
<p>这种简洁真的是深入我心。继续深入了解下Jackson，你会发现它的可扩展性以及可定制性都很强，简直相见恨晚啊。之前也是在一个舒适圈待习惯了，这次主动跳出来居然有了意想不到的收获。</p> 
<p>但是呢，每个框架也会有它自己的注意点，比如jackson，属性命名不可以是is开头，否则序列化等就会报错。这点似乎在阿里巴巴JAVA手册中好像也有提到，具体原因请大家自行百度（Google）。</p> 
<h3><a id="_302"></a>资源的拷贝</h3> 
<p>当我们使用[java -jar xxx.jar]命令执行jar文件的时候，需要明确指定 jar文件的地址，但是在Compose Desktop中我们要怎么存放并读取这个jar文件呢 ？我们可以从Compose Desktop中读取并展示图片的相关代码中得到启发，假如有一个sample.svg图标文件存放到了项目的 resources 文件夹下，那么我们在引用这张图片的时候就可以使用：</p> 
<pre><code class="prism language-java"><span class="token function">painterResource</span><span class="token punctuation">(</span><span class="token string">"sample.svg"</span><span class="token punctuation">)</span>
</code></pre> 
<p>我们点进去这个方法看下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span><span class="token class-name">ExperimentalComposeUiApi</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Composable</span>
fun <span class="token function">painterResource</span><span class="token punctuation">(</span>
    resourcePath<span class="token operator">:</span> <span class="token class-name">String</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Painter</span> <span class="token operator">=</span> <span class="token function">painterResource</span><span class="token punctuation">(</span>
    resourcePath<span class="token punctuation">,</span>
    <span class="token class-name">ResourceLoader<span class="token punctuation">.</span>Default</span>
<span class="token punctuation">)</span>

<span class="token annotation punctuation">@ExperimentalComposeUiApi</span>
<span class="token annotation punctuation">@Composable</span>
fun <span class="token function">painterResource</span><span class="token punctuation">(</span>
    resourcePath<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    loader<span class="token operator">:</span> <span class="token class-name">ResourceLoader</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Painter</span> <span class="token operator">=</span> when <span class="token punctuation">(</span>resourcePath<span class="token punctuation">.</span><span class="token function">substringAfterLast</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"svg"</span> <span class="token operator">-&gt;</span> <span class="token function">rememberSvgResource</span><span class="token punctuation">(</span>resourcePath<span class="token punctuation">,</span> loader<span class="token punctuation">)</span>
    <span class="token string">"xml"</span> <span class="token operator">-&gt;</span> <span class="token function">rememberVectorXmlResource</span><span class="token punctuation">(</span>resourcePath<span class="token punctuation">,</span> loader<span class="token punctuation">)</span>
    <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token function">rememberBitmapResource</span><span class="token punctuation">(</span>resourcePath<span class="token punctuation">,</span> loader<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>里面居然有个ResourceLoader类，这名字一听就有戏啊，大概率就是我们需要的内容，而传递的默认参数是ResourceLoader.Default，那么就看下Default的源码吧：</p> 
<pre><code class="prism language-java"><span class="token comment">//==========Resources.desktop.kt文件==========</span>
<span class="token annotation punctuation">@ExperimentalComposeUiApi</span>
<span class="token keyword">interface</span> <span class="token class-name">ResourceLoader</span> <span class="token punctuation">{<!-- --></span>
    companion object <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * Resource loader which is capable to load resources from `resources` folder in an application's
         * project. Ability to load from dependent modules resources is not guaranteed in the future.
         * Use explicit `ClassLoaderResourceLoader` instance if such guarantee is needed.
         */</span>
        <span class="token annotation punctuation">@ExperimentalComposeUiApi</span>
        val <span class="token class-name">Default</span> <span class="token operator">=</span> <span class="token class-name">ClassLoaderResourceLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fun <span class="token function">load</span><span class="token punctuation">(</span>resourcePath<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">InputStream</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ExperimentalComposeUiApi</span>
<span class="token keyword">class</span> <span class="token class-name">ClassLoaderResourceLoader</span> <span class="token operator">:</span> <span class="token class-name">ResourceLoader</span> <span class="token punctuation">{<!-- --></span>
    override fun <span class="token function">load</span><span class="token punctuation">(</span>resourcePath<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">InputStream</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// TODO(https://github.com/JetBrains/compose-jb/issues/618): probably we shouldn't use</span>
        <span class="token comment">//  contextClassLoader here, as it is not defined in threads created by non-JVM</span>
        val contextClassLoader <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contextClassLoader<span class="token operator">!</span><span class="token operator">!</span>
        val resource <span class="token operator">=</span> contextClassLoader<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resourcePath<span class="token punctuation">)</span>
            <span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">::</span><span class="token class-name">ClassLoaderResourceLoader</span><span class="token punctuation">.</span>javaClass<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resourcePath<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">requireNotNull</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"Resource $resourcePath not found"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//==========ClassLoader类==========</span>
<span class="token keyword">public</span> <span class="token class-name">InputStream</span> <span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token function">getResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> url <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> url<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">URL</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">URL</span> url<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        url <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        url <span class="token operator">=</span> <span class="token class-name">BootLoader</span><span class="token punctuation">.</span><span class="token function">findResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        url <span class="token operator">=</span> <span class="token function">findResource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> url<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述源码的整个逻辑基本上就是两步，根据资源文件名获取到资源文件，然后获取资源文件的输入流。看到这里其实我们已经有两种方案了：</p> 
<ul><li>方案一：直接拿到文件的URL然后获取到文件的路径</li><li>方案二：根据文件的输入流，将文件重新保存到本机相关目录</li></ul> 
<p>然而事情并没有这么简单，如果我们使用方案一，那么在编译运行的时候完全没有问题，所有的资源文件会被保存到【\build\processedResources\jvm】下，此时我们直接可以通过文件的URL获取到文件路径，然后调用即可。但是，当我们打包成安装包后，例如在Windows下使用packageMsi命令打包出msi文件并安装到电脑上后，运行程序，这时候你就会发现资源文件所在的路径就很奇怪，例如我的工程下是【C:\Program Files\工程名\app\工程名-jvm-1.0-SNAPSHOT-xxxxxx.jar!/资源文件名】，也就是说所有的资源文件被打包进了这个快照文件，如果此时直接使用该路径运行java -jar 等命令，那么肯定就会报错了。</p> 
<p>所以最稳妥的方式还是使用方案二，使用ResourceLoader获取到资源文件流然后重新保存到本机上的相关目录就好了，伪代码如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">ResourceLoader<span class="token punctuation">.</span>Default</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>resourcesPath<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>use <span class="token punctuation">{<!-- --></span> inputStream <span class="token operator">-&gt;</span>
        val fos <span class="token operator">=</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        val buffer <span class="token operator">=</span> <span class="token class-name">ByteArray</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> len<span class="token operator">:</span> <span class="token class-name">Int</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">.</span>also <span class="token punctuation">{<!-- --></span> len <span class="token operator">=</span> it <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
          fos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="MSI_413"></a>打包MSI</h3> 
<p>在Windows环境下打包Msi格式安装包的时候，有一个downloadWix的Task，该Task涉及到了Wix资源的下载，如下 ：</p> 
<blockquote> 
 <p>Task :downloadWix<br> Download <a href="https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311-binaries.zip">https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311-binaries.zip</a></p> 
</blockquote> 
<p>在IDEA中下载可能会非常的缓慢，此时我们可以复制上述地址，登上梯子，然后直接去GitHub下载。下载完毕后直接放入【/build/wixToolset】目录下即可，再次编译速度就会起飞了。</p> 
<h2><a id="_420"></a>总结</h2> 
<p>简直没想到啊，作为一个Android开发者，现在借助Compose Desktop开发起桌面端居然能这么的轻车熟路，我对Compose真是越来越喜欢了。</p> 
<p>另外呢，跳出业务这一段时间来处理这些东西也让我对干预APK的打包等过程从理论迈出了实践的一步，同时对市场和运营同学的工作也有了更多了解，通过该工具帮助其处理了部分重复机械式的工作，部门间的感情也得到了进一步的增温（狗头滑稽）。</p> 
<p>就编到这吧，桌面工具还需要持续的维护跟优化，基本是面向市场和运营同事编程了。关于开头说的Jenkins那一套其实早就写好了，是鄙人少有的万字长文，但是中间变故太大，一直也没发布出来，接下来会重新整理下并发布，还请大家多多指正。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/203e84293be0f2089b3d8de54bd16830/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Burp Suite下载CA证书</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7f0dee1b0b997351db7d0de59382e82e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">k8s nginx .yaml 测试</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>