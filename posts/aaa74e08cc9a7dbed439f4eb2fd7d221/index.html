<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>LWIP开发 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="LWIP开发" />
<meta property="og:description" content="目录 前言一、TCP/IP 协议以及LWIP简介1.1 TCP/IP协议简介1.2 STM32的ETH外设1.2.1 MAC子层1.2.2 SMI站管理接口1.2.3 MII和RMII接口 1.3 外部PHY芯片LAN87201.3.1 LAN8720 中断管理1.3.2 PHY 地址设置1.3.3 nINT/REFCLKO 配置1.3.4 LAN8720 内部寄存器 1.4 LWIP 简介 二、带操作系统的移植2.1 移植准备工作2.2 文件移植与工程添加2.3 修改以太网驱动2.3.1 stm32f4x7_eth_conf.h修改2.3.2 修改 stm32f4x7_eth.c 文件2.3.3 添加 LAN8720 和 MAC /DMA 驱动 2.4 LwIP的网络接口修改2.4.1 添加ethernetif.h文件2.4.2 修改ethernetif.c文件2.4.3 修改mem.c 和 memp.c文件2.4.5 修改icmp.c 文件 2.5 修改LWIP与UCOS接口文件2.5.1 修改LWIP源文件名字2.5.2 修改头文件2.5.3 修改 lwipopts.h配置文件2.5.4 修改 sys_arch.h 和 sys.arch.c 文件2.5.5 添加LWIP通用文件 2.6 测试函数编写 三、NETCONN接口编程3.1 pbuf结构3.2 netbuf数据缓冲区3.3 netconn连接结构3.4 netconn编程API函数 四、Socket接口编程五、HTTP协议六、MQTT协议 前言 主要介绍FWIP的移植，以及基于操作系统的应用
一、TCP/IP 协议以及LWIP简介 1.1 TCP/IP协议简介 TCP/IP 中文名为传输控制协议/因特网互联协议，又名网络通讯协议，是 Internet 最基本的协议、Internet 国际互联网络的基础，由网络层的 IP 协议和传输层的 TCP 协议组成。TCP/IP 协议不是 TCP 和 IP 这两个协议的合称，而是指因特网整个 TCP/IP 协议族。从协议分层模型方面来讲，TCP/IP 由四个层次组成：网络接口层、网络层、传输层、应用层。OSI 是传统的开放式系统互连参考模型,该模型将 TCP/IP 分为七层:物理层、数据链路层（网络接口层）、网络层（网络层）、传输层（传输层）、会话层、表示层和应用层（应用层）。TCP/IP 模型与 OSI模型对比如表所示" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/aaa74e08cc9a7dbed439f4eb2fd7d221/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-10T10:06:44+08:00" />
<meta property="article:modified_time" content="2023-07-10T10:06:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">LWIP开发</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_3" rel="nofollow">前言</a></li><li><a href="#TCPIP_LWIP_5" rel="nofollow">一、TCP/IP 协议以及LWIP简介</a></li><li><ul><li><a href="#11_TCPIP_6" rel="nofollow">1.1 TCP/IP协议简介</a></li><li><a href="#12_STM32ETH_12" rel="nofollow">1.2 STM32的ETH外设</a></li><li><ul><li><a href="#121_MAC_16" rel="nofollow">1.2.1 MAC子层</a></li><li><a href="#122_SMI_20" rel="nofollow">1.2.2 SMI站管理接口</a></li><li><a href="#123_MIIRMII_22" rel="nofollow">1.2.3 MII和RMII接口</a></li></ul> 
   </li><li><a href="#13_PHYLAN8720_27" rel="nofollow">1.3 外部PHY芯片LAN8720</a></li><li><ul><li><a href="#131_LAN8720__30" rel="nofollow">1.3.1 LAN8720 中断管理</a></li><li><a href="#132_PHY__32" rel="nofollow">1.3.2 PHY 地址设置</a></li><li><a href="#133_nINTREFCLKO__34" rel="nofollow">1.3.3 nINT/REFCLKO 配置</a></li><li><a href="#134_LAN8720__37" rel="nofollow">1.3.4 LAN8720 内部寄存器</a></li></ul> 
   </li><li><a href="#14_LWIP__49" rel="nofollow">1.4 LWIP 简介</a></li></ul> 
  </li><li><a href="#_57" rel="nofollow">二、带操作系统的移植</a></li><li><ul><li><a href="#21__58" rel="nofollow">2.1 移植准备工作</a></li><li><a href="#22__63" rel="nofollow">2.2 文件移植与工程添加</a></li><li><a href="#23__81" rel="nofollow">2.3 修改以太网驱动</a></li><li><ul><li><a href="#231_stm32f4x7_eth_confh_82" rel="nofollow">2.3.1 stm32f4x7_eth_conf.h修改</a></li><li><a href="#232__stm32f4x7_ethc__129" rel="nofollow">2.3.2 修改 stm32f4x7_eth.c 文件</a></li><li><a href="#233__LAN8720__MAC_DMA__172" rel="nofollow">2.3.3 添加 LAN8720 和 MAC /DMA 驱动</a></li></ul> 
   </li><li><a href="#24_LwIP_462" rel="nofollow">2.4 LwIP的网络接口修改</a></li><li><ul><li><a href="#241_ethernetifh_463" rel="nofollow">2.4.1 添加ethernetif.h文件</a></li><li><a href="#242_ethernetifc_467" rel="nofollow">2.4.2 修改ethernetif.c文件</a></li><li><a href="#243_memc__mempc_597" rel="nofollow">2.4.3 修改mem.c 和 memp.c文件</a></li><li><a href="#245_icmpc__621" rel="nofollow">2.4.5 修改icmp.c 文件</a></li></ul> 
   </li><li><a href="#25_LWIPUCOS_650" rel="nofollow">2.5 修改LWIP与UCOS接口文件</a></li><li><ul><li><a href="#251_LWIP_651" rel="nofollow">2.5.1 修改LWIP源文件名字</a></li><li><a href="#252__664" rel="nofollow">2.5.2 修改头文件</a></li><li><a href="#253__lwipoptsh_770" rel="nofollow">2.5.3 修改 lwipopts.h配置文件</a></li><li><a href="#254__sys_archh__sysarchc__877" rel="nofollow">2.5.4 修改 sys_arch.h 和 sys.arch.c 文件</a></li><li><a href="#255_LWIP_1215" rel="nofollow">2.5.5 添加LWIP通用文件</a></li></ul> 
   </li><li><a href="#26__1492" rel="nofollow">2.6 测试函数编写</a></li></ul> 
  </li><li><a href="#NETCONN_1653" rel="nofollow">三、NETCONN接口编程</a></li><li><ul><li><a href="#31__pbuf_1655" rel="nofollow">3.1 pbuf结构</a></li><li><a href="#32__netbuf_1681" rel="nofollow">3.2 netbuf数据缓冲区</a></li><li><a href="#33_netconn_1699" rel="nofollow">3.3 netconn连接结构</a></li><li><a href="#34_netconnAPI_1771" rel="nofollow">3.4 netconn编程API函数</a></li></ul> 
  </li><li><a href="#Socket_1854" rel="nofollow">四、Socket接口编程</a></li><li><a href="#HTTP_1855" rel="nofollow">五、HTTP协议</a></li><li><a href="#MQTT_1856" rel="nofollow">六、MQTT协议</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_3"></a>前言</h2> 
<p>  主要介绍FWIP的移植，以及基于操作系统的应用</p> 
<h2><a id="TCPIP_LWIP_5"></a>一、TCP/IP 协议以及LWIP简介</h2> 
<h3><a id="11_TCPIP_6"></a>1.1 TCP/IP协议简介</h3> 
<p>  TCP/IP 中文名为传输控制协议/因特网互联协议，又名网络通讯协议，是 Internet 最基本的协议、Internet 国际互联网络的基础，由网络层的 IP 协议和传输层的 TCP 协议组成。TCP/IP 协议不是 TCP 和 IP 这两个协议的合称，而是指因特网整个 TCP/IP 协议族。从协议分层模型方面来讲，TCP/IP 由四个层次组成：网络接口层、网络层、传输层、应用层。OSI 是传统的开放式系统互连参考模型,该模型将 TCP/IP 分为七层:物理层、数据链路层（网络接口层）、网络层（网络层）、传输层（传输层）、会话层、表示层和应用层（应用层）。TCP/IP 模型与 OSI模型对比如表所示<br> <img src="https://images2.imgbox.com/94/f5/gvozmFWE_o.png" alt="在这里插入图片描述"><br>   在LWIP实验中 PHY 层芯片 LAN8720 相当于物理层，STM32F407 自带的 MAC 层相当于数据链路层,而 LWIP 提供的就是网络层、传输层的功能，应用层是需要用户自己根据自己想要的功能去实现的。</p> 
<h3><a id="12_STM32ETH_12"></a>1.2 STM32的ETH外设</h3> 
<p>  STM32F407 芯片自带以太网模块，该模块包括带专用 DMA 控制器的 MAC 802.3（介质访问控制）控制器，支持介质独立接口 (MII) 和简化介质独立接口 (RMII)，并自带了一个用于外部 PHY 通信的 SMI 接口，通过一组配置寄存器，用户可以为 MAC 控制器和 DMA 控制器选择所需模式和功能。<br> <img src="https://images2.imgbox.com/e3/52/G89Sw1ly_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="121_MAC_16"></a>1.2.1 MAC子层</h4> 
<p>  MAC 子层是属于数据链路层的下半部分，它主要负责与物理层进行数据交接，如是否可以发送数据，发送的数据是否正确，对数据流进行控制等。它自动对来自上层的数据包加上一些控制信号，交给物理层。接收方得到正常数据时，自动去除 MAC 控制信号，把该数据包交给上层<br>   IEEE 对以太网上传输的数据包格式也进行了统一规定，MAC 数据包由前导字段、帧起始定界符、目标地址、源地址、数据包类型、数据域、填充域、校验和域组成。<br> <img src="https://images2.imgbox.com/7e/4d/ZOpL9Nzt_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="122_SMI_20"></a>1.2.2 SMI站管理接口</h4> 
<p>  站管理接口(SMI) 允许应用程序通过 2 条线：时钟(MDC)和数据线(MDIO)访问任意 PHY 寄存器。该接口支持访问多达 32 个 PHY。应用程序可以从 32 个 PHY 中选择一个 PHY，然后从任意 PHY 包含的 32 个寄存器中选择一个寄存器，发送控制数据或接收状态信息。任意给定时间内只能对一个 PHY 中的一个寄存器进行寻址。在 MAC 对 PHY 进行读写操作的时候，应用程序不能修改 MII 的地址寄存器和 MII 的数据寄存器。在此期间对 MII 地址寄存器或 MII 数据寄存器执行的写操作将会被忽略。</p> 
<h4><a id="123_MIIRMII_22"></a>1.2.3 MII和RMII接口</h4> 
<p>  介质独立接口(MII)用于MAC层与PHY层进行数据传输。而精简介质独立接口(RMII) 规范降低 10/100 Mbit/s 下微控制器以太网外设与外部 PHY 间的引脚数。根据 IEEE 802.3u 标准，MII 包括 16 个数据和控制信号的引脚。RMII 规范将引脚数减少为 7 个。<br>   因为 RMII 相比 MII，其发送和接收都少了两条线。因此要达到 10Mbit/s 的速度，其时钟频率应为 5MHZ，同理要达到100Mbit/s 的速度其时钟频率应为 50MHz，而 MII 接口分别为 2.5MHZ 和 25MHZ。STM32F407 开发板采用 RMII 接口连接 LAN8720示意图：<br> <img src="https://images2.imgbox.com/00/de/ksjCWKJe_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="13_PHYLAN8720_27"></a>1.3 外部PHY芯片LAN8720</h3> 
<p>  LAN8720 是低功耗的 10/100M 以太网 PHY 层芯片，I/O 引脚电压符合 IEEE802.3-2005 标准。LAN8720 支持通过 RMII 接口与以太网 MAC 层通信，内置 10-BASE-T/100BASE-TX 全双工传输模块，支持 10Mbps 和 100Mbps。LAN8720 可以通过自协商的方式与目的主机最佳的连接方式(速度和双工模式)。支持 HP Auto-MDIX 自动翻转功能，无需更换网线即可将连接更改为直连或交叉连接。LAN8720 功能框图如图所示：<br> <img src="https://images2.imgbox.com/3b/ea/xr20ilwz_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="131_LAN8720__30"></a>1.3.1 LAN8720 中断管理</h4> 
<p>  当一个中断事件发生并且相应事件的中断位使能，LAN8720 就会在 nINT(14 脚)产生一个低电平有效的中断信号。LAN8720的中断系统提供两种中断模式：主中断模式和复用中断模式。主中断模式是默认中断模式，LAN8720 上电或复位后就工作在主中断模式，当模式控制/状态寄存器(十进制地址为 17)的ALTINT 为 0 是 LAN8720 工作在主模式，当 ALTINT 为 1 时工作在复用中断模式。<strong>可以不使用用到中断功能</strong></p> 
<h4><a id="132_PHY__32"></a>1.3.2 PHY 地址设置</h4> 
<p>  MAC 层通过 SMI 总线对 PHY 进行读写操作，SMI 可以控制 32 个 PHY 芯片，通过不同的PHY 芯片地址来对不同的 PHY 操作。LAN8720 通过设置 RXER/PHYAD0 引脚来设置其 PHY地址，默认情况下为 0，在系统上电时会检测该引脚获取得到 LAN8720A的地址为 0 或者 1，并保存在特殊模式寄存器(R18)的 PHYAD 位中，该寄存器的 PHYAD有 5 个位，在需要超过 2 个 LAN8720A 时可以通过软件设置不同 SMI 通信地址。PHYAD[0]是与 RXER 引脚共用。</p> 
<h4><a id="133_nINTREFCLKO__34"></a>1.3.3 nINT/REFCLKO 配置</h4> 
<p>  nINTSEL引脚(2 号引脚)用于设置 nINT/REFCLKO 引脚(14 号引脚)的功能。当工作在 REF_CLK In 模式时，50MHz 的外部时钟信号应接到 LAN8720 的 XTAL1/CKIN引脚(5 号引脚)和 STM32F407 的 RMII_REF_CLK(PA1)引脚上；为了降低成本，LAN8720 可以从外部的 25MHz 的晶振中产生 REF_CLK 时钟。到要使用此功能时应工作在 REF_CLK Out 模式时。<br> <img src="https://images2.imgbox.com/0d/df/52oSRRF1_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="134_LAN8720__37"></a>1.3.4 LAN8720 内部寄存器</h4> 
<p>  PHY 是由 IEEE 802.3 定义的，一般通过 SMI 对 PHY 进行管理和控制,也就是读写 PHY 内部寄存器。PHY 寄存器的地址空间为 5 位，可以定义 0 ~ 31 共 32 个寄存器，IEEE 802.3 定义了 0~ 15 这 16 个寄存器的功能，16~31 寄存器由芯片制造商自由定义。但是随之 PHY 芯片功能的增加，很多 PHY 芯片采用分页技术来扩展地址空间，定义更多的寄存器，在这里我们只介绍几个用到的寄存器（括号内为寄存器地址，此处使用十进制表示）：BCR(0)，BSR(1)，PHY 特殊功能寄存器(31)这三个寄存器。</p> 
<ol><li> <p>BCR寄存器<br> <img src="https://images2.imgbox.com/68/4b/IYD9Bnff_o.png" alt="在这里插入图片描述"><br>   我们配置 LAN8720 其实就是配置 BCR 寄存器，我们通过调用 ST 官方的以太网库的ETH_ReadPHYRegister 和 ETH_WritePHYRegister 函数来完成对 PHY 芯片寄存器的读写操作。在 ST 官方以太网库的 stm32f4x7_eth.h 中已经定义了 BCR 和 BSR 寄存器。在以后要讲的 LAN8720 初始化的中并没有看到我们直接操作 PHY 的寄存器，原因就在这里当我们调用 ETH_Init()函数以后就会根据我们输入的参数配置 LAN8720 的相应寄存器。</p> </li><li> <p>BSR 寄存器<br> <img src="https://images2.imgbox.com/6e/04/FmaLCDal_o.png" alt="在这里插入图片描述"></p> </li><li> <p>LAN8720 特殊功能寄存器<br> <img src="https://images2.imgbox.com/dc/50/apM5HNmn_o.png" alt="在这里插入图片描述"><br>   特殊功能寄存器中我们关心的是 bit2~bit4 这三位，因为通过这 3 位来确定连接的状态和速度。在 ETH_Init 函数中通过读取这 3 位的值来设置 BCR 寄存器的 bit8 和 bit13。由于特殊功能寄存器不属于 IEEE802.3 规定的前 16 个寄存器，所以每个厂家的可能不同，这个需要用户根自己实际使用的 PHY 芯片去修改，在 stm32f4x7_eth_conf.h 文件中定义</p> </li></ol> 
<h3><a id="14_LWIP__49"></a>1.4 LWIP 简介</h3> 
<p>  LwIP 全名：Light weight IP，意思是轻量化的 TCP/IP 协议，是瑞典计算机科学院(SICS)的 Adam Dunkels 开发的一个小型开源的 TCP/IP 协议栈。LwIP 的设计初衷是：用少量的资源消耗实现一个较为完整的 TCP/IP 协议栈，其中“完整”主要指的是 TCP 协议的完整性，实现的重点是在保持 TCP 协议主要功能的基础上减少对 RAM 的占用。此外 LwIP既可以移植到操作系统上运行，也可以在无操作系统的情况下独立运行。下载网址<a href="http://download-mirror.savannah.gnu.org/releases/lwip/" rel="nofollow">http://download-mirror.savannah.gnu.org/releases/lwip/</a><br>   下载两个包：lwip-2.1.2.zip（源码包）和 contrib-2.1.0.zip（contrib 包）。解压以后会得到两个文件夹。打开LWIP1.4.1 其中包括 doc，src 和 test 三个文件夹和 5 个其他文件。doc 文件夹下包含了几个与协议栈使用相关的文本文档，doc 文件夹里面有两个比较重要的文档:rawapi.txt 和 sys_arch.txt。<br> <img src="https://images2.imgbox.com/0b/be/8eOxBbh8_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/15/9c/lcyXlibR_o.png" alt="在这里插入图片描述"></p> 
<p>  rawapi.txt 告诉读者怎么使用 raw/callback API 进行编程，sys_arch.txt 包含了移植说明，在移植的时候会用到。src 文件夹是我们的重点，里面包含了 LWIP 的源码。test 是 LWIP 提供的一些测试程序。src 文件夹由 4 个文件夹组成：api、core、include、netif 四个文件夹。api 文件夹里面是 LWIP的 sequential API(Netconn)和 socket API 两种接口函数的源码，要使用这两种 API 需要操作系统支持。 core 文件夹是 LWIP 内核源码，include 文件夹里面是 LWIP 使用到的头文件，netif 文件夹里面是与网络底层接口有关的文件。<br>   LwIP 提供了三种编程接口，分别为 RAW/Callback API、NETCONN API、SOCKETAPI。它们的易用性从左到右依次提高，而执行效率从左到右依次降低，用户可以根据实际情况，平衡利弊，选择合适的 API 进行网络应用程序的开发。以下内容将分别介绍这三种 API。</p> 
<h2><a id="_57"></a>二、带操作系统的移植</h2> 
<h3><a id="21__58"></a>2.1 移植准备工作</h3> 
<p>  需要三个官方文件lwip-1.4.1、contrib-1.4.1和STM32F4x7_ETH_LwIP_V1.1.0，以及一个移植好UCOS的工程。其中lwip文件夹是关于以太网协议的实现，contrib是以太网顶层应用层的实现，STM32F4x7_ETH_LwIP文件是官方驱动实现，最后UCOS的工程移植不介绍，具体见下链接：<br> <a href="https://blog.csdn.net/weixin_44567668/article/details/131056991">https://blog.csdn.net/weixin_44567668/article/details/131056991</a><br> 所需文件下载见下：<br> <a href="https://download.csdn.net/download/weixin_44567668/87919549">https://download.csdn.net/download/weixin_44567668/87919549</a></p> 
<h3><a id="22__63"></a>2.2 文件移植与工程添加</h3> 
<ol><li> <p>官方驱动移植<br> 将STM32F4x7_ETH_LwIP_V1.1.0\Libraries里的STM32F4x7_ETH_Driver文件夹复制进工程里的FWLIB中<br> <img src="https://images2.imgbox.com/09/85/eS1mikTq_o.png" alt="在这里插入图片描述"></p> </li><li> <p>LWIP文件移植<br> 在工程里新建LWIP文件夹，然后将lwip-1.4.1\src里的文件复制进来，然后在LWIP文件夹里建立arch与apps文件夹<br> <img src="https://images2.imgbox.com/9d/ab/GoKk4d5Z_o.png" alt="在这里插入图片描述"></p> </li><li> <p>arch框架移植<br> 将contrib-1.4.1\contrib-1.4.1\ports\unix文件夹里的cc.h、cpu.h、lwipopts.h、perf.h、sys_arch.c、sys_arch.h这6个文件复制进上面新建的arch文件夹里<br> <img src="https://images2.imgbox.com/c9/ed/O1RCrZ3q_o.png" alt="在这里插入图片描述"></p> </li><li> <p>在keil工程里添加，结果如下<br> <img src="https://images2.imgbox.com/d4/5d/PCG6rTpq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/17/6f/0drM9xuA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/74/20/RaKI7icB_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c7/ff/Os7pR2Xb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/12/f2/mX7UszcT_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="23__81"></a>2.3 修改以太网驱动</h3> 
<h4><a id="231_stm32f4x7_eth_confh_82"></a>2.3.1 stm32f4x7_eth_conf.h修改</h4> 
<p>  将stm32f4x7_eth_conf_template.h重命名为stm32f4x7_eth_conf.h，里面定义了一些关于操作 PHY 芯片的信息，根据 LAN8720 做一定的修改</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__STM32F4x7_ETH_CONF_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__STM32F4x7_ETH_CONF_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f4xx.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">USE_ENHANCED_DMA_DESCRIPTORS</span></span>

<span class="token comment">//如果使用自己定义的延时函数的话就注销掉下面一行代码，否则使用</span>
<span class="token comment">//默认的低精度延时函数</span>

<span class="token comment">//#define USE_Delay    	//使用默认延时函数，因此注销掉</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_Delay</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span>               </span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_eth_delay_</span>    <span class="token expression">Delay     </span><span class="token comment">//Delay为用户自己提供的高精度延时函数</span></span>
                                    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_eth_delay_</span>    <span class="token expression">ETH_Delay </span><span class="token comment">//默认的_eth_delay功能函数延时精度差</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">CUSTOM_DRIVER_BUFFERS_CONFIG</span></span>
	<span class="token comment">//重新定义以太网接收和发送缓冲区的大小和数量</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ETH_RX_BUF_SIZE</span>    <span class="token expression">ETH_MAX_PACKET_SIZE </span><span class="token comment">//接收缓冲区的大小</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ETH_TX_BUF_SIZE</span>    <span class="token expression">ETH_MAX_PACKET_SIZE </span><span class="token comment">//发送缓冲区的大小</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ETH_RXBUFNB</span>        <span class="token expression"><span class="token number">20</span>                  </span><span class="token comment">//接收缓冲区数量</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ETH_TXBUFNB</span>        <span class="token expression"><span class="token number">5</span>                   </span><span class="token comment">//发送缓冲区数量</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">//*******************PHY配置块*******************</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_Delay</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PHY_RESET_DELAY</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x000000FF</span><span class="token punctuation">)</span>  	</span><span class="token comment">//PHY复位延时</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PHY_CONFIG_DELAY</span>   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000FFF</span><span class="token punctuation">)</span> 	</span><span class="token comment">//PHY配置延时</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ETH_REG_WRITE_DELAY</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00000001</span><span class="token punctuation">)</span>	</span><span class="token comment">//向以太网寄存器写数据时的延时</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PHY_RESET_DELAY</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x000FFFFF</span><span class="token punctuation">)</span>	</span><span class="token comment">//PHY复位延时</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PHY_CONFIG_DELAY</span>   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00FFFFFF</span><span class="token punctuation">)</span>	</span><span class="token comment">//PHY配置延时</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ETH_REG_WRITE_DELAY</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x0000FFFF</span><span class="token punctuation">)</span>	</span><span class="token comment">//向以太网寄存器写数据时的延时</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">//LAN8720 PHY芯片的状态寄存器</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PHY_SR</span>				<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token number">31</span><span class="token punctuation">)</span> 		</span><span class="token comment">//LAN8720的PHY状态寄存器地址</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PHY_SPEED_STATUS</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token number">0x0004</span><span class="token punctuation">)</span> 	</span><span class="token comment">//LAN8720 PHY速度值掩码</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PHY_DUPLEX_STATUS</span>   <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token number">0x00010</span><span class="token punctuation">)</span> </span><span class="token comment">//LAN8720 PHY连接状态值掩码  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
</code></pre> 
<h4><a id="232__stm32f4x7_ethc__129"></a>2.3.2 修改 stm32f4x7_eth.c 文件</h4> 
<p>将下面四个数组：Rx_Buff[]、Tx_Buff[]、DMARxDscrTab[]和 DMATxDscrTab[]屏蔽，这四个数组占用了大量的 RAM，后面采用动态内存分配</p> 
<pre><code class="prism language-c"><span class="token comment">//#if defined   (__CC_ARM) /*!&lt; ARM Compiler */</span>
<span class="token comment">//__align(4) </span>
<span class="token comment">//ETH_DMADESCTypeDef  DMARxDscrTab[ETH_RXBUFNB];/* Ethernet Rx MA Descriptor */</span>
<span class="token comment">//__align(4) </span>
<span class="token comment">//ETH_DMADESCTypeDef  DMATxDscrTab[ETH_TXBUFNB];/* Ethernet Tx DMA Descriptor */</span>
<span class="token comment">//__align(4) </span>
<span class="token comment">//uint8_t Rx_Buff[ETH_RXBUFNB][ETH_RX_BUF_SIZE]; /* Ethernet Receive Buffer */</span>
<span class="token comment">//__align(4) </span>
<span class="token comment">//uint8_t Tx_Buff[ETH_TXBUFNB][ETH_TX_BUF_SIZE]; /* Ethernet Transmit Buffer */</span>

<span class="token comment">//#elif defined ( __ICCARM__ ) /*!&lt; IAR Compiler */</span>
<span class="token comment">//#pragma data_alignment=4</span>
<span class="token comment">//ETH_DMADESCTypeDef  DMARxDscrTab[ETH_RXBUFNB];/* Ethernet Rx MA Descriptor */</span>
<span class="token comment">//#pragma data_alignment=4</span>
<span class="token comment">//ETH_DMADESCTypeDef  DMATxDscrTab[ETH_TXBUFNB];/* Ethernet Tx DMA Descriptor */</span>
<span class="token comment">//#pragma data_alignment=4</span>
<span class="token comment">//uint8_t Rx_Buff[ETH_RXBUFNB][ETH_RX_BUF_SIZE]; /* Ethernet Receive Buffer */</span>
<span class="token comment">//#pragma data_alignment=4</span>
<span class="token comment">//uint8_t Tx_Buff[ETH_TXBUFNB][ETH_TX_BUF_SIZE]; /* Ethernet Transmit Buffer */</span>

<span class="token comment">//#elif defined (__GNUC__) /*!&lt; GNU Compiler */</span>
<span class="token comment">//ETH_DMADESCTypeDef  DMARxDscrTab[ETH_RXBUFNB] __attribute__ ((aligned (4))); /* Ethernet Rx DMA Descriptor */</span>
<span class="token comment">//ETH_DMADESCTypeDef  DMATxDscrTab[ETH_TXBUFNB] __attribute__ ((aligned (4))); /* Ethernet Tx DMA Descriptor */</span>
<span class="token comment">//uint8_t Rx_Buff[ETH_RXBUFNB][ETH_RX_BUF_SIZE] __attribute__ ((aligned (4))); /* Ethernet Receive Buffer */</span>
<span class="token comment">//uint8_t Tx_Buff[ETH_TXBUFNB][ETH_TX_BUF_SIZE] __attribute__ ((aligned (4))); /* Ethernet Transmit Buffer */</span>

<span class="token comment">//#elif defined  (__TASKING__) /*!&lt; TASKING Compiler */</span>
<span class="token comment">//__align(4) </span>
<span class="token comment">//ETH_DMADESCTypeDef  DMARxDscrTab[ETH_RXBUFNB];/* Ethernet Rx MA Descriptor */</span>
<span class="token comment">//__align(4) </span>
<span class="token comment">//ETH_DMADESCTypeDef  DMATxDscrTab[ETH_TXBUFNB];/* Ethernet Tx DMA Descriptor */</span>
<span class="token comment">//__align(4) </span>
<span class="token comment">//uint8_t Rx_Buff[ETH_RXBUFNB][ETH_RX_BUF_SIZE]; /* Ethernet Receive Buffer */</span>
<span class="token comment">//__align(4) </span>
<span class="token comment">//uint8_t Tx_Buff[ETH_TXBUFNB][ETH_TX_BUF_SIZE]; /* Ethernet Transmit Buffer */</span>

<span class="token comment">//#endif /* __CC_ARM */</span>
</code></pre> 
<h4><a id="233__LAN8720__MAC_DMA__172"></a>2.3.3 添加 LAN8720 和 MAC /DMA 驱动</h4> 
<ol><li>lan8720.h头文件</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__LAN8720_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__LAN8720_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f4x7_eth.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LAN8720_PHY_ADDRESS</span>  	<span class="token expression"><span class="token number">0x00</span>				</span><span class="token comment">//LAN8720 PHY芯片地址.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LAN8720_RST</span> 		   	<span class="token expression"><span class="token function">PDout</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> 			</span><span class="token comment">//LAN8720复位引脚	 </span></span>

<span class="token keyword">extern</span> ETH_DMADESCTypeDef <span class="token operator">*</span>DMARxDscrTab<span class="token punctuation">;</span>			<span class="token comment">//以太网DMA接收描述符数据结构体指针</span>
<span class="token keyword">extern</span> ETH_DMADESCTypeDef <span class="token operator">*</span>DMATxDscrTab<span class="token punctuation">;</span>			<span class="token comment">//以太网DMA发送描述符数据结构体指针 </span>
<span class="token keyword">extern</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>Rx_Buff<span class="token punctuation">;</span> 							<span class="token comment">//以太网底层驱动接收buffers指针 </span>
<span class="token keyword">extern</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>Tx_Buff<span class="token punctuation">;</span> 							<span class="token comment">//以太网底层驱动发送buffers指针</span>
<span class="token keyword">extern</span> ETH_DMADESCTypeDef  <span class="token operator">*</span>DMATxDescToSet<span class="token punctuation">;</span>			<span class="token comment">//DMA发送描述符追踪指针</span>
<span class="token keyword">extern</span> ETH_DMADESCTypeDef  <span class="token operator">*</span>DMARxDescToGet<span class="token punctuation">;</span> 		<span class="token comment">//DMA接收描述符追踪指针 </span>
<span class="token keyword">extern</span> ETH_DMA_Rx_Frame_infos <span class="token operator">*</span>DMA_RX_FRAME_infos<span class="token punctuation">;</span>	<span class="token comment">//DMA最后接收到的帧信息指针</span>

u8 <span class="token function">LAN8720_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">LAN8720_Get_Speed</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">ETH_MACDMA_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
FrameTypeDef <span class="token function">ETH_Rx_Packet</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">ETH_Tx_Packet</span><span class="token punctuation">(</span>u16 FrameLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
u32 <span class="token function">ETH_GetCurrentTxBuffer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">ETH_Mem_Malloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">ETH_Mem_Free</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
</code></pre> 
<ol start="2"><li>lan8720.c文件</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lan8720.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f4x7_eth.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"malloc.h"</span> </span>


ETH_DMADESCTypeDef <span class="token operator">*</span>DMARxDscrTab<span class="token punctuation">;</span>	<span class="token comment">//以太网DMA接收描述符数据结构体指针</span>
ETH_DMADESCTypeDef <span class="token operator">*</span>DMATxDscrTab<span class="token punctuation">;</span>	<span class="token comment">//以太网DMA发送描述符数据结构体指针 </span>
<span class="token class-name">uint8_t</span> <span class="token operator">*</span>Rx_Buff<span class="token punctuation">;</span> 					<span class="token comment">//以太网底层驱动接收buffers指针 </span>
<span class="token class-name">uint8_t</span> <span class="token operator">*</span>Tx_Buff<span class="token punctuation">;</span> 					<span class="token comment">//以太网底层驱动发送buffers指针</span>
  
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ETHERNET_NVICConfiguration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//LAN8720初始化</span>
<span class="token comment">//返回值:0,成功;</span>
<span class="token comment">//    其他,失败</span>
u8 <span class="token function">LAN8720_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 rval<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
  
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOA<span class="token operator">|</span>RCC_AHB1Periph_GPIOC<span class="token operator">|</span>RCC_AHB1Periph_GPIOG<span class="token operator">|</span>RCC_AHB1Periph_GPIOD<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使能GPIO时钟 RMII接口</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_SYSCFG<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//使能SYSCFG时钟</span>
  
	<span class="token function">SYSCFG_ETH_MediaInterfaceConfig</span><span class="token punctuation">(</span>SYSCFG_ETH_MediaInterface_RMII<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//MAC和PHY之间使用RMII接口</span>

	<span class="token comment">/*网络引脚设置 RMII接口
	  ETH_MDIO -------------------------&gt; PA2
	  ETH_MDC --------------------------&gt; PC1
	  ETH_RMII_REF_CLK------------------&gt; PA1
	  ETH_RMII_CRS_DV ------------------&gt; PA7
	  ETH_RMII_RXD0 --------------------&gt; PC4
	  ETH_RMII_RXD1 --------------------&gt; PC5
	  ETH_RMII_TX_EN -------------------&gt; PG11
	  ETH_RMII_TXD0 --------------------&gt; PG13
	  ETH_RMII_TXD1 --------------------&gt; PG14
	  ETH_RESET-------------------------&gt; PD3*/</span>
					
	  <span class="token comment">//配置PA1 PA2 PA7</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_1<span class="token operator">|</span>GPIO_Pin_2<span class="token operator">|</span>GPIO_Pin_7<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_100MHz<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_NOPULL <span class="token punctuation">;</span>  
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PinSource1<span class="token punctuation">,</span> GPIO_AF_ETH<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//引脚复用到网络接口上</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PinSource2<span class="token punctuation">,</span> GPIO_AF_ETH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PinSource7<span class="token punctuation">,</span> GPIO_AF_ETH<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//配置PC1,PC4 and PC5</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_1 <span class="token operator">|</span> GPIO_Pin_4 <span class="token operator">|</span> GPIO_Pin_5<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> GPIO_PinSource1<span class="token punctuation">,</span> GPIO_AF_ETH<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//引脚复用到网络接口上</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> GPIO_PinSource4<span class="token punctuation">,</span> GPIO_AF_ETH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> GPIO_PinSource5<span class="token punctuation">,</span> GPIO_AF_ETH<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                
	<span class="token comment">//配置PG11, PG14 and PG13 </span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>  GPIO_Pin_11 <span class="token operator">|</span> GPIO_Pin_13 <span class="token operator">|</span> GPIO_Pin_14<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOG<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOG<span class="token punctuation">,</span> GPIO_PinSource11<span class="token punctuation">,</span> GPIO_AF_ETH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOG<span class="token punctuation">,</span> GPIO_PinSource13<span class="token punctuation">,</span> GPIO_AF_ETH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOG<span class="token punctuation">,</span> GPIO_PinSource14<span class="token punctuation">,</span> GPIO_AF_ETH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//配置PD3为推完输出</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_3<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_100MHz<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>	<span class="token comment">//推完输出</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_NOPULL <span class="token punctuation">;</span>  
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	LAN8720_RST<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>					<span class="token comment">//硬件复位LAN8720</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	LAN8720_RST<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>				 	<span class="token comment">//复位结束 </span>
	<span class="token function">ETHERNET_NVICConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置中断优先级</span>
	rval<span class="token operator">=</span><span class="token function">ETH_MACDMA_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//配置MAC及DMA</span>
	<span class="token keyword">return</span> <span class="token operator">!</span>rval<span class="token punctuation">;</span>					<span class="token comment">//ETH的规则为:0,失败;1,成功;所以要取反一下 </span>
<span class="token punctuation">}</span>

<span class="token comment">//以太网中断分组配置</span>
<span class="token keyword">void</span> <span class="token function">ETHERNET_NVICConfiguration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>
	
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> ETH_IRQn<span class="token punctuation">;</span>  <span class="token comment">//以太网中断</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">0X00</span><span class="token punctuation">;</span>  <span class="token comment">//中断寄存器组2最高优先级</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0X00</span><span class="token punctuation">;</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//得到8720的速度模式</span>
<span class="token comment">//返回值:</span>
<span class="token comment">//001:10M半双工</span>
<span class="token comment">//101:10M全双工</span>
<span class="token comment">//010:100M半双工</span>
<span class="token comment">//110:100M全双工</span>
<span class="token comment">//其他:错误.</span>
u8 <span class="token function">LAN8720_Get_Speed</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 speed<span class="token punctuation">;</span>
	speed<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ETH_ReadPHYRegister</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x1C</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从LAN8720的31号寄存器中读取网络速度和双工模式</span>
	<span class="token keyword">return</span> speed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/</span>
<span class="token comment">//以下部分为STM32F407网卡配置/接口函数.</span>

<span class="token comment">//初始化ETH MAC层及DMA配置</span>
<span class="token comment">//返回值:ETH_ERROR,发送失败(0)</span>
<span class="token comment">//		ETH_SUCCESS,发送成功(1)</span>
u8 <span class="token function">ETH_MACDMA_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 rval<span class="token punctuation">;</span>
	ETH_InitTypeDef ETH_InitStructure<span class="token punctuation">;</span> 
	
	<span class="token comment">//使能以太网MAC以及MAC接收和发送时钟</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_ETH_MAC <span class="token operator">|</span> RCC_AHB1Periph_ETH_MAC_Tx <span class="token operator">|</span>RCC_AHB1Periph_ETH_MAC_Rx<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        
	<span class="token function">ETH_DeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  								<span class="token comment">//AHB总线重启以太网</span>
	<span class="token function">ETH_SoftwareReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  						<span class="token comment">//软件重启网络</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">ETH_GetSoftwareResetStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待软件重启网络完成 </span>
	<span class="token function">ETH_StructInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ETH_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span> 	 	<span class="token comment">//初始化网络为默认值  </span>

	<span class="token comment">///网络MAC参数设置 </span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_AutoNegotiation <span class="token operator">=</span> ETH_AutoNegotiation_Enable<span class="token punctuation">;</span>   			<span class="token comment">//开启网络自适应功能</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_LoopbackMode <span class="token operator">=</span> ETH_LoopbackMode_Disable<span class="token punctuation">;</span>					<span class="token comment">//关闭反馈</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_RetryTransmission <span class="token operator">=</span> ETH_RetryTransmission_Disable<span class="token punctuation">;</span> 		<span class="token comment">//关闭重传功能</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_AutomaticPadCRCStrip <span class="token operator">=</span> ETH_AutomaticPadCRCStrip_Disable<span class="token punctuation">;</span> 	<span class="token comment">//关闭自动去除PDA/CRC功能 </span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_ReceiveAll <span class="token operator">=</span> ETH_ReceiveAll_Disable<span class="token punctuation">;</span>						<span class="token comment">//关闭接收所有的帧</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_BroadcastFramesReception <span class="token operator">=</span> ETH_BroadcastFramesReception_Enable<span class="token punctuation">;</span><span class="token comment">//允许接收所有广播帧</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_PromiscuousMode <span class="token operator">=</span> ETH_PromiscuousMode_Disable<span class="token punctuation">;</span>			<span class="token comment">//关闭混合模式的地址过滤  </span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_MulticastFramesFilter <span class="token operator">=</span> ETH_MulticastFramesFilter_Perfect<span class="token punctuation">;</span><span class="token comment">//对于组播地址使用完美地址过滤   </span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_UnicastFramesFilter <span class="token operator">=</span> ETH_UnicastFramesFilter_Perfect<span class="token punctuation">;</span>	<span class="token comment">//对单播地址使用完美地址过滤 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CHECKSUM_BY_HARDWARE</span></span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_ChecksumOffload <span class="token operator">=</span> ETH_ChecksumOffload_Enable<span class="token punctuation">;</span> 			<span class="token comment">//开启ipv4和TCP/UDP/ICMP的帧校验和卸载   </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">//当我们使用帧校验和卸载功能的时候，一定要使能存储转发模式,存储转发模式中要保证整个帧存储在FIFO中,</span>
	<span class="token comment">//这样MAC能插入/识别出帧校验值,当真校验正确的时候DMA就可以处理帧,否则就丢弃掉该帧</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_DropTCPIPChecksumErrorFrame <span class="token operator">=</span> ETH_DropTCPIPChecksumErrorFrame_Enable<span class="token punctuation">;</span> <span class="token comment">//开启丢弃TCP/IP错误帧</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_ReceiveStoreForward <span class="token operator">=</span> ETH_ReceiveStoreForward_Enable<span class="token punctuation">;</span>     <span class="token comment">//开启接收数据的存储转发模式    </span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_TransmitStoreForward <span class="token operator">=</span> ETH_TransmitStoreForward_Enable<span class="token punctuation">;</span>   <span class="token comment">//开启发送数据的存储转发模式  </span>

	ETH_InitStructure<span class="token punctuation">.</span>ETH_ForwardErrorFrames <span class="token operator">=</span> ETH_ForwardErrorFrames_Disable<span class="token punctuation">;</span>     	<span class="token comment">//禁止转发错误帧  </span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_ForwardUndersizedGoodFrames <span class="token operator">=</span> ETH_ForwardUndersizedGoodFrames_Disable<span class="token punctuation">;</span>	<span class="token comment">//不转发过小的好帧 </span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_SecondFrameOperate <span class="token operator">=</span> ETH_SecondFrameOperate_Enable<span class="token punctuation">;</span>  		<span class="token comment">//打开处理第二帧功能</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_AddressAlignedBeats <span class="token operator">=</span> ETH_AddressAlignedBeats_Enable<span class="token punctuation">;</span>  	<span class="token comment">//开启DMA传输的地址对齐功能</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_FixedBurst <span class="token operator">=</span> ETH_FixedBurst_Enable<span class="token punctuation">;</span>            			<span class="token comment">//开启固定突发功能    </span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_RxDMABurstLength <span class="token operator">=</span> ETH_RxDMABurstLength_32Beat<span class="token punctuation">;</span>     		<span class="token comment">//DMA发送的最大突发长度为32个节拍   </span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_TxDMABurstLength <span class="token operator">=</span> ETH_TxDMABurstLength_32Beat<span class="token punctuation">;</span>			<span class="token comment">//DMA接收的最大突发长度为32个节拍</span>
	ETH_InitStructure<span class="token punctuation">.</span>ETH_DMAArbitration <span class="token operator">=</span> ETH_DMAArbitration_RoundRobin_RxTx_2_1<span class="token punctuation">;</span>
	rval<span class="token operator">=</span><span class="token function">ETH_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ETH_InitStructure<span class="token punctuation">,</span>LAN8720_PHY_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//配置ETH</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>rval<span class="token operator">==</span>ETH_SUCCESS<span class="token punctuation">)</span><span class="token comment">//配置成功</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">ETH_DMAITConfig</span><span class="token punctuation">(</span>ETH_DMA_IT_NIS<span class="token operator">|</span>ETH_DMA_IT_R<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>  	<span class="token comment">//使能以太网接收中断	</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> rval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">lwip_pkt_handle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//在lwip_comm.c里面定义</span>
<span class="token comment">//以太网DMA接收中断服务函数</span>
<span class="token keyword">void</span> <span class="token function">ETH_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">ETH_GetRxPktSize</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 	<span class="token comment">//检测是否收到数据包</span>
	<span class="token punctuation">{<!-- --></span> 
		<span class="token function">lwip_pkt_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token punctuation">}</span>
	<span class="token function">ETH_DMAClearITPendingBit</span><span class="token punctuation">(</span>ETH_DMA_IT_R<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//清除DMA中断标志位</span>
	<span class="token function">ETH_DMAClearITPendingBit</span><span class="token punctuation">(</span>ETH_DMA_IT_NIS<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清除DMA接收中断标志位</span>
<span class="token punctuation">}</span>  
<span class="token comment">//接收一个网卡数据包</span>
<span class="token comment">//返回值:网络数据包帧结构体</span>
FrameTypeDef <span class="token function">ETH_Rx_Packet</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
	u32 framelength<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	FrameTypeDef frame<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>   
	<span class="token comment">//检查当前描述符,是否属于ETHERNET DMA(设置的时候)/CPU(复位的时候)</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status<span class="token operator">&amp;</span>ETH_DMARxDesc_OWN<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>	
		frame<span class="token punctuation">.</span>length<span class="token operator">=</span>ETH_ERROR<span class="token punctuation">;</span> 
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ETH<span class="token operator">-&gt;</span>DMASR<span class="token operator">&amp;</span>ETH_DMASR_RBUS<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span>  
		<span class="token punctuation">{<!-- --></span> 
			ETH<span class="token operator">-&gt;</span>DMASR <span class="token operator">=</span> ETH_DMASR_RBUS<span class="token punctuation">;</span><span class="token comment">//清除ETH DMA的RBUS位 </span>
			ETH<span class="token operator">-&gt;</span>DMARPDR<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//恢复DMA接收</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> frame<span class="token punctuation">;</span><span class="token comment">//错误,OWN位被设置了</span>
	<span class="token punctuation">}</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status<span class="token operator">&amp;</span>ETH_DMARxDesc_ES<span class="token punctuation">)</span><span class="token operator">==</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span> 
	<span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_LS<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>  
	<span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_FS<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token punctuation">)</span>  
	<span class="token punctuation">{<!-- --></span>       
		framelength<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status<span class="token operator">&amp;</span>ETH_DMARxDesc_FL<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span>ETH_DMARxDesc_FrameLengthShift<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//得到接收包帧长度(不包含4字节CRC)</span>
 		frame<span class="token punctuation">.</span>buffer <span class="token operator">=</span> DMARxDescToGet<span class="token operator">-&gt;</span>Buffer1Addr<span class="token punctuation">;</span><span class="token comment">//得到包数据所在的位置</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> framelength<span class="token operator">=</span>ETH_ERROR<span class="token punctuation">;</span><span class="token comment">//错误  </span>
	frame<span class="token punctuation">.</span>length<span class="token operator">=</span>framelength<span class="token punctuation">;</span> 
	frame<span class="token punctuation">.</span>descriptor<span class="token operator">=</span>DMARxDescToGet<span class="token punctuation">;</span>  
	<span class="token comment">//更新ETH DMA全局Rx描述符为下一个Rx描述符</span>
	<span class="token comment">//为下一次buffer读取设置下一个DMA Rx描述符</span>
	DMARxDescToGet<span class="token operator">=</span><span class="token punctuation">(</span>ETH_DMADESCTypeDef<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Buffer2NextDescAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token keyword">return</span> frame<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
<span class="token comment">//发送一个网卡数据包</span>
<span class="token comment">//FrameLength:数据包长度</span>
<span class="token comment">//返回值:ETH_ERROR,发送失败(0)</span>
<span class="token comment">//		ETH_SUCCESS,发送成功(1)</span>
u8 <span class="token function">ETH_Tx_Packet</span><span class="token punctuation">(</span>u16 FrameLength<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>   
	<span class="token comment">//检查当前描述符,是否属于ETHERNET DMA(设置的时候)/CPU(复位的时候)</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMATxDescToSet<span class="token operator">-&gt;</span>Status<span class="token operator">&amp;</span>ETH_DMATxDesc_OWN<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token keyword">return</span> ETH_ERROR<span class="token punctuation">;</span><span class="token comment">//错误,OWN位被设置了 </span>
 	DMATxDescToSet<span class="token operator">-&gt;</span>ControlBufferSize<span class="token operator">=</span><span class="token punctuation">(</span>FrameLength<span class="token operator">&amp;</span>ETH_DMATxDesc_TBS1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置帧长度,bits[12:0]</span>
	DMATxDescToSet<span class="token operator">-&gt;</span>Status<span class="token operator">|=</span>ETH_DMATxDesc_LS<span class="token operator">|</span>ETH_DMATxDesc_FS<span class="token punctuation">;</span><span class="token comment">//设置最后一个和第一个位段置位(1个描述符传输一帧)</span>
  	DMATxDescToSet<span class="token operator">-&gt;</span>Status<span class="token operator">|=</span>ETH_DMATxDesc_OWN<span class="token punctuation">;</span><span class="token comment">//设置Tx描述符的OWN位,buffer重归ETH DMA</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ETH<span class="token operator">-&gt;</span>DMASR<span class="token operator">&amp;</span>ETH_DMASR_TBUS<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token comment">//当Tx Buffer不可用位(TBUS)被设置的时候,重置它.恢复传输</span>
	<span class="token punctuation">{<!-- --></span> 
		ETH<span class="token operator">-&gt;</span>DMASR<span class="token operator">=</span>ETH_DMASR_TBUS<span class="token punctuation">;</span><span class="token comment">//重置ETH DMA TBUS位 </span>
		ETH<span class="token operator">-&gt;</span>DMATPDR<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//恢复DMA发送</span>
	<span class="token punctuation">}</span> 
	<span class="token comment">//更新ETH DMA全局Tx描述符为下一个Tx描述符</span>
	<span class="token comment">//为下一次buffer发送设置下一个DMA Tx描述符 </span>
	DMATxDescToSet<span class="token operator">=</span><span class="token punctuation">(</span>ETH_DMADESCTypeDef<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DMATxDescToSet<span class="token operator">-&gt;</span>Buffer2NextDescAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token keyword">return</span> ETH_SUCCESS<span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
<span class="token comment">//得到当前描述符的Tx buffer地址</span>
<span class="token comment">//返回值:Tx buffer地址</span>
u32 <span class="token function">ETH_GetCurrentTxBuffer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
  <span class="token keyword">return</span> DMATxDescToSet<span class="token operator">-&gt;</span>Buffer1Addr<span class="token punctuation">;</span><span class="token comment">//返回Tx buffer地址  </span>
<span class="token punctuation">}</span>

<span class="token comment">//为ETH底层驱动申请内存</span>
<span class="token comment">//返回值:0,正常</span>
<span class="token comment">//    其他,失败</span>
u8 <span class="token function">ETH_Mem_Malloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
	DMARxDscrTab<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>ETH_RXBUFNB<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ETH_DMADESCTypeDef<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//申请内存</span>
	DMATxDscrTab<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>ETH_TXBUFNB<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ETH_DMADESCTypeDef<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//申请内存  </span>
	Rx_Buff<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>ETH_RX_BUF_SIZE<span class="token operator">*</span>ETH_RXBUFNB<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//申请内存</span>
	Tx_Buff<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>ETH_TX_BUF_SIZE<span class="token operator">*</span>ETH_TXBUFNB<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//申请内存</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>DMARxDscrTab<span class="token operator">||</span><span class="token operator">!</span>DMATxDscrTab<span class="token operator">||</span><span class="token operator">!</span>Rx_Buff<span class="token operator">||</span><span class="token operator">!</span>Tx_Buff<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">ETH_Mem_Free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//申请失败</span>
	<span class="token punctuation">}</span>	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//申请成功</span>
<span class="token punctuation">}</span>

<span class="token comment">//释放ETH 底层驱动申请的内存</span>
<span class="token keyword">void</span> <span class="token function">ETH_Mem_Free</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
	<span class="token function">myfree</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>DMARxDscrTab<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放内存</span>
	<span class="token function">myfree</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>DMATxDscrTab<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放内存</span>
	<span class="token function">myfree</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>Rx_Buff<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//释放内存</span>
	<span class="token function">myfree</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>Tx_Buff<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//释放内存  </span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="24_LwIP_462"></a>2.4 LwIP的网络接口修改</h3> 
<h4><a id="241_ethernetifh_463"></a>2.4.1 添加ethernetif.h文件</h4> 
<p>  将STM32F4x7_ETH_LwIP_V1.1.0\Utilities\Third_Party\lwip-1.4.1\port\STM32F4x7\Standalone里的ethernetif.h添加到我们的LWIP移植\LWIP\include\netif里<br> <img src="https://images2.imgbox.com/65/a7/n3vmIioC_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="242_ethernetifc_467"></a>2.4.2 修改ethernetif.c文件</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"netif/ethernetif.h"</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lan8720.h"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip_comm.h"</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"netif/etharp.h"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span>  </span>

<span class="token comment">//由ethernetif_init()调用用于初始化硬件</span>
<span class="token comment">//netif:网卡结构体指针 </span>
<span class="token comment">//返回值:ERR_OK,正常</span>
<span class="token comment">//       其他,失败</span>
<span class="token keyword">static</span> <span class="token class-name">err_t</span> <span class="token function">low_level_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CHECKSUM_BY_HARDWARE</span></span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span> 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
	netif<span class="token operator">-&gt;</span>hwaddr_len <span class="token operator">=</span> ETHARP_HWADDR_LEN<span class="token punctuation">;</span> <span class="token comment">//设置MAC地址长度,为6个字节</span>
	<span class="token comment">//初始化MAC地址,设置什么地址由用户自己设置,但是不能与网络中其他设备MAC地址重复</span>
	netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
	netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
	netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	netif<span class="token operator">-&gt;</span>mtu<span class="token operator">=</span><span class="token number">1500</span><span class="token punctuation">;</span> <span class="token comment">//最大允许传输单元,允许该网卡广播和ARP功能</span>
	<span class="token comment">//并且该网卡允许有硬件链路连接</span>
	netif<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> NETIF_FLAG_BROADCAST<span class="token operator">|</span>NETIF_FLAG_ETHARP<span class="token operator">|</span>NETIF_FLAG_LINK_UP<span class="token punctuation">;</span>
	
	<span class="token function">ETH_MACAddressConfig</span><span class="token punctuation">(</span>ETH_MAC_Address0<span class="token punctuation">,</span> netif<span class="token operator">-&gt;</span>hwaddr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//向STM32F4的MAC地址寄存器中写入MAC地址</span>
	<span class="token function">ETH_DMATxDescChainInit</span><span class="token punctuation">(</span>DMATxDscrTab<span class="token punctuation">,</span> Tx_Buff<span class="token punctuation">,</span> ETH_TXBUFNB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ETH_DMARxDescChainInit</span><span class="token punctuation">(</span>DMARxDscrTab<span class="token punctuation">,</span> Rx_Buff<span class="token punctuation">,</span> ETH_RXBUFNB<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CHECKSUM_BY_HARDWARE 	</span><span class="token comment">//使用硬件帧校验</span></span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>ETH_TXBUFNB<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//使能TCP,UDP和ICMP的发送帧校验,TCP,UDP和ICMP的接收帧校验在DMA中配置了</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">ETH_DMATxDescChecksumInsertionConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DMATxDscrTab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> ETH_DMATxDesc_ChecksumTCPUDPICMPFull<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">ETH_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开启MAC和DMA				</span>
	<span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//用于发送数据包的最底层函数(lwip通过netif-&gt;linkoutput指向该函数)</span>
<span class="token comment">//netif:网卡结构体指针</span>
<span class="token comment">//p:pbuf数据结构体指针</span>
<span class="token comment">//返回值:ERR_OK,发送正常</span>
<span class="token comment">//       ERR_MEM,发送失败</span>
<span class="token keyword">static</span> <span class="token class-name">err_t</span> <span class="token function">low_level_output</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 res<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
	<span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	u8 <span class="token operator">*</span>buffer<span class="token operator">=</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ETH_GetCurrentTxBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">for</span><span class="token punctuation">(</span>q<span class="token operator">=</span>p<span class="token punctuation">;</span>q<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>q<span class="token operator">=</span>q<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">,</span> q<span class="token operator">-&gt;</span>payload<span class="token punctuation">,</span> q<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		l<span class="token operator">=</span>l<span class="token operator">+</span>q<span class="token operator">-&gt;</span>len<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> 
	res<span class="token operator">=</span><span class="token function">ETH_Tx_Packet</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">==</span>ETH_ERROR<span class="token punctuation">)</span><span class="token keyword">return</span> ERR_MEM<span class="token punctuation">;</span><span class="token comment">//返回错误状态</span>
	<span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//用于接收数据包的最底层函数</span>
<span class="token comment">//neitif:网卡结构体指针</span>
<span class="token comment">//返回值:pbuf数据结构体指针</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span> <span class="token function">low_level_input</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
	<span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
	<span class="token class-name">u16_t</span> len<span class="token punctuation">;</span>
	<span class="token keyword">int</span> l <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	FrameTypeDef frame<span class="token punctuation">;</span>
	u8 <span class="token operator">*</span>buffer<span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	frame<span class="token operator">=</span><span class="token function">ETH_Rx_Packet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	len<span class="token operator">=</span>frame<span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token comment">//得到包大小</span>
	buffer<span class="token operator">=</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>frame<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span><span class="token comment">//得到包数据地址 </span>
	p<span class="token operator">=</span><span class="token function">pbuf_alloc</span><span class="token punctuation">(</span>PBUF_RAW<span class="token punctuation">,</span>len<span class="token punctuation">,</span>PBUF_POOL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//pbufs内存池分配pbuf</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>q<span class="token operator">=</span>p<span class="token punctuation">;</span>q<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>q<span class="token operator">=</span>q<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>q<span class="token operator">-&gt;</span>payload<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">,</span> q<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
			l<span class="token operator">=</span>l<span class="token operator">+</span>q<span class="token operator">-&gt;</span>len<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>    
	<span class="token punctuation">}</span>
	frame<span class="token punctuation">.</span>descriptor<span class="token operator">-&gt;</span>Status<span class="token operator">=</span>ETH_DMARxDesc_OWN<span class="token punctuation">;</span><span class="token comment">//设置Rx描述符OWN位,buffer重归ETH DMA </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ETH<span class="token operator">-&gt;</span>DMASR<span class="token operator">&amp;</span>ETH_DMASR_RBUS<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token comment">//当Rx Buffer不可用位(RBUS)被设置的时候,重置它.恢复传输</span>
	<span class="token punctuation">{<!-- --></span> 
		ETH<span class="token operator">-&gt;</span>DMASR<span class="token operator">=</span>ETH_DMASR_RBUS<span class="token punctuation">;</span><span class="token comment">//重置ETH DMA RBUS位 </span>
		ETH<span class="token operator">-&gt;</span>DMARPDR<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//恢复DMA接收</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//网卡接收数据(lwip直接调用)</span>
<span class="token comment">//netif:网卡结构体指针</span>
<span class="token comment">//返回值:ERR_OK,发送正常</span>
<span class="token comment">//       ERR_MEM,发送失败</span>
<span class="token class-name">err_t</span> <span class="token function">ethernetif_input</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">err_t</span> err<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
	p<span class="token operator">=</span><span class="token function">low_level_input</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> ERR_MEM<span class="token punctuation">;</span>
	err<span class="token operator">=</span>netif<span class="token operator">-&gt;</span><span class="token function">input</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span>ERR_OK<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LWIP_DEBUGF</span><span class="token punctuation">(</span>NETIF_DEBUG<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"ethernetif_input: IP input error\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pbuf_free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
		p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> 
	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//使用low_level_init()函数来初始化网络</span>
<span class="token comment">//netif:网卡结构体指针</span>
<span class="token comment">//返回值:ERR_OK,正常</span>
<span class="token comment">//       其他,失败</span>
<span class="token class-name">err_t</span> <span class="token function">ethernetif_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"netif!=NULL"</span><span class="token punctuation">,</span><span class="token punctuation">(</span>netif<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_NETIF_HOSTNAME			</span><span class="token comment">//LWIP_NETIF_HOSTNAME </span></span>
	netif<span class="token operator">-&gt;</span>hostname<span class="token operator">=</span><span class="token string">"lwip"</span><span class="token punctuation">;</span>  	<span class="token comment">//初始化名称</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
	netif<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>IFNAME0<span class="token punctuation">;</span> 	<span class="token comment">//初始化变量netif的name字段</span>
	netif<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>IFNAME1<span class="token punctuation">;</span> 	<span class="token comment">//在文件外定义这里不用关心具体值</span>
	netif<span class="token operator">-&gt;</span>output<span class="token operator">=</span>etharp_output<span class="token punctuation">;</span><span class="token comment">//IP层发送数据包函数</span>
	netif<span class="token operator">-&gt;</span>linkoutput<span class="token operator">=</span>low_level_output<span class="token punctuation">;</span><span class="token comment">//ARP模块发送数据包函数</span>
	<span class="token function">low_level_init</span><span class="token punctuation">(</span>netif<span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//底层硬件初始化函数</span>
	<span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="243_memc__mempc_597"></a>2.4.3 修改mem.c 和 memp.c文件</h4> 
<p><strong>注</strong>：可自行选择内存管理函数<br>    LWIP 有一个内存堆 ram_heap 和内存池 memp_memory，这两个是 LWIP 的内存来源。这两个分别在 mem.c 和 memp.c 中，我们将这两个数组改用 ALIENTEK 的内存分配函数对其进行内存分配。在 mem.c 文件中我们将ram_heap 数组注销掉，定义为指向 u8_t 的指针<br> <img src="https://images2.imgbox.com/84/09/AS7dHfe2_o.png" alt="在这里插入图片描述"><br>    将 memp.c 文件中将 memp_memory 数组屏蔽掉改为指针<br> <img src="https://images2.imgbox.com/6c/9a/5SDRjP0k_o.png" alt="在这里插入图片描述"><br>    在 memp.c 文件中添加 memp_get_memorysize()函数<br> <img src="https://images2.imgbox.com/ab/9a/5S5RnIAV_o.png" alt="在这里插入图片描述"><br>    在 memp.c 文件中添加 memp_get_memorysize()函数</p> 
<pre><code class="prism language-c"><span class="token comment">//得到memp_memory数组大小</span>
u32 <span class="token function">memp_get_memorysize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 length<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	length<span class="token operator">=</span><span class="token punctuation">(</span>
			MEM_ALIGNMENT<span class="token operator">-</span><span class="token number">1</span> <span class="token comment">//全局型数组 为所有POOL分配的内存空间</span>
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LWIP_MEMPOOL</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span>num<span class="token punctuation">,</span>size<span class="token punctuation">,</span>desc<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>MEMP_SIZE<span class="token operator">+</span><span class="token function">MEMP_ALIGN_SIZE</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token comment">//MEMP_SIZE表示需要在每个POOL头部预留的空间  MEMP_SIZE = 0</span></span>
			<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/memp_std.h"</span></span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> length<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="245_icmpc__621"></a>2.4.5 修改icmp.c 文件</h4> 
<p>  修改 icmp.c 文档使其支持硬件帧校验，在195行注释掉上面，添加下面代码</p> 
<pre><code class="prism language-c"><span class="token comment">//#if CHECKSUM_GEN_ICMP</span>
<span class="token comment">//    /* adjust the checksum */</span>
<span class="token comment">//    if (iecho-&gt;chksum &gt;= PP_HTONS(0xffffU - (ICMP_ECHO &lt;&lt; 8))) {<!-- --></span>
<span class="token comment">//      iecho-&gt;chksum += PP_HTONS(ICMP_ECHO &lt;&lt; 8) + 1;</span>
<span class="token comment">//    } else {<!-- --></span>
<span class="token comment">//      iecho-&gt;chksum += PP_HTONS(ICMP_ECHO &lt;&lt; 8);</span>
<span class="token comment">//    }</span>
<span class="token comment">//#else /* CHECKSUM_GEN_ICMP */</span>
<span class="token comment">//    iecho-&gt;chksum = 0;</span>
<span class="token comment">//#endif /* CHECKSUM_GEN_ICMP */</span>
<span class="token comment">/* This part of code has been modified by ST's MCD Application Team */</span>
<span class="token comment">/* To use the Checksum Offload Engine for the putgoing ICMP packets,
   the ICMP checksum field should be set to 0, this is required only for Tx ICMP*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CHECKSUM_BY_HARDWARE</span></span>
    iecho<span class="token operator">-&gt;</span>chksum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token comment">/* adjust the checksum */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iecho<span class="token operator">-&gt;</span>chksum <span class="token operator">&gt;=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">0xffff</span> <span class="token operator">-</span> <span class="token punctuation">(</span>ICMP_ECHO <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      iecho<span class="token operator">-&gt;</span>chksum <span class="token operator">+=</span> <span class="token function">htons</span><span class="token punctuation">(</span>ICMP_ECHO <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      iecho<span class="token operator">-&gt;</span>chksum <span class="token operator">+=</span> <span class="token function">htons</span><span class="token punctuation">(</span>ICMP_ECHO <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h3><a id="25_LWIPUCOS_650"></a>2.5 修改LWIP与UCOS接口文件</h3> 
<h4><a id="251_LWIP_651"></a>2.5.1 修改LWIP源文件名字</h4> 
<ol><li>sys.c 和 sys.h文件名修改<br>   我们按路径：lwip-1.4.1-&gt;src-&gt;core 可以发现在 core 文件下有一个 sys.c 文件，按路径lwip-1.4.1-&gt;src-&gt;include-&gt;lwip 可以发现有一个 sys.h 文件。sys.c 和 sys.h 这两个文件和我们的SYSTEM 文件中的 sys.c 和 sys.h 重名，因此我们将 LWIP 中 sys.c 和 sys.h 改为 lwip_sys.c 和lwip_sys.h，然后在工程中将 LWIP 源码里面的#include “sys.h”代码也要改掉，更改为#include “lwip_sys.h”。</li><li>cpu.h文件名修改<br>   UCOSIII 和 LWIP 中都有个 cpu.h 文件，因此其中的某一个必须改名。这里我们将 LWIP 中的 cpu.h 文件名字修改为 lwip_cpu.h，直接在模板工程中修改。文件路径为：LWIP-&gt;arch-&gt;cpu.h。cpu.h 用来定义 CPU 的大小端模式，因为 STM32 是小端模式<br> <img src="https://images2.imgbox.com/08/cf/uuIrsnPn_o.png" alt="在这里插入图片描述"></li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__CPU_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__CPU_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BYTE_ORDER</span> <span class="token expression">LITTLE_ENDIAN </span><span class="token comment">//小端模式</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h4><a id="252__664"></a>2.5.2 修改头文件</h4> 
<ol><li>修改cc.h文件<br>   在arch文件夹里cc.h主要完成了协议栈内部使用的数据类型的定义。在 LWIP 中支持针对关键代码的保护，比如申请内存等，而我们知道在 UCOS II 有临界区保护，因此我们就可以使用 UCOS II 中的临界区保护函数。在 cc.h 问文件中我们使用了宏定义来实现这一功能</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__CC_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__CC_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"cpu.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"includes.h"</span>  <span class="token comment">//使用UCOS要添加</span></span>

<span class="token comment">/*-------------data type------------------------------------------------------*/</span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span>   <span class="token keyword">char</span>    <span class="token class-name">u8_t</span><span class="token punctuation">;</span>    <span class="token comment">/* Unsigned 8 bit quantity         */</span>
<span class="token keyword">typedef</span> <span class="token keyword">signed</span>     <span class="token keyword">char</span>    <span class="token class-name">s8_t</span><span class="token punctuation">;</span>    <span class="token comment">/* Signed    8 bit quantity        */</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span>   <span class="token keyword">short</span>   <span class="token class-name">u16_t</span><span class="token punctuation">;</span>   <span class="token comment">/* Unsigned 16 bit quantity        */</span>
<span class="token keyword">typedef</span> <span class="token keyword">signed</span>     <span class="token keyword">short</span>   <span class="token class-name">s16_t</span><span class="token punctuation">;</span>   <span class="token comment">/* Signed   16 bit quantity        */</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span>   <span class="token keyword">long</span>    <span class="token class-name">u32_t</span><span class="token punctuation">;</span>   <span class="token comment">/* Unsigned 32 bit quantity        */</span>
<span class="token keyword">typedef</span> <span class="token keyword">signed</span>     <span class="token keyword">long</span>    <span class="token class-name">s32_t</span><span class="token punctuation">;</span>   <span class="token comment">/* Signed   32 bit quantity        */</span>
<span class="token keyword">typedef</span> <span class="token class-name">u32_t</span> <span class="token class-name">mem_ptr_t</span><span class="token punctuation">;</span>            <span class="token comment">/* Unsigned 32 bit quantity        */</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token class-name">sys_prot_t</span><span class="token punctuation">;</span>

<span class="token comment">/*-------------critical region protection (depends on uC/OS-II setting)-------*/</span>
<span class="token comment">//使用操作系统时的临界区保护，这里以 UCOS III 为例</span>
<span class="token comment">//当定义了 OS_CRITICAL_METHOD 时就说明使用了 UCOS III</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CPU_CFG_CRITICAL_METHOD <span class="token operator">==</span> <span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SYS_ARCH_DECL_PROTECT</span><span class="token expression"><span class="token punctuation">(</span>lev<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SYS_ARCH_PROTECT</span><span class="token expression"><span class="token punctuation">(</span>lev<span class="token punctuation">)</span> <span class="token function">CPU_INT_DIS</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SYS_ARCH_UNPROTECT</span><span class="token expression"><span class="token punctuation">(</span>lev<span class="token punctuation">)</span> <span class="token function">CPU_INT_EN</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CPU_CFG_CRITICAL_METHOD <span class="token operator">==</span> <span class="token number">3</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SYS_ARCH_DECL_PROTECT</span><span class="token expression"><span class="token punctuation">(</span>lev<span class="token punctuation">)</span> <span class="token class-name">u32_t</span> lev</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SYS_ARCH_PROTECT</span><span class="token expression"><span class="token punctuation">(</span>lev<span class="token punctuation">)</span> lev <span class="token operator">=</span> <span class="token function">CPU_SR_Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> </span><span class="token comment">//进入临界区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SYS_ARCH_UNPROTECT</span><span class="token expression"><span class="token punctuation">(</span>lev<span class="token punctuation">)</span> <span class="token function">CPU_SR_Restore</span><span class="token punctuation">(</span>lev<span class="token punctuation">)</span> </span><span class="token comment">//退出临界区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*----------------------------------------------------------------------------*/</span>

<span class="token comment">/* define compiler specific symbols */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>__ICCARM__<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_BEGIN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_STRUCT</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_END</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PACK_STRUCT_FIELD</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> x</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_USE_INCLUDES</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>__CC_ARM<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_BEGIN</span> <span class="token expression">__packed</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_STRUCT</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_END</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PACK_STRUCT_FIELD</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> x</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_BEGIN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_STRUCT</span> <span class="token expression"><span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__packed__<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_END</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PACK_STRUCT_FIELD</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> x</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>__TASKING__<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_BEGIN</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_STRUCT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PACK_STRUCT_END</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PACK_STRUCT_FIELD</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> x</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*---define (sn)printf formatters for these lwip types, for lwip DEBUG/STATS--*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">U16_F</span> <span class="token string">"4d"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S16_F</span> <span class="token string">"4d"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">X16_F</span> <span class="token string">"4x"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">U32_F</span> <span class="token string">"8ld"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S32_F</span> <span class="token string">"8ld"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">X32_F</span> <span class="token string">"8lx"</span></span>

<span class="token comment">/*--------------macros--------------------------------------------------------*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LWIP_PLATFORM_ASSERT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LWIP_PLATFORM_ASSERT</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{<!-- --></span>   <span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"Assertion \"%s\" failed at line %d in %s\r\n"</span><span class="token expression"><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LWIP_PLATFORM_DIAG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LWIP_PLATFORM_DIAG</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>printf x<span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __CC_H__ */</span></span>
</code></pre> 
<ol start="2"><li>修改perf.h文件<br>   perf.h是和系统测量与统计相关的文件，我们不使用任何的测量和统计</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__PERF_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__PERF_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PERF_START</span> <span class="token comment">//空定义</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PERF_STOP</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> </span><span class="token comment">//空定义</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h4><a id="253__lwipoptsh_770"></a>2.5.3 修改 lwipopts.h配置文件</h4> 
<p>  lwipopts.h 是用来裁剪和配置 LWIP 的，那么我们要使用操作系统的话就需要对其进行相应的配置</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__LWIPOPTS_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__LWIPOPTS_H__</span></span>

<span class="token comment">//线程优先级</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">TCPIP_THREAD_PRIO</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCPIP_THREAD_PRIO</span>		<span class="token expression"><span class="token number">5</span>	</span><span class="token comment">//定义内核任务的优先级为5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span>  <span class="token expression">DEFAULT_THREAD_PRIO</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_THREAD_PRIO</span>		<span class="token expression"><span class="token number">2</span></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYS_LIGHTWEIGHT_PROT</span>    <span class="token expression"><span class="token number">1</span>		</span><span class="token comment">//为1时使用实时操作系统的轻量级保护,保护关键代码不被中断打断</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NO_SYS</span>                  <span class="token expression"><span class="token number">0</span>  		</span><span class="token comment">//使用UCOS操作系统</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEM_ALIGNMENT</span>           <span class="token expression"><span class="token number">4</span>  		</span><span class="token comment">//使用4字节对齐模式</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEM_SIZE</span>                <span class="token expression"><span class="token number">16000</span> 	</span><span class="token comment">//内存堆heap大小</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEMP_NUM_PBUF</span>           <span class="token expression"><span class="token number">20</span> 		</span><span class="token comment">//MEMP_NUM_PBUF:memp结构的pbuf数量,如果应用从ROM或者静态存储区发送大量数据时,这个值应该设置大一点</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEMP_NUM_UDP_PCB</span>        <span class="token expression"><span class="token number">6</span>		</span><span class="token comment">//MEMP_NUM_UDP_PCB:UDP协议控制块(PCB)数量.每个活动的UDP"连接"需要一个PCB.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEMP_NUM_TCP_PCB</span>        <span class="token expression"><span class="token number">10</span>		</span><span class="token comment">//MEMP_NUM_TCP_PCB:同时建立激活的TCP数量</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEMP_NUM_TCP_PCB_LISTEN</span> <span class="token expression"><span class="token number">6</span>		</span><span class="token comment">//MEMP_NUM_TCP_PCB_LISTEN:能够监听的TCP连接数量</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEMP_NUM_TCP_SEG</span>        <span class="token expression"><span class="token number">15</span>		</span><span class="token comment">//MEMP_NUM_TCP_SEG:最多同时在队列中的TCP段数量</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEMP_NUM_SYS_TIMEOUT</span>    <span class="token expression"><span class="token number">8</span>		</span><span class="token comment">//MEMP_NUM_SYS_TIMEOUT:能够同时激活的timeout个数</span></span>

<span class="token comment">//pbuf选项</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PBUF_POOL_SIZE</span>          <span class="token expression"><span class="token number">20</span>		</span><span class="token comment">//PBUF_POOL_SIZE:pbuf内存池个数</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PBUF_POOL_BUFSIZE</span>       <span class="token expression"><span class="token number">512</span>		</span><span class="token comment">//PBUF_POOL_BUFSIZE:每个pbuf内存池大小</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_TCP</span>                <span class="token expression"><span class="token number">1</span>  		</span><span class="token comment">//使用TCP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCP_TTL</span>                 <span class="token expression"><span class="token number">255</span>		</span><span class="token comment">//生存时间</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">TCP_QUEUE_OOSEQ</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCP_QUEUE_OOSEQ</span>         <span class="token expression"><span class="token number">0</span> 		</span><span class="token comment">//当TCP的数据段超出队列时的控制位,当设备的内存过小的时候此项应为0</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">TCPIP_MBOX_SIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCPIP_MBOX_SIZE</span>         <span class="token expression">MAX_QUEUE_ENTRIES   </span><span class="token comment">//tcpip创建主线程时的消息邮箱大小</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">DEFAULT_TCP_RECVMBOX_SIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_TCP_RECVMBOX_SIZE</span>       <span class="token expression">MAX_QUEUE_ENTRIES  </span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">DEFAULT_ACCEPTMBOX_SIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_ACCEPTMBOX_SIZE</span>         <span class="token expression">MAX_QUEUE_ENTRIES  </span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCP_MSS</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token number">1500</span> <span class="token operator">-</span> <span class="token number">40</span><span class="token punctuation">)</span>	  	</span><span class="token comment">//最大TCP分段,TCP_MSS = (MTU - IP报头大小 - TCP报头大小</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCP_SND_BUF</span>             <span class="token expression"><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>TCP_MSS<span class="token punctuation">)</span>		</span><span class="token comment">//TCP发送缓冲区大小(bytes).</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCP_SND_QUEUELEN</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span> TCP_SND_BUF<span class="token operator">/</span>TCP_MSS<span class="token punctuation">)</span>	</span><span class="token comment">//TCP_SND_QUEUELEN: TCP发送缓冲区大小(pbuf).这个值最小为(2 * TCP_SND_BUF/TCP_MSS)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCP_WND</span>                 <span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>TCP_MSS<span class="token punctuation">)</span>		</span><span class="token comment">//TCP发送窗口</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_ICMP</span>               <span class="token expression"><span class="token number">1</span> 	</span><span class="token comment">//使用ICMP协议</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_DHCP</span>               <span class="token expression"><span class="token number">1</span>	</span><span class="token comment">//使用DHCP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_UDP</span>                <span class="token expression"><span class="token number">1</span> 	</span><span class="token comment">//使用UDP服务</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UDP_TTL</span>                 <span class="token expression"><span class="token number">255</span> </span><span class="token comment">//UDP数据包生存时间</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_STATS</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_PROVIDE_ERRNO</span> <span class="token expression"><span class="token number">1</span></span></span>


<span class="token comment">//帧校验和选项，STM32F4x7允许通过硬件识别和计算IP,UDP和ICMP的帧校验和</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_BY_HARDWARE</span> <span class="token comment">//定义CHECKSUM_BY_HARDWARE,使用硬件帧校验</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CHECKSUM_BY_HARDWARE</span></span>
  <span class="token comment">//CHECKSUM_GEN_IP==0: 硬件生成IP数据包的帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_GEN_IP</span>                 <span class="token expression"><span class="token number">0</span></span></span>
  <span class="token comment">//CHECKSUM_GEN_UDP==0: 硬件生成UDP数据包的帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_GEN_UDP</span>                <span class="token expression"><span class="token number">0</span></span></span>
  <span class="token comment">//CHECKSUM_GEN_TCP==0: 硬件生成TCP数据包的帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_GEN_TCP</span>                <span class="token expression"><span class="token number">0</span> </span></span>
  <span class="token comment">//CHECKSUM_CHECK_IP==0: 硬件检查输入的IP数据包帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_CHECK_IP</span>               <span class="token expression"><span class="token number">0</span></span></span>
  <span class="token comment">//CHECKSUM_CHECK_UDP==0: 硬件检查输入的UDP数据包帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_CHECK_UDP</span>              <span class="token expression"><span class="token number">0</span></span></span>
  <span class="token comment">//CHECKSUM_CHECK_TCP==0: 硬件检查输入的TCP数据包帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_CHECK_TCP</span>              <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token comment">//CHECKSUM_GEN_IP==1: 软件生成IP数据包帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_GEN_IP</span>                 <span class="token expression"><span class="token number">1</span></span></span>
  <span class="token comment">// CHECKSUM_GEN_UDP==1: 软件生成UDOP数据包帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_GEN_UDP</span>                <span class="token expression"><span class="token number">1</span></span></span>
  <span class="token comment">//CHECKSUM_GEN_TCP==1: 软件生成TCP数据包帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_GEN_TCP</span>                <span class="token expression"><span class="token number">1</span></span></span>
  <span class="token comment">// CHECKSUM_CHECK_IP==1: 软件检查输入的IP数据包帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_CHECK_IP</span>               <span class="token expression"><span class="token number">1</span></span></span>
  <span class="token comment">// CHECKSUM_CHECK_UDP==1: 软件检查输入的UDP数据包帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_CHECK_UDP</span>              <span class="token expression"><span class="token number">1</span></span></span>
  <span class="token comment">//CHECKSUM_CHECK_TCP==1: 软件检查输入的TCP数据包帧校验和</span>
  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CHECKSUM_CHECK_TCP</span>              <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>



<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_NETCONN</span>                    <span class="token expression"><span class="token number">1</span> 	</span><span class="token comment">//LWIP_NETCONN==1:使能NETCON函数(要求使用api_lib.c)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_SOCKET</span>                     <span class="token expression"><span class="token number">1</span>	</span><span class="token comment">//LWIP_SOCKET==1:使能Sicket API(要求使用sockets.c)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_COMPAT_MUTEX</span>               <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_SO_RCVTIMEO</span>                <span class="token expression"><span class="token number">1</span> 	</span><span class="token comment">//通过定义LWIP_SO_RCVTIMEO使能netconn结构体中recv_timeout,使用recv_timeout可以避免阻塞线程</span></span>

<span class="token comment">//有关系统的选项</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TCPIP_THREAD_STACKSIZE</span>          <span class="token expression"><span class="token number">1000</span>	</span><span class="token comment">//内核任务堆栈大小</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_UDP_RECVMBOX_SIZE</span>       <span class="token expression"><span class="token number">2000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_THREAD_STACKSIZE</span>        <span class="token expression"><span class="token number">512</span></span></span>

<span class="token comment">//LWIP调试选项</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_DEBUG</span>                    	 <span class="token expression"><span class="token number">0</span>	 </span><span class="token comment">//关闭DEBUG选项</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ICMP_DEBUG</span>                      <span class="token expression">LWIP_DBG_OFF </span><span class="token comment">//开启/关闭ICMPdebug</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __LWIPOPTS_H__ */</span></span>
</code></pre> 
<h4><a id="254__sys_archh__sysarchc__877"></a>2.5.4 修改 sys_arch.h 和 sys.arch.c 文件</h4> 
<ol><li>修改 sys_arch.h 头文件<br>   在 sys_arch.h 中定义了消息邮箱的数量和每个消息邮箱的大小，在这个文件中还定义了 4中数据类型：sys_sem_t、sys_mutex_t、sys_mbox_t 和 sys_thread_t。分别为信号量、互斥信号量、消息邮箱和线程 ID。这里不能直接使用 UCOS 的消息邮箱，使用的是消息队列</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__ARCH_SYS_ARCH_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__ARCH_SYS_ARCH_H__</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;includes.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"arch/cc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"includes.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SYS_ARCH_GLOBALS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYS_ARCH_EXT</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYS_ARCH_EXT</span> <span class="token expression"><span class="token keyword">extern</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_QUEUES</span> <span class="token expression">OS_CFG_MSG_POOL_SIZE</span><span class="token comment">// 消息邮箱的数量</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_QUEUE_ENTRIES</span> <span class="token expression"><span class="token number">20</span> </span><span class="token comment">// 每个消息邮箱的大小</span></span>

<span class="token keyword">typedef</span> OS_SEM <span class="token class-name">sys_sem_t</span><span class="token punctuation">;</span> <span class="token comment">//LWIP 使用的信号量</span>
<span class="token keyword">typedef</span> OS_MUTEX <span class="token class-name">sys_mutex_t</span><span class="token punctuation">;</span> <span class="token comment">//LWIP 使用的互斥信号量</span>
<span class="token keyword">typedef</span> OS_Q <span class="token class-name">sys_mbox_t</span><span class="token punctuation">;</span> <span class="token comment">//LWIP 使用的消息邮箱,其实就是 UCOS 中的消息队列</span>
<span class="token keyword">typedef</span> CPU_INT08U <span class="token class-name">sys_thread_t</span><span class="token punctuation">;</span> <span class="token comment">//线程 ID,也就是任务优先级</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<ol start="2"><li>修改 sys_arch.c 文件<br>   sys_arch.c 文件是非常重要的一个文件，在这个文件中定义了 LWIP 使用到的关于信号量、消息邮箱的操作函数。与邮箱有关的函数要使用操作系统中的消息队列，有关于消息邮箱的这些函数功能来自于移植手册 sys_arch.txt</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYS_ARCH_GLOBALS</span></span>

<span class="token comment">/* lwIP includes. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/debug.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/def.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/lwip_sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/mem.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"includes.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"arch/sys_arch.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"malloc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"os_cfg_app.h"</span></span>


<span class="token comment">//当消息指针为空时,指向一个常量pvNullPointer所指向的值.</span>
<span class="token comment">//在UCOS中如果OSQPost()中的msg==NULL会返回一条OS_ERR_POST_NULL</span>
<span class="token comment">//错误,而在lwip中会调用sys_mbox_post(mbox,NULL)发送一条空消息,我们</span>
<span class="token comment">//在本函数中把NULL变成一个常量指针0Xffffffff</span>
<span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token keyword">const</span> pvNullPointer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">mem_ptr_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0xffffffff</span><span class="token punctuation">;</span>
 
<span class="token comment">/*************************消息邮箱函数*********************/</span>
<span class="token comment">//创建一个消息邮箱</span>
<span class="token comment">//*mbox:消息邮箱</span>
<span class="token comment">//size:邮箱大小</span>
<span class="token comment">//返回值:ERR_OK,创建成功</span>
<span class="token comment">//         其他,创建失败</span>
<span class="token class-name">err_t</span> <span class="token function">sys_mbox_new</span><span class="token punctuation">(</span> <span class="token class-name">sys_mbox_t</span> <span class="token operator">*</span>mbox<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	OS_ERR err<span class="token punctuation">;</span>
	<span class="token comment">//消息队列最多容纳 MAX_QUEUE_ENTRIES 消息数目</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>size<span class="token operator">&gt;</span>MAX_QUEUE_ENTRIES<span class="token punctuation">)</span>size<span class="token operator">=</span>MAX_QUEUE_ENTRIES<span class="token punctuation">;</span>
	<span class="token function">OSQCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_Q<span class="token operator">*</span> <span class="token punctuation">)</span>mbox<span class="token punctuation">,</span> <span class="token comment">//消息队列</span>
 			<span class="token punctuation">(</span>CPU_CHAR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token string">"LWIP Quiue"</span><span class="token punctuation">,</span> <span class="token comment">//消息队列名称</span>
 			<span class="token punctuation">(</span>OS_MSG_QTY <span class="token punctuation">)</span>size<span class="token punctuation">,</span> <span class="token comment">//消息队列长度</span>
 			<span class="token punctuation">(</span>OS_ERR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//错误码</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">==</span>OS_ERR_NONE<span class="token punctuation">)</span> <span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
	<span class="token keyword">return</span> ERR_MEM<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//释放并删除一个消息邮箱</span>
<span class="token comment">//*mbox:要删除的消息邮箱</span>
<span class="token keyword">void</span> <span class="token function">sys_mbox_free</span><span class="token punctuation">(</span><span class="token class-name">sys_mbox_t</span> <span class="token operator">*</span> mbox<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	OS_ERR err<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_Q_FLUSH_EN <span class="token operator">&gt;</span> <span class="token number">0u</span> </span></span>
	<span class="token function">OSQFlush</span><span class="token punctuation">(</span>mbox<span class="token punctuation">,</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">OSQDel</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_Q<span class="token operator">*</span> <span class="token punctuation">)</span>mbox<span class="token punctuation">,</span>
			<span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span>OS_OPT_DEL_ALWAYS<span class="token punctuation">,</span>
 			<span class="token punctuation">(</span>OS_ERR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span> <span class="token string">"OSQDel "</span><span class="token punctuation">,</span>err <span class="token operator">==</span> OS_ERR_NONE <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//向消息邮箱中发送一条消息(必须发送成功)</span>
<span class="token comment">//*mbox:消息邮箱</span>
<span class="token comment">//*msg:要发送的消息</span>
<span class="token keyword">void</span> <span class="token function">sys_mbox_post</span><span class="token punctuation">(</span><span class="token class-name">sys_mbox_t</span> <span class="token operator">*</span>mbox<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>    
	OS_ERR err<span class="token punctuation">;</span>
	CPU_INT08U i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">//当 msg 为空时 msg 等于 pvNullPointer 指向的值</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>msg<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pvNullPointer<span class="token punctuation">;</span>
	<span class="token comment">//发送消息</span>
 	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">//试 10 次 </span>
 	<span class="token punctuation">{<!-- --></span>
		<span class="token function">OSQPost</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_Q<span class="token operator">*</span> <span class="token punctuation">)</span>mbox<span class="token punctuation">,</span>
				<span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">)</span>msg<span class="token punctuation">,</span>
				<span class="token punctuation">(</span>OS_MSG_SIZE <span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span>OS_OPT_POST_FIFO<span class="token punctuation">,</span>
 				<span class="token punctuation">(</span>OS_ERR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">==</span>OS_ERR_NONE<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">OSTimeDlyHMSM</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span>OS_OPT_TIME_HMSM_STRICT<span class="token punctuation">,</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//延时 5ms</span>
	<span class="token punctuation">}</span>
	<span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span> <span class="token string">"sys_mbox_post error!\n"</span><span class="token punctuation">,</span> i <span class="token operator">!=</span><span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//尝试向一个消息邮箱发送消息</span>
<span class="token comment">//此函数相对于sys_mbox_post函数只发送一次消息，</span>
<span class="token comment">//发送失败后不会尝试第二次发送</span>
<span class="token comment">//*mbox:消息邮箱</span>
<span class="token comment">//*msg:要发送的消息</span>
<span class="token comment">//返回值:ERR_OK,发送OK</span>
<span class="token comment">// 	     ERR_MEM,发送失败</span>
<span class="token class-name">err_t</span> <span class="token function">sys_mbox_trypost</span><span class="token punctuation">(</span><span class="token class-name">sys_mbox_t</span> <span class="token operator">*</span>mbox<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
	OS_ERR err<span class="token punctuation">;</span>
	<span class="token comment">//当 msg 为空时 msg 等于 pvNullPointer 指向的值</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>msg<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pvNullPointer<span class="token punctuation">;</span>
	<span class="token function">OSQPost</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_Q<span class="token operator">*</span> <span class="token punctuation">)</span>mbox<span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">)</span>msg<span class="token punctuation">,</span>
			<span class="token punctuation">(</span>OS_MSG_SIZE <span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span>OS_OPT_POST_FIFO<span class="token punctuation">,</span>
			<span class="token punctuation">(</span>OS_ERR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span>OS_ERR_NONE<span class="token punctuation">)</span> <span class="token keyword">return</span> ERR_MEM<span class="token punctuation">;</span>
	<span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//等待邮箱中的消息</span>
<span class="token comment">//*mbox:消息邮箱</span>
<span class="token comment">//*msg:消息</span>
<span class="token comment">//timeout:超时时间，如果timeout为0的话,就一直等待</span>
<span class="token comment">//返回值:当timeout不为0时如果成功的话就返回等待的时间，</span>
<span class="token comment">//		失败的话就返回超时SYS_ARCH_TIMEOUT</span>
<span class="token class-name">u32_t</span> <span class="token function">sys_arch_mbox_fetch</span><span class="token punctuation">(</span><span class="token class-name">sys_mbox_t</span> <span class="token operator">*</span>mbox<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token class-name">u32_t</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
	OS_ERR err<span class="token punctuation">;</span>
	OS_MSG_SIZE size<span class="token punctuation">;</span>
	<span class="token class-name">u32_t</span> ucos_timeout<span class="token punctuation">,</span>timeout_new<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>temp<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//转换为节拍数,因为 UCOS 延时使用的是节拍数,而 LWIP 是用 ms</span>
		ucos_timeout<span class="token operator">=</span><span class="token punctuation">(</span>timeout<span class="token operator">*</span>OS_CFG_TICK_RATE_HZ<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ucos_timeout<span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>ucos_timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//至少 1 个节拍</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> ucos_timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
	timeout <span class="token operator">=</span> <span class="token function">OSTimeGet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取系统时间</span>
	<span class="token comment">//请求消息</span>
	temp<span class="token operator">=</span><span class="token function">OSQPend</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_Q<span class="token operator">*</span> <span class="token punctuation">)</span>mbox<span class="token punctuation">,</span> 
				<span class="token punctuation">(</span>OS_TICK <span class="token punctuation">)</span>ucos_timeout<span class="token punctuation">,</span>
				<span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span>OS_OPT_PEND_BLOCKING<span class="token punctuation">,</span>
				<span class="token punctuation">(</span>OS_MSG_SIZE<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>size<span class="token punctuation">,</span>
 				<span class="token punctuation">(</span>CPU_TS<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
 				<span class="token punctuation">(</span>OS_ERR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//因为 lwip 发送空消息的时候我们使用了 pvNullPointer 指针,所以判断 pvNullPointer</span>
		<span class="token comment">//指向的值就可知道请求到的消息是否有效。</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>pvNullPointer<span class="token punctuation">)</span><span class="token operator">*</span>msg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token operator">*</span>msg<span class="token operator">=</span>temp<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> 
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">==</span>OS_ERR_TIMEOUT<span class="token punctuation">)</span>timeout<span class="token operator">=</span>SYS_ARCH_TIMEOUT<span class="token punctuation">;</span> <span class="token comment">//请求超时</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"OSQPend "</span><span class="token punctuation">,</span>err<span class="token operator">==</span>OS_ERR_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		timeout_new<span class="token operator">=</span><span class="token function">OSTimeGet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//算出请求消息或使用的时间</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_new<span class="token operator">&gt;=</span>timeout<span class="token punctuation">)</span> timeout_new <span class="token operator">=</span> timeout_new <span class="token operator">-</span> timeout<span class="token punctuation">;</span>
		<span class="token keyword">else</span> timeout_new <span class="token operator">=</span> <span class="token number">0xffffffff</span> <span class="token operator">-</span> timeout <span class="token operator">+</span> timeout_new<span class="token punctuation">;</span> 
		timeout<span class="token operator">=</span>timeout_new<span class="token operator">*</span><span class="token number">1000</span><span class="token operator">/</span>OS_CFG_TICK_RATE_HZ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//尝试获取消息</span>
<span class="token comment">//*mbox:消息邮箱</span>
<span class="token comment">//*msg:消息</span>
<span class="token comment">//返回值:等待消息所用的时间/SYS_ARCH_TIMEOUT</span>
<span class="token class-name">u32_t</span> <span class="token function">sys_arch_mbox_tryfetch</span><span class="token punctuation">(</span><span class="token class-name">sys_mbox_t</span> <span class="token operator">*</span>mbox<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">sys_arch_mbox_fetch</span><span class="token punctuation">(</span>mbox<span class="token punctuation">,</span>msg<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//尝试获取一个消息</span>
<span class="token punctuation">}</span>
<span class="token comment">//检查一个消息邮箱是否有效</span>
<span class="token comment">//*mbox:消息邮箱</span>
<span class="token comment">//返回值:1,有效.</span>
<span class="token comment">//      0,无效</span>
<span class="token keyword">int</span> <span class="token function">sys_mbox_valid</span><span class="token punctuation">(</span><span class="token class-name">sys_mbox_t</span> <span class="token operator">*</span>mbox<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>mbox<span class="token operator">-&gt;</span>NamePtr<span class="token punctuation">)</span> 
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>mbox<span class="token operator">-&gt;</span>NamePtr<span class="token punctuation">,</span><span class="token string">"?Q"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//设置一个消息邮箱为无效</span>
<span class="token comment">//*mbox:消息邮箱</span>
<span class="token keyword">void</span> <span class="token function">sys_mbox_set_invalid</span><span class="token punctuation">(</span><span class="token class-name">sys_mbox_t</span> <span class="token operator">*</span>mbox<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sys_mbox_valid</span><span class="token punctuation">(</span>mbox<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">sys_mbox_free</span><span class="token punctuation">(</span>mbox<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token comment">/********************信号量相关函数************************/</span>
<span class="token comment">//创建一个信号量</span>
<span class="token comment">//*sem:创建的信号量</span>
<span class="token comment">//count:信号量值</span>
<span class="token comment">//返回值:ERR_OK,创建OK</span>
<span class="token comment">// 	     ERR_MEM,创建失败</span>
<span class="token class-name">err_t</span> <span class="token function">sys_sem_new</span><span class="token punctuation">(</span><span class="token class-name">sys_sem_t</span> <span class="token operator">*</span> sem<span class="token punctuation">,</span> <span class="token class-name">u8_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
	OS_ERR err<span class="token punctuation">;</span>
	<span class="token function">OSSemCreate</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_SEM<span class="token operator">*</span> <span class="token punctuation">)</span>sem<span class="token punctuation">,</span>
 				<span class="token punctuation">(</span>CPU_CHAR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token string">"LWIP Sem"</span><span class="token punctuation">,</span>
 				<span class="token punctuation">(</span>OS_SEM_CTR <span class="token punctuation">)</span>count<span class="token punctuation">,</span>
 				<span class="token punctuation">(</span>OS_ERR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span>OS_ERR_NONE<span class="token punctuation">)</span><span class="token keyword">return</span> ERR_MEM<span class="token punctuation">;</span> 
	<span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"OSSemCreate "</span><span class="token punctuation">,</span>sem <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ERR_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//等待一个信号量</span>
<span class="token comment">//*sem:要等待的信号量</span>
<span class="token comment">//timeout:超时时间</span>
<span class="token comment">//返回值:当timeout不为0时如果成功的话就返回等待的时间，</span>
<span class="token comment">//		失败的话就返回超时SYS_ARCH_TIMEOUT</span>
<span class="token class-name">u32_t</span> <span class="token function">sys_arch_sem_wait</span><span class="token punctuation">(</span><span class="token class-name">sys_sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">,</span> <span class="token class-name">u32_t</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
	OS_ERR err<span class="token punctuation">;</span>
	<span class="token class-name">u32_t</span> ucos_timeout<span class="token punctuation">,</span> timeout_new<span class="token punctuation">;</span> 
	<span class="token keyword">if</span><span class="token punctuation">(</span> timeout<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//转换为节拍数,因为 UCOS 延时使用的是节拍数,而 LWIP 是用 ms</span>
		ucos_timeout <span class="token operator">=</span> <span class="token punctuation">(</span>timeout <span class="token operator">*</span> OS_CFG_TICK_RATE_HZ<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ucos_timeout <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
		ucos_timeout <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> ucos_timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
	timeout <span class="token operator">=</span> <span class="token function">OSTimeGet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">OSSemPend</span><span class="token punctuation">(</span>sem<span class="token punctuation">,</span>ucos_timeout<span class="token punctuation">,</span>OS_OPT_PEND_BLOCKING<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//请求信号量</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> OS_ERR_TIMEOUT<span class="token punctuation">)</span>timeout<span class="token operator">=</span>SYS_ARCH_TIMEOUT<span class="token punctuation">;</span> <span class="token comment">//请求超时</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span> 
		timeout_new <span class="token operator">=</span> <span class="token function">OSTimeGet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_new<span class="token operator">&gt;=</span>timeout<span class="token punctuation">)</span> timeout_new <span class="token operator">=</span> timeout_new <span class="token operator">-</span> timeout<span class="token punctuation">;</span>
		<span class="token keyword">else</span> timeout_new <span class="token operator">=</span> <span class="token number">0xffffffff</span> <span class="token operator">-</span> timeout <span class="token operator">+</span> timeout_new<span class="token punctuation">;</span>
		<span class="token comment">//算出请求消息或使用的时间(ms)</span>
		timeout <span class="token operator">=</span> <span class="token punctuation">(</span>timeout_new<span class="token operator">*</span><span class="token number">1000</span><span class="token operator">/</span>OS_CFG_TICK_RATE_HZ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//发送一个信号量</span>
<span class="token comment">//sem:信号量指针</span>
<span class="token keyword">void</span> <span class="token function">sys_sem_signal</span><span class="token punctuation">(</span><span class="token class-name">sys_sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	OS_ERR err<span class="token punctuation">;</span>
	<span class="token function">OSSemPost</span><span class="token punctuation">(</span>sem<span class="token punctuation">,</span>OS_OPT_POST_1<span class="token punctuation">,</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送信号量</span>
	<span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"OSSemPost "</span><span class="token punctuation">,</span>err <span class="token operator">==</span> OS_ERR_NONE <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//释放并删除一个信号量</span>
<span class="token comment">//sem:信号量指针</span>
<span class="token keyword">void</span> <span class="token function">sys_sem_free</span><span class="token punctuation">(</span><span class="token class-name">sys_sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	OS_ERR err<span class="token punctuation">;</span>
	<span class="token function">OSSemDel</span><span class="token punctuation">(</span>sem<span class="token punctuation">,</span>OS_OPT_DEL_ALWAYS<span class="token punctuation">,</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LWIP_ASSERT</span><span class="token punctuation">(</span><span class="token string">"OSSemDel "</span><span class="token punctuation">,</span>err<span class="token operator">==</span>OS_ERR_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sem <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//查询一个信号量的状态,无效或有效</span>
<span class="token comment">//sem:信号量指针</span>
<span class="token comment">//返回值:1,有效.</span>
<span class="token comment">//      0,无效</span>
<span class="token keyword">int</span> <span class="token function">sys_sem_valid</span><span class="token punctuation">(</span><span class="token class-name">sys_sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sem<span class="token operator">-&gt;</span>NamePtr<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>sem<span class="token operator">-&gt;</span>NamePtr<span class="token punctuation">,</span><span class="token string">"?SEM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>           
<span class="token punctuation">}</span> 
<span class="token comment">//设置一个信号量无效</span>
<span class="token comment">//sem:信号量指针</span>
<span class="token keyword">void</span> <span class="token function">sys_sem_set_invalid</span><span class="token punctuation">(</span><span class="token class-name">sys_sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sys_sem_valid</span><span class="token punctuation">(</span>sem<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">sys_sem_free</span><span class="token punctuation">(</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//arch初始化</span>
<span class="token keyword">void</span> <span class="token function">sys_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token comment">//这里,我们在该函数,不做任何事情</span>
<span class="token punctuation">}</span> 

<span class="token comment">/****************创建新进程****************/</span>
<span class="token keyword">extern</span> CPU_STK <span class="token operator">*</span> TCPIP_THREAD_TASK_STK<span class="token punctuation">;</span><span class="token comment">//TCP IP 内核任务堆栈,在lwip_comm函数定义</span>
<span class="token comment">//LWIP 内核任务的任务控制块</span>
OS_TCB TcpipthreadTaskTCB<span class="token punctuation">;</span>
<span class="token comment">//创建一个新进程</span>
<span class="token comment">//*name:进程名称</span>
<span class="token comment">//thred:进程任务函数</span>
<span class="token comment">//*arg:进程任务函数的参数</span>
<span class="token comment">//stacksize:进程任务的堆栈大小</span>
<span class="token comment">//prio:进程任务的优先级</span>
<span class="token class-name">sys_thread_t</span> <span class="token function">sys_thread_new</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> lwip_thread_fn thread<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">int</span> stacksize<span class="token punctuation">,</span> <span class="token keyword">int</span> prio<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	OS_ERR err<span class="token punctuation">;</span>
	<span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>TCPIP_THREAD_NAME<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//创建 TCP IP 内核任务</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">OS_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//进入临界区</span>
		<span class="token comment">//创建开始任务</span>
		<span class="token function">OSTaskCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_TCB<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>TcpipthreadTaskTCB<span class="token punctuation">,</span><span class="token comment">//任务控制块</span>
					<span class="token punctuation">(</span>CPU_CHAR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token string">"TCPIPThread task"</span><span class="token punctuation">,</span> <span class="token comment">//任务名字</span>
					<span class="token punctuation">(</span>OS_TASK_PTR <span class="token punctuation">)</span>thread<span class="token punctuation">,</span> <span class="token comment">//任务函数</span>
					<span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//传递给任务函数的参数</span>
					<span class="token punctuation">(</span>OS_PRIO <span class="token punctuation">)</span>prio<span class="token punctuation">,</span> <span class="token comment">//任务优先级</span>
					<span class="token punctuation">(</span>CPU_STK<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>TCPIP_THREAD_TASK_STK<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
					<span class="token punctuation">(</span>CPU_STK_SIZE <span class="token punctuation">)</span>stacksize<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">//任务堆栈深度限位</span>
					<span class="token punctuation">(</span>CPU_STK_SIZE <span class="token punctuation">)</span>stacksize<span class="token punctuation">,</span> <span class="token comment">//任务堆栈大小</span>
					<span class="token punctuation">(</span>OS_MSG_QTY <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
					<span class="token punctuation">(</span>OS_TICK <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span>
					<span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//用户补充的存储区</span>
					<span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span>OS_OPT_TASK_STK_CHK<span class="token operator">|</span>\ <span class="token comment">//任务选项</span>
							OS_OPT_TASK_STK_CLR<span class="token punctuation">,</span> 
					<span class="token punctuation">(</span>OS_ERR<span class="token operator">*</span> <span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//存放该函数错误时的返回值</span>
		<span class="token function">OS_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//退出临界区</span>
	<span class="token punctuation">}</span> 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//lwip延时函数</span>
<span class="token comment">//ms:要延时的ms数</span>
<span class="token keyword">void</span> <span class="token function">sys_msleep</span><span class="token punctuation">(</span><span class="token class-name">u32_t</span> ms<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//获取系统时间,LWIP1.4.1增加的函数</span>
<span class="token comment">//返回值:当前系统时间(单位:毫秒)</span>
<span class="token class-name">u32_t</span> <span class="token function">sys_now</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	OS_ERR err<span class="token punctuation">;</span>
	<span class="token class-name">u32_t</span> ucos_time<span class="token punctuation">,</span> lwip_time<span class="token punctuation">;</span>
	ucos_time<span class="token operator">=</span><span class="token function">OSTimeGet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取当前系统时间 得到的是 UCSO 的节拍数</span>
	lwip_time<span class="token operator">=</span><span class="token punctuation">(</span>ucos_time<span class="token operator">*</span><span class="token number">1000</span><span class="token operator">/</span>OS_CFG_TICK_RATE_HZ<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将节拍数转换为 LWIP 的时间MS</span>
	<span class="token keyword">return</span> lwip_time<span class="token punctuation">;</span> <span class="token comment">//返回 lwip_time;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  最后我们还实现了 sys_msleep 和 sys_now 这两个函数，他们分别为 LWIP 使用到的延时函数和获取系统时间函数。sys_msleep 函数很简单，sys_now 函数是先获取到 UCOS 的时间节拍，然后将其转换为 LWIP 使用的 ms，并返回这个时间值。</p> 
<h4><a id="255_LWIP_1215"></a>2.5.5 添加LWIP通用文件</h4> 
<p>  lwip_comm.c 和 lwip_comm.h 是将 LWIP 源码和前面的以太网驱动库结合起来的桥梁，在apps里添加lwip_comm文件夹，在里面添加lwip_comm.c 和 lwip_comm.h两个文件</p> 
<ol><li>添加lwip_comm.h 文件</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_LWIP_COMM_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_LWIP_COMM_H</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lan8720.h"</span> </span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_MAX_DHCP_TRIES</span>		<span class="token expression"><span class="token number">4</span>   </span><span class="token comment">//DHCP服务器最大重试次数 </span></span>

<span class="token comment">//lwip控制结构体</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span>  
<span class="token punctuation">{<!-- --></span>
	u8 mac<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">//MAC地址</span>
	u8 remoteip<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//远端主机IP地址 </span>
	u8 ip<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">//本机IP地址</span>
	u8 netmask<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 	<span class="token comment">//子网掩码</span>
	u8 gateway<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 	<span class="token comment">//默认网关的IP地址</span>
	
	vu8 dhcpstatus<span class="token punctuation">;</span>	<span class="token comment">//dhcp状态 </span>
					<span class="token comment">//0,未获取DHCP地址;</span>
					<span class="token comment">//1,进入DHCP获取状态</span>
					<span class="token comment">//2,成功获取DHCP地址</span>
					<span class="token comment">//0XFF,获取失败.</span>
<span class="token punctuation">}</span>__lwip_dev<span class="token punctuation">;</span>
<span class="token keyword">extern</span> __lwip_dev lwipdev<span class="token punctuation">;</span>	<span class="token comment">//lwip控制结构体</span>
 
<span class="token keyword">void</span> <span class="token function">lwip_pkt_handle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_default_ip_set</span><span class="token punctuation">(</span>__lwip_dev <span class="token operator">*</span>lwipx<span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">lwip_comm_mem_malloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_mem_free</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">lwip_comm_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_dhcp_creat</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_dhcp_delete</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_destroy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_delete_next_timeout</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<ol start="2"><li>添加lwip_comm.c 文件</li></ol> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip_comm.h"</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"netif/etharp.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/dhcp.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ethernetif.h"</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/timers.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/tcp_impl.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/ip_frag.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip/tcpip.h"</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"malloc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

  
__lwip_dev lwipdev<span class="token punctuation">;</span>						<span class="token comment">//lwip控制结构体 </span>
<span class="token keyword">struct</span> <span class="token class-name">netif</span> lwip_netif<span class="token punctuation">;</span>				<span class="token comment">//定义一个全局的网络接口</span>

<span class="token keyword">extern</span> u32 <span class="token function">memp_get_memorysize</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//在memp.c里面定义</span>
<span class="token keyword">extern</span> <span class="token class-name">u8_t</span> <span class="token operator">*</span>memp_memory<span class="token punctuation">;</span>				<span class="token comment">//在memp.c里面定义.</span>
<span class="token keyword">extern</span> <span class="token class-name">u8_t</span> <span class="token operator">*</span>ram_heap<span class="token punctuation">;</span>					<span class="token comment">//在mem.c里面定义.</span>


<span class="token comment"></span>
<span class="token comment">//lwip两个任务定义(内核任务和DHCP任务)</span>

<span class="token comment">//lwip内核任务堆栈(优先级和堆栈大小在lwipopts.h定义了) </span>
CPU_STK <span class="token operator">*</span> TCPIP_THREAD_TASK_STK<span class="token punctuation">;</span>

<span class="token comment">//lwip DHCP任务</span>
<span class="token comment">//设置任务优先级</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_DHCP_TASK_PRIO</span>       		<span class="token expression"><span class="token number">7</span></span></span>
<span class="token comment">//设置任务堆栈大小</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LWIP_DHCP_STK_SIZE</span>  		    <span class="token expression"><span class="token number">256</span></span></span>
<span class="token comment">//任务控制块</span>
OS_TCB LwipdhcpTaskTCB<span class="token punctuation">;</span>
<span class="token comment">//任务堆栈，采用内存管理的方式控制申请</span>
CPU_STK <span class="token operator">*</span> LWIP_DHCP_TASK_STK<span class="token punctuation">;</span>
<span class="token comment">//任务函数</span>
<span class="token keyword">void</span> <span class="token function">lwip_dhcp_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span><span class="token punctuation">;</span> 


<span class="token comment">//用于以太网中断调用</span>
<span class="token keyword">void</span> <span class="token function">lwip_pkt_handle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">ethernetif_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lwip_netif<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//lwip内核部分,内存申请</span>
<span class="token comment">//返回值:0,成功;</span>
<span class="token comment">//    其他,失败</span>
u8 <span class="token function">lwip_comm_mem_malloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 mempsize<span class="token punctuation">;</span>
	u32 ramheapsize<span class="token punctuation">;</span> 
	mempsize<span class="token operator">=</span><span class="token function">memp_get_memorysize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//得到memp_memory数组大小</span>
	memp_memory<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>mempsize<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//为memp_memory申请内存</span>
	ramheapsize<span class="token operator">=</span><span class="token function">LWIP_MEM_ALIGN_SIZE</span><span class="token punctuation">(</span>MEM_SIZE<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span><span class="token function">LWIP_MEM_ALIGN_SIZE</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">+</span>MEM_ALIGNMENT<span class="token punctuation">;</span><span class="token comment">//得到ram heap大小</span>
	ram_heap<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>ramheapsize<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//为ram_heap申请内存 </span>
	TCPIP_THREAD_TASK_STK<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>TCPIP_THREAD_STACKSIZE<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//给内核任务申请堆栈 </span>
	LWIP_DHCP_TASK_STK<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>LWIP_DHCP_STK_SIZE<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//给dhcp任务堆栈申请内存空间</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>memp_memory<span class="token operator">||</span><span class="token operator">!</span>ram_heap<span class="token operator">||</span><span class="token operator">!</span>TCPIP_THREAD_TASK_STK<span class="token operator">||</span><span class="token operator">!</span>LWIP_DHCP_TASK_STK<span class="token punctuation">)</span><span class="token comment">//有申请失败的</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">lwip_comm_mem_free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
<span class="token comment">//lwip内核部分,内存释放</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_mem_free</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 	
	<span class="token function">myfree</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>memp_memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">myfree</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>ram_heap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">myfree</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>TCPIP_THREAD_TASK_STK<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">myfree</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>LWIP_DHCP_TASK_STK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//lwip 默认IP设置</span>
<span class="token comment">//lwipx:lwip控制结构体指针</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_default_ip_set</span><span class="token punctuation">(</span>__lwip_dev <span class="token operator">*</span>lwipx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 sn0<span class="token punctuation">;</span>
	sn0<span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>vu32<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x1FFF7A10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取STM32的唯一ID的前24位作为MAC地址后三字节</span>
	<span class="token comment">//默认远端IP为:192.168.1.100</span>
	lwipx<span class="token operator">-&gt;</span>remoteip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">192</span><span class="token punctuation">;</span>	
	lwipx<span class="token operator">-&gt;</span>remoteip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">168</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>remoteip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>remoteip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span>
	<span class="token comment">//MAC地址设置(高三字节固定为:2.0.0,低三字节用STM32唯一ID)</span>
	lwipx<span class="token operator">-&gt;</span>mac<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//高三字节(IEEE称之为组织唯一ID,OUI)地址固定为:2.0.0</span>
	lwipx<span class="token operator">-&gt;</span>mac<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>mac<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>mac<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>sn0<span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0XFF</span><span class="token punctuation">;</span><span class="token comment">//低三字节用STM32的唯一ID</span>
	lwipx<span class="token operator">-&gt;</span>mac<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>sn0<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0XFFF</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>mac<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span>sn0<span class="token operator">&amp;</span><span class="token number">0XFF</span><span class="token punctuation">;</span> 
	<span class="token comment">//默认本地IP为:192.168.1.30</span>
	lwipx<span class="token operator">-&gt;</span>ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">192</span><span class="token punctuation">;</span>	
	lwipx<span class="token operator">-&gt;</span>ip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">168</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>ip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>ip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">;</span>
	<span class="token comment">//默认子网掩码:255.255.255.0</span>
	lwipx<span class="token operator">-&gt;</span>netmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">;</span>	
	lwipx<span class="token operator">-&gt;</span>netmask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>netmask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>netmask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">//默认网关:192.168.1.1</span>
	lwipx<span class="token operator">-&gt;</span>gateway<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">192</span><span class="token punctuation">;</span>	
	lwipx<span class="token operator">-&gt;</span>gateway<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">168</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>gateway<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	lwipx<span class="token operator">-&gt;</span>gateway<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	
	lwipx<span class="token operator">-&gt;</span>dhcpstatus<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//没有DHCP	</span>
<span class="token punctuation">}</span> 

<span class="token comment">//LWIP初始化(LWIP启动的时候使用)</span>
<span class="token comment">//返回值:0,成功</span>
<span class="token comment">//      1,内存错误</span>
<span class="token comment">//      2,LAN8720初始化失败</span>
<span class="token comment">//      3,网卡添加失败.</span>
u8 <span class="token function">lwip_comm_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	OS_CPU_SR cpu_sr<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>Netif_Init_Flag<span class="token punctuation">;</span>		<span class="token comment">//调用netif_add()函数时的返回值,用于判断网络初始化是否成功</span>
	<span class="token keyword">struct</span> <span class="token class-name">ip_addr</span> ipaddr<span class="token punctuation">;</span>  			<span class="token comment">//ip地址</span>
	<span class="token keyword">struct</span> <span class="token class-name">ip_addr</span> netmask<span class="token punctuation">;</span> 			<span class="token comment">//子网掩码</span>
	<span class="token keyword">struct</span> <span class="token class-name">ip_addr</span> gw<span class="token punctuation">;</span>      			<span class="token comment">//默认网关 </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ETH_Mem_Malloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//内存申请失败</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">lwip_comm_mem_malloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//内存申请失败</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">LAN8720_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>			<span class="token comment">//初始化LAN8720失败 </span>
	<span class="token function">tcpip_init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//初始化tcp ip内核,该函数里面会创建tcpip_thread内核任务</span>
	<span class="token function">lwip_comm_default_ip_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lwipdev<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置默认IP等信息</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_DHCP		</span><span class="token comment">//使用动态IP</span></span>
	ipaddr<span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	netmask<span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	gw<span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span>				<span class="token comment">//使用静态IP</span></span>
	<span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ipaddr<span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netmask<span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gw<span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"网卡en的MAC地址为:................%d.%d.%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"静态IP地址........................%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子网掩码..........................%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"默认网关..........................%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">OS_ENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//进入临界区</span>
	Netif_Init_Flag<span class="token operator">=</span><span class="token function">netif_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lwip_netif<span class="token punctuation">,</span><span class="token operator">&amp;</span>ipaddr<span class="token punctuation">,</span><span class="token operator">&amp;</span>netmask<span class="token punctuation">,</span><span class="token operator">&amp;</span>gw<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>ethernetif_init<span class="token punctuation">,</span><span class="token operator">&amp;</span>tcpip_input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//向网卡列表中添加一个网口</span>
	<span class="token function">OS_EXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//退出临界区</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Netif_Init_Flag<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//网卡添加失败 </span>
	<span class="token keyword">else</span><span class="token comment">//网口添加成功后,设置netif为默认值,并且打开netif网口</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">netif_set_default</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lwip_netif<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置netif为默认网口</span>
		<span class="token function">netif_set_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lwip_netif<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//打开netif网口</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//操作OK.</span>
<span class="token punctuation">}</span>   
<span class="token comment">//如果使能了DHCP</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_DHCP</span></span>
<span class="token comment">//创建DHCP任务</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_dhcp_creat</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	OS_CPU_SR cpu_sr<span class="token punctuation">;</span>
	<span class="token function">OS_ENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//进入临界区</span>
	<span class="token function">OSTaskCreate</span><span class="token punctuation">(</span>lwip_dhcp_task<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>OS_STK<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>LWIP_DHCP_TASK_STK<span class="token punctuation">[</span>LWIP_DHCP_STK_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>LWIP_DHCP_TASK_PRIO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建DHCP任务 </span>
	<span class="token function">OS_EXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//退出临界区</span>
<span class="token punctuation">}</span>
<span class="token comment">//删除DHCP任务</span>
<span class="token keyword">void</span> <span class="token function">lwip_comm_dhcp_delete</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">dhcp_stop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lwip_netif<span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//关闭DHCP</span>
	<span class="token function">OSTaskDel</span><span class="token punctuation">(</span>LWIP_DHCP_TASK_PRIO<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//删除DHCP任务</span>
<span class="token punctuation">}</span>
<span class="token comment">//DHCP处理任务</span>
<span class="token keyword">void</span> <span class="token function">lwip_dhcp_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 ip<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>netmask<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>gw<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">dhcp_start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lwip_netif<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开启DHCP </span>
	lwipdev<span class="token punctuation">.</span>dhcpstatus<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//正在DHCP</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"正在查找DHCP服务器,请稍等...........\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span> 
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"正在获取地址...\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		ip<span class="token operator">=</span>lwip_netif<span class="token punctuation">.</span>ip_addr<span class="token punctuation">.</span>addr<span class="token punctuation">;</span>		<span class="token comment">//读取新IP地址</span>
		netmask<span class="token operator">=</span>lwip_netif<span class="token punctuation">.</span>netmask<span class="token punctuation">.</span>addr<span class="token punctuation">;</span><span class="token comment">//读取子网掩码</span>
		gw<span class="token operator">=</span>lwip_netif<span class="token punctuation">.</span>gw<span class="token punctuation">.</span>addr<span class="token punctuation">;</span>			<span class="token comment">//读取默认网关 </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ip<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>   					<span class="token comment">//当正确读取到IP地址的时候</span>
		<span class="token punctuation">{<!-- --></span>
			lwipdev<span class="token punctuation">.</span>dhcpstatus<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>	<span class="token comment">//DHCP成功</span>
 			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"网卡en的MAC地址为:................%d.%d.%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//解析出通过DHCP获取到的IP地址</span>
			lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ip<span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
			lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ip<span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ip<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"通过DHCP获取到IP地址..............%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//解析通过DHCP获取到的子网掩码地址</span>
			lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>netmask<span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>netmask<span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>netmask<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>netmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"通过DHCP获取到子网掩码............%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//解析出通过DHCP获取到的默认网关</span>
			lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gw<span class="token operator">&gt;&gt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gw<span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gw<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gw<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"通过DHCP获取到的默认网关..........%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>lwip_netif<span class="token punctuation">.</span>dhcp<span class="token operator">-&gt;</span>tries<span class="token operator">&gt;</span>LWIP_MAX_DHCP_TRIES<span class="token punctuation">)</span> <span class="token comment">//通过DHCP服务获取IP地址失败,且超过最大尝试次数</span>
		<span class="token punctuation">{<!-- --></span>  
			lwipdev<span class="token punctuation">.</span>dhcpstatus<span class="token operator">=</span><span class="token number">0XFF</span><span class="token punctuation">;</span><span class="token comment">//DHCP失败.</span>
			<span class="token comment">//使用静态IP地址</span>
			<span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>lwip_netif<span class="token punctuation">.</span>ip_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>lwip_netif<span class="token punctuation">.</span>netmask<span class="token punctuation">)</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>lwip_netif<span class="token punctuation">.</span>gw<span class="token punctuation">)</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"DHCP服务超时,使用静态IP地址!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"网卡en的MAC地址为:................%d.%d.%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>mac<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"静态IP地址........................%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子网掩码..........................%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"默认网关..........................%d.%d.%d.%d\r\n"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>  
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//延时250ms</span>
	<span class="token punctuation">}</span>
	<span class="token function">lwip_comm_dhcp_delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//删除DHCP任务 </span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
</code></pre> 
<p>在 lwip_comm.c 中有一下 7 个函数：</p> 
<blockquote> 
 <p>①lwip_comm_mem_malloc()函数完成了对 mem.c 和memp.c 中内存堆 ram_heap 和内存池 memp_memory 的内存分配<br> ②lwip_comm_mem_free()函数用来释放内存堆 ram_heap 和内存池 memp_memory 的内存<br> ③lwip_comm_default_ip_set()函数用来设置默认地址<br> ④lwip_comm_init 函数主要完成 LWIP 内核初始化、设置默认网卡并且打开指定的网卡<br> ⑤在中断服务函数中我们调用了lwip_pkt_handle()函数来接收数据<br> ⑥lwip_periodic_handle()函数就可以完成对 LWIP 内核的定时处理函数的周期性调用<br> ⑦lwip_dhcp_process_handle()函数为 DHCP 处理函数</p> 
</blockquote> 
<h3><a id="26__1492"></a>2.6 测试函数编写</h3> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip_comm.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"LAN8720.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usmart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"timer.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sram.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"malloc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwip_comm.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"includes.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lwipopts.h"</span></span>


<span class="token comment">//在LCD上显示地址信息任务</span>
<span class="token comment">//任务优先级</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPLAY_TASK_PRIO</span>	<span class="token expression"><span class="token number">8</span></span></span>
<span class="token comment">//任务堆栈大小</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPLAY_STK_SIZE</span>	<span class="token expression"><span class="token number">128</span></span></span>
<span class="token comment">//任务堆栈</span>
OS_STK	DISPLAY_TASK_STK<span class="token punctuation">[</span>DISPLAY_STK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//任务函数</span>
<span class="token keyword">void</span> <span class="token function">display_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//LED任务</span>
<span class="token comment">//任务优先级</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_TASK_PRIO</span>		<span class="token expression"><span class="token number">9</span></span></span>
<span class="token comment">//任务堆栈大小</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_STK_SIZE</span>		<span class="token expression"><span class="token number">64</span></span></span>
<span class="token comment">//任务堆栈</span>
OS_STK	LED_TASK_STK<span class="token punctuation">[</span>LED_STK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//任务函数</span>
<span class="token keyword">void</span> <span class="token function">led_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span><span class="token punctuation">;</span>  


<span class="token comment">//START任务</span>
<span class="token comment">//任务优先级</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">START_TASK_PRIO</span>		<span class="token expression"><span class="token number">10</span></span></span>
<span class="token comment">//任务堆栈大小</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">START_STK_SIZE</span>		<span class="token expression"><span class="token number">128</span></span></span>
<span class="token comment">//任务堆栈</span>
OS_STK START_TASK_STK<span class="token punctuation">[</span>START_STK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//任务函数</span>
<span class="token keyword">void</span> <span class="token function">start_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">//在LCD上显示地址信息</span>
<span class="token comment">//mode:1 显示DHCP获取到的地址</span>
<span class="token comment">//	  其他 显示静态地址</span>
<span class="token keyword">void</span> <span class="token function">show_address</span><span class="token punctuation">(</span>u8 mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 buf<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token string">"DHCP IP :%d.%d.%d.%d"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//打印动态IP地址</span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">210</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token string">"DHCP GW :%d.%d.%d.%d"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打印网关地址</span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">210</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token string">"NET MASK:%d.%d.%d.%d"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打印子网掩码地址</span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">210</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token string">"Static IP:%d.%d.%d.%d"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>ip<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//打印动态IP地址</span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">130</span><span class="token punctuation">,</span><span class="token number">210</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token string">"Static GW:%d.%d.%d.%d"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>gateway<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打印网关地址</span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">210</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token string">"NET MASK :%d.%d.%d.%d"</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>lwipdev<span class="token punctuation">.</span>netmask<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打印子网掩码地址</span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">210</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token number">168</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       	<span class="token comment">//延时初始化</span>
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//中断分组配置</span>
	<span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    	<span class="token comment">//串口波特率设置</span>
	usmart_dev<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//初始化USMART</span>
	<span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  			<span class="token comment">//LED初始化</span>
	<span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  			<span class="token comment">//按键初始化</span>
	<span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  			<span class="token comment">//LCD初始化</span>
	
	<span class="token function">FSMC_SRAM_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//SRAM初始化</span>
	
	<span class="token function">mymem_init</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">)</span><span class="token punctuation">;</span>  	<span class="token comment">//初始化内部内存池</span>
	<span class="token function">mymem_init</span><span class="token punctuation">(</span>SRAMEX<span class="token punctuation">)</span><span class="token punctuation">;</span>  	<span class="token comment">//初始化外部内存池</span>
	<span class="token function">mymem_init</span><span class="token punctuation">(</span>SRAMCCM<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//初始化CCM内存池</span>
	
	POINT_COLOR <span class="token operator">=</span> RED<span class="token punctuation">;</span> 		<span class="token comment">//红色字体</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Explorer STM32F4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"LWIP+UCOS Test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"ATOM@ALIENTEK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"2014/9/1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">OSInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 					<span class="token comment">//UCOS初始化</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">lwip_comm_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 	<span class="token comment">//lwip初始化</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Lwip Init failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//lwip初始化失败</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">LCD_Fill</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">230</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">LCD_ShowString</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"Lwip Init Success!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//lwip初始化成功</span>
	<span class="token function">OSTaskCreate</span><span class="token punctuation">(</span>start_task<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>OS_STK<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>START_TASK_STK<span class="token punctuation">[</span>START_STK_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>START_TASK_PRIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">OSStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开启UCOS</span>
<span class="token punctuation">}</span>

<span class="token comment">//start任务</span>
<span class="token keyword">void</span> <span class="token function">start_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	OS_CPU_SR cpu_sr<span class="token punctuation">;</span>
	pdata <span class="token operator">=</span> pdata <span class="token punctuation">;</span>
	
	<span class="token function">OSStatInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  			<span class="token comment">//初始化统计任务</span>
	<span class="token function">OS_ENTER_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  	<span class="token comment">//关中断</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_DHCP</span></span>
	<span class="token function">lwip_comm_dhcp_creat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建DHCP任务</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	
	<span class="token function">OSTaskCreate</span><span class="token punctuation">(</span>led_task<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>OS_STK<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>LED_TASK_STK<span class="token punctuation">[</span>LED_STK_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>LED_TASK_PRIO<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建LED任务</span>
	<span class="token function">OSTaskCreate</span><span class="token punctuation">(</span>display_task<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>OS_STK<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>DISPLAY_TASK_STK<span class="token punctuation">[</span>DISPLAY_STK_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>DISPLAY_TASK_PRIO<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//显示任务</span>
	<span class="token function">OSTaskSuspend</span><span class="token punctuation">(</span>OS_PRIO_SELF<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//挂起start_task任务</span>
	<span class="token function">OS_EXIT_CRITICAL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  		<span class="token comment">//开中断</span>
<span class="token punctuation">}</span>

<span class="token comment">//显示地址等信息</span>
<span class="token keyword">void</span> <span class="token function">display_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span> 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_DHCP									</span><span class="token comment">//当开启DHCP的时候</span></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>lwipdev<span class="token punctuation">.</span>dhcpstatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> 			<span class="token comment">//开启DHCP</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">show_address</span><span class="token punctuation">(</span>lwipdev<span class="token punctuation">.</span>dhcpstatus <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//显示地址信息</span>
			<span class="token function">OSTaskSuspend</span><span class="token punctuation">(</span>OS_PRIO_SELF<span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">//显示完地址信息后挂起自身任务</span>
		<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
		<span class="token function">show_address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 						<span class="token comment">//显示静态地址</span>
		<span class="token function">OSTaskSuspend</span><span class="token punctuation">(</span>OS_PRIO_SELF<span class="token punctuation">)</span><span class="token punctuation">;</span> 			<span class="token comment">//显示完地址信息后挂起自身任务</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//LWIP_DHCP</span></span>
		<span class="token function">OSTimeDlyHMSM</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//led任务</span>
<span class="token keyword">void</span> <span class="token function">led_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		LED0 <span class="token operator">=</span> <span class="token operator">!</span>LED0<span class="token punctuation">;</span>
		<span class="token function">OSTimeDlyHMSM</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//延时500ms</span>
 	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="NETCONN_1653"></a>三、NETCONN接口编程</h2> 
<p>  使用 NETCONN API 时需要有操作系统的支持</p> 
<h3><a id="31__pbuf_1655"></a>3.1 pbuf结构</h3> 
<p>  lwIP 使用 pbuf 对数据进行发送与接收，灵活的 pbuf 结构体使得数据在不同层之间传输时可以减少内存的开销以及减少内存复制所占用的时间，一切都是为了节约内存，提高数据在不同层之间传递的速度。lwIP 源码中的 pbuf.c 和 pbuf.h 这两个文件就是关于 pbuf 的，pbuf 结构如下源码所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token punctuation">{<!-- --></span>
 	<span class="token comment">/* pbuf 链表中指向下一个 pbuf 结构 */</span>
 	<span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
 	<span class="token comment">/* 数据指针，指向该 pbuf 所记录的数据区域 */</span>
 	<span class="token keyword">void</span> <span class="token operator">*</span>payload<span class="token punctuation">;</span>
 	<span class="token comment">/* 当前 pbuf 及后续所有 pbuf 中所包含的数据总长度 */</span>
 	<span class="token class-name">u16_t</span> tot_len<span class="token punctuation">;</span>
 	<span class="token comment">/* 当前 pbuf 中数据的长度 */</span>
 	<span class="token class-name">u16_t</span> len<span class="token punctuation">;</span>
 	<span class="token comment">/* 当前 pbuf 的类型 */</span>
 	<span class="token class-name">u8_t</span> type<span class="token punctuation">;</span>
 	<span class="token comment">/* 状态位未用到 */</span>
 	<span class="token class-name">u8_t</span> flags<span class="token punctuation">;</span>
 	<span class="token comment">/* 指向该 pbuf 的指针数，即该 pbuf 被引用的次数 */</span>
 	LWIP_PBUF_REF_T ref<span class="token punctuation">;</span>
 	<span class="token comment">/* 对于传入的数据包，它包含输入 netif 的索引 */</span>
	<span class="token class-name">u8_t</span> if_idx<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>pbuf 结构体具有多个字段，这些字段的作用如下所示：<br> <img src="https://images2.imgbox.com/c5/c1/zhOela3B_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32__netbuf_1681"></a>3.2 netbuf数据缓冲区</h3> 
<p>  在前面我们讲过了描述数据包的 pbuf 结构，netbuf 是 NETCONN 编程 API 接口使用的描述数据包的结构，我们可以使用 netbuf 来管理发送数据、接收数据的缓冲区。有关 netbuf 的详细描述在netbuf.c 和 netbuf.h 这两个文件中，netbuf 是一个结构体，它在 netbuf.h 中定义了这个结构体，代码如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/* 网络缓冲区包含数据和寻址信息 */</span>
<span class="token keyword">struct</span> <span class="token class-name">netbuf</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* p 字段的指针指向 pbuf 链表 */</span>
 	<span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
 	<span class="token class-name">ip_addr_t</span> addr<span class="token punctuation">;</span> <span class="token comment">/* 记录了数据发送方的 IP 地址 */</span>
 	<span class="token class-name">u16_t</span> port<span class="token punctuation">;</span> <span class="token comment">/* 记录了数据发送方的端口号 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>  其中 p 和 ptr 都指向 pbuf 链表，不同的是 p 一直指向 pbuf 链表的第一个 pbuf 结构，而 ptr 可能指向链表中其他的位置，lwIP 提供的 netbuf_next 和 netbuf_first 函数都是操作 ptr 字段的。addr 和 port 字段用来记录数据发送方的 IP 地址和端口号，lwIP 提供的netbuf_fromaddr 和 netbuf_fromport 函数用于返回 addr 和 port 这两个字段。netbuf和pbuf之间的关系如图所示:<br> <img src="https://images2.imgbox.com/1f/39/jGHuZvtX_o.png" alt="在这里插入图片描述"><br>   不管是 TCP 连接还是 UDP 连接，接收到数据包后会将数据封装在一个 netbuf 中，然后将这个 netbuf 交给应用程序去处理。在数据发送时，根据不同的连接有不同的处理：对于 TCP连接，用户只需要提供待发送数据的起始地址和长度，内核会根据实际情况将数据封装在合适大小的数据包中，并放入发送队列中，对于 UDP 来说，用户需要自行将数据封装在 netbuf 结构中，当发送函数被调用的时候内核直接将数据包中的数据发送出去。<br>   在 netbuf.c 中提供了几个操作 netbuf 的函数，如下表所示：<br> <img src="https://images2.imgbox.com/5e/55/2QW5q0wn_o.png" alt="在这里插入图片描述"><br> <strong>注意</strong>：用户使用 NETCONN 编程 API 接口时必须在 lwipopts.h 把 LWIP_NETCONN 配置项设置为 1 启动 NETCONN 编程 API 接口。</p> 
<h3><a id="33_netconn_1699"></a>3.3 netconn连接结构</h3> 
<p>  NETCONN 对于UDP 和 TCP这两种连接提供了统一的编程接口，用于使用同一的连接结构和编程函数，在 api.h 中定了 netcon 结构体，代码如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/* netconn 描述符 */</span>
<span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token punctuation">{<!-- --></span>
 	<span class="token comment">/* 连接类型，TCP UDP 或者 RAW */</span>
 	<span class="token keyword">enum</span> <span class="token class-name">netconn_type</span> type<span class="token punctuation">;</span>
 	<span class="token comment">/* 当前连接状态 */</span>
 	<span class="token keyword">enum</span> <span class="token class-name">netconn_state</span> state<span class="token punctuation">;</span>
 	<span class="token comment">/* 内核中与连接相关的控制块指针 */</span>
 	<span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
 		<span class="token keyword">struct</span> <span class="token class-name">ip_pcb</span> <span class="token operator">*</span>ip<span class="token punctuation">;</span> <span class="token comment">/* IP 控制块 */</span>
 		<span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span> <span class="token operator">*</span>tcp<span class="token punctuation">;</span> <span class="token comment">/* TCP 控制块 */</span>
 		<span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>udp<span class="token punctuation">;</span> <span class="token comment">/* UDP 控制块 */</span>
 		<span class="token keyword">struct</span> <span class="token class-name">raw_pcb</span> <span class="token operator">*</span>raw<span class="token punctuation">;</span> <span class="token comment">/* RAW 控制块 */</span>
	<span class="token punctuation">}</span> pcb<span class="token punctuation">;</span>
	<span class="token comment">/* 这个 netconn 最后一个异步未报告的错误 */</span>
 	<span class="token class-name">err_t</span> pending_err<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>LWIP_NETCONN_SEM_PER_THREAD</span></span>
 	<span class="token comment">/* 用于两部分 API 同步的信号量 */</span>
 	<span class="token class-name">sys_sem_t</span> op_completed<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 	<span class="token comment">/* 接收数据的邮箱 */</span>
 	<span class="token class-name">sys_mbox_t</span> recvmbox<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
 	<span class="token comment">/* 用于 TCP 服务器端，连接请求的缓冲队列*/</span>
 	<span class="token class-name">sys_mbox_t</span> acceptmbox<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>
 	<span class="token comment">/* Socket 描述符，用于 Socket API */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SOCKET</span></span>
 <span class="token keyword">int</span> Socket<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SOCKET */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_SO_RCVTIMEO</span></span>
 	<span class="token comment">/* 接收数据时的超时时间*/</span>
 	<span class="token class-name">u32_t</span> recv_timeout<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_SO_RCVTIMEO */</span></span>
 	<span class="token comment">/* 标识符 */</span>
 	<span class="token class-name">u8_t</span> flags<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LWIP_TCP</span></span>
 <span class="token comment">/* TCP:当传递到 netconn_write 的数据不适合发送缓冲区时，
 	这将临时存储消息。
 	也用于连接和关闭。 */</span>
 	<span class="token keyword">struct</span> <span class="token class-name">api_msg</span> <span class="token operator">*</span>current_msg<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* LWIP_TCP */</span></span>
 	<span class="token comment">/* 连接相关回调函数，实现 Socket API 时使用 */</span>
 	netconn_callback callback<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>  在 api.h 文件中还定义了连接状态和连接类型，这两个都是枚举类型</p> 
<pre><code class="prism language-c"><span class="token comment">/* 枚举类型，用于描述连接类型 */</span>
<span class="token keyword">enum</span> <span class="token class-name">netconn_type</span> <span class="token punctuation">{<!-- --></span>
 	NETCONN_INVALID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">/* 无效类型 */</span>
 	NETCONN_TCP <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token comment">/* TCP */</span>
 	NETCONN_UDP <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token comment">/* UDP */</span>
 	NETCONN_UDPLITE <span class="token operator">=</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token comment">/* UDPLite */</span>
 	NETCONN_UDPNOCHKSUM <span class="token operator">=</span> <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token comment">/* 无校验 UDP */</span>
 	NETCONN_RAW <span class="token operator">=</span> <span class="token number">0x40</span> <span class="token comment">/* 原始链接 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* 枚举类型，用于描述连接状态，主要用于 TCP 连接中 */</span>
<span class="token keyword">enum</span> <span class="token class-name">netconn_state</span>
<span class="token punctuation">{<!-- --></span>
 	NETCONN_NONE<span class="token punctuation">,</span> <span class="token comment">/* 不处于任何状态 */</span>
 	NETCONN_WRITE<span class="token punctuation">,</span> <span class="token comment">/* 正在发送数据 */</span>
 	NETCONN_LISTEN<span class="token punctuation">,</span> <span class="token comment">/* 侦听状态 */</span>
 	NETCONN_CONNECT<span class="token punctuation">,</span> <span class="token comment">/* 连接状态 */</span>
 	NETCONN_CLOSE <span class="token comment">/* 关闭状态 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="34_netconnAPI_1771"></a>3.4 netconn编程API函数</h3> 
<p>  本节我们就讲解一下 NETCONN 编程的 API 函数，这些函数在 api_lib.c 文件中实现的,其中这个文件包含了很多 netconn 接口的函数，它们大部分是 lwIP 内部调用的，少部分是给用户使用的，用户能使用的函数如下表所示：</p> 
<table><thead><tr><th>函数</th><th>描述</th></tr></thead><tbody><tr><td>netconn_new()</td><td>这个函数其实就是一个宏定义，用来为新连接申请一个连接结构netconn 空间。</td></tr><tr><td>netconn_delete()</td><td>该函数的功能是删除一个 netconn 连接结构。</td></tr><tr><td>netconn_getaddr()</td><td>该函数用来获取一个 netconn 连接结构的源 IP 地址和源端口号或者目的 IP 地址和目的端口号。</td></tr><tr><td>netconn_bind()</td><td>将一个连接结构与本地 IP 地址和端口号进行绑定。</td></tr><tr><td>netconn_connect()</td><td>将一个连接结构与目的 IP 地址和端口号进行绑定。</td></tr><tr><td>netconn_disconnect()</td><td>只能用在 UDP 连接结构中，用来断开与服务器的连接。</td></tr><tr><td>netconn_listen()</td><td>这个函数就是一个宏定义，只在 TCP 服务器程序中使用，用来将连接结构 netconn 置为侦听状态。</td></tr><tr><td>netconn_accept()</td><td>这个函数也只用与 TCP 服务器程序中，服务器调用此函数可以获得一个新的连接。</td></tr><tr><td>netconn_recv()</td><td>从连接的 recvmbox 邮箱中接收数据包，可用于 TCP 连接，也可用于UDP 连接。</td></tr><tr><td>netconn_send()</td><td>用于在已建立的 UDP 连接上发送数据。</td></tr><tr><td>netconn_write()</td><td>用于在稳定的 TCP 连接上发送数据。</td></tr><tr><td>netconn_close()</td><td>关闭一个 TCP 连接。</td></tr></tbody></table> 
<ol><li> <p>netconn_new()函数<br>   netconn_new()函数是函数 netconn_new_with_proto_and_callback()的宏定义，此函数用来为新连接申请一个 netconn 空间，参数为新连接的类型，连接类型在上一节已经讲过了，常用的值是 NETCONN_UDP 和 NETCONN_TCP，分别代表 UDP 连接和 TCP 连接。<br>   系统对 conn 申请内存，如果内存申请成功，则系统构建 API 消息。所谓API 消息，其实就是两个 API 部分的交互的消息，它是由用户的调用 API 函数为起点，使用IPC 通信机制告诉内核需要执行那个部分的 API 函数，netconn_new 函数交互流程如下图所示：<br> <img src="https://images2.imgbox.com/1a/3b/gzKD1aSj_o.png" alt="在这里插入图片描述"></p> </li><li> <p>netconn_delete()函数<br>   netconn_delete()函数用来删除一个 netconn 连接结构，如果函数调用时双方仍然处于连接状态，则相应连接将被关闭：对于 UDP 连接，连接立即被关闭，UDP 控制块被删除；对于 TCP连接，则函数执行主动关闭，内核完成剩余的断开握手过程。</p> </li><li> <p>netconn_getaddr()函数<br>   netconn_getaddr()函数用来获取一个 netconn 连接结构的源 IP 地址和源端口号或者目的 IP地址和目的端口号，IP 地址保存在 addr 中，端口信息保存在 port 中，参数 local 指明是获取源地址还是目的地址，当 local 为 1 时表示本地地址，此函数原型如下</p> </li></ol> 
<pre><code class="prism language-c"><span class="token class-name">err_t</span> <span class="token function">netconn_getaddr</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token operator">*</span>conn<span class="token punctuation">,</span> <span class="token class-name">ip_addr_t</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span><span class="token class-name">u16_t</span> <span class="token operator">*</span>port<span class="token punctuation">,</span> <span class="token class-name">u8_t</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="4"><li>netconn_bind()函数<br>   netconn_bind()函数将一个连接结构与本地 IP 地址 addr 和端口号 port 进行绑定，服务器端程序必须执行这一步，服务器必须与指定的端口号绑定才能结接受客户端的连接请求，函数原型如下</li></ol> 
<pre><code class="prism language-c"><span class="token class-name">err_t</span> <span class="token function">netconn_bind</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token operator">*</span>conn<span class="token punctuation">,</span> <span class="token class-name">ip_addr_t</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">u16_t</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="5"><li>netconn_connect()函数<br>   netconn_connect()函数的功能是连接服务器，将指定的连接结构与目的 IP 地址 addr 和目的端口号 port 进行绑定，当作为 TCP 客户端程序时，调用此函数会产生握手过程，函数原型如下</li></ol> 
<pre><code class="prism language-c"><span class="token class-name">err_t</span> <span class="token function">netconn_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token operator">*</span>conn<span class="token punctuation">,</span> <span class="token class-name">ip_addr_t</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">u16_t</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="6"><li>netconn_disconnect()函数<br>   netconn_disconnect()函数只能使用在 UDP 连接中，功能是断开与服务器的连接。对于 UDP连接来说就是将 UDP 控制块中的 remote_ip 和 remote_port 字段值清零，函数原型如下</li></ol> 
<pre><code class="prism language-c"><span class="token class-name">err_t</span> <span class="token function">netconn_disconnect</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token operator">*</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="7"><li>netconn_listen()函数<br>   netconn_listen()函数只有在 TCP 服务器程序中使用，将一个连接结构 netconn 设置为侦听状态，既将 TCP 控制块的状态设置为 LISTEN 状态。</li><li>netconn_accept()函数<br>   netconn_accept()函数也只用于 TCP 服务器程序，服务器调用此函数可以从 acceptmbox 邮箱中获取一个新建立的连接，若邮箱为空，则函数会一直阻塞，直到新连接的到来。服务器端调用此函数前必须先调用 netconn_listen()函数将连接设置为侦听状态，函数原型如下</li></ol> 
<pre><code class="prism language-c"><span class="token class-name">err_t</span> <span class="token function">netconn_accept</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token operator">*</span>conn<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token operator">*</span><span class="token operator">*</span>new_conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="9"><li>netconn_recv()函数<br>    netconn_recv()函数是从连接的 recvmbox 邮箱中接收数据包，可用于 TDP 连接，也可用于UDP 连接，函数会一直阻塞，直到从邮箱中获得数据消息，数据被封装在 netbuf 中。如果从邮箱中接收到一条空消息，表示对方已经关闭当前的连接，应用程序也应该关闭这个无效的连接，函数原型如下</li></ol> 
<pre><code class="prism language-c"><span class="token class-name">err_t</span> <span class="token function">netconn_recv</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token operator">*</span>conn<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">netbuf</span> <span class="token operator">*</span><span class="token operator">*</span>new_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="10"><li>netconn_send()函数<br>   netconn_send()函数用于在 UDP 连接上发送数据，参数 conn 指出了要操作的连接，参数 buf为要发送的数据，数据被封装在 netbuf 中。如果 IP 层分片功能未使能，则 netbuf 中的数据不能太长，不能超过 MTU 的值，最好不要超过 1000 字节。如果 IP 层分片功能使能的情况下就可以忽略此细节，函数原型如下：</li></ol> 
<pre><code class="prism language-c"><span class="token class-name">err_t</span> <span class="token function">netconn_send</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token operator">*</span>conn<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">netbuf</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="11"><li>netconn_write()函数<br>   netconn_write()函数用于在稳定的 TCP 连接上发送数据，参数 dataptr 和 size 分别指出了待发送数据的起始地址和长度，函数并不要求用户将数据封装在 netbuf 中，对于数据长度也没有限制，内核会直接处理这些数据，将他们封装在 pbuf 中，并挂接到 TCP 的发送队列中</li><li>netconn_close()函数<br>   netconn_close()函数用来关闭一个 TCP 连接，该函数会产生一个 FIN 握手包的发送，成功后函数便返回，而后剩余的断开握手操作由内核自动完成，用户程序不用关心，该函数只是断开一个连接，但不会删除连接结构 netconn，用户需要调用 netconn_delete()函数来删除连接结构，否则会造成内存泄漏，函数原型如下</li></ol> 
<pre><code class="prism language-c"><span class="token class-name">err_t</span> <span class="token function">netconn_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token operator">*</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="Socket_1854"></a>四、Socket接口编程</h2> 
<h2><a id="HTTP_1855"></a>五、HTTP协议</h2> 
<h2><a id="MQTT_1856"></a>六、MQTT协议</h2>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a00d5adb86120fcb17a49ad7720cfaed/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">element ui 之 el-table 的多列排序，带清除排序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fa3f548555a2102fb733e46d76bde728/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">交叉编译、gcc编译与Makefile</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>