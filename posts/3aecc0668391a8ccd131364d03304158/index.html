<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>响应式圣经：10W字，实现Spring响应式编程自由 - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="响应式圣经：10W字，实现Spring响应式编程自由" />
<meta property="og:description" content="前言 全链路异步化改造的基础是响应式编程 随着业务的发展，微服务应用的流量越来越大，使用到的资源也越来越多。
在微服务架构下，大量的应用都是 SpringCloud 分布式架构，这种架构总体上是全链路同步模式。
全链路同步模式不仅造成了资源的极大浪费，并且在流量发生激增波动的时候，受制于系统资源而无法快速的扩容。
全球后疫情时代，降本增效是大背景。如何降本增效？
可以通过技术升级，全链路同步模式 ，升级为 全链路异步模式。
先回顾一下全链路同步模式架构图
全链路同步模式 ，如何升级为 全链路异步模式， 就是一个一个 环节的异步化。
40岁老架构师尼恩，持续深化自己的3高架构知识宇宙，当然首先要去完成一次牛逼的全链路异步模式 微服务实操，下面是尼恩的实操过程、效果、压测数据(性能足足提升10倍多)。
全链路异步模式改造 具体的内容，请参考尼恩的深度文章：全链路异步，让你的 SpringCloud 性能优化10倍&#43;
并且，上面的文章，作为尼恩 全链路异步的架构知识，收录在《尼恩Java面试宝典》V46版的架构专题中
全链路异步化改造，性能提升十倍是大好事，那么，全链路同步模式改造的问题是什么呢？
全链路异步化改造的技术基础，是响应式编程，关键问题在于： 响应式编程的知识太难。
古语说： 蜀道难难于上青天。
很多小伙伴认为： 响应式编程， 比蜀道还难？
所以，40岁老架构师 使用20年的编程功力，给大家呈上一篇， 学习响应式编程 的超级长文，也是一篇超级、超级详细，超级超级全面，并且不断迭代的文章：
《响应式圣经：10W字实现响应式编程自由》
此文，目前为V2版本，新版本是基于V1老版本是尼恩之前写的一篇深受好评的博客文章
Flux、Mono、Reactor 实战（史上最全）
后续，尼恩会一直不断迭代， 为大家拉涅出一本史上最棒的 《响应式圣经》 ，帮助大家实现响应式编程自由。
从此： 蜀道，不再难。
注：本文以 PDF 持续更新，最新尼恩 架构笔记、面试题 的PDF文件，请从这里获取：码云
Reactive programming 响应式编程概述 背景知识 为了应对高并发服务器端开发场景，在2009 年，微软提出了一个更优雅地实现异步编程的方式——Reactive Programming，我们称之为响应式编程。
随后，Netflix 和LightBend 公司提供了RxJava 和Akka Stream 等技术，使得Java 平台也有了能够实现响应式编程的框架。
在2017 年9 月28 日，Spring 5 正式发布。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/3aecc0668391a8ccd131364d03304158/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-14T11:31:38+08:00" />
<meta property="article:modified_time" content="2023-02-14T11:31:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">响应式圣经：10W字，实现Spring响应式编程自由</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_2"></a>前言</h3> 
<h3><a id="_4"></a>全链路异步化改造的基础是响应式编程</h3> 
<p>随着业务的发展，微服务应用的流量越来越大，使用到的资源也越来越多。</p> 
<p>在微服务架构下，大量的应用都是 SpringCloud 分布式架构，这种架构总体上是<strong>全链路同步模式</strong>。</p> 
<p><strong>全链路同步模式</strong>不仅造成了资源的极大浪费，并且在流量发生激增波动的时候，受制于系统资源而无法快速的扩容。</p> 
<p>全球后疫情时代，降本增效是大背景。如何降本增效？</p> 
<p>可以通过技术升级，<strong>全链路同步模式</strong> ，升级为 <strong>全链路异步模式</strong>。</p> 
<p>先回顾一下全链路同步模式架构图</p> 
<p><img src="https://images2.imgbox.com/8b/db/wB7j1e3f_o.png" alt=""></p> 
<p><strong>全链路同步模式</strong> ，如何升级为 <strong>全链路异步模式</strong>， 就是一个一个 环节的异步化。</p> 
<p>40岁老架构师尼恩，持续深化自己的3高架构知识宇宙，当然首先要去完成一次牛逼的<strong>全链路异步模式 微服务实操，下面是尼恩的实操过程、效果、压测数据(性能足足提升10倍多)。</strong></p> 
<p><strong>全链路异步模式</strong>改造 具体的内容，请参考尼恩的深度文章：<a href="https://blog.csdn.net/crazymakercircle/article/details/129004814">全链路异步，让你的 SpringCloud 性能优化10倍+</a></p> 
<p>并且，上面的文章，作为尼恩 全链路异步的架构知识，收录在《<a href="https://blog.csdn.net/crazymakercircle/article/details/124790425">尼恩Java面试宝典</a>》V46版的架构专题中</p> 
<p><strong>全链路异步化改造，性能提升十倍是大好事，那么，全链路同步模式改造的问题是什么呢？</strong></p> 
<p>全链路异步化改造的技术基础，是响应式编程，关键问题在于： <strong>响应式编程的知识太难</strong>。</p> 
<p>古语说： 蜀道难难于上青天。</p> 
<p>很多小伙伴认为： 响应式编程， 比蜀道还难？</p> 
<p>所以，40岁老架构师 使用20年的编程功力，给大家呈上一篇， 学习响应式编程 的超级长文，也是一篇超级、超级详细，超级超级全面，并且不断迭代的文章：</p> 
<p><strong>《响应式圣经：10W字实现响应式编程自由》</strong></p> 
<img src="https://images2.imgbox.com/42/aa/TerUMPzz_o.png" width="400"> 
<p>此文，目前为V2版本，新版本是基于V1老版本是尼恩之前写的一篇深受好评的博客文章</p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/124120506">Flux、Mono、Reactor 实战（史上最全）</a></p> 
<p>后续，尼恩会一直不断迭代， 为大家拉涅出一本史上最棒的 <strong>《响应式圣经》</strong> ，帮助大家实现响应式编程自由。</p> 
<p><strong>从此： 蜀道，不再难。</strong></p> 
<blockquote> 
 <p>注：本文以 PDF 持续更新，最新尼恩 架构笔记、面试题 的PDF文件，请从这里获取：<a href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/%E7%96%AF%E7%8B%82%E5%88%9B%E5%AE%A2%E5%9C%88%E6%80%BB%E7%9B%AE%E5%BD%95.md" rel="nofollow">码云</a></p> 
</blockquote> 
<hr> 
<h3><a id="Reactive_programming__60"></a>Reactive programming 响应式编程概述</h3> 
<h4><a id="_62"></a>背景知识</h4> 
<p>为了应对高并发服务器端开发场景，在2009 年，微软提出了一个更优雅地实现异步编程的方式——Reactive Programming，我们称之为响应式编程。</p> 
<p>随后，Netflix 和LightBend 公司提供了RxJava 和Akka Stream 等技术，使得Java 平台也有了能够实现响应式编程的框架。</p> 
<p>在2017 年9 月28 日，Spring 5 正式发布。</p> 
<p>Spring 5 发布最大的意义在于，它将响应式编程技术的普及向前推进了一大步。</p> 
<p>而同时，作为在背后支持Spring 5 响应式编程的框架Spring Reactor，也进入了里程碑式的3.1.0 版本。</p> 
<h4><a id="_74"></a>什么是响应式编程</h4> 
<p>响应式编程是一种面向数据流和变化传播的编程范式。</p> 
<p>这意味着可以在编程语言中很方便地表达静态或动态的数据流，而相关的计算模型会自动将变化的值通过数据流进行传播。</p> 
<p>响应式编程基于reactor（Reactor 是一个运行在 Java8 之上的响应式框架）的思想，当你做一个带有一定延迟的才能够返回的io操作时，不会阻塞，而是立刻返回一个流，并且订阅这个流，当这个流上产生了返回数据，可以立刻得到通知并调用回调函数处理数据。</p> 
<p>电子表格程序就是响应式编程的一个例子。有些单元个含有公式，比如可以包含字面值或类似"=B1+C1"的公式，这些单元格的值，会依据其他单元格的值的变化而变化。</p> 
<p>响应式传播核心特点之一：变化传播。</p> 
<p>一个单元格变化之后，会像多米诺骨牌一样，导致直接和间接引用它的其他单元格均发生相应变化。</p> 
<h4><a id="API_Reactive_programming__88"></a>从API视角，看什么是 Reactive programming 响应式编程</h4> 
<p>有了 Reactive Streams 这种标准和规范，利用规范可以进行响应式编程。</p> 
<p>那再了解下什么是 Reactive programming 响应式编程。</p> 
<p>响应式编程是基于异步和事件驱动的非阻塞程序，只是垂直通过在 JVM 内启动少量线程扩展，而不是水平通过集群扩展。</p> 
<p>异步调用 +IO Reactor 事件驱动，可以避免将 CPU 浪费在等待网络 IO 和磁盘 IO 时上，实现提高资源使用率。</p> 
<p>Reactive programming就是一个编程范例，具体项目中如何体现呢？</p> 
<p>响应式项目编程实战中，通过基于 Reactive Streams 规范实现的框架Spring Reactor 去实战。</p> 
<p>Spring Reactor 一般提供两种响应式 API ：</p> 
<ul><li><code>Mono</code>：实现发布者，并返回 0 或 1 个元素</li><li><code>Flux</code>：实现发布者，并返回 N 个元素</li></ul> 
<h4><a id="_107"></a>响应式编程-&gt;异步非阻塞</h4> 
<p>上面讲了响应式编程是什么：</p> 
<blockquote> 
 <p>响应式编程（reactive programming）是一种基于数据流（data stream）和变化传递（propagation of change）的声明式（declarative）的编程范式</p> 
</blockquote> 
<p>也讲解了数据流/变化传递/声明式是什么意思，但说到响应式编程就离不开<strong>异步非阻塞</strong>。</p> 
<p>从Spring官网介绍WebFlux的信息我们就可以发现<code>asynchronous, nonblocking</code> 这样的字样，因为<strong>响应式编程它是异步</strong>的，也可以理解成<strong>变化传递</strong>它是异步执行的。</p> 
<h4><a id="Java8_119"></a>基于Java8观察者模式</h4> 
<p>Observable类：此类表示可观察对象，或模型视图范例中的“数据”。</p> 
<p>它可以被子类实现以表示应用程序想要观察的对象。</p> 
<pre><code class="prism language-java"><span class="token comment">//想要观察的对象 ObserverDemo</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObserverDemo</span> <span class="token keyword">extends</span> <span class="token class-name">Observable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ObserverDemo</span> observerDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObserverDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加观察者</span>
        observerDemo<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据发生变化A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        observerDemo<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据发生变化B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        observerDemo<span class="token punctuation">.</span><span class="token function">setChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将此Observable对象标记为已更改</span>
        observerDemo<span class="token punctuation">.</span><span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果该对象发生了变化，则通知其所有观察者</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动程序测试：</p> 
<p><img src="https://images2.imgbox.com/fb/42/E1ysRSw0_o.png" alt=""></p> 
<h4><a id="Observable_149"></a>创建一个Observable</h4> 
<p>rxjava中，可以使用Observable.create() 该方法接收一个Obsubscribe对象</p> 
<pre><code class="prism language-java"><span class="token class-name">Observable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> observable <span class="token operator">=</span> <span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Observable<span class="token punctuation">.</span>OnSubscribe</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Subscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>来个大点的例子：</p> 
<pre><code class="prism language-java"><span class="token class-name">Observable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> observable<span class="token operator">=</span><span class="token class-name">Observable</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Observable<span class="token punctuation">.</span>OnSubscribe</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Subscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            subscriber<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        subscriber<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//Observable.subscribe(Observer)，Observer订阅了Observable</span>
<span class="token class-name">Subscription</span> subscribe <span class="token operator">=</span> observable<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> integer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"接收Obsverable中发射的值："</span> <span class="token operator">+</span> integer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">接收Obsverable中发射的值：0
接收Obsverable中发射的值：1
接收Obsverable中发射的值：2
接收Obsverable中发射的值：3
接收Obsverable中发射的值：4
</code></pre> 
<p>从上面的例子可以看出，在Observer订阅了Observable后，</p> 
<p>Observer作为OnSubscribe中call方法的参数传入，从而调用了Observer的相关方法</p> 
<h4><a id="_Reactor__210"></a>基于 Reactor 实现</h4> 
<p>Reactor 是一个运行在 Java8 之上满足 Reactice 规范的响应式框架，它提供了一组响应式风格的 API。</p> 
<p>Reactor 有两个核心类： <code>Flux&lt;T&gt;</code> 和 <code>Mono&lt;T&gt;</code>，这两个类都实现 Publisher 接口。</p> 
<ul><li>Flux 类似 RxJava 的 Observable，它可以触发零到多个事件，并根据实际情况结束处理或触发错误。</li><li>Mono 最多只触发一个事件，所以可以把 Mono 用于在异步任务完成时发出通知。</li></ul> 
<p><img src="https://images2.imgbox.com/99/42/Hzl2GAcg_o.png" alt="preview"></p> 
<p>Flux 和 Mono 都是数据流的发布者，使用 Flux 和 Mono 都可以发出三种数据信号：元素值，错误信号，完成信号；错误信号和完成信号都代表终止信号，终止信号用于告诉订阅者数据流结束了，错误信号终止数据流同时把错误信息传递给订阅者。</p> 
<p>三种信号的特点：</p> 
<ul><li>错误信号和完成信号都是终止信号，不能共存</li><li>如果没有发送任何元素值，而是直接发送错误或者完成信号，表示是空数据流</li><li>如果没有错误信号，也没有完成信号，表示是无限数据流</li></ul> 
<h5><a id="_229"></a>引入依赖</h5> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectreactor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>reactor-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="just__subscribe_238"></a>just 和 subscribe方法</h5> 
<p>just()：创建Flux序列，并声明指定数据流</p> 
<p>subscribe()：订阅Flux序列，只有进行订阅后才回触发数据流，不订阅就什么都不会发生</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestReactor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//just()：创建Flux序列，并声明数据流，</span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> integerFlux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//整形</span>
        <span class="token comment">//subscribe()：订阅Flux序列，只有进行订阅后才回触发数据流，不订阅就什么都不会发生</span>
        integerFlux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringFlux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//字符串</span>
        stringFlux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//fromArray(),fromIterable()和fromStream()：可以从一个数组、Iterable 对象或Stream 对象中创建Flux序列</span>
        <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromArray</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> integers <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span>integers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span> integers<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromStream</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动测试：</p> 
<img src="https://images2.imgbox.com/90/e8/zanmsRd8_o.png" width="120"> 
<h4><a id="Reactive_Streams_274"></a>Reactive Streams（响应式流）的特点</h4> 
<p>要搞清楚这两个概念，必须说一下响应流规范。</p> 
<p>它是响应式编程的基石。他具有以下特点：</p> 
<ul><li>响应流必须是无阻塞的。</li><li>响应流必须是一个数据流。</li><li>它必须可以异步执行。</li><li>并且它也应该能够处理背压。</li><li><strong>即时响应性:</strong><br> 只要有可能， <a href="https://www.reactivemanifesto.org/zh-CN/glossary#System" rel="nofollow">系统</a>就会及时地做出响应。 即时响应是可用性和实用性的基石， 而更加重要的是，即时响应意味着可以快速地检测到问题并且有效地对其进行处理。 即时响应的系统专注于提供快速而一致的响应时间， 确立可靠的反馈上限， 以提供一致的服务质量。 这种一致的行为转而将简化错误处理、 建立最终用户的信任并促使用户与系统作进一步的互动。</li><li><strong>回弹性：</strong><br> 系统在出现<a href="https://www.reactivemanifesto.org/zh-CN/glossary#Failure" rel="nofollow">失败</a>时依然保持即时响应性。 这不仅适用于高可用的、 任务关键型系统——任何不具备回弹性的系统都将会在发生失败之后丢失即时响应性。 回弹性是通过<a href="https://www.reactivemanifesto.org/zh-CN/glossary#Replication" rel="nofollow">复制</a>、 遏制、 <a href="https://www.reactivemanifesto.org/zh-CN/glossary#Isolation" rel="nofollow">隔离</a>以及<a href="https://www.reactivemanifesto.org/zh-CN/glossary#Delegation" rel="nofollow">委托</a>来实现的。 失败的扩散被遏制在了每个<a href="/glossary.zh-cn.md#%E7%BB%84%E4%BB%B6" rel="nofollow">组件</a>内部， 与其他组件相互隔离， 从而确保系统某部分的失败不会危及整个系统，并能独立恢复。 每个组件的恢复都被委托给了另一个（外部的）组件， 此外，在必要时可以通过复制来保证高可用性。 （因此）组件的客户端不再承担组件失败的处理。</li><li><strong>弹性：</strong><br> 系统在不断变化的工作负载之下依然保持即时响应性。 反应式系统可以对输入（负载）的速率变化做出反应，比如通过增加或者减少被分配用于服务这些输入（负载）的<a href="https://www.reactivemanifesto.org/zh-CN/glossary#Resource" rel="nofollow">资源</a>。 这意味着设计上并没有争用点和中央瓶颈， 得以进行组件的分片或者复制， 并在它们之间分布输入（负载）。 通过提供相关的实时性能指标， 反应式系统能支持预测式以及反应式的伸缩算法。 这些系统可以在常规的硬件以及软件平台上实现成本高效的<a href="https://www.reactivemanifesto.org/zh-CN/glossary#Elasticity" rel="nofollow">弹性</a><a href="https://www.reactivemanifesto.org/zh-CN/glossary#Elasticity" rel="nofollow">。</a></li><li><strong>消息驱动：</strong><br> 反应式系统依赖异步的、消息传递，从而确保了松耦合、隔离、<a href="https://www.reactivemanifesto.org/zh-CN/glossary#Location-Transparency" rel="nofollow">位置透明</a>的组件之间有着明确边界。<br> 这一边界还提供了将<a href="https://www.reactivemanifesto.org/zh-CN/glossary#Failure" rel="nofollow">失败</a>作为消息委托出去的手段。<br> 使用显式的消息传递，可以通过在系统中塑造并监视消息流队列， 并在必要时应用<a href="https://www.reactivemanifesto.org/zh-CN/glossary#Back-Pressure" rel="nofollow">回压</a>， 从而实现负载管理、 弹性以及流量控制。<br> 使用位置透明的消息传递作为通信的手段， 使得跨集群或者在单个主机中使用相同的结构成分和语义来管理失败成为了可能。<br> <a href="https://www.reactivemanifesto.org/zh-CN/glossary#Non-Blocking" rel="nofollow">非阻塞的</a>通信使得接收者可以只在活动时才消耗<a href="https://www.reactivemanifesto.org/zh-CN/glossary#Resource" rel="nofollow">资源</a>， 从而减少系统开销。</li></ul> 
<h4><a id="Reactive_Streams_299"></a>Reactive Streams（响应式流）的过程</h4> 
<p><strong>一般由以下组成：</strong></p> 
<p>一般由以下组成：</p> 
<ul><li><code>publisher</code>：发布者，发布元素到订阅者</li><li><code>subscriber</code>：订阅者，消费元素</li><li><code>subscription</code>：订阅，在发布者中，订阅被创建时，将与订阅者共享</li><li><code>processor</code>：处理器，发布者与订阅者之间处理数据，包含了发布者与订阅者的共同体</li></ul> 
<p><strong>publisher接口规范</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Publisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>   
 <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Subscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加订阅者</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>subscriber接口规范</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Subscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span> 

    <span class="token keyword">void</span> <span class="token function">onSubscribe</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">T</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token keyword">void</span> <span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>subscription接口规范</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{<!-- --></span>   
    <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token keyword">long</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>processor接口规范</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Processor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Subscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Publisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Reactor__349"></a>Reactor 流框架的组件和使用</h3> 
<ul><li>Reactor 框架是 Pivotal 公司（开发 Spring 等技术的公司）开发的</li><li>实现了 Reactive Programming 思想，符合Reactive Streams 规范（Reactive Streams 是由 Netflix、TypeSafe、Pivotal 等公司发起的）的一项技术</li><li>侧重于server端的响应式编程框架</li><li>Reactor 框架主要有两个主要的模块：reactor-core 和 reactor-ipc。前者主要负责 Reactive Programming 相关的核心 API 的实现，后者负责高性能网络通信的实现，目前是基于 Netty 实现的。</li></ul> 
<h5><a id="Java_356"></a>Java原有的异步编程方式</h5> 
<ul><li><code>Callback</code>：异步方法采用一个callback作为参数，当结果出来后回调这个callback，例如swings的EventListener</li><li><code>Future</code>：异步方法返回一个<code>Future&lt;T&gt;</code>，此时结果并不是立刻可以拿到，需要处理结束之后才可以使用</li></ul> 
<p><strong>Future局限</strong></p> 
<ul><li>多个Future组合不易</li><li>调用Future#get时仍然会阻塞</li><li>缺乏对多个值以及进一步的出错处理</li></ul> 
<h5><a id="ReactorPublisher_367"></a>Reactor的Publisher</h5> 
<ul><li><code>Mono </code>实现了 org.reactivestreams.Publisher 接口，代表0到1个元素的响应式序列。</li><li><code>Flux </code>同样实现了 org.reactivestreams.Publisher 接口，代表0到N个元素的结果。</li></ul> 
<h4><a id="PublisherFluxMono__374"></a>Publisher/Flux和Mono 三大流</h4> 
<p>由于响应流的特点，我们不能再返回一个简单的<strong>POJO</strong>对象来表示结果了。</p> 
<p>必须返回一个类似<strong>Java</strong>中的<code>Future</code>的概念，在有结果可用时通知消费者进行消费响应。</p> 
<p><strong>Reactive Stream</strong>规范中这种被定义为<code>Publisher&lt;T&gt;</code></p> 
<h4><a id="Publisher___382"></a>Publisher 发射着基础类</h4> 
<p><code>Publisher&lt;T&gt;</code>是一个可以提供0-N个序列元素的提供者，并根据其订阅者<code>Subscriber&lt;? super T&gt;</code>的需求推送元素。</p> 
<p>一个<code>Publisher&lt;T&gt;</code>可以支持多个订阅者，并可以根据订阅者的逻辑进行推送序列元素。</p> 
<p>下面这个<strong>Excel</strong>计算就能说明一些<code>Publisher&lt;T&gt;</code>的特点。</p> 
<p><img src="https://images2.imgbox.com/23/b9/IJuAIlv7_o.png" alt=""></p> 
<p><strong>A1-A9</strong>就可以看做<code>Publisher&lt;T&gt;</code>及其提供的元素序列。</p> 
<p><strong>A10-A13</strong>分别是求和函数<code>SUM(A1:A9)</code>、平均函数<code>AVERAGE(A1:A9)</code>、最大值函数<code>MAX(A1:A9)</code>、最小值函数<code>MIN(A1:A9)</code>，</p> 
<p><strong>A10-A13</strong>可以看作订阅者<code>Subscriber</code>。</p> 
<p>假如说我们没有<strong>A10-A13</strong>，那么<strong>A1-A9</strong>就没有实际意义，它们并不产生 计算。</p> 
<p>这也是响应式的一个重要特点：<strong>当没有订阅时发布者什么也不做</strong>。</p> 
<p>而Flux和Mono都是<code>Publisher&lt;T&gt;</code>在<strong>Reactor 3</strong> 实现类。</p> 
<p><code>Publisher&lt;T&gt;</code>提供了<code>subscribe</code>方法，允许增加订阅的消费者，订阅之后，消费者在有结果可用时进行消费。</p> 
<p>如果没有消费者，<code>Publisher&lt;T&gt;</code>不会做任何事情，所以，Publisher根据消费情况进行响应。</p> 
<p><code>Publisher&lt;T&gt;</code>可能返回零或者多个，甚至可能是无限的，为了更加清晰表示期待的结果就引入了两个实现模型Mono和Flux。</p> 
<h4><a id="Publishers___414"></a>深入Publishers 发布者（发射序列）</h4> 
<p>异步处理将I/O或计算与调用该操作的线程进行解耦。</p> 
<p>异步处理返回结果的未来句柄，通常是<code>java.util.concurrent.Future</code>或类似的东西，它返回单个对象，集合或异常。</p> 
<p>使用Java 8或Promise模式，可以设置future的线性链接，以便发出后续的异步请求。 一旦需要条件处理，就必须中断并同步异步流。 尽管这种方法是可行的，但它并未充分利用异步处理的优势。</p> 
<p><code>Publisher&lt;T&gt;</code>支持值甚至是无限流的发射序列，而不仅是单个标量值的发射（如Future那样）。 一旦开始处理流而不是单个值，你将非常感谢这个事实。</p> 
<p>Project Reactor的词汇表使用两种类型：<code>Mono</code> 和<code>Flux</code> ，它们都是发布者。</p> 
<p><code>Mono</code>可以发出0到1个事件，而<code>Flux</code>可以发出0到N个事件。</p> 
<p><code>Publisher&lt;T&gt;</code>不会偏向某些特定的并发性或异步性来源，也不会偏向于在<code>ThreadPool</code>中运行基础代码的执行方式-<strong>同步还是异步</strong>。 作为<code>Publisher&lt;T&gt;</code>的消费者，你将实际的实现留给了生产者，生产者可以在以后修改它而无需修改代码。</p> 
<p><code>Publisher&lt;T&gt;</code>的最后一个关键点是，底层处理不是在获取<code>Publisher&lt;T&gt;</code>时开始的，而是在观察者订阅或向 <code>Publisher&lt;T&gt;</code>发出信号的那一刻开始的。</p> 
<p>这与<code>java.util.concurrent.Future</code>至关重要，后者在创建/获取（created/obtained）时在某个地方启动。 因此，如果没有观察者订阅<code>Publisher&lt;T&gt;</code>，则将不会发生任何事情。</p> 
<h4><a id="Publisher__Iterable_pull__434"></a><strong>Publisher</strong> 和 <strong>Iterable (pull)</strong> 的对比</h4> 
<table><thead><tr><th align="left">event</th><th align="left">Iterable (pull)</th><th align="left">Publisher (push)</th></tr></thead><tbody><tr><td align="left">retrieve data</td><td align="left">T next()</td><td align="left">onNext(T)</td></tr><tr><td align="left">discover error</td><td align="left">throws Exception</td><td align="left">onError(Exception)</td></tr><tr><td align="left">complete</td><td align="left">!hasNext()</td><td align="left">onCompleted()</td></tr></tbody></table> 
<h4><a id="Publisher__444"></a>Publisher 如何使用</h4> 
<p>与发布者合作时，你要做的第一件事就是消费它们。</p> 
<p>消费发布者意味着订阅它。</p> 
<p>这是一个订阅并打印所有发出的项目的示例：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Subscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSubscribe</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        s<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello "</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>该示例打印以下行：</p> 
<pre><code class="prism language-bash">Hello BenHello MichaelHello MarkCompleted
</code></pre> 
<p>你可以看到订阅者（或观察者）收到每个事件的通知，并且还接收到已完成的事件。</p> 
<p><code>Publisher&lt;T&gt;</code>会发出项目（items），直到引发异常或<code>Publisher&lt;T&gt;</code>完成调用<code>onCompleted</code>的发出为止。 在那之后不再发出其他元素。</p> 
<p>对<code>subscribe</code>的调用会注册一个允许取消的<code>Subscription</code>，因此不会接收其他事件。</p> 
<p>一旦订阅者从<code>Publisher&lt;T&gt;</code>中取消订阅，发布者便可以与取消订阅和免费资源进行互操作。</p> 
<p>实现<code>Subscriber&lt;T&gt;</code>需要实现多种方法，因此让我们将代码重写为更简单的形式：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello "</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doOnComplete</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>或者，使用Java 8 Lambdas甚至更简单：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello "</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">doOnComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Completed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>你可以使用运算符控制<code>Subscriber</code>处理的元素。</p> 
<p>如果仅对前<code>N</code>个元素感兴趣，<code>take()</code>运算符将限制发射项目的数量。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span> <span class="token comment">//</span>
        <span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello "</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">doOnComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Completed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>该示例打印以下行：</p> 
<pre><code class="prism language-bash">Hello Ben
Hello Michael
Completed
</code></pre> 
<p>请注意，一旦发出预期的元素计数，take操作符就会从<code>Publisher&lt;T&gt;</code>隐式取消其订阅。</p> 
<p>可以通过另一个Flux或Subscriber来完成对<code>Publisher&lt;T&gt;</code>的订阅。</p> 
<p>除非要实现自定义Publisher，否则请始终使用Subscriber。</p> 
<p>上例中使用的订阅者Consumer不处理异常，因此一旦引发异常，你将看到如下堆栈跟踪：</p> 
<pre><code class="prism language-java"><span class="token class-name">Exception</span> in thread <span class="token string">"main"</span> <span class="token class-name"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>Exceptions</span>$<span class="token class-name">BubblingException</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> <span class="token class-name">Example</span> exception
    at <span class="token class-name"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>Exceptions</span><span class="token punctuation">.</span><span class="token function">bubble</span><span class="token punctuation">(</span><span class="token class-name">Exceptions</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">96</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span>Operators</span><span class="token punctuation">.</span><span class="token function">onErrorDropped</span><span class="token punctuation">(</span><span class="token class-name">Operators</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">296</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span>LambdaSubscriber</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">LambdaSubscriber</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">117</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> <span class="token class-name">Example</span> exception
    at demos<span class="token punctuation">.</span>lambda$example3Lambda$<span class="token function">4</span><span class="token punctuation">(</span>demos<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">87</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span>FluxPeekFuseable</span>$<span class="token class-name">PeekFuseableSubscriber</span><span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">FluxPeekFuseable</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">157</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">23</span> more
</code></pre> 
<p>始终建议从一开始就实施错误处理程序。 在某些时候，事情可能并且会出错。</p> 
<p>完全实现的订阅者声明<code>onCompleted</code> 和<code>onError</code> 方法，使你可以对以下事件作出反应：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Subscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSubscribe</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        s<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello "</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"onError: "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="pushpull_573"></a>从push到pull</h5> 
<p>上面的示例说明了如何以一种非阻塞式或非阻塞式执行的方式设置发布者。</p> 
<p><code>Flux&lt;T&gt;</code>可以显式转换为<code>Iterable&lt;T&gt;</code>或与<code>block()</code>同步。</p> 
<p>开始表达代码内部执行的本质时，请避免在代码中调用<code>block()</code>。</p> 
<p>调用<code>block()</code>消除了应用程序反应链（reactive chain）的所有非阻塞优势。</p> 
<pre><code class="prism language-java"><span class="token class-name">String</span> last <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>该示例打印以下行：</p> 
<pre><code class="prism language-less">Mark
</code></pre> 
<p>阻塞调用可用于同步发布者链（chain），并找到进入普通且众所周知的<code>Pull</code> 模式的方法。</p> 
<pre><code class="prism language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collectList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>toList</code> 运算符收集所有发出的元素，并将列表通过<code>BlockingPublisher&lt;T&gt;</code>传递。</p> 
<p>该示例打印以下行：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>Ben, Michael, Mark<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="Flux__611"></a>Flux 流（多个元素的发射序列）</h4> 
<p>Flux 是一个发出(emit)<code>0-N</code>个元素组成的异步序列的<code>Publisher&lt;T&gt;</code>,可以被<code>onComplete</code>信号或者<code>onError</code>信号所终止。</p> 
<p>在响应流规范中存在三种给下游消费者调用的方法 <code>onNext</code>, <code>onComplete</code>, 和<code>onError</code>。</p> 
<p>下面这张图表示了Flux的抽象模型：</p> 
<p><img src="https://images2.imgbox.com/03/67/ApEmXmCB_o.png" alt=""></p> 
<p>以上的的讲解对于初次接触反应式编程的依然是难以理解的，所以这里有一个循序渐进的理解过程。</p> 
<blockquote> 
 <p><strong>有些类比并不是很妥当，但是对于你循序渐进的理解这些新概念还是有帮助的。</strong></p> 
</blockquote> 
<h5><a id="_627"></a>传统数据处理</h5> 
<p>我们在平常是这么写的：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">allUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们通过迭代返回值<code>List</code>来<code>get</code>这些元素进行再处理（消费），不管有没有消费者， 菜品都会生产出来。</p> 
<h5><a id="_639"></a>流式数据处理</h5> 
<p>在<strong>Java 8</strong>中我们可以改写为流的表示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">allUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span>  <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_651"></a>反应式数据处理</h5> 
<p>在<strong>Reactor</strong>中我们又可以改写为Flux表示：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">allUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这时候食客来了，发生了订阅，厨师才开始做。</p> 
<h5><a id="Flux_Demo_665"></a>Flux 的创建Demo</h5> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span> ints <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span> seq1 <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"bole1"</span><span class="token punctuation">,</span> <span class="token string">"bole2"</span><span class="token punctuation">,</span> <span class="token string">"bole3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> iterable <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"bole_01"</span><span class="token punctuation">,</span> <span class="token string">"bole_02"</span><span class="token punctuation">,</span> <span class="token string">"bole_03"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span> seq2 <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span><span class="token punctuation">;</span>
seq2<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="MonoT_677"></a><code>Mono&lt;T&gt;</code></h4> 
<p>Mono 是一个发出(emit)<code>0-1</code>个元素的<code>Publisher&lt;T&gt;</code>,可以被<code>onComplete</code>信号或者<code>onError</code>信号所终止。</p> 
<p><img src="https://images2.imgbox.com/52/c0/NGR1woYp_o.png" alt=""></p> 
<p>mono 整体和Flux差不多，只不过这里只会发出0-1个元素。也就是说不是有就是没有。</p> 
<p>象Flux一样，我们来看看Mono的演化过程以帮助理解。</p> 
<h5><a id="_689"></a>传统数据处理</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">User</span> currentUser <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> isAuthenticated <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"felord.cn"</span><span class="token punctuation">,</span> <span class="token string">"reactive"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>直接返回符合条件的对象或者null`。</p> 
<h5><a id="Optional_699"></a>Optional的处理方式</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> currentUser <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> isAuthenticated <span class="token operator">?</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"felord.cn"</span><span class="token punctuation">,</span> <span class="token string">"reactive"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个Optional我觉得就有反应式的那种味儿了，当然它并不是反应式。当我们不从返回值Optional取其中具体的对象时，我们不清楚里面到底有没有，但是Optional是一定客观存在的,不会出现<strong>NPE</strong>问题。</p> 
<h5><a id="_710"></a>反应式数据处理</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> currentUser <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> isAuthenticated <span class="token operator">?</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"felord.cn"</span><span class="token punctuation">,</span> <span class="token string">"reactive"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>和Optional有点类似的机制，当然Mono不是为了解决<strong>NPE</strong>问题的，它是为了处理响应流中单个值（也可能是<code>Void</code>）而存在的。</p> 
<h5><a id="MonoDemo_723"></a>Mono的创建Demo</h5> 
<pre><code class="prism language-java"><span class="token class-name">Mono</span> data <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"bole"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Mono</span> noData <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
m<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_733"></a>函数编程</h3> 
<p>反应式编程，常常和函数式编程结合，这就是让大家困扰的地方</p> 
<h4><a id="_739"></a>函数编程接口</h4> 
<table><thead><tr><th>接口函数名</th><th>说明</th></tr></thead><tbody><tr><td>BiConsumer</td><td>表示接收两个输入参数和不返回结果的操作。</td></tr><tr><td>BiFunction</td><td>表示接受两个参数，并产生一个结果的函数。</td></tr><tr><td>BinaryOperator</td><td>表示在相同类型的两个操作数的操作，生产相同类型的操作数的结果。</td></tr><tr><td>BiPredicate</td><td>代表两个参数谓词（布尔值函数）。</td></tr><tr><td>BooleanSupplier</td><td>代表布尔值结果的提供者。</td></tr><tr><td>Consumer</td><td>表示接受一个输入参数和不返回结果的操作。</td></tr><tr><td>DoubleBinaryOperator</td><td>代表在两个double值操作数的运算，并产生一个double值结果。</td></tr><tr><td>DoubleConsumer</td><td>表示接受一个double值参数，不返回结果的操作。</td></tr><tr><td>DoubleFunction</td><td>表示接受double值参数，并产生一个结果的函数。</td></tr><tr><td>DoublePredicate</td><td>代表一个double值参数谓词（布尔值函数）。</td></tr><tr><td>DoubleSupplier</td><td>表示表示接受double值参数，并产生一个结果的函数。值结果的提供者。</td></tr><tr><td>DoubleToIntFunction</td><td>表示接受一个double值参数，不返回结果的操作。</td></tr><tr><td>DoubleFunction</td><td>表示接受double值参数，并产生一个结果的函数。</td></tr><tr><td>DoublePredicate</td><td>代表一个double值参数谓词（布尔值函数）。</td></tr><tr><td>DoubleSupplier</td><td>DoubleToIntFunction</td></tr><tr><td>DoubleToIntFunction</td><td>表示接受double值参数，并产生一个int值结果的函数。</td></tr><tr><td>DoubleToLongFunction</td><td>表示上产生一个double值结果的单个double值操作数的操作。</td></tr><tr><td>Function</td><td>代表接受一个double值参数，并产生一个long值结果的函数。</td></tr><tr><td>DoubleUnaryOperator</td><td>表示上产生一个double值结果的单个double值操作数的操作。</td></tr><tr><td>Function</td><td>表示接受一个参数，并产生一个结果的函数。</td></tr><tr><td>IntConsumer</td><td>表示接受单个int值的参数并没有返回结果的操作。</td></tr><tr><td>IntFunction</td><td>表示接受一个int值参数，并产生一个结果的函数。</td></tr><tr><td>IntPredicate</td><td>表示一个整数值参数谓词（布尔值函数）。</td></tr><tr><td>IntSupplier</td><td>代表整型值的结果的提供者。</td></tr><tr><td>IntToLongFunction</td><td>表示接受一个int值参数，并产生一个long值结果的函数。</td></tr><tr><td>IntUnaryOperator</td><td>表示产生一个int值结果的单个int值操作数的运算。</td></tr><tr><td>LongBinaryOperator</td><td>表示在两个long值操作数的操作，并产生一个ObjLongConsumer值结果。</td></tr><tr><td>LongFunction</td><td>表示接受long值参数，并产生一个结果的函数。</td></tr><tr><td>LongPredicate</td><td>代表一个long值参数谓词（布尔值函数）。</td></tr><tr><td>LongSupplier</td><td>表示long值结果的提供者。</td></tr><tr><td>LongToDoubleFunction</td><td>表示接受double参数，并产生一个double值结果的函数。</td></tr><tr><td>LongToIntFunction</td><td>表示接受long值参数，并产生一个int值结果的函数。</td></tr><tr><td>LongUnaryOperator</td><td>表示上产生一个long值结果单一的long值操作数的操作。</td></tr><tr><td>ObjDoubleConsumer</td><td>表示接受对象值和double值参数，并且没有返回结果的操作。</td></tr><tr><td>ObjIntConsumer</td><td>表示接受对象值和整型值参数，并返回没有结果的操作。</td></tr><tr><td>ObjLongConsumer</td><td>表示接受对象值和整型值参数，并返回没有结果的操作。</td></tr><tr><td>ObjLongConsumer</td><td>表示接受对象值和double值参数，并且没有返回结果的操作。</td></tr><tr><td>ObjIntConsumer</td><td>表示接受对象值和整型值参数，并返回没有结果的操作。</td></tr><tr><td>ObjLongConsumer</td><td>表示接受对象的值和long值的说法，并没有返回结果的操作。</td></tr><tr><td>Predicate</td><td>代表一个参数谓词（布尔值函数）。</td></tr><tr><td>Supplier</td><td>表示一个提供者的结果。</td></tr><tr><td>ToDoubleBiFunction</td><td>表示接受两个参数，并产生一个double值结果的功能。</td></tr><tr><td>ToDoubleFunction</td><td>代表一个产生一个double值结果的功能。</td></tr><tr><td>ToIntBiFunction</td><td>表示接受两个参数，并产生一个int值结果的函数。</td></tr><tr><td>ToIntFunction</td><td>代表产生一个int值结果的功能。</td></tr><tr><td>ToLongBiFunction</td><td>表示接受两个参数，并产生long值结果的功能。</td></tr><tr><td>ToLongFunction</td><td>代表一个产生long值结果的功能。</td></tr><tr><td>UnaryOperator</td><td>表示上产生相同类型的操作数的结果的单个操作数的操作。</td></tr></tbody></table> 
<h4><a id="_794"></a>常用函数编程示例</h4> 
<p>Consumer ：有 一个 输入 无输出 函数接口</p> 
<pre><code class="prism language-java"><span class="token class-name">Product</span> product<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//类名+静态方法  有一个输入T， 没有输出</span>
<span class="token class-name">Consumer</span> consumer1 <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token operator">-&gt;</span><span class="token class-name">Product</span><span class="token punctuation">.</span><span class="token function">nameOf</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//lambda</span>
consumer1<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Consumer</span> consumer <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token operator">::</span><span class="token function">nameOf</span><span class="token punctuation">;</span><span class="token comment">//方法引用</span>
consumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Funtion&lt;T,R&gt; ：一个输入 一个输出 函数接口</p> 
<pre><code class="prism language-java"><span class="token comment">//对象+方法  一个输入T 一个输出R</span>
<span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> function <span class="token operator">=</span> product<span class="token operator">::</span><span class="token function">reduceStock</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"剩余库存："</span> <span class="token operator">+</span> function<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//带参数的构造函数</span>
<span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> function1<span class="token operator">=</span><span class="token class-name">Product</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"新对象:"</span> <span class="token operator">+</span>function1<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Predicate ： 一个输入T, 一个输出 Boolean</p> 
<pre><code class="prism language-java"><span class="token comment">//Predicate 一个输入T 一个输出Boolean</span>
<span class="token class-name">Predicate</span> predicate<span class="token operator">=</span> i <span class="token operator">-&gt;</span> product<span class="token punctuation">.</span><span class="token function">isEnough</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//lambda</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"库存是否足够："</span><span class="token operator">+</span>predicate<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Predicate</span> predicate1<span class="token operator">=</span> product<span class="token operator">::</span><span class="token function">isEnough</span><span class="token punctuation">;</span><span class="token comment">//方法引用</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"库存是否足够："</span><span class="token operator">+</span>predicate1<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>UnaryOperator ：一元操作符 ,输入输出都是T</p> 
<pre><code class="prism language-java"><span class="token comment">//一元操作符  输入和输出T</span>
<span class="token class-name">UnaryOperator</span> integerUnaryOperator <span class="token operator">=</span>product<span class="token operator">::</span><span class="token function">reduceStock</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"剩余库存："</span> <span class="token operator">+</span> integerUnaryOperator<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntUnaryOperator</span> intUnaryOperator <span class="token operator">=</span> product<span class="token operator">::</span><span class="token function">reduceStock</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"剩余库存："</span> <span class="token operator">+</span> intUnaryOperator<span class="token punctuation">.</span><span class="token function">applyAsInt</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Supplier ： 没有输入 只有输出</p> 
<pre><code class="prism language-java"><span class="token comment">//无参数构造函数</span>
<span class="token class-name">Supplier</span> supplier <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"创建新对象:"</span> <span class="token operator">+</span> supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token class-name">Supplier</span> supplier1<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>product<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"剩余库存:"</span> <span class="token operator">+</span> supplier1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>BiFunction： 二元操作符 两个输入&lt;T,U&gt; 一个输出</p> 
<pre><code class="prism language-java"><span class="token comment">//类名+方法</span>
<span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> binaryOperator <span class="token operator">=</span> <span class="token class-name">Product</span><span class="token operator">::</span><span class="token function">reduceStock</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" 剩余库存(BiFunction)："</span> <span class="token operator">+</span> binaryOperator<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>product<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>BinaryOperator ：二元操作符，二个输入，一个输出</p> 
<pre><code class="prism language-java"><span class="token comment">//BinaryOperator binaryOperator1=(x,y)-&gt;product.reduceStock(x,y);</span>
<span class="token class-name">BinaryOperator</span> binaryOperator1<span class="token operator">=</span>product<span class="token operator">::</span><span class="token function">reduceStock</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">" 剩余库存(BinaryOperator)："</span> <span class="token operator">+</span>binaryOperator1<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="Flux_874"></a>Flux类中的静态方法：</h3> 
<h4><a id="_876"></a>简单的创建方法</h4> 
<p><strong>just</strong>()：</p> 
<p>可以指定序列中包含的全部元素。创建出来的Flux序列在发布这些元素之后会自动结束</p> 
<p><strong>fromArray()，fromIterable()，fromStream()：</strong></p> 
<p>可以从一个数组，Iterable对象或Stream对象中穿件Flux对象</p> 
<p><strong>empty</strong>()：</p> 
<p>创建一个不包含任何元素，只发布结束消息的序列</p> 
<p><strong>error</strong>(Throwable error)：</p> 
<p>创建一个只包含错误消息的序列</p> 
<p><strong>never</strong>()：</p> 
<p>传建一个不包含任务消息通知的序列</p> 
<p><strong>range(int start, int count)：</strong></p> 
<p>创建包含从start起始的count个数量的Integer对象的序列</p> 
<p><strong>interval(Duration period)和interval(Duration delay, Duration period)：</strong></p> 
<p>创建一个包含了从0开始递增的Long对象的序列。其中包含的元素按照指定的间隔来发布。除了间隔时间之外，还可以指定起始元素发布之前的延迟时间</p> 
<p><strong>intervalMillis(long period)和intervalMillis(long delay, long period)：</strong></p> 
<p>与interval()方法相同，但该方法通过毫秒数来指定时间间隔和延迟时间</p> 
<p>例子</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">,</span> <span class="token string">"World"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscirbe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_generate_925"></a>复杂的序列创建 generate()</h4> 
<p>当序列的生成需要复杂的逻辑时，则应该使用generate()或create()方法。</p> 
<p>generate()方法通过同步和逐一的方式来产生Flux序列。</p> 
<p>序列的产生是通过调用所提供的的SynchronousSink对象的next()，complete()和error(Throwable)方法来完成的。</p> 
<p>逐一生成的含义是在具体的生成逻辑中，next()方法只能最多被调用一次。</p> 
<p>在某些情况下，序列的生成可能是有状态的，需要用到某些状态对象，此时可以使用</p> 
<pre><code class="prism language-java"><span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> stateSupplier<span class="token punctuation">,</span> <span class="token class-name">BiFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">SynchronousSink</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> generator<span class="token punctuation">)</span>，
</code></pre> 
<p>其中stateSupplier用来提供初始的状态对象。</p> 
<p>在进行序列生成时，状态对象会作为generator使用的第一个参数传入，可以在对应的逻辑中对改状态对象进行修改以供下一次生成时使用。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">final</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>list<span class="token punctuation">,</span> sink<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> value <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token number">10</span> <span class="token punctuation">)</span>
        sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_create_964"></a>复杂的序列创建 create()</h4> 
<p>create()方法与generate()方法的不同之处在于所使用的是FluxSink对象。</p> 
<p>FluxSink支持同步和异步的消息产生，并且可以在一次调用中产生多个元素。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span>
        sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="Mono_980"></a>Mono静态方法</h3> 
<p>Mono类包含了与Flux类中相同的静态方法：just()，empty()和never()等。</p> 
<p>除此之外，Mono还有一些独有的静态方法：</p> 
<ul><li>fromCallable()，fromCompletionStage()，fromFuture()，fromRunnable()和fromSupplier()：分别从Callable，CompletionStage，CompletableFuture，Runnable和Supplier中创建Mono</li><li><code>delay(Duration duration)和delayMillis(long duration)</code>：创建一个Mono序列，在指定的延迟时间之后，产生数字0作为唯一值</li><li><code>ignoreElements(Publisher&lt;T&gt; source)</code>：创建一个Mono序列，忽略作为源的Publisher中的所有元素，只产生消息</li><li><code>justOrEmpty(Optional&lt;? extends T&gt; data)</code>和<code>justOrEmpty(T data)</code>：从一个Optional对象或可能为null的对象中创建Mono。只有Optional对象中包含之或对象不为null时，Mono序列才产生对应的元素</li></ul> 
<p>例子：</p> 
<pre><code class="prism language-java"><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromSupplier</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">justOrEmpty</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> sink<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribte</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_999"></a>操作符</h3> 
<h4><a id="bufferbufferTimeout_1001"></a>操作符buffer和bufferTimeout</h4> 
<p>这两个操作符的作用是把当前流中的元素收集到集合中，并把集合对象作为流中的新元素。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在进行收集时可以指定不同的条件：所包含的元素的最大数量或收集的时间间隔。</p> 
<p>方法buffer()仅使用一个条件，而bufferTimeout()可以同时指定两个条件。</p> 
<p>指定时间间隔时可以使用Duration对象或毫秒数，即使用bufferMillis()或bufferTimeoutMillis()两个方法。</p> 
<p>除了元素数量和时间间隔外，还可以通过bufferUntil和bufferWhile操作符来进行收集。这两个操作符的参数时表示每个集合中的元素索要满足的条件的Predicate对象。</p> 
<p>bufferUntil会一直收集直到Predicate返回true。</p> 
<p>使得Predicate返回true的那个元素可以选择添加到当前集合或下一个集合中；bufferWhile则只有当Predicate返回true时才会收集。一旦为false，会立即开始下一次收集。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferMillis</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferUntil</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferWhile</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="Filter_1031"></a>操作符Filter</h4> 
<p>对流中包含的元素进行过滤，只留下满足Predicate指定条件的元素。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="zipWith_1041"></a>操作符zipWith</h4> 
<p>zipWith操作符把当前流中的元素与另一个流中的元素按照一对一的方式进行合并。在合并时可以不做任何处理，由此得到的是一个元素类型为Tuple2的流；也可以通过一个BiFunction函数对合并的元素进行处理，所得到的流的元素类型为该函数的返回值。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zipWith</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zipWith</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s-%s"</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="take_1052"></a>操作符take</h4> 
<p>take系列操作符用来从当前流中提取元素。提取方式如下：</p> 
<p>take(long n)，take(Duration timespan)和takeMillis(long timespan)：按照指定的数量或时间间隔来提取</p> 
<p>takeLast(long n)：提取流中的最后N个元素</p> 
<p>takeUntil(Predicate&lt;? super T&gt; predicate) ：提取元素直到Predicate返回true</p> 
<p>takeWhile(Predicate&lt;? super T&gt; continuePredicate)：当Predicate返回true时才进行提取</p> 
<p>takeUntilOther(Publisher&lt;?&gt; other)：提取元素知道另外一个流开始产生元素</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">takeLast</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">takeWhile</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">takeUntil</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="reducereduceWith_1075"></a>操作符reduce和reduceWith</h4> 
<p>reduce和reduceWith操作符对流中包含的所有元素进行累计操作，得到一个包含计算结果的Mono序列。累计操作是通过一个BiFunction来表示的。在操作时可以指定一个初始值。若没有初始值，则序列的第一个元素作为初始值。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduceWith</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> y<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="mergemergeSequential_1086"></a>操作符merge和mergeSequential</h4> 
<p>merge和mergeSequential操作符用来把多个流合并成一个Flux序列。merge按照所有流中元素的实际产生序列来合并，而mergeSequential按照所有流被订阅的顺序，以流为单位进行合并。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">mergeSequential</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="flatMapflatMapSequential_1097"></a>操作符flatMap和flatMapSequential</h4> 
<p>flatMap和flatMapSequential操作符把流中的每个元素转换成一个流，再把所有流中的元素进行合并。flatMapSequential和flatMap之间的区别与mergeSequential和merge是一样的。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>x <span class="token operator">-&gt;</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="concatMap_1107"></a>操作符concatMap</h4> 
<p>concatMap操作符的作用也是把流中的每个元素转换成一个流，再把所有流进行合并。concatMap会根据原始流中的元素顺序依次把转换之后的流进行合并，并且concatMap堆转换之后的流的订阅是动态进行的，而flatMapSequential在合并之前就已经订阅了所有的流。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concatMap</span><span class="token punctuation">(</span>x <span class="token operator">-&gt;</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="combineLatest_1117"></a>操作符combineLatest</h4> 
<p>combineLatest操作符把所有流中的最新产生的元素合并成一个新的元素，作为返回结果流中的元素。只要其中任何一个流中产生了新的元素，合并操作就会被执行一次，结果流中就会产生新的元素。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">combineLatest</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token operator">::</span><span class="token function">toString</span><span class="token punctuation">,</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p></p> 
<h3><a id="_1127"></a>消息处理</h3> 
<p>当需要处理Flux或Mono中的消息时，可以通过subscribe方法来添加相应的订阅逻辑。</p> 
<p>在调用subscribe方法时可以指定需要处理的消息类型。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concatWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concatWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onErrorReturn</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>第2种可以通过switchOnError()方法来使用另外的流来产生元素。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concatWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">switchOnError</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>第三种是通过onErrorResumeWith()方法来根据不同的异常类型来选择要使用的产生元素的流。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concatWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onErrorResumeWith</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">epmty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">,</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>当出现错误时还可以使用retry操作符来进行重试。重试的动作是通过重新订阅序列来实现的。在使用retry操作时还可以指定重试的次数。</p> 
<pre><code class="prism language-java"> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concatWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">retry</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscrible</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_1165"></a>测试</h3> 
<p>StepVerifier的作用是可以对序列中包含的元素进行逐一验证。通过StepVerifier.create()方法对一个流进行包装之后再进行验证。expectNext()方法用来声明测试时所期待的流中的下一个元素的值，而verifyComplete()方法则验证流是否正常结束。verifyError()来验证流由于错误而终止。</p> 
<pre><code class="prism language-java"><span class="token class-name">StepVerifier</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">verifyComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>使用StepVerifier.withVirtualTime()方法可以创建出使用虚拟时钟的SteoVerifier。通过thenAwait(Duration)方法可以让虚拟时钟前进。</p> 
<pre><code class="prism language-java"><span class="token class-name">StepVerifier</span><span class="token punctuation">.</span><span class="token function">withVirtualTime</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expectSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expectNoEvent</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">thenAwait</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">verifyComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>TestPublisher的作用在于可以控制流中元素的产生，甚至是违反反应流规范的情况。通过create()方法创建一个新的TestPublisher对象，然后使用next()方法来产生元素，使用complete()方法来结束流。</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">TestPublisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> testPublisher <span class="token operator">=</span> <span class="token class-name">TestPublisher</span><span class="token punctuation">.</span><span class="token function">creater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
testPublisher<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
testPublisher<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
testPublisher<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">StepVerifier</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>testPublisher<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expectComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_1201"></a>调试</h3> 
<p>在调试模式启用之后，所有的操作符在执行时都会保存额外的与执行链相关的信息。当出现错误时，这些信息会被作为异常堆栈信息的一部分输出。</p> 
<pre><code class="prism language-java"><span class="token class-name">Hooks</span><span class="token punctuation">.</span><span class="token function">onOperator</span><span class="token punctuation">(</span>providedHook <span class="token operator">-&gt;</span> providedHook<span class="token punctuation">.</span><span class="token function">operatorStacktrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>也可以通过checkpoint操作符来对特定的流处理链来启用调试模式。</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">-&gt;</span> <span class="token number">1</span><span class="token operator">/</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkpoint</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_1217"></a>日志记录</h3> 
<p>可以通过添加log操作把流相关的事件记录在日志中，</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Range"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_1227"></a>冷热序列</h3> 
<p>冷序列的含义是不论订阅者在何时订阅该序列，总是能收到序列中产生的全部消息。</p> 
<p>热序列是在持续不断的产生消息，订阅者只能获取到在其订阅之后产生的消息。</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">intervalMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>publish<span class="token punctuation">.</span><span class="token function">autoConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
source<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
source<span class="token punctuation">.</span><span class="token function">toStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="map_flatMap__flatMapSequential__1242"></a>map 、flatMap 以及 flatMapSequential 区别：</h3> 
<pre><code class="prism language-java"><span class="token comment">//Map 的方法签名</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> mapper<span class="token punctuation">)</span>

<span class="token comment">//FlatMap的方法签名</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Publisher</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mapper<span class="token punctuation">)</span>
</code></pre> 
<p><strong>map：</strong></p> 
<p>通过对每个元素应用 转换函数来 同步 转换此Flux发出的元素， 并且是一对一的转换流元素。</p> 
<p><img src="https://images2.imgbox.com/c7/ec/6WZNWnc1_o.png" alt=""></p> 
<p><strong>flatMap：</strong></p> 
<p>将此Flux发出的元素 异步 转换为 Publisher，然后通过合并将这些内部Publisher，最终扁平化为单个Flux 。</p> 
<p>Flux可能包含N个元素，所以flatMap是一对多的转换。</p> 
<p>Flux 将各个 publisher 合并的过程中，不会保持 源Flux发布 的顺序，可能出现交错。</p> 
<p><img src="https://images2.imgbox.com/c3/10/8ofCzDpj_o.png" alt=""></p> 
<p><strong>flatMapSequential：</strong></p> 
<p>将此Flux发出的元素异步转换为 Publisher，然后通过合并将这些内部发布者扁平化为单个Flux 。</p> 
<p>与 flatMap 不同的是 flatMapSequential 在合并 publisher 时， 会 按源元素的顺序合并它们。</p> 
<p><img src="https://images2.imgbox.com/f5/73/Ie6HlKNr_o.png" alt=""></p> 
<p>map是一个同步运算符，它只是一种将一个值转换为另一个值的方法。</p> 
<p>flatMap可以是同步的，也可以是异步的，这取决于flatMap中调用的方法怎么使用。</p> 
<p>示例1：</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. Flux.interval 按时生产Long的无限流</span>
    <span class="token keyword">final</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">MILLIS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//2. 调用方法log，订阅后log()会在当前线程执行</span>
            <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token function">logOfFlux</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//3. 通过flatMap调用 log(), 会在当前线程执行</span>
    <span class="token comment">//完成flux的定义，调用subscribe后才会真正开始执行</span>
    flux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> aLong <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"num is {}"</span><span class="token punctuation">,</span> aLong<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> aLong<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Flux</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">logOfFlux</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> aLong <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"num is {}"</span><span class="token punctuation">,</span> aLong<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>aLong<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在我们的示例代码中，该 flatMap 操作是同步的，因为我们使用Flux.just()方法发出元素。</p> 
<p>下面我们会介绍如何在 flatMap 中实现异步操作。</p> 
<p>上边代码中讲到了 Publisher 调用 subscribe 后才会真正开始执行，所以 subscribe 中的代码并不一定会执行。</p> 
<p>当 Mono 是空序列时 ：</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">monoOfEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>message <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
          responseObserver<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
          responseObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>会有同学喜欢在 subscribe 中处理响应（例如rpc），但这个场景中responseObserver.onCompleted() 不会被执行。</p> 
<p>正确的做法应该是：</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">monoOfEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">doOnSuccess</span><span class="token punctuation">(</span>message <span class="token operator">-&gt;</span> responseObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>responseObserver<span class="token operator">::</span><span class="token function">onNext</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1342"></a>如何选择操作符？</h3> 
<p>本节的内容来自 <a href="https://htmlpreview.github.io/?https://github.com/get-set/reactor-core/blob/master-zh/src/docs/index.html#which-operator">Reacto 3 参考文档——如何选择操作符</a>。</p> 
<blockquote> 
 <p>如果一个操作符是专属于 <code>Flux</code> 或 <code>Mono</code> 的，那么会给它注明前缀。<br> 公共的操作符没有前缀。如果一个具体的用例涉及多个操作符的组合，这里以方法调用的方式展现，<br> 会以一个点（.）开头，并将参数置于圆括号内，比如： <code>.methodCall(parameter)</code>。</p> 
</blockquote> 
<h4><a id="1_1350"></a>1）创建一个新序列，它…</h4> 
<h5><a id="11__Tjust_1352"></a>1.1 发出一个T，用just：</h5> 
<p>Mono ,是指最多只能触发(emit) (事件)一次。</p> 
<p>Mono 对应于 RxJava 库的 Single 和 Maybe 类型或者是java的Optional。</p> 
<p>因此一个异步任务，如果只是想要在完成时给出完成信号，就可以使用 <code>Mono&lt;Void&gt;</code>。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMonoBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromSupplier</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">justOrEmpty</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> sink<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>基于一个 <code>Optional&lt;T&gt;</code>：<code>Mono#justOrEmpty(Optional&lt;T&gt;)</code></li><li>基于一个可能为 <code>null</code> 的 T：<code>Mono#justOrEmpty(T)</code></li></ul> 
<p>Flux 相当于一个 RxJava Observable，能够发出 0~N 个数据项，然后（可选地）completing 或 erroring。Flux处理多个数据项作为stream。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">,</span> <span class="token string">"World"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>    
</code></pre> 
<h5><a id="12_T_1387"></a>1.2 发出一个“懒”创建的T</h5> 
<ul><li>还是由 just返回但是“懒”创建的：</li></ul> 
<p>使用 <code>Mono#fromSupplier</code> 或用 <code>defer</code> 包装 <code>just</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//声明阶段创建DeferClass对象</span>

    <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> m1 <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> m2 <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m1<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m2<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//延迟5秒钟</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    m1<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m2<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="13_T_1413"></a>1.3发出许多 <code>T</code>，</h5> 
<ul><li>这些元素我可以明确列举出来：<code>Flux#just(T...)</code></li><li>基于迭代数据结构: 
  <ul><li>一个数组：<code>Flux#fromArray</code></li><li>一个集合或 iterable：<code>Flux#fromIterable</code></li><li>一个 Integer 的 range：<code>Flux#range</code></li><li>一个 <code>Stream</code> 提供给每一个订阅：<code>Flux#fromStream(Supplier&lt;Stream&gt;)</code></li></ul> </li><li>基于一个参数值给出的源： 
  <ul><li>一个 <code>Supplier&lt;T&gt;</code>：<code>Mono#fromSupplier</code></li><li>一个任务：<code>Mono#fromCallable</code>，<code>Mono#fromRunnable</code></li><li>一个 <code>CompletableFuture&lt;T&gt;</code>：<code>Mono#fromFuture</code></li></ul> </li><li>直接完成：<code>empty</code></li><li>立即生成错误：error 
  <ul><li>…“懒”的方式生成 <code>Throwable</code>：<code>error(Supplier&lt;Throwable&gt;)</code></li></ul> </li><li>什么都不做：<code>never</code></li><li>订阅时才决定：<code>defer</code></li><li>依赖一个可回收的资源：<code>using</code></li><li>可编程地生成事件（可以使用状态）: 
  <ul><li>同步且逐个的：<code>Flux#generate</code></li><li>异步（也可同步）的，每次尽可能多发出元素：<code>Flux#create</code><br> （<code>Mono#create</code> 也类似的，只不过只能发一个）</li></ul> </li></ul> 
<h4><a id="2_1436"></a>2）对序列进行转化</h4> 
<ul><li>我想转化一个序列： 
  <ul><li>1对1地转化（比如字符串转化为它的长度）：<code>map</code></li><li>…类型转化：<code>cast</code></li><li>…为了获得每个元素的序号：<code>Flux#index</code></li><li>1对n地转化（如字符串转化为一串字符）：<code>flatMap</code> + 使用一个工厂方法</li><li>1对n地转化可自定义转化方法和/或状态：<code>handle</code></li><li>对每一个元素执行一个异步操作（如对 url 执行 http 请求）：<code>flatMap</code> + 一个异步的返回类型为 <code>Publisher</code> 的方法</li><li>…忽略一些数据：在 flatMap lambda 中根据条件返回一个 <code>Mono.empty()</code></li><li>…保留原来的序列顺序：<code>Flux#flatMapSequential</code>（对每个元素的异步任务会立即执行，但会将结果按照原序列顺序排序）</li><li>…当 Mono 元素的异步任务会返回多个元素的序列时：<code>Mono#flatMapMany</code></li></ul> </li><li>我想添加一些数据元素到一个现有的序列： 
  <ul><li>在开头添加：<code>Flux#startWith(T...)</code></li><li>在最后添加：<code>Flux#concatWith(T...)</code></li></ul> </li><li>我想将 <code>Flux</code> 转化为集合（一下都是针对 <code>Flux</code> 的） 
  <ul><li>转化为 List：<code>collectList</code>，<code>collectSortedList</code></li><li>转化为 Map：<code>collectMap</code>，<code>collectMultiMap</code></li><li>转化为自定义集合：<code>collect</code></li><li>计数：<code>count</code></li><li>reduce 算法（将上个元素的reduce结果与当前元素值作为输入执行reduce方法，如sum） <code>reduce</code></li><li>…将每次 reduce 的结果立即发出：<code>scan</code></li><li>转化为一个 boolean 值：</li><li>对所有元素判断都为true：<code>all</code></li><li>对至少一个元素判断为true：<code>any</code></li><li>判断序列是否有元素（不为空）：<code>hasElements</code></li><li>判断序列中是否有匹配的元素：<code>hasElement</code></li></ul> </li><li>我想合并 publishers… 
  <ul><li>按序连接：<code>Flux#concat</code> 或 <code>.concatWith(other)</code></li><li>…即使有错误，也会等所有的 publishers 连接完成：<code>Flux#concatDelayError</code></li><li>…按订阅顺序连接（这里的合并仍然可以理解成序列的连接）：<code>Flux#mergeSequential</code></li><li>按元素发出的顺序合并（无论哪个序列的，元素先到先合并）：<code>Flux#merge</code> / <code>.mergeWith(other)</code></li><li>…元素类型会发生变化：<code>Flux#zip</code> / <code>Flux#zipWith</code></li><li>将元素组合：</li><li>2个 Monos 组成1个 <code>Tuple2</code>：<code>Mono#zipWith</code></li><li>n个 Monos 的元素都发出来后组成一个 Tuple：<code>Mono#zip</code></li><li>在终止信号出现时“采取行动”：</li><li>在 Mono 终止时转换为一个 <code>Mono&lt;Void&gt;</code>：<code>Mono#and</code></li><li>当 n 个 Mono 都终止时返回 <code>Mono&lt;Void&gt;</code>：<code>Mono#when</code></li><li>返回一个存放组合数据的类型，对于被合并的多个序列： 
    <ul><li>每个序列都发出一个元素时：<code>Flux#zip</code></li><li>任何一个序列发出元素时：<code>Flux#combineLatest</code></li></ul> </li><li>只取各个序列的第一个元素：<code>Flux#first</code>，<code>Mono#first</code>，<code>mono.or(otherMono).or(thirdMono)</code>，<code>flux.or(otherFlux).or(thirdFlux)</code></li><li>由一个序列触发（类似于 <code>flatMap</code>，不过“喜新厌旧”）：<code>switchMap</code></li><li>由每个新序列开始时触发（也是“喜新厌旧”风格）：<code>switchOnNext</code></li></ul> </li><li>我想重复一个序列：<code>repeat</code> 
  <ul><li>…但是以一定的间隔重复：<code>Flux.interval(duration).flatMap(tick -&gt; myExistingPublisher)</code></li></ul> </li><li>我有一个空序列，但是… 
  <ul><li>我想要一个缺省值来代替：<code>defaultIfEmpty</code></li><li>我想要一个缺省的序列来代替：<code>switchIfEmpty</code></li></ul> </li><li>我有一个序列，但是我对序列的元素值不感兴趣：<code>ignoreElements</code> 
  <ul><li>…并且我希望用 <code>Mono</code> 来表示序列已经结束：<code>then</code></li><li>…并且我想在序列结束后等待另一个任务完成：<code>thenEmpty</code></li><li>…并且我想在序列结束之后返回一个 <code>Mono</code>：<code>Mono#then(mono)</code></li><li>…并且我想在序列结束之后返回一个值：<code>Mono#thenReturn(T)</code></li><li>…并且我想在序列结束之后返回一个 <code>Flux</code>：<code>thenMany</code></li></ul> </li><li>我有一个 Mono 但我想延迟完成… 
  <ul><li>…当有1个或N个其他 publishers 都发出（或结束）时才完成：<code>Mono#delayUntilOther</code></li><li>…使用一个函数式来定义如何获取“其他 publisher”：<code>Mono#delayUntil(Function)</code></li></ul> </li><li>我想基于一个递归的生成序列的规则扩展每一个元素，然后合并为一个序列发出： 
  <ul><li>…广度优先：<code>expand(Function)</code></li><li>…深度优先：<code>expandDeep(Function)</code></li></ul> </li></ul> 
<h4><a id="3_1499"></a><strong>3）“窥视”（只读）序列</strong></h4> 
<ul><li>再不对序列造成改变的情况下，我想： 
  <ul><li>得到通知或执行一些操作：</li><li>发出元素：<code>doOnNext</code></li><li>序列完成：<code>Flux#doOnComplete</code>，<code>Mono#doOnSuccess</code></li><li>因错误终止：<code>doOnError</code></li><li>取消：<code>doOnCancel</code></li><li>订阅时：<code>doOnSubscribe</code></li><li>请求时：<code>doOnRequest</code></li><li>完成或错误终止：doOnTerminate（Mono的方法可能包含有结果） 
    <ul><li>但是在终止信号向下游传递 <em>之后</em> ：<code>doAfterTerminate</code></li></ul> </li><li>所有类型的信号（<code>Signal</code>）：<code>Flux#doOnEach</code></li><li>所有结束的情况（完成complete、错误error、取消cancel）：<code>doFinally</code></li><li>记录日志：<code>log</code></li></ul> </li><li>我想知道所有的事件: 
  <ul><li>每一个事件都体现为一个 <code>single</code> 对象：</li><li>执行 callback：<code>doOnEach</code></li><li>每个元素转化为single对象：materialize 
    <ul><li>…在转化回元素：<code>dematerialize</code></li></ul> </li><li>转化为一行日志：<code>log</code></li></ul> </li></ul> 
<h4><a id="4_1521"></a>4）过滤序列</h4> 
<ul><li>我想过滤一个序列 
  <ul><li>基于给定的判断条件：<code>filter</code></li><li>…异步地进行判断：<code>filterWhen</code></li><li>仅限于指定类型的对象：<code>ofType</code></li><li>忽略所有元素：<code>ignoreElements</code></li><li>去重:</li><li>对于整个序列：<code>Flux#distinct</code></li><li>去掉连续重复的元素：<code>Flux#distinctUntilChanged</code></li></ul> </li><li>我只想要一部分序列： 
  <ul><li>只要 N 个元素：</li><li>从序列的第一个元素开始算：Flux#take(long) 
    <ul><li>…取一段时间内发出的元素：<code>Flux#take(Duration)</code></li><li>…只取第一个元素放到 <code>Mono</code> 中返回：<code>Flux#next()</code></li><li>…使用 <code>request(N)</code> 而不是取消：<code>Flux#limitRequest(long)</code></li></ul> </li><li>从序列的最后一个元素倒数：<code>Flux#takeLast</code></li><li>直到满足某个条件（包含）：<code>Flux#takeUntil</code>（基于判断条件），<code>Flux#takeUntilOther</code>（基于对 publisher 的比较）</li><li>直到满足某个条件（不包含）：<code>Flux#takeWhile</code></li><li>最多只取 1 个元素：</li><li>给定序号：<code>Flux#elementAt</code></li><li>最后一个：</li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token punctuation">.</span><span class="token function">takeLast</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>…如果为序列空则发出错误信号：<code>Flux#last()</code></li><li>…如果序列为空则返回默认值：<code>Flux#last(T)</code></li><li>跳过一些元素：</li><li>从序列的第一个元素开始跳过：Flux#skip(long) 
  <ul><li>…跳过一段时间内发出的元素：<code>Flux#skip(Duration)</code></li></ul> </li><li>跳过最后的 n 个元素：<code>Flux#skipLast</code></li><li>直到满足某个条件（包含）：<code>Flux#skipUntil</code>（基于判断条件），<code>Flux#skipUntilOther</code> （基于对 publisher 的比较）</li><li>直到满足某个条件（不包含）：<code>Flux#skipWhile</code></li><li>采样：</li><li>给定采样周期：Flux#sample(Duration) 
  <ul><li>取采样周期里的第一个元素而不是最后一个：<code>sampleFirst</code></li></ul> </li><li>基于另一个 publisher：<code>Flux#sample(Publisher)</code></li><li>基于 publisher“超时”：<code>Flux#sampleTimeout</code> （每一个元素会触发一个 publisher，如果这个 publisher 不被下一个元素触发的 publisher 覆盖就发出这个元素）</li><li>我只想要一个元素（如果多于一个就返回错误）… 
  <ul><li>如果序列为空，发出错误信号：<code>Flux#single()</code></li><li>如果序列为空，发出一个缺省值：<code>Flux#single(T)</code></li><li>如果序列为空就返回一个空序列：<code>Flux#singleOrEmpty</code></li></ul> </li></ul> 
<h4><a id="5_1566"></a>5）错误处理</h4> 
<ul><li>我想创建一个错误序列：<code>error</code>… 
  <ul><li>…替换一个完成的 <code>Flux</code>：<code>.concat(Flux.error(e))</code></li><li>…替换一个完成的 <code>Mono</code>：<code>.then(Mono.error(e))</code></li><li>…如果元素超时未发出：<code>timeout</code></li><li>…“懒”创建：<code>error(Supplier&lt;Throwable&gt;)</code></li></ul> </li><li>我想要类似 try/catch 的表达方式： 
  <ul><li>抛出异常：<code>error</code></li><li>捕获异常：</li><li>然后返回缺省值：<code>onErrorReturn</code></li><li>然后返回一个 <code>Flux</code> 或 <code>Mono</code>：<code>onErrorResume</code></li><li>包装异常后再抛出：<code>.onErrorMap(t -&gt; new RuntimeException(t))</code></li><li>finally 代码块：<code>doFinally</code></li><li>Java 7 之后的 try-with-resources 写法：<code>using</code> 工厂方法</li></ul> </li><li>我想从错误中恢复… 
  <ul><li>返回一个缺省的：</li><li>的值：<code>onErrorReturn</code></li><li><code>Publisher</code>：<code>Flux#onErrorResume</code> 和 <code>Mono#onErrorResume</code></li><li>重试：<code>retry</code></li><li>…由一个用于伴随 Flux 触发：<code>retryWhen</code></li></ul> </li><li>我想处理回压错误（向上游发出“MAX”的 request，如果下游的 request 比较少，则应用策略）… 
  <ul><li>抛出 <code>IllegalStateException</code>：<code>Flux#onBackpressureError</code></li><li>丢弃策略：<code>Flux#onBackpressureDrop</code></li><li>…但是不丢弃最后一个元素：<code>Flux#onBackpressureLatest</code></li><li>缓存策略（有限或无限）：<code>Flux#onBackpressureBuffer</code></li><li>…当有限的缓存空间用满则应用给定策略：<code>Flux#onBackpressureBuffer</code> 带有策略 <code>BufferOverflowStrategy</code></li></ul> </li></ul> 
<h4><a id="6__1594"></a>6） 基于时间的操作</h4> 
<ul><li>我想将元素转换为带有时间信息的 <code>Tuple2&lt;Long, T&gt;</code>… 
  <ul><li>从订阅时开始：<code>elapsed</code></li><li>记录时间戳：<code>timestamp</code></li></ul> </li><li>如果元素间延迟过长则中止序列：<code>timeout</code></li><li>以固定的周期发出元素：<code>Flux#interval</code></li><li>在一个给定的延迟后发出 <code>0</code>：static <code>Mono.delay</code>.</li><li>我想引入延迟： 
  <ul><li>对每一个元素：<code>Mono#delayElement</code>，<code>Flux#delayElements</code></li><li>延迟订阅：<code>delaySubscription</code></li></ul> </li></ul> 
<h4><a id="7_Flux_1606"></a>7）拆分 Flux</h4> 
<ul><li>我想将一个 <code>Flux&lt;T&gt;</code> 拆分为一个 <code>Flux&lt;Flux&lt;T&gt;&gt;</code>： 
  <ul><li>以个数为界：<code>window(int)</code></li><li>…会出现重叠或丢弃的情况：<code>window(int, int)</code></li><li>以时间为界：<code>window(Duration)</code></li><li>…会出现重叠或丢弃的情况：<code>window(Duration, Duration)</code></li><li>以个数或时间为界：<code>windowTimeout(int, Duration)</code></li><li>基于对元素的判断条件：<code>windowUntil</code></li><li>…触发判断条件的元素会分到下一波（<code>cutBefore</code> 变量）：<code>.windowUntil(predicate, true)</code></li><li>…满足条件的元素在一波，直到不满足条件的元素发出开始下一波：<code>windowWhile</code> （不满足条件的元素会被丢弃）</li><li>通过另一个 Publisher 的每一个 onNext 信号来拆分序列：<code>window(Publisher)</code>，<code>windowWhen</code></li></ul> </li><li>我想将一个 <code>Flux&lt;T&gt;</code> 的元素拆分到集合… 
  <ul><li>拆分为一个一个的 <code>List</code>:</li><li>以个数为界：buffer(int) 
    <ul><li>…会出现重叠或丢弃的情况：<code>buffer(int, int)</code></li></ul> </li><li>以时间为界：buffer(Duration) 
    <ul><li>…会出现重叠或丢弃的情况：<code>buffer(Duration, Duration)</code></li></ul> </li><li>以个数或时间为界：<code>bufferTimeout(int, Duration)</code></li><li>基于对元素的判断条件：bufferUntil(Predicate) 
    <ul><li>…触发判断条件的元素会分到下一个buffer：<code>.bufferUntil(predicate, true)</code></li><li>…满足条件的元素在一个buffer，直到不满足条件的元素发出开始下一buffer：<code>bufferWhile(Predicate)</code></li></ul> </li><li>通过另一个 Publisher 的每一个 onNext 信号来拆分序列：<code>buffer(Publisher)</code>，<code>bufferWhen</code></li><li>拆分到指定类型的 “collection”：<code>buffer(int, Supplier&lt;C&gt;)</code></li></ul> </li><li>我想将 <code>Flux&lt;T&gt;</code> 中具有共同特征的元素分组到子 Flux：<code>groupBy(Function&lt;T,K&gt;)</code>（注意返回值是 <code>Flux&lt;GroupedFlux&lt;K, T&gt;&gt;</code>，每一个 <code>GroupedFlux</code> 具有相同的 key 值 <code>K</code>，可以通过 <code>key()</code> 方法获取）。</li></ul> 
<p><strong>8）回到同步的世界</strong></p> 
<ul><li>我有一个 <code>Flux&lt;T&gt;</code>，我想： 
  <ul><li>在拿到第一个元素前阻塞：<code>Flux#blockFirst</code></li><li>…并给出超时时限：<code>Flux#blockFirst(Duration)</code></li><li>在拿到最后一个元素前阻塞（如果序列为空则返回 null）：<code>Flux#blockLast</code></li><li>…并给出超时时限：<code>Flux#blockLast(Duration)</code></li><li>同步地转换为 <code>Iterable&lt;T&gt;</code>：<code>Flux#toIterable</code></li><li>同步地转换为 Java 8 <code>Stream&lt;T&gt;</code>：<code>Flux#toStream</code></li></ul> </li><li>我有一个 <code>Mono&lt;T&gt;</code>，我想： 
  <ul><li>在拿到元素前阻塞：<code>Mono#block</code></li><li>…并给出超时时限：<code>Mono#block(Duration)</code></li><li>转换为 <code>CompletableFuture&lt;T&gt;</code>：<code>Mono#toFuture</code></li></ul> </li></ul> 
<h3><a id="_1648"></a>处理错误</h3> 
<p>在响应式流中，错误（error）是终止（terminal）事件。</p> 
<p>当有错误发生时，它会导致流序列停止， 并且错误信号会沿着操作链条向下传递，直至遇到定义的 Subscriber 及其 onError 方法。</p> 
<p>在 try-catch 代码块中处理异常的几种方法。常见的包括如下几种：</p> 
<ol><li>捕获并返回一个静态的缺省值。</li><li>捕获并执行一个异常处理方法。</li><li>捕获并动态计算一个候补值来顶替。</li><li>捕获，并再包装为某一个 业务相关的异常，然后再抛出业务异常。</li><li>捕获，记录错误日志，然后继续抛出。</li><li>使用 finally 来清理资源</li></ol> 
<p>以上所有这些在 Reactor 都有等效的 操作符处理方式。</p> 
<p>与第 (1) 条（捕获并返回一个静态的缺省值）对应的是 onErrorReturn：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">function</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onErrorReturn</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回一个静态的缺省值</span>
</code></pre> 
<p>根据错误类型返回对应值</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">function</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">onErrorReturn</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"boom-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Error-1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>与第 (2、3、4) 条（捕获并执行一个异常处理方法）对应的是 onErrorResume</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> <span class="token function">function</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token function">handleErr</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> <span class="token function">function</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token function">errFunc</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> <span class="token function">function</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>对应第 (5) 条（捕获，记录错误日志，并继续抛出）</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> <span class="token function">function</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">doOnError</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> 
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>对应（6）doFinally 在序列终止（无论是 onComplete、onError还是取消）的时候被执行， 并且能够判断是什么类型的终止事件</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">doFinally</span><span class="token punctuation">(</span>type <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token class-name">SignalType</span><span class="token punctuation">.</span><span class="token constant">CANCEL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"a log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre> 
<h3><a id="_1719"></a>流的并行（或者异步）与多线程</h3> 
<p>Reactor被视为与并发无关的。</p> 
<p>也就是说，获得Flux或Mono并不一定意味着它在专用线程中运行。</p> 
<p>取而代之的是，大多数Operator会继续在执行前一个Operator的线程中工作。</p> 
<p>除非指定，否则最顶层的Operator（源）本身运行在进行subscribe()调用的线程上。</p> 
<p><strong>先分享一个案例：</strong></p> 
<p>在进行DB这种耗时的操作时，我们不希望在IO线程上执行，而是在专用的线程池里边执行，从而使得IO线程不会阻塞,。</p> 
<p>来看看下面的代码：</p> 
<pre><code class="prism language-java"><span class="token comment">//获得所有的用户</span>
<span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllUser</span><span class="token punctuation">(</span><span class="token class-name">ServerRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>代码中没有使用subscriptOn或者publishOn操作符，userRepository.findAll() 会使后续的操作符都在 lettuce-1 线程（IO）线程中执行，所以， 并且整个流的执行都是串行的，</p> 
<p>我们需要将查询过程改为异步查询。</p> 
<h4><a id="Schedulersthreads_1750"></a>调度程序(Schedulers)和线程(threads)</h4> 
<p>Project Reactor中的调度程序(Schedulers)用于指示多线程(multi-threading)。</p> 
<p>某些运算符具有将Scheduler作为参数的变体。 这些指示操作员在特定的调度程序上执行其部分或全部工作。</p> 
<p>Project Reactor附带了一组预配置的调度程序(Schedulers)，都可以通过<code>Schedulers</code> 类进行访问：</p> 
<ul><li>Schedulers.parallel(): 执行诸如事件循环和回调处理之类的计算工作。</li><li>Schedulers.immediate(): 在当前线程中立即执行工作</li><li>Schedulers.elastic(): 执行I/O绑定的工作，例如阻塞I/O的异步性能，此调度程序由线程池支持，该线程池将根据需要增长</li><li>Schedulers.newSingle(): 在新线程上执行工作</li><li>Schedulers.fromExecutor(): <code>从java.util.concurrent.Executor创建调度程序</code></li><li>Schedulers.timer(): 创建或重新使用分辨率为50ms的基于hash-wheel的TimedScheduler。</li></ul> 
<p>不要将计算调度程序用于I/O。</p> 
<p>调度程序可以通过以下几种不同的方式执行发布者：</p> 
<ul><li>使用利用调度程序的运算符</li><li>明确地通过将调度程序传递给这样的运算符</li><li>通过使用 <code>subscribeOn(Scheduler)</code></li><li>通过使用 <code>publishOn(Scheduler)</code></li></ul> 
<p>如果没有其他说明，默认情况下，诸如<code>buffer</code>, <code>replay</code>, <code>skip</code>, <code>delay</code>, <code>parallel</code>等操作符将使用调度程序。</p> 
<p>如果需要，所有列出的运算符都允许你传入自定义调度程序。 大多数时候都使用默认值是一个好主意。</p> 
<p>如果希望在特定的调度程序上执行订阅链，请使用<code>subscribeOn()</code>运算符。</p> 
<p>该代码在未设置调度程序的情况下在主线程上执行：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Map 1: "</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Map 2: "</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>该示例打印以下行：</p> 
<pre><code class="prism language-cobol">Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Ben</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token function">Ben</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Michael</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token function">Michael</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Mark</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token function">Mark</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
</code></pre> 
<p>此示例显示了添加到流中的<code>subscribeOn()</code>方法（在哪里添加都无所谓）：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Map 1: "</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Map 2: "</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribeOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>该示例的输出显示了<code>subscribeOn()</code>的效果。</p> 
<p>你可以看到Publisher在同一线程上执行，但在计算线程池上执行：</p> 
<pre><code class="prism language-cobol">Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Ben</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token function">Ben</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Michael</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token function">Michael</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Mark</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token function">Mark</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果将相同的代码应用于Lettuce，你将注意到执行第二个<code>flatMap()</code>的线程有所不同：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Map 1: "</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> commands<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Map 2: "</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribeOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>该示例打印以下行：</p> 
<pre><code class="prism language-cobol">Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Ben</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Michael</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Mark</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token constant">OK</span> <span class="token punctuation">(</span>lettuce<span class="token operator">-</span>nioEventLoop<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token constant">OK</span> <span class="token punctuation">(</span>lettuce<span class="token operator">-</span>nioEventLoop<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token constant">OK</span> <span class="token punctuation">(</span>lettuce<span class="token operator">-</span>nioEventLoop<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>与独立示例有两点不同：</p> 
<ul><li>这些值是同时设置的，而不是顺序设置的</li><li>第二个<code>flatMap()</code>转换输出netty EventLoop线程名称这是因为默认情况下，Lettuce发布者是在netty EventLoop线程上执行和完成的。</li></ul> 
<p><code>publishOn</code> 指示发布者在特定的Scheduler上调用其观察者的<code>nNext</code>, <code>onError</code>和<code>onCompleted</code> 方法。</p> 
<p>在这里，顺序很重要：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Map 1: "</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> commands<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Map 2: "</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">" ("</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>publishOn()</code>调用之前的所有操作均在main中执行，而调度器中的以下所有操作均在其中执行：</p> 
<pre><code class="prism language-cobol">Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Ben</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Michael</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
Map <span class="token number">1</span><span class="token operator">:</span> <span class="token function">Mark</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token constant">OK</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token constant">OK</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
Map <span class="token number">2</span><span class="token operator">:</span> <span class="token constant">OK</span> <span class="token punctuation">(</span>parallel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>调度程序(Schedulers)允许直接调度操作。 有关更多信息，请参考<a href="https://projectreactor.io/core/docs/api/reactor/core/scheduler/Schedulers.html" rel="nofollow">Project Reactor文档</a>。</p> 
<h4><a id="Scheduler_1888"></a>两种在流中切换执行上下文（或Scheduler）的方式</h4> 
<p>Reactor提供了两种在流中切换执行上下文（或Scheduler）的方式：</p> 
<ul><li>publishOn</li><li>subscribeOn</li></ul> 
<p>我们可以通过这两种方式达到异步执行的目的</p> 
<p><strong>publishOn :</strong></p> 
<p>此运算符影响线程上下文，它下面的链中的其余运算符将在其中执行，直到新出现的publishOn。</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">MILLIS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//1</span>
            <span class="token punctuation">.</span><span class="token function">publishOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//2</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//3</span>
            <span class="token punctuation">.</span><span class="token function">publishOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">elastic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//4</span>
            <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token function">logOfMono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//5</span>
    flux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码中：</p> 
<ol><li>会在调用flux.subscribe()的线程上执行</li><li>指定后续的运算符执行的上下文</li><li>会在parallel线程上执行</li><li>指定后续的运算符执行的上下文</li><li>会在elastic线程上执行</li></ol> 
<p><strong>subscribeOn ：</strong></p> 
<p>整个流在指定的Scheduler的Scheduler.Worker上运行 ，直至出现publishOn ，publishOn后续的操作符由 publishOn 决定执行上下文。</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">MILLIS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//1</span>
            <span class="token punctuation">.</span><span class="token function">publishOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//2</span>
            <span class="token punctuation">.</span><span class="token function">subscribeOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">elastic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token function">logOfMono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    flux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码中：</p> 
<ol><li>会在elastic线程执行</li><li>会在parallel线程上执行，publishOn会“覆盖”subscribeOn的行为</li></ol> 
<p>这样我们就可以异步的去执行方法了。</p> 
<blockquote> 
 <p>Flux依次发出了1，2，3三个元素 无论是subscribeOn、还是publishOn，经过flatMap 都会在 parallel-1 线程上执行，也就是说，Flux中的所有元素只是从主线程发出，在另一个线程中执行。</p> 
</blockquote> 
<h4><a id="_1946"></a>如何实现流的并行</h4> 
<p>在调用一些阻塞方法时（rpc、redis、io），我们期望每个元素经过 flatMap 中时可以运行在不同线程上（串行-&gt; 并发），应该怎么做？</p> 
<h5><a id="_1952"></a>并行的方法</h5> 
<ul><li>1 使用ParallelFlux<br> 将Flux转为ParallelFlux，使用runOn来指明需要的线程池</li><li>2 内部通过publishOn表明执行上下文<br> fluxMap中调用的方法需要在内部通过publishOn表明执行上下文。</li><li>3 创建异步流</li></ul> 
<h5><a id="1_ParallelFlux_1960"></a>1 使用ParallelFlux</h5> 
<p>将Flux转为ParallelFlux，使用runOn来指明需要的线程池</p> 
<p>要获得ParallelFlux，可以在Flux 上使用parallel()运算符。</p> 
<p>为了告诉ParallelFlux在哪里运行每个元素，必须使用runOn(Scheduler)。</p> 
<p>如果并行处理后，您想恢复到“正常”状态 Flux并以顺序方式应用运算符链的其余部分，可以使用sequential()</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token number">3L</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">elastic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token function">logOfMono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">sequential</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    flux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2_publishOn_1980"></a>2 内部通过publishOn表明执行上下文</h5> 
<p>fluxMap中调用的方法需要在内部通过publishOn表明执行上下文。</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token number">3L</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">blockFunction</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//通过publishOn 来表明 blockFunction() 的上下文</span>
<span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">blockFunctionAsync</span><span class="token punctuation">(</span><span class="token class-name">Long</span> i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">elastic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">blockFunction</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">blockFunction</span><span class="token punctuation">(</span><span class="token class-name">Long</span> i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3__2002"></a>3 创建异步流</h5> 
<ol><li>使用 Mono.fromFuture() 创建流</li></ol> 
<pre><code class="prism language-java"><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromFuture</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">blockFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Mono.fromFuture() 创建一个Mono ，需要提供一个 CompletableFuture 产生它的值。</p> 
<p>CompletableFuture.supplyAsync() 返回一个 CompletableFuture，它将在ForkJoinPool.commonPool() 上运行任务，异步完成。</p> 
<p><img src="https://images2.imgbox.com/9b/ac/CFPQn9MX_o.png" alt=""></p> 
<blockquote> 
 <p>ForkJoinPool<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ForkJoinPool.html" rel="nofollow">一个全局线程池</a>，主要应用于计算密集型的场景。</p> 
</blockquote> 
<ol start="2"><li>使用Mono.create() 、Flux.create() 方法创建流</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//自定义线程池</span>
<span class="token keyword">final</span> <span class="token class-name">Executor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">//创建Mono、Flux时 指明上下文</span>
<span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    sink<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token function">blockFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      
<span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userMono <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> bizPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    sink<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span> jpaEntityService<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>dto<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>目前我们推荐使用 这种方法来创建Mono、Flux来实现异步</p> 
<p>这样做的好处：</p> 
<ol><li>Reactor对新手来说有一定理解成本，在调用一个返回值为 Publisher 的类型的方法的时候，不点进去看看，无法知道这是同步方法还是异步响应式方法，这样显示开发人员知道这是一个 响应式方法，避免对于调用者造成的心智负担。</li><li>更方便得使用自定义线程池</li></ol> 
<h5><a id="3_2042"></a>以上3中流并行方法，如何选择？</h5> 
<p>建议查询业务场景 采取合适的方法：</p> 
<p><strong>方法1 ：</strong></p> 
<p>ParallelFlux 不能保证上游元素 返回顺序，不满足多个 sql 有序执行，或者 上游 元素有序执行的 场景。</p> 
<p><strong>方法2：</strong></p> 
<p>Reactor对新手来说有一定理解成本，在调用一个返回值为 Publisher 的类型的方法时，不点进去无法知道这是同步方法还是异步方法，对于调用者存在心智负担。</p> 
<p><strong>方法3.1：</strong></p> 
<p>无法指定自定义线程池</p> 
<p><strong>方法3.2：</strong></p> 
<p>这样做的好处：</p> 
<ol><li>Reactor对新手来说有一定理解成本，在调用一个返回值为 Publisher 的类型的方法的时候，不点进去看看，无法知道这是同步方法还是异步响应式方法，这样显示开发人员知道这是一个 响应式方法，避免对于调用者造成的心智负担。</li><li>更方便得使用自定义线程池</li></ol> 
<h3><a id="Webflux__2067"></a>Webflux 概述</h3> 
<p>简单来说，Webflux 是响应式编程的框架，与其对等的概念是 SpringMVC。</p> 
<p>两者的不同之处在于 Webflux 框架是异步非阻塞的，其可以通过较少的线程处理高并发请求。</p> 
<p>Webflux 的框架底层采用了 Reactor响应式编程框架以及 Netty，关于这两部分内容可以参看我之前的3高基础书籍：</p> 
<p>《<a href="https://www.cnblogs.com/crazymakercircle/p/14493539.html" rel="nofollow">Java高并发核心编程 卷1 加强版</a>》</p> 
<p>作为一个异步框架来说，必须保证整个程序链中的每一步都是异步操作，如果在某一步出现了同步阻塞（如等待数据库 IO），则整个程序还是回出现阻塞的问题。</p> 
<h4><a id="webflux_2079"></a>webflux应用场景</h4> 
<p>既适合IO密集型、磁盘IO密集、网络IO密集等服务场景，也适用于高并发、高吞吐业务场景的响应式改造。</p> 
<p>比如微服务网关，就可以使用webflux技术来显著的提升网关对下游服务的吞吐量，spring cloud gateway就使用了webflux这门技术</p> 
<p><img src="https://images2.imgbox.com/af/8d/xTgI7Un5_o.png" alt=""></p> 
<h4><a id="Spring_boot__webflux_2087"></a>Spring boot webflux介绍</h4> 
<h5><a id="Spring_Boot_20_2089"></a>先提一下Spring Boot 2.0</h5> 
<p><strong>spring.io 官网有句醒目的话是：</strong></p> 
<blockquote> 
 <p>BUILD ANYTHING WITH SPRING BOOT</p> 
</blockquote> 
<p>Spring Boot （Boot 顾名思义，是引导的意思）框架是用于简化 Spring 应用从搭建到开发的过程。</p> 
<p>应用开箱即用，只要通过一个指令，包括命令行 java -jar 、SpringApplication 应用启动类 、 Spring Boot Maven 插件等，就可以启动应用了。</p> 
<p>另外，Spring Boot 强调只需要很少的配置文件，所以在开发生产级 Spring 应用中，让开发变得更加高效和简易。</p> 
<p>目前，Spring Boot 2.x 包括 WebFlux。</p> 
<p><img src="https://images2.imgbox.com/e1/51/8WmF3IK8_o.png" alt=""></p> 
<h5><a id="Spring_Boot_20_WebFlux_2107"></a>Spring Boot 2.0 WebFlux</h5> 
<p>Spring Boot Webflux 就是基于 Reactive Streams 实现的。Spring Boot 2.0 包括一个新的 spring-webflux 模块。</p> 
<p>所以，了解 WebFlux，首先了解下什么是 Reactive Streams。</p> 
<p>Reactive Streams 是 JVM 中面向流的库标准和规范：</p> 
<ul><li>处理可能无限数量的元素</li><li>按顺序处理</li><li>组件之间异步传递</li><li>强制性非阻塞背压（Backpressure）</li></ul> 
<p><strong>Backpressure（背压）</strong></p> 
<p>背压是一种常用策略，使得发布者拥有无限制的缓冲区存储元素，用于确保发布者发布元素太快时，不会去压制订阅者。</p> 
<p><strong>响应式 API</strong></p> 
<p>Reactor 框架是Reactive Streams 的一个实现框架，也是 Spring Boot Webflux 响应库依赖，通过 Reactor 并与其他响应库交互。</p> 
<p>Webflux 提供了 两种响应式 API：Mono 和 Flux。</p> 
<p>Webflux 的处理流程是：一般是将 Publisher 作为输入，在框架内部转换成 Reactor 类型并处理逻辑，然后返回 Flux 或 Mono 作为输出。</p> 
<h4><a id="Spring_Webflux_2134"></a>Spring Webflux</h4> 
<p>Spring Boot Webflux 有两种编程模型实现，一种类似 Spring MVC 注解方式，另一种是使用其功能性端点方式。</p> 
<p><strong>Spring Boot 2.0 WebFlux 特性</strong></p> 
<p>常用的 Spring Boot 2.0 WebFlux 生产的特性如下：</p> 
<ul><li>响应式 API</li><li>编程模型</li><li>适用性</li><li>内嵌容器</li><li>Starter 组件</li></ul> 
<p>还有对日志、Web、消息、测试及扩展等支持。</p> 
<h4><a id="spring_webfluxspring_mvc_2152"></a>spring webflux和spring mvc的异同点</h4> 
<h5><a id="WebFlux__MVC__2154"></a>WebFlux 和 MVC 的交集</h5> 
<p><img src="https://images2.imgbox.com/28/a6/HykKQ0Db_o.png" alt=""></p> 
<p><strong>一图就很明确了，WebFlux 和 MVC 有交集，方便大家迁移。但是注意：</strong></p> 
<ul><li>MVC 能满足场景的，就不需要更改为 WebFlux。</li><li>要注意容器的支持，可以看看下面内嵌容器的支持。</li><li>微服务体系结构，WebFlux 和 MVC 可以混合使用。尤其开发 IO 密集型服务的时候，选择 WebFlux 去实现。</li><li>spring mvc是一个命令式的编程方式采用同步阻塞方式，方便开发人员编写代码和调试；spring webflux调试会非常不方便</li><li>JDBC连接池和JPA等技术还是阻塞模型，传统的关系型数据库如MySQL也不支持非阻塞的方式获取数据，目前只有非关系型数据库如Redis、Mongodb支持非阻塞方式获取数据</li></ul> 
<p><strong>编程模型</strong></p> 
<p>Spring 5 web 模块包含了 Spring WebFlux 的 HTTP 抽象。类似 Servlet API , WebFlux 提供了 WebHandler API 去定义非阻塞 API 抽象接口。可以选择以下两种编程模型实现：</p> 
<ul><li>注解控制层。和 MVC 保持一致，WebFlux 也支持响应性 @RequestBody 注解。</li><li>功能性端点。基于 lambda 轻量级编程模型，用来路由和处理请求的小工具。和上面最大的区别就是，这种模型，全程控制了请求 - 响应的生命流程</li></ul> 
<p><strong>内嵌容器</strong></p> 
<p>跟 Spring Boot 大框架一样启动应用，但 WebFlux 默认是通过 Netty 启动，并且自动设置了默认端口为 8080。另外还提供了对 Jetty、Undertow 等容器的支持。</p> 
<p>开发者自行在添加对应的容器 Starter 组件依赖，即可配置并使用对应内嵌容器实例。</p> 
<p>但是要注意，必须是 Servlet 3.1+ 容器，如 Tomcat、Jetty；或者非 Servlet 容器，如 Netty 和 Undertow。</p> 
<p><strong>Netty优点</strong></p> 
<ul><li>API使用简单、易上手</li><li>功能强大、支持多种主流协议</li><li>定制能力强、可扩展性高</li><li>性能高、综合性能最优</li><li>成熟稳定、久经考验</li><li>社区活跃、学习资料多</li></ul> 
<h5><a id="Netty_selector_2190"></a>Netty selector模型</h5> 
<p><img src="https://images2.imgbox.com/9f/07/AHSggQbj_o.png" alt=""></p> 
<h5><a id="SpringMVC_Spring_WebFlux__2196"></a>SpringMVC 与Spring WebFlux 的根本区别</h5> 
<p>Spring Webflux模块包含对响应式 HTTP 和 WebSocket 客户端的支持，以及对 REST，HTML 和 WebSocket 交互等程序的支持。</p> 
<p>一般来说，Spring MVC 用于同步处理，Spring Webflux 用于异步处理。</p> 
<p>回顾一下，传统的以SpringMVC为代表的webmvc技术使用的是同步阻塞式IO模型</p> 
<img src="https://images2.imgbox.com/cb/a6/ZKBCmdyY_o.png" alt="img"> 
<p>而Spring WebFlux是一个异步非阻塞式IO模型，可以用少量的容器线程支撑大量的并发访问，</p> 
<p>所以Spring WebFlux可以提升吞吐量和伸缩性，但是接口的响应时间并不会缩短，</p> 
<p>其处理结果还是得由worker线程处理完成之后在返回给请求</p> 
<img src="https://images2.imgbox.com/63/d4/Z6C6BX2r_o.png" alt="img"> 
<h4><a id="Webflux__2216"></a>Webflux 基本使用</h4> 
<p>首先创建 maven 项目，在项目的 pom 文件中引入相应的依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-r2dbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-webflux<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>dev.miku<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>r2dbc-mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.8.2.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.18.24<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>创建项目的启动类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebfluxDemoApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">WebfluxDemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此时，我们就可以编写一个简单的 Controller 来感受一下 Webflux 框架异步相应的概念</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ThreadUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">JpaEntityServiceImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiImplicitParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiImplicitParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Flux</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Supplier</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>parallel<span class="token punctuation">.</span></span><span class="token class-name">DBFunctionWrapper</span><span class="token punctuation">.</span><span class="token static">dbFunWrapSafe</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Mono 和 Flux 适用于两个场景，即：
 * Mono：实现发布者，并返回 0 或 1 个元素，即单对象。
 * Flux：实现发布者，并返回 N 个元素，即 List 列表对象。
 * 有人会问，这为啥不直接返回对象，比如返回 City/Long/List。
 * 原因是，直接使用 Flux 和 Mono 是非阻塞写法，相当于回调方式。
 * 利用函数式可以减少了回调，因此会看不到相关接口。这恰恰是 WebFlux 的好处：集合了非阻塞 + 异步
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"用户信息、基础学习DEMO"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"用户信息DEMO"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserReactiveController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> bizPool <span class="token operator">=</span> <span class="token class-name">ThreadUtil</span><span class="token punctuation">.</span><span class="token function">getIoIntenseTargetThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"回显测试"</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">"提示接口使用者注意事项"</span><span class="token punctuation">,</span> httpMethod <span class="token operator">=</span> <span class="token string">"GET"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"string"</span><span class="token punctuation">,</span> dataTypeClass <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"名称"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RestOut</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"方法 hello 被调用了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span><span class="token string">"hello "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述代码中，我们定义了一个异步响应的接口，启动程序调用相应接口，可以看到效果</p> 
<h5><a id="WebFluxSpring_Web_MVC__2324"></a>WebFlux和Spring Web MVC 的组件对比</h5> 
<p>Spring WebFlux不依赖于Servlet API，它可以运行在非Servlet容器Netty、Undertow和任何Servlet 3.1+的Servlet容器（Tomcat，Jetty）之上。</p> 
<p>虽然Servlet 3.1提供了非阻碍I/O的API，但是有很多其它的API依然是同步或阻碍式的；这使得Spring需要重新构建完全基于异步和非阻碍式的运行环境。</p> 
<p>Spring WebFlux最底层的组件是<code>HttpHandler</code>，它用来适配不同的服务器引擎（Netty、Undertow、Tomcat、Jetty）。</p> 
<p>在通过<code>HttpHandler</code>消除了服务器引擎的异构行后，Spring WebFlux的API设计与Spring MVC是高度一致的。</p> 
<p>Spring WebFlux与Spring MVC在概念上有对应的关系：</p> 
<table><thead><tr><th>Spring WebFlux</th><th>Spring Web MVC</th></tr></thead><tbody><tr><td><code>DispatcherHandler</code></td><td><code>DispatcherServlet</code></td></tr><tr><td><code>WebFilter</code></td><td><code>Filter</code></td></tr><tr><td><code>HttpMessageWriter</code> <code>HttpMessageReader</code></td><td><code>HttpMessageConverter</code></td></tr><tr><td><code>HandlerMapping</code></td><td><code>HandlerMapping</code></td></tr><tr><td><code>HandlerAdapter</code></td><td><code>HandlerAdapter</code></td></tr><tr><td><code>ServerHttpRequest</code> <code>ServerHttpResponse</code></td><td><code>ServletRequest</code> <code>ServletResponse</code></td></tr></tbody></table> 
<p>Spring WebFlux支持两种编程模型：</p> 
<ul><li>注解控制器：和Spring MVC使用的注解式保持一致。 
  <ul><li><code>RequestMappingHandlerMapping</code>：映射请求与<code>@RequestMapping</code>控制器类和方法；</li><li><code>RequestMappingHandlerAdapter</code>：调用<code>@RequestMapping</code>注解的方法。<br> Sping MVC的两个类与这两个类名称一致，在不同的包里，有不同的实现，但功能保持一致。</li></ul> </li><li>函数式端点：基于Lambada表达式、轻量级的函数式编程模型。 
  <ul><li><code>RouterFunctionMapping</code>：用来支持<code>RouterFunction</code>；</li><li><code>HandlerFunctionAdapter</code>：用来支持<code>HandlerFunctions</code>。<br> 从Spring 5.2或Spring 2.2.x以后Spring MVC也支持这种编程模型。</li></ul> </li></ul> 
<h4><a id="Spring_Boot_2356"></a>Spring Boot的自动配置</h4> 
<p>Spring Boot提供的自动配置主要有：</p> 
<ul><li><code>CodecsAutoConfiguration</code>：Spring WebFlux使用<code>HttpMessageReader</code>和<code>HttpMessageWriter</code>接口来转换HTTP请求和返回。本配置类为我们注册了<code>CodecCustomizer</code>的Bean，默认使用<code>Jackson2JsonEncoder</code>和<code>Jackson2JsonDecoder</code>。</li><li><code>ReactiveWebServerFactoryAutoConfiguration</code>：为响应式Web服务器进行自动配置。</li><li><code>WebFluxAutoConfiguration</code>：使用等同于<code>@EnableWebFlux</code>的配置开启WebFlux的支持。可通过<code>WebFluxProperties</code>使用<code>spring.webflux.*</code>来对WebFlux进行配置：</li></ul> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">webflux</span><span class="token punctuation">:</span>
      <span class="token key atrule">date-format</span><span class="token punctuation">:</span> yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd <span class="token comment"># 日期格式</span>
      <span class="token key atrule">static-path-pattern</span><span class="token punctuation">:</span> /resouces/static/<span class="token important">**</span> <span class="token comment"># 静态资源目录</span>
</code></pre> 
<ul><li><code>WebClientAutoConfiguration</code>：为<code>WebClient</code>进行自动配置。</li></ul> 
<h3><a id="Reactive_2377"></a>传统代码转为Reactive的桥梁</h3> 
<h4><a id="MonoFluxCreate_Reactive_2379"></a>Mono/FluxCreate ——传统代码转为Reactive的桥梁</h4> 
<p>Reactive Programming 作为观察者模式（Observer） 的延伸，不同于传统的命令编程方式（ Imperative programming）同步拉取数据的方式，如迭代器模式（Iterator） 。</p> 
<p>而是采用数据发布者同步或异步地推送到数据流（Data Streams）的方案。当该数据流（Data Steams）订阅者监听到传播变化时，立即作出响应动作。</p> 
<p>在实现层面上，Reactive Programming 可结合函数式编程简化面向对象语言语法的臃肿性，屏蔽并发实现的复杂细节，提供数据流的有序操作，从而达到提升代码的可读性，以及减少 Bugs 出现的目的。</p> 
<p>同时，Reactive Programming 结合背压（Backpressure）的技术解决发布端生成数据的速率高于订阅端消费的问题。</p> 
<p><code>Project Reactor</code>提供了很多创建Mono/Flux的静态方法，而最常用的就是Mono#create方法，通过该方法能把以前命令式的程序转化为Reactive的编程方式。</p> 
<p>众所周知，Reactive Programming是一种Pull-Push模型，其中Pull用于实现back-pressure，</p> 
<p>Iterator 属于推模式（push-based），Reactive Flux/Mono 属于拉模式（pull-based）</p> 
<p>下面以一个常见的Pull模型迭代器Iterator来说明如何将传统代码转为Reactive的代码。</p> 
<h4><a id="Iterator__Flux__2397"></a>Iterator 推模式-&gt; Flux 拉模式</h4> 
<pre><code class="prism language-java"><span class="token comment">//创建一个迭代器</span>
<span class="token class-name">Iterator</span> it <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span>asList<span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//使用迭代器</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//模拟业务逻辑 —— 这里直接打印value</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面是一个常见的迭代器使用方式，下面看看是如何将迭代器转换成Flux的:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fluxExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//创建迭代器</span>
    <span class="token class-name">Iterator</span> it <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> iteratorFlux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Integer</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//利用FluxSink实现data的Push</span>
        <span class="token punctuation">}</span>
        sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//发送结束的Signal</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">//进行订阅，进行业务逻辑操作</span>
    iteratorFlux<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>输出</p> 
<pre><code class="prism language-bash"><span class="token number">23</span>:29:15.727 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO reactor.Flux.Create.1 - onSubscribe<span class="token punctuation">(</span>FluxCreate.BufferAsyncSink<span class="token punctuation">)</span>
<span class="token number">23</span>:29:15.730 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO reactor.Flux.Create.1 - request<span class="token punctuation">(</span>unbounded<span class="token punctuation">)</span>
<span class="token number">23</span>:29:20.931 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO reactor.Flux.Create.1 - onNext<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token number">23</span>:29:20.931 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO reactor.Flux.Create.1 - onNext<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">2</span>
<span class="token number">23</span>:29:20.931 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO reactor.Flux.Create.1 - onNext<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token number">3</span>
<span class="token number">23</span>:29:20.932 <span class="token punctuation">[</span>main<span class="token punctuation">]</span> INFO reactor.Flux.Create.1 - onComplete<span class="token punctuation">(</span><span class="token punctuation">)</span>
Disconnected from the target VM, address: <span class="token string">'127.0.0.1:58005'</span>, transport: <span class="token string">'socket'</span>

Process finished with <span class="token builtin class-name">exit</span> code <span class="token number">0</span>
</code></pre> 
<h4><a id="MonoCreate_2455"></a>MonoCreate常见的两者使用方式</h4> 
<p>传统命令式编程除了Iterator的Pull模式外，通常还有Observable以及Callback这两种Push模式，下面分别举例讲讲这两种模式。</p> 
<h5><a id="Observable__MonoCreate_2459"></a>Observable -&gt; MonoCreate</h5> 
<p>Observable原始代码举例：</p> 
<pre><code class="prism language-java"><span class="token class-name">Observable</span> observable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//需要重写Observable，默认是setChanged与notifyObservers分离，实现先提交再通知的效果</span>
    <span class="token comment">//这里为了简单起见，将通知与提交放在了一起</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">setChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">notifyObservers</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">Observer</span> first <span class="token operator">=</span> <span class="token punctuation">(</span>ob<span class="token punctuation">,</span>value<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"value is "</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
observable<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
observable<span class="token punctuation">.</span><span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token string">"42"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//    after some time, cancel observer to dispose resource</span>
observable<span class="token punctuation">.</span><span class="token function">deleteObserver</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>MonoCreate的转化示例：</p> 
<pre><code class="prism language-java"><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> observableMono <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Observer</span> first <span class="token operator">=</span> <span class="token punctuation">(</span>ob<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        sink<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    observable<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
    observable<span class="token punctuation">.</span><span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token string">"42"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sink<span class="token punctuation">.</span><span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> observable<span class="token punctuation">.</span><span class="token function">deleteObserver</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
observableMono<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>v <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"value is "</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="Callback__MonoCreate_2497"></a>Callback -&gt; MonoCreate</h5> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callbackExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ListeningExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">MoreExecutors</span><span class="token punctuation">.</span><span class="token function">listeningDecorator</span><span class="token punctuation">(</span>bizPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ListenableFuture</span> future <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mydebug   run, "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">FutureCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">Object</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mydebug   onSuccess, "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> thrown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"mydebug   onFailure, "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>bizPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>MonoCreate的转化示例：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CallbackHandlerInner</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">MonoSink</span> monoSink<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">FutureCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> responseCallback<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CallbackHandlerInner</span><span class="token punctuation">(</span><span class="token class-name">MonoSink</span> monoSink<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>monoSink <span class="token operator">=</span> monoSink<span class="token punctuation">;</span>
        responseCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">" .... 2: FutureCallback   run, "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                monoSink<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                monoSink<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">MonoCreateExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ListeningExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">MoreExecutors</span><span class="token punctuation">.</span><span class="token function">listeningDecorator</span><span class="token punctuation">(</span>bizPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ListenableFuture</span> future <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">" .... 1: mydebug   run, "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"async out"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> responseMono <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>monoSink <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// callback的处理类，并传入monoSink供使用</span>
        <span class="token class-name">CallbackHandlerInner</span> callbackHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CallbackHandlerInner</span><span class="token punctuation">(</span>monoSink<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> callbackHandler<span class="token punctuation">.</span><span class="token function">getResponseCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dbPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    responseMono<span class="token punctuation">.</span><span class="token function">subscribeOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>out <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">" .... 3: final out:, "</span> <span class="token operator">+</span> out<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ThreadUtil</span><span class="token punctuation">.</span><span class="token function">sleepMilliSeconds</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="MonoSink_2575"></a>MonoSink</h4> 
<p>从前面已经可以看到，将传统代码转变为Reactive方式的关键是在于sink，</p> 
<p>在创建Mono/FluxCreate的时候，Mono/Flux都会提供相应的sink给使用方来使用。</p> 
<p>MonoSink相比FluxSink要简单的多，为了简单起见，我们从MonoSink来了解sink的运行原理。下面就来探探Mono下的MonoSink究竟到底是什么。</p> 
<p>再深入MonoSink之前，我们先来看看MonoCreate是怎么使用MonoSink的，对于Reactor来说，所有的入口都是<code>subscribe</code>方法，所以先来看看MonoCreate的subscribe方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">CoreSubscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> actual<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1. 创建MonoSink实例，供MonoCreate来使用</span>
    <span class="token comment">//如变量名字emitter一样，MonoSink的作用其实就是信号的发射器（signal emitter）</span>
    <span class="token class-name">DefaultMonoSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMonoSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2. emitter除了是sink外，也实现了subscription，供Subscriber使用</span>
    <span class="token comment">//这一步，调用Subscriber的onSubscribe方法，其内部则会调用subscription的request方法 （后续会重点说DefaultMonoSink的request方法）</span>
    actual<span class="token punctuation">.</span><span class="token function">onSubscribe</span><span class="token punctuation">(</span>emitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//3. callback就是在Mono.create时候传入的Mono构造器</span>
        <span class="token comment">//此步骤即调用Mono构造器函数，并将sink传入</span>
        callback<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>emitter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        emitter<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">Operators</span><span class="token punctuation">.</span><span class="token function">onOperatorError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> actual<span class="token punctuation">.</span><span class="token function">currentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从上面的源代码可以看出，整个MonoCreate订阅过程很简单，主要是分为三个步骤：</p> 
<ol><li>创建DefaultMonoSink <em>(通过这一步可以看出，一个Subscriber是独占一个MonoSink的)</em></li><li>实现Subscriber的onSubscribe的方法</li><li>调用Mono#create的构造器函数</li></ol> 
<p>以上三个步骤是从整体视角来看的，我们再进一步进入DefaultMonoSink，以它的内部视角，来看看到底作为signal emitter的MonoSink做了些什么。</p> 
<h5><a id="MonoSink__2614"></a>MonoSink 内部状态</h5> 
<p>MonoSink内部主要有4个状态:</p> 
<pre><code class="prism language-java"><span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span> <span class="token comment">//初始默认状态0，即未调用Request且未赋值</span>

<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NO_REQUEST_HAS_VALUE</span>  <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//未调用Request但已经赋值</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HAS_REQUEST_NO_VALUE</span>  <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">//调用了Request但还未赋值</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HAS_REQUEST_HAS_VALUE</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">//调用了Request且已经赋值了</span>
</code></pre> 
<p>这三个状态主要取决于request和success(或者error)的调用时机，调用了request方法则会是<code>HAS_REQUEST</code>，调用了success(或者error)方法则会是<code>HAS_VALUE</code>，其中request方法调用是由Subscriber#onSubscribe调用的，success或者error则是由具体使用者来调用的，如Callback。</p> 
<p>由于success或者error调用时机往往不可能确定（通常是异步的），所以才产生了上述4种状态。</p> 
<p>以同步的角度思考，通常是先调用request然后再调用success或者error方法，其中success会对应调用Subscriber的onNext与onComplete方法，error方法则会调用对应的Subscriber#onError方法。但事情往往没这么简单，就如前面提到的，request方法与success/error方法是乱序的，很有可能在request的时候，success/error方法已经调用结束了。</p> 
<p>为了解决这个问题，每个方法都引入了for-loop加CAS的多线程操作，变得相对复杂了，但只要知道其内部原理，再复杂的代码看起来就都有线索了，下面以request方法为例，来讲讲是MonoSink是如何解决多线程问题的。</p> 
<h5><a id="MonoSink_request_2634"></a>MonoSink request方法解释</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Operators</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LongConsumer</span> consumer <span class="token operator">=</span> requestConsumer<span class="token punctuation">;</span>
        <span class="token comment">//1. 如果传入了requestConsumer，则调用</span>
        <span class="token comment">//requestConsumer是通过onRequest方法传入的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>consumer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            consumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//2. 进入for loop来实现自旋</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>
            <span class="token comment">//2.1 HAS_Request: 已经调用过了，直接退出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">HAS_REQUEST_NO_VALUE</span> <span class="token operator">||</span> s <span class="token operator">==</span> <span class="token constant">HAS_REQUEST_HAS_VALUE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NO_REQUEST_HAS_VALUE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 2.2 double check 是否已经有值</span>
                <span class="token comment">// 如果是，执行onNext/onComplete方法，并设置完成状态: HAS_REQUEST_HAS_VALUE</span>
                <span class="token comment">// 如果不是，double check失败，直接退出，说明有别的线程已经执行了该方法了</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">STATE</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token constant">HAS_REQUEST_HAS_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        actual<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        actual<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//释放资源 - 具体调用的disposable对象由onDisposable方法赋值</span>
                        <span class="token function">disposeResource</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//2.3 正常流程，值没有被赋值，设置为HAS_REQUEST_NO_VALUE</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">STATE</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token constant">HAS_REQUEST_NO_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="MonoSink_2677"></a>MonoSink回调方法</h4> 
<p>MonoSink除了request、success、error方法外，还提供了几个回调函数，以供使用者使用，主要有：</p> 
<pre><code class="prism language-java"><span class="token comment">//request的时候会被调用，获取request的数量N</span>
<span class="token class-name">MonoSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">onRequest</span><span class="token punctuation">(</span><span class="token class-name">LongConsumer</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Subscriber调用subscription.cancel是会调用该Disposable方法</span>
<span class="token class-name">MonoSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">onCancel</span><span class="token punctuation">(</span><span class="token class-name">Disposable</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//与onCancel类似，区别是，除了onCancel方法，在onComplete以及onError也会调用该Disposable方法</span>
<span class="token class-name">MonoSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">onDispose</span><span class="token punctuation">(</span><span class="token class-name">Disposable</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里简单讲一下Reactor的代码命名规范，对于回调函数都是以onXXX方式命名，注意调用该onXXX方式的时候，<strong>并不是直接调用，而只是传入该回调方法，待对应的事件信号发生时，才会真的被调用</strong>。</p> 
<p>这也是声明式编程的一个特色，先声明再执行。</p> 
<h3><a id="_2698"></a>全链路异步化改造，性能提升十倍</h3> 
<p>结论来自于，尼恩的实操，具体请参考下面的文章</p> 
<p><a href="https://blog.csdn.net/crazymakercircle/article/details/129004814">全链路异步，让你的 SpringCloud 性能优化10倍+</a></p> 
<h3><a id="WebFlux__allegrotech_2706"></a>案例分析：微服务迁移到WebFlux - allegro.tech</h3> 
<p>原文：</p> 
<p>https://blog.allegro.tech/2019/07/migrating-microservice-to-spring-webflux.html</p> 
<p>响应式编程在这几个月内一直是许多会议演讲的热门话题。找到简单的代码示例和教程并将它们应用于allegro新项目是毫不费力的。</p> 
<p>当需要从现有解决方案迁移时，特别是它是具有<strong>数百万用户</strong>和<strong>每秒数千个请求</strong>的生产服务时，事情变得有点复杂。</p> 
<p>在本文中，我想 通过一个Allegro微服务的例子讨论从[Spring Web MVC到 [Spring WebFlux的迁移策略 。</p> 
<p>我将展示一些常见的陷阱，以及生产中的性能指标如何受迁移的影响。</p> 
<p><strong>改变的动机</strong><br> 在详细探讨迁移策略之前，让我们先讨论其变更的动机。</p> 
<p>其中一个由我的团队开发和维护的<strong>微服务</strong>，参与了2018年7月18日的重大Allegro停运（详见<a href="https://allegro.tech/2018/08/postmortem-why-allegro-went-down.html" rel="nofollow">尸检）</a>）。</p> 
<p>虽然我们的微服务不是问题的根本原因，但由于<strong>线程池饱和</strong>，一些实例也崩溃了。</p> 
<p>临时修复是：增加线程池大小并减少外部服务调用的超时; 然而，这还不够。</p> 
<p>临时解决方案仅略微提高了外部服务延迟的吞吐量和弹性。</p> 
<p>我们决定转而使用<strong>非阻塞方法</strong>来彻底摆脱线程池作为并发的基础。</p> 
<p>使用WebFlux的另一个动机是新项目，它使我们的微服务中的外部服务调用流程变得复杂。</p> 
<p>无论复杂程度如何增加，我们都面临着保持代码库可维护性和可读性的挑战。</p> 
<p>我们看到WebFlux比我们之前基于Java 8的解决方案（CompletableFuture可以模拟复杂的流程）更加友好。</p> 
<h4><a id="_2741"></a>什么时候迁移？</h4> 
<p>每一种新兴技术都倾向于其炒作周期。</p> 
<p>玩一种新的解决方案，特别是在生产环境中，仅仅因为它新鲜，有光泽和嗡嗡声</p> 
<p>尝鲜可能导致沮丧，有时甚至是灾难性的后果。</p> 
<p>每个软件供应商都想宣传他的产品，并说服客户使用它。</p> 
<p>但是，WebFlux的官方 Pivotal 表现得非常负责任，密切关注那些最好不要迁移到WebFlux的场景。官方文件的<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" rel="nofollow">第1.1.4部分</a>详细介绍了这一点。</p> 
<p><strong>官方文件最重要的几点是：</strong></p> 
<ul><li><strong>不要改变工作正常的东西。</strong></li></ul> 
<p>如果您的服务中没有性能问题，或扩展性问题，建议不要迁移，而是<strong>找一个更好的地方来尝试WebFlux</strong>。</p> 
<ul><li><strong>阻塞式API和WebFlux不是最好的朋友。</strong></li></ul> 
<p>他们可以合作，但把阻塞式API迁移到响应式编程，不会有效率提升。</p> 
<p>如果没有迁移恰当，一个阻塞调用可以锁定整个应用程序。</p> 
<ul><li><strong>团队的学习曲线，特别是如果没有响应性编程的经验，可能会很陡峭</strong>。</li></ul> 
<p>你应该在迁移过程中非常注意人为因素。</p> 
<p>我们来谈谈性能。</p> 
<p>对此有很多误解。反应Reactive并不意味着马上、自动大的提升性能，提升性能还有很多工作要做。WebFlux文档警告我们，以非阻塞方式执行操作需要做更多工作。</p> 
<p>响应式闪耀点：等待其他服务响应不会阻塞线程。</p> 
<p>因此，获得相同吞吐量所需的线程更少，线程越少意味着使用的内存越少。</p> 
<p>始终建议检查独立来源以避免框架作者的偏见。</p> 
<h4><a id="WebFlux_2779"></a>迁移到WebFlux有四个指标</h4> 
<p>总而言之，迁移到WebFlux有四个指标如果符合则可行：</p> 
<ul><li>当前的技术栈没有解决低性能和可<strong>扩展性</strong>的问题。</li><li>对外部服务或数据库的调用很多，响应速度可能很慢。</li><li>现有的阻塞依赖项可以很容易地被替换为响应式API。</li><li>开发团队面临新的挑战并愿意学习。</li></ul> 
<h4><a id="_2788"></a>三阶段迁移策略</h4> 
<p>根据我们的迁移经验，我想介绍三阶段迁移策略。</p> 
<p>为什么3个阶段？</p> 
<p>如果我们谈论具有大型代码库的实时服务，每秒数千个请求和数百万用户， 从头开始​​重写是一个相当大的风险。</p> 
<p>让我们看看如何在后续的小步骤中将应用程序从Spring Web MVC迁移到Spring WebFlux，从而实现从阻塞到非阻塞世界的平滑过渡。</p> 
<h5><a id="1___2798"></a>第1阶段，入门 - 迁移一小段代码</h5> 
<p>通常，首先在系统的非关键部分尝试新技术是一种很好的做法。</p> 
<p>响应式技术也不例外。这个阶段的想法是只要找到一个非关键特性功能，它又是被封装在一个阻塞方法调用中，那就将其重写为非阻塞风格。</p> 
<p>让我们看看执行此阻塞方法的示例，该方法用于RestTemplate从外部服务检索结果。</p> 
<pre><code class="prism language-java"><span class="token class-name">Pizza</span> <span class="token function">getPizzaBlocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/pizza/"</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">Pizza</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RestClientException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PizzaException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们从丰富的WebFlux功能集中选择一件事 - 反应式WebClient - 并使用它以非阻塞方式重写此方法：</p> 
<pre><code class="prism language-java"><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pizza</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPizzaReactive</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> webClient
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/pizza/"</span> <span class="token operator">+</span> id<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">bodyToMono</span><span class="token punctuation">(</span><span class="token class-name">Pizza</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onErrorMap</span><span class="token punctuation">(</span><span class="token class-name">PizzaException</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>现在是时候将我们的新方法与应用程序的其余部分连接起来了。</p> 
<p>非阻塞方法返回Mono，但我们需要一个普通类型。</p> 
<p>我们可以使用Mono.block()方法从中检索值。</p> 
<pre><code class="prism language-java"><span class="token class-name">Pizza</span> <span class="token function">getPizzaBlocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">getPizzaReactive</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最终，我们的方法仍在都塞等待。</p> 
<p>但是，它内部使用了非阻塞库。</p> 
<p>此阶段的主要目标是熟悉非阻塞API。这种更改对应用程序的其余部分是透明的，易于测试并可部署到生产环境中。</p> 
<h5><a id="___2847"></a>第二阶段，主菜 - 将关键路径转换为非阻塞方法</h5> 
<p>在使用WebClient转换一小段代码后，我们准备更进一步。</p> 
<p>第二阶段的目标是将应用程序的关键路径转换为非阻塞 - 从HTTP客户端到处理外部服务响应的类，再到控制器。</p> 
<p>在这个阶段，重要的是<strong>避免重写所有代码</strong>。</p> 
<p>应用程序中较不重要的部分，例如没有外部调用或很少使用的部分，应该保持不变。</p> 
<p>我们需要关注非阻塞方法揭示其优势的领域。</p> 
<pre><code class="prism language-java"><span class="token comment">//parallel call to two services using Java8 CompletableFuture</span>
<span class="token class-name">Food</span> <span class="token function">orderFoodBlocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">completedFuture</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FoodBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> pizzaService<span class="token punctuation">.</span><span class="token function">getPizzaBlocking</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> executorService<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">FoodBuilder</span><span class="token operator">::</span><span class="token function">withPizza</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> hamburgerService<span class="token punctuation">.</span><span class="token function">getHamburgerBlocking</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> executorService<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">FoodBuilder</span><span class="token operator">::</span><span class="token function">withHamburger</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> <span class="token operator">|</span> <span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FoodException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//parallel call to two services using Reactor</span>
<span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Food</span><span class="token punctuation">&gt;</span></span> <span class="token function">orderFoodReactive</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FoodBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">zipWith</span><span class="token punctuation">(</span>pizzaService<span class="token punctuation">.</span><span class="token function">getPizzaReactive</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">FoodBuilder</span><span class="token operator">::</span><span class="token function">withPizza</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">zipWith</span><span class="token punctuation">(</span>hamburgerService<span class="token punctuation">.</span><span class="token function">getHamburgerReactive</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">FoodBuilder</span><span class="token operator">::</span><span class="token function">withHamburger</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">FoodBuilder</span><span class="token operator">::</span><span class="token function">build</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">onErrorMap</span><span class="token punctuation">(</span><span class="token class-name">FoodException</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用.subscribeOn()方法，可以轻松地将阻塞部分系统与非阻塞代码合并。</p> 
<p>可以使用默认的Reactor调度器之一，或者我们自己创建并提供的线程池ExecutorService。</p> 
<pre><code class="prism language-java"><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pizza</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPizzaReactive</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromSupplier</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getPizzaBlocking</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribeOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">fromExecutorService</span><span class="token punctuation">(</span>executorService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此外，只需对控制器进行少量更改即可 - 将返回类型更改Foo为<code>Mono&lt;Foo&gt;</code>或<code>Flux&lt;Foo&gt;</code>。</p> 
<p>它甚至可以在Spring Web MVC中运行 - 您不需要将整个应用程序的堆栈更改为被动。</p> 
<p>第2阶段的成功实施为我们提供了非阻塞方法的所有主要优点。是时候测量并检查我们的问题是否已解决。</p> 
<h5><a id="3__WebFlux_2900"></a>第3阶段，甜点 - 让我们改变WebFlux的一切！</h5> 
<p>我们可以在第2阶段之后做更多的事情。</p> 
<p>我们可以重写代码中不太关键的部分，并使用Netty服务器而不是servlet。</p> 
<p>我们也可以删除@Controller注释并将端点重写为函数风格，尽管这是因为风格和个人偏好去改写，而非性能的问题去改写。</p> 
<p>这里的关键问题是：这些优势的成本是多少？</p> 
<p>代码可以一直重构，并且通常定义“足够好”的点是很有挑战性的。</p> 
<p>在我们的案例中，我们没有决定更进一步。重写整个代码库需要很多工作。</p> 
<p>帕累托原则结果证明是有效的一次。</p> 
<p>我们认为我们已经取得了显着的收益，而后续的收益也相对较高。</p> 
<p>作为一般规则 - 当我们从头开始编写新服务时，获得WebFlux的所有特权是很好的。</p> 
<p>另一方面，当我们重构现有（微）服务时，通常最好尽可能少地完成工作。</p> 
<h4><a id="_2922"></a>迁移陷阱以及经验教训</h4> 
<h5><a id="1___2926"></a>问题1 - 缺乏订阅</h5> 
<p>WebFlux初学者有时会忘记反应流往往尽可能地会惰加载。</p> 
<p>由于缺少订阅，以下功能永远不会向控制台打印任何内容：</p> 
<pre><code class="prism language-java"><span class="token class-name">Food</span> <span class="token function">orderFood</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">FoodBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FoodBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withPizza</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pizza</span><span class="token punctuation">(</span><span class="token string">"margherita"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    hamburgerService<span class="token punctuation">.</span><span class="token function">getHamburgerReactive</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span>builder<span class="token operator">::</span><span class="token function">withHamburger</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//hamburger will never be set, </span>
    <span class="token comment">//because Mono returned from getHamburgerReactive() is not subscribed to</span>

    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>教训： 每一个Mono和Flux都需要进行订阅。</p> 
<p>在控制器中返回的 响应式类型就是一种隐式订阅。</p> 
<h5><a id="2__blockReactor_2948"></a>问题2 - .block()在Reactor线程中</h5> 
<p>正如我之前所展示的（在第1阶段），.block()有时用于将反应函数加入到阻塞代码中。</p> 
<pre><code class="prism language-java"><span class="token class-name">Food</span> <span class="token function">getFoodBlocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> foodService<span class="token punctuation">.</span><span class="token function">orderFoodReactive</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在Reactor线程中无法调用此函数。这种尝试会导致以下错误：</p> 
<pre><code class="prism language-java"><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">blockFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">blockLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> are blocking<span class="token punctuation">,</span> which is not supported in thread reactor<span class="token operator">-</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">2</span>
</code></pre> 
<p>.block()只允许在其他线程中使用显式用法（请参阅参考资料.subscribeOn()）。</p> 
<p>Reactor抛出一个异常并告知我们这个问题是有帮助的。</p> 
<p>不幸的是，许多其他方案允许将阻塞代码插入到Reactor线程中，这不会自动检测到。</p> 
<p>学到的经验教训：</p> 
<ul><li>.block()只能在scheduler中执行的代码中使用。</li><li>更好的是避免使用.block()。</li></ul> 
<h5><a id="3__Reactor_2977"></a>问题3 - 阻塞Reactor线程中的代码</h5> 
<p>没有什么能阻止我们将阻塞代码添加到被动流中。</p> 
<p>而且，我们不需要使用.block()- 我们可以通过使用可以阻止当前线程的库无意识地引入阻塞。</p> 
<p>请考虑以下代码示例。第一个类似于正确的“响应式”延迟。</p> 
<pre><code class="prism language-java"><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Food</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFood</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> foodService<span class="token punctuation">.</span><span class="token function">orderFood</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">delayElement</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>另一个示例模拟了一个危险的延迟，它阻塞了订户线程。</p> 
<pre><code class="prism language-java"><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Food</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFood</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> foodService
      <span class="token punctuation">.</span><span class="token function">orderFood</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span>food <span class="token operator">-&gt;</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>一目了然，这两个版本似乎都有效。</p> 
<p>当我们在localhost上运行此应用程序并尝试请求服务时，我们可以看到类似的行为。</p> 
<p>“Hello，world！”在延迟1秒后返回。</p> 
<p>然而，这种观察极具误导性。</p> 
<p>实际上，具有反应式延迟（上一段代码）的版本在重负载下运行良好，另一方面，具有阻塞延迟（下一段代码）的版本重负载下运行糟糕。</p> 
<p>所以，大家要重视对应用程序进行性能测试，尤其是考虑外部调用的延迟。</p> 
<h5><a id="4___3016"></a>问题4 - 意外的代码执行</h5> 
<p>Reactor有许多有用的方法，有助于编写富有表现力和声明性的代码。</p> 
<p>但是，其中一些可能有点棘手。</p> 
<p>请考虑以下代码：</p> 
<pre><code class="prism language-java"><span class="token class-name">String</span> valueFromCache <span class="token operator">=</span> <span class="token string">"some non-empty value"</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">justOrEmpty</span><span class="token punctuation">(</span>valueFromCache<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">switchIfEmpty</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token function">getValueFromService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们使用类似的代码检查特定值的缓存，然后在缺少值时调用外部服务。</p> 
<p>作者的意图似乎很明确：getValueFromService() 仅在缺少缓存值的情况下执行。</p> 
<p><strong>但是，此代码每次都会运行，即使是缓存命中也是如此。</strong></p> 
<p>赋给.switchIfEmpty()的参数不是lambda，而是Mono.just()直接执行作为参数传递的代码。</p> 
<p>显而易见的解决方案是使用Mono.fromSupplier()，并将条件代码作为lambda传递，如下例所示：</p> 
<pre><code class="prism language-java"><span class="token class-name">String</span> valueFromCache <span class="token operator">=</span> <span class="token string">"some non-empty value"</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">justOrEmpty</span><span class="token punctuation">(</span>valueFromCache<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">switchIfEmpty</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromSupplier</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getValueFromService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>经验教训： Reactor API有许多不同的方法。</p> 
<p>始终考虑一个问题：参数是应该按原样传递，还是用lambda包装。</p> 
<h4><a id="_3050"></a>迁移带来的好处</h4> 
<p>总结一下，在迁移到WebFlux之后检查我们服务的生产指标。</p> 
<p>明显而直接的影响是应用程序使用的线程数量减少。</p> 
<p>有趣的是，我们没有将应用程序类型更改为Reactive（我们仍然使用servlet，有关详细信息，请参阅第3阶段），但Undertow工作线程的使用也变小了一个数量级。</p> 
<p>低级指标如何受到影响？</p> 
<p>我们观察到更少的垃圾收集，并且他们花费的时间更少。</p> 
<p>每10分钟的GC次数<br> <img src="https://images2.imgbox.com/48/ca/Nye8zfZk_o.png" alt="GC count comparison — reactive vs blocking"></p> 
<p>每10分钟的GC耗时</p> 
<p><img src="https://images2.imgbox.com/04/4d/1lMM8W4d_o.png" alt="GC time comparison — reactive vs blocking"></p> 
<p>此外，响应时间略有下降，但我们没有预料到这样的效果。</p> 
<p>其他指标（如CPU负载，文件描述符使用情况和消耗的总内存）未发生变化。我们的服务也做了很多工作，这与调用无关。将流量迁移到HTTP客户端和控制器周围的响应是至关重要的，但在资源使用方面并不重要。</p> 
<p>正如我在开始时所说的那样，**迁移的预期收益是延迟的可扩展性和弹性。我们确信我们已经实现了这一目标。</p> 
<p><strong>结论</strong><br> 您是否正在迁移现有的微服务？考虑到文章中涉及的因素，不仅仅是技术因素 - 检查时间和人员使用新解决方案的能力。</p> 
<p>始终测试您的应用程序 , 在迁移过程中，覆盖外部耗时调用的集成和性能测试至关重要。</p> 
<p>请记住，响应式思维不同于众所周知的阻塞式、命令式思维。</p> 
<h3><a id="Lettuce_Reactive_API_3084"></a>Lettuce Reactive API</h3> 
<p>spring默认redis连接库lettuce性能优化，突破性能天花板,获得官方建议方式2倍吞吐量</p> 
<p>spring-data-redis性能优化，使用lettuce库连接池模式，比官方推荐方式性能翻倍。</p> 
<p>所有命令都返回订阅者可以订阅的<code>Flux&lt;T&gt;</code>, <code>Mono&lt;T&gt;</code>或<code>Mono&lt;Void&gt;</code>。</p> 
<p>该订阅者对<code>Publisher &lt;T&gt;</code>发出的任何项目或项目序列做出反应。</p> 
<p>此模式有助于并发操作，因为在等待<code>Publisher&lt;T&gt;</code>发出对象时不需要阻塞。 相反，它以订阅者的形式创建一个哨兵，随时准备在<code>Publisher&lt;T&gt;</code>以后的任何时间做出适当的反应。</p> 
<h4><a id="LettuceFluxMono_3096"></a>使用Lettuce创建<code>Flux</code>和<code>Mono</code></h4> 
<p>建立发布者的方法有很多。</p> 
<p>你已经看过<code>just()</code>，<code>take()</code>和<code>collectList()</code>。 有关可用于创建<code>Flux</code>和<code>Mono</code>的更多方法，请参考<a href="http://projectreactor.io/docs/" rel="nofollow">Project Reactor文档</a>。</p> 
<p>Lettuce发布者可用于初始和链接（chaining）操作。</p> 
<p>使用Lettuce发布者时，你会注意到非阻塞行为。</p> 
<p>这是因为所有的I/O和命令处理都是使用netty EventLoop异步处理的。</p> 
<p>连接到Redis非常简单：</p> 
<pre><code class="prism language-java"><span class="token class-name">RedisClient</span> client <span class="token operator">=</span> <span class="token class-name">RedisClient</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"redis://localhost"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RedisStringReactiveCommands</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> commands <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>下一步，从键获取值需要GET操作：</p> 
<pre><code class="prism language-java">commands<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>或者，用Java 8 lambdas编写：</p> 
<pre><code class="prism language-java">commands
   <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>执行是异步处理的，并且在Netty EventLoop线程上完成操作时，可以使用调用线程在处理中进行处理。 由于其解耦性质，可以在完成<code>Publisher&lt;T&gt;</code>的执行之前保留调用方法。</p> 
<p>可以在链接（chaining）的上下文中使用Lettuce发布者来异步加载多个键：</p> 
<pre><code class="prism language-java"><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">"Ben"</span><span class="token punctuation">,</span> <span class="token string">"Michael"</span><span class="token punctuation">,</span> <span class="token string">"Mark"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">flatMap</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> commands<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
        <span class="token function">subscribe</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Got value: "</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_3144"></a>性能验证</h4> 
<p>文章已经太长，这里不做赘述，具体请参考<a href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/%E7%96%AF%E7%8B%82%E5%88%9B%E5%AE%A2%E5%9C%88%E6%80%BB%E7%9B%AE%E5%BD%95.md" rel="nofollow">尼恩3高架构笔记</a></p> 
<h3><a id="Spring_Cloud__Gateway_3150"></a>Spring Cloud Gateway的开发</h3> 
<h4><a id="_SpringCloud_Gateway__3152"></a>姊妹篇：关于 SpringCloud Gateway 简介</h4> 
<p>SpringCloud Gateway 是 Spring Cloud 的一个全新项目，该项目是基于 Spring 5.0，Spring Boot 2.0 和 Project Reactor 等技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。</p> 
<p>SpringCloud Gateway 作为 Spring Cloud 生态系统中的网关，目标是替代 Zuul，</p> 
<p>在Spring Cloud 2.0以上版本中，没有对新版本的Zuul 2.0以上最新高性能版本进行集成，</p> 
<p>仍然还是使用的Zuul 2.0之前的非Reactor模式的老版本。</p> 
<p>而为了提升网关的性能，SpringCloud Gateway是基于WebFlux框架实现的，而WebFlux框架底层则使用了高性能的Reactor模式通信框架Netty。</p> 
<p>Spring Cloud Gateway 的目标，不仅提供统一的路由方式，并且基于 Filter 链的方式提供了网关基本的功能，例如：安全，监控/指标，和限流。</p> 
<p>有关 Spring Cloud Gateway 实战， 具体请参考尼恩的 深度文章：</p> 
<p><a href="https://www.cnblogs.com/crazymakercircle/p/11704077.html" rel="nofollow">《SpringCloud gateway （史上最全））》</a></p> 
<p><strong>特别说明</strong>：</p> 
<p>Spring Cloud Gateway 底层使用了高性能的通信框架Netty。</p> 
<p>Netty 是高性能中间件的通讯底座， rocketmq 、seata、nacos 、sentinel 、redission 、dubbo 等太多、太多的的大名鼎鼎的中间件，无一例外都是基于netty。</p> 
<p>可以毫不夸张的说： <strong>netty 是进入大厂、走向高端 的必备技能</strong>。</p> 
<p>要想深入了解springcloud gateway ，<strong>最好是掌握netty 编程</strong>。</p> 
<p>有关 netty学习 具体请参见机工社出版 、尼恩的畅销书: <a href="https://www.cnblogs.com/crazymakercircle/p/14493539.html" rel="nofollow">《<strong>Java高并发核心编程卷 1</strong>》</a></p> 
<h4><a id="ServerWebExchange_3186"></a>ServerWebExchange交换机</h4> 
<h5><a id="ServerWebExchange_3188"></a>理解ServerWebExchange</h5> 
<p>先看<code>ServerWebExchange</code>的注释：</p> 
<blockquote> 
 <p>Contract for an HTTP request-response interaction.</p> 
 <p>Provides access to the HTTP request and response and also exposes additional server-side processing related properties and features such as request attributes.</p> 
</blockquote> 
<p>翻译一下大概是：</p> 
<blockquote> 
 <p>ServerWebExchange是一个HTTP请求-响应交互的契约。</p> 
 <p>提供对HTTP请求和响应的访问，并公开额外的服务器端处理相关属性和特性，如请求属性。</p> 
</blockquote> 
<p>其实，<code>ServerWebExchange</code>命名为<strong>服务网络交换器</strong>，存放着重要的请求-响应属性、请求实例和响应实例等等，有点像<code>Context</code>的角色。</p> 
<h5><a id="ServerWebExchange_3204"></a><code>ServerWebExchange</code>与过滤器的关系：</h5> 
<p>Spring Cloud Gateway同zuul类似，有“pre”和“post”两种方式的filter。</p> 
<p>客户端的请求先经过“pre”类型的filter，然后将请求转发到具体的业务服务，收到业务服务的响应之后，再经过“post”类型的filter处理，最后返回响应到客户端。</p> 
<p>引用Spring Cloud Gateway官网上的一张图：<br> <img src="https://images2.imgbox.com/71/a9/8QJb35sI_o.png" alt=""></p> 
<p>与zuul不同的是，filter除了分为“pre”和“post”两种方式的filter外，在Spring Cloud Gateway中，filter从作用范围可分为另外两种，</p> 
<p>一种是<strong>针对于单个路由的gateway filter</strong>，它在配置文件中的写法同predict类似；</p> 
<p>一种是<strong>针对于所有路由的global gateway filer</strong>。</p> 
<p>现在从作用范围划分的维度来讲解这两种filter。</p> 
<p>我们在使用<code>Spring Cloud Gateway</code>的时候，注意到过滤器（包括<code>GatewayFilter</code>、<code>GlobalFilter</code>和过滤器链<code>GatewayFilterChain</code>）。</p> 
<p>Spring Cloud Gateway根据作用范围划分为GatewayFilter和GlobalFilter，二者区别如下：</p> 
<ul><li><strong>GatewayFilter</strong> : 需要通过spring.cloud.routes.filters 配置在具体路由下，只作用在当前路由上或通过spring.cloud.default-filters配置在全局，作用在所有路由上</li><li><strong>GlobalFilter</strong> : 全局过滤器，不需要在配置文件中配置，作用在所有的路由上，最终通过GatewayFilterAdapter包装成GatewayFilterChain可识别的过滤器，它为请求业务以及路由的URI转换为真实业务服务的请求地址的核心过滤器，不需要配置，系统初始化时加载，并作用在每个路由上。</li></ul> 
<p>Spring Cloud Gateway框架内置的GlobalFilter如下：</p> 
<p><img src="https://images2.imgbox.com/04/6d/nyLGf7dk_o.png" alt=""></p> 
<p>上图中每一个GlobalFilter都作用在每一个router上，能够满足大多数的需求。</p> 
<p>但是如果遇到业务上的定制，可能需要编写满足自己需求的GlobalFilter。</p> 
<p>过滤器都依赖到<code>ServerWebExchange</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GlobalFilter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GatewayFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ShortcutConfigurable</span> <span class="token punctuation">{<!-- --></span>

	<span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">GatewayFilterChain</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>    
</code></pre> 
<p>这里的设计和<code>Servlet</code>中的<code>Filter</code>是相似的，</p> 
<p>当前过滤器可以决定是否执行下一个过滤器的逻辑，由<code>GatewayFilterChain#filter()</code>是否被调用来决定。</p> 
<p>而<code>ServerWebExchange</code>就相当于当前请求和响应的上下文。</p> 
<p><code>ServerWebExchange</code>实例不单存储了<code>Request</code>和<code>Response</code>对象，还提供了一些扩展方法，如果想实现改造请求参数或者响应参数，就必须深入了解<code>ServerWebExchange</code>。</p> 
<h5><a id="ServerWebExchange_3265"></a>ServerWebExchange接口</h5> 
<p><code>ServerWebExchange</code>接口的所有方法：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerWebExchange</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 日志前缀属性的KEY，值为org.springframework.web.server.ServerWebExchange.LOG_ID</span>
    <span class="token comment">// 可以理解为 attributes.set("org.springframework.web.server.ServerWebExchange.LOG_ID","日志前缀的具体值");</span>
    <span class="token comment">// 作用是打印日志的时候会拼接这个KEY对饮的前缀值，默认值为""</span>
    String <span class="token constant">LOG_ID_ATTRIBUTE</span> <span class="token operator">=</span> ServerWebExchange<span class="token punctuation">.</span>class<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".LOG_ID"</span><span class="token punctuation">;</span>
    String <span class="token function">getLogPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取ServerHttpRequest对象</span>
    ServerHttpRequest <span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取ServerHttpResponse对象</span>
    ServerHttpResponse <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 返回当前exchange的请求属性，返回结果是一个可变的Map</span>
    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> <span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 根据KEY获取请求属性</span>
    @Nullable
    <span class="token keyword">default</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token constant">T</span> <span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token parameter">String name</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">T</span><span class="token punctuation">)</span> <span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 根据KEY获取请求属性，做了非空判断</span>
    @<span class="token function">SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token constant">T</span> <span class="token function">getRequiredAttribute</span><span class="token punctuation">(</span><span class="token parameter">String name</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">T</span> value <span class="token operator">=</span> <span class="token function">getAttribute</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"Required attribute '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"' is missing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

     <span class="token comment">// 根据KEY获取请求属性，需要提供默认值</span>
    @<span class="token function">SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token constant">T</span> <span class="token function">getAttributeOrDefault</span><span class="token punctuation">(</span><span class="token parameter">String name<span class="token punctuation">,</span> <span class="token constant">T</span> defaultValue</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">T</span><span class="token punctuation">)</span> <span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

    <span class="token comment">// 返回当前请求的网络会话</span>
    Mono<span class="token operator">&lt;</span>WebSession<span class="token operator">&gt;</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回当前请求的认证用户，如果存在的话</span>
    <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Principal</span><span class="token operator">&gt;</span> Mono<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    
    <span class="token comment">// 返回请求的表单数据或者一个空的Map，只有Content-Type为application/x-www-form-urlencoded的时候这个方法才会返回一个非空的Map -- 这个一般是表单数据提交用到</span>
    Mono<span class="token operator">&lt;</span>MultiValueMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;&gt;</span> <span class="token function">getFormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    
    <span class="token comment">// 返回multipart请求的part数据或者一个空的Map，只有Content-Type为multipart/form-data的时候这个方法才会返回一个非空的Map  -- 这个一般是文件上传用到</span>
    Mono<span class="token operator">&lt;</span>MultiValueMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Part<span class="token operator">&gt;&gt;</span> <span class="token function">getMultipartData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 返回Spring的上下文</span>
    @Nullable
    ApplicationContext <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

    <span class="token comment">// 这几个方法和lastModified属性相关</span>
    boolean <span class="token function">isNotModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolean <span class="token function">checkNotModified</span><span class="token punctuation">(</span>Instant lastModified<span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolean <span class="token function">checkNotModified</span><span class="token punctuation">(</span>String etag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    boolean <span class="token function">checkNotModified</span><span class="token punctuation">(</span>@Nullable String etag<span class="token punctuation">,</span> Instant lastModified<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// URL转换</span>
    String <span class="token function">transformUrl</span><span class="token punctuation">(</span>String url<span class="token punctuation">)</span><span class="token punctuation">;</span>    
   
    <span class="token comment">// URL转换映射</span>
    <span class="token keyword">void</span> <span class="token function">addUrlTransformer</span><span class="token punctuation">(</span>Function<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> transformer<span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token comment">// 注意这个方法，方法名是：改变，这个是修改ServerWebExchange属性的方法，返回的是一个Builder实例，Builder是ServerWebExchange的内部类</span>
    <span class="token keyword">default</span> Builder <span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultServerWebExchangeBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">interface</span> <span class="token class-name">Builder</span> <span class="token punctuation">{<!-- --></span>      
         
        <span class="token comment">// 覆盖ServerHttpRequest</span>
        Builder <span class="token function">request</span><span class="token punctuation">(</span>Consumer<span class="token operator">&lt;</span>ServerHttpRequest<span class="token punctuation">.</span>Builder<span class="token operator">&gt;</span> requestBuilderConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Builder <span class="token function">request</span><span class="token punctuation">(</span>ServerHttpRequest request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 覆盖ServerHttpResponse</span>
        Builder <span class="token function">response</span><span class="token punctuation">(</span>ServerHttpResponse response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 覆盖当前请求的认证用户</span>
        Builder <span class="token function">principal</span><span class="token punctuation">(</span>Mono<span class="token operator">&lt;</span>Principal<span class="token operator">&gt;</span> principalMono<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 构建新的ServerWebExchange实例</span>
        ServerWebExchange <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre> 
<h5><a id="ServerWebExchangemutate__3358"></a>ServerWebExchange#mutate() 方法</h5> 
<p>注意到<code>ServerWebExchange#mutate()</code>方法，<code>ServerWebExchange</code>实例可以理解为不可变实例，</p> 
<p>如果我们想要修改它，需要通过<code>mutate()</code>方法生成一个新的实例，例如这样：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span> <span class="token punctuation">{<!-- --></span>

    @Override
    <span class="token keyword">public</span> Mono<span class="token operator">&lt;</span>Void<span class="token operator">&gt;</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">ServerWebExchange exchange<span class="token punctuation">,</span> GatewayFilterChain chain</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ServerHttpRequest request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里可以修改ServerHttpRequest实例</span>
        ServerHttpRequest newRequest <span class="token operator">=</span> <span class="token operator">...</span>
        ServerHttpResponse response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里可以修改ServerHttpResponse实例</span>
        ServerHttpResponse newResponse <span class="token operator">=</span> <span class="token operator">...</span>
        <span class="token comment">// 构建新的ServerWebExchange实例</span>
        ServerWebExchange newExchange <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>newRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>newResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>newExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="ServerHttpRequest_3382"></a>ServerHttpRequest接口</h5> 
<p><code>ServerHttpRequest</code>实例是用于承载请求相关的属性和请求体，</p> 
<p><code>Spring Cloud Gateway</code>中底层使用<code>Netty</code>处理网络请求，通过追溯源码，</p> 
<p>可以从<code>ReactorHttpHandlerAdapter</code>中得知<code>ServerWebExchange</code>实例中持有的<code>ServerHttpRequest</code>实例的具体实现是<code>ReactorServerHttpRequest</code>。</p> 
<p>之所以列出这些实例之间的关系，是因为这样比较容易理清一些隐含的问题，例如：</p> 
<ul><li><strong><code>ReactorServerHttpRequest</code>的父类<code>AbstractServerHttpRequest</code>中初始化内部属性headers的时候把请求的HTTP头部封装为只读的实例</strong>：</li></ul> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token function">AbstractServerHttpRequest</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">URI</span> uri<span class="token punctuation">,</span> @Nullable String contextPath<span class="token punctuation">,</span> HttpHeaders headers</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>uri <span class="token operator">=</span> uri<span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> RequestPath<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> contextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>headers <span class="token operator">=</span> HttpHeaders<span class="token punctuation">.</span><span class="token function">readOnlyHttpHeaders</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// HttpHeaders类中的readOnlyHttpHeaders方法，</span>
<span class="token comment">// ReadOnlyHttpHeaders屏蔽了所有修改请求头的方法，直接抛出UnsupportedOperationException</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> HttpHeaders <span class="token function">readOnlyHttpHeaders</span><span class="token punctuation">(</span><span class="token parameter">HttpHeaders headers</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">"HttpHeaders must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>headers <span class="token keyword">instanceof</span> <span class="token class-name">ReadOnlyHttpHeaders</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> headers<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReadOnlyHttpHeaders</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>所以, <strong>不能直接从<code>ServerHttpRequest</code>实例中直接获取请求头<code>HttpHeaders</code>实例并且进行修改</strong>。</p> 
<p><code>ServerHttpRequest</code>接口如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HttpMessage</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// 获取请求头，目前的实现中返回的是ReadOnlyHttpHeaders实例，只读</span>
    HttpHeaders <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>    

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReactiveHttpInputMessage</span> <span class="token keyword">extends</span> <span class="token class-name">HttpMessage</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// 返回请求体的Flux封装</span>
    Flux<span class="token operator">&lt;</span>DataBuffer<span class="token operator">&gt;</span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HttpRequest</span> <span class="token keyword">extends</span> <span class="token class-name">HttpMessage</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 返回HTTP请求方法，解析为HttpMethod实例</span>
    @Nullable
    <span class="token keyword">default</span> HttpMethod <span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> HttpMethod<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">getMethodValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 返回HTTP请求方法，字符串</span>
    String <span class="token function">getMethodValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    
    <span class="token comment">// 请求的URI</span>
    <span class="token constant">URI</span> <span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>    

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerHttpRequest</span> <span class="token keyword">extends</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">,</span> ReactiveHttpInputMessage <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// 连接的唯一标识或者用于日志处理标识</span>
    String <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    
    <span class="token comment">// 获取请求路径，封装为RequestPath对象</span>
    RequestPath <span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 返回查询参数，是只读的MultiValueMap实例</span>
    MultiValueMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> <span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回Cookie集合，是只读的MultiValueMap实例</span>
    MultiValueMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> HttpCookie<span class="token operator">&gt;</span> <span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    
    <span class="token comment">// 远程服务器地址信息</span>
    @Nullable
    <span class="token keyword">default</span> InetSocketAddress <span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// SSL会话实现的相关信息</span>
    @Nullable
    <span class="token keyword">default</span> SslInfo <span class="token function">getSslInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
    
    <span class="token comment">// 修改请求的方法，返回一个建造器实例Builder，Builder是内部类</span>
    <span class="token keyword">default</span> ServerHttpRequest<span class="token punctuation">.</span>Builder <span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultServerHttpRequestBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

    <span class="token keyword">interface</span> <span class="token class-name">Builder</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">// 覆盖请求方法</span>
        Builder <span class="token function">method</span><span class="token punctuation">(</span>HttpMethod httpMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
		 
        <span class="token comment">// 覆盖请求的URI、请求路径或者上下文，这三者相互有制约关系，具体可以参考API注释</span>
        Builder <span class="token function">uri</span><span class="token punctuation">(</span><span class="token constant">URI</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Builder <span class="token function">path</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Builder <span class="token function">contextPath</span><span class="token punctuation">(</span>String contextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 覆盖请求头</span>
        Builder <span class="token function">header</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> String value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Builder <span class="token function">headers</span><span class="token punctuation">(</span>Consumer<span class="token operator">&lt;</span>HttpHeaders<span class="token operator">&gt;</span> headersConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 覆盖SslInfo</span>
        Builder <span class="token function">sslInfo</span><span class="token punctuation">(</span>SslInfo sslInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 构建一个新的ServerHttpRequest实例</span>
        ServerHttpRequest <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>         
<span class="token punctuation">}</span>    
</code></pre> 
<p><strong>注意：</strong></p> 
<p><code>ServerHttpRequest</code>或者说<code>HttpMessage</code>接口提供的获取请求头方法<code>HttpHeaders getHeaders();</code></p> 
<p>返回结果是一个只读的实例，具体是<code>ReadOnlyHttpHeaders</code>类型，</p> 
<p>如果要修改<code>ServerHttpRequest</code>实例，那么需要这样做：</p> 
<pre><code class="prism language-java"><span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServerHttpRequest</span> newRequest <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"/myPath"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="ServerHttpResponse_3515"></a>ServerHttpResponse接口</h5> 
<p><code>ServerHttpResponse</code>实例是用于承载响应相关的属性和响应体，</p> 
<p><code>Spring Cloud Gateway</code>中底层使用<code>Netty</code>处理网络请求，通过追溯源码，可以从<code>ReactorHttpHandlerAdapter</code>中得知<code>ServerWebExchange</code>实例中持有的<code>ServerHttpResponse</code>实例的具体实现是<code>ReactorServerHttpResponse</code>。</p> 
<p>之所以列出这些实例之间的关系，是因为这样比较容易理清一些隐含的问题，例如：</p> 
<pre><code class="prism language-javascript"><span class="token comment">// ReactorServerHttpResponse的父类</span>
<span class="token keyword">public</span> <span class="token function">AbstractServerHttpResponse</span><span class="token punctuation">(</span><span class="token parameter">DataBufferFactory dataBufferFactory<span class="token punctuation">,</span> HttpHeaders headers</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>dataBufferFactory<span class="token punctuation">,</span> <span class="token string">"DataBufferFactory must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> <span class="token string">"HttpHeaders must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>dataBufferFactory <span class="token operator">=</span> dataBufferFactory<span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>headers <span class="token operator">=</span> headers<span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>cookies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token function">ReactorServerHttpResponse</span><span class="token punctuation">(</span><span class="token parameter">HttpServerResponse response<span class="token punctuation">,</span> DataBufferFactory bufferFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">super</span><span class="token punctuation">(</span>bufferFactory<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyHeadersAdapter</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">responseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"HttpServerResponse must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可知<code>ReactorServerHttpResponse</code>构造函数初始化实例的时候，存放响应Header的是<code>HttpHeaders</code>实例，也就是响应Header是可以直接修改的。</p> 
<p><code>ServerHttpResponse</code>接口如下：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HttpMessage</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// 获取响应Header，目前的实现中返回的是HttpHeaders实例，可以直接修改</span>
    HttpHeaders <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>  

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReactiveHttpOutputMessage</span> <span class="token keyword">extends</span> <span class="token class-name">HttpMessage</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// 获取DataBufferFactory实例，用于包装或者生成数据缓冲区DataBuffer实例(创建响应体)</span>
    DataBufferFactory <span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 注册一个动作，在HttpOutputMessage提交之前此动作会进行回调</span>
    <span class="token keyword">void</span> <span class="token function">beforeCommit</span><span class="token punctuation">(</span>Supplier<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Mono</span><span class="token operator">&lt;</span>Void<span class="token operator">&gt;&gt;</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断HttpOutputMessage是否已经提交</span>
    boolean <span class="token function">isCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 写入消息体到HTTP协议层</span>
    Mono<span class="token operator">&lt;</span>Void<span class="token operator">&gt;</span> <span class="token function">writeWith</span><span class="token punctuation">(</span>Publisher<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataBuffer</span><span class="token operator">&gt;</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 写入消息体到HTTP协议层并且刷新缓冲区</span>
    Mono<span class="token operator">&lt;</span>Void<span class="token operator">&gt;</span> <span class="token function">writeAndFlushWith</span><span class="token punctuation">(</span>Publisher<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Publisher</span><span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataBuffer</span><span class="token operator">&gt;&gt;</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 指明消息处理已经结束，一般在消息处理结束自动调用此方法，多次调用不会产生副作用</span>
    Mono<span class="token operator">&lt;</span>Void<span class="token operator">&gt;</span> <span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerHttpResponse</span> <span class="token keyword">extends</span> <span class="token class-name">ReactiveHttpOutputMessage</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// 设置响应状态码</span>
    boolean <span class="token function">setStatusCode</span><span class="token punctuation">(</span>@Nullable HttpStatus status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取响应状态码</span>
    @Nullable
    HttpStatus <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取响应Cookie，封装为MultiValueMap实例，可以修改</span>
    MultiValueMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ResponseCookie<span class="token operator">&gt;</span> <span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    
    <span class="token comment">// 添加响应Cookie</span>
    <span class="token keyword">void</span> <span class="token function">addCookie</span><span class="token punctuation">(</span>ResponseCookie cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>    
</code></pre> 
<p>这里可以看到除了响应体比较难修改之外，其他的属性都是可变的。</p> 
<h5><a id="ServerWebExchangeUtils_3593"></a>ServerWebExchangeUtils和上下文属性</h5> 
<p><code>ServerWebExchangeUtils</code>里面存放了很多静态公有的字符串KEY值</p> 
<p>(<strong>这些字符串KEY的实际值是</strong><code>org.springframework.cloud.gateway.support.ServerWebExchangeUtils.</code> + 下面任意的静态公有KEY)，</p> 
<p>这些字符串KEY值一般是用于<code>ServerWebExchange</code>的属性(<code>Attribute</code>，见上文的<code>ServerWebExchange#getAttributes()</code>方法)的KEY，这些属性值都是有特殊的含义，在使用过滤器的时候如果时机适当可以直接取出来使用，下面逐个分析。</p> 
<ul><li><code>PRESERVE_HOST_HEADER_ATTRIBUTE</code>：是否保存Host属性，值是布尔值类型，写入位置是<code>PreserveHostHeaderGatewayFilterFactory</code>，使用的位置是<code>NettyRoutingFilter</code>，作用是如果设置为true，HTTP请求头中的Host属性会写到底层Reactor-Netty的请求Header属性中。</li><li><code>CLIENT_RESPONSE_ATTR</code>：保存底层Reactor-Netty的响应对象，类型是<code>reactor.netty.http.client.HttpClientResponse</code>。</li><li><code>CLIENT_RESPONSE_CONN_ATTR</code>：保存底层Reactor-Netty的连接对象，类型是<code>reactor.netty.Connection</code>。</li><li><code>URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>：<code>PathRoutePredicateFactory</code>解析路径参数完成之后，把解析完成后的占位符KEY-路径Path映射存放在<code>ServerWebExchange</code>的属性中，KEY就是<code>URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>。</li><li><code>CLIENT_RESPONSE_HEADER_NAMES</code>：保存底层Reactor-Netty的响应Header的名称集合。</li><li><code>GATEWAY_ROUTE_ATTR</code>：用于存放<code>RoutePredicateHandlerMapping</code>中匹配出来的具体的路由(<code>org.springframework.cloud.gateway.route.Route</code>)实例，通过这个路由实例可以得知当前请求会路由到下游哪个服务。</li><li><code>GATEWAY_REQUEST_URL_ATTR</code>：<code>java.net.URI</code>类型的实例，这个实例代表直接请求或者负载均衡处理之后需要请求到下游服务的真实URI。</li><li><code>GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code>：<code>java.net.URI</code>类型的实例，需要重写请求URI的时候，保存原始的请求URI。</li><li><code>GATEWAY_HANDLER_MAPPER_ATTR</code>：保存当前使用的<code>HandlerMapping</code>具体实例的类型简称(一般是字符串"RoutePredicateHandlerMapping")。</li><li><code>GATEWAY_SCHEME_PREFIX_ATTR</code>：确定目标路由URI中如果存在schemeSpecificPart属性，则保存该URI的scheme在此属性中，路由URI会被重新构造，见<code>RouteToRequestUrlFilter</code>。</li><li><code>GATEWAY_PREDICATE_ROUTE_ATTR</code>：用于存放<code>RoutePredicateHandlerMapping</code>中匹配出来的具体的路由(<code>org.springframework.cloud.gateway.route.Route</code>)实例的ID。</li><li><code>WEIGHT_ATTR</code>：实验性功能(此版本还不建议在正式版本使用)存放分组权重相关属性，见<code>WeightCalculatorWebFilter</code>。</li><li><code>ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR</code>：存放响应Header中的ContentType的值。</li><li><code>HYSTRIX_EXECUTION_EXCEPTION_ATTR</code>：<code>Throwable</code>的实例，存放的是Hystrix执行异常时候的异常实例，见<code>HystrixGatewayFilterFactory</code>。</li><li><code>GATEWAY_ALREADY_ROUTED_ATTR</code>：布尔值，用于判断是否已经进行了路由，见<code>NettyRoutingFilter</code>。</li><li><code>GATEWAY_ALREADY_PREFIXED_ATTR</code>：布尔值，用于判断请求路径是否被添加了前置部分，见<code>PrefixPathGatewayFilterFactory</code>。</li></ul> 
<p><code>ServerWebExchangeUtils</code>提供的上下文属性用于<code>Spring Cloud Gateway</code>的<code>ServerWebExchange</code>组件处理请求和响应的时候，内部一些重要实例或者标识属性的安全传输和使用，使用它们可能存在一定的风险，</p> 
<p>因为没有人可以确定在版本升级之后，原有的属性KEY或者VALUE是否会发生改变，如果评估过风险或者规避了风险之后，可以安心使用。</p> 
<p>例如我们**在做请求和响应日志(类似Nginx的Access Log)的时候，可以依赖到<code>GATEWAY_ROUTE_ATTR</code>，因为我们要打印路由的目标信息。**举个简单例子：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessLogFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pathWithinApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpMethod</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取路由的目标URI</span>
        <span class="token class-name">URI</span> targetUri <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchangeUtils</span><span class="token punctuation">.</span><span class="token constant">GATEWAY_REQUEST_URL_ATTR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InetSocketAddress</span> remoteAddress <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromRunnable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HttpStatus</span> statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"请求路径:{},客户端远程IP地址:{},请求方法:{},目标URI:{},响应码:{}"</span><span class="token punctuation">,</span>
                    path<span class="token punctuation">,</span> remoteAddress<span class="token punctuation">,</span> method<span class="token punctuation">,</span> targetUri<span class="token punctuation">,</span> statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_3649"></a>修改请求体和响应体</h4> 
<h5><a id="_3651"></a>修改请求体</h5> 
<p>修改请求体是一个比较常见的需求。</p> 
<p>例如我们使用<code>Spring Cloud Gateway</code>实现网关的时候，要实现一个功能：</p> 
<blockquote> 
 <p>把存放在请求头中的JWT解析后，提取里面的用户ID，然后写入到请求体中。</p> 
</blockquote> 
<p>我们简化这个场景，假设我们把userId明文存放在请求头中的accessToken中，请求体是一个JSON结构：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"serialNumber"</span><span class="token operator">:</span> <span class="token string">"请求流水号"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"payload"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ... 这里是有效载荷，存放具体的数据</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们需要提取accessToken，也就是userId插入到请求体JSON中如下：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"userId"</span><span class="token operator">:</span> <span class="token string">"用户ID"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"serialNumber"</span><span class="token operator">:</span> <span class="token string">"请求流水号"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"payload"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ... 这里是有效载荷，存放具体的数据</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里为了简化设计，用全局过滤器<code>GlobalFilter</code>实现，实际需要结合具体场景考虑：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ModifyRequestBodyGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DataBufferFactory</span> dataBufferFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyDataBufferFactory</span><span class="token punctuation">(</span><span class="token class-name">ByteBufAllocator</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> accessToken <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"accessToken"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"accessToken"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 新建一个ServerHttpRequest装饰器,覆盖需要装饰的方法</span>
        <span class="token class-name">ServerHttpRequestDecorator</span> decorator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerHttpRequestDecorator</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">InputStreamHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                body<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>buffer <span class="token operator">-&gt;</span> holder<span class="token punctuation">.</span>inputStream <span class="token operator">=</span> buffer<span class="token punctuation">.</span><span class="token function">asInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> holder<span class="token punctuation">.</span>inputStream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        
                        <span class="token comment">// 解析JSON的节点</span>
                        <span class="token class-name">JsonNode</span> jsonNode <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>jsonNode <span class="token keyword">instanceof</span> <span class="token class-name">ObjectNode</span><span class="token punctuation">,</span> <span class="token string">"JSON格式异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">ObjectNode</span> objectNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">;</span>
                        
                        <span class="token comment">// JSON节点最外层写入新的属性</span>
                        objectNode<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">DataBuffer</span> dataBuffer <span class="token operator">=</span> dataBufferFactory<span class="token punctuation">.</span><span class="token function">allocateBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> json <span class="token operator">=</span> objectNode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"最终的JSON数据为:{}"</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        dataBuffer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        
                        <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用修改后的ServerHttpRequestDecorator重新生成一个新的ServerWebExchange</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>decorator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">InputStreamHolder</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">InputStream</span> inputStream<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试一下：</p> 
<pre><code class="prism language-html">// HTTP
POST /order/json HTTP/1.1
Host: localhost:9090
Content-Type: application/json
accessToken: 10086
Accept: */*
Cache-Control: no-cache
Host: localhost:9090
accept-encoding: gzip, deflate
content-length: 94
Connection: keep-alive
cache-control: no-cache

{
    "serialNumber": "请求流水号",
    "payload": {
        "name": "doge"
    }
}

// 日志输出
最终的JSON数据为:{"serialNumber":"请求流水号","payload":{"name":"doge"},"userId":"10086"}
</code></pre> 
<p>最重要的是用到了<code>ServerHttpRequest</code>装饰器<code>ServerHttpRequestDecorator</code>，主要覆盖对应获取请求体数据缓冲区的方法即可，至于怎么处理其他逻辑需要自行考虑，这里只是做一个简单的示范。</p> 
<p>一般的代码逻辑如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServerHttpRequestDecorator</span> requestDecorator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerHttpRequestDecorator</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// 拿到承载原始请求体的Flux</span>
         <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 这里通过自定义方式生成新的承载请求体的Flux</span>
         <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> newBody <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token keyword">return</span> newBody<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>            
<span class="token punctuation">}</span>
<span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>requestDecorator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
</code></pre> 
<h5><a id="_3791"></a>修改响应体</h5> 
<p>修改响应体的需求也是比较常见的，具体的做法和修改请求体差不多。</p> 
<p>例如我们想要实现下面的功能：第三方服务请求经过网关，原始报文是密文，我们需要在网关实现密文解密，然后把解密后的明文路由到下游服务，下游服务处理成功响应明文，需要在网关把明文加密成密文再返回到第三方服务。</p> 
<p>现在简化整个流程，用AES加密算法，统一密码为字符串"throwable"，假设请求报文和响应报文明文如下：</p> 
<pre><code class="prism language-json"><span class="token comment">// 请求密文</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"serialNumber"</span><span class="token operator">:</span> <span class="token string">"请求流水号"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"payload"</span> <span class="token operator">:</span> <span class="token string">"加密后的请求消息载荷"</span>
<span class="token punctuation">}</span>

<span class="token comment">// 请求明文（仅仅作为提示）</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"serialNumber"</span><span class="token operator">:</span> <span class="token string">"请求流水号"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"payload"</span> <span class="token operator">:</span> <span class="token string">"{\"name:\":\"doge\"}"</span>
<span class="token punctuation">}</span>

<span class="token comment">// 响应密文</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string-property property">"message"</span><span class="token operator">:</span><span class="token string">"ok"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"payload"</span> <span class="token operator">:</span> <span class="token string">"加密后的响应消息载荷"</span>
<span class="token punctuation">}</span>

<span class="token comment">// 响应明文（仅仅作为提示）</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token string-property property">"message"</span><span class="token operator">:</span><span class="token string">"ok"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"payload"</span> <span class="token operator">:</span> <span class="token string">"{\"name:\":\"doge\",\"age\":26}"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>为了方便一些加解密或者编码解码的实现，需要引入<code>Apache</code>的<code>commons-codec</code>类库：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>这里定义一个全局过滤器专门处理加解密，实际上最好结合真实的场景决定是否适合全局过滤器，这里只是一个示例：</p> 
<pre><code class="prism language-java"><span class="token comment">// AES加解密工具类</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">AesUtils</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 单例</span>
    <span class="token class-name">X</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PASSWORD</span> <span class="token operator">=</span> <span class="token string">"throwable"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY_ALGORITHM</span> <span class="token operator">=</span> <span class="token string">"AES"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECURE_RANDOM_ALGORITHM</span> <span class="token operator">=</span> <span class="token string">"SHA1PRNG"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEFAULT_CIPHER_ALGORITHM</span> <span class="token operator">=</span> <span class="token string">"AES/ECB/PKCS5Padding"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_CIPHER_ALGORITHM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">ENCRYPT_MODE</span><span class="token punctuation">,</span> <span class="token function">provideSecretKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encodeHexString</span><span class="token punctuation">(</span>cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_CIPHER_ALGORITHM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">DECRYPT_MODE</span><span class="token punctuation">,</span> <span class="token function">provideSecretKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span><span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">decodeHex</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">SecretKey</span> <span class="token function">provideSecretKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">KeyGenerator</span> keyGen <span class="token operator">=</span> <span class="token class-name">KeyGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token constant">KEY_ALGORITHM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SecureRandom</span> secureRandom <span class="token operator">=</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token constant">SECURE_RANDOM_ALGORITHM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            secureRandom<span class="token punctuation">.</span><span class="token function">setSeed</span><span class="token punctuation">(</span><span class="token constant">PASSWORD</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyGen<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> secureRandom<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>keyGen<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">KEY_ALGORITHM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// EncryptionGlobalFilter</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EncryptionGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 响应体</span>
        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataBufferFactory</span> bufferFactory <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServerHttpRequestDecorator</span> requestDecorator <span class="token operator">=</span> <span class="token function">processRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> bufferFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServerHttpResponseDecorator</span> responseDecorator <span class="token operator">=</span> <span class="token function">processResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> bufferFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>requestDecorator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>responseDecorator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ServerHttpRequestDecorator</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">DataBufferFactory</span> bufferFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataBufferHolder</span> holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataBufferHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        body<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>dataBuffer <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> dataBuffer<span class="token punctuation">.</span><span class="token function">readableByteCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            holder<span class="token punctuation">.</span>length <span class="token operator">=</span> len<span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
            dataBuffer<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBufferUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JsonNode</span> jsonNode <span class="token operator">=</span> <span class="token function">readNode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JsonNode</span> payload <span class="token operator">=</span> jsonNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> payloadText <span class="token operator">=</span> payload<span class="token punctuation">.</span><span class="token function">asText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> <span class="token class-name">AesUtils<span class="token punctuation">.</span>X</span><span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>payloadText<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> requestBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"修改请求体payload,修改前:{},修改后:{}"</span><span class="token punctuation">,</span> payloadText<span class="token punctuation">,</span> requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">rewritePayloadNode</span><span class="token punctuation">(</span>requestBody<span class="token punctuation">,</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBuffer</span> data <span class="token operator">=</span> bufferFactory<span class="token punctuation">.</span><span class="token function">allocateBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>jsonNode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            holder<span class="token punctuation">.</span>dataBuffer <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">CONTENT_LENGTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServerHttpRequestDecorator</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">HttpHeaders</span> <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> contentLength <span class="token operator">=</span> holder<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    headers<span class="token punctuation">.</span><span class="token function">setContentLength</span><span class="token punctuation">(</span>contentLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">TRANSFER_ENCODING</span><span class="token punctuation">,</span> <span class="token string">"chunked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> headers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ServerHttpResponseDecorator</span> <span class="token function">processResponse</span><span class="token punctuation">(</span><span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">DataBufferFactory</span> bufferFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServerHttpResponseDecorator</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Publisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token keyword">instanceof</span> <span class="token class-name">Flux</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> body<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span>flux<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>buffer <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">CharBuffer</span> charBuffer <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">asByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">DataBufferUtils</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">JsonNode</span> jsonNode <span class="token operator">=</span> <span class="token function">readNode</span><span class="token punctuation">(</span>charBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">JsonNode</span> payload <span class="token operator">=</span> jsonNode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> text <span class="token operator">=</span> payload<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">AesUtils<span class="token punctuation">.</span>X</span><span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"修改响应体payload,修改前:{},修改后:{}"</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setPayloadTextNode</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> bufferFactory<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>jsonNode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rewritePayloadNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">JsonNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ObjectNode</span> objectNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> root<span class="token punctuation">;</span>
            objectNode<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setPayloadTextNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">JsonNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ObjectNode</span> objectNode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> root<span class="token punctuation">;</span>
            objectNode<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TextNode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">JsonNode</span> <span class="token function">readNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> in<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> objectMapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DataBufferHolder</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">DataBuffer</span> dataBuffer<span class="token punctuation">;</span>
        <span class="token keyword">int</span> length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre> 
<p>先准备一份密文：</p> 
<pre><code class="prism language-java"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"serialNumber"</span><span class="token punctuation">,</span> <span class="token string">"请求流水号"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token string">"{\"name\": \"doge\"}"</span><span class="token punctuation">;</span>
json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> <span class="token class-name">AesUtils<span class="token punctuation">.</span>X</span><span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"serialNumber"</span><span class="token operator">:</span><span class="token string">"请求流水号"</span><span class="token punctuation">,</span><span class="token string">"payload"</span><span class="token operator">:</span><span class="token string">"144e3dc734743f5709f1adf857bca473da683246fd612f86ac70edeb5f2d2729"</span><span class="token punctuation">}</span>
</code></pre> 
<p>模拟请求：</p> 
<pre><code class="prism language-html">POST /order/json HTTP/1.1
Host: localhost:9090
accessToken: 10086
Content-Type: application/json
User-Agent: PostmanRuntime/7.13.0
Accept: */*
Cache-Control: no-cache
Postman-Token: bda07fc3-ea1a-478c-b4d7-754fe6f37200,634734d9-feed-4fc9-ba20-7618bd986e1c
Host: localhost:9090
cookie: customCookieName=customCookieValue
accept-encoding: gzip, deflate
content-length: 104
Connection: keep-alive
cache-control: no-cache

{
    "serialNumber": "请求流水号",
    "payload": "FE49xzR0P1cJ8a34V7ykc9poMkb9YS+GrHDt618tJyk="
}

// 响应结果
{
    "serialNumber": "请求流水号",
    "payload": "oo/K1igg2t/S8EExkBVGWOfI1gAh5pBpZ0wyjNPW6e8="   # &lt;--- 解密后：{"name":"doge","age":26}
}
</code></pre> 
<p>遇到的问题：</p> 
<ul><li><strong>必须实现<code>Ordered</code>接口，返回一个小于-1的order值，这是因为<code>NettyWriteResponseFilter</code>的order值为-1</strong>，我们需要覆盖返回响应体的逻辑，自定义的<code>GlobalFilter</code>必须比<code>NettyWriteResponseFilter</code>优先执行。</li><li>网关每次重启之后，第一个请求总是无法从原始的<code>ServerHttpRequest</code>读取到有效的Body，准确来说出现的现象是<code>NettyRoutingFilter</code>调用<code>ServerHttpRequest#getBody()</code>的时候获取到一个空的对象，导致空指针；奇怪的是从第二个请求开始就能正常调用。<strong>笔者把<code>Spring Cloud Gateway</code>的版本降低到<code>Finchley.SR3</code>，<code>Spring Boot</code>的版本降低到<code>2.0.8.RELEASE</code>，问题不再出现，初步确定是<code>Spring Cloud Gateway</code>版本升级导致的兼容性问题或者是BUG</strong>。</li></ul> 
<p>最重要的是用到了<code>ServerHttpResponse</code>装饰器<code>ServerHttpResponseDecorator</code>，主要覆盖写入响应体数据缓冲区的部分，至于怎么处理其他逻辑需要自行考虑，这里只是做一个简单的示范。一般的代码逻辑如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServerHttpResponseDecorator</span> responseDecorator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerHttpResponseDecorator</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Publisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token keyword">instanceof</span> <span class="token class-name">Flux</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span> flux <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> body<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span>flux<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>buffer <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// buffer就是原始的响应数据的缓冲区</span>
                <span class="token comment">// 下面处理完毕之后返回新的响应数据的缓冲区即可</span>
                <span class="token keyword">return</span> bufferFactory<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">response</span><span class="token punctuation">(</span>responseDecorator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
</code></pre> 
<h3><a id="Webflux__R2DBC__MySQL_4084"></a>Webflux + R2DBC 操作 MySQL</h3> 
<p>R2DBC 是一个异步操作数据库的驱动，区别于传统的同步数据库驱动 JDBC，R2DBC 与数据库的各种操作也是异步的，这将大量节省高并发系统的线程数量。</p> 
<p>首先，创建一个 User 实体类用于测试，同时在 MySQL 中创建相应的数据库以及表结构</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span><span class="token string">"webflux_user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>编写数据仓库层，使用 Spring-data 封装好的简单 CRUD 接口（用法类似 JPA）</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span></span><span class="token class-name">ReactiveCrudRepository</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">ReactiveCrudRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<p>此时就可以调用封装好的 CRUD 方法进行简单的增删改查操作了。</p> 
<p>在 Webflux 框架中，我们可以使用 SpringMVC 中 Controller + Service 的模式进行开发，也可以使用 Webflux 中 route + handler 的模式进行开发。</p> 
<h4><a id="Controller__Service_4124"></a>Controller + Service</h4> 
<p>编写 Service 调用 UserRepository</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">UserRepository</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Flux</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RestOut</span><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">delUser</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> userRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span> <span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token function">succeed</span><span class="token punctuation">(</span><span class="token string">"delete ok "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultIfEmpty</span><span class="token punctuation">(</span><span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token function">succeed</span><span class="token punctuation">(</span><span class="token string">"没有找到数据 "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RestOut</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>user0 <span class="token operator">-&gt;</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user0 <span class="token operator">-&gt;</span> <span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultIfEmpty</span><span class="token punctuation">(</span><span class="token class-name">RestOut</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token function">succeed</span><span class="token punctuation">(</span><span class="token string">"没有找到数据 "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>编写 Controller 进行测试</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>common<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">UserService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">RestOut</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Flux</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RestOut</span><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">delUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">delUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PutMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RestOut</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">updateUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getAllUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Route__Handler_4211"></a>Route + Handler</h4> 
<p>handler 就相当于定义很多处理器，其中不同的方法负责处理不同路由的请求，其对应的是传统的 Service 层</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>handler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">UserRepository</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>crazymaker<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>function<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>function<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token class-name">ServerRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">bodyToMono</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">delUser</span><span class="token punctuation">(</span><span class="token class-name">ServerRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">pathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> userRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">switchIfEmpty</span><span class="token punctuation">(</span><span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">notFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token class-name">ServerRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">bodyToMono</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllUser</span><span class="token punctuation">(</span><span class="token class-name">ServerRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAllUserStream</span><span class="token punctuation">(</span><span class="token class-name">ServerRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">TEXT_EVENT_STREAM</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>route 就是路由配置，其规定路由的分发规则，将不同的请求路由分发给相应的 handler 进行业务逻辑的处理，其对应的就是传统的 Controller 层</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RouteConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RouterFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">userRoute</span><span class="token punctuation">(</span><span class="token class-name">UserHandler</span> userHandler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">RouterFunctions</span><span class="token punctuation">.</span><span class="token function">nest</span><span class="token punctuation">(</span>
                <span class="token class-name">RequestPredicates</span><span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"/userRoute"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">RouterFunctions</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token class-name">RequestPredicates</span><span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userHandler<span class="token operator">::</span><span class="token function">addUser</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">andRoute</span><span class="token punctuation">(</span><span class="token class-name">RequestPredicates</span><span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userHandler<span class="token operator">::</span><span class="token function">delUser</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">andRoute</span><span class="token punctuation">(</span><span class="token class-name">RequestPredicates</span><span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userHandler<span class="token operator">::</span><span class="token function">updateUser</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">andRoute</span><span class="token punctuation">(</span><span class="token class-name">RequestPredicates</span><span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userHandler<span class="token operator">::</span><span class="token function">getAllUser</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">andRoute</span><span class="token punctuation">(</span><span class="token class-name">RequestPredicates</span><span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/stream"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userHandler<span class="token operator">::</span><span class="token function">getAllUserStream</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_4288"></a>参考文献</h3> 
<p>https://blog.csdn.net/wpc2018/article/details/122634049</p> 
<p>https://www.jianshu.com/p/7d80b94068b3</p> 
<p>https://blog.csdn.net/yhj_911/article/details/119540000</p> 
<p>http://bjqianye.cn/detail/6845.html</p> 
<p>https://blog.csdn.net/hao134838/article/details/110824092</p> 
<p>https://blog.csdn.net/hao134838/article/details/110824092</p> 
<p>https://blog.csdn.net/weixin_34096182/article/details/91436704</p> 
<p>https://blog.csdn.net/fly910905/article/details/121682625</p> 
<p>https://gaocher.github.io/2020/01/05/mono-create/</p> 
<h3><a id="_4310"></a>推荐阅读：</h3> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/129004814">全链路异步，让你的 SpringCloud 性能优化10倍+</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128932396">Linux命令大全：2W多字，一次实现Linux自由</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128805374">网易二面：CPU狂飙900%，该怎么处理？</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128848309">阿里二面：千万级、亿级数据，如何性能优化？ 教科书级 答案来了</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128725701">峰值21WQps、亿级DAU，小游戏《羊了个羊》是怎么架构的？</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128533821">场景题：假设10W人突访，你的系统如何做到不 雪崩？</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128697096">2个大厂 100亿级 超大流量 红包 架构方案</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128684641">Nginx面试题（史上最全 + 持续更新）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128671196">K8S面试题（史上最全 + 持续更新）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128708648">操作系统面试题（史上最全、持续更新）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128670335">Docker面试题（史上最全 + 持续更新）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125057567">Springcloud gateway 底层原理、核心实战 (史上最全)</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/124120506">Flux、Mono、Reactor 实战（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125059491">sentinel （史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125057545">Nacos (史上最全)</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/114527369">TCP协议详解 (史上最全)</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/123420859">分库分表 Sharding-JDBC 底层原理、核心实战（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/126992542">clickhouse 超底层原理 + 高可用实操 （史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/120702536">nacos高可用（图解+秒懂+史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128264803">队列之王： Disruptor 原理、架构、源码 一文穿透</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128264508">环形队列、 条带环形队列 Striped-RingBuffer （史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125135726">一文搞定：SpringBoot、SLF4j、Log4j、Logback、Netty之间混乱关系（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128265067">单例模式（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/125017316">红黑树（ 图解 + 秒懂 + 史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/109459593">分布式事务 （秒懂）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/128123114">缓存之王：Caffeine 源码、架构、原理（史上最全，10W字 超级长文）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/113751575">缓存之王：Caffeine 的使用（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/126579528">Java Agent 探针、字节码增强 ByteBuddy（史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/120747767">Docker原理（图解+秒懂+史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/116425814">Redis分布式锁（图解 - 秒懂 - 史上最全）</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/85956246">Zookeeper 分布式锁 - 图解 - 秒懂</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/85922561">Zookeeper Curator 事件监听 - 10分钟看懂</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/83957259">Netty 粘包 拆包 | 史上最全解读</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/83758107">Netty 100万级高并发服务器配置</a>》</p> 
<p>《<a href="https://blog.csdn.net/crazymakercircle/article/details/102557988">Springcloud 高并发 配置 （一文全懂）</a>》</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/52927d5546189c1446363cc7b0f76905/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【设计模式】九、面向对象设计原则之迪米特法则</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/85e6dae42bddc847eee0ac3725096716/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">uniapp 文字上下滚动，抽奖效果</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>