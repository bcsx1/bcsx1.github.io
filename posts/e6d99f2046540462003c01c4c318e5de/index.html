<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>å¾®ä¿¡æ”¯ä»˜éœ€è¦éªŒè¯å¾®ä¿¡èº«ä»½éƒ¨åˆ†openidï¼Œtoken - ç¼–ç¨‹éšæƒ³</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="å¾®ä¿¡æ”¯ä»˜éœ€è¦éªŒè¯å¾®ä¿¡èº«ä»½éƒ¨åˆ†openidï¼Œtoken" />
<meta property="og:description" content="&lt;?php namespace app\api\controller; use alisms\SendSms; use app\index\controller\Api; use think\Controller; use think\Db; use think\Request; //use wxappletpay\Pay; use think\Exception; use GuzzleHttp\Exception\RequestException; use WechatPay\GuzzleMiddleware\WechatPayMiddleware; use WeChatPay\Util\PemUtil; //use GuzzleHttp\HandlerStack; use GuzzleHttp\HandlerStack; //use WechatPay\GuzzleMiddleware\Util\AesUtil; class WxApplet extends Controller { public function __construct() { // $result=$this-&gt;verifyPermissions(); // if (!$result){ // die(json_encode([&#39;code&#39;=&gt;40010,&#39;errmsg&#39;=&gt;&#39;æƒé™ä¸è¶³&#39;])); // } } private function verifyPermissions() { $token = Request::instance()-&gt;header(&#39;token&#39;); return redis()-&gt;exists($token); } public function cardList(){ $cardList=db(&#39;cardinfo&#39;)-&gt;select(); return jsonSuccess($cardList); } //ç®€å•çš„è°ƒç”¨ public function sendSms(Request $request) { //åˆ¤æ–­æ˜¯å¦ajaxæäº¤ if($request-&gt;isPost()) { //è·å–mobileå‚æ•° $mobile = $request-&gt;param(&#39;phone&#39;); if(!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/e6d99f2046540462003c01c4c318e5de/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-12T16:30:03+08:00" />
<meta property="article:modified_time" content="2023-04-12T16:30:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹éšæƒ³" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹éšæƒ³</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">å¾®ä¿¡æ”¯ä»˜éœ€è¦éªŒè¯å¾®ä¿¡èº«ä»½éƒ¨åˆ†openidï¼Œtoken</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <pre><code class="language-php">&lt;?php
namespace app\api\controller;

use alisms\SendSms;
use app\index\controller\Api;
use think\Controller;
use think\Db;
use think\Request;
//use wxappletpay\Pay;
use think\Exception;
use GuzzleHttp\Exception\RequestException;
use WechatPay\GuzzleMiddleware\WechatPayMiddleware;
use WeChatPay\Util\PemUtil;
//use GuzzleHttp\HandlerStack;
use GuzzleHttp\HandlerStack;
//use WechatPay\GuzzleMiddleware\Util\AesUtil;

class WxApplet extends Controller
{
    public function  __construct()
    {
//        $result=$this-&gt;verifyPermissions();
//        if (!$result){
//            die(json_encode(['code'=&gt;40010,'errmsg'=&gt;'æƒé™ä¸è¶³']));
//        }


    }



    private function verifyPermissions()
    {
        $token = Request::instance()-&gt;header('token');
        return redis()-&gt;exists($token);
    }

    public function cardList(){
        $cardList=db('cardinfo')-&gt;select();
        return jsonSuccess($cardList);
    }

    //ç®€å•çš„è°ƒç”¨
    public function sendSms(Request $request)
    {
        //åˆ¤æ–­æ˜¯å¦ajaxæäº¤
        if($request-&gt;isPost())
        {
            //è·å–mobileå‚æ•°
            $mobile = $request-&gt;param('phone');
            if(!preg_match("/^1[3456789]\d{9}$/", $mobile)){
                return jsonFail("æ‰‹æœºå·ä¸æ­£ç¡®");
            }
            //æ–°å»ºcode
            $templateParam = array('code' =&gt; rand(10000,99999));

            //ä¿å­˜åœ¨sessionè¿›è¡ŒéªŒè¯
            session('sms_code',['mobile'=&gt;$mobile,'code'=&gt;$templateParam['code']]);

            //å®ä¾‹åŒ–ç±»
            $send = new SendSms();
            //è°ƒç”¨ç±»é‡Œé¢sendæ–¹æ³• send()æ–¹æ³•éœ€è¦ä¿©ä¸ªå‚æ•°;
            //å‘é€çŸ­ä¿¡~
            $result = $send-&gt;send($mobile,$templateParam,config('AliSms.payTemplateCode'));
            //æ˜¯å¦æˆåŠŸ
            if($result)
            {
                //è¿”å›
                return jsonSuccess('','å‘é€æˆåŠŸ!');
            }else{
                return jsonFail("å‘é€çŸ­ä¿¡å¤±è´¥");
            }
        }
    }

    public function verifyFaces(){
        $api = new Api();
        header("Access-Control-Allow-Origin: *");

        if (request()-&gt;isPost()) {
            //1ã€‚ä¸Šä¼ å›¾ç‰‡æ–¹å¼
            $farr = $api-&gt;upload("faces");
            $img_dir = ROOT_PATH . 'public' . DS . 'uploads' . DS . $farr['save'];
            $img_base64 = $api-&gt;imgToBase64($img_dir);
            $param['image'] = substr($img_base64, 22);
            //2ã€‚base64å­—ç¬¦ä¸²å½¢å¼
//            $img_base64 = input("post.faces");
//            $param['image'] = $img_base64;
//            return jsonSuccess(['picPath'=&gt;DS . 'uploads' . DS . $farr['save']],"é€šè¿‡");
//            $membernum = input("post.membernum")?input("post.membernum"):1;
            $membernum=1;
            $url = "https://aip.baidubce.com/rest/2.0/face/v3/detect?access_token=" . $api-&gt;getbdtoken();


            $param['image_type'] = "BASE64";
            $param['face_type'] = "LIVE";
            $param['face_field'] = "eye_status,quality,glasses,angle,beauty,expression,mask";
            $param['max_face_num'] = 10;
//            var_dump($param['image']);
//            exit();
            $o = "";
            foreach ($param as $k =&gt; $v) {
                $o .= "$k=" . urlencode($v) . "&amp;";
            }
            $post_data = substr($o, 0, -1);
//            var_dump($post_data);
//            exit();
            $res = $api-&gt;request_post($url, $post_data);

            $res = json_decode($res);


            if ($res-&gt;error_code === 0) {
                if($res-&gt;result-&gt;face_num!=$membernum){
                    return jsonFail("äººè„¸æ•°é‡ä¸ä¸€è‡´");
                }
                $result = $api-&gt;face_pic_check($res);
                $picPath = DS . 'uploads' . DS . $farr['save'];
                if ($result['error_code']===0){
                    return jsonSuccess($picPath);
                }else{
                    return jsonFail($result['error_msg']);
                }

            } else {
                return jsonFail($res-&gt;error_msg,'',$res-&gt;error_code);
            }

//            return json_encode($arr, JSON_UNESCAPED_UNICODE);
        }else{
            return jsonFail("éæ³•è¯·æ±‚");
        }
    }

    public function uploadTmpPic()
    {
        // è·å–è¡¨å•ä¸Šä¼ æ–‡ä»¶ ä¾‹å¦‚ä¸Šä¼ äº†001.jpg
        $file = request()-&gt;file("faces");
        // ç§»åŠ¨åˆ°æ¡†æ¶åº”ç”¨æ ¹ç›®å½•/public/uploads/ ç›®å½•ä¸‹
        $dirPath = ROOT_PATH . 'public' . DS . 'uploads' . DS . 'tmp';
        if (!is_dir($dirPath)){
            mkdir(iconv("UTF-8", "GBK", $dirPath),0777,true);
        }
        $info = $file-&gt;move($dirPath);
//        $info = $file-&gt;move(ROOT_PATH . 'uploads');

        if ($info) {
            // æˆåŠŸä¸Šä¼ å è·å–ä¸Šä¼ ä¿¡æ¯
            // è¾“å‡º jpg
            $upload['houzhui'] = $info-&gt;getExtension();
            // è¾“å‡º 20160820/42a79759f284b767dfcb2a0197904287.jpg
            $upload['save'] = $info-&gt;getSaveName();
            // è¾“å‡º 42a79759f284b767dfcb2a0197904287.jpg
            $upload['name'] = $info-&gt;getFilename();
        } else {
            // ä¸Šä¼ å¤±è´¥è·å–é”™è¯¯ä¿¡æ¯
            $upload['error'] = $file-&gt;getError();
        }
        return jsonSuccess($upload);
    }

    public function verifyCode(){
        $post = input('post.');
        $sms_code = session("sms_code");
//        if (empty($post['phone'])||empty($post['code'])) return jsonFail("è¯·æ±‚å‚æ•°é”™è¯¯");
//        if (empty($sms_code)) return jsonFail("sessionä¸å­˜åœ¨");
//        trace(request()-&gt;url().":".json_encode($sms_code), 'api');
//        if($sms_code['mobile']!=$post['phone']) return jsonFail("æ‰‹æœºå·ä¸æ­£ç¡®");
//        if($sms_code['code']!=$post['code']) return jsonFail("éªŒè¯ç ä¸æ­£ç¡®");
        return jsonSuccess();

    }

    public function addCard(){
        $post = input('post.');
        trace(request()-&gt;url().":".json_encode($post), 'api');
        if (!is_array($post['username'])) return jsonFail('usernameå¿…é¡»æ˜¯Array');
        if (!is_array($post['phone'])) return jsonFail('phoneå¿…é¡»æ˜¯Array');
        if (!is_array($post['shenfenz'])) return jsonFail('shenfenzå¿…é¡»æ˜¯Array');
        if (!is_array($post['photo'])) return jsonFail('photoå¿…é¡»æ˜¯Array');

        if(empty($post['cardid'])||empty($post['starttime'])||empty($post['endtime'])){
            return json(['code' =&gt; 1, "msg" =&gt; "cardid,starttime,endtime ä¸èƒ½ä¸ºç©º"]);
        }
//        return false;
        $data['cardid'] = $post['cardid'];
        $data['startdate'] = $post['starttime'];
        $data['enddate'] = $post['endtime'];
        $data['pay_way'] = isset($post['pay_way'])?$post['pay_way']:2;
        $data['pay_fee'] = db('cardinfo')-&gt;where('cardid',$post['cardid'])-&gt;value("cardamt");
        $data['card_type']=$post['card_type'];
        $data['photo']=null;
        $data['client'] =  input("post.openid");

        $ret=Db::transaction(function () use ($post, $data) {
            try {
                $getid = db('clubinfo')-&gt;insertGetId($data);
                $push_data=db('clubinfo')-&gt;where('cardno', $getid)-&gt;find();
                for ($i = 0; $i &lt; count($post['photo']); $i++) {
                    if (empty($post['photo'][$i])||empty($post['username'][$i])){
                        return ['code' =&gt; 1, 'msg' =&gt; "photo,username ä¸èƒ½ä¸ºç©º"];
                    }
                    if ($i===0){
                        if ($post['cardid']!=1&amp;&amp;$post['cardid']!=5){
                            if (empty($post['shenfenz'][$i])) return ['code' =&gt; 1, 'msg' =&gt; "èº«ä»½è¯å· ä¸èƒ½ä¸ºç©º"];
                        }

                        if (empty($post['phone'][$i])) return ['code' =&gt; 1, 'msg' =&gt; "æ‰‹æœºå· ä¸èƒ½ä¸ºç©º"];
                    }
                    if (!empty($post['shenfenz'][$i])){
                        if(preg_match("/([\x81-\xfe][\x40-\xfe])/", $post['shenfenz'][$i], $match)){
                            return ['code' =&gt; 1, 'msg' =&gt; "èº«ä»½è¯å·ä¸èƒ½æœ‰ä¸­æ–‡"];
                        }
                    }
                    if (!empty($post['phone'][$i])){
                        if(!is_numeric($post['phone'][$i])){
                            return ['code' =&gt; 1, 'msg' =&gt; "æ‰‹æœºå·å¿…é¡»æ˜¯æ•°å­—"];
                        }
                    }

                    $data2 = [];
                    $data2['cardno'] = $getid;
                    $data2['membername'] = $post['username'][$i];
                    $data2['phone'] = isset($post['phone'][$i])?$post['phone'][$i]:"";
                    $data2['idnumber'] = isset($post['shenfenz'][$i])?$post['shenfenz'][$i]:"";
                    $data2['memberbirthday'] = empty($data2['idnumber']) ? "" : substr($data2['idnumber'], 6, 8);
                    $data2['photo'] = $post['photo'][$i];
                    $data2['client'] = $data['client'];
                    $data2['issub'] = ($i === 0) ? 0 : 1;
                    $memberid=db('memberinfo')-&gt;insertGetId($data2);
                    $data3=db('memberinfo')-&gt;where('id', $memberid)-&gt;find();
                    $push_data['member'][$i] = $data3;
                }


                return ['code'=&gt;0,"msg"=&gt;"æ·»åŠ æˆåŠŸ",'data'=&gt;['cardno'=&gt;$getid]];
            } catch (Exception $e) {
                trace(request()-&gt;url().":".$e-&gt;getMessage(), 'api');
                return ['code'=&gt;1,"msg"=&gt;"æ·»åŠ å¤±è´¥"];
            }
        });

        if (isset($ret['data']['cardno'])){
            $data10['cardno'] = $ret['data']['cardno'];
            $clubInfo=db('clubinfo')-&gt;where('cardno', $data10['cardno'])-&gt;find();
            $data10['pay_fee'] = $clubInfo['pay_fee'];
            $data10['client'] = $data['client'];
            $data10['order_no'] = 'wx' . time() . $data10['cardno']  ;
            $resultId=db('order')-&gt;insertGetId($data10);
            if ($resultId) {
                return jsonSuccess($resultId);
            } else {
                return jsonFail("æ·»åŠ æ”¯ä»˜æ•°æ®å¤±è´¥");
            }
        } else {
            return jsonFail("æ·»åŠ å¹´å¡æ•°æ®å¤±è´¥ï¼Œerr:".json_encode($ret));
        }

    }

    public function getCardInfo(){
        $cardNo = input('post.cardno');
        if (!empty($cardNo)){
            $cardInfo=db('clubinfo')-&gt;where('cardno', $cardNo)-&gt;find();
            if ($cardInfo){
                return jsonSuccess($cardInfo);

            }else{
                return jsonFail();
            }
        }else{
            return jsonFail();
        }
    }
    protected function getsign($data, $appid ,$keypath){
//        $content = $appid . '\n'.  $data['timeStamp'] . '\n'.  $data['nonceStr'] . '\n'.  $data['package'] . '\n';
//        var_dump($content);
        $key = openssl_get_privatekey($keypath);
//        $key = openssl_pkey_get_private($keypath);
        openssl_sign($content, $signature, $key, "SHA256");
        openssl_sign($content, $signature, $key, 'sha256WithRSAEncryption');
        openssl_sign($content, $signature, $key, OPENSSL_ALGO_SHA256);
//        openssl_sign($content, $signature, $key);
//        openssl_free_key($key);
//        $sign = base64_encode($signature);
//        return $sign;
        $str = "{$appid}\n{$data['timeStamp']}\n{$data['nonceStr']}\n{$data['package']}\n";
        $privateKey = PemUtil::loadPrivateKey($keypath); // $this-&gt;private_key
        openssl_sign($str, $encrypt_data, openssl_pkey_get_private($privateKey), 'sha256WithRSAEncryption');
        $encrypt_data = base64_encode($encrypt_data);
        return $encrypt_data;

    }

    public function pay()
    {
        $openid = input('post.openid'); //opendiå¯ä»¥è‡ªå·±é‡æ–°è·å–ä¹Ÿå¯ä»¥å­˜èµ·æ¥ å¿…é¡»è¦ï¼ï¼ï¼
        $orderid = input('post.orderid');  //è¿™é‡Œæ˜¯è®¢å•çš„id æ ¹æ®è‡ªå·±éœ€è¦æ¥
//        echo date('Y-m-d\TH:i:sP');
//        echo date('c'); die();
        //æŸ¥è¯¢é‡Œé¢çš„ä»·æ ¼
        $orderdata = db('order')-&gt;where('id',$orderid)-&gt;field('order_no,pay_fee')-&gt;find();
        if (is_null($orderdata) ){
            $orderdata = db('order')-&gt;where('order_no',$orderid)-&gt;field('order_no,pay_fee')-&gt;find();
        }
        //å¼•å…¥æ”¯ä»˜çš„ç±»  ç¬¬äºŒä¸ªä»£ç å—ğŸ‘‡
//        $wxBizDataCrypt = EXTEND_PATH.'/wxappletpay/Pay.php';
//        require_once $wxBizDataCrypt;
//        $a = new Pay($openid,$orderdata['order_no'],'å¾®ä¿¡æ”¯ä»˜',$orderdata['pay_fee']);
//        $pay = $a -&gt; pay();//ä¸‹å•è·å–è¿”å›å€¼
//        var_dump(123);die();
        $wxpay = config('WxAppletPay');
        if(is_null($orderdata)) {
            $orderdata['order_no'] = 'wx1596337296' . time() ;  //id cardno order_no , 205 =&gt; 64053074 wx1596337296
            $orderdata['pay_fee'] = 1 ;
//            return jsonFail("è®¢å•ä¸å­˜åœ¨");
        }
        // å•†æˆ·ç›¸å…³é…ç½®ï¼Œ
        $ishttp = (isset($_SERVER['HTTPS']) &amp;&amp; $_SERVER['HTTPS'] == 'on') ? 'https://' : 'http://';
        $merchantId = $wxpay['mch_id']; // å•†æˆ·å·
        $merchantSerialNumber = $wxpay['serial']; // å•†æˆ·APIè¯ä¹¦åºåˆ—å·
        $merchantPrivateKey = PemUtil::loadPrivateKey($wxpay['keyfile']); // å•†æˆ·ç§é’¥æ–‡ä»¶è·¯å¾„
//        $merchantPrivateKey = \WeChatPay\Crypto\Rsa::from($wxpay['keyfile']); // å•†æˆ·ç§é’¥æ–‡ä»¶è·¯å¾„

// å¾®ä¿¡æ”¯ä»˜å¹³å°é…ç½®
        $wechatpayCertificate = PemUtil::loadCertificate($wxpay['wechatpay']); // å¾®ä¿¡æ”¯ä»˜å¹³å°è¯ä¹¦æ–‡ä»¶è·¯å¾„

// æ„é€ ä¸€ä¸ªWechatPayMiddleware
        $wechatpayMiddleware = WechatPayMiddleware::builder()
            -&gt;withMerchant($merchantId, $merchantSerialNumber, $merchantPrivateKey) // ä¼ å…¥å•†æˆ·ç›¸å…³é…ç½®
            -&gt;withWechatPay([ $wechatpayCertificate ]) // å¯ä¼ å…¥å¤šä¸ªå¾®ä¿¡æ”¯ä»˜å¹³å°è¯ä¹¦ï¼Œå‚æ•°ç±»å‹ä¸ºarray
            -&gt;build();

// å°†WechatPayMiddlewareæ·»åŠ åˆ°Guzzleçš„HandlerStackä¸­
        $stack = HandlerStack::create();
        $stack-&gt;push($wechatpayMiddleware, 'wechatpay');

// åˆ›å»ºGuzzle HTTP Clientæ—¶ï¼Œå°†HandlerStackä¼ å…¥ï¼Œæ¥ä¸‹æ¥ï¼Œæ­£å¸¸ä½¿ç”¨Guzzleå‘èµ·APIè¯·æ±‚ï¼ŒWechatPayMiddlewareä¼šè‡ªåŠ¨åœ°å¤„ç†ç­¾åå’ŒéªŒç­¾
        $client = new \GuzzleHttp\Client(['handler' =&gt; $stack]);
        try {
            $resp = $client-&gt;request(
                'POST',
                'https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi', //è¯·æ±‚URL
                [
                    // JSONè¯·æ±‚ä½“
                    'json' =&gt; [
                        "time_expire" =&gt; date('c') ,//"2018-06-08T10:34:56+08:00",
                        "amount" =&gt; [
//                            "total" =&gt; $orderdata['pay_fee'],
                            "total" =&gt; 1,
                            "currency" =&gt; "CNY",
                        ],
                        "mchid" =&gt; $wxpay['mch_id'],
                        "description" =&gt; "æµ·æ´‹ä¸–ç•Œå¹´å¡",
                        "notify_url" =&gt; $ishttp . $_SERVER['HTTP_HOST'] . '/api/index/notify_url',//"https://www.weixin.qq.com/wxpay/pay.php"
                        "payer" =&gt; [
                            "openid" =&gt; $openid ,
                        ],
                        "out_trade_no" =&gt; $orderdata['order_no'],
                        "goods_tag" =&gt; "NianKa",
                        "appid" =&gt; $wxpay['appid'],
                        "attach" =&gt; "å¹´å¡",
                        "scene_info" =&gt; [
                            "store_info" =&gt; [
                                "address" =&gt; "å®æ³¢å¸‚æµ·æ´‹ä¸–ç•Œ",
                                "area_code" =&gt; "315153",
                                "name" =&gt; "å®æ³¢æµ·æ´‹ä¸–ç•Œ",
                                "id" =&gt; "0001",
                            ],
                            "device_id" =&gt; "000000000001",
                            "payer_client_ip" =&gt; $this-&gt;getClientIP(),
                        ]
                    ],
                    'headers' =&gt; [ 'Accept' =&gt; 'application/json' ]
                ]
            );
            $statusCode = $resp-&gt;getStatusCode();
            if ($statusCode == 200) { //å¤„ç†æˆåŠŸ
//                echo "success,return body = " . $resp-&gt;getBody()-&gt;getContents()."\n";
                $package = 'prepay_id=' . json_decode($resp-&gt;getBody()-&gt;getContents(),true)['prepay_id'];
//                $decrypter = new AesUtil($wxpay['apiv3']);
                $paydata = array('timeStamp' =&gt; (string)time(), "nonceStr" =&gt;md5(time() .$package ) , 'package' =&gt;$package, 'signType' =&gt; "RSA"  );
//                $paySign = $decrypter-&gt;decryptToString('') ;
                $paySign = $this-&gt;getsign($paydata,$wxpay['appid'],$wxpay['keyfile']);
                $paydata['paySign'] = $paySign;
                return jsonSuccess($paydata,"è·å–è®¢å•ä¿¡æ¯æˆåŠŸ");
            } else if ($statusCode == 204) { //å¤„ç†æˆåŠŸï¼Œæ— è¿”å›Body
                echo "success";
            }
        } catch (RequestException $e) {
            // è¿›è¡Œé”™è¯¯å¤„ç†
            echo $e-&gt;getMessage()."\n";
            if ($e-&gt;hasResponse()) {
                echo "failed,resp code = " . $e-&gt;getResponse()-&gt;getStatusCode() . " return body = " . $e-&gt;getResponse()-&gt;getBody() . "\n";
            }
            return;
        }
//        return jsonSuccess("è·å–è®¢å•ä¿¡æ¯æˆåŠŸ",'resp');
    }

    function getClientIP(){
        $ip = 'unknow';
        $list = array(
            'HTTP_CLIENT_IP',
            'HTTP_X_FORWARDED_FOR',
            'HTTP_X_FORWARDED',
            'HTTP_X_CLUSTER_CLIENT_IP',
            'HTTP_FORWARDED_FOR',
            'HTTP_FORWARDED',
            'REMOTE_ADDR');
        foreach ($list as $key) {
            if (array_key_exists($key, $_SERVER)) {
                foreach (explode(',', $_SERVER[$key]) as $ip) {
                    $ip = trim($ip);
                    //ä¼šè¿‡æ»¤æ‰ä¿ç•™åœ°å€å’Œç§æœ‰åœ°å€æ®µçš„IPï¼Œä¾‹å¦‚ 127.0.0.1ä¼šè¢«è¿‡æ»¤
                    //ä¹Ÿå¯ä»¥ä¿®æ”¹æˆæ­£åˆ™éªŒè¯IP
                    if ((bool)filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4 | FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) {
                        return $ip;
                    }
                }
            }
        }
        if ($ip == '::1'){
            //æœ¬åœ°
            $ip = '127.0.0.1';
        }
        return $ip;
    }

}</code></pre> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ef6c3eb05a2a32a3a6b216f4254022ae/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">ã€æ— æ ‡é¢˜ã€‘åœ¨el-diaologä¸­å±•ç¤ºechartsæ—¶ï¼Œç¬¬ä¸€æ¬¡è¿›å…¥å¼¹æ¡†ï¼Œå›¾è¡¨æ— æ³•å æ»¡æ•´ä¸ªå®¹å™¨</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/45d9ad1b4446bc66d2a5b5e00745bda2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">linuxæ›´æ”¹æ–‡ä»¶çš„è¯»å†™æ‰§è¡Œç­‰æƒé™</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 ç¼–ç¨‹éšæƒ³.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>