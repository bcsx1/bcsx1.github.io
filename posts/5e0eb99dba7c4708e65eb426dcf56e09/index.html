<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ogre学习笔记（6）：BspSceneManager - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ogre学习笔记（6）：BspSceneManager" />
<meta property="og:description" content="【1. 概览】 Ogre支持Quake3的bsp格式。相关的代码在“Plugin_BSPSceneManager”工程中。主要的类有以下几个：
Class BspSceneNode：
BspSceneNode是SceneNode的派生类，是专门提供给BSPSceneManager使用的。主要是提供针对于BSP tree的可见性判断。这个类并不是BSP tree的node，BSP tree中的node使用BspNode。BspSceneNode会放入BSP tree的leaf节点中。由于SceneNode使用包裹盒的方法，不可分割，所以一个BspSceneNode可能放入多个Bsp tree的leaf节点中。
从类的定义看，BspSceneNode并没有额外的保存什么数据。重写的几个虚函数主要是用来通知BspSceneMapager，BspSceneNode::_update()会调用BspSceneManager::_notifyObjectMoved()，detach objcect会调用BspSceneManager::_notifyObjectDetached()。
Class BspSceneManager：
粗略的看BspSceneManager与OctreeSceneManager类似。首先保存了一个BspLevel的指针，然后使用一个walkTree()函数，用来遍历tree结构。由于Quake使用BSP leaf tree，所以多了一个processVisibleLeaf()函数。另外一个明显的不同是有一个renderStaticGeometry()函数，“Renders the static level geometry tagged in walkTree”。此函数渲染“mMatFaceGroupMap”中的所有数据。BSP一个好处是不透明面可以front-back的顺序来渲染，而透明面back-front来渲染，OGRE是如何将此特性保存到MaterialFaceGroupMap的呢？
Class BspLevel：
这是一个核心的class。他存储了BSP的所有数据，关键的数据有：
1. “BspNode* mRootNode;”――BSP tree的根节点
2. “VertexData* mVertexData;”――整个level的所有顶点；
3. “StaticFaceGroup* mFaceGroups;”――faces
4. “BspNode::Brush *mBrushes;”――用来做碰撞检测的Brush，是QuakeBSP除了渲染以外的另外一个精华！Brush的名字有点怪，其实就是一个convex volume，可以减少CD的运算量。
5. “VisData mVisData;”――PVS数据，是又一个Quake中的精华！当初Carmark在设计Quake的时候还使用软件渲染，hiden surface removal和减少over draw是最另他头痛的问题。BSP的思想应该是他从网上看来的，不过PVS应该是他所创。PVS大大减少了over draw。(见《Michael Abrash&#39;s Graphics Programming Black Book》)
6. “PatchMap mPatches;”――Quake3支持贝赛尔曲面
关键的函数：
1． bool isLeafVisible(const BspNode* from, const BspNode* to) const;使用PVS来检测可见性。
2． void _notifyObjectMoved(const MovableObject* mov, const Vector3&amp; pos);" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/5e0eb99dba7c4708e65eb426dcf56e09/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2006-09-13T12:02:00+08:00" />
<meta property="article:modified_time" content="2006-09-13T12:02:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ogre学习笔记（6）：BspSceneManager</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4><span style="font-family: 宋体;">【</span><span lang="EN-US">1. </span><span style="font-family: 宋体;">概览】</span></h4> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span>Ogre</span><span style="font-family: 宋体;">支持</span><span lang="EN-US">Quake3</span><span style="font-family: 宋体;">的</span><span lang="EN-US">bsp</span><span style="font-family: 宋体;">格式。相关的代码在“</span><span lang="EN-US">Plugin_BSPSceneManager</span><span style="font-family: 宋体;">”工程中。主要的类有以下几个：</span></p> 
<p class="MsoNormal"><span lang="EN-US"> 
  
      
  </span></p> 
<p class="MsoNormal"><span lang="EN-US">Class BspSceneNode</span><span style="font-family: 宋体;">：</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span>BspSceneNode</span><span style="font-family: 宋体;">是</span><span lang="EN-US">SceneNode</span><span style="font-family: 宋体;">的派生类，是专门提供给</span><span lang="EN-US">BSPSceneManager</span><span style="font-family: 宋体;">使用的。主要是提供针对于</span><span lang="EN-US">BSP tree</span><span style="font-family: 宋体;">的可见性判断。这个类并不是</span><span lang="EN-US">BSP tree</span><span style="font-family: 宋体;">的</span><span lang="EN-US">node</span><span style="font-family: 宋体;">，</span><span lang="EN-US">BSP tree</span><span style="font-family: 宋体;">中的</span><span lang="EN-US">node</span><span style="font-family: 宋体;">使用</span><span lang="EN-US">BspNode</span><span style="font-family: 宋体;">。</span><span lang="EN-US">BspSceneNode</span><span style="font-family: 宋体;">会放入</span><span lang="EN-US">BSP tree</span><span style="font-family: 宋体;">的</span><span lang="EN-US">leaf</span><span style="font-family: 宋体;">节点中。由于</span><span lang="EN-US">SceneNode</span><span style="font-family: 宋体;">使用包裹盒的方法，不可分割，所以一个</span><span lang="EN-US">BspSceneNode</span><span style="font-family: 宋体;">可能放入多个</span><span lang="EN-US">Bsp tree</span><span style="font-family: 宋体;">的</span><span lang="EN-US">leaf</span><span style="font-family: 宋体;">节点中。</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span></span><span style="font-family: 宋体;">从类的定义看，</span><span lang="EN-US">BspSceneNode</span><span style="font-family: 宋体;">并没有额外的保存什么数据。重写的几个虚函数主要是用来通知</span><span lang="EN-US">BspSceneMapager</span><span style="font-family: 宋体;">，</span><span lang="EN-US">BspSceneNode::_update()</span><span style="font-family: 宋体;">会调用</span><span lang="EN-US">BspSceneManager::_notifyObjectMoved()</span><span style="font-family: 宋体;">，</span><span lang="EN-US">detach objcect</span><span style="font-family: 宋体;">会调用</span><span lang="EN-US">BspSceneManager::_notifyObjectDetached()</span><span style="font-family: 宋体;">。</span></p> 
<p class="MsoNormal"><span lang="EN-US"> 
  
      
  </span></p> 
<p class="MsoNormal"><span lang="EN-US">Class BspSceneManager</span><span style="font-family: 宋体;">：</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span></span><span style="font-family: 宋体;">粗略的看</span><span lang="EN-US">BspSceneManager</span><span style="font-family: 宋体;">与</span><span lang="EN-US">OctreeSceneManager</span><span style="font-family: 宋体;">类似。首先保存了一个</span><span lang="EN-US">BspLevel</span><span style="font-family: 宋体;">的指针，然后使用一个</span><span lang="EN-US">walkTree()</span><span style="font-family: 宋体;">函数，用来遍历</span><span lang="EN-US">tree</span><span style="font-family: 宋体;">结构。由于</span><span lang="EN-US">Quake</span><span style="font-family: 宋体;">使用</span><span lang="EN-US">BSP leaf tree</span><span style="font-family: 宋体;">，所以多了一个</span><span lang="EN-US">processVisibleLeaf()</span><span style="font-family: 宋体;">函数。另外一个明显的不同是有一个</span><span lang="EN-US">renderStaticGeometry()</span><span style="font-family: 宋体;">函数，“</span><span lang="EN-US">Renders the static level geometry tagged in walkTree</span><span style="font-family: 宋体;">”。此函数渲染“</span><span lang="EN-US">mMatFaceGroupMap</span><span style="font-family: 宋体;">”中的所有数据。</span><span lang="EN-US">BSP</span><span style="font-family: 宋体;">一个好处是不透明面可以</span><span lang="EN-US">front-back</span><span style="font-family: 宋体;">的顺序来渲染，而透明面</span><span lang="EN-US">back-front</span><span style="font-family: 宋体;">来渲染，</span><span lang="EN-US">OGRE</span><span style="font-family: 宋体;">是如何将此特性保存到</span><span lang="EN-US">MaterialFaceGroupMap</span><span style="font-family: 宋体;">的呢？</span></p> 
<p class="MsoNormal"><span lang="EN-US"> 
  
      
  </span></p> 
<p class="MsoNormal"><span lang="EN-US">Class BspLevel</span><span style="font-family: 宋体;">：</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span></span><span style="font-family: 宋体;">这是一个核心的</span><span lang="EN-US">class</span><span style="font-family: 宋体;">。他存储了</span><span lang="EN-US">BSP</span><span style="font-family: 宋体;">的所有数据，关键的数据有：</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">1.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">“</span><span lang="EN-US">BspNode* mRootNode;</span><span style="font-family: 宋体;">”――</span><span lang="EN-US">BSP tree</span><span style="font-family: 宋体;">的根节点</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">2.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">“</span><span lang="EN-US">VertexData* mVertexData;</span><span style="font-family: 宋体;">”――整个</span><span lang="EN-US">level</span><span style="font-family: 宋体;">的所有顶点；</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">3.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">“</span><span lang="EN-US">StaticFaceGroup* mFaceGroups;</span><span style="font-family: 宋体;">”――</span><span lang="EN-US">faces</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">4.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">“</span><span lang="EN-US">BspNode::Brush *mBrushes;</span><span style="font-family: 宋体;">”――用来做碰撞检测的</span><span lang="EN-US">Brush</span><span style="font-family: 宋体;">，是</span><span lang="EN-US">QuakeBSP</span><span style="font-family: 宋体;">除了渲染以外的另外一个精华！</span><span lang="EN-US">Brush</span><span style="font-family: 宋体;">的名字有点怪，其实就是一个</span><span lang="EN-US">convex volume</span><span style="font-family: 宋体;">，可以减少</span><span lang="EN-US">CD</span><span style="font-family: 宋体;">的运算量。</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">5.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">“</span><span lang="EN-US">VisData mVisData;</span><span style="font-family: 宋体;">”――</span><span lang="EN-US">PVS</span><span style="font-family: 宋体;">数据，是又一个</span><span lang="EN-US">Quake</span><span style="font-family: 宋体;">中的精华！当初</span><span lang="EN-US">Carmark</span><span style="font-family: 宋体;">在设计</span><span lang="EN-US">Quake</span><span style="font-family: 宋体;">的时候还使用软件渲染，</span><span lang="EN-US">hiden surface removal</span><span style="font-family: 宋体;">和减少</span><span lang="EN-US">over draw</span><span style="font-family: 宋体;">是最另他头痛的问题。</span><span lang="EN-US">BSP</span><span style="font-family: 宋体;">的思想应该是他从网上看来的，不过</span><span lang="EN-US">PVS</span><span style="font-family: 宋体;">应该是他所创。</span><span lang="EN-US">PVS</span><span style="font-family: 宋体;">大大减少了</span><span lang="EN-US">over draw</span><span style="font-family: 宋体;">。</span><span lang="EN-US">(</span><span style="font-family: 宋体;">见《</span><span lang="EN-US">Michael Abrash's Graphics Programming Black Book</span><span style="font-family: 宋体;">》</span><span lang="EN-US">)</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">6.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">“</span><span lang="EN-US">PatchMap mPatches;</span><span style="font-family: 宋体;">”――</span><span lang="EN-US">Quake3</span><span style="font-family: 宋体;">支持贝赛尔曲面</span></p> 
<p style="margin-left: 21pt;" class="MsoNormal"><span style="font-family: 宋体;">关键的函数：</span></p> 
<p style="margin-left: 39pt; text-indent: -18pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">1．<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>  </span></span></span> 
 <span lang="EN-US">bool isLeafVisible(const BspNode* from, const BspNode* to) const;</span><span style="font-family: 宋体;">使用</span><span lang="EN-US">PVS</span><span style="font-family: 宋体;">来检测可见性。</span></p> 
<p style="margin-left: 39pt; text-indent: -18pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">2．<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>  </span></span></span> 
 <span lang="EN-US">void _notifyObjectMoved(const MovableObject* mov, const Vector3&amp; pos);<br> void _notifyObjectDetached(const MovableObject* mov);<br> </span><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US"> void tagNodesWithMovable(BspNode* node, const MovableObject* mov, const Vector3&amp; pos);<br> </span><span style="font-family: 宋体;">把</span><span lang="EN-US">MovableObject</span><span style="font-family: 宋体;">（注意：不是</span><span lang="EN-US">SceneNode</span><span style="font-family: 宋体;">）挂到</span><span lang="EN-US">BSP</span><span style="font-family: 宋体;">的</span><span lang="EN-US">leaves</span><span style="font-family: 宋体;">上。</span></p> 
<p class="MsoNormal"><span lang="EN-US"> 
  
      
  </span></p> 
<p class="MsoNormal"><span lang="EN-US">Class BspNode</span><span style="font-family: 宋体;">：</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span></span><span style="font-family: 宋体;">这是</span><span lang="EN-US">Bsp</span><span style="font-family: 宋体;">中的另外一个重要的类了。</span><span lang="EN-US">Node</span><span style="font-family: 宋体;">和</span><span lang="EN-US">Leaf</span><span style="font-family: 宋体;">都使用这个类。</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span></span><span style="font-family: 宋体;">重要数据：</span></p> 
<p style="margin-left: 60pt; text-indent: -18pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">1．<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>  </span></span></span> 
 <span lang="EN-US">Plane mSplitPlane;<span style="">     </span>BspNode* mFront;<span style="">     </span>BspNode* mBack;<br> </span><span style="font-family: 宋体;">分割平面和前后节点；</span></p> 
<p style="margin-left: 60pt; text-indent: -18pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">2．<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>  </span></span></span> 
 <span lang="EN-US">int mVisCluster;<br> </span><span style="font-family: 宋体;">每个</span><span lang="EN-US">cluster</span><span style="font-family: 宋体;">占</span><span lang="EN-US">pvs</span><span style="font-family: 宋体;">的一个</span><span lang="EN-US">bit</span><span style="font-family: 宋体;">，这是为了减少</span><span lang="EN-US">pvs</span><span style="font-family: 宋体;">占用的内存。</span></p> 
<p style="margin-left: 60pt; text-indent: -18pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">3．<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>  </span></span></span> 
 <span lang="EN-US">int mNumFaceGroups;<span style="">    </span>int mFaceGroupStart;<br> </span><span style="font-family: 宋体;">用来找到</span><span lang="EN-US">BspLevel</span><span style="font-family: 宋体;">中哪些</span><span lang="EN-US">face group</span><span style="font-family: 宋体;">是属于我这个</span><span lang="EN-US">leaf</span><span style="font-family: 宋体;">的，这样做也是为了优化存储；</span></p> 
<p style="margin-left: 60pt; text-indent: -18pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">4．<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>  </span></span></span> 
 <span lang="EN-US">IntersectingObjectSet mMovables;<br> </span><span style="font-family: 宋体;">和本节点相交的</span><span lang="EN-US">movable</span><span style="font-family: 宋体;">对象</span></p> 
<p style="margin-left: 60pt; text-indent: -18pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">5．<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>  </span></span></span> 
 <span lang="EN-US">NodeBrushList mSolidBrushes;<br> </span><span style="font-family: 宋体;">本节点包含的</span><span lang="EN-US">brush</span><span style="font-family: 宋体;">。</span></p> 
<p class="MsoNormal"><span style="font-family: 宋体;">另外剩下的</span><span lang="EN-US">OgreQuake3Level.h</span><span style="font-family: 宋体;">、</span><span lang="EN-US">OgreQuake3Shader.h</span><span style="font-family: 宋体;">、</span><span lang="EN-US">OgreQuake3ShaderManager.h</span><span style="font-family: 宋体;">、</span><span lang="EN-US">OgreQuake3Type.h</span><span style="font-family: 宋体;">主要是为了把</span><span lang="EN-US">Quake3</span><span style="font-family: 宋体;">格式的</span><span lang="EN-US">bsp</span><span style="font-family: 宋体;">，</span><span lang="EN-US">shader</span><span style="font-family: 宋体;">信息读入，并转换成</span><span lang="EN-US">Ogre</span><span style="font-family: 宋体;">本地的</span><span lang="EN-US">bsp</span><span style="font-family: 宋体;">定义以及</span><span lang="EN-US">Material</span><span style="font-family: 宋体;">。现在</span><span lang="EN-US">quake3</span><span style="font-family: 宋体;">的源码已经公开（非常感谢</span><span lang="EN-US">id software</span><span style="font-family: 宋体;">以及</span><span lang="EN-US">carmark</span><span style="font-family: 宋体;">），可以结合</span><span lang="EN-US">quake3</span><span style="font-family: 宋体;">的源码来看。</span></p> 
<p class="MsoNormal"><span lang="EN-US"> 
  
      
  </span></p> 
<h4><span style="font-family: 宋体;">【</span><span lang="EN-US">2. Quake3 bsp</span><span style="font-family: 宋体;">的加载】</span></h4> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span></span><span style="font-family: 宋体;">以</span><span lang="EN-US">Demo_BSP</span><span style="font-family: 宋体;">为例，首先需要修改“</span><span lang="EN-US">quake3settings.cfg</span><span style="font-family: 宋体;">”，两个参数，“</span><span lang="EN-US">Pak0Location</span><span style="font-family: 宋体;">”是</span><span lang="EN-US">pk</span><span style="font-family: 宋体;">包的路径（是一个</span><span lang="EN-US">zip</span><span style="font-family: 宋体;">文件），“</span><span lang="EN-US">Map</span><span style="font-family: 宋体;">”为想要加载的地图。</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span>OGRE</span><span style="font-family: 宋体;">使用</span><span lang="EN-US">BspLevel</span><span style="font-family: 宋体;">来存储</span><span lang="EN-US">Bsp</span><span style="font-family: 宋体;">场景信息，这个类是与文件格式无关的。所以需要另外一个类来把</span><span lang="EN-US">Quake3</span><span style="font-family: 宋体;">的</span><span lang="EN-US">bsp</span><span style="font-family: 宋体;">文件读入。</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span>Quake3Level</span><span style="font-family: 宋体;">的读盘的主要由两个函数完成：</span></p> 
<p style="text-indent: 21pt;" class="MsoNormal"><span lang="EN-US">1</span><span style="font-family: 宋体;">、“</span><span lang="EN-US">void Quake3Level::loadHeaderFromStream()</span><span style="font-family: 宋体;">”。调用的流程是：</span></p> 
<p style="margin-left: 21pt; text-indent: 21pt;" class="MsoNormal"><span lang="EN-US">BspApplication::loadResources()</span></p> 
<p style="margin-left: 21pt; text-indent: 21pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US"> ResourceGroupManager::loadResourceGroup()</span><span style="font-family: 宋体;">【</span><span lang="EN-US">A</span><span style="font-family: 宋体;">】</span></p> 
<p style="margin-left: 21pt; text-indent: 21pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US"> BspSceneManager::estimateWorldGeometry()</span></p> 
<p style="margin-left: 21pt; text-indent: 21pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US"> BspLevel::calculateLoadingStages()</span></p> 
<p style="margin-left: 21pt; text-indent: 21pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US">Quake3Level::loadHeaderFromStream()</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span>Quake3 BSP</span><span style="font-family: 宋体;">的文件格式很简单明了，前面是一个文件头，后面是几个数据块。文件头主要存储了几个</span><span lang="EN-US">lump</span><span style="font-family: 宋体;">，包含数据块的起始位置和大小，通过</span><span lang="EN-US">lump</span><span style="font-family: 宋体;">，可以直接</span><span lang="EN-US">seek</span><span style="font-family: 宋体;">到对于的数据块。</span><span lang="EN-US"><br> <span style="">       </span></span><span style="font-family: 宋体;">此函数在加载了文件头之后，调用了</span><span lang="EN-US">Quake3Level:: initialiseCounts ()</span><span style="font-family: 宋体;">函数，主要是计算了每个</span><span lang="EN-US">lump</span><span style="font-family: 宋体;">包含的对象的个数，例如</span><span lang="EN-US">face</span><span style="font-family: 宋体;">，</span><span lang="EN-US">vertex</span><span style="font-family: 宋体;">，</span><span lang="EN-US">bursh</span><span style="font-family: 宋体;">等等。</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span>2</span><span style="font-family: 宋体;">、第二个函数“</span><span lang="EN-US">void Quake3Level::loadFromStream()</span><span style="font-family: 宋体;">”。调用的过程是：</span></p> 
<p style="margin-left: 31.5pt;" class="MsoNormal"><span lang="EN-US">ResourceGroupManager::loadResourceGroup(</span><span style="font-family: 宋体;">）【</span><span lang="EN-US">A</span><span style="font-family: 宋体;">】</span></p> 
<p style="margin-left: 31.5pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US">BspSceneManager::setWorldGeometry(</span><span style="font-family: 宋体;">）</span></p> 
<p style="margin-left: 31.5pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US">BspResourceManager::load(</span><span style="font-family: 宋体;">）</span></p> 
<p style="margin-left: 31.5pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US">ResourceManager::load(</span><span style="font-family: 宋体;">）</span></p> 
<p style="margin-left: 31.5pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US">Resource::load()</span></p> 
<p style="margin-left: 31.5pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US">BspLevel::loadImpl()</span></p> 
<p style="margin-left: 31.5pt;" class="MsoNormal"><span lang="EN-US" style="font-family: Wingdings;"><span style="">à</span></span><span lang="EN-US">Quake3Level::loadFromStream(</span><span style="font-family: 宋体;">）</span></p> 
<p style="margin-left: 31.5pt;" class="MsoNormal"><span style="font-family: 宋体;">在这地方</span><span lang="EN-US">OGRE</span><span style="font-family: 宋体;">延续了他罗嗦的风格，</span><span lang="EN-US">BspSceneManager</span><span style="font-family: 宋体;">要通过</span><span lang="EN-US">BspResourceManager</span><span style="font-family: 宋体;">来加载场景，</span><span lang="EN-US">BspLevel</span><span style="font-family: 宋体;">实现为一种</span><span lang="EN-US">Resource</span><span style="font-family: 宋体;">，</span><span lang="EN-US">BspResourceManager</span><span style="font-family: 宋体;">通过标准的</span><span lang="EN-US">ResourceManager</span><span style="font-family: 宋体;">――》</span><span lang="EN-US">Resource</span><span style="font-family: 宋体;">来找到</span><span lang="EN-US">BspLevel</span><span style="font-family: 宋体;">，然后调用其加载函数。</span></p> 
<p style="margin-left: 31.5pt;" class="MsoNormal"><span lang="EN-US"> 
  
      
  </span></p> 
<p style="margin-left: 21pt;" class="MsoNormal"><span style="font-family: 宋体;">此函数首先构造了一个“</span><span lang="EN-US">MemoryDataStream</span><span style="font-family: 宋体;">”对象，在</span><span lang="EN-US">MemoryDataStream</span><span style="font-family: 宋体;">的构造函数中把文件数据全部读入其缓冲中（</span><span lang="EN-US">Quake</span><span style="font-family: 宋体;">也是这样干的），然后调用“</span><span lang="EN-US">void Quake3Level::initialisePointers(void)</span><span style="font-family: 宋体;">”函数，得到所有</span><span lang="EN-US">lump</span><span style="font-family: 宋体;">索引的对象的指针。</span></p> 
<p style="margin-left: 21pt;" class="MsoNormal"><span lang="EN-US"> 
  
      
  </span></p> 
<p style="margin-left: 21pt;" class="MsoNormal"><span lang="EN-US">Quake3Level</span><span style="font-family: 宋体;">把文件读入并明确了所有数据的指针之后，在</span><span lang="EN-US">void BspLevel::loadImpl()</span><span style="font-family: 宋体;">中调用“</span><span lang="EN-US">BspLevel::loadQuake3Level()</span><span style="font-family: 宋体;">”函数讲</span><span lang="EN-US">Quake3level</span><span style="font-family: 宋体;">中的数据拷贝到自己的数据对象中。主要执行了以下几个操作：</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">1.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">“</span><span lang="EN-US">BspLevel::loadEntities()</span><span style="font-family: 宋体;">”，这个</span><span lang="EN-US">lump</span><span style="font-family: 宋体;">存的是一个字符串，用来描述一些游戏信息，</span><span lang="EN-US">Ogre</span><span style="font-family: 宋体;">的这个函数只读取了</span><span lang="EN-US">Player start</span><span style="font-family: 宋体;">信息（位置和角度）。</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">2.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">“</span><span lang="EN-US">Quake3Level::extractLightmaps()</span><span style="font-family: 宋体;">”。</span><span lang="EN-US">Quake3 BSP</span><span style="font-family: 宋体;">的每个</span><span lang="EN-US">light map</span><span style="font-family: 宋体;">都是</span><span lang="EN-US">128</span><span style="font-family: 宋体;">×</span><span lang="EN-US">128</span><span style="font-family: 宋体;">大，此函数将</span><span lang="EN-US">Light map lump</span><span style="font-family: 宋体;">中的数据逐个调用“</span><span lang="EN-US">TextureManager::loadImage()</span><span style="font-family: 宋体;">”创建成</span><span lang="EN-US">Texture</span><span style="font-family: 宋体;">对象（</span><span lang="EN-US">class D3D9Texture for D3D9 RenderSystem</span><span style="font-family: 宋体;">）。</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">3.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">创建</span><span lang="EN-US">VertexData:<br> [Create vertex declaration] OGRE BspLevel</span><span style="font-family: 宋体;">使用的顶点格式为：</span><span lang="EN-US">Position3</span><span style="font-family: 宋体;">，</span><span lang="EN-US">Normal3</span><span style="font-family: 宋体;">，</span><span lang="EN-US">Diffuse</span><span style="font-family: 宋体;">，</span><span lang="EN-US">uv0</span><span style="font-family: 宋体;">，</span><span lang="EN-US">uv1</span><span style="font-family: 宋体;">；</span><span lang="EN-US"><br> [Build initial patches] </span><span style="font-family: 宋体;">调用</span><span lang="EN-US">BspLevel::initQuake3Patches()</span><span style="font-family: 宋体;">。此函数遍历</span><span lang="EN-US">Quake3Level</span><span style="font-family: 宋体;">中的所有</span><span lang="EN-US">faces</span><span style="font-family: 宋体;">，对于每个</span><span lang="EN-US">face type</span><span style="font-family: 宋体;">为“</span><span lang="EN-US">BSP_FACETYPE_PATCH</span><span style="font-family: 宋体;">”的</span><span lang="EN-US">face</span><span style="font-family: 宋体;">，创建一个</span><span lang="EN-US">PatchSurface</span><span style="font-family: 宋体;">对象，并调用</span><span lang="EN-US">PatchSurface:: defineSurface()</span><span style="font-family: 宋体;">函数进行，然后保存到</span><span lang="EN-US">BspLevel:: mPatches</span><span style="font-family: 宋体;">数组中。此函数还计算了</span><span lang="EN-US">BspLevel:: mPatchVertexCount</span><span style="font-family: 宋体;">和</span><span lang="EN-US">BspLevel:: mPatchIndexCount</span><span style="font-family: 宋体;">；</span><span lang="EN-US"><br> [</span><span style="font-family: 宋体;">硬件顶点缓冲</span><span lang="EN-US">] </span><span style="font-family: 宋体;">调用</span><span lang="EN-US">HardwareBufferManager</span><span style="font-family: 宋体;">创建</span><span lang="EN-US">HardwareVertexBuffer</span><span style="font-family: 宋体;">对象；使用“</span><span lang="EN-US">BspLevel::quakeVertexToBspVertex()</span><span style="font-family: 宋体;">”函数把</span><span lang="EN-US">q3 bsp</span><span style="font-family: 宋体;">顶点格式转换为</span><span lang="EN-US">Ogre BSPLevel</span><span style="font-family: 宋体;">的顶点格式。然后绑定到</span><span lang="EN-US">BspLevel::mVertexData</span><span style="font-family: 宋体;">；</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">4.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span style="font-family: 宋体;">创建</span><span lang="EN-US">Faces</span><span style="font-family: 宋体;">：创建</span><span lang="EN-US">BspLevel:: mLeafFaceGroups</span><span style="font-family: 宋体;">数组；创建</span><span lang="EN-US">BspLevel:: mFaceGroups</span><span style="font-family: 宋体;">数组，此数组的数据在后面一步中填充；创建</span><span lang="EN-US">indexbuffer</span><span style="font-family: 宋体;">，并将</span><span lang="EN-US">Quake3Level::mElements</span><span style="font-family: 宋体;">拷贝进来；</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">5.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span lang="EN-US">Create materials for shaders</span><span style="font-family: 宋体;">：对于</span><span lang="EN-US">Quake3Level::mFaces</span><span style="font-family: 宋体;">每一个</span><span lang="EN-US">bsp_face_t</span><span style="font-family: 宋体;">，找到它索引的</span><span lang="EN-US">Quake3Shader</span><span style="font-family: 宋体;">，并创建</span><span lang="EN-US">Material</span><span style="font-family: 宋体;">，如果没有找到</span><span lang="EN-US">Quake3Shader</span><span style="font-family: 宋体;">的话则使用</span><span lang="EN-US">shader name</span><span style="font-family: 宋体;">去查找贴图文件；</span><span lang="EN-US"><br> </span><span style="font-family: 宋体;">在此循环中还进行了“</span><span lang="EN-US">Copy face data</span><span style="font-family: 宋体;">”的操作，填充</span><span lang="EN-US">BspLevel:: mFaceGroups</span><span style="font-family: 宋体;">中的数据；</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">6.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span lang="EN-US">Nodes</span><span style="font-family: 宋体;">：创建</span><span lang="EN-US">BspLevel:: mRootNode</span><span style="font-family: 宋体;">数组，并将数据拷贝进来。</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">7.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span lang="EN-US">Brushes</span><span style="font-family: 宋体;">：将数据拷贝到</span><span lang="EN-US">BspLevel:: mBrushes</span><span style="font-family: 宋体;">中；</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">8.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span lang="EN-US">Leaves</span><span style="font-family: 宋体;">：设置每个</span><span lang="EN-US">leaf</span><span style="font-family: 宋体;">节点的数据，主要包括包裹盒，</span><span lang="EN-US">mFaceGroupStart</span><span style="font-family: 宋体;">，</span><span lang="EN-US">mNumFaceGroups</span><span style="font-family: 宋体;">，</span><span lang="EN-US">mVisCluster</span><span style="font-family: 宋体;">，</span><span lang="EN-US">mSolidBrushes</span><span style="font-family: 宋体;">。参见</span><span lang="EN-US">BspNode</span><span style="font-family: 宋体;">类；</span></p> 
<p style="margin-left: 42pt; text-indent: -21pt;" class="MsoNormal"> 
 <span lang="EN-US" style=""><span style="">9.<span style='font-family: "Times New Roman"; font-style: normal; font-variant: normal; font-weight: normal; font-size: 7pt; line-height: normal; font-size-adjust: none; font-stretch: normal;'>         </span></span></span> 
 <span lang="EN-US">Vis data</span><span style="font-family: 宋体;">：将数据拷贝到</span><span lang="EN-US">BspLevel:: mVisData</span><span style="font-family: 宋体;">中。</span></p> 
<p style="margin-left: 21pt;" class="MsoNormal"><span lang="EN-US">Quake3 BSP</span><span style="font-family: 宋体;">的</span><span lang="EN-US">load</span><span style="font-family: 宋体;">流程基本上就是这些了。</span></p> 
<h4><span style="font-family: 宋体;">【</span><span lang="EN-US">3. Bsp tree scene</span><span style="font-family: 宋体;">的渲染】</span></h4> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span></span><span style="font-family: 宋体;">仍然以</span><span lang="EN-US">Demo_BSP</span><span style="font-family: 宋体;">为例来分析。渲染的核心操作流程从</span><span lang="EN-US">SceneManager::_renderScene()</span><span style="font-family: 宋体;">开始（参见“</span><span lang="EN-US">Ogre</span><span style="font-family: 宋体;">学习笔记（</span><span lang="EN-US">3</span><span style="font-family: 宋体;">）：</span><span lang="EN-US">Mesh</span><span style="font-family: 宋体;">的渲染流程”），接下来还有</span><span lang="EN-US">SceneManager:: _updateSceneGraph()</span><span style="font-family: 宋体;">，</span><span lang="EN-US">SceneManager::prepareRenderQueue()</span><span style="font-family: 宋体;">，</span><span lang="EN-US">BspSceneManager</span><span style="font-family: 宋体;">没有重写这几个函数。不过，有一点需要注意，</span><span lang="EN-US">SceneManager:: _updateSceneGraph()</span><span style="font-family: 宋体;">调用了</span><span lang="EN-US">BspSceneNode::_update()</span><span style="font-family: 宋体;">与</span><span lang="EN-US">OctreeSceneManager</span><span style="font-family: 宋体;">类似的，如果有必要的话，会调用</span><span lang="EN-US">BspSceneManager:: _notifyObjectMoved()</span><span style="font-family: 宋体;">－－》</span><span lang="EN-US">BspLevel:: _notifyObjectMoved()</span><span style="font-family: 宋体;">，将</span><span lang="EN-US">SceneNode</span><span style="font-family: 宋体;">中的</span><span lang="EN-US">MovableObject attach</span><span style="font-family: 宋体;">到正确的</span><span lang="EN-US">leaf node</span><span style="font-family: 宋体;">中。</span><span lang="EN-US"><br> <span style="">       </span></span><span style="font-family: 宋体;">接下来是</span><span lang="EN-US">BspSceneManager:: findVisibleObjects()</span><span style="font-family: 宋体;">，这是一个从</span><span lang="EN-US">SceneManager</span><span style="font-family: 宋体;">重写的函数。顺理成章的，这个函数调用了</span><span lang="EN-US">BspSceneManager::walkTree()</span><span style="font-family: 宋体;">。在这个函数中，首先找到了</span><span lang="EN-US">camera</span><span style="font-family: 宋体;">所在的</span><span lang="EN-US">leaf node</span><span style="font-family: 宋体;">（通过</span><span lang="EN-US">BspLevel::findleaf</span><span style="font-family: 宋体;">（）函数）；然后遍历</span><span lang="EN-US">BspLevel</span><span style="font-family: 宋体;">中的每个</span><span lang="EN-US">leaf node</span><span style="font-family: 宋体;">，先使用</span><span lang="EN-US">PVS</span><span style="font-family: 宋体;">检测可见性（通过</span><span lang="EN-US">BspLevel::isLeafVisible()</span><span style="font-family: 宋体;">函数），如果可见再使用</span><span lang="EN-US">camera</span><span style="font-family: 宋体;">――</span><span lang="EN-US">bounding box</span><span style="font-family: 宋体;">检测，如果还是可见的，则对此</span><span lang="EN-US">leaf node</span><span style="font-family: 宋体;">调用</span><span lang="EN-US">BspSceneManager::processVisibleLeaf()</span><span style="font-family: 宋体;">函数。此函数主要执行两个操作，一个是把</span><span lang="EN-US">World Geometry</span><span style="font-family: 宋体;">加入到渲染数据表中（</span><span lang="EN-US">mFaceGroupSet</span><span style="font-family: 宋体;">和</span><span lang="EN-US">mMatFaceGroupMap</span><span style="font-family: 宋体;">），另外一个是把与此</span><span lang="EN-US">leaf node</span><span style="font-family: 宋体;">相交的</span><span lang="EN-US">MoveableObject</span><span style="font-family: 宋体;">加到渲染队列中（</span><span lang="EN-US">mMovablesForRendering</span><span style="font-family: 宋体;">）。一件比较有疑问的事情是，</span><span lang="EN-US">walkTree</span><span style="font-family: 宋体;">是循环遍历所有</span><span lang="EN-US">leaf node</span><span style="font-family: 宋体;">，而没有按照</span><span lang="EN-US">BSP tree</span><span style="font-family: 宋体;">递归遍历，这大大削弱了</span><span lang="EN-US">BSP</span><span style="font-family: 宋体;">的提前排序的优势。</span></p> 
<p class="MsoNormal"><span lang="EN-US"><span style="">       </span></span><span style="font-family: 宋体;">然后是</span><span lang="EN-US">BspSceneManager</span><span style="font-family: 宋体;">重写了另外一个重要的函数</span><span lang="EN-US">_renderVisibleObjects()</span><span style="font-family: 宋体;">。此函数包含两个操作，一个是</span><span lang="EN-US">renderStaticGeometry()</span><span style="font-family: 宋体;">，另外一个是调用父类的</span><span lang="EN-US">SceneManager::_renderVisibleObjects()</span><span style="font-family: 宋体;">。前者循环遍历</span><span lang="EN-US">mMatFaceGroupMap</span><span style="font-family: 宋体;">，然后调用</span><span lang="EN-US">RenderSystem::_rendr()</span><span style="font-family: 宋体;">；后者已经在“</span><span lang="EN-US">Ogre</span><span style="font-family: 宋体;">学习笔记（</span><span lang="EN-US">3</span><span style="font-family: 宋体;">）：</span><span lang="EN-US">Mesh</span><span style="font-family: 宋体;">的渲染流程”中详细分析过了。</span></p>   
<img alt="" src="https://images2.imgbox.com/4e/d0/CrAwl9js_o.jpg">
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c7e89f8e754e482ca31c5daeceee1df7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SSIS处理导入数据时, 存在的更新, 不存在的插入</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1837d63983117e5ba5c300e572b3b047/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">模拟QQ截屏效果。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>