<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Leetcode题库（数据库合集） - 编程随想</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Leetcode题库（数据库合集）" />
<meta property="og:description" content="目录 难度：简单1. 组合两个表2. 第二高的薪水3. 第N高的薪水4. 分数排名5. 连续出现的数字6. 超过经理收入的员工7. 重新8. 寻找用户推荐人9. 销售员10. 排名靠前的旅行者11. 患某种疾病的患者12. 修复表中的名字13. 求关注者的数量14. 可回收且低脂的产品15. 计算特殊奖金16. 丢失信息的雇员17. 每个产品在不同商店的价格18. 文章浏览19. 上升的温度20. 按日期分组销售产品21. 员工奖金22. 使用唯一标识码替换员工Id23. 订单最多的客户24. 判断三角形25. 只出现一次的最大数字26. 平均售价27. 查找拥有有效邮箱的用户28. 查询结果的质量和占比29. 列出指定时间段内所有的下单产品30. 最高薪水差异31. 总旅行距离32. 自行车的最后使用时间33. 统计 Spotify 排行榜上艺术家出现次数34. 查询员工当前薪水35. 把名字和职业联系起来36. 形成化学键37. 整理奥运表38. 每位教师所教授的科目种类的数量39. 联赛的所有比赛39. 产品销售分析 ⑤ 难度：中等1.股票的资本损益2. 当选者3. 页面推荐4. 2016年的投资5. 买下所有产品的人6. 电影评分6. 确认率7. 按分类统计薪水8. 餐馆营业额的变化增长8. 即时食物配送 ①9. 至少有5名直系下属的经理10. 游戏玩法分析11. 好友申请：谁有最多的好友12. 指定日期的产品价格13. 每月交易14.市场分析15. 即时食物配送 ②16. 计算税后工资17. 选举结果18. 航班入座率和等待名单分析19. 统计文本中单词出现的次数20. 查找活跃用户21. 计算每个销售人员的影响力22. 坚定的友谊23." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/cfadfe5837cad047e31ed361287ad758/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-04T13:58:08+08:00" />
<meta property="article:modified_time" content="2023-12-04T13:58:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程随想" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程随想</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Leetcode题库（数据库合集）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">难度：简单</a></li><li><ul><li><a href="#1__2" rel="nofollow">1. 组合两个表</a></li><li><a href="#2__22" rel="nofollow">2. 第二高的薪水</a></li><li><a href="#3_N_49" rel="nofollow">3. 第N高的薪水</a></li><li><a href="#4__81" rel="nofollow">4. 分数排名</a></li><li><a href="#5__91" rel="nofollow">5. 连续出现的数字</a></li><li><a href="#6__120" rel="nofollow">6. 超过经理收入的员工</a></li><li><a href="#7__126" rel="nofollow">7. 重新</a></li><li><a href="#8__160" rel="nofollow">8. 寻找用户推荐人</a></li><li><a href="#9__186" rel="nofollow">9. 销售员</a></li><li><a href="#10__208" rel="nofollow">10. 排名靠前的旅行者</a></li><li><a href="#11__232" rel="nofollow">11. 患某种疾病的患者</a></li><li><a href="#12__246" rel="nofollow">12. 修复表中的名字</a></li><li><a href="#13__260" rel="nofollow">13. 求关注者的数量</a></li><li><a href="#14__273" rel="nofollow">14. 可回收且低脂的产品</a></li><li><a href="#15__284" rel="nofollow">15. 计算特殊奖金</a></li><li><a href="#16__300" rel="nofollow">16. 丢失信息的雇员</a></li><li><a href="#17__324" rel="nofollow">17. 每个产品在不同商店的价格</a></li><li><a href="#18__339" rel="nofollow">18. 文章浏览</a></li><li><a href="#19__362" rel="nofollow">19. 上升的温度</a></li><li><a href="#20__374" rel="nofollow">20. 按日期分组销售产品</a></li><li><a href="#21__403" rel="nofollow">21. 员工奖金</a></li><li><a href="#22_Id_438" rel="nofollow">22. 使用唯一标识码替换员工Id</a></li><li><a href="#23__480" rel="nofollow">23. 订单最多的客户</a></li><li><a href="#24__514" rel="nofollow">24. 判断三角形</a></li><li><a href="#25__538" rel="nofollow">25. 只出现一次的最大数字</a></li><li><a href="#26__569" rel="nofollow">26. 平均售价</a></li><li><a href="#27__618" rel="nofollow">27. 查找拥有有效邮箱的用户</a></li><li><a href="#28__652" rel="nofollow">28. 查询结果的质量和占比</a></li><li><a href="#29__691" rel="nofollow">29. 列出指定时间段内所有的下单产品</a></li><li><a href="#30__746" rel="nofollow">30. 最高薪水差异</a></li><li><a href="#31__783" rel="nofollow">31. 总旅行距离</a></li><li><a href="#32__835" rel="nofollow">32. 自行车的最后使用时间</a></li><li><a href="#33__Spotify__870" rel="nofollow">33. 统计 Spotify 排行榜上艺术家出现次数</a></li><li><a href="#34__906" rel="nofollow">34. 查询员工当前薪水</a></li><li><a href="#35__950" rel="nofollow">35. 把名字和职业联系起来</a></li><li><a href="#36__983" rel="nofollow">36. 形成化学键</a></li><li><a href="#37__1022" rel="nofollow">37. 整理奥运表</a></li><li><a href="#38__1070" rel="nofollow">38. 每位教师所教授的科目种类的数量</a></li><li><a href="#39__1104" rel="nofollow">39. 联赛的所有比赛</a></li><li><a href="#39___1135" rel="nofollow">39. 产品销售分析 ⑤</a></li></ul> 
  </li><li><a href="#_1151" rel="nofollow">难度：中等</a></li><li><ul><li><a href="#1_1152" rel="nofollow">1.股票的资本损益</a></li><li><a href="#2__1172" rel="nofollow">2. 当选者</a></li><li><a href="#3__1201" rel="nofollow">3. 页面推荐</a></li><li><a href="#4_2016_1219" rel="nofollow">4. 2016年的投资</a></li><li><a href="#5__1265" rel="nofollow">5. 买下所有产品的人</a></li><li><a href="#6__1300" rel="nofollow">6. 电影评分</a></li><li><a href="#6__1330" rel="nofollow">6. 确认率</a></li><li><a href="#7__1377" rel="nofollow">7. 按分类统计薪水</a></li><li><a href="#8__1421" rel="nofollow">8. 餐馆营业额的变化增长</a></li><li><a href="#8___1452" rel="nofollow">8. 即时食物配送 ①</a></li><li><a href="#9_5_1488" rel="nofollow">9. 至少有5名直系下属的经理</a></li><li><a href="#10__1533" rel="nofollow">10. 游戏玩法分析</a></li><li><a href="#11__1571" rel="nofollow">11. 好友申请：谁有最多的好友</a></li><li><a href="#12__1605" rel="nofollow">12. 指定日期的产品价格</a></li><li><a href="#13__1642" rel="nofollow">13. 每月交易</a></li><li><a href="#14_1676" rel="nofollow">14.市场分析</a></li><li><a href="#15___1747" rel="nofollow">15. 即时食物配送 ②</a></li><li><a href="#16__1781" rel="nofollow">16. 计算税后工资</a></li><li><a href="#17__1826" rel="nofollow">17. 选举结果</a></li><li><a href="#18__1866" rel="nofollow">18. 航班入座率和等待名单分析</a></li><li><a href="#19__1919" rel="nofollow">19. 统计文本中单词出现的次数</a></li><li><a href="#20__1949" rel="nofollow">20. 查找活跃用户</a></li><li><a href="#21__1989" rel="nofollow">21. 计算每个销售人员的影响力</a></li><li><a href="#22__2049" rel="nofollow">22. 坚定的友谊</a></li><li><a href="#23__2101" rel="nofollow">23. 苹果和桔子</a></li><li><a href="#24__2135" rel="nofollow">24. 小众书籍</a></li><li><a href="#25__2188" rel="nofollow">25. 矩形面积</a></li><li><a href="#26__2200" rel="nofollow">26. 最后一个能进入巴士的人</a></li><li><a href="#27__2236" rel="nofollow">27. 滚动平均步数</a></li><li><a href="#28__2288" rel="nofollow">28. 开除员工</a></li><li><a href="#29_2336" rel="nofollow">29.报告的记录</a></li><li><a href="#30__2344" rel="nofollow">30. 二级关注者</a></li><li><a href="#31__2388" rel="nofollow">31. 部门工资最高的员工</a></li><li><a href="#32__2442" rel="nofollow">32. 查询回答率最高的问题</a></li><li><a href="#33__2489" rel="nofollow">33. 统计各专业学生人数</a></li><li><a href="#34__2535" rel="nofollow">34. 平面上的最近距离</a></li><li><a href="#35__2564" rel="nofollow">35. 换座位</a></li><li><a href="#36___2611" rel="nofollow">36. 项目员工 ③</a></li><li><a href="#37__2658" rel="nofollow">37. 每日新用户统计</a></li><li><a href="#38__2707" rel="nofollow">38. 每位学生的最高成绩</a></li><li><a href="#39__2742" rel="nofollow">39. 查询活跃业务</a></li><li><a href="#40__2781" rel="nofollow">40. 查询球队积分</a></li><li><a href="#41__CEO__2853" rel="nofollow">41. 向公司 CEO 汇报工作的所有人</a></li><li><a href="#42__2896" rel="nofollow">42. 找到连续区间的开始和结束数字</a></li><li><a href="#43__2930" rel="nofollow">43. 不同性别每日分数总计</a></li><li><a href="#44__2964" rel="nofollow">44. 活动参与者</a></li><li><a href="#45__3016" rel="nofollow">45. 顾客的可信联系人数量</a></li><li><a href="#46_A_B_C__3098" rel="nofollow">46. 购买了产品A 和产品B 却没有购买产品C 的顾客</a></li><li><a href="#47__3168" rel="nofollow">47. 计算布尔表达式的值</a></li><li><a href="#48__3221" rel="nofollow">48. 可以放心投资的国家</a></li><li><a href="#49__3305" rel="nofollow">49. 最近的三笔订单</a></li><li><a href="#50__3366" rel="nofollow">50. 每件商品的最新订单</a></li><li><a href="#51__3444" rel="nofollow">51. 银行账户概要</a></li><li><a href="#52__3511" rel="nofollow">52. 每位顾客最经常订购的商品</a></li><li><a href="#53_ID_3588" rel="nofollow">53. 找到遗失的ID</a></li><li><a href="#54__3637" rel="nofollow">54. 两人之间的通话次数</a></li><li><a href="#55__3681" rel="nofollow">55. 访问日期之间最大的空档期</a></li><li><a href="#56_Leetflex__3735" rel="nofollow">56. 应该被禁止的Leetflex 账户</a></li><li><a href="#57__3774" rel="nofollow">57. 苹果和橘子的个数</a></li><li><a href="#58__3825" rel="nofollow">58. 大满贯数量</a></li><li><a href="#59__3876" rel="nofollow">59. 寻找面试候选人</a></li><li><a href="#60__3950" rel="nofollow">60. 每天的最大交易</a></li><li><a href="#61__3987" rel="nofollow">61. 联赛信息统计</a></li><li><a href="#62__4065" rel="nofollow">62. 可疑银行账户</a></li><li><a href="#63__4127" rel="nofollow">63. 最大数量高于平均水平的订单</a></li><li><a href="#64__4174" rel="nofollow">64. 将工资相同的雇员分组</a></li><li><a href="#65__4215" rel="nofollow">65. 查询具有最多共同关注者的所有两两结对组</a></li><li><a href="#66__4259" rel="nofollow">66. 找出每所学校的最低分数要求</a></li><li><a href="#67__4311" rel="nofollow">67. 统计实验的数量</a></li><li><a href="#68__4363" rel="nofollow">68. 无流量的账户数</a></li><li><a href="#69__4418" rel="nofollow">69. 面试中被录取的候选人</a></li><li><a href="#70__4476" rel="nofollow">70. 商店中每个成员的级别</a></li><li><a href="#71__4558" rel="nofollow">71. 账户余额</a></li><li><a href="#72_0_1__4595" rel="nofollow">72. 为订单类型为0 的客户删除类型为1 的订单</a></li><li><a href="#73__4647" rel="nofollow">73. 最繁忙的机场</a></li><li><a href="#74___4686" rel="nofollow">74. 每辆车的乘客人数 ①</a></li><li><a href="#75__4734" rel="nofollow">75. 分别排序两列</a></li><li><a href="#76__4770" rel="nofollow">76. 世界排名的变化</a></li><li><a href="#77_7_4822" rel="nofollow">77. 7天内两次购买的用户</a></li><li><a href="#78__4870" rel="nofollow">78. 司机成为乘客的次数</a></li><li><a href="#79_3_4905" rel="nofollow">79. 连续两年有3个及以上订单的产品</a></li><li><a href="#80__4915" rel="nofollow">80. 周末任务计数</a></li><li><a href="#81__4950" rel="nofollow">81. 按性别排列表格</a></li><li><a href="#82__4993" rel="nofollow">82. 每个城市最高气温的第一天</a></li><li><a href="#83__5030" rel="nofollow">83. 以百分比计算排名</a></li><li><a href="#84__5067" rel="nofollow">84. 将表中的空值更改为前一个值</a></li></ul> 
  </li><li><a href="#_5119" rel="nofollow">难度：困难</a></li><li><ul><li><a href="#1__5120" rel="nofollow">1. 部门工资前三高的所有员工</a></li><li><a href="#2__5141" rel="nofollow">2. 行程和用户</a></li><li><a href="#3__5147" rel="nofollow">3. 体育馆的人流量</a></li><li><a href="#4__5191" rel="nofollow">4. 员工薪水的中位数</a></li><li><a href="#5__5214" rel="nofollow">5. 同一天的第一个电话和最后一个电话</a></li><li><a href="#5__5242" rel="nofollow">5. 查询员工的累计薪水</a></li><li><a href="#6__5278" rel="nofollow">6. 给定数字的频率查询中位数</a></li><li><a href="#7__5297" rel="nofollow">7. 查询员工的累计薪水</a></li><li><a href="#8__5339" rel="nofollow">8. 学生地理信息报告</a></li><li><a href="#9__5374" rel="nofollow">9. 同一天的第一个和最后一个电话</a></li><li><a href="#10__5416" rel="nofollow">10. 职员招聘人数</a></li><li><a href="#11___5470" rel="nofollow">11. 职员招聘人数 ②</a></li><li><a href="#12__5521" rel="nofollow">12. 找到每篇文章的主题</a></li><li><a href="#13__5573" rel="nofollow">13. 生成发票</a></li><li><a href="#14__5626" rel="nofollow">14. 受欢迎度百分比</a></li><li><a href="#15__5664" rel="nofollow">15. 购买量严格增加的客户</a></li><li><a href="#16__5712" rel="nofollow">16. 合并在同一个大厅重叠的活动</a></li><li><a href="#17__5774" rel="nofollow">17. 表的动态旋转</a></li><li><a href="#18__5782" rel="nofollow">18. 兴趣相同的朋友</a></li><li><a href="#19_Leetcodify__5848" rel="nofollow">19. Leetcodify 好友推荐</a></li><li><a href="#20__5877" rel="nofollow">20. 航班机票状态</a></li><li><a href="#21__5928" rel="nofollow">21. 受欢迎度百分比</a></li><li><a href="#22__5963" rel="nofollow">22. 用户购买平台</a></li><li><a href="#23__6015" rel="nofollow">23. 锦标赛优胜者</a></li><li><a href="#24__6077" rel="nofollow">24. 周内每天的销售情况</a></li><li><a href="#25__6141" rel="nofollow">25. 平均工资：部门与公司比较</a></li><li><a href="#26___6198" rel="nofollow">26. 游戏玩法分析 ⑤</a></li><li><a href="#27__6239" rel="nofollow">27. 报告系统状态的连续日期</a></li><li><a href="#28__6291" rel="nofollow">28. 每次访问的交易次数</a></li><li><a href="#29__6366" rel="nofollow">29. 获取最近第二次的活动</a></li><li><a href="#30__6403" rel="nofollow">30. 按年度列出销售总额</a></li><li><a href="#31__6469" rel="nofollow">31. 查找成绩处于中游的学生</a></li><li><a href="#32__6532" rel="nofollow">32. 寻找没有被执行的任务对</a></li><li><a href="#33___6581" rel="nofollow">33. 页面推荐 ②</a></li><li><a href="#34__6599" rel="nofollow">34. 在连续天数上进行了最多交易次数的顾客</a></li><li><a href="#35__6644" rel="nofollow">35. 连续递增交易</a></li><li><a href="#36__6715" rel="nofollow">36. 最多连胜的次数</a></li><li><a href="#37___6759" rel="nofollow">37. 每辆车的乘客人数 ②</a></li><li><a href="#38__6842" rel="nofollow">38. 建立方程</a></li><li><a href="#39__6862" rel="nofollow">39. 动态取消表的旋转</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>难度：简单</h2> 
<h3><a id="1__2"></a>1. 组合两个表</h3> 
<p>表1：Person<br> <img src="https://images2.imgbox.com/93/ac/cTCEtPU4_o.png" alt="在这里插入图片描述"><br> PersonId 是上表主键<br> 表2： Address<br> <img src="https://images2.imgbox.com/94/d3/fsPmfyCa_o.png" alt="在这里插入图片描述"><br> AddressId 是上表主键<br> 编写一个 SQL 查询，满足条件：无论 person 是否有地址信息，都需要基于上述两表提供 person 的以下信息：<br> FirstName, LastName, City, State</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>FirstName<span class="token punctuation">,</span> a<span class="token punctuation">.</span>LastName<span class="token punctuation">,</span> b<span class="token punctuation">.</span>City<span class="token punctuation">,</span> b<span class="token punctuation">.</span>State 
<span class="token keyword">from</span> Person a 
<span class="token keyword">left</span> <span class="token keyword">join</span> Address b 
<span class="token keyword">on</span> a<span class="token punctuation">.</span>PersonID <span class="token operator">=</span> b<span class="token punctuation">.</span>PersonID
</code></pre> 
<h3><a id="2__22"></a>2. 第二高的薪水</h3> 
<p>编写一个 SQL 查询，获取 Employee 表中第二高的薪水（Salary） 。<br> <img src="https://images2.imgbox.com/06/ad/tsVf9iYZ_o.png" alt="在这里插入图片描述"><br> 例如上述 Employee 表，SQL查询应该返回 200 作为第二高的薪水。如果不存在第二高的薪水，那么查询应返回 null。<br> <img src="https://images2.imgbox.com/e1/4c/5dtBi8ST_o.png" alt="在这里插入图片描述"><br> 方法一：<br> 因为排序可能会出现薪资相同的情况，</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>Salary<span class="token punctuation">)</span> <span class="token keyword">as</span> SecondHighestSalary
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> Salary<span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> Salary <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> employee b
<span class="token keyword">group</span> <span class="token keyword">by</span> Salary
<span class="token punctuation">)</span> a
<span class="token keyword">where</span> a<span class="token punctuation">.</span>rnk <span class="token operator">=</span> <span class="token number">2</span>

</code></pre> 
<p>方法二：<br> 通过取最大值再去排除最大值去找到第二高的薪水。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>Salary<span class="token punctuation">)</span> <span class="token keyword">as</span> SecondHighestSalary 
<span class="token keyword">from</span> Employee
<span class="token keyword">where</span> Salary <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>Salary<span class="token punctuation">)</span> <span class="token keyword">from</span> Employee<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="3_N_49"></a>3. 第N高的薪水</h3> 
<p>有如下两张表T<br> 编写一个 SQL 查询，获取 Employee 表中第 n 高的薪水（Salary）。<br> <img src="https://images2.imgbox.com/2c/c6/7KfGgtdB_o.png" alt="在这里插入图片描述"></p> 
<p>例如上述 Employee 表，n = 2 时，应返回第二高的薪水 200。如果不存在第 n 高的薪水，那么查询应返回 null。<br> <img src="https://images2.imgbox.com/92/88/nBP7vvrs_o.png" alt="在这里插入图片描述"><br> 方法一：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> getNthHighestSalary<span class="token punctuation">(</span><span class="token variable">@N</span> <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">INT</span> <span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>    
<span class="token keyword">RETURN</span> <span class="token punctuation">(</span>        
<span class="token keyword">select</span> Salary <span class="token keyword">as</span> getNthHighestSalary        
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span>  Salary <span class="token punctuation">,</span>dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> Salary <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk        
<span class="token keyword">from</span> Employee        
<span class="token keyword">group</span> <span class="token keyword">by</span> Salary<span class="token punctuation">)</span> a        
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token variable">@N</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>
</code></pre> 
<p>方法二：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> getNthHighestSalary<span class="token punctuation">(</span><span class="token variable">@N</span> <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">INT</span> <span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">RETURN</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token keyword">distinct</span> Salary 
<span class="token keyword">from</span> Employee
<span class="token keyword">order</span> <span class="token keyword">by</span> Salary <span class="token keyword">desc</span>
<span class="token keyword">Offset</span> <span class="token variable">@N</span><span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">rows</span>
<span class="token keyword">Fetch</span> <span class="token keyword">next</span> <span class="token number">1</span> <span class="token keyword">rows</span> only<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>
</code></pre> 
<h3><a id="4__81"></a>4. 分数排名</h3> 
<p>编写一个 SQL 查询来实现分数排名。<br> 如果两个分数相同，则两个分数排名（Rank）相同。请注意，平分后的下一个名次应该是下一个连续的整数值。换句话说，名次之间不应该有“间隔”。<br> <img src="https://images2.imgbox.com/eb/d5/uN5KpJCv_o.png" alt="在这里插入图片描述"><br> 例如，根据上述给定的 Scores 表，你的查询应该返回（按分数从高到低排列）：<br> <img src="https://images2.imgbox.com/04/9a/VHfvfJft_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> Score<span class="token punctuation">,</span>DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> Score <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Rank
<span class="token keyword">from</span> Scores
</code></pre> 
<h3><a id="5__91"></a>5. 连续出现的数字</h3> 
<p>表：Logs<br> <img src="https://images2.imgbox.com/d8/35/XOlgORtd_o.png" alt="在这里插入图片描述"></p> 
<p>编写一个 SQL 查询，查找所有至少连续出现三次的数字。<br> 返回的结果表中的数据可以按 任意顺序 排列。<br> 查询结果格式如下面的例子所示：<br> <img src="https://images2.imgbox.com/0e/14/ngN7kXdh_o.png" alt="在这里插入图片描述"><br> 方法一：<br> 如果是连续100次，1000次数值相同，那么这种方法就不适用了</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>Num <span class="token keyword">as</span>  ConsecutiveNums
<span class="token keyword">from</span> Logs a 
<span class="token keyword">inner</span> <span class="token keyword">join</span> Logs b 
<span class="token keyword">on</span> a<span class="token punctuation">.</span>ID <span class="token operator">=</span> B<span class="token punctuation">.</span>ID <span class="token operator">+</span><span class="token number">1</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>NUm <span class="token operator">=</span> b<span class="token punctuation">.</span>Num
<span class="token keyword">inner</span> <span class="token keyword">join</span> Logs c 
<span class="token keyword">on</span> a<span class="token punctuation">.</span>ID <span class="token operator">=</span> C<span class="token punctuation">.</span>ID <span class="token operator">+</span><span class="token number">2</span> <span class="token operator">and</span> b<span class="token punctuation">.</span>Num <span class="token operator">=</span> c<span class="token punctuation">.</span>Num 
</code></pre> 
<p>方法二：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> Num <span class="token keyword">as</span> ConsecutiveNums 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> Num<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> SerialCount 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span>Num<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> id<span class="token punctuation">)</span> <span class="token operator">-</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> Num <span class="token keyword">order</span> <span class="token keyword">by</span> Id<span class="token punctuation">)</span> <span class="token keyword">as</span> SerialNumberSubGroup
<span class="token keyword">FROM</span> Logs<span class="token punctuation">)</span> <span class="token keyword">as</span> Sub
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Num<span class="token punctuation">,</span>SerialNumberSubGroup <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Result
</code></pre> 
<h3><a id="6__120"></a>6. 超过经理收入的员工</h3> 
<p>Employee 表包含所有员工，他们的经理也属于员工。每个员工都有一个 Id，此外还有一列对应员工的经理的 Id。<br> <img src="https://images2.imgbox.com/38/78/lRfpUDlP_o.png" alt="在这里插入图片描述"><br> 给定 Employee 表，编写一个 SQL 查询，该查询可以获取收入超过他们经理的员工的姓名。在上面的表格中，Joe 是唯一一个收入超过他的经理的员工。<br> <img src="https://images2.imgbox.com/51/3b/1myuEKDj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="7__126"></a>7. 重新</h3> 
<pre><code class="prism language-sql"><span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'department'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> department
<span class="token keyword">create</span> <span class="token keyword">table</span> department <span class="token punctuation">(</span>
    id <span class="token keyword">int</span>
    <span class="token punctuation">,</span>revenue <span class="token keyword">INT</span>
    <span class="token punctuation">,</span><span class="token keyword">MONTH</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> DEPARTMENT<span class="token punctuation">(</span>id<span class="token punctuation">,</span>REVENUE<span class="token punctuation">,</span><span class="token keyword">MONTH</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8000</span>    <span class="token punctuation">,</span> <span class="token string">'Jan'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">9000</span>    <span class="token punctuation">,</span> <span class="token string">'Jan'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">10000</span>   <span class="token punctuation">,</span> <span class="token string">'Feb'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7000</span>    <span class="token punctuation">,</span> <span class="token string">'Feb'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6000</span>    <span class="token punctuation">,</span> <span class="token string">'Mar'</span>  <span class="token punctuation">)</span>
<span class="token keyword">select</span> id
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Jan'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> jan_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Feb'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Feb_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Mar'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Mar_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Apr'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Apr_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'May'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> May_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Jun'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Jun_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Jul'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Jul_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Aug'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Aug_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Sep'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Sep_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Oct'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Oct_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Nov'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Nov_revenue
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">=</span> <span class="token string">'Dec'</span> <span class="token keyword">then</span> revenue <span class="token keyword">else</span> <span class="token boolean">null</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Dec_revenue
<span class="token keyword">from</span> DEPARTMENT
<span class="token keyword">group</span> <span class="token keyword">by</span> id
</code></pre> 
<h3><a id="8__160"></a>8. 寻找用户推荐人</h3> 
<p>给定表 customer ，里面保存了所有客户信息和他们的推荐人。<br> <img src="https://images2.imgbox.com/04/a1/DCa1IBeJ_o.png" alt="在这里插入图片描述"><br> 写一个查询语句，返回一个客户列表，列表中客户的推荐人的编号都 不是 2。</p> 
<p>对于上面的示例数据，结果为：</p> 
<p><img src="https://images2.imgbox.com/b8/28/ObJU95xd_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--方法一：执行耗时852ms</span>
<span class="token keyword">select</span> name 
<span class="token keyword">from</span> customer 
<span class="token keyword">where</span> isnull<span class="token punctuation">(</span>referee_id<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token number">2</span>

<span class="token comment">--方法二：执行耗时1038ms</span>
<span class="token keyword">select</span> name 
<span class="token keyword">from</span> customer 
<span class="token keyword">where</span> id <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> id <span class="token keyword">from</span> customer <span class="token keyword">where</span> referee_id <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">)</span>



</code></pre> 
<h3><a id="9__186"></a>9. 销售员</h3> 
<p><img src="https://images2.imgbox.com/b9/5f/7sDrt93Y_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fa/a9/9afOeicW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/aa/49/vV3SL0bK_o.png" alt="在这里插入图片描述"><br> 编写一个SQL查询，报告没有任何与名为 “RED” 的公司相关的订单的所有销售人员的姓名。</p> 
<p>以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql">
<span class="token comment">--方法一：运行耗时903ms</span>

<span class="token keyword">SELECT</span> s<span class="token punctuation">.</span>name
<span class="token keyword">FROM</span> salesperson s
<span class="token keyword">WHERE</span> s<span class="token punctuation">.</span>sales_id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span>
            o<span class="token punctuation">.</span>sales_id
        <span class="token keyword">FROM</span> orders o
        <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> company c 
        <span class="token keyword">ON</span> o<span class="token punctuation">.</span>com_id <span class="token operator">=</span> c<span class="token punctuation">.</span>com_id
        <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'RED'</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="10__208"></a>10. 排名靠前的旅行者</h3> 
<p>表：Users<br> <img src="https://images2.imgbox.com/c2/cd/GfCRSzvA_o.png" alt="在这里插入图片描述"><br> 表：Rides<br> <img src="https://images2.imgbox.com/08/6f/ACJDOKI5_o.png" alt="在这里插入图片描述"><br> 写一段 SQL , 报告每个用户的旅行距离。</p> 
<p>返回的结果表单，以 travelled_distance 降序排列 ，如果有两个或者更多的用户旅行了相同的距离, 那么再以 name 升序排列 。</p> 
<p>查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/df/13/G0HfYjlg_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> name<span class="token punctuation">,</span>travelled_distance <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> b<span class="token punctuation">.</span>id<span class="token punctuation">,</span>b<span class="token punctuation">.</span>name<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> travelled_distance 
<span class="token keyword">from</span> users b
<span class="token keyword">left</span> <span class="token keyword">join</span> rides a 
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>id 
<span class="token keyword">group</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>id<span class="token punctuation">,</span>b<span class="token punctuation">.</span>name <span class="token punctuation">)</span> a 
<span class="token keyword">order</span> <span class="token keyword">by</span> travelled_distance <span class="token keyword">desc</span><span class="token punctuation">,</span>name <span class="token keyword">asc</span>
</code></pre> 
<h3><a id="11__232"></a>11. 患某种疾病的患者</h3> 
<p>患者信息表： Patients<br> <img src="https://images2.imgbox.com/ad/93/ZA1hZ93e_o.png" alt="在这里插入图片描述"><br> 写一条 SQL 语句，查询患有 I 类糖尿病的患者 ID （patient_id）、患者姓名（patient_name）以及其患有的所有疾病代码（conditions）。I 类糖尿病的代码总是包含前缀 DIAB1 。</p> 
<p>按 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> 
<span class="token keyword">from</span> patients 
<span class="token keyword">where</span> conditions <span class="token operator">like</span> <span class="token string">'DIAB1%'</span>
<span class="token operator">or</span> conditions <span class="token operator">like</span> <span class="token string">'% DIAB1%'</span>
</code></pre> 
<h3><a id="12__246"></a>12. 修复表中的名字</h3> 
<p>表： Users<br> <img src="https://images2.imgbox.com/c2/0a/XyPf6COC_o.png" alt="在这里插入图片描述"><br> 编写一个 SQL 查询来修复名字，使得只有第一个字符是大写的，其余都是小写的。</p> 
<p>返回按 user_id 排序的结果表。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> user_id<span class="token punctuation">,</span>
concat<span class="token punctuation">(</span>upper<span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lower<span class="token punctuation">(</span><span class="token keyword">right</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> name
<span class="token keyword">from</span> Users
<span class="token keyword">order</span> <span class="token keyword">by</span> user_id
</code></pre> 
<h3><a id="13__260"></a>13. 求关注者的数量</h3> 
<p>表： Followers<br> <img src="https://images2.imgbox.com/2a/d0/nRu3s0wt_o.png" alt="在这里插入图片描述"><br> 写出 SQL 语句，对于每一个用户，返回该用户的关注者数量。</p> 
<p>按 user_id 的顺序返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> user_id <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> followers_count
<span class="token keyword">from</span> Followers 
<span class="token keyword">group</span> <span class="token keyword">by</span> user_id
</code></pre> 
<h3><a id="14__273"></a>14. 可回收且低脂的产品</h3> 
<p>表：Products<br> <img src="https://images2.imgbox.com/da/f2/QeKnfFE1_o.png" alt="在这里插入图片描述"><br> 写出 SQL 语句，查找既是低脂又是可回收的产品编号。</p> 
<p>返回结果 无顺序要求 。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> product_id <span class="token keyword">from</span> Products 
<span class="token keyword">where</span> low_fats <span class="token operator">=</span><span class="token string">'Y'</span> <span class="token operator">and</span> recyclable <span class="token operator">=</span><span class="token string">'Y'</span>
</code></pre> 
<h3><a id="15__284"></a>15. 计算特殊奖金</h3> 
<p>表: Employees<br> <img src="https://images2.imgbox.com/5f/b5/kjy104G3_o.png" alt="在这里插入图片描述"><br> 写出一个SQL 查询语句，计算每个雇员的奖金。如果一个雇员的id是奇数并且他的名字不是以’M’开头，那么他的奖金是他工资的100%，否则奖金为0。</p> 
<p>Return the result table ordered by employee_id.</p> 
<p>返回的结果集请按照employee_id排序。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> employee_id  
<span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> employee_id <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token keyword">left</span><span class="token punctuation">(</span>name  <span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span><span class="token string">'M'</span>
<span class="token keyword">then</span> salary  <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token keyword">as</span> bonus 
<span class="token keyword">from</span> Employees 
<span class="token keyword">order</span> <span class="token keyword">by</span> employee_id
</code></pre> 
<h3><a id="16__300"></a>16. 丢失信息的雇员</h3> 
<p>表: Employees<br> <img src="https://images2.imgbox.com/9f/58/blKZgXFT_o.png" alt="在这里插入图片描述"><br> 表: Salaries<br> <img src="https://images2.imgbox.com/48/db/8w7NqmkT_o.png" alt="在这里插入图片描述"><br> 写出一个查询语句，找到所有 丢失信息 的雇员id。当满足下面一个条件时，就被认为是雇员的信息丢失：</p> 
<p>雇员的 姓名 丢失了，或者<br> 雇员的 薪水信息 丢失了，或者<br> 返回这些雇员的id employee_id ， 从小到大排序 。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> employee_id <span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span> employee_id <span class="token keyword">from</span> Employees
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span> employee_id <span class="token keyword">from</span> Salaries
<span class="token punctuation">)</span><span class="token keyword">as</span> t
<span class="token keyword">group</span> <span class="token keyword">by</span> employee_id
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>employee_id<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> employee_id
</code></pre> 
<h3><a id="17__324"></a>17. 每个产品在不同商店的价格</h3> 
<p>表：Products<br> <img src="https://images2.imgbox.com/9b/6b/F6EoN2ot_o.png" alt="在这里插入图片描述"><br> 请你重构 Products 表，查询每个产品在不同商店的价格，使得输出的格式变为(product_id, store, price) 。如果这一产品在商店里没有出售，则不输出这一行。</p> 
<p>输出结果表中的 顺序不作要求 。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> product_id<span class="token punctuation">,</span>store<span class="token punctuation">,</span>price
<span class="token keyword">from</span> Products 
<span class="token keyword">unpivot</span><span class="token punctuation">(</span>price <span class="token keyword">for</span> store <span class="token operator">in</span><span class="token punctuation">(</span>store1  <span class="token punctuation">,</span>store2<span class="token punctuation">,</span>store3  <span class="token punctuation">)</span><span class="token punctuation">)</span> c<span class="token punctuation">)</span>a 
<span class="token keyword">where</span> price <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
</code></pre> 
<h3><a id="18__339"></a>18. 文章浏览</h3> 
<p>请编写一条 SQL 查询以找出所有浏览过自己文章的作者，结果按照 id 升序排列。</p> 
<p>查询结果的格式如下所示：<br> <img src="https://images2.imgbox.com/24/2c/wOFoG5tz_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--distinct 去重</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> author_id <span class="token keyword">as</span> id 
<span class="token keyword">from</span> Views 
<span class="token keyword">where</span> author_id <span class="token operator">=</span> viewer_id
<span class="token keyword">order</span> <span class="token keyword">by</span> author_id 

<span class="token comment">--group by 去重</span>
<span class="token keyword">select</span>  author_id <span class="token keyword">as</span> id 
<span class="token keyword">from</span> Views 
<span class="token keyword">where</span> author_id <span class="token operator">=</span> viewer_id
<span class="token keyword">group</span> <span class="token keyword">by</span> author_id
<span class="token keyword">order</span> <span class="token keyword">by</span> author_id 
</code></pre> 
<h3><a id="19__362"></a>19. 上升的温度</h3> 
<p>编写一个 SQL 查询，来查找与之前（昨天的）日期相比温度更高的所有日期的 id 。<br> 返回结果 不要求顺序 。<br> 查询结果格式如下例。<br> <img src="https://images2.imgbox.com/a5/04/SI5pNF0e_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>id <span class="token keyword">from</span> weather a
<span class="token keyword">left</span> <span class="token keyword">join</span> weather b 
<span class="token keyword">on</span> a<span class="token punctuation">.</span>recordDate <span class="token operator">=</span> dateadd<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>recordDate<span class="token punctuation">)</span>
<span class="token keyword">where</span> a<span class="token punctuation">.</span>temperature <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>temperature
</code></pre> 
<h3><a id="20__374"></a>20. 按日期分组销售产品</h3> 
<p>编写一个 SQL 查询来查找每个日期、销售的不同产品的数量及其名称。<br> 每个日期的销售产品名称应按词典序排列。<br> 返回按 sell_date 排序的结果表。<br> 查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/1c/f0/kJCi8cmn_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--MS SQL SERVER</span>
<span class="token keyword">select</span> sell_date <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> product<span class="token punctuation">)</span> <span class="token keyword">as</span>  num_sold 
<span class="token punctuation">,</span>STUFF<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> <span class="token string">','</span><span class="token operator">+</span>product 
<span class="token keyword">from</span> activities B 
<span class="token keyword">where</span>  A<span class="token punctuation">.</span>sell_date <span class="token operator">=</span> B<span class="token punctuation">.</span>sell_date 
<span class="token keyword">FOR</span> XML PATH<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> products                     
<span class="token keyword">from</span> activities a
<span class="token keyword">group</span> <span class="token keyword">by</span> sell_date

<span class="token comment">--MySQL</span>
<span class="token keyword">select</span> 
    sell_date<span class="token punctuation">,</span> 
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> product<span class="token punctuation">)</span> <span class="token keyword">as</span> num_sold<span class="token punctuation">,</span> 
    group_concat<span class="token punctuation">(</span><span class="token keyword">distinct</span> product <span class="token keyword">order</span> <span class="token keyword">by</span> product separator <span class="token string">','</span><span class="token punctuation">)</span> <span class="token keyword">as</span> products
<span class="token keyword">from</span> Activities
<span class="token keyword">group</span> <span class="token keyword">by</span> sell_date
<span class="token keyword">order</span> <span class="token keyword">by</span> sell_date<span class="token punctuation">;</span>


</code></pre> 
<h3><a id="21__403"></a>21. 员工奖金</h3> 
<p>选出所有 bonus &lt; 1000 的员工的 name 及其 bonus。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employee'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employee
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employee<span class="token punctuation">(</span>
    empId <span class="token keyword">int</span><span class="token punctuation">,</span>  name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> supervisor <span class="token keyword">int</span> <span class="token punctuation">,</span> salary  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employee
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'John'</span>   <span class="token punctuation">,</span><span class="token number">3</span>       <span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'Dan'</span>    <span class="token punctuation">,</span><span class="token number">3</span>       <span class="token punctuation">,</span> <span class="token number">2000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'Brad'</span>   <span class="token punctuation">,</span><span class="token boolean">null</span>    <span class="token punctuation">,</span> <span class="token number">4000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'Thomas'</span> <span class="token punctuation">,</span><span class="token number">3</span>       <span class="token punctuation">,</span> <span class="token number">4000</span> <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Bonus'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Bonus
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Bonus <span class="token punctuation">(</span>
    empId <span class="token keyword">int</span> <span class="token punctuation">,</span> bonus  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Bonus
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">500</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>name<span class="token punctuation">,</span>b<span class="token punctuation">.</span>bonus
<span class="token keyword">from</span> employee a
<span class="token keyword">left</span> <span class="token keyword">join</span> bonus b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>empid <span class="token operator">=</span> b<span class="token punctuation">.</span>empid
<span class="token keyword">where</span> isnull<span class="token punctuation">(</span>b<span class="token punctuation">.</span>bonus<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1000</span>
</code></pre> 
<h3><a id="22_Id_438"></a>22. 使用唯一标识码替换员工Id</h3> 
<p>写一段SQL查询来展示每位用户的 唯一标识码（unique ID ）；如果某位员工没有唯一标识码，使用 null 填充即可。<br> 你可以以 任意 顺序返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employees'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employees
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employees  <span class="token punctuation">(</span>
 id            <span class="token keyword">int</span>
<span class="token punctuation">,</span> name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employees
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'Alice'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span>  <span class="token punctuation">,</span><span class="token string">'Bob'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">11</span> <span class="token punctuation">,</span><span class="token string">'Meir'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">90</span> <span class="token punctuation">,</span><span class="token string">'Winston'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'Jonathan'</span> <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'EmployeeUNI'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> EmployeeUNI
go
<span class="token keyword">create</span> <span class="token keyword">table</span> EmployeeUNI<span class="token punctuation">(</span>
  id           <span class="token keyword">int</span>
<span class="token punctuation">,</span> unique_id     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> EmployeeUNI
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">11</span> <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">90</span> <span class="token punctuation">,</span> <span class="token number">3</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> b<span class="token punctuation">.</span>unique_id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>name
<span class="token keyword">from</span> Employees a
<span class="token keyword">left</span> <span class="token keyword">join</span> EmployeeUNI b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id

</code></pre> 
<h3><a id="23__480"></a>23. 订单最多的客户</h3> 
<p>编写一个SQL查询，为下了 最多订单 的客户查找 customer_number 。<br> 测试用例生成后， 恰好有一个客户 比任何其他客户下了更多的订单。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders<span class="token punctuation">(</span>
  order_number    <span class="token keyword">int</span>
<span class="token punctuation">,</span> customer_number <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--方法一</span>
<span class="token keyword">select</span> customer_number <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> cnt <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> customer_number <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> order_number<span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
        <span class="token keyword">from</span> Orders
        <span class="token keyword">group</span> <span class="token keyword">by</span> customer_number <span class="token punctuation">)</span> a <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">--方法二</span>
<span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">1</span> customer_number 
<span class="token keyword">from</span> orders 
<span class="token keyword">group</span> <span class="token keyword">by</span> customer_number 
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span>order_number<span class="token punctuation">)</span> <span class="token keyword">desc</span>
</code></pre> 
<h3><a id="24__514"></a>24. 判断三角形</h3> 
<p>写一个SQL查询，每三个线段报告它们是否可以形成一个三角形。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Triangle'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Triangle
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Triangle<span class="token punctuation">(</span>
 x         <span class="token keyword">int</span>
<span class="token punctuation">,</span>y         <span class="token keyword">int</span>
<span class="token punctuation">,</span>z         <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Triangle
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">15</span> <span class="token punctuation">,</span><span class="token number">30</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span> <span class="token punctuation">,</span><span class="token number">15</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
       <span class="token keyword">case</span> <span class="token keyword">when</span> x<span class="token operator">+</span>y<span class="token operator">&gt;</span>z <span class="token operator">and</span>  x<span class="token operator">+</span>z<span class="token operator">&gt;</span>y <span class="token operator">and</span>  y<span class="token operator">+</span>z <span class="token operator">&gt;</span>x <span class="token keyword">then</span> <span class="token string">'Yes'</span> <span class="token keyword">else</span> <span class="token string">'No'</span> <span class="token keyword">END</span> <span class="token keyword">as</span> triangle
<span class="token keyword">FROM</span> Triangle
</code></pre> 
<h3><a id="25__538"></a>25. 只出现一次的最大数字</h3> 
<p>单一数字 是在 MyNumbers 表中只出现一次的数字。<br> 请你编写一个 SQL 查询来报告最大的 单一数字 。如果不存在 单一数字 ，查询需报告 null 。</p> 
<pre><code class="prism language-sql"><span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'MyNumbers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> MyNumbers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> MyNumbers  <span class="token punctuation">(</span>
     num        <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> MyNumbers
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">8</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">as</span> num
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> num
        <span class="token keyword">from</span> MyNumbers
        <span class="token keyword">group</span> <span class="token keyword">by</span> num
        <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">)</span> a
</code></pre> 
<h3><a id="26__569"></a>26. 平均售价</h3> 
<p>编写SQL查询以查找每种产品的平均售价。<br> average_price 应该四舍五入到小数点后两位。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Prices'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Prices
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Prices<span class="token punctuation">(</span>
  product_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> start_date     <span class="token keyword">date</span>
<span class="token punctuation">,</span> end_date       <span class="token keyword">date</span>
<span class="token punctuation">,</span> price          <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Prices
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2019-02-17'</span><span class="token punctuation">,</span><span class="token string">'2019-02-28'</span><span class="token punctuation">,</span> <span class="token number">5</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2019-03-01'</span><span class="token punctuation">,</span><span class="token string">'2019-03-22'</span><span class="token punctuation">,</span> <span class="token number">20</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2019-02-01'</span><span class="token punctuation">,</span><span class="token string">'2019-02-20'</span><span class="token punctuation">,</span> <span class="token number">15</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2019-02-21'</span><span class="token punctuation">,</span><span class="token string">'2019-03-31'</span><span class="token punctuation">,</span> <span class="token number">30</span>     <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'UnitsSold'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> UnitsSold
go
<span class="token keyword">create</span> <span class="token keyword">table</span> UnitsSold <span class="token punctuation">(</span>
    product_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>purchase_date  <span class="token keyword">date</span>
<span class="token punctuation">,</span> units          <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> UnitsSold
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2019-02-25'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2019-03-01'</span><span class="token punctuation">,</span> <span class="token number">15</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'2019-02-10'</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'2019-03-22'</span><span class="token punctuation">,</span> <span class="token number">30</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

<span class="token keyword">select</span> product_id <span class="token punctuation">,</span>cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>price <span class="token operator">*</span> units <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span>units<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> average_price
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>units
<span class="token keyword">from</span> Prices  a
<span class="token keyword">left</span> <span class="token keyword">join</span> UnitsSold b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>product_id <span class="token operator">=</span> b<span class="token punctuation">.</span>product_id
<span class="token operator">and</span> b<span class="token punctuation">.</span>purchase_date <span class="token operator">between</span> a<span class="token punctuation">.</span>start_date <span class="token operator">and</span> a<span class="token punctuation">.</span>end_date <span class="token punctuation">)</span> a
<span class="token keyword">group</span> <span class="token keyword">by</span> product_id

</code></pre> 
<h3><a id="27__618"></a>27. 查找拥有有效邮箱的用户</h3> 
<p>写一条 SQL 语句，查询拥有有效邮箱的用户。<br> 有效的邮箱包含符合下列条件的前缀名和域名：<br> 前缀名是包含字母（大写或小写）、数字、下划线 ‘_’、句点 ‘.’ 和/或横杠 ‘-’ 的字符串。前缀名必须以字母开头。<br> 域名是 ‘@leetcode.com’ 。<br> 按任意顺序返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Users
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Users <span class="token punctuation">(</span>
  user_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> name          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> mail          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Users
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'Winston'</span>   <span class="token punctuation">,</span><span class="token string">'winston@leetcode.com'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'Jonathan'</span>  <span class="token punctuation">,</span><span class="token string">'jonathanisgreat'</span>         <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Annabelle'</span> <span class="token punctuation">,</span><span class="token string">'bella-@leetcode.com'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Sally'</span>     <span class="token punctuation">,</span><span class="token string">'sally.come@leetcode.com'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'Marwan'</span>    <span class="token punctuation">,</span><span class="token string">'quarz#2020@leetcode.com'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'David'</span>     <span class="token punctuation">,</span><span class="token string">'david69@gmail.com'</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span><span class="token string">'Shapiro'</span>   <span class="token punctuation">,</span><span class="token string">'.shapo@leetcode.com'</span>     <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Users
<span class="token keyword">WHERE</span> mail <span class="token operator">LIKE</span> <span class="token string">'[A-Za-z]%@leetcode.com'</span> <span class="token operator">AND</span> mail <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%[^A-Za-z0-9._/-]%@%'</span>

</code></pre> 
<h3><a id="28__652"></a>28. 查询结果的质量和占比</h3> 
<p><img src="https://images2.imgbox.com/8f/38/VTLfFXRA_o.png" alt="在这里插入图片描述"></p> 
<p>将查询结果的质量 quality 定义为：<br> 各查询结果的评分与其位置之间比率的平均值。</p> 
<p>将劣质查询百分比 poor_query_percentage 为：<br> 评分小于 3 的查询结果占全部查询结果的百分比。</p> 
<p>编写一组 SQL 来查找每次查询的名称(query_name)、质量(quality) 和 劣质查询百分比(poor_query_percentage)。<br> 质量(quality) 和劣质查询百分比(poor_query_percentage) 都应四舍五入到小数点后两位。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Queries'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Queries
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Queries<span class="token punctuation">(</span>
 query_name   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>result       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>position     <span class="token keyword">int</span>
<span class="token punctuation">,</span>rating       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>     Queries
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token string">'Dog'</span><span class="token punctuation">,</span>       <span class="token string">'Golden Retriever'</span>  <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">5</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Dog'</span><span class="token punctuation">,</span>       <span class="token string">'German Shepherd'</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">5</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Dog'</span><span class="token punctuation">,</span>       <span class="token string">'Mule'</span>              <span class="token punctuation">,</span><span class="token number">200</span>  <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span>       <span class="token string">'Shirazi'</span>           <span class="token punctuation">,</span><span class="token number">5</span>    <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span>       <span class="token string">'Siamese'</span>           <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span>       <span class="token string">'Sphynx'</span>            <span class="token punctuation">,</span><span class="token number">7</span>    <span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> query_name<span class="token punctuation">,</span> cast<span class="token punctuation">(</span><span class="token function">avg</span><span class="token punctuation">(</span>rating <span class="token operator">*</span><span class="token number">1.0</span> <span class="token operator">/</span> position <span class="token punctuation">)</span>  <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Quality
<span class="token punctuation">,</span>cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> rating <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> poor_query_percentage
<span class="token keyword">from</span> Queries
<span class="token keyword">group</span> <span class="token keyword">by</span> query_name
</code></pre> 
<h3><a id="29__691"></a>29. 列出指定时间段内所有的下单产品</h3> 
<p>写一个解决方案，要求获取在 2020 年 2 月份下单的数量不少于 100 的产品的名字和数目。<br> 返回结果表单的 顺序无要求 。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span><span class="token string">'U'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Products
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Products<span class="token punctuation">(</span>
     product_id       <span class="token keyword">int</span>
 <span class="token punctuation">,</span>product_name     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
 <span class="token punctuation">,</span>product_category <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Products
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'Leetcode Solutions'</span>    <span class="token punctuation">,</span><span class="token string">'Book'</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>      <span class="token punctuation">,</span><span class="token string">'Jewels of Stringology'</span> <span class="token punctuation">,</span><span class="token string">'Book'</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>      <span class="token punctuation">,</span><span class="token string">'HP'</span>                    <span class="token punctuation">,</span><span class="token string">'Laptop'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>      <span class="token punctuation">,</span><span class="token string">'Lenovo'</span>                <span class="token punctuation">,</span><span class="token string">'Laptop'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span>      <span class="token punctuation">,</span><span class="token string">'Leetcode Kit'</span>          <span class="token punctuation">,</span><span class="token string">'T-shirt'</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders<span class="token punctuation">(</span>
  product_id    <span class="token keyword">int</span>
 <span class="token punctuation">,</span>order_date    <span class="token keyword">date</span>
 <span class="token punctuation">,</span>unit          <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2020-02-05'</span><span class="token punctuation">,</span><span class="token number">60</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2020-02-10'</span><span class="token punctuation">,</span><span class="token number">70</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2020-01-18'</span><span class="token punctuation">,</span><span class="token number">30</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2020-02-11'</span><span class="token punctuation">,</span><span class="token number">80</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'2020-02-17'</span><span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'2020-02-24'</span><span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'2020-03-01'</span><span class="token punctuation">,</span><span class="token number">20</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'2020-03-04'</span><span class="token punctuation">,</span><span class="token number">30</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'2020-03-04'</span><span class="token punctuation">,</span><span class="token number">60</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'2020-02-25'</span><span class="token punctuation">,</span><span class="token number">50</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'2020-02-27'</span><span class="token punctuation">,</span><span class="token number">50</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'2020-03-01'</span><span class="token punctuation">,</span><span class="token number">50</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>Product_name<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>Unit<span class="token punctuation">)</span> <span class="token keyword">as</span> Unit
<span class="token keyword">from</span> Products  a
<span class="token keyword">left</span> <span class="token keyword">join</span> orders b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>product_id <span class="token operator">=</span> b<span class="token punctuation">.</span>product_id
<span class="token keyword">where</span> <span class="token keyword">year</span><span class="token punctuation">(</span>order_date <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2020</span> <span class="token operator">and</span> <span class="token keyword">month</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>product_name
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>Unit<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">100</span>
</code></pre> 
<h3><a id="30__746"></a>30. 最高薪水差异</h3> 
<p><img src="https://images2.imgbox.com/95/60/EOoRk0aX_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案，计算 市场部门 和 工程部门 中 最高 工资之间的差异。输出工资的绝对差异。<br> 返回结果表。<br> 返回结果格式如下示例所示。<br> <img src="https://images2.imgbox.com/a7/96/16exYqqa_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Salaries'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Salaries
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Salaries<span class="token punctuation">(</span>
 emp_name     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> department   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> salary      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Salaries
<span class="token keyword">values</span>
 <span class="token punctuation">(</span>  <span class="token string">'Kathy'</span>    <span class="token punctuation">,</span><span class="token string">'Engineering'</span> <span class="token punctuation">,</span><span class="token number">50000</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'Roy'</span>      <span class="token punctuation">,</span><span class="token string">'Marketing'</span>   <span class="token punctuation">,</span><span class="token number">30000</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'Charles'</span>  <span class="token punctuation">,</span><span class="token string">'Engineering'</span> <span class="token punctuation">,</span><span class="token number">45000</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'Jack'</span>     <span class="token punctuation">,</span><span class="token string">'Engineering'</span> <span class="token punctuation">,</span><span class="token number">85000</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'Benjamin'</span> <span class="token punctuation">,</span><span class="token string">'Marketing'</span>   <span class="token punctuation">,</span><span class="token number">34000</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'Anthony'</span>  <span class="token punctuation">,</span><span class="token string">'Marketing'</span>   <span class="token punctuation">,</span><span class="token number">42000</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'Edward'</span>   <span class="token punctuation">,</span><span class="token string">'Engineering'</span> <span class="token punctuation">,</span><span class="token number">102000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'Terry'</span>    <span class="token punctuation">,</span><span class="token string">'Engineering'</span> <span class="token punctuation">,</span><span class="token number">44000</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'Evelyn'</span>   <span class="token punctuation">,</span><span class="token string">'Marketing'</span>   <span class="token punctuation">,</span><span class="token number">53000</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'Arthur'</span>   <span class="token punctuation">,</span><span class="token string">'Engineering'</span> <span class="token punctuation">,</span><span class="token number">32000</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> ABS<span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>salary<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">max</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>salary<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> salary_difference
<span class="token keyword">from</span> salaries a
<span class="token keyword">full</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> salaries b
<span class="token keyword">on</span> b<span class="token punctuation">.</span>department <span class="token operator">=</span> <span class="token string">'Marketing'</span>
<span class="token keyword">where</span> a<span class="token punctuation">.</span>department <span class="token operator">=</span> <span class="token string">'Engineering'</span>
</code></pre> 
<h3><a id="31__783"></a>31. 总旅行距离</h3> 
<p><img src="https://images2.imgbox.com/23/b0/CEyKeIFB_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案，计算每个用户的旅行距离 distance 。如果有用户没有任何旅行记录，那么他们的 distance 应被视为 0 。输出 user_id, name 和总旅行距离 traveled distance 。<br> 按 升序排序 的 user_id 返回结果表。<br> 结果格式如下示例。<br> <img src="https://images2.imgbox.com/c8/a5/YN2lXPYS_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Users
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Users<span class="token punctuation">(</span>
user_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> name        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Users
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">17</span>  <span class="token punctuation">,</span><span class="token string">'Addison'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">14</span>  <span class="token punctuation">,</span><span class="token string">'Ethan'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'Michael'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'Avery'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">10</span>  <span class="token punctuation">,</span><span class="token string">'Eleanor'</span> <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Rides'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Rides
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Rides <span class="token punctuation">(</span>
ride_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span>user_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span>distance      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Rides
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">72</span>  <span class="token punctuation">,</span><span class="token number">17</span>   <span class="token punctuation">,</span><span class="token number">160</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">42</span>  <span class="token punctuation">,</span><span class="token number">14</span>   <span class="token punctuation">,</span><span class="token number">161</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">45</span>  <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token number">59</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">32</span>  <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">197</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">15</span>  <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token number">357</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">56</span>  <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">196</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">10</span>  <span class="token punctuation">,</span><span class="token number">14</span>   <span class="token punctuation">,</span><span class="token number">25</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span>a<span class="token punctuation">.</span>name
<span class="token punctuation">,</span> isnull<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>distance <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>traveled distance<span class="token punctuation">]</span>
<span class="token keyword">from</span> Users  a
<span class="token keyword">left</span> <span class="token keyword">join</span> Rides b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span>a<span class="token punctuation">.</span>name
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id
</code></pre> 
<h3><a id="32__835"></a>32. 自行车的最后使用时间</h3> 
<p><img src="https://images2.imgbox.com/7f/db/5q3I66Ij_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案，找出每辆自行车 最近一次被使用 的时间。<br> 返回结果表按 最近被使用 的自行车进行排序。<br> 返回结果的格式如下所示：<br> <img src="https://images2.imgbox.com/29/40/T2WqXkR8_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Bikes'</span> <span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Bikes
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Bikes<span class="token punctuation">(</span>
    ride_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> bike_number  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> start_time   <span class="token keyword">datetime</span>
<span class="token punctuation">,</span> end_time     <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Bikes
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'W00576'</span><span class="token punctuation">,</span> <span class="token string">'2012-03-25 11:30:00'</span><span class="token punctuation">,</span>  <span class="token string">'2012-03-25 12:40:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'W00300'</span><span class="token punctuation">,</span> <span class="token string">'2012-03-25 10:30:00'</span><span class="token punctuation">,</span>  <span class="token string">'2012-03-25 10:50:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'W00455'</span><span class="token punctuation">,</span> <span class="token string">'2012-03-26 14:30:00'</span><span class="token punctuation">,</span>  <span class="token string">'2012-03-26 17:40:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'W00455'</span><span class="token punctuation">,</span> <span class="token string">'2012-03-25 12:30:00'</span><span class="token punctuation">,</span>  <span class="token string">'2012-03-25 13:40:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'W00576'</span><span class="token punctuation">,</span> <span class="token string">'2012-03-25 08:10:00'</span><span class="token punctuation">,</span>  <span class="token string">'2012-03-25 09:10:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token string">'W00576'</span><span class="token punctuation">,</span> <span class="token string">'2012-03-28 02:30:00'</span><span class="token punctuation">,</span>  <span class="token string">'2012-03-28 02:50:00'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> bike_number
<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>end_time            <span class="token punctuation">)</span> <span class="token keyword">as</span> end_time
<span class="token keyword">from</span> Bikes
<span class="token keyword">group</span> <span class="token keyword">by</span> bike_number
<span class="token keyword">order</span> <span class="token keyword">by</span> end_time <span class="token keyword">desc</span>
</code></pre> 
<h3><a id="33__Spotify__870"></a>33. 统计 Spotify 排行榜上艺术家出现次数</h3> 
<p><img src="https://images2.imgbox.com/94/09/EbnTut5g_o.png" alt="在这里插入图片描述"><br> 编写解决方案来查找每个艺术家在Spotify排行榜上出现的次数。<br> 返回结果表，其中包含艺术家的名称以及相应的出现次数，按出现次数 降序 排列。如果出现次数相等，则按艺术家名称 升序 排列。<br> 返回结果格式如下所示：<br> <img src="https://images2.imgbox.com/c5/88/EHpMH11E_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Spotify'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Spotify
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Spotify<span class="token punctuation">(</span>
 id         <span class="token keyword">int</span>
<span class="token punctuation">,</span> track_name   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> artist      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>  Spotify
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">303651</span>  <span class="token punctuation">,</span><span class="token string">'Heart Won''t Forget'</span> <span class="token punctuation">,</span><span class="token string">'Sia'</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1046089</span> <span class="token punctuation">,</span><span class="token string">'Shape of you'</span>       <span class="token punctuation">,</span><span class="token string">'Ed Sheeran'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">33445</span>   <span class="token punctuation">,</span><span class="token string">'I''m the one'</span>        <span class="token punctuation">,</span><span class="token string">'DJ Khalid'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">811266</span>  <span class="token punctuation">,</span><span class="token string">'Young Dumb &amp; Broke'</span> <span class="token punctuation">,</span><span class="token string">'DJ Khalid'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">505727</span>  <span class="token punctuation">,</span><span class="token string">'Happier'</span>            <span class="token punctuation">,</span><span class="token string">'Ed Sheeran'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> artist     <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>id <span class="token punctuation">)</span> <span class="token keyword">as</span> occurrences
<span class="token keyword">from</span> Spotify
<span class="token keyword">group</span> <span class="token keyword">by</span> artist
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span>id <span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">,</span>artist
</code></pre> 
<h3><a id="34__906"></a>34. 查询员工当前薪水</h3> 
<p><img src="https://images2.imgbox.com/ea/49/FUm4VU3B_o.png" alt="在这里插入图片描述"><br> 找出每个员工的当前薪水，假设薪水每年增加。输出他们的 emp_id 、firstname 、lastname 、salary 和 department_id 。<br> 按 emp_id 升序排序 返回结果表。<br> 返回结果格式如下所示。<br> <img src="https://images2.imgbox.com/1a/57/bfT10Ihe_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Salary'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Salary
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Salary<span class="token punctuation">(</span>
 emp_id         <span class="token keyword">int</span>
<span class="token punctuation">,</span> firstname     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> lastname      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> salary         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> department_id  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Salary
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Todd'</span>      <span class="token punctuation">,</span><span class="token string">'Wilson'</span>   <span class="token punctuation">,</span><span class="token number">110000</span> <span class="token punctuation">,</span><span class="token string">'D1006'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Todd'</span>      <span class="token punctuation">,</span><span class="token string">'Wilson'</span>   <span class="token punctuation">,</span><span class="token number">106119</span> <span class="token punctuation">,</span><span class="token string">'D1006'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Justin'</span>    <span class="token punctuation">,</span><span class="token string">'Simon'</span>    <span class="token punctuation">,</span><span class="token number">128922</span> <span class="token punctuation">,</span><span class="token string">'D1005'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Justin'</span>    <span class="token punctuation">,</span><span class="token string">'Simon'</span>    <span class="token punctuation">,</span><span class="token number">130000</span> <span class="token punctuation">,</span><span class="token string">'D1005'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Kelly'</span>     <span class="token punctuation">,</span><span class="token string">'Rosario'</span>  <span class="token punctuation">,</span><span class="token number">42689</span>  <span class="token punctuation">,</span><span class="token string">'D1002'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Patricia'</span>  <span class="token punctuation">,</span><span class="token string">'Powell'</span>   <span class="token punctuation">,</span><span class="token number">162825</span> <span class="token punctuation">,</span><span class="token string">'D1004'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Patricia'</span>  <span class="token punctuation">,</span><span class="token string">'Powell'</span>   <span class="token punctuation">,</span><span class="token number">170000</span> <span class="token punctuation">,</span><span class="token string">'D1004'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Sherry'</span>    <span class="token punctuation">,</span><span class="token string">'Golden'</span>   <span class="token punctuation">,</span><span class="token number">44101</span>  <span class="token punctuation">,</span><span class="token string">'D1002'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Natasha'</span>   <span class="token punctuation">,</span><span class="token string">'Swanson'</span>  <span class="token punctuation">,</span><span class="token number">79632</span>  <span class="token punctuation">,</span><span class="token string">'D1005'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Natasha'</span>   <span class="token punctuation">,</span><span class="token string">'Swanson'</span>  <span class="token punctuation">,</span><span class="token number">90000</span>  <span class="token punctuation">,</span><span class="token string">'D1005'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

<span class="token keyword">select</span>
emp_id <span class="token punctuation">,</span> firstname<span class="token punctuation">,</span> lastname <span class="token punctuation">,</span> salary <span class="token punctuation">,</span>department_id
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span>
        emp_id <span class="token punctuation">,</span> firstname<span class="token punctuation">,</span> lastname <span class="token punctuation">,</span> salary <span class="token punctuation">,</span>department_id
        <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> emp_id <span class="token keyword">order</span> <span class="token keyword">by</span> salary <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
        <span class="token keyword">from</span> Salary  <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> emp_id
</code></pre> 
<h3><a id="35__950"></a>35. 把名字和职业联系起来</h3> 
<p><img src="https://images2.imgbox.com/58/83/vGOiFNLS_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案报告每个人的名字，后面是他们职业的第一个字母，用括号括起来。<br> 返回按 person_id 降序排列 的结果表。<br> 返回结果格式示例如下。<br> <img src="https://images2.imgbox.com/1d/53/eUsLulBZ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Person'</span> <span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Person
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Person <span class="token punctuation">(</span>
 person_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> profession  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Person
<span class="token keyword">values</span>
 <span class="token punctuation">(</span>  <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'Alex'</span>  <span class="token punctuation">,</span><span class="token string">'Singer'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'Alice'</span> <span class="token punctuation">,</span><span class="token string">'Actor'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'Bob'</span>   <span class="token punctuation">,</span><span class="token string">'Player'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'Messi'</span> <span class="token punctuation">,</span><span class="token string">'Doctor'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">6</span>  <span class="token punctuation">,</span><span class="token string">'Tyson'</span> <span class="token punctuation">,</span><span class="token string">'Engineer'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token string">'Meir'</span>  <span class="token punctuation">,</span><span class="token string">'Lawyer'</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> person_id
     <span class="token punctuation">,</span> name <span class="token operator">+</span> <span class="token string">'('</span> <span class="token operator">+</span> <span class="token keyword">left</span><span class="token punctuation">(</span>profession <span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">')'</span> <span class="token keyword">as</span> name
<span class="token keyword">from</span> Person
<span class="token keyword">order</span> <span class="token keyword">by</span> person_id  <span class="token keyword">desc</span>
</code></pre> 
<h3><a id="36__983"></a>36. 形成化学键</h3> 
<p><img src="https://images2.imgbox.com/24/af/m4JQN2Wa_o.png" alt="在这里插入图片描述"><br> 如果一个元素是 ‘Metal’，另外一个元素是 ‘Nonmetal’ ，那么它们可以形成键。<br> 编写一个解决方案找出所有可以形成键的元素对。<br> 以 任意顺序 返回结果表。<br> 查询结果格式如下所示。<br> <img src="https://images2.imgbox.com/8f/2d/xfROVhMh_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Elements'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Elements
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Elements<span class="token punctuation">(</span>
   symbol     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token keyword">type</span>       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> electrons   <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Elements
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token string">'He'</span>  <span class="token punctuation">,</span><span class="token string">'Noble'</span>    <span class="token punctuation">,</span><span class="token number">0</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Na'</span>  <span class="token punctuation">,</span><span class="token string">'Metal'</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Ca'</span>  <span class="token punctuation">,</span><span class="token string">'Metal'</span>    <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'La'</span>  <span class="token punctuation">,</span><span class="token string">'Metal'</span>    <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Cl'</span>  <span class="token punctuation">,</span><span class="token string">'Nonmetal'</span> <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'O'</span>   <span class="token punctuation">,</span><span class="token string">'Nonmetal'</span> <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'N'</span>   <span class="token punctuation">,</span><span class="token string">'Nonmetal'</span> <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span>  a<span class="token punctuation">.</span>symbol <span class="token keyword">as</span> metal<span class="token punctuation">,</span>b<span class="token punctuation">.</span>symbol <span class="token keyword">as</span> nonmetal
<span class="token keyword">from</span> Elements  a
<span class="token keyword">cross</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> symbol  <span class="token keyword">from</span> Elements
    <span class="token keyword">where</span> <span class="token keyword">type</span>     <span class="token operator">=</span> <span class="token string">'Nonmetal'</span>
    <span class="token punctuation">)</span> b
<span class="token keyword">where</span> a<span class="token punctuation">.</span><span class="token keyword">type</span>     <span class="token operator">=</span> <span class="token string">'Metal'</span>

</code></pre> 
<h3><a id="37__1022"></a>37. 整理奥运表</h3> 
<p><img src="https://images2.imgbox.com/cc/2e/W9gUG5Ba_o.png" alt="在这里插入图片描述"><br> 奥运名次表的排序规则如下:</p> 
<ul><li>金牌越多的国家排名第一。</li><li>如果金牌数持平，银牌多的国家排名第一。</li><li>如果银牌数量持平，铜牌数量最多的国家排名第一。</li><li>如果铜牌中出现并列，那么并列的国家将按照字典的升序进行排序。<br> 写一个解决方案对奥运表进行排序</li></ul> 
<p>返回结果格式示例如下。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Olympic'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Olympic
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Olympic <span class="token punctuation">(</span>
  country      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> gold_medals  <span class="token keyword">int</span>
<span class="token punctuation">,</span> silver_medals <span class="token keyword">int</span>
<span class="token punctuation">,</span> bronze_medals  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Olympic
<span class="token keyword">values</span>
  <span class="token punctuation">(</span> <span class="token string">'China'</span>       <span class="token punctuation">,</span> <span class="token number">10</span>   <span class="token punctuation">,</span> <span class="token number">10</span>   <span class="token punctuation">,</span><span class="token number">20</span>  <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'South Sudan'</span> <span class="token punctuation">,</span> <span class="token number">0</span>    <span class="token punctuation">,</span> <span class="token number">0</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'USA'</span>         <span class="token punctuation">,</span> <span class="token number">10</span>   <span class="token punctuation">,</span> <span class="token number">10</span>   <span class="token punctuation">,</span><span class="token number">20</span>  <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Israel'</span>      <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Egypt'</span>       <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
 go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> country   <span class="token punctuation">,</span>gold_medals   <span class="token punctuation">,</span> silver_medals  <span class="token punctuation">,</span> bronze_medals
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> gold_medals <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> gold_rank
<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> silver_medals <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> silver_rank
<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> bronze_medals <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> bronze_rank
<span class="token keyword">from</span> Olympic <span class="token punctuation">)</span> a
<span class="token keyword">order</span> <span class="token keyword">by</span> gold_rank <span class="token punctuation">,</span>silver_rank <span class="token punctuation">,</span>bronze_rank <span class="token punctuation">,</span>country

</code></pre> 
<h3><a id="38__1070"></a>38. 每位教师所教授的科目种类的数量</h3> 
<p><img src="https://images2.imgbox.com/22/35/YX0DR7tC_o.png" alt="在这里插入图片描述"><br> 查询每位老师在大学里教授的科目种类的数量。<br> 以 任意顺序 返回结果表。<br> 查询结果格式示例如下。<br> <img src="https://images2.imgbox.com/c0/d6/UimPhJJW_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Teacher'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Teacher
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Teacher<span class="token punctuation">(</span>
 teacher_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> subject_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> dept_id     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Teacher
<span class="token keyword">values</span>
 <span class="token punctuation">(</span>  <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> teacher_id <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> subject_id <span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> Teacher
<span class="token keyword">group</span> <span class="token keyword">by</span> teacher_id

</code></pre> 
<h3><a id="39__1104"></a>39. 联赛的所有比赛</h3> 
<p><img src="https://images2.imgbox.com/ce/0e/zmKNQmH2_o.png" alt="在这里插入图片描述"><br> 编写解决方案，获取联赛中所有比赛。每两支球队进行两场比赛，其中一支球队是主队 home_team ，另一支是客场队 away_team。<br> 按 任意顺序 返回结果表。<br> 返回结果格式如下例所示。</p> 
<p><img src="https://images2.imgbox.com/e5/c6/I6md4StO_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Teams'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Teams
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Teams<span class="token punctuation">(</span>
 team_name    <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Teams
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token string">'Leetcode FC'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Ahly SC'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Real Madrid'</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>team_name <span class="token keyword">as</span> home_team      <span class="token punctuation">,</span>b<span class="token punctuation">.</span>team_name <span class="token keyword">as</span> away_team
<span class="token keyword">from</span> Teams a
<span class="token keyword">cross</span> <span class="token keyword">join</span> Teams b
<span class="token keyword">where</span> a<span class="token punctuation">.</span>team_name   <span class="token operator">&lt;&gt;</span> b<span class="token punctuation">.</span>team_name
</code></pre> 
<h3><a id="39___1135"></a>39. 产品销售分析 ⑤</h3> 
<p><img src="https://images2.imgbox.com/c1/bc/726S2I5R_o.png" alt="在这里插入图片描述"><br> 编写解决方案，获取每个用户的消费额。<br> 按用户消费额 spending 递减的顺序返回结果。在消费额相等的情况下，以 user_id 递增的顺序将其排序。<br> 结果的格式如下面例子所示：<br> <img src="https://images2.imgbox.com/30/1c/XTYN4mkD_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql">在这里插入代码片
</code></pre> 
<h2><a id="_1151"></a>难度：中等</h2> 
<h3><a id="1_1152"></a>1.股票的资本损益</h3> 
<p>Stocks 表：<br> <img src="https://images2.imgbox.com/9d/35/uiHy1vmo_o.png" alt="在这里插入图片描述"><br> 编写一个SQL查询来报告每支股票的资本损益。</p> 
<p>股票的资本损益是一次或多次买卖股票后的全部收益或损失。</p> 
<p>以任意顺序返回结果即可。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> stock_name<span class="token punctuation">,</span>
        <span class="token function">SUM</span><span class="token punctuation">(</span>
            <span class="token keyword">CASE</span> operation <span class="token keyword">WHEN</span> <span class="token string">'sell'</span>  
            <span class="token keyword">THEN</span> price <span class="token keyword">ELSE</span> <span class="token operator">-</span>price  
            <span class="token keyword">END</span>                  
           <span class="token punctuation">)</span> <span class="token keyword">AS</span> capital_gain_loss     
<span class="token keyword">FROM</span> Stocks
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> stock_name

</code></pre> 
<h3><a id="2__1172"></a>2. 当选者</h3> 
<p>编写一个SQL查询来报告获胜候选人的名字(即获得最多选票的候选人)。</p> 
<p>生成测试用例以确保 只有一个候选人赢得选举。</p> 
<p>查询结果格式如下所示。<br> <img src="https://images2.imgbox.com/ad/8b/S5U3z2FY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/79/fe/2lIVFXnd_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--MS SQL Server</span>
<span class="token keyword">select</span> name
<span class="token keyword">from</span> Candidate
<span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> candidateId
    <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">1</span>  candidateId<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
               <span class="token keyword">from</span> vote
               <span class="token keyword">group</span> <span class="token keyword">by</span> candidateId
               <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">)</span>a
  <span class="token punctuation">)</span>

<span class="token comment">--MySQL</span>
<span class="token keyword">select</span> Name <span class="token keyword">from</span> Candidate 
<span class="token keyword">where</span> id <span class="token operator">=</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> CandidateId <span class="token keyword">from</span> Vote 
<span class="token keyword">group</span> <span class="token keyword">by</span> CandidateId
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span>CandidateId<span class="token punctuation">)</span> <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="3__1201"></a>3. 页面推荐</h3> 
<p><img src="https://images2.imgbox.com/28/9a/gEMIpqB1_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ec/55/qTU6D3MY_o.png" alt="在这里插入图片描述"><br> 写一段 SQL 向user_id = 1 的用户，推荐其朋友们喜欢的页面。不要推荐该用户已经喜欢的页面。<br> 你返回的结果中不应当包含重复项。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> page_id <span class="token keyword">as</span> recommended_page 
<span class="token keyword">from</span> Likes 
<span class="token keyword">where</span> user_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> user2_id 
                    <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> user1_id <span class="token punctuation">,</span> user2_id <span class="token keyword">from</span> friendship
                          <span class="token keyword">union</span> 
                          <span class="token keyword">select</span>  user2_id <span class="token punctuation">,</span>user1_id  <span class="token keyword">from</span> friendship<span class="token punctuation">)</span> a 
                    <span class="token keyword">where</span> user1_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token operator">and</span> page_id <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> page_id <span class="token keyword">from</span> Likes <span class="token keyword">where</span> user_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
</code></pre> 
<h3><a id="4_2016_1219"></a>4. 2016年的投资</h3> 
<p>写一个查询语句，将 2016 年 (TIV_2016) 所有成功投资的金额加起来，保留 2 位小数。<br> 对于一个投保人，他在 2016 年成功投资的条件是：<br> 他在 2015 年的投保额 (TIV_2015) 至少跟一个其他投保人在 2015 年的投保额相同。<br> 他所在的城市必须与其他投保人都不同（也就是说维度和经度不能跟其他任何一个投保人完全相同）。</p> 
<pre><code class="prism language-sql"><span class="token keyword">IF</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">'insurance'</span><span class="token punctuation">,</span><span class="token string">'U'</span><span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span>  insurance
GO

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> insurance<span class="token punctuation">(</span>
 PID         <span class="token keyword">INT</span>
<span class="token punctuation">,</span>TIV_2015    <span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>TIV_2016    <span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>LAT         <span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>LON         <span class="token keyword">NUMERIC</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
GO

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> insurance
<span class="token keyword">VALUES</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">224.17</span>   <span class="token punctuation">,</span> <span class="token number">952.73</span>   <span class="token punctuation">,</span> <span class="token number">32.4</span> <span class="token punctuation">,</span> <span class="token number">20.2</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">224.17</span>   <span class="token punctuation">,</span> <span class="token number">900.66</span>   <span class="token punctuation">,</span> <span class="token number">52.4</span> <span class="token punctuation">,</span> <span class="token number">32.7</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">824.61</span>   <span class="token punctuation">,</span> <span class="token number">645.13</span>   <span class="token punctuation">,</span> <span class="token number">72.4</span> <span class="token punctuation">,</span> <span class="token number">45.2</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span> <span class="token number">424.32</span>   <span class="token punctuation">,</span> <span class="token number">323.66</span>   <span class="token punctuation">,</span> <span class="token number">12.4</span> <span class="token punctuation">,</span> <span class="token number">7.7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span> <span class="token number">424.32</span>   <span class="token punctuation">,</span> <span class="token number">282.9</span>    <span class="token punctuation">,</span> <span class="token number">12.4</span> <span class="token punctuation">,</span> <span class="token number">7.7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>   <span class="token punctuation">,</span> <span class="token number">625.05</span>   <span class="token punctuation">,</span> <span class="token number">243.53</span>   <span class="token punctuation">,</span> <span class="token number">52.5</span> <span class="token punctuation">,</span> <span class="token number">32.8</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>   <span class="token punctuation">,</span> <span class="token number">424.32</span>   <span class="token punctuation">,</span> <span class="token number">968.94</span>   <span class="token punctuation">,</span> <span class="token number">72.5</span> <span class="token punctuation">,</span> <span class="token number">45.3</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>   <span class="token punctuation">,</span> <span class="token number">624.46</span>   <span class="token punctuation">,</span> <span class="token number">714.13</span>   <span class="token punctuation">,</span> <span class="token number">12.5</span> <span class="token punctuation">,</span> <span class="token number">7.8</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>   <span class="token punctuation">,</span> <span class="token number">425.49</span>   <span class="token punctuation">,</span> <span class="token number">463.85</span>   <span class="token punctuation">,</span> <span class="token number">32.5</span> <span class="token punctuation">,</span> <span class="token number">20.3</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">10</span>  <span class="token punctuation">,</span> <span class="token number">624.46</span>   <span class="token punctuation">,</span> <span class="token number">776.85</span>   <span class="token punctuation">,</span> <span class="token number">12.4</span> <span class="token punctuation">,</span> <span class="token number">7.7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">11</span>  <span class="token punctuation">,</span> <span class="token number">624.46</span>   <span class="token punctuation">,</span> <span class="token number">692.71</span>   <span class="token punctuation">,</span> <span class="token number">72.5</span> <span class="token punctuation">,</span> <span class="token number">45.3</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">12</span>  <span class="token punctuation">,</span> <span class="token number">225.93</span>   <span class="token punctuation">,</span> <span class="token number">933</span>      <span class="token punctuation">,</span> <span class="token number">12.5</span> <span class="token punctuation">,</span> <span class="token number">7.8</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">13</span>  <span class="token punctuation">,</span> <span class="token number">824.61</span>   <span class="token punctuation">,</span> <span class="token number">786.86</span>   <span class="token punctuation">,</span> <span class="token number">32.6</span> <span class="token punctuation">,</span> <span class="token number">20.3</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">14</span>  <span class="token punctuation">,</span> <span class="token number">824.61</span>   <span class="token punctuation">,</span> <span class="token number">935.34</span>   <span class="token punctuation">,</span> <span class="token number">52.6</span> <span class="token punctuation">,</span> <span class="token number">32.8</span> <span class="token punctuation">)</span>


<span class="token keyword">select</span> cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>TIV_2016<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  TIV_2016
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> TIV_2015 <span class="token punctuation">)</span> <span class="token keyword">as</span> cnt1
      <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> PID<span class="token punctuation">,</span>TIV_2015<span class="token punctuation">,</span>TIV_2016<span class="token punctuation">,</span>LAT<span class="token punctuation">,</span>LON <span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> LAT<span class="token punctuation">,</span>LON<span class="token punctuation">)</span> <span class="token keyword">AS</span> CNT
            <span class="token keyword">FROM</span> insurance
            <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> PID<span class="token punctuation">,</span>TIV_2015<span class="token punctuation">,</span>TIV_2016<span class="token punctuation">,</span>LAT<span class="token punctuation">,</span>LON<span class="token punctuation">)</span> A
        <span class="token keyword">WHERE</span> CNT <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> PID<span class="token punctuation">,</span>TIV_2015<span class="token punctuation">,</span>TIV_2016<span class="token punctuation">,</span>LAT<span class="token punctuation">,</span>LON<span class="token punctuation">,</span>cnt <span class="token punctuation">)</span> a
<span class="token keyword">where</span> cnt1 <span class="token operator">&gt;=</span> <span class="token number">2</span>
</code></pre> 
<h3><a id="5__1265"></a>5. 买下所有产品的人</h3> 
<p>写一条 SQL 查询语句，从 Customer 表中查询购买了 Product 表中所有产品的客户的 id。</p> 
<pre><code class="prism language-sql"><span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Customer'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Customer
go
<span class="token keyword">create</span>  <span class="token keyword">table</span> Customer<span class="token punctuation">(</span>
customer_id  <span class="token keyword">int</span>    <span class="token punctuation">,</span>
product_key  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>   Customer
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span>      <span class="token number">5</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span>      <span class="token number">6</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span>      <span class="token number">5</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span>      <span class="token number">6</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span>      <span class="token number">6</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'Product'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Product
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Product<span class="token punctuation">(</span>
   product_key  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Product
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
go

<span class="token keyword">select</span> a<span class="token punctuation">.</span>customer_id
<span class="token keyword">from</span> Customer a
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>customer_id
<span class="token keyword">having</span>  <span class="token function">count</span><span class="token punctuation">(</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>product_key <span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> Product<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="6__1300"></a>6. 电影评分</h3> 
<p>请你编写一组 SQL 查询：<br> 查找评论电影数量最多的用户名。如果出现平局，返回字典序较小的用户名。<br> 查找在 February 2020 平均评分最高 的电影名称。如果出现平局，返回字典序较小的电影名称。<br> 字典序 ，即按字母在字典中出现顺序对字符串排序，字典序较小则意味着排序靠前。</p> 
<pre><code class="prism language-sql">
<span class="token keyword">select</span> name <span class="token keyword">as</span> results       <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>b<span class="token punctuation">.</span>name<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk1
<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>name <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> MovieRating a
<span class="token keyword">left</span> <span class="token keyword">join</span> Users b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span>b<span class="token punctuation">.</span>name <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk1 <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> title <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span>  b<span class="token punctuation">.</span>title <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>rating<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Score
<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk1
<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>title <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> MovieRating a
<span class="token keyword">left</span> <span class="token keyword">join</span> Movies  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>movie_id <span class="token operator">=</span> b<span class="token punctuation">.</span>movie_id
<span class="token keyword">where</span> <span class="token keyword">left</span><span class="token punctuation">(</span>created_at<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'2020-02'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>title <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk1 <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> rnk <span class="token operator">=</span> <span class="token number">1</span>

</code></pre> 
<h3><a id="6__1330"></a>6. 确认率</h3> 
<p>用户的 确认率 是 ‘confirmed’ 消息的数量除以请求的确认消息的总数。没有请求任何确认消息的用户的确认率为 0 。确认率四舍五入到 小数点后两位 。<br> 编写一个SQL查询来查找每个用户的 确认率 。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Signups'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Signups
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Signups <span class="token punctuation">(</span>
  user_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span> time_stamp     <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Signups
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2020-03-21 10:16:13'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span>    <span class="token punctuation">,</span><span class="token string">'2020-01-04 13:57:59'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2020-07-29 23:09:44'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'2020-12-09 10:39:37'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'Confirmations'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Confirmations
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Confirmations<span class="token punctuation">(</span>
  user_id         <span class="token keyword">int</span>
<span class="token punctuation">,</span> time_stamp     <span class="token keyword">datetime</span>
<span class="token punctuation">,</span> <span class="token keyword">action</span>          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Confirmations
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token string">'2021-01-06 03:30:46'</span><span class="token punctuation">,</span> <span class="token string">'timeout'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token string">'2021-07-14 14:00:00'</span><span class="token punctuation">,</span> <span class="token string">'timeout'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span> <span class="token string">'2021-06-12 11:57:29'</span><span class="token punctuation">,</span> <span class="token string">'confirmed'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span> <span class="token string">'2021-06-13 12:58:28'</span><span class="token punctuation">,</span> <span class="token string">'confirmed'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span> <span class="token string">'2021-06-14 13:59:27'</span><span class="token punctuation">,</span> <span class="token string">'confirmed'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token string">'2021-01-22 00:00:00'</span><span class="token punctuation">,</span> <span class="token string">'confirmed'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token string">'2021-02-28 23:59:59'</span><span class="token punctuation">,</span> <span class="token string">'timeout'</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--Output</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>user_id
<span class="token punctuation">,</span> cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> b<span class="token punctuation">.</span><span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'confirmed'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> confirmation_rate
<span class="token keyword">from</span> Signups a
<span class="token keyword">left</span> <span class="token keyword">join</span> Confirmations b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id
</code></pre> 
<h3><a id="7__1377"></a>7. 按分类统计薪水</h3> 
<p>写出一个 SQL 查询，来报告每个工资类别的银行账户数量。 工资类别如下：<br> “Low Salary”：所有工资 严格低于 20000 美元。<br> “Average Salary”： 包含 范围内的所有工资 [$20000, $50000] 。<br> “High Salary”：所有工资 严格大于 50000 美元。<br> 结果表 必须 包含所有三个类别。 如果某个类别中没有帐户，则报告 0 。<br> 按 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql">
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Accounts'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Accounts
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Accounts <span class="token punctuation">(</span>
 account_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>income    <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span>  <span class="token keyword">into</span>  Accounts
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">3</span>        <span class="token punctuation">,</span> <span class="token number">108939</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>        <span class="token punctuation">,</span> <span class="token number">12747</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>        <span class="token punctuation">,</span> <span class="token number">87709</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span>        <span class="token punctuation">,</span> <span class="token number">91796</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> Accounts


<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token string">'Low Salary'</span> <span class="token keyword">as</span> Category
<span class="token keyword">union</span>
<span class="token keyword">select</span> <span class="token string">'Average Salary'</span>
<span class="token keyword">union</span>
<span class="token keyword">select</span> <span class="token string">'High Salary'</span>
<span class="token punctuation">)</span>

<span class="token keyword">select</span> a<span class="token punctuation">.</span>Category <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>Category<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> accounts_count
<span class="token keyword">from</span> t a
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> income <span class="token operator">&lt;</span> <span class="token number">20000</span> <span class="token keyword">then</span><span class="token string">'Low Salary'</span>
            <span class="token keyword">when</span> income <span class="token operator">between</span>  <span class="token number">20000</span> <span class="token operator">and</span> <span class="token number">50000</span> <span class="token keyword">then</span> <span class="token string">'Average Salary'</span>
            <span class="token keyword">else</span> <span class="token string">'High Salary'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> Category
            <span class="token keyword">from</span> Accounts<span class="token punctuation">)</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>category <span class="token operator">=</span> b<span class="token punctuation">.</span>category
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>category
</code></pre> 
<h3><a id="8__1421"></a>8. 餐馆营业额的变化增长</h3> 
<p>你是餐馆的老板，现在你想分析一下可能的营业额变化增长（每天至少有一位顾客）。<br> 写一条 SQL 查询计算以 7 天（某日期 + 该日期前的 6 天）为一个时间段的顾客消费平均值。average_amount 要 保留两位小数。<br> 查询结果按 visited_on 排序。</p> 
<pre><code class="prism language-sql">
<span class="token keyword">SELECT</span> visited_on<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>average_amount
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> visited_on<span class="token punctuation">,</span>
           <span class="token function">SUM</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> visited_on <span class="token keyword">ROWS</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> amount<span class="token punctuation">,</span>
           <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token function">AVG</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> visited_on <span class="token keyword">ROWS</span> <span class="token number">6</span> <span class="token keyword">PRECEDING</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> average_amount
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> visited_on<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">AS</span> amount
        <span class="token keyword">FROM</span> Customer
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> visited_on
    <span class="token punctuation">)</span> TABLE_1
<span class="token punctuation">)</span> TABLE_2
<span class="token keyword">WHERE</span> DATEDIFF<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MIN</span><span class="token punctuation">(</span>visited_on<span class="token punctuation">)</span> <span class="token keyword">FROM</span> Customer<span class="token punctuation">)</span> <span class="token punctuation">,</span> visited_on<span class="token punctuation">)</span> <span class="token operator">&gt;=</span><span class="token number">6</span>
</code></pre> 
<pre><code class="prism language-sql">
<span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">1</span> person_name
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
<span class="token function">SUM</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> turn <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token keyword">UNBOUNDED</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> curr_weight
<span class="token keyword">FROM</span> Queue<span class="token punctuation">)</span> t
<span class="token keyword">WHERE</span> curr_weight <span class="token operator">&lt;=</span> <span class="token number">1000</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> curr_weight <span class="token keyword">DESC</span>
</code></pre> 
<h3><a id="8___1452"></a>8. 即时食物配送 ①</h3> 
<p>如果顾客期望的配送日期和下单日期相同，则该订单称为 「即时订单」，否则称为「计划订单」。<br> 「首次订单」是顾客最早创建的订单。我们保证一个顾客只会有一个「首次订单」。<br> 写一条 SQL 查询语句获取即时订单在所有用户的首次订单中的比例。保留两位小数。</p> 
<pre><code class="prism language-sql"><span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'Delivery'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Delivery
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Delivery <span class="token punctuation">(</span>
 delivery_id                  <span class="token keyword">int</span>
<span class="token punctuation">,</span>customer_id                  <span class="token keyword">int</span>
<span class="token punctuation">,</span> order_date                   <span class="token keyword">date</span>
<span class="token punctuation">,</span>customer_pref_delivery_date  <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Delivery
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token string">'2019-08-01'</span> <span class="token punctuation">,</span><span class="token string">'2019-08-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token string">'2019-08-02'</span> <span class="token punctuation">,</span><span class="token string">'2019-08-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>      <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token string">'2019-08-11'</span> <span class="token punctuation">,</span><span class="token string">'2019-08-12'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>      <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token string">'2019-08-24'</span> <span class="token punctuation">,</span><span class="token string">'2019-08-24'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>      <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token string">'2019-08-21'</span> <span class="token punctuation">,</span><span class="token string">'2019-08-22'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>      <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token string">'2019-08-11'</span> <span class="token punctuation">,</span><span class="token string">'2019-08-13'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>      <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span> <span class="token string">'2019-08-09'</span> <span class="token punctuation">,</span><span class="token string">'2019-08-09'</span><span class="token punctuation">)</span>
go

<span class="token keyword">select</span> cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> order_date <span class="token operator">=</span> customer_pref_delivery_date <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span>
   <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">as</span> immediate_percentage
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">Partition</span> <span class="token keyword">by</span> customer_id  <span class="token keyword">order</span> <span class="token keyword">by</span> order_date <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
    <span class="token keyword">from</span>  Delivery<span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>

</code></pre> 
<h3><a id="9_5_1488"></a>9. 至少有5名直系下属的经理</h3> 
<p>编写一个SQL查询，查询至少有5名直接下属的经理 。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employee'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employee
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employee <span class="token punctuation">(</span>
    id           <span class="token keyword">int</span>
<span class="token punctuation">,</span> name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> department   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> managerId    <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employee
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">101</span> <span class="token punctuation">,</span><span class="token string">'John'</span>  <span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token boolean">null</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">102</span> <span class="token punctuation">,</span><span class="token string">'Dan'</span>   <span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token string">'101'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">103</span> <span class="token punctuation">,</span><span class="token string">'James'</span> <span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token string">'101'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">104</span> <span class="token punctuation">,</span><span class="token string">'Amy'</span>   <span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token string">'101'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">105</span> <span class="token punctuation">,</span><span class="token string">'Anne'</span>  <span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">,</span>    <span class="token string">'101'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">106</span> <span class="token punctuation">,</span><span class="token string">'Ron'</span>   <span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">,</span>    <span class="token string">'101'</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--方法一</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> name <span class="token keyword">from</span> Employee
<span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> managerid
<span class="token keyword">from</span> Employee
<span class="token keyword">group</span> <span class="token keyword">by</span> managerid
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> id <span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment">--方法二</span>
<span class="token keyword">SELECT</span>
    Name
<span class="token keyword">FROM</span>
    Employee <span class="token keyword">AS</span> t1 <span class="token keyword">JOIN</span>
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span>
        ManagerId
    <span class="token keyword">FROM</span>
        Employee
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> ManagerId
    <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>ManagerId<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> t2
    <span class="token keyword">ON</span> t1<span class="token punctuation">.</span>Id <span class="token operator">=</span> t2<span class="token punctuation">.</span>ManagerId
</code></pre> 
<h3><a id="10__1533"></a>10. 游戏玩法分析</h3> 
<p>编写一个 SQL 查询，报告在首次登录的第二天再次登录的玩家的比率，四舍五入到小数点后两位。换句话说，您需要计算从首次登录日期开始至少连续两天登录的玩家的数量，然后除以玩家总数。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Activity'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Activity
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Activity <span class="token punctuation">(</span>
  player_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> device_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> event_date    <span class="token keyword">date</span>
<span class="token punctuation">,</span> games_played  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Activity
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2016-03-01'</span><span class="token punctuation">,</span><span class="token number">5</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2016-03-02'</span><span class="token punctuation">,</span><span class="token number">6</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'2017-06-25'</span><span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2016-03-02'</span><span class="token punctuation">,</span><span class="token number">0</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'2018-07-03'</span><span class="token punctuation">,</span><span class="token number">5</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> player_id id<span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>event_date<span class="token punctuation">)</span> mn
            <span class="token keyword">from</span> activity
            <span class="token keyword">group</span> <span class="token keyword">by</span> player_id<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">convert</span><span class="token punctuation">(</span><span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token keyword">convert</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">from</span> t b
    <span class="token keyword">inner</span> <span class="token keyword">join</span> activity a
    <span class="token keyword">on</span> b<span class="token punctuation">.</span>id<span class="token operator">=</span>a<span class="token punctuation">.</span>player_id <span class="token operator">and</span> datediff<span class="token punctuation">(</span>d<span class="token punctuation">,</span>b<span class="token punctuation">.</span>mn<span class="token punctuation">,</span>a<span class="token punctuation">.</span>event_date<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">from</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span> fraction


</code></pre> 
<h3><a id="11__1571"></a>11. 好友申请：谁有最多的好友</h3> 
<p>在 Facebook 或者 Twitter 这样的社交应用中，人们经常会发好友申请也会收到其他人的好友申请。<br> 写一个查询语句，找出拥有最多的好友的人和他拥有的好友数目。<br> 生成的测试用例保证拥有最多好友数目的只有 1 个人。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'RequestAccepted'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> RequestAccepted
go
<span class="token keyword">create</span> <span class="token keyword">table</span> RequestAccepted<span class="token punctuation">(</span>
  requester_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> accepter_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> accept_date     <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> RequestAccepted
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'2016/06/03'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'2016/06/08'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'2016/06/08'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'2016/06/09'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">1</span> requester_id <span class="token keyword">as</span> id <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> num
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> requester_id<span class="token punctuation">,</span>accepter_id
<span class="token keyword">from</span> RequestAccepted
<span class="token keyword">union</span>
<span class="token keyword">select</span> accepter_id<span class="token punctuation">,</span>requester_id
<span class="token keyword">from</span> RequestAccepted <span class="token punctuation">)</span>a
<span class="token keyword">group</span> <span class="token keyword">by</span> requester_id
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">desc</span>
</code></pre> 
<h3><a id="12__1605"></a>12. 指定日期的产品价格</h3> 
<p>写一段 SQL来查找在 2019-08-16 时全部产品的价格，假设所有产品在修改前的价格都是 10 。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Products
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Products<span class="token punctuation">(</span>
  product_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> new_price     <span class="token keyword">int</span>
<span class="token punctuation">,</span> change_date    <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Products
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">20</span>  <span class="token punctuation">,</span><span class="token string">'2019-08-14'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">50</span>  <span class="token punctuation">,</span><span class="token string">'2019-08-14'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">30</span>  <span class="token punctuation">,</span><span class="token string">'2019-08-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">35</span>  <span class="token punctuation">,</span><span class="token string">'2019-08-16'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">65</span>  <span class="token punctuation">,</span><span class="token string">'2019-08-17'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">20</span>  <span class="token punctuation">,</span><span class="token string">'2019-08-18'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> product_id <span class="token keyword">order</span> <span class="token keyword">by</span> change_date <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
    <span class="token keyword">from</span> Products
    <span class="token keyword">where</span> change_date <span class="token operator">&lt;=</span> <span class="token string">'2019-08-16'</span><span class="token punctuation">)</span> a
    <span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>Product_id <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>b<span class="token punctuation">.</span>new_price<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Price
<span class="token keyword">from</span> Products a
<span class="token keyword">left</span> <span class="token keyword">join</span> T B
<span class="token keyword">ON</span> a<span class="token punctuation">.</span>product_id <span class="token operator">=</span> b<span class="token punctuation">.</span>product_id

</code></pre> 
<h3><a id="13__1642"></a>13. 每月交易</h3> 
<p>编写一个 sql 查询来查找每个月和每个国家/地区的事务数及其总金额、已批准的事务数及其总金额。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Transactions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span><span class="token punctuation">(</span>
 id            <span class="token keyword">int</span>
<span class="token punctuation">,</span>country       <span class="token keyword">varchar</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>state         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>amount        <span class="token keyword">int</span>
<span class="token punctuation">,</span>trans_date    <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">Transactions</span>
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">121</span>  <span class="token punctuation">,</span><span class="token string">'US'</span><span class="token punctuation">,</span><span class="token string">'approved'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span><span class="token string">'2018-12-18'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">122</span>  <span class="token punctuation">,</span><span class="token string">'US'</span><span class="token punctuation">,</span><span class="token string">'declined'</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span><span class="token string">'2018-12-19'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">123</span>  <span class="token punctuation">,</span><span class="token string">'US'</span><span class="token punctuation">,</span><span class="token string">'approved'</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span><span class="token string">'2019-01-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">124</span>  <span class="token punctuation">,</span><span class="token string">'DE'</span><span class="token punctuation">,</span><span class="token string">'approved'</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span><span class="token string">'2019-01-07'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">SELECT</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>trans_date <span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">month</span>   <span class="token punctuation">,</span> country
     <span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> trans_count
<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> STATE <span class="token operator">=</span> <span class="token string">'approved'</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token punctuation">)</span><span class="token keyword">AS</span> approved_count
<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>AMOUNT<span class="token punctuation">)</span> <span class="token keyword">AS</span> trans_total_amount
<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> STATE <span class="token operator">=</span> <span class="token string">'approved'</span> <span class="token keyword">THEN</span> AMOUNT <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token punctuation">)</span> <span class="token keyword">AS</span> approved_total_amount
<span class="token keyword">FROM</span> <span class="token keyword">Transactions</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>trans_date <span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> country
</code></pre> 
<h3><a id="14_1676"></a>14.市场分析</h3> 
<p>请写出一条SQL语句以查询每个用户的注册日期和在 2019 年作为买家的订单总数。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Users
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Users<span class="token punctuation">(</span>
 user_id         <span class="token keyword">int</span>
<span class="token punctuation">,</span>join_date       <span class="token keyword">date</span>
<span class="token punctuation">,</span>favorite_brand  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Users
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2018-01-01'</span><span class="token punctuation">,</span> <span class="token string">'Lenovo'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'2018-02-09'</span><span class="token punctuation">,</span> <span class="token string">'Samsung'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'2018-01-19'</span><span class="token punctuation">,</span> <span class="token string">'LG'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'2018-05-21'</span><span class="token punctuation">,</span> <span class="token string">'HP'</span>      <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders<span class="token punctuation">(</span>
 order_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>order_date  <span class="token keyword">date</span>
<span class="token punctuation">,</span>item_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>buyer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>seller_id   <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span>  <span class="token keyword">into</span>   Orders
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-01'</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2018-08-02'</span><span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-03'</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'2018-08-04'</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token number">4</span> <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2018-08-04'</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token number">3</span> <span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-05'</span><span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Items'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Items
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Items<span class="token punctuation">(</span>
    item_id      <span class="token keyword">int</span>
 <span class="token punctuation">,</span>item_brand     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Items
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'Samsung'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'Lenovo'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token punctuation">,</span><span class="token string">'LG'</span>        <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token punctuation">,</span><span class="token string">'HP'</span>        <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--方法一</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>user_id <span class="token keyword">as</span> buyer_id  <span class="token punctuation">,</span>a<span class="token punctuation">.</span>join_date<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>b<span class="token punctuation">.</span>num<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> orders_in_2019
<span class="token keyword">from</span> Users a
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> buyer_id <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">left</span><span class="token punctuation">(</span>order_date<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2019</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span>  <span class="token punctuation">)</span> <span class="token keyword">as</span> num
    <span class="token keyword">from</span> Orders
    <span class="token keyword">group</span> <span class="token keyword">by</span> buyer_id<span class="token punctuation">)</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>buyer_id
<span class="token comment">--方法二</span>
<span class="token keyword">SELECT</span> Users<span class="token punctuation">.</span>user_id <span class="token keyword">AS</span> buyer_id<span class="token punctuation">,</span> join_date<span class="token punctuation">,</span>
 <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>Orders<span class="token punctuation">.</span>order_date<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2019</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> orders_in_2019
<span class="token keyword">FROM</span> Users
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> Orders 
<span class="token keyword">ON</span> Users<span class="token punctuation">.</span>user_id <span class="token operator">=</span> Orders<span class="token punctuation">.</span>buyer_id
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Users<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>join_date
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> Users<span class="token punctuation">.</span>user_id
</code></pre> 
<h3><a id="15___1747"></a>15. 即时食物配送 ②</h3> 
<p>如果顾客期望的配送日期和下单日期相同，则该订单称为 「即时订单」，否则称为「计划订单」。<br> 「首次订单」是顾客最早创建的订单。我们保证一个顾客只会有一个「首次订单」。<br> 写一条 SQL 查询语句获取即时订单在所有用户的首次订单中的比例。保留两位小数。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Delivery'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Delivery
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Delivery<span class="token punctuation">(</span>
 delivery_id                 <span class="token keyword">int</span>
<span class="token punctuation">,</span>customer_id                 <span class="token keyword">int</span>
<span class="token punctuation">,</span>order_date                  <span class="token keyword">date</span>
<span class="token punctuation">,</span>customer_pref_delivery_date <span class="token keyword">date</span>

<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Delivery
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-01'</span><span class="token punctuation">,</span><span class="token string">'2019-08-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-02'</span><span class="token punctuation">,</span><span class="token string">'2019-08-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-11'</span><span class="token punctuation">,</span><span class="token string">'2019-08-12'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-24'</span><span class="token punctuation">,</span><span class="token string">'2019-08-24'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-21'</span><span class="token punctuation">,</span><span class="token string">'2019-08-22'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>    <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-11'</span><span class="token punctuation">,</span><span class="token string">'2019-08-13'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'2019-08-09'</span><span class="token punctuation">,</span><span class="token string">'2019-08-09'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> order_date <span class="token operator">=</span> customer_pref_delivery_date <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">as</span> immediate_percentage
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> customer_id <span class="token keyword">order</span> <span class="token keyword">by</span> order_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
        <span class="token keyword">from</span> Delivery<span class="token punctuation">)</span>a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="16__1781"></a>16. 计算税后工资</h3> 
<p><img src="https://images2.imgbox.com/b3/46/Cfdcb3Zc_o.png" alt="计算税后工资"></p> 
<p>查找出每个员工的税后工资<br> 每个公司的税率计算依照以下规则：<br> 如果这个公司员工最高工资不到 $1000 ，税率为 0%<br> 如果这个公司员工最高工资在 [1000, 10000] 之间，税率为 24%<br> 如果这个公司员工最高工资大于 $10000 ，税率为 49%<br> 按 任意顺序 返回结果。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Salaries'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Salaries
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Salaries<span class="token punctuation">(</span>
 company_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>employee_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>employee_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>salary        <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Salaries
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'Tony'</span>       <span class="token punctuation">,</span><span class="token number">2000</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'Pronub'</span>     <span class="token punctuation">,</span><span class="token number">21300</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'Tyrrox'</span>     <span class="token punctuation">,</span><span class="token number">10800</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'Pam'</span>        <span class="token punctuation">,</span><span class="token number">300</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">7</span>   <span class="token punctuation">,</span><span class="token string">'Bassem'</span>     <span class="token punctuation">,</span><span class="token number">450</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">9</span>   <span class="token punctuation">,</span><span class="token string">'Hermione'</span>   <span class="token punctuation">,</span><span class="token number">700</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">7</span>   <span class="token punctuation">,</span><span class="token string">'Bocaben'</span>    <span class="token punctuation">,</span><span class="token number">100</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'Ognjen'</span>     <span class="token punctuation">,</span><span class="token number">2200</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">13</span>  <span class="token punctuation">,</span><span class="token string">'Nyancat'</span>    <span class="token punctuation">,</span><span class="token number">3300</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">15</span>  <span class="token punctuation">,</span><span class="token string">'Morninngcat'</span><span class="token punctuation">,</span><span class="token number">7777</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> company_id<span class="token punctuation">,</span>employee_id<span class="token punctuation">,</span>employee_name
<span class="token punctuation">,</span>cast <span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> MaxSalary <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token keyword">then</span> salary <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">when</span> MaxSalary <span class="token operator">between</span>  <span class="token number">1000</span> <span class="token operator">and</span> <span class="token number">10000</span> <span class="token keyword">then</span> Salary <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">0.24</span><span class="token punctuation">)</span>
<span class="token keyword">else</span> salary <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">0.49</span><span class="token punctuation">)</span> <span class="token keyword">end</span>  <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Salary
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> company_id<span class="token punctuation">,</span>employee_id<span class="token punctuation">,</span>employee_name<span class="token punctuation">,</span>salary
     <span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> company_id<span class="token punctuation">)</span> <span class="token keyword">as</span> MaxSalary
<span class="token keyword">from</span> Salaries<span class="token punctuation">)</span> a
</code></pre> 
<h3><a id="17__1826"></a>17. 选举结果</h3> 
<p><img src="https://images2.imgbox.com/9c/b2/OmpGUp7s_o.png" alt="在这里插入图片描述"><br> 选举在一个城市进行，每个人都可以投票给 一个或多个 候选人，也可以选择 不 投票。每个人都有 1 票，所以如果他们投票给多个候选人，他们的选票会被平均分配。例如，如果一个人投票给 2 个候选人，这些候选人每人获得 0.5 张选票。<br> 编写一个 SQL 查询来查找获得最多选票并赢得选举的候选人 candidate 。输出 候选人 的姓名，或者如果多个候选人的票数 相等 ，则输出所有候选人的姓名。<br> 返回按 candidate 升序排序 的结果表。</p> 
<pre><code class="prism language-sql">
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Votes'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Votes
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Votes <span class="token punctuation">(</span>
  voter      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> candidate  <span class="token keyword">varchar</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Votes
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token string">'Kathy'</span>    <span class="token punctuation">,</span><span class="token boolean">null</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Charles'</span>  <span class="token punctuation">,</span><span class="token string">'Ryan'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Charles'</span>  <span class="token punctuation">,</span><span class="token string">'Christine'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Charles'</span>  <span class="token punctuation">,</span><span class="token string">'Kathy'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Benjamin'</span> <span class="token punctuation">,</span><span class="token string">'Christine'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Anthony'</span>  <span class="token punctuation">,</span><span class="token string">'Ryan'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Edward'</span>   <span class="token punctuation">,</span><span class="token string">'Ryan'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Terry'</span>    <span class="token punctuation">,</span><span class="token boolean">null</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Evelyn'</span>   <span class="token punctuation">,</span><span class="token string">'Kathy'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Arthur'</span>   <span class="token punctuation">,</span><span class="token string">'Christine'</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> candidate <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> candidate <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token operator">/</span>cnt<span class="token punctuation">)</span>  <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk  <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> candidate <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">1</span> <span class="token keyword">end</span><span class="token punctuation">)</span>  <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> voter<span class="token punctuation">)</span> <span class="token keyword">as</span> Cnt
<span class="token keyword">from</span> votes<span class="token punctuation">)</span> a
<span class="token keyword">where</span> cnt <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> candidate<span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk  <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> candidate
</code></pre> 
<h3><a id="18__1866"></a>18. 航班入座率和等待名单分析</h3> 
<p><img src="https://images2.imgbox.com/fe/3d/Vg2Zc5sC_o.png" alt="航班入座率和等到结果分析"><br> 乘客提前预订航班机票。如果乘客预订了某个航班的机票，并且该航班还有空座位，乘客的机票将会得到 确认 。然而，如果航班已经满员，乘客将会进入 等待名单 。<br> 编写解决方案，报告每个航班已成功预订（获得座位）的乘客数以及处于等待名单上的乘客数。<br> 按照 flight_id 升序排序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Flights'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Flights
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Flights<span class="token punctuation">(</span>
flight_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>capacity     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Flights
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'Passengers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Passengers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Passengers<span class="token punctuation">(</span>
 passenger_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span>flight_id     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>  Passengers
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">101</span>     <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">102</span>     <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">103</span>     <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">104</span>     <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">105</span>     <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">106</span>     <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">107</span>     <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>flight_id
     <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> b<span class="token punctuation">.</span>capacity<span class="token operator">&gt;=</span> cnt <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> booked_cnt
    <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> b<span class="token punctuation">.</span>capacity <span class="token operator">&lt;</span> cnt <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> waitlist_cnt
<span class="token keyword">from</span> Flights a
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>capacity <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>flight_id <span class="token keyword">order</span> <span class="token keyword">by</span> passenger_id<span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> Flights b
<span class="token keyword">left</span> <span class="token keyword">join</span> Passengers a
<span class="token keyword">on</span> a<span class="token punctuation">.</span>flight_id <span class="token operator">=</span> b<span class="token punctuation">.</span>flight_id<span class="token punctuation">)</span>b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>flight_id <span class="token operator">=</span> b<span class="token punctuation">.</span>flight_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>flight_id
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>flight_id
</code></pre> 
<h3><a id="19__1919"></a>19. 统计文本中单词出现的次数</h3> 
<p><img src="https://images2.imgbox.com/34/d4/2pGT5otC_o.png" alt="在这里插入图片描述"><br> 编写解决方案，找出单词 ‘bull’ 和 ‘bear’ 作为 独立词 出现的次数，不考虑任何它出现在两侧没有空格的情况（例如，‘bullet’, ‘bears’, ‘bull.’，或者 ‘bear’ 在句首或句尾 不会 被考虑）。<br> 返回单词 ‘bull’ 和 ‘bear’ 以及它们对应的出现次数，顺序没有限制 。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Files'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Files
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Files<span class="token punctuation">(</span>
  file_name   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> content     <span class="token keyword">text</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Files
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token string">'draft1.txt'</span> <span class="token punctuation">,</span><span class="token string">'The stock exchange predicts a bull market which would make many investors happy.'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'draft2.txt'</span> <span class="token punctuation">,</span><span class="token string">'The stock exchange predicts a bull market which would make many investors happy,but analysts warn of possibility of too much optimism and that in fact we are awaiting a bear market.'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'draft3.txt'</span> <span class="token punctuation">,</span> <span class="token string">'The stock exchange predicts a bull market which would make many investors happy,but analysts warn of possibility of too much optimism and that in fact we are awaiting a bear market. As always predicting the future market is an uncertain game and all investors should follow their instincts and best practices.'</span>         <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token string">'bull'</span> <span class="token keyword">as</span> word <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>  <span class="token function">len</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>   <span class="token operator">-</span>  <span class="token function">len</span><span class="token punctuation">(</span><span class="token keyword">replace</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span><span class="token string">' bull '</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">/</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token string">' bull '</span><span class="token punctuation">)</span> <span class="token keyword">as</span> count
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> file_name<span class="token punctuation">,</span>cast<span class="token punctuation">(</span>content <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> content <span class="token keyword">from</span> files <span class="token punctuation">)</span> a
<span class="token keyword">union</span>
<span class="token keyword">select</span> <span class="token string">'bear'</span> <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span>  <span class="token function">len</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>   <span class="token operator">-</span>  <span class="token function">len</span><span class="token punctuation">(</span><span class="token keyword">replace</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span><span class="token string">' bear '</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span><span class="token operator">/</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token string">' bear '</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> file_name<span class="token punctuation">,</span>cast<span class="token punctuation">(</span>content <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> content <span class="token keyword">from</span> files <span class="token punctuation">)</span> a

</code></pre> 
<h3><a id="20__1949"></a>20. 查找活跃用户</h3> 
<p><img src="https://images2.imgbox.com/ae/d1/ILFQaBUY_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案，找出活跃用户。活跃用户是指在其任何一次购买之后的 七天内 进行了第二次购买的用户。<br> 例如，如果结束日期是 2023年5月31日，那么在 2023年5月31日 和 2023年6月7日之间（包括这两天）的任何日期都被视为"在7天内"。<br> 返回 任意顺序 的 user_id 列表，表示活跃用户列表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Users
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Users <span class="token punctuation">(</span>
  user_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> item         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> created_at  <span class="token keyword">datetime</span>
<span class="token punctuation">,</span> amount      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Users
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'Smart Crock Pot'</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-18'</span><span class="token punctuation">,</span> <span class="token number">698882</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'Smart Lock'</span>        <span class="token punctuation">,</span><span class="token string">'2021-09-14'</span><span class="token punctuation">,</span> <span class="token number">11487</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'Smart Thermostat'</span>  <span class="token punctuation">,</span><span class="token string">'2021-09-10'</span><span class="token punctuation">,</span> <span class="token number">674762</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>    <span class="token punctuation">,</span><span class="token string">'Smart Light Strip'</span> <span class="token punctuation">,</span><span class="token string">'2021-09-29'</span><span class="token punctuation">,</span> <span class="token number">630773</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Smart Cat Feeder'</span>  <span class="token punctuation">,</span><span class="token string">'2021-09-02'</span><span class="token punctuation">,</span> <span class="token number">693545</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Smart Bed'</span>         <span class="token punctuation">,</span><span class="token string">'2021-09-13'</span><span class="token punctuation">,</span> <span class="token number">170249</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
          <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> created_at<span class="token punctuation">)</span>  <span class="token keyword">as</span> rnk
          <span class="token punctuation">,</span>dateadd<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> created_at<span class="token punctuation">)</span> <span class="token keyword">as</span> eddate
          <span class="token keyword">from</span> users <span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>user_id
<span class="token keyword">from</span> T a
<span class="token keyword">left</span> <span class="token keyword">join</span> T b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id <span class="token operator">and</span> b<span class="token punctuation">.</span>rnk <span class="token operator">&lt;&gt;</span> a<span class="token punctuation">.</span>rnk
<span class="token keyword">where</span> a<span class="token punctuation">.</span>created_at <span class="token operator">between</span> b<span class="token punctuation">.</span>created_at <span class="token operator">and</span> b<span class="token punctuation">.</span>eddate
</code></pre> 
<h3><a id="21__1989"></a>21. 计算每个销售人员的影响力</h3> 
<p><img src="https://images2.imgbox.com/08/1b/ppuE2VXi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c4/64/bYaYwbWE_o.png" alt="在这里插入图片描述"><br> 编写一个 SQL 查询用来报告每个销售人员的客户所支付的价格总和。如果销售人员没有任何客户，则总值应该为 0 。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Salesperson'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Salesperson
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Salesperson <span class="token punctuation">(</span>
 salesperson_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span>name            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Salesperson
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>         <span class="token punctuation">,</span><span class="token string">'Alice'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>         <span class="token punctuation">,</span><span class="token string">'Bob'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>         <span class="token punctuation">,</span><span class="token string">'Jerry'</span> <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Customer'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Customer
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Customer<span class="token punctuation">(</span>
 customer_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>salesperson_id  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Customer
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">1</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">1</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">2</span>     <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span> <span class="token string">'Sales'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Sales
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Sales<span class="token punctuation">(</span>
  sale_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> customer_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> price        <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Sales
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">892</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">354</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">988</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">856</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>salesperson_id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>total<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total
<span class="token keyword">from</span> Salesperson a
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> b<span class="token punctuation">.</span>salesperson_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price <span class="token punctuation">)</span> <span class="token keyword">as</span> total
<span class="token keyword">from</span> Sales   a
<span class="token keyword">left</span> <span class="token keyword">join</span> Customer  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> b<span class="token punctuation">.</span>customer_id
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> B<span class="token punctuation">.</span>salesperson_id<span class="token punctuation">)</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>salesperson_id <span class="token operator">=</span> b<span class="token punctuation">.</span>salesperson_id
</code></pre> 
<h3><a id="22__2049"></a>22. 坚定的友谊</h3> 
<p><img src="https://images2.imgbox.com/61/64/tJtPbx4I_o.png" alt="在这里插入图片描述"><br> 如果 x 和 y 为朋友且他们至少有三个共同的朋友 ，那么 x 和 y 之间的友谊就是坚定的。<br> 写一个 SQL 查询来找到所有的坚定的友谊。<br> 注意，结果表不应该包含重复，并且 user1_id &lt; user2_id。<br> 以任何顺序返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表  如果 x  和 y 为朋友且他们至少有三个共同的朋友 ，那么 x 和 y 之间的友谊就是坚定的。</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Friendship'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Friendship
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Friendship <span class="token punctuation">(</span>
  user1_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> user2_id     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Friendship
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">5</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">5</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">6</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">6</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">6</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> f <span class="token keyword">as</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> user1_id<span class="token punctuation">,</span>user2_id <span class="token keyword">from</span> Friendship
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span> user2_id<span class="token punctuation">,</span>user1_id <span class="token keyword">from</span> Friendship
<span class="token punctuation">)</span><span class="token punctuation">,</span>
t <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> a<span class="token punctuation">.</span>user1_id a1<span class="token punctuation">,</span> a<span class="token punctuation">.</span>user2_id a2<span class="token punctuation">,</span> b<span class="token punctuation">.</span>user1_id b1<span class="token punctuation">,</span> b<span class="token punctuation">.</span>user2_id b2
    <span class="token keyword">from</span> f a <span class="token keyword">left</span> <span class="token keyword">join</span> f b <span class="token keyword">on</span> a<span class="token punctuation">.</span>user2_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user1_id
<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">data</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> a1<span class="token punctuation">,</span>a2<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>user2_id<span class="token punctuation">)</span> common_friend
    <span class="token keyword">from</span> t <span class="token keyword">left</span> <span class="token keyword">join</span> f c <span class="token keyword">on</span> t<span class="token punctuation">.</span>a1 <span class="token operator">=</span> c<span class="token punctuation">.</span>user1_id <span class="token operator">and</span> t<span class="token punctuation">.</span>b2 <span class="token operator">=</span> c<span class="token punctuation">.</span>user2_id
    <span class="token keyword">group</span> <span class="token keyword">by</span> a1<span class="token punctuation">,</span>a2 <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>user2_id<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> a1 user1_id<span class="token punctuation">,</span> a2 user2_id<span class="token punctuation">,</span> common_friend
<span class="token keyword">from</span> <span class="token keyword">data</span>
<span class="token keyword">where</span> a1 <span class="token operator">&lt;</span> a2<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="23__2101"></a>23. 苹果和桔子</h3> 
<p><img src="https://images2.imgbox.com/6c/8c/kTBbgO6t_o.png" alt="在这里插入图片描述"><br> 编写解决方案报告每一天 苹果 和 桔子 销售的数目的差异.<br> 返回的结果表, 按照格式为 (‘YYYY-MM-DD’) 的 sale_date 排序.</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Sales'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Sales
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Sales <span class="token punctuation">(</span>
 sale_date    <span class="token keyword">date</span>
<span class="token punctuation">,</span>fruit        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>sold_num      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Sales
<span class="token keyword">values</span>
   <span class="token punctuation">(</span>  <span class="token string">'2020-05-01'</span> <span class="token punctuation">,</span><span class="token string">'apples'</span>     <span class="token punctuation">,</span><span class="token number">10</span>   <span class="token punctuation">)</span>
  <span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'2020-05-01'</span> <span class="token punctuation">,</span><span class="token string">'oranges'</span>    <span class="token punctuation">,</span><span class="token number">8</span>    <span class="token punctuation">)</span>
  <span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'2020-05-02'</span> <span class="token punctuation">,</span><span class="token string">'apples'</span>     <span class="token punctuation">,</span><span class="token number">15</span>   <span class="token punctuation">)</span>
  <span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'2020-05-02'</span> <span class="token punctuation">,</span><span class="token string">'oranges'</span>    <span class="token punctuation">,</span><span class="token number">15</span>   <span class="token punctuation">)</span>
  <span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'2020-05-03'</span> <span class="token punctuation">,</span><span class="token string">'apples'</span>     <span class="token punctuation">,</span><span class="token number">20</span>   <span class="token punctuation">)</span>
  <span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'2020-05-03'</span> <span class="token punctuation">,</span><span class="token string">'oranges'</span>    <span class="token punctuation">,</span><span class="token number">0</span>    <span class="token punctuation">)</span>
  <span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'2020-05-04'</span> <span class="token punctuation">,</span><span class="token string">'apples'</span>     <span class="token punctuation">,</span><span class="token number">15</span>   <span class="token punctuation">)</span>
  <span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token string">'2020-05-04'</span> <span class="token punctuation">,</span><span class="token string">'oranges'</span>    <span class="token punctuation">,</span><span class="token number">16</span>   <span class="token punctuation">)</span>
  go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> sale_date<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> fruit <span class="token operator">=</span> <span class="token string">'apples'</span> <span class="token keyword">then</span> sold_num <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> fruit <span class="token operator">=</span> <span class="token string">'oranges'</span> <span class="token keyword">then</span> sold_num <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> diff
<span class="token keyword">from</span> sales
<span class="token keyword">group</span> <span class="token keyword">by</span> sale_date
<span class="token keyword">order</span> <span class="token keyword">by</span> sale_date
</code></pre> 
<h3><a id="24__2135"></a>24. 小众书籍</h3> 
<p><img src="https://images2.imgbox.com/5e/74/ZOb1mzHr_o.png" alt="在这里插入图片描述"><br> 编写解决方案，筛选出过去一年中订单总量 少于 10 本 的 书籍，并且 不考虑 上架距今销售 不满一个月 的书籍 。假设今天是 2019-06-23 。<br> 返回结果表 无顺序要求 。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Books'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Books
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Books<span class="token punctuation">(</span>
    book_id         <span class="token keyword">int</span>
 <span class="token punctuation">,</span>name            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
 <span class="token punctuation">,</span>available_from  <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Books
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>     <span class="token punctuation">,</span><span class="token string">'"Kalila And Demna"'</span><span class="token punctuation">,</span><span class="token string">'2010-01-01'</span><span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>     <span class="token punctuation">,</span><span class="token string">'"28 Letters"'</span>      <span class="token punctuation">,</span><span class="token string">'2012-05-12'</span><span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>     <span class="token punctuation">,</span><span class="token string">'"The Hobbit"'</span>      <span class="token punctuation">,</span><span class="token string">'2019-06-10'</span><span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>     <span class="token punctuation">,</span><span class="token string">'"13 Reasons Why"'</span>  <span class="token punctuation">,</span><span class="token string">'2019-06-01'</span><span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span>     <span class="token punctuation">,</span><span class="token string">'"The Hunger Games"'</span><span class="token punctuation">,</span><span class="token string">'2008-09-21'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders<span class="token punctuation">(</span>
 order_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span> book_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span> quantity      <span class="token keyword">int</span>
<span class="token punctuation">,</span> dispatch_date   <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2018-07-26'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2018-11-05'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">8</span>    <span class="token punctuation">,</span><span class="token string">'2019-06-11'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'2019-06-05'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2019-06-20'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>  <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token number">9</span>    <span class="token punctuation">,</span><span class="token string">'2009-02-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>  <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token number">8</span>    <span class="token punctuation">,</span><span class="token string">'2010-04-13'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询 编写解决方案，筛选出过去一年中订单总量 少于 10 本 的 书籍，并且 不考虑 上架距今销售 不满一个月 的书籍 。假设今天是 2019-06-23 。</span>
<span class="token keyword">select</span>  a<span class="token punctuation">.</span>book_id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>name
<span class="token keyword">from</span> books a
<span class="token keyword">left</span> <span class="token keyword">join</span>  Orders  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>book_id <span class="token operator">=</span> b<span class="token punctuation">.</span>book_id <span class="token operator">and</span> b<span class="token punctuation">.</span>dispatch_date <span class="token operator">&gt;=</span> <span class="token string">'2018-06-23'</span>
<span class="token keyword">where</span> datediff<span class="token punctuation">(</span><span class="token keyword">month</span> <span class="token punctuation">,</span>available_from <span class="token punctuation">,</span><span class="token string">'2019-06-23'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>book_id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>name
<span class="token keyword">having</span> isnull<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">10</span>

</code></pre> 
<h3><a id="25__2188"></a>25. 矩形面积</h3> 
<p><img src="https://images2.imgbox.com/e6/cd/XiCat2Hz_o.png" alt="在这里插入图片描述"><br> 编写解决方案，报告由表中任意两点可以形成的所有 边与坐标轴平行 且 面积不为零 的矩形。<br> 结果表中的每一行包含三列 (p1, p2, area) 如下:<br> p1 和 p2 是矩形两个对角的 id<br> 矩形的面积由列 area 表示<br> 返回结果表请按照面积 area 大小 降序排列；如果面积相同的话, 则按照 p1 升序排序；若仍相同，则按 p2 升序排列。</p> 
<pre><code class="prism language-sql">在这里插入代码片
</code></pre> 
<h3><a id="26__2200"></a>26. 最后一个能进入巴士的人</h3> 
<p><img src="https://images2.imgbox.com/34/8e/OpU5TS4i_o.png" alt="在这里插入图片描述"><br> 有一队乘客在等着上巴士。然而，巴士有1000 千克 的重量限制，所以其中一部分乘客可能无法上巴士。<br> 编写解决方案找出 最后一个 上巴士且不超过重量限制的乘客，并报告 person_name 。题目测试用例确保顺位第一的人可以上巴士且不会超重。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Queue'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Queue
 go
<span class="token keyword">create</span> <span class="token keyword">table</span> Queue<span class="token punctuation">(</span>
  person_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> person_name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> weight       <span class="token keyword">int</span>
<span class="token punctuation">,</span> turn         <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Queue
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'Alice'</span>      <span class="token punctuation">,</span><span class="token number">250</span>  <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'Bob'</span>        <span class="token punctuation">,</span><span class="token number">175</span>  <span class="token punctuation">,</span><span class="token number">5</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'Alex'</span>       <span class="token punctuation">,</span><span class="token number">350</span>  <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span>   <span class="token punctuation">,</span><span class="token string">'John Cena'</span>  <span class="token punctuation">,</span><span class="token number">400</span>  <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'Winston'</span>    <span class="token punctuation">,</span><span class="token number">500</span>  <span class="token punctuation">,</span><span class="token number">6</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'Marie'</span>      <span class="token punctuation">,</span><span class="token number">200</span>  <span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--select* from Queue</span>
<span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">1</span> person_name <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> turn <span class="token punctuation">)</span> <span class="token keyword">as</span> sumweight
<span class="token keyword">from</span> Queue <span class="token punctuation">)</span>a
<span class="token keyword">where</span> sumweight <span class="token operator">&lt;=</span> <span class="token number">1000</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> turn <span class="token keyword">desc</span>
</code></pre> 
<h3><a id="27__2236"></a>27. 滚动平均步数</h3> 
<p><img src="https://images2.imgbox.com/f2/c1/zaaQ6sp8_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案，计算出每个用户的 3-day 滚动平均步数 。<br> 计算 n-day 滚动平均值 的计算方式如下：<br> 对于每一天，如果有可用数据的情况下，我们会计算以该天为结束的 n 天连续步数的平均值，否则，对于该天来说，n 天滚动平均步数是未定义的。<br> 输出 user_id 、 steps_date 和滚动平均值。并将滚动平均值四舍五入到 两位小数。<br> 返回结果表以user_id 和 steps_date 升序 排序。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Steps'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Steps
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Steps<span class="token punctuation">(</span>
  user_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> steps_count  <span class="token keyword">int</span>
<span class="token punctuation">,</span> steps_date   <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Steps
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">687</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">395</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-04'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">499</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-05'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">712</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-06'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">576</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-07'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">153</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-06'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">171</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-07'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">530</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-08'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">945</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-04'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">120</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-07'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">557</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-08'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">840</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-09'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">627</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-10'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token number">382</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-05'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>   <span class="token punctuation">,</span><span class="token number">480</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>   <span class="token punctuation">,</span><span class="token number">191</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>   <span class="token punctuation">,</span><span class="token number">303</span>   <span class="token punctuation">,</span><span class="token string">'2021-09-05'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> <span class="token keyword">temp</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>
      <span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span>steps_date<span class="token punctuation">,</span> LAG<span class="token punctuation">(</span>steps_date<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> user_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> steps_date<span class="token punctuation">)</span> <span class="token keyword">AS</span> lag_date<span class="token punctuation">,</span>
    cast<span class="token punctuation">(</span><span class="token function">AVG</span><span class="token punctuation">(</span>steps_count<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> user_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> steps_date <span class="token keyword">ROWS</span> <span class="token number">2</span> <span class="token keyword">PRECEDING</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rolling_average <span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> abs<span class="token punctuation">(</span>DATEDIFF<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span>steps_date<span class="token punctuation">,</span> LAG<span class="token punctuation">(</span>steps_date<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> user_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> steps_date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> di
    <span class="token keyword">FROM</span> Steps <span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> steps_date<span class="token punctuation">,</span> rolling_average
<span class="token keyword">FROM</span> <span class="token keyword">temp</span>
<span class="token keyword">WHERE</span> di <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">,</span> steps_date<span class="token punctuation">;</span>


</code></pre> 
<h3><a id="28__2288"></a>28. 开除员工</h3> 
<p><img src="https://images2.imgbox.com/98/70/Ft0QJfDp_o.png" alt="在这里插入图片描述"><br> 在公司里，每个员工每个月必须工作一定的小时数。员工在工作段中工作。员工工作的小时数可以通过员工在所有工作段中工作的分钟数的总和来计算。每个工作段的分钟数是向上取整的。<br> 例如，如果员工在一个时间段中工作了 51 分 2 秒，我们就认为它是 52 分钟。<br> 编写解决方案来报告将被开除的员工的 id。换句话说，报告没有工作所需时间的员工的 id。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employees'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employees
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employees <span class="token punctuation">(</span>
  employee_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> needed_hours  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employees
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">20</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">12</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Logs'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Logs
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Logs<span class="token punctuation">(</span>
  employee_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> in_time      <span class="token keyword">datetime</span>
<span class="token punctuation">,</span> out_time     <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Logs
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2022-10-01 09:00:00'</span><span class="token punctuation">,</span><span class="token string">'2022-10-01 17:00:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2022-10-06 09:05:04'</span><span class="token punctuation">,</span><span class="token string">'2022-10-06 17:09:03'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2022-10-12 23:00:00'</span><span class="token punctuation">,</span><span class="token string">'2022-10-13 03:00:01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2022-10-29 12:00:00'</span><span class="token punctuation">,</span><span class="token string">'2022-10-29 23:59:58'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

<span class="token keyword">select</span> a<span class="token punctuation">.</span>employee_id <span class="token keyword">from</span> Employees a
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> employee_id <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>ceiling<span class="token punctuation">(</span>datediff<span class="token punctuation">(</span><span class="token keyword">second</span><span class="token punctuation">,</span>in_time<span class="token punctuation">,</span>out_time<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token number">60</span> <span class="token keyword">as</span> workhour
<span class="token keyword">from</span> Logs
<span class="token keyword">group</span> <span class="token keyword">by</span> employee_id<span class="token punctuation">)</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>employee_id <span class="token operator">=</span> b<span class="token punctuation">.</span>employee_id
<span class="token keyword">where</span> a<span class="token punctuation">.</span>needed_hours <span class="token operator">&gt;</span> isnull<span class="token punctuation">(</span>b<span class="token punctuation">.</span>workhour<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="29_2336"></a>29.报告的记录</h3> 
<p><img src="https://images2.imgbox.com/39/fe/haDPz7Vk_o.png" alt="在这里插入图片描述"><br> 编写解决方案，统计在被报告为垃圾广告的帖子中，被移除的帖子的每日平均占比，四舍五入到小数点后 2 位。</p> 
<pre><code class="prism language-sql">在这里插入代码片
</code></pre> 
<h3><a id="30__2344"></a>30. 二级关注者</h3> 
<p><img src="https://images2.imgbox.com/69/fa/EXn0tpDj_o.png" alt="在这里插入图片描述"><br> 二级关注者 是指满足以下条件的用户:<br> 关注至少一个用户，<br> 被至少一个用户关注。<br> 编写一个解决方案来报告 二级用户 及其关注者的数量。<br> 返回按 follower 字典序排序 的结果表。</p> 
<pre><code class="prism language-sql">
<span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Follow'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Follow
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Follow <span class="token punctuation">(</span>
  followee     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> follower     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Follow
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token string">'Alice'</span>    <span class="token punctuation">,</span> <span class="token string">'Bob'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Bob'</span>      <span class="token punctuation">,</span> <span class="token string">'Cena'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Bob'</span>      <span class="token punctuation">,</span> <span class="token string">'Donald'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Donald'</span>   <span class="token punctuation">,</span> <span class="token string">'Edward'</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> followee<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> num <span class="token keyword">from</span> follow
<span class="token keyword">group</span> <span class="token keyword">by</span> followee
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span>t2 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> follower  <span class="token keyword">from</span> follow
<span class="token keyword">group</span> <span class="token keyword">by</span> follower
 <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token keyword">select</span> follower<span class="token punctuation">,</span>num <span class="token keyword">from</span> t1 a
<span class="token keyword">inner</span> <span class="token keyword">join</span> t2 b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>followee <span class="token operator">=</span> b<span class="token punctuation">.</span>follower
<span class="token keyword">order</span> <span class="token keyword">by</span> follower
<span class="token comment">--方法二</span>
<span class="token keyword">select</span> f1<span class="token punctuation">.</span>followee follower<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> f1<span class="token punctuation">.</span>follower<span class="token punctuation">)</span> num
<span class="token keyword">from</span> follow f1
      <span class="token keyword">join</span> follow f2 <span class="token keyword">on</span> f1<span class="token punctuation">.</span>followee <span class="token operator">=</span> f2<span class="token punctuation">.</span>follower
<span class="token keyword">group</span> <span class="token keyword">by</span> f1<span class="token punctuation">.</span>followee
</code></pre> 
<h3><a id="31__2388"></a>31. 部门工资最高的员工</h3> 
<p><img src="https://images2.imgbox.com/41/af/Qv5YlcSp_o.png" alt="在这里插入图片描述"><br> 查找出每个部门中薪资最高的员工。<br> 按 任意顺序 返回结果表。<br> 查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/e3/dc/mOSfrRYv_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employee'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employee
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employee<span class="token punctuation">(</span>
 id            <span class="token keyword">int</span>
<span class="token punctuation">,</span>name          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>salary        <span class="token keyword">int</span>
<span class="token punctuation">,</span>departmentId  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employee
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'Joe'</span>   <span class="token punctuation">,</span><span class="token number">70000</span>  <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'Jim'</span>   <span class="token punctuation">,</span><span class="token number">90000</span>  <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'Henry'</span> <span class="token punctuation">,</span><span class="token number">80000</span>  <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'Sam'</span>   <span class="token punctuation">,</span><span class="token number">60000</span>  <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token string">'Max'</span>   <span class="token punctuation">,</span><span class="token number">90000</span>  <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Department'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Department
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Department<span class="token punctuation">(</span>
  id          <span class="token keyword">int</span>
<span class="token punctuation">,</span> name        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Department
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'IT'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Sales'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--注意：当有部门没有员工薪资信息时，最后查询结果中不需要显示该部门</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>Department  <span class="token punctuation">,</span>a<span class="token punctuation">.</span>name <span class="token keyword">as</span> Employee<span class="token punctuation">,</span>a<span class="token punctuation">.</span>Salary
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>name <span class="token keyword">as</span> Department
<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> departmentid <span class="token keyword">order</span> <span class="token keyword">by</span> salary <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> Employee a
<span class="token keyword">left</span> <span class="token keyword">join</span> department  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>departmentId <span class="token operator">=</span> b<span class="token punctuation">.</span>id
<span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>


</code></pre> 
<h3><a id="32__2442"></a>32. 查询回答率最高的问题</h3> 
<p><img src="https://images2.imgbox.com/ba/93/j2rK688e_o.png" alt="在这里插入图片描述"><br> 回答率 是指：同一问题编号中回答次数占显示次数的比率。<br> 编写一个解决方案以报告 回答率 最高的问题。如果有多个问题具有相同的最大 回答率 ，返回 question_id 最小的那个。<br> 查询结果如下例所示。<br> <img src="https://images2.imgbox.com/8e/a7/zt1OZ6qp_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'SurveyLog'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> SurveyLog
go
<span class="token keyword">create</span> <span class="token keyword">table</span> SurveyLog<span class="token punctuation">(</span>

  id           <span class="token keyword">int</span>
<span class="token punctuation">,</span> <span class="token keyword">action</span>       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> question_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> answer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> q_num        <span class="token keyword">int</span>
<span class="token punctuation">,</span> <span class="token keyword">timestamp</span>    <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> SurveyLog
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">5</span> <span class="token punctuation">,</span> <span class="token string">'show'</span>   <span class="token punctuation">,</span> <span class="token number">285</span>   <span class="token punctuation">,</span><span class="token boolean">null</span>    <span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">123</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token punctuation">,</span> <span class="token string">'answer'</span> <span class="token punctuation">,</span> <span class="token number">285</span>   <span class="token punctuation">,</span><span class="token number">124124</span>  <span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token number">124</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token punctuation">,</span> <span class="token string">'show'</span>   <span class="token punctuation">,</span> <span class="token number">369</span>   <span class="token punctuation">,</span><span class="token boolean">null</span>    <span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">125</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token punctuation">,</span> <span class="token string">'skip'</span>   <span class="token punctuation">,</span> <span class="token number">369</span>   <span class="token punctuation">,</span><span class="token boolean">null</span>    <span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">126</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--方法1</span>
<span class="token keyword">select</span> question_id <span class="token keyword">as</span> survey_log
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> 回答率  <span class="token keyword">desc</span> <span class="token punctuation">,</span>question_id <span class="token keyword">asc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> question_id
     <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'answer'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span><span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">as</span> 回答率
<span class="token keyword">from</span> SurveyLog
<span class="token keyword">group</span> <span class="token keyword">by</span> question_id<span class="token punctuation">)</span> a <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">--方法2 ：</span>
<span class="token keyword">select</span>
<span class="token keyword">top</span> <span class="token number">1</span> question_id <span class="token keyword">as</span> survey_log
<span class="token keyword">from</span> SurveyLog
<span class="token keyword">group</span> <span class="token keyword">by</span> question_id
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'answer'</span> <span class="token keyword">then</span> <span class="token number">1.00</span> <span class="token keyword">else</span> <span class="token number">0.00</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">action</span> <span class="token operator">=</span> <span class="token string">'show'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">desc</span> <span class="token punctuation">,</span>question_id

</code></pre> 
<h3><a id="33__2489"></a>33. 统计各专业学生人数</h3> 
<p><img src="https://images2.imgbox.com/30/df/kuTl68JZ_o.png" alt="在这里插入图片描述"><br> 编写解决方案，为 Department 表中的所有部门(甚至是没有当前学生的部门)报告各自的部门名称和每个部门的学生人数。<br> 按 student_number 降序 返回结果表。如果是平局，则按 dept_name 的 字母顺序 排序。<br> 结果格式如下所示。<br> <img src="https://images2.imgbox.com/ff/c1/6gTJMsWX_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Student'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Student
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Student<span class="token punctuation">(</span>
   student_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> student_name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> gender        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> dept_id       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> Student
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'Jack'</span><span class="token punctuation">,</span><span class="token string">'M'</span><span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'Jane'</span><span class="token punctuation">,</span><span class="token string">'F'</span><span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Mark'</span><span class="token punctuation">,</span><span class="token string">'M'</span><span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Department'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> Department
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Department<span class="token punctuation">(</span>
 dept_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>dept_name   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Department
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'Engineering'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'Science'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'Law'</span>         <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>dept_name<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>student_id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> student_number
<span class="token keyword">from</span> department a
<span class="token keyword">left</span> <span class="token keyword">join</span> Student b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> b<span class="token punctuation">.</span>dept_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>dept_name
<span class="token keyword">order</span> <span class="token keyword">by</span> isnull<span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>student_id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">desc</span> <span class="token punctuation">,</span>dept_name <span class="token keyword">asc</span>
</code></pre> 
<h3><a id="34__2535"></a>34. 平面上的最近距离</h3> 
<p><img src="https://images2.imgbox.com/3b/a4/PY1hc0I8_o.png" alt="在这里插入图片描述"><br> p1(x1, y1) 和 p2(x2, y2) 这两点之间的距离是 sqrt((x2 - x1)2 + (y2 - y1)2) 。<br> 编写解决方案，报告 Point2D 表中任意两点之间的最短距离。保留 2 位小数 。<br> 返回结果格式如下例所示。<br> <img src="https://images2.imgbox.com/bf/c4/6Ve0U36S_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Point2D'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Point2D
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Point2D<span class="token punctuation">(</span>
  x            <span class="token keyword">int</span>
<span class="token punctuation">,</span> y            <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Point2D
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">0</span>  <span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> cast<span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>x<span class="token operator">-</span>a<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>x<span class="token operator">-</span>a<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>y<span class="token operator">-</span>a<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>y<span class="token operator">-</span>a<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> shortest
<span class="token keyword">from</span> Point2D a
<span class="token keyword">cross</span> <span class="token keyword">join</span> point2d b
<span class="token keyword">where</span> <span class="token operator">not</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>x <span class="token operator">=</span> b<span class="token punctuation">.</span>x <span class="token operator">and</span> a<span class="token punctuation">.</span>y <span class="token operator">=</span> b<span class="token punctuation">.</span>y <span class="token punctuation">)</span>
</code></pre> 
<h3><a id="35__2564"></a>35. 换座位</h3> 
<p><img src="https://images2.imgbox.com/5b/a4/w4x4X9ry_o.png" alt="在这里插入图片描述"><br> 编写解决方案来交换每两个连续的学生的座位号。如果学生的数量是奇数，则最后一个学生的id不交换。<br> 按 id 升序 返回结果表。<br> 查询结果格式如下所示。</p> 
<p><img src="https://images2.imgbox.com/bd/99/MZ1uYJBT_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Seat'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Seat
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Seat <span class="token punctuation">(</span>
  id          <span class="token keyword">int</span>
<span class="token punctuation">,</span> student     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Seat
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'Abbot'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'Doris'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'Emerson'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'Green'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token string">'Jeames'</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--交换每两个连续学生座位号，如果是奇数最后一个学生的ID 不交换</span>
<span class="token comment">--方法1</span>
<span class="token keyword">select</span>
     <span class="token keyword">case</span>  <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> Seat<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span>
            a<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> Seat<span class="token punctuation">)</span>  <span class="token keyword">then</span> a<span class="token punctuation">.</span>id
            <span class="token keyword">when</span>  a<span class="token punctuation">.</span>id <span class="token operator">%</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> a<span class="token punctuation">.</span>id <span class="token operator">-</span><span class="token number">1</span>
            <span class="token keyword">else</span> a<span class="token punctuation">.</span>id<span class="token operator">+</span><span class="token number">1</span>
      <span class="token keyword">end</span> <span class="token keyword">as</span> id  <span class="token punctuation">,</span>student
<span class="token keyword">from</span> Seat a
<span class="token keyword">order</span> <span class="token keyword">by</span>   <span class="token keyword">case</span>  <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> Seat<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span>
            a<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> Seat<span class="token punctuation">)</span>  <span class="token keyword">then</span> a<span class="token punctuation">.</span>id
            <span class="token keyword">when</span>  a<span class="token punctuation">.</span>id <span class="token operator">%</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> a<span class="token punctuation">.</span>id <span class="token operator">-</span><span class="token number">1</span>
            <span class="token keyword">else</span> a<span class="token punctuation">.</span>id<span class="token operator">+</span><span class="token number">1</span>
      <span class="token keyword">end</span>
<span class="token comment">--方法2</span>
<span class="token keyword">select</span> rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> newid<span class="token punctuation">)</span> <span class="token keyword">as</span> id <span class="token punctuation">,</span>student
<span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">case</span> <span class="token keyword">when</span> id <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> id <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">else</span> id <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">end</span> <span class="token keyword">as</span> newid<span class="token punctuation">,</span>student <span class="token keyword">from</span> Seat
<span class="token punctuation">)</span> <span class="token keyword">as</span>  t

</code></pre> 
<h3><a id="36___2611"></a>36. 项目员工 ③</h3> 
<p><img src="https://images2.imgbox.com/c5/11/azzUVg4O_o.png" alt="在这里插入图片描述"><br> 编写解决方案，报告在每一个项目中 经验最丰富 的雇员是谁。如果出现经验年数相同的情况，请报告所有具有最大经验年数的员工。<br> 返回结果表 无顺序要求 。<br> 结果格式如下示例所示。<br> <img src="https://images2.imgbox.com/8f/cf/JYwQ3g46_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Project'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Project
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Project<span class="token punctuation">(</span>
 project_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>employee_id  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Project
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">1</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">2</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">3</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">1</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">4</span>     <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employee'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employee
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employee <span class="token punctuation">(</span>
  employee_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span>name              <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>experience_years  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employee
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'Khaled'</span> <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'Ali'</span>    <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'John'</span>   <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'Doe'</span>    <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> project_id  <span class="token punctuation">,</span>employee_id
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> project_id <span class="token keyword">order</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>experience_years <span class="token keyword">desc</span> <span class="token punctuation">)</span>  <span class="token keyword">as</span> rnk
        <span class="token keyword">from</span> Project a
        <span class="token keyword">left</span> <span class="token keyword">join</span>  Employee  b
        <span class="token keyword">on</span> a<span class="token punctuation">.</span>employee_id <span class="token operator">=</span> b<span class="token punctuation">.</span>employee_id <span class="token punctuation">)</span>a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="37__2658"></a>37. 每日新用户统计</h3> 
<p><img src="https://images2.imgbox.com/63/5f/de1cRcqo_o.png" alt="在这里插入图片描述"><br> 编写解决方案，找出从今天起最多 90 天内，每个日期该日期首次登录的用户数。假设今天是 2019-06-30 。<br> 以 任意顺序 返回结果表。<br> 结果格式如下所示。<br> <img src="https://images2.imgbox.com/f4/6a/geFdvec8_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Traffic '</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Traffic
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Traffic <span class="token punctuation">(</span>
   user_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> activity       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> activity_date  <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Traffic
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'login'</span>    <span class="token punctuation">,</span><span class="token string">'2019-05-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'homepage'</span> <span class="token punctuation">,</span><span class="token string">'2019-05-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'logout'</span>   <span class="token punctuation">,</span><span class="token string">'2019-05-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'login'</span>    <span class="token punctuation">,</span><span class="token string">'2019-06-21'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'logout'</span>   <span class="token punctuation">,</span><span class="token string">'2019-06-21'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'login'</span>    <span class="token punctuation">,</span><span class="token string">'2019-01-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'jobs'</span>     <span class="token punctuation">,</span><span class="token string">'2019-01-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'logout'</span>   <span class="token punctuation">,</span><span class="token string">'2019-01-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'login'</span>    <span class="token punctuation">,</span><span class="token string">'2019-06-21'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'groups'</span>   <span class="token punctuation">,</span><span class="token string">'2019-06-21'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'logout'</span>   <span class="token punctuation">,</span><span class="token string">'2019-06-21'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'login'</span>    <span class="token punctuation">,</span><span class="token string">'2019-03-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'logout'</span>   <span class="token punctuation">,</span><span class="token string">'2019-03-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'login'</span>    <span class="token punctuation">,</span><span class="token string">'2019-06-21'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'logout'</span>   <span class="token punctuation">,</span><span class="token string">'2019-06-21'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> login_date <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> user_count
<span class="token keyword">from</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> user_id<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>activity_date<span class="token punctuation">)</span> <span class="token keyword">as</span> login_date
         <span class="token keyword">from</span> traffic
         <span class="token keyword">where</span> activity <span class="token operator">=</span> <span class="token string">'login'</span>
         <span class="token keyword">group</span> <span class="token keyword">by</span> user_id
         <span class="token keyword">having</span> <span class="token function">min</span><span class="token punctuation">(</span>activity_date<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> dateadd<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token string">'2019-06-30'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">)</span> a
<span class="token keyword">group</span> <span class="token keyword">by</span> login_date
</code></pre> 
<h3><a id="38__2707"></a>38. 每位学生的最高成绩</h3> 
<p><img src="https://images2.imgbox.com/fe/bb/IPWY2Z6Q_o.png" alt="在这里插入图片描述"><br> 编写解决方案，找出每位学生获得的最高成绩和它所对应的科目，若科目成绩并列，取 course_id 最小的一门。查询结果需按 student_id 增序进行排序。<br> 以 任意顺序 返回结果表。<br> 查询结果格式如下所示。<br> <img src="https://images2.imgbox.com/a8/29/oAHE4CJM_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Enrollments'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Enrollments
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Enrollments<span class="token punctuation">(</span>
 student_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>course_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> grade       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Enrollments
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">95</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">95</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">90</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">99</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">80</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">75</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">82</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> student_id <span class="token punctuation">,</span> course_id <span class="token punctuation">,</span> grade
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
       rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> student_id  <span class="token keyword">order</span> <span class="token keyword">by</span> grade  <span class="token keyword">desc</span> <span class="token punctuation">,</span>course_id <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> Enrollments <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="39__2742"></a>39. 查询活跃业务</h3> 
<p><img src="https://images2.imgbox.com/5a/74/nhBAEPkg_o.png" alt="在这里插入图片描述"><br> 平均活动 是指有特定 event_type 的具有该事件的所有公司的 occurences 的均值。<br> 活跃业务 是指具有 多个 event_type 的业务，它们的 occurences 严格大于 该事件的平均活动次数。<br> 写一个解决方案，找到所有 活跃业务。<br> 以 任意顺序 返回结果表。<br> 结果格式如下所示。<br> <img src="https://images2.imgbox.com/69/3f/q9l6ENeW_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span> <span class="token string">'Events'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Events
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Events<span class="token punctuation">(</span>
   business_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> event_type    <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> occurences     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Events
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'reviews'</span>    <span class="token punctuation">,</span><span class="token number">7</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'reviews'</span>    <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'ads'</span>        <span class="token punctuation">,</span><span class="token number">11</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'ads'</span>        <span class="token punctuation">,</span><span class="token number">7</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'ads'</span>        <span class="token punctuation">,</span><span class="token number">6</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'page views'</span> <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'page views'</span> <span class="token punctuation">,</span><span class="token number">12</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> business_id
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>occurences<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> event_type <span class="token punctuation">)</span> <span class="token keyword">as</span> avg_occurences
<span class="token keyword">from</span> Events <span class="token punctuation">)</span> a
<span class="token keyword">where</span> occurences <span class="token operator">&gt;</span> avg_occurences
<span class="token keyword">group</span> <span class="token keyword">by</span> business_id
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> event_type<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span>
</code></pre> 
<h3><a id="40__2781"></a>40. 查询球队积分</h3> 
<p><img src="https://images2.imgbox.com/0b/03/RY84T9G6_o.png" alt="在这里插入图片描述"><br> 你希望在所有比赛之后计算所有球队的比分。积分奖励方式如下:</p> 
<ul><li>如果球队赢了比赛(即比对手进更多的球)，就得 3 分。</li><li>如果双方打成平手(即，与对方得分相同)，则得 1 分。</li><li>如果球队输掉了比赛(例如，比对手少进球)，就 不得分 。<br> 编写解决方案，以找出每个队的 team_id，team_name 和 num_points。<br> 返回的结果根据 num_points 降序排序，如果有两队积分相同，那么这两队按 team_id 升序排序。<br> 返回结果格式如下。<br> <img src="https://images2.imgbox.com/af/ca/WmzPrH1k_o.png" alt="在这里插入图片描述"></li></ul> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Teams'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Teams
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Teams<span class="token punctuation">(</span>
  team_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> team_name     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Teams
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">10</span>     <span class="token punctuation">,</span><span class="token string">'Leetcode FC'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">20</span>     <span class="token punctuation">,</span><span class="token string">'NewYork FC'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">30</span>     <span class="token punctuation">,</span><span class="token string">'Atlanta FC'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">40</span>     <span class="token punctuation">,</span><span class="token string">'Chicago FC'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">50</span>     <span class="token punctuation">,</span><span class="token string">'Toronto FC'</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Matches'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Matches
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Matches<span class="token punctuation">(</span>
  match_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> host_team    <span class="token keyword">int</span>
<span class="token punctuation">,</span> guest_team   <span class="token keyword">int</span>
<span class="token punctuation">,</span> host_goals   <span class="token keyword">int</span>
<span class="token punctuation">,</span> guest_goals  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Matches
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">10</span>   <span class="token punctuation">,</span><span class="token number">20</span>    <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">30</span>   <span class="token punctuation">,</span><span class="token number">10</span>    <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">10</span>   <span class="token punctuation">,</span><span class="token number">50</span>    <span class="token punctuation">,</span> <span class="token number">5</span>    <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">20</span>   <span class="token punctuation">,</span><span class="token number">30</span>    <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token number">50</span>   <span class="token punctuation">,</span><span class="token number">30</span>    <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> host_goals <span class="token operator">&gt;</span> guest_goals  <span class="token keyword">then</span> <span class="token number">3</span>
<span class="token keyword">when</span> host_goals <span class="token operator">=</span> guest_goals  <span class="token keyword">then</span> <span class="token number">1</span>
<span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> host_point
<span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> host_goals <span class="token operator">&lt;</span> guest_goals  <span class="token keyword">then</span> <span class="token number">3</span>
<span class="token keyword">when</span> host_goals <span class="token operator">=</span> guest_goals  <span class="token keyword">then</span> <span class="token number">1</span>
<span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> guest_point
<span class="token keyword">from</span> Matches <span class="token punctuation">)</span>

<span class="token punctuation">,</span> T2 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> host_team <span class="token keyword">as</span> team_id    <span class="token punctuation">,</span>host_point <span class="token keyword">as</span> points <span class="token keyword">from</span> T
            <span class="token keyword">union</span> <span class="token keyword">all</span>
            <span class="token keyword">select</span> guest_team <span class="token punctuation">,</span>guest_point <span class="token keyword">from</span> T
<span class="token punctuation">)</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>team_id  <span class="token punctuation">,</span>a<span class="token punctuation">.</span>team_name<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> num_points
<span class="token keyword">from</span> Teams a
<span class="token keyword">left</span> <span class="token keyword">join</span> T2 B
<span class="token keyword">on</span> a<span class="token punctuation">.</span>team_id <span class="token operator">=</span> b<span class="token punctuation">.</span>team_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>team_id  <span class="token punctuation">,</span>a<span class="token punctuation">.</span>team_name
<span class="token keyword">order</span> <span class="token keyword">by</span> isnull<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token keyword">desc</span> <span class="token punctuation">,</span>team_id
</code></pre> 
<h3><a id="41__CEO__2853"></a>41. 向公司 CEO 汇报工作的所有人</h3> 
<p><img src="https://images2.imgbox.com/55/58/caJKltWA_o.png" alt="在这里插入图片描述"><br> 编写解决方案，找出所有直接或间接向公司 CEO 汇报工作的职工的 employee_id 。<br> 由于公司规模较小，经理之间的间接关系 不超过 3 个经理 。<br> 可以以 任何顺序 返回无重复项的结果。<br> 返回结果示例如下。<br> <img src="https://images2.imgbox.com/17/5a/7dUW6985_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employees'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employees
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employees<span class="token punctuation">(</span>
  employee_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> employee_name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> manager_id     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employees
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>     <span class="token punctuation">,</span><span class="token string">'Boss'</span>         <span class="token punctuation">,</span> <span class="token number">1</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>     <span class="token punctuation">,</span><span class="token string">'Alice'</span>        <span class="token punctuation">,</span> <span class="token number">3</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>     <span class="token punctuation">,</span><span class="token string">'Bob'</span>          <span class="token punctuation">,</span> <span class="token number">1</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>     <span class="token punctuation">,</span><span class="token string">'Daniel'</span>       <span class="token punctuation">,</span> <span class="token number">2</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span>     <span class="token punctuation">,</span><span class="token string">'Luis'</span>         <span class="token punctuation">,</span> <span class="token number">4</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>     <span class="token punctuation">,</span><span class="token string">'Jhon'</span>         <span class="token punctuation">,</span> <span class="token number">3</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>     <span class="token punctuation">,</span><span class="token string">'Angela'</span>       <span class="token punctuation">,</span> <span class="token number">8</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">77</span>    <span class="token punctuation">,</span><span class="token string">'Robert'</span>       <span class="token punctuation">,</span> <span class="token number">1</span>     <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> employee_id <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token punctuation">,</span>b<span class="token punctuation">.</span>manager_id  <span class="token keyword">as</span> L1BOSS<span class="token punctuation">,</span>c<span class="token punctuation">.</span>manager_id  <span class="token keyword">as</span> L2BOSS
<span class="token keyword">from</span> Employees  a
<span class="token keyword">left</span> <span class="token keyword">join</span> Employees  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>manager_id  <span class="token operator">=</span> b<span class="token punctuation">.</span>employee_id
<span class="token keyword">left</span> <span class="token keyword">join</span> Employees  c
<span class="token keyword">on</span> b<span class="token punctuation">.</span>manager_id  <span class="token operator">=</span> c<span class="token punctuation">.</span>employee_id <span class="token punctuation">)</span> a
<span class="token keyword">where</span> <span class="token punctuation">(</span>manager_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">or</span> L1BOSS <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">OR</span> L2BOSS  <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token operator">and</span> employee_id <span class="token operator">&lt;&gt;</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="42__2896"></a>42. 找到连续区间的开始和结束数字</h3> 
<p><img src="https://images2.imgbox.com/da/c2/VwoUqNbj_o.png" alt="在这里插入图片描述"><br> 编写解决方案，得到 Logs 表中的连续区间的开始数字和结束数字。<br> 返回结果表按照 start_id 排序。<br> 结果格式如下面的例子。<br> <img src="https://images2.imgbox.com/b5/dd/s1eC8Wls_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Logs'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span>  Logs
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Logs<span class="token punctuation">(</span>
    log_id        <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Logs
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

<span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>log_id<span class="token punctuation">)</span> <span class="token keyword">as</span> start_id   <span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>log_id<span class="token punctuation">)</span> <span class="token keyword">as</span> end_id
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token punctuation">,</span>log_id <span class="token operator">-</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> log_id<span class="token punctuation">)</span> <span class="token keyword">as</span> diff
<span class="token keyword">from</span> logs<span class="token punctuation">)</span> a
<span class="token keyword">group</span> <span class="token keyword">by</span> diff
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">min</span><span class="token punctuation">(</span>log_id<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="43__2930"></a>43. 不同性别每日分数总计</h3> 
<p><img src="https://images2.imgbox.com/bb/d4/CWyGkKFE_o.png" alt="在这里插入图片描述"><br> 编写解决方案统计每种性别在每一天的总分。<br> 返回按 gender 和 day 对查询结果 升序排序 的结果。<br> 查询结果格式的示例如下。<br> <img src="https://images2.imgbox.com/33/c0/3vkuzozI_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Scores'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Scores
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Scores<span class="token punctuation">(</span>
 player_name   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> gender        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token keyword">day</span>            <span class="token keyword">date</span>
<span class="token punctuation">,</span> score_points   <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Scores
<span class="token keyword">values</span>
  <span class="token punctuation">(</span><span class="token string">'Aron'</span>        <span class="token punctuation">,</span><span class="token string">'F'</span> <span class="token punctuation">,</span>     <span class="token string">'2020-01-01'</span> <span class="token punctuation">,</span><span class="token number">17</span>   <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Alice'</span>       <span class="token punctuation">,</span><span class="token string">'F'</span> <span class="token punctuation">,</span>     <span class="token string">'2020-01-07'</span> <span class="token punctuation">,</span><span class="token number">23</span>   <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Bajrang'</span>     <span class="token punctuation">,</span><span class="token string">'M'</span> <span class="token punctuation">,</span>     <span class="token string">'2020-01-07'</span> <span class="token punctuation">,</span><span class="token number">7</span>    <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Khali'</span>       <span class="token punctuation">,</span><span class="token string">'M'</span> <span class="token punctuation">,</span>     <span class="token string">'2019-12-25'</span> <span class="token punctuation">,</span><span class="token number">11</span>   <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Slaman'</span>      <span class="token punctuation">,</span><span class="token string">'M'</span> <span class="token punctuation">,</span>     <span class="token string">'2019-12-30'</span> <span class="token punctuation">,</span><span class="token number">13</span>   <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Joe'</span>         <span class="token punctuation">,</span><span class="token string">'M'</span> <span class="token punctuation">,</span>     <span class="token string">'2019-12-31'</span> <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Jose'</span>        <span class="token punctuation">,</span><span class="token string">'M'</span> <span class="token punctuation">,</span>     <span class="token string">'2019-12-18'</span> <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Priya'</span>       <span class="token punctuation">,</span><span class="token string">'F'</span> <span class="token punctuation">,</span>     <span class="token string">'2019-12-31'</span> <span class="token punctuation">,</span><span class="token number">23</span>   <span class="token punctuation">)</span>
 <span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Priyanka'</span>    <span class="token punctuation">,</span><span class="token string">'F'</span> <span class="token punctuation">,</span>     <span class="token string">'2019-12-30'</span> <span class="token punctuation">,</span><span class="token number">17</span>   <span class="token punctuation">)</span>
 <span class="token comment">--查询</span>
<span class="token keyword">select</span> gender<span class="token punctuation">,</span><span class="token keyword">day</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>score_points<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> gender <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">day</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total
<span class="token keyword">from</span> scores
</code></pre> 
<h3><a id="44__2964"></a>44. 活动参与者</h3> 
<p><img src="https://images2.imgbox.com/d9/7b/FpHQ81Qp_o.png" alt="在这里插入图片描述"><br> 找出那些既没有最多，也没有最少参与者的活动的名字。<br> Activities 表中的任意活动都有在 Friends 中参与过。<br> 可以以 任何顺序 返回结果。<br> 下面是返回结果格式的例子。<br> <img src="https://images2.imgbox.com/81/88/4J4uiMOb_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Friends'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span>  Friends
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Friends <span class="token punctuation">(</span>
   id            <span class="token keyword">int</span>
<span class="token punctuation">,</span> name          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
 <span class="token punctuation">,</span>activity       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Friends
<span class="token keyword">values</span>

 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token string">'Jonathan D.'</span> <span class="token punctuation">,</span> <span class="token string">'Eating'</span>        <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token string">'Jade W.'</span>     <span class="token punctuation">,</span> <span class="token string">'Singing'</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token string">'Victor J.'</span>   <span class="token punctuation">,</span> <span class="token string">'Singing'</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span> <span class="token string">'Elvis Q.'</span>    <span class="token punctuation">,</span> <span class="token string">'Eating'</span>        <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span> <span class="token string">'Daniel A.'</span>   <span class="token punctuation">,</span> <span class="token string">'Eating'</span>        <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>    <span class="token punctuation">,</span> <span class="token string">'Bob B.'</span>      <span class="token punctuation">,</span> <span class="token string">'Horse Riding'</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Activities'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Activities
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Activities<span class="token punctuation">(</span>
 id             <span class="token keyword">int</span>
 <span class="token punctuation">,</span>name          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Activities
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'Eating'</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'Singing'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'Horse Riding'</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> activity <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span>  a<span class="token punctuation">.</span>name  <span class="token keyword">as</span> activity
<span class="token punctuation">,</span> rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> R1
<span class="token punctuation">,</span> rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  <span class="token keyword">desc</span><span class="token punctuation">)</span>  <span class="token keyword">as</span> R2
<span class="token keyword">from</span> Activities  a
<span class="token keyword">left</span> <span class="token keyword">join</span> Friends  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>name <span class="token operator">=</span> b<span class="token punctuation">.</span>activity
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>name <span class="token punctuation">)</span> a
<span class="token keyword">where</span> R1 <span class="token operator">&lt;&gt;</span> <span class="token number">1</span> <span class="token operator">and</span> R2 <span class="token operator">&lt;&gt;</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="45__3016"></a>45. 顾客的可信联系人数量</h3> 
<p><img src="https://images2.imgbox.com/d6/31/l80OOg4H_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3a/84/fSbhVGDS_o.png" alt="在这里插入图片描述"><br> 为每张发票 invoice_id 编写一个查询方案以查找以下内容：</p> 
<ul><li>customer_name：与发票相关的顾客名称。</li><li>price：发票的价格。</li><li>contacts_cnt：该顾客的联系人数量</li><li>trusted_contacts_cnt：可信联系人的数量：既是该顾客的联系人又是商店顾客的联系人数量（即：可信联系人的电子邮件存在于 Customers 表中）。<br> 返回结果按照 invoice_id 排序。<br> 结果的格式如下例所示。<br> <img src="https://images2.imgbox.com/43/16/EBkdhBaE_o.png" alt="在这里插入图片描述"></li></ul> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Customers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Customers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Customers<span class="token punctuation">(</span>
  customer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> customer_name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> email          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Customers
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'Alice'</span>        <span class="token punctuation">,</span><span class="token string">'alice@leetcode.com'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token string">'Bob'</span>          <span class="token punctuation">,</span><span class="token string">'bob@leetcode.com'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">13</span>     <span class="token punctuation">,</span><span class="token string">'John'</span>         <span class="token punctuation">,</span><span class="token string">'john@leetcode.com'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>      <span class="token punctuation">,</span><span class="token string">'Alex'</span>         <span class="token punctuation">,</span><span class="token string">'alex@leetcode.com'</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Contacts'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Contacts
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Contacts<span class="token punctuation">(</span>
      user_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> contact_name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> contact_email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Contacts
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'Bob'</span>      <span class="token punctuation">,</span><span class="token string">'bob@leetcode.com'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'John'</span>     <span class="token punctuation">,</span><span class="token string">'john@leetcode.com'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'Jal'</span>      <span class="token punctuation">,</span><span class="token string">'jal@leetcode.com'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'Omar'</span>     <span class="token punctuation">,</span><span class="token string">'omar@leetcode.com'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'Meir'</span>     <span class="token punctuation">,</span><span class="token string">'meir@leetcode.com'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>   <span class="token punctuation">,</span><span class="token string">'Alice'</span>    <span class="token punctuation">,</span><span class="token string">'alice@leetcode.com'</span> <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Invoices'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Invoices
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Invoices<span class="token punctuation">(</span>

  invoice_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> price        <span class="token keyword">int</span>
<span class="token punctuation">,</span> user_id      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Invoices
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">77</span>   <span class="token punctuation">,</span><span class="token number">100</span> <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">88</span>   <span class="token punctuation">,</span><span class="token number">200</span> <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">99</span>   <span class="token punctuation">,</span><span class="token number">300</span> <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">66</span>   <span class="token punctuation">,</span><span class="token number">400</span> <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">55</span>   <span class="token punctuation">,</span><span class="token number">500</span> <span class="token punctuation">,</span><span class="token number">13</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">44</span>   <span class="token punctuation">,</span><span class="token number">60</span>  <span class="token punctuation">,</span><span class="token number">6</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>invoice_id<span class="token punctuation">,</span>b<span class="token punctuation">.</span>customer_name<span class="token punctuation">,</span>a<span class="token punctuation">.</span>price
<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>c<span class="token punctuation">.</span>contacts_cnt<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> contacts_cnt
<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>d<span class="token punctuation">.</span>trusted_contacts_cnt <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> trusted_contacts_cnt
<span class="token keyword">from</span>  Invoices a
<span class="token keyword">left</span> <span class="token keyword">join</span> Customers  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id  <span class="token operator">=</span> b<span class="token punctuation">.</span>customer_id
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> user_id<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> contacts_cnt  <span class="token keyword">from</span> Contacts
            <span class="token keyword">group</span> <span class="token keyword">by</span> user_id <span class="token punctuation">)</span> c
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> c<span class="token punctuation">.</span>user_id
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> user_id<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> trusted_contacts_cnt
             <span class="token keyword">from</span> Contacts
             <span class="token keyword">where</span> contact_email   <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> email <span class="token keyword">from</span> Customers<span class="token punctuation">)</span>
                <span class="token keyword">group</span> <span class="token keyword">by</span> user_id  <span class="token punctuation">)</span> d
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> d<span class="token punctuation">.</span>user_id
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>invoice_id
</code></pre> 
<h3><a id="46_A_B_C__3098"></a>46. 购买了产品A 和产品B 却没有购买产品C 的顾客</h3> 
<p><img src="https://images2.imgbox.com/d6/a9/fXWT3kRE_o.png" alt="在这里插入图片描述"><br> 请你编写解决方案，报告购买了产品 “A”，“B” 但没有购买产品 “C” 的客户的 customer_id 和 customer_name，因为我们想推荐他们购买这样的产品。<br> 返回按 customer_id 排序 的结果表。<br> 返回结果格式如下所示。<br> <img src="https://images2.imgbox.com/dc/5e/jHlrwbXS_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Customers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Customers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Customers <span class="token punctuation">(</span>
 customer_id         <span class="token keyword">int</span>
<span class="token punctuation">,</span>customer_name       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Customers
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'Daniel'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'Diana'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token punctuation">,</span><span class="token string">'Elizabeth'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token punctuation">,</span><span class="token string">'Jhon'</span>      <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span>  Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders<span class="token punctuation">(</span>
      order_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> customer_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> product_name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">10</span>   <span class="token punctuation">,</span>  <span class="token number">1</span>  <span class="token punctuation">,</span>  <span class="token string">'A'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span>   <span class="token punctuation">,</span>  <span class="token number">1</span>  <span class="token punctuation">,</span>  <span class="token string">'B'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">30</span>   <span class="token punctuation">,</span>  <span class="token number">1</span>  <span class="token punctuation">,</span>  <span class="token string">'D'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">40</span>   <span class="token punctuation">,</span>  <span class="token number">1</span>  <span class="token punctuation">,</span>  <span class="token string">'C'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">50</span>   <span class="token punctuation">,</span>  <span class="token number">2</span>  <span class="token punctuation">,</span>  <span class="token string">'A'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">60</span>   <span class="token punctuation">,</span>  <span class="token number">3</span>  <span class="token punctuation">,</span>  <span class="token string">'A'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">70</span>   <span class="token punctuation">,</span>  <span class="token number">3</span>  <span class="token punctuation">,</span>  <span class="token string">'B'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">80</span>   <span class="token punctuation">,</span>  <span class="token number">3</span>  <span class="token punctuation">,</span>  <span class="token string">'D'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">90</span>   <span class="token punctuation">,</span>  <span class="token number">4</span>  <span class="token punctuation">,</span>  <span class="token string">'C'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--需要考虑到比如顾客3 买了产品A 两次，但是没有买B 也没有买C 对的情况</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> customer_id<span class="token punctuation">,</span>customer_name
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> Product_name <span class="token operator">=</span><span class="token string">'A'</span> <span class="token operator">OR</span>  Product_name <span class="token operator">=</span><span class="token string">'B'</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span> <span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> S1
<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> Product_name <span class="token operator">=</span> <span class="token string">'c'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> S2
<span class="token punctuation">,</span>b<span class="token punctuation">.</span>customer_name
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> Product_Name<span class="token punctuation">,</span> customer_id <span class="token keyword">from</span> orders <span class="token punctuation">)</span> a
<span class="token keyword">left</span> <span class="token keyword">join</span> Customers  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> b<span class="token punctuation">.</span>customer_id <span class="token punctuation">)</span> a
<span class="token keyword">where</span> S1 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">AND</span> S2 <span class="token operator">&lt;&gt;</span><span class="token number">1</span>

<span class="token comment">--方法2</span>
<span class="token keyword">SELECT</span> a<span class="token punctuation">.</span>customer_id <span class="token keyword">as</span> customer_id<span class="token punctuation">,</span> customer_name
<span class="token keyword">FROM</span> Customers a
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> customer_id
              <span class="token keyword">FROM</span> Orders
              <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customer_id
              <span class="token keyword">HAVING</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> product_name<span class="token operator">=</span><span class="token string">'A'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
                <span class="token operator">and</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> product_name<span class="token operator">=</span><span class="token string">'B'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
                <span class="token operator">and</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> product_name<span class="token operator">=</span><span class="token string">'C'</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>  <span class="token punctuation">)</span> b
<span class="token keyword">ON</span> a<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> b<span class="token punctuation">.</span>customer_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span>customer_id

</code></pre> 
<h3><a id="47__3168"></a>47. 计算布尔表达式的值</h3> 
<p><img src="https://images2.imgbox.com/38/03/S2yAWMko_o.png" alt="在这里插入图片描述"><br> 计算表 Expressions 中的布尔表达式。<br> 返回的结果表 无顺序要求 。<br> 结果格式如下例所示。<br> <img src="https://images2.imgbox.com/91/5b/rGPxH1sC_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Variables'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Variables
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Variables<span class="token punctuation">(</span>
 name           <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token keyword">value</span>          <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Variables
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token string">'x'</span><span class="token punctuation">,</span>    <span class="token number">66</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'y'</span><span class="token punctuation">,</span>    <span class="token number">77</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Expressions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Expressions
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Expressions<span class="token punctuation">(</span>
 left_operand   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>operator       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>right_operand  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Expressions
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token string">'x'</span><span class="token punctuation">,</span>  <span class="token string">'&gt;'</span><span class="token punctuation">,</span><span class="token string">'y'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'x'</span><span class="token punctuation">,</span>  <span class="token string">'&lt;'</span><span class="token punctuation">,</span><span class="token string">'y'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'x'</span><span class="token punctuation">,</span>  <span class="token string">'='</span><span class="token punctuation">,</span><span class="token string">'y'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'y'</span><span class="token punctuation">,</span>  <span class="token string">'&gt;'</span><span class="token punctuation">,</span><span class="token string">'x'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'y'</span><span class="token punctuation">,</span>  <span class="token string">'&lt;'</span><span class="token punctuation">,</span><span class="token string">'x'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'x'</span><span class="token punctuation">,</span>  <span class="token string">'='</span><span class="token punctuation">,</span><span class="token string">'x'</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

<span class="token keyword">select</span> left_operand <span class="token punctuation">,</span>operator <span class="token punctuation">,</span>right_operand
<span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> a<span class="token punctuation">.</span>operator  <span class="token operator">=</span> <span class="token string">'&lt;'</span> <span class="token operator">and</span>   b<span class="token punctuation">.</span><span class="token keyword">Value</span> <span class="token operator">&lt;</span> c<span class="token punctuation">.</span><span class="token keyword">Value</span>  <span class="token keyword">then</span> <span class="token string">'true'</span>
<span class="token keyword">when</span>  a<span class="token punctuation">.</span>operator  <span class="token operator">=</span> <span class="token string">'&gt;'</span> <span class="token operator">and</span>   b<span class="token punctuation">.</span><span class="token keyword">Value</span> <span class="token operator">&gt;</span> c<span class="token punctuation">.</span><span class="token keyword">Value</span>  <span class="token keyword">then</span> <span class="token string">'true'</span>
<span class="token keyword">when</span>  a<span class="token punctuation">.</span>operator  <span class="token operator">=</span> <span class="token string">'='</span> <span class="token operator">and</span>   b<span class="token punctuation">.</span><span class="token keyword">Value</span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token keyword">Value</span>  <span class="token keyword">then</span> <span class="token string">'true'</span>
<span class="token keyword">else</span> <span class="token string">'false'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> <span class="token keyword">value</span>
 <span class="token keyword">from</span> expressions   a
<span class="token keyword">left</span> <span class="token keyword">join</span> Variables b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>left_operand <span class="token operator">=</span> b<span class="token punctuation">.</span>name
<span class="token keyword">left</span> <span class="token keyword">join</span> Variables c
<span class="token keyword">on</span> a<span class="token punctuation">.</span>right_operand  <span class="token operator">=</span> c<span class="token punctuation">.</span>name

</code></pre> 
<h3><a id="48__3221"></a>48. 可以放心投资的国家</h3> 
<p><img src="https://images2.imgbox.com/15/74/bfWYr1vh_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bb/34/TxUoC1SL_o.png" alt="在这里插入图片描述"><br> 一家电信公司想要投资新的国家。该公司想要投资的国家是: 该国的平均通话时长要严格地大于全球平均通话时长。<br> 写一个解决方案, 找到所有该公司可以投资的国家。<br> 返回的结果表 无顺序要求。<br> 结果格式如下例所示。</p> 
<p><img src="https://images2.imgbox.com/e3/5e/13KXnNx5_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dc/0f/RE1tl25O_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Person'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Person
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Person<span class="token punctuation">(</span>
  id              <span class="token keyword">int</span>
<span class="token punctuation">,</span> name            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> phone_number    <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Person
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">,</span><span class="token string">'Jonathan'</span> <span class="token punctuation">,</span><span class="token string">'051-1234567'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">12</span><span class="token punctuation">,</span><span class="token string">'Elvis'</span>    <span class="token punctuation">,</span><span class="token string">'051-7654321'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'Moncef'</span>   <span class="token punctuation">,</span><span class="token string">'212-1234567'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'Maroua'</span>   <span class="token punctuation">,</span><span class="token string">'212-6523651'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span> <span class="token punctuation">,</span><span class="token string">'Meir'</span>     <span class="token punctuation">,</span><span class="token string">'972-1234567'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span> <span class="token punctuation">,</span><span class="token string">'Rachel'</span>   <span class="token punctuation">,</span><span class="token string">'972-0011100'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Country'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Country
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Country<span class="token punctuation">(</span>
  name           <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> country_code   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Country
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token string">'Peru'</span>     <span class="token punctuation">,</span><span class="token string">'051'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Israel'</span>   <span class="token punctuation">,</span><span class="token string">'972'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Morocco'</span>  <span class="token punctuation">,</span><span class="token string">'212'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Germany'</span>  <span class="token punctuation">,</span><span class="token string">'049'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Ethiopia'</span> <span class="token punctuation">,</span><span class="token string">'251'</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Calls'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Calls
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Calls<span class="token punctuation">(</span>
 caller_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>callee_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>duration     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Calls
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">9</span>    <span class="token punctuation">,</span><span class="token number">33</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">9</span>    <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">59</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">12</span>   <span class="token punctuation">,</span><span class="token number">102</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">12</span>   <span class="token punctuation">,</span><span class="token number">330</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">12</span>   <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">5</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span> <span class="token number">9</span>    <span class="token punctuation">,</span><span class="token number">13</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>    <span class="token punctuation">,</span> <span class="token number">7</span>    <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">7</span>    <span class="token punctuation">,</span><span class="token number">7</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T <span class="token keyword">AS</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> caller_id  <span class="token punctuation">,</span> duration  <span class="token keyword">from</span> Calls
 <span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">SELECT</span> callee_id  <span class="token punctuation">,</span> duration  <span class="token keyword">from</span> Calls
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> country   <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> c<span class="token punctuation">.</span>country_code<span class="token punctuation">,</span> c<span class="token punctuation">.</span>name <span class="token keyword">as</span> country
<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> c<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">as</span> C_AVG
<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> a_AVG
<span class="token keyword">from</span> T a
<span class="token keyword">left</span> <span class="token keyword">join</span> Person b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>caller_id <span class="token operator">=</span> b<span class="token punctuation">.</span>id
<span class="token keyword">left</span> <span class="token keyword">join</span> Country  c
<span class="token keyword">on</span> <span class="token keyword">left</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>phone_number<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">=</span> c<span class="token punctuation">.</span>country_code <span class="token punctuation">)</span>  a
<span class="token keyword">where</span> C_AVG <span class="token operator">&gt;</span> a_avg
</code></pre> 
<h3><a id="49__3305"></a>49. 最近的三笔订单</h3> 
<p><img src="https://images2.imgbox.com/03/b0/T9ZfTXFu_o.png" alt="在这里插入图片描述"><br> 写一个解决方案，找到每个用户的最近三笔订单。如果用户的订单少于 3 笔，则返回他的全部订单。<br> 返回的结果按照 customer_name 升序 排列。如果有相同的排名，则按照 customer_id 升序 排列。如果排名还有相同，则按照 order_date 降序 排列。<br> 结果格式如下例所示：<br> <img src="https://images2.imgbox.com/74/84/ABuqnXid_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/46/d3/hA1Nd1fo_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Customers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Customers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Customers<span class="token punctuation">(</span>
 customer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>name           <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Customers
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token string">'Winston'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token string">'Jonathan'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span><span class="token string">'Annabelle'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>     <span class="token punctuation">,</span><span class="token string">'Marwan'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>     <span class="token punctuation">,</span><span class="token string">'Khaled'</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders<span class="token punctuation">(</span>
   order_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> order_date    <span class="token keyword">date</span>
<span class="token punctuation">,</span> customer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> cost           <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2020-07-31'</span><span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">30</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2020-07-30'</span><span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">40</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2020-07-31'</span><span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">70</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'2020-07-29'</span><span class="token punctuation">,</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token number">100</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2020-06-10'</span><span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">1010</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'2020-08-01'</span><span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">102</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span><span class="token string">'2020-08-01'</span><span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">111</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>    <span class="token punctuation">,</span><span class="token string">'2020-08-03'</span><span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">99</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>    <span class="token punctuation">,</span><span class="token string">'2020-08-07'</span><span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">32</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">10</span>   <span class="token punctuation">,</span><span class="token string">'2020-07-15'</span><span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span>  customer_name <span class="token punctuation">,</span>customer_id <span class="token punctuation">,</span> order_id <span class="token punctuation">,</span> order_date
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token punctuation">,</span>b<span class="token punctuation">.</span>name <span class="token keyword">as</span> customer_name
<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>customer_id <span class="token keyword">order</span> <span class="token keyword">by</span> order_date <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> Orders a
<span class="token keyword">left</span> <span class="token keyword">join</span> Customers b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> b<span class="token punctuation">.</span>customer_id <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk<span class="token operator">&lt;=</span><span class="token number">3</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> customer_name <span class="token punctuation">,</span>customer_id <span class="token keyword">asc</span><span class="token punctuation">,</span>order_date <span class="token keyword">desc</span>

</code></pre> 
<h3><a id="50__3366"></a>50. 每件商品的最新订单</h3> 
<p><img src="https://images2.imgbox.com/45/88/fXhji9PN_o.png" alt="在这里插入图片描述"><br> 写一个解决方案, 找到每件商品的最新订单(可能有多个).<br> 返回的结果以 product_name 升序排列, 如果有排序相同, 再以 product_id 升序排列. 如果还有排序相同, 再以 order_id 升序排列.<br> 查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/6c/0f/IqNkm8Uf_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8e/e6/mv4norj4_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql">
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Customers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Customers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Customers<span class="token punctuation">(</span>
  customer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> name           <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Customers
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'Winston'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'Jonathan'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Annabelle'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Marwan'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'Khaled'</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders <span class="token punctuation">(</span>
   order_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> order_date     <span class="token keyword">date</span>
<span class="token punctuation">,</span> customer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> product_id     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>

 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2020-07-31'</span><span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2020-07-30'</span><span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2020-08-29'</span><span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'2020-07-29'</span><span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2020-06-10'</span><span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'2020-08-01'</span><span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span><span class="token string">'2020-08-01'</span><span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>    <span class="token punctuation">,</span><span class="token string">'2020-08-03'</span><span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>    <span class="token punctuation">,</span><span class="token string">'2020-08-07'</span><span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">10</span>   <span class="token punctuation">,</span><span class="token string">'2020-07-15'</span><span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Products
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Products<span class="token punctuation">(</span>
  product_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> product_name   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> price          <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Products
<span class="token keyword">values</span>


<span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'keyboard'</span>    <span class="token punctuation">,</span><span class="token number">120</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'mouse'</span>       <span class="token punctuation">,</span><span class="token number">80</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'screen'</span>      <span class="token punctuation">,</span><span class="token number">600</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'hard disk'</span>   <span class="token punctuation">,</span><span class="token number">450</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> product_name <span class="token punctuation">,</span> product_id <span class="token punctuation">,</span> order_id <span class="token punctuation">,</span> order_date
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>product_name
<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>product_id  <span class="token keyword">order</span> <span class="token keyword">by</span> order_date <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> orders a
<span class="token keyword">left</span> <span class="token keyword">join</span> Products b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>product_id <span class="token operator">=</span> b<span class="token punctuation">.</span>product_id<span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span><span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> product_name <span class="token keyword">asc</span> <span class="token punctuation">,</span>product_id <span class="token keyword">asc</span> <span class="token punctuation">,</span>order_id <span class="token keyword">asc</span>

</code></pre> 
<h3><a id="51__3444"></a>51. 银行账户概要</h3> 
<p><img src="https://images2.imgbox.com/19/c4/qKupcBZ6_o.png" alt="在这里插入图片描述"><br> 力扣银行 (LCB) 帮助程序员们完成虚拟支付。我们的银行在表 Transaction 中记录每条交易信息，我们要查询每个用户的当前余额，并检查他们是否已透支（当前额度小于 0）。</p> 
<p>编写解决方案报告：</p> 
<ul><li>user_id 用户 ID</li><li>user_name 用户名</li><li>credit 完成交易后的余额</li><li>credit_limit_breached 检查是否透支 （“Yes” 或 “No”）<br> 以任意顺序返回结果表。</li></ul> 
<p>结果格式见如下所示。<br> <img src="https://images2.imgbox.com/29/75/DRBNkdTx_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Users
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Users<span class="token punctuation">(</span>
 user_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> user_name    <span class="token keyword">varchar</span><span class="token punctuation">(</span> <span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> credit      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Users
<span class="token keyword">values</span>

 <span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'Moustafa'</span>    <span class="token punctuation">,</span> <span class="token number">100</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'Jonathan'</span>    <span class="token punctuation">,</span> <span class="token number">200</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Winston'</span>     <span class="token punctuation">,</span> <span class="token number">10000</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Luis'</span>        <span class="token punctuation">,</span> <span class="token number">800</span>     <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Transactions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span><span class="token punctuation">(</span>

 trans_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span>paid_by       <span class="token keyword">int</span>
<span class="token punctuation">,</span>paid_to       <span class="token keyword">int</span>
<span class="token punctuation">,</span>amount        <span class="token keyword">int</span>
<span class="token punctuation">,</span>transacted_on <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">Transactions</span>
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">400</span> <span class="token punctuation">,</span><span class="token string">'2020-08-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">500</span> <span class="token punctuation">,</span><span class="token string">'2020-08-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">200</span> <span class="token punctuation">,</span><span class="token string">'2020-08-03'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T <span class="token keyword">AS</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> paid_by  <span class="token keyword">as</span> user_id  <span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">*</span>amount <span class="token keyword">as</span> amount
<span class="token keyword">from</span> <span class="token keyword">Transactions</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> paid_to<span class="token punctuation">,</span>amount
<span class="token keyword">from</span> <span class="token keyword">Transactions</span> <span class="token punctuation">)</span>

<span class="token keyword">select</span> a<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span> a<span class="token punctuation">.</span>user_name
     <span class="token punctuation">,</span>a<span class="token punctuation">.</span>credit <span class="token operator">+</span> isnull<span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>AMOUNT<span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> credit
<span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> a<span class="token punctuation">.</span>credit <span class="token operator">+</span> isnull<span class="token punctuation">(</span><span class="token function">SUM</span><span class="token punctuation">(</span>AMOUNT<span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'Yes'</span>
<span class="token keyword">else</span> <span class="token string">'No'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> credit_limit_breached
<span class="token keyword">FROM</span> Users a
<span class="token keyword">left</span> <span class="token keyword">join</span> t b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> a<span class="token punctuation">.</span>user_name  <span class="token punctuation">,</span>a<span class="token punctuation">.</span>credit
</code></pre> 
<h3><a id="52__3511"></a>52. 每位顾客最经常订购的商品</h3> 
<p><img src="https://images2.imgbox.com/66/37/3i6Dk6Pk_o.png" alt="在这里插入图片描述"><br> 写一个解决方案，找到每一个顾客最经常订购的商品。<br> 结果表单应该有每一位至少下过一次单的顾客 customer_id , 他最经常订购的商品的 product_id 和 product_name。<br> 返回结果 没有顺序要求。<br> 查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/a6/f4/XdVuFs1v_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c8/b4/7JePSgQE_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Customers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Customers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Customers<span class="token punctuation">(</span>
customer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Customers
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'Alice'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'Bob'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'Tom'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'Jerry'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token string">'John'</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders<span class="token punctuation">(</span>
   order_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> order_date     <span class="token keyword">date</span>
<span class="token punctuation">,</span> customer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> product_id     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span>     <span class="token punctuation">,</span><span class="token string">'2020-07-31'</span><span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>     <span class="token punctuation">,</span><span class="token string">'2020-07-30'</span><span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>     <span class="token punctuation">,</span><span class="token string">'2020-08-29'</span><span class="token punctuation">,</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>     <span class="token punctuation">,</span><span class="token string">'2020-07-29'</span><span class="token punctuation">,</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span>     <span class="token punctuation">,</span><span class="token string">'2020-06-10'</span><span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span>     <span class="token punctuation">,</span><span class="token string">'2020-08-01'</span><span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span>     <span class="token punctuation">,</span><span class="token string">'2020-08-01'</span><span class="token punctuation">,</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>     <span class="token punctuation">,</span><span class="token string">'2020-08-03'</span><span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>     <span class="token punctuation">,</span><span class="token string">'2020-08-07'</span><span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span>    <span class="token punctuation">,</span><span class="token string">'2020-07-15'</span><span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Products
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Products<span class="token punctuation">(</span>
  product_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> product_name   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> price         <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Products
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'keyboard'</span>    <span class="token punctuation">,</span><span class="token number">120</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'mouse'</span>       <span class="token punctuation">,</span><span class="token number">80</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'screen'</span>      <span class="token punctuation">,</span><span class="token number">600</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'hard disk'</span>   <span class="token punctuation">,</span><span class="token number">450</span>  <span class="token punctuation">)</span>
GO
<span class="token comment">--查询</span>
<span class="token keyword">select</span> customer_id <span class="token punctuation">,</span> product_id <span class="token punctuation">,</span>product_name <span class="token keyword">from</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> customer_id <span class="token keyword">order</span> <span class="token keyword">by</span> cnt <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>customer_id <span class="token punctuation">,</span>a<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span>b<span class="token punctuation">.</span>Product_Name<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> orders a
<span class="token keyword">left</span> <span class="token keyword">join</span> Products b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>Product_id <span class="token operator">=</span> b<span class="token punctuation">.</span>Product_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>customer_id <span class="token punctuation">,</span>a<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span>b<span class="token punctuation">.</span>Product_Name<span class="token punctuation">)</span> a <span class="token punctuation">)</span>a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="53_ID_3588"></a>53. 找到遗失的ID</h3> 
<p><img src="https://images2.imgbox.com/e3/84/lqwgQKiw_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案, 找到所有遗失的顾客 id。遗失的顾客 id 是指那些不在 Customers 表中, 值却处于 1 和表中 最大 customer_id 之间的 id.<br> 注意: 最大的 customer_id 值不会超过 100.<br> 返回结果按 ids 升序 排列<br> 查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/f8/b9/4VTiddwC_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Customers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Customers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Customers<span class="token punctuation">(</span>
 customer_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> customer_name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Customers
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'Alice'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Bob'</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'Charlie'</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--方法1 </span>
<span class="token keyword">select</span> number <span class="token keyword">as</span> ids
<span class="token keyword">from</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>spt_values a
<span class="token keyword">where</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'P'</span>
<span class="token operator">and</span>  NUMBER <span class="token operator">BETWEEN</span> <span class="token number">1</span>
    <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">max</span><span class="token punctuation">(</span>customer_id <span class="token punctuation">)</span> <span class="token keyword">from</span> customers <span class="token punctuation">)</span>
<span class="token operator">and</span>  <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> customers  b
<span class="token keyword">where</span> a<span class="token punctuation">.</span>number <span class="token operator">=</span> b<span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span>

<span class="token comment">--方法2</span>
<span class="token keyword">with</span> <span class="token keyword">temp</span><span class="token punctuation">(</span>customer_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">as</span> customer_id
    <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token keyword">select</span> customer_id<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">from</span> <span class="token keyword">temp</span> <span class="token keyword">where</span> customer_id<span class="token operator">&lt;</span><span class="token number">100</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> customer_id <span class="token keyword">as</span> ids
<span class="token keyword">from</span> <span class="token keyword">temp</span> 
<span class="token keyword">where</span> customer_id <span class="token operator">not</span> <span class="token operator">in</span><span class="token punctuation">(</span><span class="token keyword">select</span> customer_id <span class="token keyword">from</span> customers<span class="token punctuation">)</span> <span class="token operator">and</span> customer_id<span class="token operator">&lt;=</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>customer_id<span class="token punctuation">)</span> <span class="token keyword">from</span> customers <span class="token punctuation">)</span>




</code></pre> 
<h3><a id="54__3637"></a>54. 两人之间的通话次数</h3> 
<p><img src="https://images2.imgbox.com/f8/50/SSoi1KH9_o.png" alt="在这里插入图片描述"><br> 编写解决方案，统计每一对用户 (person1, person2) 之间的通话次数和通话总时长，其中 person1 &lt; person2 。<br> 以 任意顺序 返回结果表。<br> 返回结果格式如下示例所示。<br> <img src="https://images2.imgbox.com/08/48/Fo3iJWf8_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Calls'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Calls
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Calls<span class="token punctuation">(</span>
  from_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>to_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span> duration     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Calls
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">59</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">11</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">20</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">100</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">200</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">200</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">499</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> from_id  <span class="token keyword">as</span> person1 <span class="token punctuation">,</span>to_id <span class="token keyword">as</span> person2<span class="token punctuation">,</span>duration <span class="token keyword">from</span> calls
<span class="token keyword">where</span> from_id <span class="token operator">&lt;</span> to_id
    <span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> to_id<span class="token punctuation">,</span>from_id <span class="token punctuation">,</span>duration <span class="token keyword">from</span> calls
    <span class="token keyword">where</span> from_id <span class="token operator">&gt;</span> to_id
<span class="token punctuation">)</span>
<span class="token keyword">select</span> person1  <span class="token punctuation">,</span>person2<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> call_count
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token keyword">as</span> total_duration 
<span class="token keyword">from</span> T
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> person1  <span class="token punctuation">,</span>person2

</code></pre> 
<h3><a id="55__3681"></a>55. 访问日期之间最大的空档期</h3> 
<p><img src="https://images2.imgbox.com/d1/57/ZbgYsy9i_o.png" alt="在这里插入图片描述"><br> 假设今天的日期是 ‘2021-1-1’ 。<br> 编写解决方案，对于每个 user_id ，求出每次访问及其下一个访问（若该次访问是最后一次，则为今天）之间最大的空档期天数 window 。<br> 返回结果表，按用户编号 user_id 排序。<br> 结果格式如下示例所示：<br> <img src="https://images2.imgbox.com/6d/68/y9SXKlvE_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql">
<span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'UserVisits'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> UserVisits
go
<span class="token keyword">create</span> <span class="token keyword">table</span>
    UserVisits<span class="token punctuation">(</span>
 user_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> visit_date  <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> UserVisits
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2020-11-28'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2020-10-20'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2020-12-3'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'2020-10-5'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'2020-12-9'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">,</span><span class="token string">'2020-11-11'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
            <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> visit_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
            <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> UserVisits
                  <span class="token keyword">union</span> <span class="token keyword">all</span>
                  <span class="token keyword">select</span> <span class="token keyword">distinct</span> user_id<span class="token punctuation">,</span><span class="token string">'2021-1-1'</span>
                  <span class="token keyword">from</span> UserVisits <span class="token punctuation">)</span> a <span class="token punctuation">)</span>
<span class="token keyword">select</span> A<span class="token punctuation">.</span>user_id
     <span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>DATEDIFF<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>VISIT_DATE<span class="token punctuation">,</span>a<span class="token punctuation">.</span>VISIT_DATE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> biggest_window
<span class="token keyword">from</span> T  A
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> T B
<span class="token keyword">ON</span> A<span class="token punctuation">.</span>USER_ID <span class="token operator">=</span> B<span class="token punctuation">.</span>USER_ID <span class="token operator">AND</span> A<span class="token punctuation">.</span>RNK <span class="token operator">=</span> B<span class="token punctuation">.</span>RNK<span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id
<span class="token comment">--方法2</span>

<span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token keyword">AS</span> biggest_window
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> visit_date
     <span class="token punctuation">,</span> DATEDIFF<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span>visit_date<span class="token punctuation">,</span> LEAD<span class="token punctuation">(</span>visit_date<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2021-01-01'</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> visit_date<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> diff
<span class="token keyword">FROM</span> UserVisits<span class="token punctuation">)</span> t1
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="56_Leetflex__3735"></a>56. 应该被禁止的Leetflex 账户</h3> 
<p><img src="https://images2.imgbox.com/57/26/kkFVQF6j_o.png" alt="在这里插入图片描述"><br> 编写解决方案，查找那些应该被禁止的Leetflex帐户编号 account_id 。 如果某个帐户在某一时刻从两个不同的网络地址登录了，则这个帐户应该被禁止。<br> 可以以 任何顺序 返回结果。<br> 查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/7c/6d/FB44nH7K_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'LogInfo'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> LogInfo
go
<span class="token keyword">create</span> <span class="token keyword">table</span> LogInfo<span class="token punctuation">(</span>
account_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> ip_address   <span class="token keyword">int</span>
<span class="token punctuation">,</span> login       <span class="token keyword">datetime</span>
<span class="token punctuation">,</span> logout       <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> LogInfo
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2021-02-01 09:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2021-02-01 09:30:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2021-02-01 08:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2021-02-01 11:30:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">6</span>   <span class="token punctuation">,</span><span class="token string">'2021-02-01 20:30:00'</span><span class="token punctuation">,</span> <span class="token string">'2021-02-01 22:00:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">7</span>   <span class="token punctuation">,</span><span class="token string">'2021-02-02 20:30:00'</span><span class="token punctuation">,</span> <span class="token string">'2021-02-02 22:00:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">9</span>   <span class="token punctuation">,</span><span class="token string">'2021-02-01 16:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2021-02-01 16:59:59'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">13</span>  <span class="token punctuation">,</span><span class="token string">'2021-02-01 17:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2021-02-01 17:59:59'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">10</span>  <span class="token punctuation">,</span><span class="token string">'2021-02-01 16:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2021-02-01 17:00:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">11</span>  <span class="token punctuation">,</span><span class="token string">'2021-02-01 17:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2021-02-01 17:59:59'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>account_id
<span class="token keyword">from</span> LogInfo a
<span class="token keyword">join</span> LogInfo b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>account_id <span class="token operator">=</span> b<span class="token punctuation">.</span>account_id
<span class="token operator">and</span> a<span class="token punctuation">.</span>ip_address <span class="token operator">!=</span> b<span class="token punctuation">.</span>ip_address
<span class="token operator">and</span> a<span class="token punctuation">.</span>login <span class="token operator">between</span> b<span class="token punctuation">.</span>login <span class="token operator">and</span> b<span class="token punctuation">.</span>logout

</code></pre> 
<h3><a id="57__3774"></a>57. 苹果和橘子的个数</h3> 
<p><img src="https://images2.imgbox.com/2d/1e/5KwHrdn8_o.png" alt="在这里插入图片描述"><br> 编写 SQL 语句，查询每个大箱子中苹果和橘子的个数。如果大箱子中包含小盒子，还应当包含小盒子中苹果和橘子的个数。<br> 以任意顺序返回结果表。<br> 查询结果的格式如下示例所示。<br> <img src="https://images2.imgbox.com/d2/61/BbNjtBW8_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">IF</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">'Boxes'</span><span class="token punctuation">,</span><span class="token string">'U'</span><span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> Boxes
GO
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> Boxes<span class="token punctuation">(</span>
 box_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span> chest_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> apple_count   <span class="token keyword">int</span>
<span class="token punctuation">,</span> orange_count  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Boxes
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token boolean">null</span> <span class="token punctuation">,</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token number">15</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">18</span> <span class="token punctuation">,</span><span class="token number">14</span>   <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token number">15</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">19</span> <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">8</span>    <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">12</span> <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">19</span>   <span class="token punctuation">,</span><span class="token number">20</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">20</span> <span class="token punctuation">,</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token number">12</span>   <span class="token punctuation">,</span><span class="token number">9</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>  <span class="token punctuation">,</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token number">9</span>    <span class="token punctuation">,</span><span class="token number">9</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">14</span>   <span class="token punctuation">,</span><span class="token number">16</span>   <span class="token punctuation">,</span><span class="token number">7</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Chests'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Chests
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Chests<span class="token punctuation">(</span>
 chest_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span>apple_count   <span class="token keyword">int</span>
<span class="token punctuation">,</span>orange_count  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Chests
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">6</span>     <span class="token punctuation">,</span><span class="token number">5</span>     <span class="token punctuation">,</span> <span class="token number">6</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">14</span>    <span class="token punctuation">,</span><span class="token number">20</span>    <span class="token punctuation">,</span> <span class="token number">10</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token number">8</span>     <span class="token punctuation">,</span> <span class="token number">8</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span><span class="token number">19</span>    <span class="token punctuation">,</span> <span class="token number">4</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">16</span>    <span class="token punctuation">,</span><span class="token number">19</span>    <span class="token punctuation">,</span> <span class="token number">19</span>      <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>apple_count <span class="token operator">+</span> isnull<span class="token punctuation">(</span>b<span class="token punctuation">.</span>apple_count <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> apple_count
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>orange_count <span class="token operator">+</span> isnull<span class="token punctuation">(</span>b<span class="token punctuation">.</span>orange_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> orange_count
<span class="token keyword">from</span> boxes a
<span class="token keyword">left</span> <span class="token keyword">join</span> chests  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>chest_id <span class="token operator">=</span> b<span class="token punctuation">.</span>chest_id
</code></pre> 
<h3><a id="58__3825"></a>58. 大满贯数量</h3> 
<p><img src="https://images2.imgbox.com/aa/f2/jXDZ0nnr_o.png" alt="在这里插入图片描述"><br> 编写解决方案，找出每一个球员赢得大满贯比赛的次数。结果不包含没有赢得比赛的球员的ID 。<br> 结果集 无顺序要求 。<br> 结果的格式，如下所示。<br> <img src="https://images2.imgbox.com/31/82/WHWOkHrM_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Players'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Players
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Players<span class="token punctuation">(</span>
  player_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> player_name     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Players
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>         <span class="token punctuation">,</span> <span class="token string">'Nadal'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>         <span class="token punctuation">,</span> <span class="token string">'Federer'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>         <span class="token punctuation">,</span> <span class="token string">'Novak'</span>      <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Championships'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Championships
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Championships<span class="token punctuation">(</span>
      <span class="token keyword">year</span>        <span class="token keyword">int</span>
<span class="token punctuation">,</span> Wimbledon   <span class="token keyword">int</span>
<span class="token punctuation">,</span> Fr_open     <span class="token keyword">int</span>
<span class="token punctuation">,</span> US_open     <span class="token keyword">int</span>
<span class="token punctuation">,</span> Au_open     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Championships
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">2018</span>  <span class="token punctuation">,</span> <span class="token number">1</span>     <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2019</span>  <span class="token punctuation">,</span> <span class="token number">1</span>     <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2020</span>  <span class="token punctuation">,</span> <span class="token number">2</span>     <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">)</span>
 go
 <span class="token comment">--查询</span>
 <span class="token keyword">select</span> a<span class="token punctuation">.</span>player_id<span class="token punctuation">,</span>b<span class="token punctuation">.</span>player_name
 <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> grand_slams_count
 <span class="token keyword">from</span> <span class="token punctuation">(</span>
          <span class="token keyword">select</span> <span class="token keyword">year</span><span class="token punctuation">,</span> <span class="token keyword">match</span><span class="token punctuation">,</span> player_id
          <span class="token keyword">from</span> Championships
                   <span class="token keyword">unpivot</span> <span class="token punctuation">(</span>player_id <span class="token keyword">for</span> <span class="token keyword">Match</span> <span class="token operator">in</span> <span class="token punctuation">(</span>Wimbledon <span class="token punctuation">,</span>Fr_open <span class="token punctuation">,</span>US_open <span class="token punctuation">,</span> Au_open<span class="token punctuation">)</span><span class="token punctuation">)</span> p
      <span class="token punctuation">)</span> a
<span class="token keyword">inner</span> <span class="token keyword">join</span> Players  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>player_id <span class="token operator">=</span> b<span class="token punctuation">.</span>player_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>player_id <span class="token punctuation">,</span>b<span class="token punctuation">.</span>player_name
</code></pre> 
<h3><a id="59__3876"></a>59. 寻找面试候选人</h3> 
<p><img src="https://images2.imgbox.com/66/7a/bihfZPq6_o.png" alt="在这里插入图片描述"><br> 编写 SQL 语句来返回 所有面试候选人 的姓名 name 和邮件 mail 。当用户满足以下两个要求中的 任意一条 ，其成为 面试候选人 :</p> 
<ul><li>该用户在 连续三场及更多 比赛中赢得 任意 奖牌。</li><li>该用户在 三场及更多不同的 比赛中赢得 金牌（这些比赛可以不是连续的）<br> 可以以 任何顺序 返回结果。</li></ul> 
<p>查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/ab/e1/GNlG5vSY_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Contests'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Contests
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Contests<span class="token punctuation">(</span>
 contest_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> gold_medal    <span class="token keyword">int</span>
<span class="token punctuation">,</span> silver_medal  <span class="token keyword">int</span>
<span class="token punctuation">,</span> bronze_medal  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Contests
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">190</span>  <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">191</span>  <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">192</span>  <span class="token punctuation">,</span> <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">193</span>  <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">194</span>  <span class="token punctuation">,</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">195</span>  <span class="token punctuation">,</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">196</span>  <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Users
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Users<span class="token punctuation">(</span>
 user_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span>mail         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Users
<span class="token keyword">values</span>
 <span class="token punctuation">(</span>  <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'sarah@leetcode.com'</span> <span class="token punctuation">,</span><span class="token string">'Sarah'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'bob@leetcode.com'</span>   <span class="token punctuation">,</span><span class="token string">'Bob'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'alice@leetcode.com'</span> <span class="token punctuation">,</span><span class="token string">'Alice'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'hercy@leetcode.com'</span> <span class="token punctuation">,</span><span class="token string">'Hercy'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'quarz@leetcode.com'</span> <span class="token punctuation">,</span><span class="token string">'Quarz'</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--select * from users</span>
<span class="token comment">--select * from contests</span>

<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token punctuation">,</span>b<span class="token punctuation">.</span>name<span class="token punctuation">,</span>b<span class="token punctuation">.</span>mail
            <span class="token keyword">from</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> contest_id<span class="token punctuation">,</span> medaltype<span class="token punctuation">,</span> user_id
                    <span class="token keyword">from</span> Contests
                    <span class="token keyword">unpivot</span> <span class="token punctuation">(</span>user_id <span class="token keyword">for</span> medaltype <span class="token operator">in</span> <span class="token punctuation">(</span> gold_medal <span class="token punctuation">,</span> silver_medal <span class="token punctuation">,</span> bronze_medal<span class="token punctuation">)</span><span class="token punctuation">)</span> p <span class="token punctuation">)</span>a
            <span class="token keyword">left</span> <span class="token keyword">join</span> users b
            <span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id <span class="token punctuation">)</span>
<span class="token comment">--连续三场获得任意奖牌</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> name<span class="token punctuation">,</span>mail
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> name<span class="token punctuation">,</span>mail <span class="token punctuation">,</span>diff
      <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>contest_id<span class="token operator">-</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id <span class="token keyword">order</span> <span class="token keyword">by</span> contest_id<span class="token punctuation">)</span> <span class="token keyword">as</span> diff
            <span class="token keyword">from</span> T<span class="token punctuation">)</span> a
        <span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">,</span>mail<span class="token punctuation">,</span>diff
        <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span> <span class="token punctuation">)</span> a
<span class="token keyword">union</span>
<span class="token comment">--三场金牌(可以不连续)</span>
<span class="token keyword">select</span> name<span class="token punctuation">,</span>mail
<span class="token keyword">from</span> T
<span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">,</span>mail
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> medaltype <span class="token operator">=</span> <span class="token string">'gold_medal'</span> <span class="token keyword">then</span> <span class="token number">1</span>  <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span>


</code></pre> 
<h3><a id="60__3950"></a>60. 每天的最大交易</h3> 
<p><img src="https://images2.imgbox.com/ee/57/5Y23ZeSM_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案，报告每天交易金额 amount 最大 的交易 ID 。如果一天中有多个这样的交易，返回这些交易的 ID 。<br> 返回结果根据 transaction_id 升序排列。<br> 返回格式如下示例所示：<br> <img src="https://images2.imgbox.com/b4/bc/T8QO7hFn_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Transactions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span><span class="token punctuation">(</span>
 transaction_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span><span class="token keyword">day</span>             <span class="token keyword">datetime</span>
<span class="token punctuation">,</span>amount          <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">Transactions</span>
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">8</span>  <span class="token punctuation">,</span><span class="token string">'2021-4-3 15:57:28'</span> <span class="token punctuation">,</span><span class="token number">57</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>  <span class="token punctuation">,</span><span class="token string">'2021-4-28 08:47:25'</span><span class="token punctuation">,</span><span class="token number">21</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2021-4-29 13:28:30'</span><span class="token punctuation">,</span><span class="token number">58</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token string">'2021-4-28 16:39:59'</span><span class="token punctuation">,</span><span class="token number">40</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>  <span class="token punctuation">,</span><span class="token string">'2021-4-29 23:39:28'</span><span class="token punctuation">,</span><span class="token number">58</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> transaction_id
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> datepart<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token keyword">day</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> amount <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
    <span class="token keyword">from</span> <span class="token keyword">Transactions</span> <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> transaction_id
</code></pre> 
<h3><a id="61__3987"></a>61. 联赛信息统计</h3> 
<p><img src="https://images2.imgbox.com/2d/7d/LYXOFJXx_o.png" alt="在这里插入图片描述"><br> 写一段SQL，用来报告联赛信息. 统计数据应使用已进行的比赛来构建，其中 获胜 球队获得 三分 ，而失败球队获得 零分 。如果 打平 ，两支球队都得 一分 。<br> result 表的每行应包含以下信息:</p> 
<ul><li>team_name - Teams 表中的队伍名字</li><li>matches_played - 主场与客场球队进行的比赛次数.</li><li>points - 球队获得的总分数.</li><li>goal_for - 球队在所有比赛中获取的总进球数</li><li>goal_against - 球队在所有比赛中，他的对手球队的所有进球数</li><li>goal_diff - goal_for - goal_against.<br> 按 points 降序 返回结果表。 如果两队或多队得分相同，则按 goal_diff 降序 排列。 如果仍然存在平局，则以 team_name 按字典顺序 排列它们。</li></ul> 
<p>查询的结果格式如下例所示。<br> <img src="https://images2.imgbox.com/03/0b/uvmWrFcA_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Teams'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Teams
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Teams<span class="token punctuation">(</span>
 team_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> team_name     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Teams
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token string">'Ajax'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span> <span class="token string">'Dortmund'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>    <span class="token punctuation">,</span> <span class="token string">'Arsenal'</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Matches'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Matches
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Matches<span class="token punctuation">(</span>
home_team_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>away_team_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>home_team_goals  <span class="token keyword">int</span>
<span class="token punctuation">,</span>away_team_goals  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Matches
<span class="token keyword">values</span>
 <span class="token punctuation">(</span>  <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token number">0</span>     <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token number">3</span>     <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">4</span>      <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">5</span>     <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">6</span>      <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">0</span>     <span class="token punctuation">,</span><span class="token number">0</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
             <span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> home_team_goals <span class="token operator">=</span> away_team_goals  <span class="token keyword">then</span> <span class="token number">1</span>
                   <span class="token keyword">when</span> home_team_goals <span class="token operator">&gt;</span> away_team_goals  <span class="token keyword">then</span> <span class="token number">3</span>
                    <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token keyword">as</span> home_team_points
            <span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span>  home_team_goals <span class="token operator">=</span> away_team_goals <span class="token keyword">then</span> <span class="token number">1</span>
                    <span class="token keyword">when</span> home_team_goals <span class="token operator">&lt;</span> away_team_goals <span class="token keyword">then</span> <span class="token number">3</span>
            <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token keyword">as</span> away_team_points
            <span class="token keyword">from</span> Matches a <span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> B<span class="token punctuation">.</span>team_name<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> matches_played
<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>home_team_points<span class="token punctuation">)</span> <span class="token keyword">AS</span> points
<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>home_team_goals<span class="token punctuation">)</span> <span class="token keyword">AS</span> goal_for
<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>away_team_goals<span class="token punctuation">)</span> <span class="token keyword">AS</span> goal_against
<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>home_team_goals<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">SUM</span><span class="token punctuation">(</span>away_team_goals<span class="token punctuation">)</span> <span class="token keyword">as</span> goal_diff
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">select</span>  home_team_id <span class="token punctuation">,</span> away_team_id  <span class="token punctuation">,</span>home_team_goals  <span class="token punctuation">,</span> away_team_goals
        <span class="token punctuation">,</span>home_team_points  <span class="token punctuation">,</span>away_team_points
        <span class="token keyword">from</span> T a
        <span class="token keyword">union</span> <span class="token keyword">all</span>
        <span class="token keyword">select</span> away_team_id  <span class="token punctuation">,</span>home_team_id <span class="token punctuation">,</span> away_team_goals<span class="token punctuation">,</span> home_team_goals
        <span class="token punctuation">,</span>away_team_points<span class="token punctuation">,</span>home_team_points
        <span class="token keyword">from</span> T  <span class="token punctuation">)</span> A
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> Teams B
<span class="token keyword">ON</span> A<span class="token punctuation">.</span>home_team_id <span class="token operator">=</span> B<span class="token punctuation">.</span>TEAM_ID
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> B<span class="token punctuation">.</span>team_name <span class="token punctuation">)</span> a
<span class="token keyword">order</span> <span class="token keyword">by</span> points  <span class="token keyword">desc</span><span class="token punctuation">,</span>goal_diff  <span class="token keyword">desc</span> <span class="token punctuation">,</span>team_name  <span class="token keyword">asc</span>

</code></pre> 
<h3><a id="62__4065"></a>62. 可疑银行账户</h3> 
<p><img src="https://images2.imgbox.com/79/73/WYbGblET_o.png" alt="在这里插入图片描述"><br> 如果一个账户在 连续两个及以上 月份的 总收入 超过最大收入（max_income），那么认为这个账户 可疑。 账户当月 总收入 是当月存入资金总数（即 transactions 表中 type 字段的 ‘Creditor’）。<br> 编写一个解决方案，报告所有的 可疑 账户。<br> 以 任意顺序 返回结果表<br> 返回结果格式如下示例所示。<br> <img src="https://images2.imgbox.com/93/4e/9BJ4feoC_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Accounts'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Accounts
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Accounts<span class="token punctuation">(</span>
  account_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> max_income      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Accounts
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">21000</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">10400</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Transactions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span> <span class="token punctuation">(</span>
 transaction_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> account_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> <span class="token keyword">type</span>            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> amount          <span class="token keyword">int</span>
<span class="token punctuation">,</span> <span class="token keyword">day</span>             <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">Transactions</span>
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Creditor'</span> <span class="token punctuation">,</span><span class="token number">107100</span> <span class="token punctuation">,</span><span class="token string">'2021-06-02 11:38:14'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>     <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Creditor'</span> <span class="token punctuation">,</span><span class="token number">10400</span>  <span class="token punctuation">,</span><span class="token string">'2021-06-20 12:39:18'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">11</span>    <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Debtor'</span>   <span class="token punctuation">,</span><span class="token number">58800</span>  <span class="token punctuation">,</span><span class="token string">'2021-07-23 12:41:55'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Creditor'</span> <span class="token punctuation">,</span><span class="token number">49300</span>  <span class="token punctuation">,</span><span class="token string">'2021-05-03 16:11:04'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">15</span>    <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Debtor'</span>   <span class="token punctuation">,</span><span class="token number">75500</span>  <span class="token punctuation">,</span><span class="token string">'2021-05-23 14:40:20'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">10</span>    <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Creditor'</span> <span class="token punctuation">,</span><span class="token number">102100</span> <span class="token punctuation">,</span><span class="token string">'2021-06-15 10:37:16'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">14</span>    <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Creditor'</span> <span class="token punctuation">,</span><span class="token number">56300</span>  <span class="token punctuation">,</span><span class="token string">'2021-07-21 12:12:25'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">19</span>    <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'Debtor'</span>   <span class="token punctuation">,</span><span class="token number">101100</span> <span class="token punctuation">,</span><span class="token string">'2021-05-09 15:21:49'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>     <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Creditor'</span> <span class="token punctuation">,</span><span class="token number">64900</span>  <span class="token punctuation">,</span><span class="token string">'2021-07-26 15:09:56'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>     <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Creditor'</span> <span class="token punctuation">,</span><span class="token number">90900</span>  <span class="token punctuation">,</span><span class="token string">'2021-06-14 11:23:07'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">SELECT</span> <span class="token keyword">distinct</span> account_id
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span>account_id<span class="token punctuation">,</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token string">'yyMM'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">Month</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>amount <span class="token punctuation">)</span> <span class="token keyword">as</span> amount
        <span class="token punctuation">,</span>b<span class="token punctuation">.</span>max_income
        <span class="token punctuation">,</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token string">'yyMM'</span><span class="token punctuation">)</span>  <span class="token operator">-</span> RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> A<span class="token punctuation">.</span>ACCOUNT_ID <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token string">'yyMM'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">AS</span> diff
        <span class="token keyword">from</span> <span class="token keyword">Transactions</span> A
        <span class="token keyword">left</span> <span class="token keyword">join</span> Accounts b
        <span class="token keyword">on</span> a<span class="token punctuation">.</span>account_id <span class="token operator">=</span> b<span class="token punctuation">.</span>account_id
        <span class="token keyword">where</span> a<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'Creditor'</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>account_id <span class="token punctuation">,</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token string">'yyMM'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>max_income
        <span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span>amount <span class="token punctuation">)</span> <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>max_income<span class="token punctuation">)</span> A
<span class="token keyword">group</span> <span class="token keyword">by</span> account_id<span class="token punctuation">,</span>diff
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>account_id
</code></pre> 
<h3><a id="63__4127"></a>63. 最大数量高于平均水平的订单</h3> 
<p><img src="https://images2.imgbox.com/7a/c0/PsNsgGe6_o.png" alt="在这里插入图片描述"><br> 您正在运行一个电子商务网站，该网站正在寻找不平衡的订单。不平衡订单的订单最大数量严格大于每个订单（包括订单本身）的平均数量。<br> 订单的平均数量计算为（订单中所有产品的总数量）/（订单中不同产品的数量）。订单的最大数量是订单中任何单个产品的最高数量。<br> 编写SQL查询以查找所有不平衡订单的订单id。<br> 按任意顺序返回结果表。<br> 查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/47/69/mepQnsjA_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'OrdersDetails'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> OrdersDetails
go
<span class="token keyword">create</span> <span class="token keyword">table</span> OrdersDetails <span class="token punctuation">(</span>
  order_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> product_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> quantity     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> OrdersDetails
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">12</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">10</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">15</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">8</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">4</span>    <span class="token punctuation">,</span> <span class="token number">4</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">5</span>    <span class="token punctuation">,</span> <span class="token number">6</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">5</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">4</span>    <span class="token punctuation">,</span> <span class="token number">18</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span> <span class="token number">5</span>    <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span> <span class="token number">6</span>    <span class="token punctuation">,</span> <span class="token number">8</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span> <span class="token number">7</span>    <span class="token punctuation">,</span> <span class="token number">9</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span> <span class="token number">8</span>    <span class="token punctuation">,</span> <span class="token number">9</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">9</span>    <span class="token punctuation">,</span> <span class="token number">20</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">9</span>    <span class="token punctuation">,</span> <span class="token number">4</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">SELECT</span> order_id
<span class="token keyword">FROM</span> OrdersDetails
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> order_id
<span class="token keyword">HAVING</span> <span class="token function">max</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> <span class="token operator">&gt;</span>  <span class="token keyword">ALL</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> <span class="token keyword">FROM</span> OrdersDetails <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> order_id<span class="token punctuation">)</span>


</code></pre> 
<h3><a id="64__4174"></a>64. 将工资相同的雇员分组</h3> 
<p><img src="https://images2.imgbox.com/2a/f5/YPIEUFbB_o.png" alt="在这里插入图片描述"><br> 这家公司想要将 工资相同 的雇员划分到同一个组中。每个组需要满足如下要求：</p> 
<ul><li>每个组需要由 至少两个 雇员组成。</li><li>同一个组中的所有雇员的 工资相同。</li><li>工资相同的所有雇员必须被分到同一个组中。</li><li>如果某位雇员的工资是独一无二的，那么它 不 被分配到任何一个组中。</li><li>组ID的设定基于这个组的工资相对于其他组的 工资的排名，即工资 最低 的组满足 team_id = 1 。注意，排名时 不需要考虑 没有组的雇员的工资。<br> 编写一个解决方案来获取每一个被分配到组中的雇员的 team_id 。<br> 返回的结果表按照 team_id 升序排列。如果相同，则按照 employee_id 升序排列。<br> 返回结果格式如下示例所示。</li></ul> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employees'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employees
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employees<span class="token punctuation">(</span>
  employee_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> salary       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employees
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token string">'Meir'</span>    <span class="token punctuation">,</span><span class="token number">3000</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token string">'Michael'</span> <span class="token punctuation">,</span><span class="token number">3000</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span>    <span class="token punctuation">,</span> <span class="token string">'Addilyn'</span> <span class="token punctuation">,</span><span class="token number">7400</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>    <span class="token punctuation">,</span> <span class="token string">'Juan'</span>    <span class="token punctuation">,</span><span class="token number">6100</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>    <span class="token punctuation">,</span> <span class="token string">'Kannon'</span>  <span class="token punctuation">,</span><span class="token number">7400</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> employee_id<span class="token punctuation">,</span>name   <span class="token punctuation">,</span> salary <span class="token punctuation">,</span>dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> team_id
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> Employees <span class="token punctuation">)</span> a
<span class="token keyword">where</span> cnt <span class="token operator">&gt;</span>  <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> team_id  <span class="token punctuation">,</span>employee_id
</code></pre> 
<h3><a id="65__4215"></a>65. 查询具有最多共同关注者的所有两两结对组</h3> 
<p><img src="https://images2.imgbox.com/46/05/TB6PT0y9_o.png" alt="在这里插入图片描述"><br> 写出一个查询语句，找到具有最多共同关注者的所有两两结对组。换句话说，如果有两个用户的共同关注者是最大的，我们应该返回所有具有此最大值的两两结对组</p> 
<p>结果返回表，每一行应该包含user1_id和 user2_id，其中user1_id &lt; user2_id.<br> 返回结果 不要求顺序 。<br> 查询结果格式如下例：<br> <img src="https://images2.imgbox.com/70/3b/oVtnBo4v_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Relations'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Relations
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Relations<span class="token punctuation">(</span>
     user_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> follower_id  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Relations
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">3</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">3</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span><span class="token number">3</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">4</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">4</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span><span class="token number">4</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">5</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">6</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span><span class="token number">5</span>      <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> user1_id  <span class="token punctuation">,</span>  user2_id
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span>user_id <span class="token keyword">as</span> user1_id <span class="token punctuation">,</span>b<span class="token punctuation">.</span>user_id <span class="token keyword">as</span> user2_id
        <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
        <span class="token keyword">from</span>  Relations  a
        <span class="token keyword">inner</span> <span class="token keyword">join</span> Relations b
        <span class="token keyword">on</span> a<span class="token punctuation">.</span>follower_id <span class="token operator">=</span> b<span class="token punctuation">.</span>follower_id
        <span class="token operator">and</span> a<span class="token punctuation">.</span>user_id <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>user_id
        <span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span>b<span class="token punctuation">.</span>user_id <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="66__4259"></a>66. 找出每所学校的最低分数要求</h3> 
<p><img src="https://images2.imgbox.com/72/69/s0iQNKcS_o.png" alt="在这里插入图片描述"><br> 每年，学校会公布学生申请所需的最低分数要求。学校根据所有学生的考试成绩来决定其最低分数要求。</p> 
<ol><li>学校希望确保即使 每 一个满足分数要求的学生都申请该学校，学校也有足够的能力接纳每一个学生。</li><li>学校也希望 尽可能多 的学生能申请该学校。</li><li>学校 必须 使用在 Exam 表中的 score 来作为最低分数要求。<br> 编写一个解决方案，报告每所学校的 最低分数要求。如果同时有多个 score 值满足上述要求，则选择其中 最小的一个。如果数据不足以决定 最低分数要求，那么输出 -1。<br> 返回的结果表可以按 任意顺序 排序。<br> 结果格式如下例所示：<br> <img src="https://images2.imgbox.com/cc/97/tNh58U6a_o.png" alt="在这里插入图片描述"></li></ol> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Schools'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Schools
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Schools<span class="token punctuation">(</span>
  school_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>capacity     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Schools
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">11</span>    <span class="token punctuation">,</span><span class="token number">151</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span>     <span class="token punctuation">,</span><span class="token number">48</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>     <span class="token punctuation">,</span><span class="token number">9</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span>    <span class="token punctuation">,</span><span class="token number">99</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Exam'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Exam
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Exam<span class="token punctuation">(</span>
 score          <span class="token keyword">int</span>
<span class="token punctuation">,</span>student_count  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Exam
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">975</span>  <span class="token punctuation">,</span><span class="token number">10</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">966</span>  <span class="token punctuation">,</span><span class="token number">60</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">844</span>  <span class="token punctuation">,</span><span class="token number">76</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">749</span>  <span class="token punctuation">,</span><span class="token number">76</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">744</span>  <span class="token punctuation">,</span><span class="token number">100</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span>  a<span class="token punctuation">.</span>school_id
     <span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token function">min</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>score<span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">else</span> <span class="token function">min</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>score<span class="token punctuation">)</span> <span class="token keyword">end</span> <span class="token keyword">as</span> score
<span class="token keyword">from</span> schools  a
<span class="token keyword">left</span> <span class="token keyword">join</span> exam b
<span class="token keyword">on</span> b<span class="token punctuation">.</span>student_count <span class="token operator">&lt;=</span> a<span class="token punctuation">.</span>capacity
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>school_id
</code></pre> 
<h3><a id="67__4311"></a>67. 统计实验的数量</h3> 
<p><img src="https://images2.imgbox.com/51/e7/qz7IOI4o_o.png" alt="在这里插入图片描述"><br> 写一个 SQL 查询语句，以报告在给定三个实验平台中每种实验完成的次数。请注意，每一对（实验平台、实验名称）都应包含在输出中，包括平台上实验次数是零的。<br> 结果可以以任意顺序给出。<br> 查询的结果如下所示：</p> 
<p><img src="https://images2.imgbox.com/94/d9/HV0lrW7T_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Experiments'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Experiments
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Experiments<span class="token punctuation">(</span>
  experiment_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> platform         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> experiment_name  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Experiments
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">4</span>     <span class="token punctuation">,</span><span class="token string">'IOS'</span>      <span class="token punctuation">,</span><span class="token string">'Programming'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">13</span>    <span class="token punctuation">,</span><span class="token string">'IOS'</span>      <span class="token punctuation">,</span><span class="token string">'Sports'</span>       <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">14</span>    <span class="token punctuation">,</span><span class="token string">'Android'</span>  <span class="token punctuation">,</span><span class="token string">'Reading'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>     <span class="token punctuation">,</span><span class="token string">'Web'</span>      <span class="token punctuation">,</span><span class="token string">'Reading'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">12</span>    <span class="token punctuation">,</span><span class="token string">'Web'</span>      <span class="token punctuation">,</span><span class="token string">'Reading'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">18</span>    <span class="token punctuation">,</span><span class="token string">'Web'</span>      <span class="token punctuation">,</span><span class="token string">'Programming'</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T1 <span class="token keyword">AS</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token string">'Android'</span> platform
    <span class="token keyword">union</span>
    <span class="token keyword">select</span> <span class="token string">'IOS'</span>
    <span class="token keyword">union</span>
    <span class="token keyword">select</span> <span class="token string">'Web'</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span> T2 <span class="token keyword">AS</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> <span class="token string">'Reading'</span> <span class="token keyword">as</span> experiment_name
         <span class="token keyword">union</span>
         <span class="token keyword">select</span> <span class="token string">'Sports'</span>
         <span class="token keyword">union</span>
         <span class="token keyword">select</span> <span class="token string">'Programming'</span>
     <span class="token punctuation">)</span>
<span class="token keyword">select</span>  a<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>b<span class="token punctuation">.</span>experiment_name
     <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> experiment_id <span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> num_experiments
<span class="token keyword">from</span> T1 a
<span class="token keyword">cross</span> <span class="token keyword">join</span> T2 b
<span class="token keyword">left</span> <span class="token keyword">join</span> Experiments  c
<span class="token keyword">on</span> a<span class="token punctuation">.</span>platform <span class="token operator">=</span> c<span class="token punctuation">.</span>platform
<span class="token operator">and</span> b<span class="token punctuation">.</span>experiment_name <span class="token operator">=</span> c<span class="token punctuation">.</span>experiment_name
<span class="token keyword">group</span> <span class="token keyword">by</span>  a<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>b<span class="token punctuation">.</span>experiment_name

</code></pre> 
<h3><a id="68__4363"></a>68. 无流量的账户数</h3> 
<p><img src="https://images2.imgbox.com/78/cb/SoS0vH4s_o.png" alt="在这里插入图片描述"><br> 编写SQL查询以报告在 2021 购买订阅但没有任何会话的帐 户数。<br> 查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/d9/29/ekTbGjsQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Subscriptions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Subscriptions
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Subscriptions<span class="token punctuation">(</span>
 account_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span>start_date   <span class="token keyword">date</span>
<span class="token punctuation">,</span> end_date     <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Subscriptions
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">9</span>    <span class="token punctuation">,</span><span class="token string">'2020-02-18'</span><span class="token punctuation">,</span><span class="token string">'2021-10-30'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2021-09-21'</span><span class="token punctuation">,</span><span class="token string">'2021-11-13'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">11</span>   <span class="token punctuation">,</span><span class="token string">'2020-02-28'</span><span class="token punctuation">,</span><span class="token string">'2020-08-18'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">13</span>   <span class="token punctuation">,</span><span class="token string">'2021-04-20'</span><span class="token punctuation">,</span><span class="token string">'2021-09-22'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'2020-10-26'</span><span class="token punctuation">,</span><span class="token string">'2021-05-08'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2020-09-11'</span><span class="token punctuation">,</span><span class="token string">'2021-01-17'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Streams'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Streams
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Streams<span class="token punctuation">(</span>
 session_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>account_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>stream_date  <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Streams
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">14</span>    <span class="token punctuation">,</span><span class="token number">9</span>  <span class="token punctuation">,</span><span class="token string">'2020-05-16'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">16</span>    <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'2021-10-27'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">18</span>    <span class="token punctuation">,</span><span class="token number">11</span> <span class="token punctuation">,</span><span class="token string">'2020-04-29'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">17</span>    <span class="token punctuation">,</span><span class="token number">13</span> <span class="token punctuation">,</span><span class="token string">'2021-08-08'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">19</span>    <span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'2020-12-31'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">13</span>    <span class="token punctuation">,</span><span class="token number">5</span>  <span class="token punctuation">,</span><span class="token string">'2021-01-05'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> accounts_count
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> account_id
        <span class="token keyword">FROM</span> subscriptions
        <span class="token keyword">WHERE</span> start_date <span class="token operator">&lt;=</span> <span class="token string">'2021-12-31'</span>
         <span class="token operator">AND</span> end_date <span class="token operator">&gt;=</span> <span class="token string">'2021-01-01'</span>
          <span class="token operator">AND</span> account_id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> account_id
                                  <span class="token keyword">FROM</span> Streams
                                  <span class="token keyword">WHERE</span> stream_date <span class="token operator">LIKE</span> <span class="token string">'2021%'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> t

</code></pre> 
<h3><a id="69__4418"></a>69. 面试中被录取的候选人</h3> 
<p><img src="https://images2.imgbox.com/0f/ce/MbvV4oye_o.png" alt="在这里插入图片描述"><br> 编写解决方案，找出 至少有两年 工作经验、且面试分数之和 严格大于 15 的候选人的 ID 。<br> 可以以 任何顺序 返回结果表。<br> 查询结果的格式如下例所示。<br> <img src="https://images2.imgbox.com/19/46/1K9JOCSi_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Candidates'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Candidates
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Candidates<span class="token punctuation">(</span>
  candidate_id <span class="token keyword">int</span>
<span class="token punctuation">,</span> name          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> years_of_exp  <span class="token keyword">int</span>
<span class="token punctuation">,</span> interview_id  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Candidates
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">11</span>   <span class="token punctuation">,</span><span class="token string">'Atticus'</span> <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">101</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>    <span class="token punctuation">,</span><span class="token string">'Ruben'</span>   <span class="token punctuation">,</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token number">104</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'Aliza'</span>   <span class="token punctuation">,</span><span class="token number">10</span>   <span class="token punctuation">,</span><span class="token number">109</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>    <span class="token punctuation">,</span><span class="token string">'Alfredo'</span> <span class="token punctuation">,</span><span class="token number">0</span>    <span class="token punctuation">,</span><span class="token number">107</span> <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Rounds'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Rounds
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Rounds<span class="token punctuation">(</span>
  interview_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> round_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> score         <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Rounds
<span class="token keyword">values</span>
 <span class="token punctuation">(</span>  <span class="token number">109</span>     <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">101</span>     <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">8</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">109</span>     <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">107</span>     <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">104</span>     <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">6</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">109</span>     <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">4</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">104</span>     <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">104</span>     <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">109</span>     <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">104</span>     <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">107</span>     <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">101</span>     <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">8</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>candidate_id
<span class="token keyword">from</span> Candidates a
<span class="token keyword">left</span> <span class="token keyword">join</span>  Rounds  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>interview_id <span class="token operator">=</span> b<span class="token punctuation">.</span>interview_id
<span class="token keyword">where</span> a<span class="token punctuation">.</span>years_of_exp <span class="token operator">&gt;=</span><span class="token number">2</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> candidate_id
<span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>score <span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">15</span>
</code></pre> 
<h3><a id="70__4476"></a>70. 商店中每个成员的级别</h3> 
<p><img src="https://images2.imgbox.com/03/09/r3UsqPSj_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f0/4d/BlnlVfRM_o.png" alt="在这里插入图片描述"><br> 一个商店想对其成员进行分类。有三个层次:</p> 
<ul><li>“钻石”: 如果转换率 大于或等于 80.</li><li>“黄金”: 如果转换率 大于或等于 50 且小于 80.</li><li>“白银”: 如果转化率 小于 50.</li><li>“青铜”: 如果该成员从未访问过该商店。<br> 成员的 转化率 为 (100 * 该会员的购买总数) / 该成员的总访问次数.</li></ul> 
<p>编写一个 SQL 来查询每个成员的 id、名称和类别。<br> 以 任意顺序 返回结果表。<br> 查询结果格式如下所示。<br> <img src="https://images2.imgbox.com/86/84/TEEQHuKo_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/85/8f/Cr5He70v_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Members'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Members
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Members<span class="token punctuation">(</span>
  member_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> name       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Members
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">9</span>    <span class="token punctuation">,</span><span class="token string">'Alice'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">11</span>   <span class="token punctuation">,</span><span class="token string">'Bob'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'Winston'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>    <span class="token punctuation">,</span><span class="token string">'Hercy'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'Narihan'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Visits'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Visits
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Visits<span class="token punctuation">(</span>
   visit_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> member_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> visit_date   <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Visits
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">22</span>  <span class="token punctuation">,</span><span class="token number">11</span>   <span class="token punctuation">,</span><span class="token string">'2021-10-28'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">16</span>  <span class="token punctuation">,</span><span class="token number">11</span>   <span class="token punctuation">,</span><span class="token string">'2021-01-12'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">18</span>  <span class="token punctuation">,</span><span class="token number">9</span>    <span class="token punctuation">,</span><span class="token string">'2021-12-10'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">19</span>  <span class="token punctuation">,</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2021-10-19'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">12</span>  <span class="token punctuation">,</span><span class="token number">11</span>   <span class="token punctuation">,</span><span class="token string">'2021-03-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">17</span>  <span class="token punctuation">,</span><span class="token number">8</span>    <span class="token punctuation">,</span><span class="token string">'2021-05-07'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">21</span>  <span class="token punctuation">,</span><span class="token number">9</span>    <span class="token punctuation">,</span><span class="token string">'2021-05-12'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Purchases'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Purchases
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Purchases<span class="token punctuation">(</span>
   visit_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> charged_amount <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Purchases
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">12</span>   <span class="token punctuation">,</span><span class="token number">2000</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">18</span>   <span class="token punctuation">,</span><span class="token number">9000</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">17</span>   <span class="token punctuation">,</span><span class="token number">7000</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

<span class="token keyword">select</span> a<span class="token punctuation">.</span>member_id <span class="token punctuation">,</span>a<span class="token punctuation">.</span>name
<span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>visit_id <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'Bronze'</span>
    <span class="token keyword">when</span> <span class="token function">count</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>visit_id <span class="token punctuation">)</span> <span class="token operator">*</span><span class="token number">1.0</span>  <span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>visit_id <span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token number">0.5</span> <span class="token keyword">then</span> <span class="token string">'Silver'</span>
    <span class="token keyword">when</span> <span class="token function">count</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>visit_id <span class="token punctuation">)</span> <span class="token operator">*</span><span class="token number">1.0</span> <span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>visit_id <span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token number">0.8</span> <span class="token keyword">then</span> <span class="token string">'Gold'</span>
    <span class="token keyword">else</span> <span class="token string">'Diamond'</span>
<span class="token keyword">end</span> <span class="token keyword">as</span> category
<span class="token keyword">from</span> Members a
<span class="token keyword">left</span> <span class="token keyword">join</span> Visits  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>member_id <span class="token operator">=</span> b<span class="token punctuation">.</span>member_id
<span class="token keyword">left</span> <span class="token keyword">join</span> Purchases c
<span class="token keyword">on</span> b<span class="token punctuation">.</span>visit_id <span class="token operator">=</span> c<span class="token punctuation">.</span>visit_id
<span class="token keyword">group</span>  <span class="token keyword">by</span> a<span class="token punctuation">.</span>member_id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>name

</code></pre> 
<h3><a id="71__4558"></a>71. 账户余额</h3> 
<p><img src="https://images2.imgbox.com/e2/ca/faLTt7x4_o.png" alt="在这里插入图片描述">请写出能够返回用户每次交易完成后的账户余额. 我们约定所有用户在进行交易前的账户余额都为0， 并且保证所有交易行为后的余额不为负数。<br> 返回的结果请依次按照 账户（account_id), 日期( day ) 进行升序排序 .<br> 查询结果的格式请参照以下测试样例.</p> 
<p><img src="https://images2.imgbox.com/39/f6/Q16M140n_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Transactions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span><span class="token punctuation">(</span>
  account_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span><span class="token keyword">day</span>         <span class="token keyword">date</span>
<span class="token punctuation">,</span><span class="token keyword">type</span>        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> amount       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">Transactions</span>
<span class="token keyword">values</span>
 <span class="token punctuation">(</span>  <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2021-11-07'</span><span class="token punctuation">,</span> <span class="token string">'Deposit'</span>  <span class="token punctuation">,</span><span class="token number">2000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2021-11-09'</span><span class="token punctuation">,</span> <span class="token string">'Withdraw'</span> <span class="token punctuation">,</span><span class="token number">1000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2021-11-11'</span><span class="token punctuation">,</span> <span class="token string">'Deposit'</span>  <span class="token punctuation">,</span><span class="token number">3000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'2021-12-07'</span><span class="token punctuation">,</span> <span class="token string">'Deposit'</span>  <span class="token punctuation">,</span><span class="token number">7000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'2021-12-12'</span><span class="token punctuation">,</span> <span class="token string">'Withdraw'</span> <span class="token punctuation">,</span><span class="token number">7000</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> account_id <span class="token punctuation">,</span><span class="token keyword">day</span>
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>amount_chulihou<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> account_id <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">day</span><span class="token punctuation">)</span> <span class="token keyword">as</span> balance
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> account_id<span class="token punctuation">,</span><span class="token keyword">day</span>
<span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'Withdraw'</span> <span class="token keyword">then</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> amount
<span class="token keyword">else</span>  amount  <span class="token keyword">end</span> <span class="token keyword">as</span> amount_chulihou
<span class="token keyword">from</span> <span class="token keyword">Transactions</span> <span class="token punctuation">)</span> a
<span class="token keyword">order</span> <span class="token keyword">by</span> account_id<span class="token punctuation">,</span><span class="token keyword">day</span>
</code></pre> 
<h3><a id="72_0_1__4595"></a>72. 为订单类型为0 的客户删除类型为1 的订单</h3> 
<p><img src="https://images2.imgbox.com/57/55/FMwMZGP3_o.png" alt="在这里插入图片描述"><br> 编写SQL查询以根据以下条件报告所有订单：</p> 
<p>如果客户至少有一个类型为0的订单，则不要报告该客户的任何类型为1的订单。<br> 否则，报告客户的所有订单。<br> 按任意顺序返回结果表。</p> 
<p>查询结果格式如下例所示。<br> <img src="https://images2.imgbox.com/76/3e/PbW1kOFt_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders<span class="token punctuation">(</span>
order_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>customer_id <span class="token keyword">int</span>
<span class="token punctuation">,</span> order_type   <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">0</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">0</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">11</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">0</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">12</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">21</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">22</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">0</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">31</span>   <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">32</span>   <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token comment">--方法1 </span>
<span class="token keyword">with</span> T <span class="token keyword">AS</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> customer_id
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> order_type <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span>  <span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> Orders a
<span class="token keyword">group</span> <span class="token keyword">by</span> customer_id <span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> orders
<span class="token keyword">where</span> customer_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> customer_id <span class="token keyword">from</span> T <span class="token keyword">WHERE</span> CNT <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> ORDERS
<span class="token keyword">WHERE</span> CUSTOMER_ID <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> customer_id <span class="token keyword">from</span> T <span class="token keyword">WHERE</span> CNT <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
<span class="token operator">AND</span> ORDER_TYPE <span class="token operator">&lt;&gt;</span> <span class="token string">'1'</span>
<span class="token comment">--方法2</span>
<span class="token keyword">select</span> order_id<span class="token punctuation">,</span> customer_id<span class="token punctuation">,</span> order_type <span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> customer_id <span class="token keyword">order</span> <span class="token keyword">by</span> order_type<span class="token punctuation">)</span> rk
<span class="token keyword">from</span> Orders<span class="token punctuation">)</span> a
<span class="token keyword">where</span> rk<span class="token operator">=</span><span class="token number">1</span>
</code></pre> 
<h3><a id="73__4647"></a>73. 最繁忙的机场</h3> 
<p><img src="https://images2.imgbox.com/77/06/77PbaDfK_o.png" alt="在这里插入图片描述"><br> 编写一个 SQL 来查询 流量最大 的机场的 ID。客流量最大的机场是指从该机场起飞或抵达该机场的航班总数最多的机场。如果有多个机场流量最大，请全部查询出来。<br> 以 任意顺序 返回结果表。<br> 查询结果格式如下所示。<br> <img src="https://images2.imgbox.com/cc/3e/XcgafB2C_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Flights'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Flights
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Flights<span class="token punctuation">(</span>
  departure_airport  <span class="token keyword">int</span>
<span class="token punctuation">,</span> arrival_airport    <span class="token keyword">int</span>
<span class="token punctuation">,</span> flights_count      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Flights
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token number">2</span>        <span class="token punctuation">,</span> <span class="token number">4</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token number">1</span>        <span class="token punctuation">,</span> <span class="token number">5</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token number">4</span>        <span class="token punctuation">,</span> <span class="token number">5</span>     <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> airport_id
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> airport_id
        <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">sum</span><span class="token punctuation">(</span>flights_count<span class="token punctuation">)</span> <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
        <span class="token keyword">from</span> <span class="token punctuation">(</span>
                 <span class="token keyword">select</span> departure_airport <span class="token keyword">as</span> airport_id<span class="token punctuation">,</span> flights_count
                 <span class="token keyword">from</span> Flights
                 <span class="token keyword">union</span> <span class="token keyword">all</span>
                 <span class="token keyword">select</span> arrival_airport<span class="token punctuation">,</span> flights_count
                 <span class="token keyword">from</span> flights
             <span class="token punctuation">)</span> a
        <span class="token keyword">group</span> <span class="token keyword">by</span> airport_id <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>

</code></pre> 
<h3><a id="74___4686"></a>74. 每辆车的乘客人数 ①</h3> 
<p><img src="https://images2.imgbox.com/42/8d/IlZpT43k_o.png" alt="在这里插入图片描述"><br> 公交车和乘客到达 LeetCode 站。如果一辆公交车在时间 tbus 到站，乘客在时间 tpassenger 到站，其中 tpassenger &lt;= tbus，该乘客之前没有赶上任何公交车，则该乘客将搭乘该公交车。<br> 编写一个 SQL 来查询使用每辆公交车的用户数量。<br> 返回按 bus_id 升序排序 的结果表。<br> 查询结果格式如下所示。<br> <img src="https://images2.imgbox.com/04/29/XXuT56EQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Buses'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Buses
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Buses<span class="token punctuation">(</span>
  bus_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span> arrival_time <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Buses
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">7</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Passengers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Passengers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Passengers<span class="token punctuation">(</span>
passenger_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span>arrival_time  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Passengers
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">11</span>    <span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">12</span>    <span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">13</span>    <span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">14</span>    <span class="token punctuation">,</span> <span class="token number">7</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> bus_id
<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>passenger_id<span class="token punctuation">)</span> <span class="token operator">-</span>lag<span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span>passenger_id <span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>arrival_time<span class="token punctuation">)</span> <span class="token keyword">as</span> passeger_cnt
<span class="token keyword">from</span> buses a
<span class="token keyword">left</span> <span class="token keyword">join</span> Passengers b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>arrival_time <span class="token operator">&gt;=</span> b<span class="token punctuation">.</span>arrival_time
<span class="token keyword">group</span> <span class="token keyword">by</span> bus_id <span class="token punctuation">,</span>a<span class="token punctuation">.</span>arrival_time
<span class="token keyword">order</span> <span class="token keyword">by</span> bus_id
</code></pre> 
<h3><a id="75__4734"></a>75. 分别排序两列</h3> 
<p><img src="https://images2.imgbox.com/e1/09/5N3kxFrz_o.png" alt="在这里插入图片描述"><br> 编写解决方案，使：<br> first_col 按照 升序 排列。<br> second_col 按照 降序 排列。<br> 返回的结果格式如下。<br> <img src="https://images2.imgbox.com/0a/68/5dpL1ZxX_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Data'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">Data</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">Data</span><span class="token punctuation">(</span>
first_col    <span class="token keyword">int</span>
<span class="token punctuation">,</span>second_col  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>  <span class="token keyword">Data</span>
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">4</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> first_col<span class="token punctuation">)</span> <span class="token keyword">as</span> first_col_rnk
<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> second_col <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> sec_col_rnk
<span class="token keyword">from</span> <span class="token keyword">Data</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>first_col <span class="token punctuation">,</span>b<span class="token punctuation">.</span>second_col
<span class="token keyword">from</span> T a
<span class="token keyword">left</span> <span class="token keyword">join</span> T b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>first_col_rnk <span class="token operator">=</span> b<span class="token punctuation">.</span>sec_col_rnk
</code></pre> 
<h3><a id="76__4770"></a>76. 世界排名的变化</h3> 
<p><img src="https://images2.imgbox.com/d5/12/QeLaDMTv_o.png" alt="在这里插入图片描述"><br> 国家队的全球排名是按 降序排列 所有队伍的得分后所得出的排名。如果两支队伍得分相同，我们将按其名称的 字典顺序 排列以打破平衡。<br> 每支国家队的分数应根据其相应的 points_change 进行更新。<br> 编写解决方案来计算在分数更新后，每个队伍的全球排名的变化。<br> 以 任意顺序 返回结果。<br> 查询结果的格式如下例所示：</p> 
<p><img src="https://images2.imgbox.com/c3/d8/Dh4Hct4R_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'TeamPoints'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> TeamPoints
go
<span class="token keyword">create</span> <span class="token keyword">table</span> TeamPoints<span class="token punctuation">(</span>
 team_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span>name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>points      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> TeamPoints
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'Algeria'</span>     <span class="token punctuation">,</span><span class="token number">1431</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'Senegal'</span>     <span class="token punctuation">,</span><span class="token number">2132</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'New Zealand'</span> <span class="token punctuation">,</span><span class="token number">1402</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'Croatia'</span>     <span class="token punctuation">,</span><span class="token number">1817</span> <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'PointsChange'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> PointsChange
go
<span class="token keyword">create</span> <span class="token keyword">table</span> PointsChange<span class="token punctuation">(</span>
    team_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span>points_change  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> PointsChange
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">3</span> <span class="token punctuation">,</span> <span class="token number">399</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token punctuation">,</span> <span class="token number">0</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token punctuation">,</span> <span class="token number">13</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">22</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>team_id <span class="token punctuation">,</span>a<span class="token punctuation">.</span>name
 <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> points <span class="token keyword">desc</span> <span class="token punctuation">,</span>name <span class="token keyword">asc</span> <span class="token punctuation">)</span> <span class="token operator">-</span>
rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>points <span class="token operator">+</span> isnull<span class="token punctuation">(</span>b<span class="token punctuation">.</span>points_change<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">desc</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">as</span> rank_diff
<span class="token keyword">from</span> TeamPoints  a
<span class="token keyword">left</span> <span class="token keyword">join</span> pointschange b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>team_id <span class="token operator">=</span> b<span class="token punctuation">.</span>team_id



</code></pre> 
<h3><a id="77_7_4822"></a>77. 7天内两次购买的用户</h3> 
<p><img src="https://images2.imgbox.com/ab/d4/3VcGVaGU_o.png" alt="在这里插入图片描述"><br> 编写解决方案，获取 最多 间隔 7 天进行两次购买的用户的 id。<br> 返回按 user_id 排序的结果表。<br> 结果格式如下所示。<br> <img src="https://images2.imgbox.com/90/f8/ZDxMal3y_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Purchases'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Purchases
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Purchases<span class="token punctuation">(</span>
 purchase_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> user_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span> purchase_date  <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Purchases
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2022-03-13'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'2022-02-11'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">7</span>   <span class="token punctuation">,</span><span class="token string">'2022-06-19'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>   <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2022-03-20'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span> <span class="token number">7</span>   <span class="token punctuation">,</span><span class="token string">'2022-06-19'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2022-06-08'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>user_id
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span>  <span class="token operator">*</span>
        <span class="token punctuation">,</span>dateadd<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span>purchase_date <span class="token punctuation">)</span> <span class="token keyword">as</span> sevendaybefore
        <span class="token keyword">from</span> Purchases<span class="token punctuation">)</span> a
<span class="token keyword">left</span> <span class="token keyword">join</span> Purchases  b
<span class="token keyword">on</span> b<span class="token punctuation">.</span>purchase_date <span class="token operator">between</span> a<span class="token punctuation">.</span>purchase_date <span class="token operator">and</span> sevendaybefore
<span class="token operator">and</span> a<span class="token punctuation">.</span>user_id  <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id <span class="token punctuation">,</span>a<span class="token punctuation">.</span>purchase_date<span class="token punctuation">,</span>a<span class="token punctuation">.</span>sevendaybefore
<span class="token keyword">having</span>  <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> b<span class="token punctuation">.</span>purchase_id<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>user_id
<span class="token comment">--方法2</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>user_id <span class="token keyword">from</span> Purchases a<span class="token punctuation">,</span> Purchases b
<span class="token keyword">where</span> a<span class="token punctuation">.</span>purchase_id <span class="token operator">&lt;&gt;</span> b<span class="token punctuation">.</span>purchase_id
<span class="token operator">and</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id
<span class="token operator">and</span> abs<span class="token punctuation">(</span>datediff<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>purchase_date<span class="token punctuation">,</span>a<span class="token punctuation">.</span>purchase_date<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">7</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>



</code></pre> 
<h3><a id="78__4870"></a>78. 司机成为乘客的次数</h3> 
<p><img src="https://images2.imgbox.com/88/e5/UAhHY7TS_o.png" alt="在这里插入图片描述"><br> 编写解决方案，获取每个司机的 ID 和他们作为乘客的次数。<br> 以 任意顺序 返回结果表。<br> 结果格式如下所示。<br> <img src="https://images2.imgbox.com/57/fe/YDiDJNoe_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Rides'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Rides
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Rides<span class="token punctuation">(</span>
ride_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> driver_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>passenger_id  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Rides
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">7</span>   <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token number">7</span>   <span class="token punctuation">,</span><span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">11</span>  <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span> <span class="token number">11</span>  <span class="token punctuation">,</span><span class="token number">7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">,</span> <span class="token number">11</span>  <span class="token punctuation">,</span><span class="token number">7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>  <span class="token punctuation">,</span> <span class="token number">11</span>  <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>driver_id <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> ride_id <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> driver_id <span class="token keyword">from</span> rides <span class="token punctuation">)</span> a
<span class="token keyword">left</span> <span class="token keyword">join</span>     Rides b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>driver_id <span class="token operator">=</span> b<span class="token punctuation">.</span>passenger_id
<span class="token operator">and</span>  b<span class="token punctuation">.</span>passenger_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> driver_id <span class="token keyword">from</span> rides <span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>driver_id
</code></pre> 
<h3><a id="79_3_4905"></a>79. 连续两年有3个及以上订单的产品</h3> 
<p><img src="https://images2.imgbox.com/76/20/r0EGCjww_o.png" alt="在这里插入图片描述"><br> 编写解决方案，获取连续两年订购三次或三次以上的所有产品的 id。<br> 以 任意顺序 返回结果表。<br> 结果格式示例如下。</p> 
<pre><code class="prism language-sql">在这里插入代码片
</code></pre> 
<h3><a id="80__4915"></a>80. 周末任务计数</h3> 
<p><img src="https://images2.imgbox.com/8c/e0/Bt3jzVjt_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案来报告：<br> 在周末 (周六，周日) 提交的任务的数量 weekend_cnt，以及<br> 工作日内提交的任务数 working_cnt。<br> 按 任意顺序 返回结果表。<br> 返回结果格式如以下示例所示。<br> <img src="https://images2.imgbox.com/ce/af/NFZMqmQy_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Tasks'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Tasks
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Tasks<span class="token punctuation">(</span>
     task_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> assignee_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> submit_date  <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>   Tasks
<span class="token keyword">values</span>
 <span class="token punctuation">(</span>  <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2022-06-13'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">6</span>  <span class="token punctuation">,</span><span class="token string">'2022-06-14'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">6</span>  <span class="token punctuation">,</span><span class="token string">'2022-06-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'2022-06-18'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token number">5</span>  <span class="token punctuation">,</span><span class="token string">'2022-06-19'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span>  <span class="token number">6</span>  <span class="token punctuation">,</span><span class="token number">7</span>  <span class="token punctuation">,</span><span class="token string">'2022-06-19'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> weekday <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> weekend_cnt
<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> weekday <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> working_cnt
<span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>datepart<span class="token punctuation">(</span>weekday<span class="token punctuation">,</span>submit_date <span class="token punctuation">)</span> <span class="token keyword">as</span> weekday
    <span class="token keyword">from</span> Tasks <span class="token punctuation">)</span> a
</code></pre> 
<h3><a id="81__4950"></a>81. 按性别排列表格</h3> 
<p><img src="https://images2.imgbox.com/85/0d/wfjRD7s2_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案以重新排列 Genders 表，使行按顺序在 ‘female’, ‘other’ 和 ‘male’ 之间交替。同时每种性别按照 user_id 升序进行排序。<br> 按 上述顺序 返回结果表。<br> 返回结果格式如以下示例所示。</p> 
<p><img src="https://images2.imgbox.com/67/cb/8Ncb4exW_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Genders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Genders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Genders<span class="token punctuation">(</span>
  user_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> gender       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Genders
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'male'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>  <span class="token punctuation">,</span><span class="token string">'female'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'other'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token string">'male'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'female'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>  <span class="token punctuation">,</span><span class="token string">'male'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>  <span class="token punctuation">,</span><span class="token string">'other'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'other'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>  <span class="token punctuation">,</span><span class="token string">'female'</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> user_id<span class="token punctuation">,</span>gender <span class="token keyword">from</span>  <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> gender <span class="token operator">=</span> <span class="token string">'female'</span> <span class="token keyword">then</span> <span class="token number">1</span>
<span class="token keyword">when</span> gender <span class="token operator">=</span> <span class="token string">'other'</span> <span class="token keyword">then</span> <span class="token number">2</span>
<span class="token keyword">else</span> <span class="token number">3</span> <span class="token keyword">end</span> <span class="token keyword">as</span> Gender_idx
<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> gender <span class="token keyword">order</span> <span class="token keyword">by</span> user_id <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> Genders<span class="token punctuation">)</span> a
<span class="token keyword">order</span> <span class="token keyword">by</span> rnk<span class="token punctuation">,</span>gender_idx

</code></pre> 
<h3><a id="82__4993"></a>82. 每个城市最高气温的第一天</h3> 
<p><img src="https://images2.imgbox.com/6c/78/Wv0ClOcC_o.png" alt="在这里插入图片描述"><br> 编写解决方案，找出每个城市中有最高温度记录的日子。如果同一城市多次记录最高气温，则返回其中最早的一天。<br> 返回按 city_id 升序排序 的结果表。<br> 查询结果格式示例如下。</p> 
<p><img src="https://images2.imgbox.com/9f/c9/nXczJ5SR_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Weather'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Weather
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Weather<span class="token punctuation">(</span>
  city_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> <span class="token keyword">day</span>          <span class="token keyword">date</span>
<span class="token punctuation">,</span> degree       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Weather
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2022-01-07'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">12</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2022-03-07'</span><span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2022-07-07'</span><span class="token punctuation">,</span><span class="token number">24</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'2022-08-07'</span><span class="token punctuation">,</span><span class="token number">37</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'2022-08-17'</span><span class="token punctuation">,</span><span class="token number">37</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">,</span><span class="token string">'2022-02-07'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">7</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">,</span><span class="token string">'2022-12-07'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">6</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> city_id<span class="token punctuation">,</span><span class="token keyword">day</span>    <span class="token punctuation">,</span>degree
<span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> city_id <span class="token keyword">order</span> <span class="token keyword">by</span> degree <span class="token keyword">desc</span> <span class="token punctuation">,</span><span class="token keyword">day</span> <span class="token keyword">asc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
    <span class="token keyword">from</span> Weather <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> city_id
</code></pre> 
<h3><a id="83__5030"></a>83. 以百分比计算排名</h3> 
<p><img src="https://images2.imgbox.com/6c/53/VnBNIxyI_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案，以百分比的形式报告每个学生在其部门的排名，其中排名的百分比使用以下公式计算:<br> (student_rank_in_the_department - 1) * 100 / (the_number_of_students_in_the_department - 1)。 percentage 应该 四舍五入到小数点后两位。<br> student_rank_in_the_department 由 mark 的降序决定，mark 最高的学生是 rank 1。如果两个学生得到相同的分数，他们也会得到相同的排名。<br> 以 任意顺序 返回结果表。<br> 结果格式如下所示。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Students'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Students
 go
 <span class="token keyword">create</span> <span class="token keyword">table</span> Students<span class="token punctuation">(</span>
 student_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>department_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span>mark           <span class="token keyword">int</span>
 <span class="token punctuation">)</span>
 go
 <span class="token keyword">insert</span> <span class="token keyword">into</span> Students
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">650</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>   <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">650</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>   <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">920</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">610</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">530</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> student_id <span class="token punctuation">,</span> department_id
<span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> isnull<span class="token punctuation">(</span>cnt<span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token function">round</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rnk<span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">/</span><span class="token punctuation">(</span>cnt<span class="token operator">-</span> <span class="token number">1</span>  <span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">)</span> <span class="token keyword">end</span> <span class="token keyword">as</span> percentage
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
     <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>student_id <span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> department_id<span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> department_id  <span class="token keyword">order</span> <span class="token keyword">by</span> mark <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> Students <span class="token punctuation">)</span> a

</code></pre> 
<h3><a id="84__5067"></a>84. 将表中的空值更改为前一个值</h3> 
<p><img src="https://images2.imgbox.com/b1/70/JZodal9k_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案将 drink 的 null 值替换为前面最近一行不为 null 的 drink。保证表第一行的 drink 不为 null。<br> 返回 与输入顺序相同的 结果表。<br> 查询结果格式示例如下。<br> <img src="https://images2.imgbox.com/28/33/UNqT6erM_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'CoffeeShop'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> CoffeeShop
go
<span class="token keyword">create</span> <span class="token keyword">table</span> CoffeeShop<span class="token punctuation">(</span>
 id         <span class="token keyword">int</span>
<span class="token punctuation">,</span> drink       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> CoffeeShop
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">9</span>  <span class="token punctuation">,</span><span class="token string">'Rum and Coke'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>  <span class="token punctuation">,</span><span class="token boolean">null</span>             <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>  <span class="token punctuation">,</span><span class="token boolean">null</span>             <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'St Germain Spritz'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'Orange Margarita'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token boolean">null</span>             <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

<span class="token keyword">with</span> c <span class="token keyword">as</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> id<span class="token punctuation">,</span>drink<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> coffeeshop
<span class="token punctuation">)</span><span class="token punctuation">,</span>d <span class="token keyword">as</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> a<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    iif<span class="token punctuation">(</span>drink <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>drink<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">1</span> drink <span class="token keyword">from</span> c <span class="token keyword">where</span> rn <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>rn <span class="token operator">and</span> drink <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">order</span> <span class="token keyword">by</span> rn <span class="token keyword">desc</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">as</span> drink   <span class="token keyword">from</span> c a
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> d 

<span class="token comment">--方法2</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span><span class="token function">MAX</span><span class="token punctuation">(</span>drink<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> total<span class="token punctuation">)</span> <span class="token keyword">AS</span> drink
<span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>drink<span class="token punctuation">,</span>rn<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> drink <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">then</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">1</span> <span class="token keyword">end</span> <span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> rn<span class="token punctuation">)</span> <span class="token keyword">AS</span> total
    <span class="token keyword">from</span> <span class="token punctuation">(</span>
       <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span>drink<span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
       <span class="token keyword">FROM</span> CoffeeShop
    <span class="token punctuation">)</span>t1
<span class="token punctuation">)</span>t2
<span class="token keyword">order</span> <span class="token keyword">by</span> rn<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="_5119"></a>难度：困难</h2> 
<h3><a id="1__5120"></a>1. 部门工资前三高的所有员工</h3> 
<p>Employee 表包含所有员工信息，每个员工有其对应的工号 Id，姓名 Name，工资 Salary 和部门编号 DepartmentId 。<br> <img src="https://images2.imgbox.com/b6/fd/AYa7MPFp_o.png" alt="在这里插入图片描述"><br> Department 表包含公司所有部门的信息。<br> <img src="https://images2.imgbox.com/74/34/T21icS4t_o.png" alt="在这里插入图片描述"><br> 编写一个 SQL 查询，找出每个部门获得前三高工资的所有员工。例如，根据上述给定的表，查询结果应返回：<br> <img src="https://images2.imgbox.com/f7/aa/8eaK0N5L_o.png" alt="在这里插入图片描述"><br> 解释：<br> IT部门中，Max获得了最高的工资，Randy和Joe都拿到了第二高的工资，Will的工资排第三。销售部门（Sales）只有两名员工，Henry的工资最高，Sam的工资排第二。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> b<span class="token punctuation">.</span>Name <span class="token keyword">as</span> Department<span class="token punctuation">,</span>a<span class="token punctuation">.</span>Name <span class="token keyword">as</span> Employee<span class="token punctuation">,</span>a<span class="token punctuation">.</span>Salary
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> departmentid <span class="token keyword">order</span> <span class="token keyword">by</span> Salary <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk <span class="token keyword">from</span> Employee<span class="token punctuation">)</span> a 
<span class="token keyword">left</span> <span class="token keyword">join</span> department b 
<span class="token keyword">on</span> a<span class="token punctuation">.</span>departmentid <span class="token operator">=</span> b<span class="token punctuation">.</span>Id 
<span class="token keyword">where</span> a<span class="token punctuation">.</span>rnk <span class="token operator">&lt;=</span> <span class="token number">3</span>

</code></pre> 
<h3><a id="2__5141"></a>2. 行程和用户</h3> 
<p>表：Trips<br> <img src="https://images2.imgbox.com/8d/7a/5N8fwvg6_o.png" alt="在这里插入图片描述"><br> 表：Users<br> <img src="https://images2.imgbox.com/e5/e8/zOfzMNGP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3__5147"></a>3. 体育馆的人流量</h3> 
<p>编写一个 SQL 查询以找出每行的人数大于或等于 100 且 id 连续的三行或更多行记录。<br> 返回按 visit_date 升序排列的结果表。</p> 
<pre><code class="prism language-sql">
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'stadium'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> stadium

<span class="token keyword">create</span> <span class="token keyword">table</span> stadium<span class="token punctuation">(</span>
    id <span class="token keyword">int</span> <span class="token keyword">identity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span>visit_date <span class="token keyword">date</span>
    <span class="token punctuation">,</span>people <span class="token keyword">int</span>
<span class="token punctuation">)</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> stadium<span class="token punctuation">(</span>visit_date<span class="token punctuation">,</span> people<span class="token punctuation">)</span>
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token string">'2017-01-01'</span> <span class="token punctuation">,</span> <span class="token number">10</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2017-01-02'</span> <span class="token punctuation">,</span> <span class="token number">109</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2017-01-03'</span> <span class="token punctuation">,</span> <span class="token number">150</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2017-01-04'</span> <span class="token punctuation">,</span> <span class="token number">99</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2017-01-05'</span> <span class="token punctuation">,</span> <span class="token number">145</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2017-01-06'</span> <span class="token punctuation">,</span> <span class="token number">1455</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2017-01-07'</span> <span class="token punctuation">,</span> <span class="token number">199</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2017-01-09'</span> <span class="token punctuation">,</span> <span class="token number">188</span>     <span class="token punctuation">)</span>

<span class="token keyword">select</span> id<span class="token punctuation">,</span>visit_date<span class="token punctuation">,</span>people
<span class="token keyword">from</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> id<span class="token punctuation">,</span> visit_date<span class="token punctuation">,</span> people<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>fz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
         <span class="token keyword">from</span> <span class="token punctuation">(</span>
                  <span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> id <span class="token operator">-</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token punctuation">)</span> <span class="token keyword">as</span> fz
                  <span class="token keyword">from</span> stadium
                  <span class="token keyword">where</span> people <span class="token operator">&gt;=</span> <span class="token number">100</span>
              <span class="token punctuation">)</span> a
     <span class="token punctuation">)</span> a
<span class="token keyword">where</span> cnt <span class="token operator">&gt;</span> <span class="token number">3</span>





</code></pre> 
<h3><a id="4__5191"></a>4. 员工薪水的中位数</h3> 
<p>写一个SQL查询，找出每个公司的工资中位数。<br> 以 任意顺序 返回结果表。<br> 查询结果格式如下所示。<br> Employee表：<br> <img src="https://images2.imgbox.com/f5/cc/pK1OALea_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4b/3d/eIQqCRsE_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql">
<span class="token comment">--方法一：</span>
<span class="token comment">--注意事项：排序时用row_number,会有排名相同的情况</span>
<span class="token comment">--中位数的逻辑了解：不论个数是奇数偶数，中位数在总数除以2和总数除以2加1之间</span>
<span class="token keyword">select</span> id <span class="token punctuation">,</span>company<span class="token punctuation">,</span>salary
<span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> company <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
    <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> company <span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
    <span class="token keyword">from</span> Employee<span class="token punctuation">)</span> a
<span class="token keyword">where</span>  rnk <span class="token operator">BETWEEN</span> cnt<span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">AND</span> cnt<span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span>


</code></pre> 
<h3><a id="5__5214"></a>5. 同一天的第一个电话和最后一个电话</h3> 
<p>编写一个 SQL 查询来找出那些ID们在任意一天的第一个电话和最后一个电话都是和同一个人的。这些电话不论是拨打者还是接收者都会被记录。<br> 结果请放在一个任意次序约束的表中。<br> 查询结果格式如下所示：<br> <img src="https://images2.imgbox.com/c6/0e/ozWhTKPR_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--MySQL </span>
<span class="token keyword">with</span> <span class="token keyword">temp</span> <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> calls
            <span class="token keyword">union</span> <span class="token keyword">all</span>
            <span class="token keyword">select</span> recipient_id caller_id<span class="token punctuation">,</span> caller_id recipient_id<span class="token punctuation">,</span> call_time <span class="token keyword">from</span> calls
    <span class="token punctuation">)</span><span class="token punctuation">,</span>

temp1 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span>
            <span class="token operator">*</span><span class="token punctuation">,</span>
            dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>call_time<span class="token punctuation">,</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>caller_id <span class="token keyword">order</span> <span class="token keyword">by</span> call_time <span class="token keyword">asc</span><span class="token punctuation">)</span> rk1<span class="token punctuation">,</span>
            dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> date_format<span class="token punctuation">(</span>call_time<span class="token punctuation">,</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>caller_id <span class="token keyword">order</span> <span class="token keyword">by</span> call_time <span class="token keyword">desc</span><span class="token punctuation">)</span> rk2
        <span class="token keyword">from</span> <span class="token keyword">temp</span>
    <span class="token punctuation">)</span>

<span class="token keyword">select</span>
    <span class="token keyword">distinct</span> caller_id <span class="token keyword">as</span> user_id
<span class="token keyword">from</span> temp1
<span class="token keyword">where</span> rk1 <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">or</span> rk2 <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> caller_id<span class="token punctuation">,</span> date_format<span class="token punctuation">(</span>call_time<span class="token punctuation">,</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> recipient_id<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>

</code></pre> 
<h3><a id="5__5242"></a>5. 查询员工的累计薪水</h3> 
<p>Employee 表保存了一年内的薪水信息。<br> 请你编写 SQL 语句，对于每个员工，查询他除最近一个月（即最大月）之外，剩下每个月的近三个月的累计薪水（不足三个月也要计算）。<br> 结果请按 Id 升序，然后按 Month 降序显示。<br> <img src="https://images2.imgbox.com/6c/4f/PWtTrpVW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/46/34/XqhrNoBE_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--MySQL</span>
<span class="token comment">--注意点：剔除最大月要以员工为单位去看，还有就是其他月份算累计只要计算近三个月的</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>id <span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token keyword">month</span> <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>salary<span class="token punctuation">)</span>  <span class="token keyword">as</span> Salary
<span class="token keyword">from</span> Employee a 
<span class="token keyword">left</span> <span class="token keyword">join</span> Employee b 
<span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id <span class="token operator">and</span> a<span class="token punctuation">.</span><span class="token keyword">Month</span> <span class="token operator">&gt;=</span> b<span class="token punctuation">.</span><span class="token keyword">Month</span>  <span class="token operator">and</span> a<span class="token punctuation">.</span><span class="token keyword">Month</span> <span class="token operator">&lt;</span> b<span class="token punctuation">.</span><span class="token keyword">Month</span> <span class="token operator">+</span> <span class="token number">3</span>
<span class="token keyword">where</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token keyword">Month</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> Id<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token keyword">Month</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> Employee <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Id<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>id <span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token keyword">month</span> 
<span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">asc</span> <span class="token punctuation">,</span><span class="token keyword">month</span> <span class="token keyword">desc</span>

<span class="token comment">--MS SQL Server</span>
<span class="token keyword">WITH</span> T <span class="token keyword">AS</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">month</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">month</span> <span class="token keyword">from</span> Employee <span class="token keyword">group</span> <span class="token keyword">by</span> id
<span class="token punctuation">)</span>

<span class="token keyword">select</span> a<span class="token punctuation">.</span>id <span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token keyword">month</span> <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>salary<span class="token punctuation">)</span>  <span class="token keyword">as</span> Salary
<span class="token keyword">from</span> Employee a 
<span class="token keyword">left</span> <span class="token keyword">join</span> Employee b 
<span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id <span class="token operator">and</span> a<span class="token punctuation">.</span><span class="token keyword">Month</span> <span class="token operator">&gt;=</span> b<span class="token punctuation">.</span><span class="token keyword">Month</span>  <span class="token operator">and</span> a<span class="token punctuation">.</span><span class="token keyword">Month</span> <span class="token operator">&lt;</span> b<span class="token punctuation">.</span><span class="token keyword">Month</span> <span class="token operator">+</span> <span class="token number">3</span>
<span class="token keyword">where</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t b  <span class="token keyword">where</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id <span class="token operator">and</span> a<span class="token punctuation">.</span><span class="token keyword">month</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token keyword">month</span><span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>id <span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token keyword">month</span> 
<span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">asc</span> <span class="token punctuation">,</span><span class="token keyword">month</span> <span class="token keyword">desc</span>



</code></pre> 
<h3><a id="6__5278"></a>6. 给定数字的频率查询中位数</h3> 
<p>中位数 是将数据样本中半数较高值和半数较低值分隔开的值。<br> 编写一个 SQL 查询，解压 Numbers 表，报告数据库中所有数字的 中位数 。结果四舍五入至 一位小数 。<br> 查询结果如下例所示。<br> <img src="https://images2.imgbox.com/9f/21/wfL4QgbT_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--中位数逻辑：按大小排序后，不论正序降序排序，中位数的排序都会大于总数的一半</span>
<span class="token keyword">select</span> cast <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> median
<span class="token keyword">from</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> Num<span class="token punctuation">,</span> frequency<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>frequency<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> Num <span class="token keyword">asc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total<span class="token punctuation">,</span>
        <span class="token function">sum</span><span class="token punctuation">(</span>frequency<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> Num <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> total1
<span class="token keyword">from</span> Numbers
<span class="token punctuation">)</span><span class="token keyword">as</span> a
<span class="token keyword">where</span> total<span class="token operator">&gt;=</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>frequency<span class="token punctuation">)</span> <span class="token keyword">from</span> Numbers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
<span class="token operator">and</span> total1<span class="token operator">&gt;=</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>frequency<span class="token punctuation">)</span> <span class="token keyword">from</span> Numbers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
</code></pre> 
<h3><a id="7__5297"></a>7. 查询员工的累计薪水</h3> 
<p>Employee 表保存了一年内的薪水信息。<br> 请你编写 SQL 语句，对于每个员工，查询他除最近一个月（即最大月）之外，剩下每个月的近三个月的累计薪水（不足三个月也要计算）。<br> 结果请按 Id 升序，然后按 Month 降序显示。<br> 示例：<br> 输入：<br> <img src="https://images2.imgbox.com/cf/7b/UyPqoj0Y_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employee'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employee
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employee  <span class="token punctuation">(</span>
    Id <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">Month</span> <span class="token keyword">int</span><span class="token punctuation">,</span> Salary <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employee
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">20</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">20</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">30</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">30</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">40</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">40</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">60</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">4</span>    <span class="token punctuation">,</span> <span class="token number">60</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">4</span>    <span class="token punctuation">,</span> <span class="token number">70</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> id  <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">month</span> <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> Employee <span class="token punctuation">)</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>id<span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token keyword">month</span> <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>salary <span class="token punctuation">)</span> <span class="token keyword">as</span> salary
<span class="token keyword">from</span> T a
<span class="token keyword">left</span> <span class="token keyword">join</span> T b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id <span class="token operator">and</span> b<span class="token punctuation">.</span><span class="token keyword">month</span> <span class="token operator">&lt;=</span> a<span class="token punctuation">.</span><span class="token keyword">month</span> <span class="token operator">and</span> a<span class="token punctuation">.</span><span class="token keyword">month</span> <span class="token operator">-</span><span class="token number">3</span> <span class="token operator">&lt;</span> b<span class="token punctuation">.</span><span class="token keyword">month</span>
<span class="token keyword">where</span> a<span class="token punctuation">.</span>rnk <span class="token operator">&lt;&gt;</span><span class="token number">1</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>id<span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token keyword">month</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>id <span class="token keyword">asc</span><span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token keyword">month</span> <span class="token keyword">desc</span>
</code></pre> 
<h3><a id="8__5339"></a>8. 学生地理信息报告</h3> 
<p>一所学校有来自亚洲、欧洲和美洲的学生。<br> 写一个查询语句实现对大洲（continent）列的 透视表 操作，使得每个学生按照姓名的字母顺序依次排列在对应的大洲下面。输出的标题应依次为美洲（America）、亚洲（Asia）和欧洲（Europe）。<br> 测试用例的生成使得来自美国的学生人数不少于亚洲或欧洲的学生人数。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'student'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> student
go
<span class="token keyword">create</span> <span class="token keyword">table</span> student <span class="token punctuation">(</span>
  name         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> continent   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> student
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token string">'Jane'</span>   <span class="token punctuation">,</span><span class="token string">'America'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Pascal'</span> <span class="token punctuation">,</span><span class="token string">'Europe'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Xi'</span>     <span class="token punctuation">,</span><span class="token string">'Asia'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token string">'Jack'</span>   <span class="token punctuation">,</span><span class="token string">'America'</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> continent <span class="token keyword">order</span> <span class="token keyword">by</span> name <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> student<span class="token punctuation">)</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>name <span class="token keyword">as</span> America<span class="token punctuation">,</span>b<span class="token punctuation">.</span>name <span class="token keyword">as</span> Asia<span class="token punctuation">,</span>c<span class="token punctuation">.</span>name <span class="token keyword">as</span> Europe
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> rnk <span class="token keyword">from</span> T <span class="token punctuation">)</span> o
<span class="token keyword">left</span> <span class="token keyword">join</span> T a
<span class="token keyword">on</span> a<span class="token punctuation">.</span>rnk <span class="token operator">=</span> o<span class="token punctuation">.</span>rnk <span class="token operator">and</span> a<span class="token punctuation">.</span>continent <span class="token operator">=</span> <span class="token string">'America'</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> T b
<span class="token keyword">on</span> o<span class="token punctuation">.</span>rnk <span class="token operator">=</span> b<span class="token punctuation">.</span>rnk <span class="token operator">and</span> b<span class="token punctuation">.</span>continent <span class="token operator">=</span> <span class="token string">'Asia'</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> T c
<span class="token keyword">on</span>  o<span class="token punctuation">.</span>rnk <span class="token operator">=</span> c<span class="token punctuation">.</span>rnk <span class="token operator">and</span> c<span class="token punctuation">.</span>continent <span class="token operator">=</span> <span class="token string">'Europe'</span>

</code></pre> 
<h3><a id="9__5374"></a>9. 同一天的第一个和最后一个电话</h3> 
<p>编写一个 SQL 查询来找出那些ID们在任意一天的第一个电话和最后一个电话都是和同一个人的。这些电话不论是拨打者还是接收者都会被记录。<br> 结果请放在一个任意次序约束的表中。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'Calls'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Calls
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Calls<span class="token punctuation">(</span>
  caller_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> recipient_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> call_time     <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Calls
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">8</span>     <span class="token punctuation">,</span><span class="token number">4</span>       <span class="token punctuation">,</span><span class="token string">'2021-08-24 17:46:07'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>     <span class="token punctuation">,</span><span class="token number">8</span>       <span class="token punctuation">,</span><span class="token string">'2021-08-24 19:57:13'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span>     <span class="token punctuation">,</span><span class="token number">1</span>       <span class="token punctuation">,</span><span class="token string">'2021-08-11 05:28:44'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>     <span class="token punctuation">,</span><span class="token number">3</span>       <span class="token punctuation">,</span><span class="token string">'2021-08-17 04:04:15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">11</span>    <span class="token punctuation">,</span><span class="token number">3</span>       <span class="token punctuation">,</span><span class="token string">'2021-08-17 13:07:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>     <span class="token punctuation">,</span><span class="token number">11</span>      <span class="token punctuation">,</span><span class="token string">'2021-08-17 22:22:22'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> caller_id<span class="token punctuation">,</span> recipient_id<span class="token punctuation">,</span> call_time
            <span class="token keyword">FROM</span> Calls
            <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
            <span class="token keyword">SELECT</span> recipient_id <span class="token punctuation">,</span> caller_id <span class="token punctuation">,</span> call_time
            <span class="token keyword">FROM</span> Calls  <span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> a<span class="token punctuation">.</span>caller_id user_id
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> caller_id<span class="token punctuation">,</span> recipient_id<span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> caller_id<span class="token punctuation">,</span> cast<span class="token punctuation">(</span>call_time <span class="token keyword">as</span> <span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> call_time<span class="token punctuation">)</span> <span class="token keyword">AS</span> rk
        <span class="token keyword">FROM</span> T<span class="token punctuation">)</span> a
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> caller_id<span class="token punctuation">,</span> recipient_id<span class="token punctuation">,</span> dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> caller_id<span class="token punctuation">,</span> cast<span class="token punctuation">(</span>call_time <span class="token keyword">as</span> <span class="token keyword">date</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> call_time <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rk
            <span class="token keyword">FROM</span> T<span class="token punctuation">)</span> b
<span class="token keyword">ON</span> a<span class="token punctuation">.</span>caller_id <span class="token operator">=</span> b<span class="token punctuation">.</span>caller_id <span class="token operator">AND</span> a<span class="token punctuation">.</span>recipient_id <span class="token operator">=</span> b<span class="token punctuation">.</span>recipient_id <span class="token operator">AND</span> a<span class="token punctuation">.</span>rk <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> b<span class="token punctuation">.</span>rk <span class="token operator">=</span> <span class="token number">1</span>



</code></pre> 
<h3><a id="10__5416"></a>10. 职员招聘人数</h3> 
<p>一家公司想雇佣新员工。公司的工资预算是 70000 美元。公司的招聘标准是：<br> 雇佣最多的高级员工。<br> 在雇佣最多的高级员工后，使用剩余预算雇佣最多的初级员工。<br> 编写一个SQL查询，查找根据上述标准雇佣的高级员工和初级员工的数量。<br> 按 任意顺序 返回结果表。<br> <img src="https://images2.imgbox.com/03/5e/JJ4Rzkry_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Candidates'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Candidates
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Candidates<span class="token punctuation">(</span>
  employee_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> experience   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> salary       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Candidates
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token string">'Junior'</span>    <span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>     <span class="token punctuation">,</span><span class="token string">'Junior'</span>    <span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token string">'Senior'</span>    <span class="token punctuation">,</span><span class="token number">20000</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">11</span>    <span class="token punctuation">,</span><span class="token string">'Senior'</span>    <span class="token punctuation">,</span><span class="token number">20000</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">13</span>    <span class="token punctuation">,</span><span class="token string">'Senior'</span>    <span class="token punctuation">,</span><span class="token number">50000</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>     <span class="token punctuation">,</span><span class="token string">'Junior'</span>    <span class="token punctuation">,</span><span class="token number">40000</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">WITH</span> SeniorTotal <span class="token keyword">AS</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> totalone
<span class="token keyword">FROM</span> Candidates
<span class="token keyword">WHERE</span> experience <span class="token operator">=</span> <span class="token string">'Senior'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
SeniorNumber <span class="token keyword">AS</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>totalone<span class="token punctuation">)</span> totals
<span class="token keyword">FROM</span> SeniorTotal
<span class="token keyword">WHERE</span> totalone <span class="token operator">&lt;=</span> <span class="token number">70000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
JuniorTotal  <span class="token keyword">AS</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> totaltwo
<span class="token keyword">FROM</span> Candidates
<span class="token keyword">WHERE</span> experience <span class="token operator">=</span> <span class="token string">'Junior'</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token string">'Senior'</span> <span class="token keyword">AS</span> experience<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> employee_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> accepted_candidates
<span class="token keyword">FROM</span> SeniorTotal
<span class="token keyword">WHERE</span> totalone <span class="token operator">&lt;=</span> <span class="token number">70000</span>
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
<span class="token keyword">SELECT</span> <span class="token string">'Junior'</span> <span class="token keyword">AS</span> experience<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> employee_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> accepted_candidates
<span class="token keyword">FROM</span> JuniorTotal<span class="token punctuation">,</span> SeniorNumber
<span class="token keyword">WHERE</span> totaltwo <span class="token operator">&lt;</span> <span class="token number">70000</span> <span class="token operator">-</span> isnull<span class="token punctuation">(</span>totals<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>




</code></pre> 
<h3><a id="11___5470"></a>11. 职员招聘人数 ②</h3> 
<p>一家公司想雇佣新员工。公司的工资预算是 7 万美元。公司的招聘标准是：<br> 继续雇佣薪水最低的高级职员，直到你不能再雇佣更多的高级职员。<br> 用剩下的预算雇佣薪水最低的初级职员。<br> 继续以最低的工资雇佣初级职员，直到你不能再雇佣更多的初级职员。<br> 编写一个SQL查询，查找根据上述条件雇用职员的 ID。<br> 按 任意顺序 返回结果表。<br> <img src="https://images2.imgbox.com/46/25/uyeJFmeh_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Candidates'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Candidates
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Candidates<span class="token punctuation">(</span>
  employee_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> experience   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> salary       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Candidates
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>     <span class="token punctuation">,</span><span class="token string">'Junior'</span><span class="token punctuation">,</span><span class="token number">10000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>     <span class="token punctuation">,</span><span class="token string">'Junior'</span><span class="token punctuation">,</span><span class="token number">15000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>     <span class="token punctuation">,</span><span class="token string">'Senior'</span><span class="token punctuation">,</span><span class="token number">20000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">11</span>    <span class="token punctuation">,</span><span class="token string">'Senior'</span><span class="token punctuation">,</span><span class="token number">16000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">13</span>    <span class="token punctuation">,</span><span class="token string">'Senior'</span><span class="token punctuation">,</span><span class="token number">50000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>     <span class="token punctuation">,</span><span class="token string">'Junior'</span><span class="token punctuation">,</span><span class="token number">40000</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">WITH</span> SeniorTotal <span class="token keyword">AS</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> totalone
<span class="token keyword">FROM</span> Candidates
<span class="token keyword">WHERE</span> experience <span class="token operator">=</span> <span class="token string">'Senior'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
SeniorNumber <span class="token keyword">AS</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>totalone<span class="token punctuation">)</span> totals
<span class="token keyword">FROM</span> SeniorTotal
<span class="token keyword">WHERE</span> totalone <span class="token operator">&lt;=</span> <span class="token number">70000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
JuniorTotal  <span class="token keyword">AS</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> employee_id<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> totaltwo
<span class="token keyword">FROM</span> Candidates
<span class="token keyword">WHERE</span> experience <span class="token operator">=</span> <span class="token string">'Junior'</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> employee_id
<span class="token keyword">FROM</span> SeniorTotal
<span class="token keyword">WHERE</span> totalone <span class="token operator">&lt;=</span> <span class="token number">70000</span>
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> employee_id
<span class="token keyword">FROM</span> JuniorTotal<span class="token punctuation">,</span> SeniorNumber
<span class="token keyword">WHERE</span> totaltwo <span class="token operator">&lt;</span> <span class="token number">70000</span> <span class="token operator">-</span> isnull<span class="token punctuation">(</span>totals<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="12__5521"></a>12. 找到每篇文章的主题</h3> 
<p>Leetcode 从其社交媒体网站上收集了一些帖子，并对每个帖子的主题感兴趣。每个主题可以由一个或多个关键字表示。如果某个主题的关键字存在于一个帖子的内容中 (不区分大小写)，那么这个帖子就有这个主题。<br> 编写一个 SQL 查询，根据以下规则查找每篇文章的主题:<br> 如果帖子没有来自任何主题的关键词，那么它的主题应该是 “Ambiguous!”。<br> 如果该帖子至少有一个主题的关键字，其主题应该是其主题的 id 按升序排列并以逗号 ‘，’ 分隔的字符串。字符串不应该包含重复的 id。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Keywords'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Keywords
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Keywords <span class="token punctuation">(</span>
  topic_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> word         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Keywords
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token string">'handball'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token string">'football'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span><span class="token string">'WAR'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token string">'Vaccine'</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Posts'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Posts
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Posts<span class="token punctuation">(</span>
    post_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>content      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Posts
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'We call it soccer They call it football hahaha'</span>                         <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'Americans prefer basketball while Europeans love handball and football'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'stop the war and play handball'</span>                                         <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'warning I planted some flowers this morning and then got vaccinated'</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span>  <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>post_id <span class="token punctuation">,</span>a<span class="token punctuation">.</span>content<span class="token punctuation">,</span>b<span class="token punctuation">.</span>topic_id

        <span class="token keyword">from</span> Posts a
        <span class="token keyword">cross</span> <span class="token keyword">join</span>  Keywords b
        <span class="token keyword">where</span> charindex<span class="token punctuation">(</span>b<span class="token punctuation">.</span>word<span class="token operator">+</span><span class="token string">' '</span><span class="token punctuation">,</span>a<span class="token punctuation">.</span>content<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>
           <span class="token operator">or</span> charindex<span class="token punctuation">(</span><span class="token string">' '</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>word<span class="token punctuation">,</span>a<span class="token punctuation">.</span>content<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span>  <span class="token punctuation">)</span>

<span class="token keyword">select</span> post_id
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> isnull<span class="token punctuation">(</span>stuff<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token string">','</span> <span class="token operator">+</span> cast<span class="token punctuation">(</span>topic_id <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">from</span> T <span class="token keyword">where</span> post_id <span class="token operator">=</span> a<span class="token punctuation">.</span>post_id  <span class="token keyword">for</span> xml path<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'Ambiguous!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> topic
<span class="token keyword">from</span> Posts a
</code></pre> 
<h3><a id="13__5573"></a>13. 生成发票</h3> 
<p>编写一个 SQL 查询来显示价格最高的发票的详细信息。如果两个或多个发票具有相同的价格，则返回 invoice_id 最小的发票的详细信息。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span>
<span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Products
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Products <span class="token punctuation">(</span>
    product_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> price        <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Products
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>         <span class="token punctuation">,</span> <span class="token number">100</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>         <span class="token punctuation">,</span> <span class="token number">200</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Purchases'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Purchases
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Purchases<span class="token punctuation">(</span>
invoice_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>product_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>quantity     <span class="token keyword">int</span>

<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span>  <span class="token keyword">into</span> Purchases
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>     <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">10</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>Product_id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>quantity<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>quantity <span class="token operator">*</span> p<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> Price
<span class="token keyword">from</span> Purchases a
<span class="token keyword">left</span> <span class="token keyword">join</span> Products p
<span class="token keyword">on</span> a<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id
<span class="token keyword">where</span> invoice_id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> invoice_id 
                    <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> sumprice <span class="token keyword">desc</span><span class="token punctuation">,</span>invoice_id <span class="token keyword">asc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
                            <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span>invoice_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>quantity  <span class="token operator">*</span> P<span class="token punctuation">.</span>price <span class="token punctuation">)</span> <span class="token keyword">as</span> SumPrice
                                    <span class="token keyword">from</span> Purchases  a
                                    <span class="token keyword">left</span> <span class="token keyword">join</span> Products P
                                    <span class="token keyword">on</span> a<span class="token punctuation">.</span>product_id <span class="token operator">=</span> P<span class="token punctuation">.</span>product_id
                                    <span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>invoice_id<span class="token punctuation">)</span> a <span class="token punctuation">)</span> a
                    <span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>Product_id<span class="token punctuation">,</span> a<span class="token punctuation">.</span>quantity
</code></pre> 
<h3><a id="14__5626"></a>14. 受欢迎度百分比</h3> 
<p>编写一条 SQL 查询，找出 Meta/Facebook 平台上每个用户的受欢迎度的百分比。受欢迎度百分比定义为用户拥有的朋友总数除以平台上的总用户数，然后乘以 100，并 四舍五入保留 2 位小数 。<br> 返回按照 user1 升序 排序的结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Friends'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Friends
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Friends <span class="token punctuation">(</span>
    user1     <span class="token keyword">int</span>
<span class="token punctuation">,</span> user2       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Friends
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">5</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">6</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">6</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>    <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>    <span class="token punctuation">,</span> <span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">9</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T <span class="token keyword">as</span><span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> friends
    <span class="token keyword">union</span>
    <span class="token keyword">select</span> user2<span class="token punctuation">,</span>user1 <span class="token keyword">from</span> friends
<span class="token punctuation">)</span>
<span class="token keyword">select</span> user1
     <span class="token punctuation">,</span>CAST<span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> user2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> user1<span class="token punctuation">)</span> <span class="token keyword">from</span> T<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> percentage_popularity
<span class="token keyword">from</span> T
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> USER1
<span class="token keyword">order</span> <span class="token keyword">by</span> user1
</code></pre> 
<h3><a id="15__5664"></a>15. 购买量严格增加的客户</h3> 
<p>编写一个 SQL 查询，报告 总购买量 每年严格增加的客户 id。<br> 客户在一年内的 总购买量 是该年订单价格的总和。如果某一年客户没有下任何订单，我们认为总购买量为 0。<br> 对于每个客户，要考虑的第一个年是他们 第一次下单 的年份。<br> 对于每个客户，要考虑的最后一年是他们 最后一次下单 的年份。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 建表</span>
<span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders<span class="token punctuation">(</span>
order_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> customer_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span> order_date    <span class="token keyword">date</span>
<span class="token punctuation">,</span> price         <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'2019-07-01'</span><span class="token punctuation">,</span><span class="token number">1100</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'2019-11-01'</span><span class="token punctuation">,</span><span class="token number">1200</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'2020-05-26'</span><span class="token punctuation">,</span><span class="token number">3000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>    <span class="token punctuation">,</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'2021-08-31'</span><span class="token punctuation">,</span><span class="token number">3100</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span>    <span class="token punctuation">,</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'2022-12-07'</span><span class="token punctuation">,</span><span class="token number">4700</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span>    <span class="token punctuation">,</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token string">'2015-01-01'</span><span class="token punctuation">,</span><span class="token number">700</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span>    <span class="token punctuation">,</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token string">'2017-11-07'</span><span class="token punctuation">,</span><span class="token number">1000</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span>    <span class="token punctuation">,</span> <span class="token number">3</span>      <span class="token punctuation">,</span><span class="token string">'2017-01-01'</span><span class="token punctuation">,</span><span class="token number">900</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>    <span class="token punctuation">,</span> <span class="token number">3</span>      <span class="token punctuation">,</span><span class="token string">'2018-11-07'</span><span class="token punctuation">,</span><span class="token number">900</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">WITH</span> T <span class="token keyword">AS</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> customer_id<span class="token punctuation">,</span>datepart<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span>order_date<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">year</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price <span class="token punctuation">)</span> <span class="token keyword">as</span> Price_SUM
<span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> customer_id <span class="token keyword">order</span> <span class="token keyword">by</span> datepart<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span>order_date<span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> Orders
<span class="token keyword">group</span> <span class="token keyword">by</span> customer_id <span class="token punctuation">,</span>datepart<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span>order_date<span class="token punctuation">)</span>
 <span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>customer_id
<span class="token keyword">from</span> T a
<span class="token keyword">left</span> <span class="token keyword">join</span> T b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> b<span class="token punctuation">.</span>customer_id <span class="token operator">and</span> a<span class="token punctuation">.</span>rnk <span class="token operator">=</span> b<span class="token punctuation">.</span>rnk<span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword">where</span> A<span class="token punctuation">.</span>customer_id <span class="token operator">in</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span> a<span class="token punctuation">.</span>customer_id  <span class="token keyword">FROM</span> T a
<span class="token keyword">group</span> <span class="token keyword">by</span> customer_id
<span class="token keyword">having</span>  <span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">year</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">year</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>rnk <span class="token operator">&lt;&gt;</span> <span class="token number">1</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>price_sum<span class="token operator">-</span>b<span class="token punctuation">.</span>Price_SUM  <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
</code></pre> 
<h3><a id="16__5712"></a>16. 合并在同一个大厅重叠的活动</h3> 
<p>编写一个 SQL 查询来合并在 同一个大厅举行 的所有重叠活动。如果两个活动 至少有一天 相同，那么它们就是重叠的。<br> 以任意顺序返回结果表。<br> <img src="https://images2.imgbox.com/97/5f/XXqoHpli_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'HallEvents'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> HallEvents
go
<span class="token keyword">create</span> <span class="token keyword">table</span> HallEvents<span class="token punctuation">(</span>
   hall_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> start_day    <span class="token keyword">date</span>
<span class="token punctuation">,</span> end_day      <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> HallEvents
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-09'</span><span class="token punctuation">,</span><span class="token string">'2023-01-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-01'</span><span class="token punctuation">,</span><span class="token string">'2022-12-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2023-01-12'</span><span class="token punctuation">,</span><span class="token string">'2023-01-14'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-01'</span><span class="token punctuation">,</span><span class="token string">'2022-12-19'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-29'</span><span class="token punctuation">,</span><span class="token string">'2022-12-31'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-22'</span><span class="token punctuation">,</span><span class="token string">'2023-01-18'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-04'</span><span class="token punctuation">,</span><span class="token string">'2022-12-18'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-29'</span><span class="token punctuation">,</span><span class="token string">'2023-01-24'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-20'</span><span class="token punctuation">,</span><span class="token string">'2023-01-09'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-08'</span><span class="token punctuation">,</span><span class="token string">'2022-12-31'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-14'</span><span class="token punctuation">,</span><span class="token string">'2022-12-22'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2023-01-15'</span><span class="token punctuation">,</span><span class="token string">'2023-01-27'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-07'</span><span class="token punctuation">,</span><span class="token string">'2023-01-03'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-30'</span><span class="token punctuation">,</span><span class="token string">'2023-01-27'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-01'</span><span class="token punctuation">,</span><span class="token string">'2023-01-22'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-29'</span><span class="token punctuation">,</span><span class="token string">'2022-12-30'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2023-01-04'</span><span class="token punctuation">,</span><span class="token string">'2023-01-05'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>    <span class="token punctuation">,</span><span class="token string">'2022-12-12'</span><span class="token punctuation">,</span><span class="token string">'2022-12-17'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>      <span class="token punctuation">,</span><span class="token string">'2023-01-26'</span><span class="token punctuation">,</span><span class="token string">'2023-01-30'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>      <span class="token punctuation">,</span><span class="token string">'2023-01-17'</span><span class="token punctuation">,</span><span class="token string">'2023-01-28'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>      <span class="token punctuation">,</span><span class="token string">'2022-12-14'</span><span class="token punctuation">,</span><span class="token string">'2023-01-16'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>      <span class="token punctuation">,</span><span class="token string">'2022-12-15'</span><span class="token punctuation">,</span><span class="token string">'2023-01-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>      <span class="token punctuation">,</span><span class="token string">'2022-12-10'</span><span class="token punctuation">,</span><span class="token string">'2023-01-12'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span>      <span class="token punctuation">,</span><span class="token string">'2022-12-27'</span><span class="token punctuation">,</span><span class="token string">'2023-01-06'</span><span class="token punctuation">)</span>
go
<span class="token keyword">SELECT</span> hall_id<span class="token punctuation">,</span>
       <span class="token function">MIN</span><span class="token punctuation">(</span>start_day<span class="token punctuation">)</span> <span class="token keyword">AS</span> start_day<span class="token punctuation">,</span>
       <span class="token function">MAX</span><span class="token punctuation">(</span>end_day<span class="token punctuation">)</span> <span class="token keyword">AS</span> end_day
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
           <span class="token function">SUM</span><span class="token punctuation">(</span>range_start<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> hall_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> start_day<span class="token punctuation">)</span> <span class="token keyword">AS</span> range_grp
    <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
               <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> start_day <span class="token operator">&lt;=</span> LAG<span class="token punctuation">(</span>max_end_day_so_far<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> hall_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> start_day<span class="token punctuation">)</span> <span class="token keyword">THEN</span> <span class="token number">0</span>
                    <span class="token keyword">ELSE</span> <span class="token number">1</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> range_start
        <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
            <span class="token keyword">SELECT</span> hall_id<span class="token punctuation">,</span>
                   start_day<span class="token punctuation">,</span>
                   end_day<span class="token punctuation">,</span>
                   <span class="token function">MAX</span><span class="token punctuation">(</span>end_day<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> hall_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> start_day<span class="token punctuation">)</span> <span class="token keyword">AS</span> max_end_day_so_far
            <span class="token keyword">FROM</span> HallEvents
        <span class="token punctuation">)</span> t
    <span class="token punctuation">)</span> t1
<span class="token punctuation">)</span> t2
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> hall_id<span class="token punctuation">,</span> range_grp<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="17__5774"></a>17. 表的动态旋转</h3> 
<p>实现 PivotProducts 过程来重新组织 Products 表，以便每行都有一个商品的 id 及其在每个商店中的价格。如果商品不在商店出售，价格应为 null。表的列应该包含每个商店，并且它们应该按 字典顺序排序。<br> 过程应该在重新组织表之后返回它。<br> 以 任意顺序 返回结果表。</p> 
<h3><a id="18__5782"></a>18. 兴趣相同的朋友</h3> 
<p>请写一段SQL查询获取到兴趣相同的朋友。用户 x 和 用户 y 是兴趣相同的朋友，需满足下述条件：<br> 用户 x 和 y 是朋友，并且<br> 用户 x and y 在同一天内听过相同的歌曲，且数量大于等于三首.<br> 结果表 无需排序 。注意：返回的结果需要和源数据表的呈现方式相同 （例如， 需满足 user1_id &lt; user2_id）。<br> <img src="https://images2.imgbox.com/9b/09/YeTRxDhU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/02/72/x5ZFQ1MK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bf/75/CRISYPGY_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Listens'</span><span class="token punctuation">,</span><span class="token string">'U'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Listens <span class="token punctuation">(</span>
user_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span> song_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> <span class="token keyword">day</span>        <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Listens
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token number">10</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token number">11</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token number">12</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token number">10</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token number">11</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token number">12</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>      <span class="token punctuation">,</span><span class="token number">10</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>      <span class="token punctuation">,</span><span class="token number">11</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>      <span class="token punctuation">,</span><span class="token number">12</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>      <span class="token punctuation">,</span><span class="token number">10</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>      <span class="token punctuation">,</span><span class="token number">11</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>      <span class="token punctuation">,</span><span class="token number">13</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-15'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>      <span class="token punctuation">,</span><span class="token number">10</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-16'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>      <span class="token punctuation">,</span><span class="token number">11</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-16'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>      <span class="token punctuation">,</span><span class="token number">12</span>    <span class="token punctuation">,</span><span class="token string">'2021-03-16'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Friendship'</span><span class="token punctuation">,</span><span class="token string">'U'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Friendship
GO
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> Friendship<span class="token punctuation">(</span>
    user1_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> user2_id      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Friendship
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>       <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>       <span class="token punctuation">,</span> <span class="token number">4</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>       <span class="token punctuation">,</span> <span class="token number">5</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> user1_id<span class="token punctuation">,</span>user2_id
<span class="token keyword">from</span> Friendship f
<span class="token keyword">left</span> <span class="token keyword">join</span> Listens l1
<span class="token keyword">on</span> user1_id<span class="token operator">=</span>l1<span class="token punctuation">.</span>user_id
<span class="token keyword">left</span> <span class="token keyword">join</span> Listens l2
<span class="token keyword">on</span> user2_id<span class="token operator">=</span>l2<span class="token punctuation">.</span>user_id
<span class="token keyword">where</span> l1<span class="token punctuation">.</span>song_id<span class="token operator">=</span>l2<span class="token punctuation">.</span>song_id
<span class="token operator">and</span> l1<span class="token punctuation">.</span><span class="token keyword">day</span><span class="token operator">=</span>l2<span class="token punctuation">.</span><span class="token keyword">day</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> user1_id<span class="token punctuation">,</span>user2_id<span class="token punctuation">,</span>l1<span class="token punctuation">.</span><span class="token keyword">day</span>
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> l2<span class="token punctuation">.</span>song_id<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">3</span>

</code></pre> 
<h3><a id="19_Leetcodify__5848"></a>19. Leetcodify 好友推荐</h3> 
<p>写出 SQL 语句，为 Leetcodify 用户推荐好友。我们将符合下列条件的用户 x 推荐给用户 y ：<br> 用户 x 和 y 不是好友，且<br> 用户 x 和 y 在同一天收听了相同的三首或更多不同歌曲。<br> 注意，好友推荐是单向的，这意味着如果用户 x 和用户 y 需要互相推荐给对方，结果表需要将用户 x 推荐给用户 y 并将用户 y 推荐给用户 x。另外，结果表不得出现重复项（即，用户 y 不可多次推荐给用户 x ）。<br> 按任意顺序返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> t<span class="token punctuation">.</span>user1_id <span class="token keyword">AS</span> user_id<span class="token punctuation">,</span>t<span class="token punctuation">.</span>user2_id <span class="token keyword">AS</span> recommended_id
  <span class="token keyword">FROM</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> a<span class="token punctuation">.</span>user_id <span class="token keyword">AS</span> user1_id
       <span class="token punctuation">,</span>b<span class="token punctuation">.</span>user_id <span class="token keyword">AS</span> user2_id
       <span class="token punctuation">,</span>a<span class="token punctuation">.</span>song_id
       <span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token keyword">day</span>
       <span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>song_id<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span><span class="token keyword">day</span><span class="token punctuation">,</span>a<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>b<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt
  <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Listens<span class="token punctuation">)</span> a
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Listens<span class="token punctuation">)</span> b
    <span class="token keyword">ON</span> a<span class="token punctuation">.</span>user_id <span class="token operator">&lt;&gt;</span> b<span class="token punctuation">.</span>user_id
   <span class="token operator">AND</span> a<span class="token punctuation">.</span>song_id <span class="token operator">=</span> b<span class="token punctuation">.</span>song_id
   <span class="token operator">AND</span> a<span class="token punctuation">.</span><span class="token keyword">day</span> <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token keyword">day</span><span class="token punctuation">)</span> t
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> Friendship t1
    <span class="token keyword">ON</span> t<span class="token punctuation">.</span>user1_id <span class="token operator">=</span> t1<span class="token punctuation">.</span>user1_id <span class="token operator">AND</span> t<span class="token punctuation">.</span>user2_id <span class="token operator">=</span> t1<span class="token punctuation">.</span>user2_id
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> Friendship t2
    <span class="token keyword">ON</span> t<span class="token punctuation">.</span>user1_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>user2_id <span class="token operator">AND</span> t<span class="token punctuation">.</span>user2_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>user1_id
 <span class="token keyword">WHERE</span> t<span class="token punctuation">.</span>cnt <span class="token operator">&gt;=</span> <span class="token number">3</span> <span class="token operator">AND</span> t1<span class="token punctuation">.</span>user1_id <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> t2<span class="token punctuation">.</span>user1_id <span class="token operator">IS</span> <span class="token boolean">NULL</span>
</code></pre> 
<h3><a id="20__5877"></a>20. 航班机票状态</h3> 
<p><img src="https://images2.imgbox.com/25/e7/aWJmAOMo_o.png" alt="在这里插入图片描述"></p> 
<p>乘客提前预订航班机票。如果乘客预订了一张航班机票，并且航班上还有空座位，则乘客的机票将 得到确认 。然而，如果航班已经满员，乘客将被列入 等候名单 。<br> 编写解决方案来确定每个乘客航班机票的当前状态。<br> 按 passenger_id 升序排序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'Flights'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Flights
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Flights<span class="token punctuation">(</span>
  flight_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> capacity     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Flights
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>      <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Passengers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Passengers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Passengers<span class="token punctuation">(</span>
 passenger_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span>flight_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>booking_time  <span class="token keyword">datetime</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Passengers
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">101</span>  <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2023-07-10 16:30:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">102</span>  <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2023-07-10 17:45:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">103</span>  <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2023-07-10 12:00:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">104</span>  <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'2023-07-05 13:23:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">105</span>  <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'2023-07-05 09:00:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">106</span>  <span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'2023-07-08 11:10:00'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">107</span>  <span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'2023-07-08 09:10:00'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>passenger_id
     <span class="token punctuation">,</span> <span class="token keyword">case</span> <span class="token keyword">when</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>flight_id <span class="token keyword">order</span> <span class="token keyword">by</span> booking_time<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> b<span class="token punctuation">.</span>capacity <span class="token keyword">then</span> <span class="token string">'Confirmed'</span>
         <span class="token keyword">else</span> <span class="token string">'Waitlist'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> <span class="token keyword">Status</span>
<span class="token keyword">from</span> passengers a
<span class="token keyword">left</span> <span class="token keyword">join</span> Flights b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>flight_id <span class="token operator">=</span> b<span class="token punctuation">.</span>flight_id
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>passenger_id
</code></pre> 
<h3><a id="21__5928"></a>21. 受欢迎度百分比</h3> 
<p><img src="https://images2.imgbox.com/96/8a/YdbjKVnX_o.png" alt="在这里插入图片描述"><br> 编写一条 SQL 查询，找出 Meta/Facebook 平台上每个用户的受欢迎度的百分比。受欢迎度百分比定义为用户拥有的朋友总数除以平台上的总用户数，然后乘以 100，并 四舍五入保留 2 位小数 。<br> 返回按照 user1 升序 排序的结果表。</p> 
<pre><code class="prism language-sql">
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Friends'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Friends
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Friends<span class="token punctuation">(</span>
 user1     <span class="token keyword">int</span>
<span class="token punctuation">,</span>user2      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Friends
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">5</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span> <span class="token number">6</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span> <span class="token number">6</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>   <span class="token punctuation">,</span> <span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>   <span class="token punctuation">,</span> <span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span> <span class="token number">9</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> user1 <span class="token punctuation">,</span>user2 <span class="token keyword">from</span> friends
<span class="token keyword">union</span> <span class="token keyword">select</span> user2 <span class="token punctuation">,</span>user1 <span class="token keyword">from</span> friends<span class="token punctuation">)</span>
<span class="token keyword">select</span> user1 <span class="token punctuation">,</span>cast<span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> user2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> user1<span class="token punctuation">)</span> <span class="token keyword">FROM</span> T<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> percentage_popularity
<span class="token keyword">from</span> T a
<span class="token keyword">group</span> <span class="token keyword">by</span> user1
</code></pre> 
<h3><a id="22__5963"></a>22. 用户购买平台</h3> 
<p><img src="https://images2.imgbox.com/26/38/m3iEOICy_o.png" alt="在这里插入图片描述"><br> 编写解决方案找出每天 仅 使用手机端用户、仅 使用桌面端用户和 同时 使用桌面端和手机端的用户人数和总支出金额。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Spending'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Spending
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Spending<span class="token punctuation">(</span>
 user_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span>spend_date   <span class="token keyword">date</span>
<span class="token punctuation">,</span>platform     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>amount       <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Spending
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2019-07-01'</span><span class="token punctuation">,</span> <span class="token string">'mobile'</span>   <span class="token punctuation">,</span><span class="token number">100</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'2019-07-01'</span><span class="token punctuation">,</span> <span class="token string">'desktop'</span>  <span class="token punctuation">,</span><span class="token number">100</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2019-07-01'</span><span class="token punctuation">,</span> <span class="token string">'mobile'</span>   <span class="token punctuation">,</span><span class="token number">100</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'2019-07-02'</span><span class="token punctuation">,</span> <span class="token string">'mobile'</span>   <span class="token punctuation">,</span><span class="token number">100</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2019-07-01'</span><span class="token punctuation">,</span> <span class="token string">'desktop'</span>  <span class="token punctuation">,</span><span class="token number">100</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'2019-07-02'</span><span class="token punctuation">,</span> <span class="token string">'desktop'</span>  <span class="token punctuation">,</span><span class="token number">100</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

 <span class="token keyword">WITH</span> T <span class="token keyword">AS</span><span class="token punctuation">(</span>
<span class="token keyword">select</span> spend_date<span class="token punctuation">,</span> platform<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span> <span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token keyword">as</span> total_users<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">as</span> total_amount
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> user_id<span class="token punctuation">,</span> spend_date<span class="token punctuation">,</span>amount<span class="token punctuation">,</span>
    <span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token function">count</span><span class="token punctuation">(</span>platform<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> user_id<span class="token punctuation">,</span> spend_date<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'both'</span>
    <span class="token keyword">else</span> platform <span class="token keyword">end</span> <span class="token keyword">as</span> platform
    <span class="token keyword">from</span> spending <span class="token punctuation">)</span> A
<span class="token keyword">GROUP</span>  <span class="token keyword">by</span> spend_date<span class="token punctuation">,</span>platform
<span class="token punctuation">)</span>

 <span class="token keyword">SELECT</span> B<span class="token punctuation">.</span>spend_date<span class="token punctuation">,</span> A<span class="token punctuation">.</span>platform<span class="token punctuation">,</span> ISNULL<span class="token punctuation">(</span>T<span class="token punctuation">.</span>total_amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> total_amount<span class="token punctuation">,</span>ISNULL<span class="token punctuation">(</span>T<span class="token punctuation">.</span>total_users<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> total_users
 <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token string">'mobile'</span> <span class="token keyword">as</span> platform
         <span class="token keyword">union</span>
         <span class="token keyword">select</span> <span class="token string">'desktop'</span> <span class="token keyword">as</span> platform
         <span class="token keyword">union</span>
         <span class="token keyword">select</span> <span class="token string">'both'</span> <span class="token keyword">as</span> platform
         <span class="token punctuation">)</span> A
 <span class="token keyword">CROSS</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">select</span>  <span class="token keyword">distinct</span> spend_date <span class="token keyword">from</span> spending <span class="token punctuation">)</span> B
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> T T
<span class="token keyword">ON</span> B<span class="token punctuation">.</span>spend_date<span class="token operator">=</span>T<span class="token punctuation">.</span>spend_date <span class="token operator">AND</span> A<span class="token punctuation">.</span>platform<span class="token operator">=</span>T<span class="token punctuation">.</span>platform
<span class="token keyword">order</span> <span class="token keyword">by</span> B<span class="token punctuation">.</span>spend_date<span class="token punctuation">,</span><span class="token function">LEN</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span>platform<span class="token punctuation">)</span> <span class="token keyword">DESC</span>
</code></pre> 
<h3><a id="23__6015"></a>23. 锦标赛优胜者</h3> 
<p><img src="https://images2.imgbox.com/91/41/29OiTZzU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2a/d4/uuF5Oqmx_o.png" alt="在这里插入图片描述"><br> 每组的获胜者是在组内累积得分最高的选手。如果平局，player_id 最小 的选手获胜。<br> 编写解决方案来查找每组中的获胜者。<br> 返回的结果表单 没有顺序要求 。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Players'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Players
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Players <span class="token punctuation">(</span>
 player_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>group_id     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Players
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">15</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">25</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">30</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">45</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">10</span>    <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">35</span>    <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">50</span>    <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">20</span>    <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">40</span>    <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Matches'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Matches
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Matches <span class="token punctuation">(</span>
  match_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> first_player  <span class="token keyword">int</span>
<span class="token punctuation">,</span> second_player <span class="token keyword">int</span>
<span class="token punctuation">,</span> first_score   <span class="token keyword">int</span>
<span class="token punctuation">,</span> second_score  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Matches
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">15</span>    <span class="token punctuation">,</span><span class="token number">45</span>   <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">0</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">30</span>    <span class="token punctuation">,</span><span class="token number">25</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">30</span>    <span class="token punctuation">,</span><span class="token number">15</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">0</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">40</span>    <span class="token punctuation">,</span><span class="token number">20</span>   <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token number">35</span>    <span class="token punctuation">,</span><span class="token number">50</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> group_id<span class="token punctuation">,</span>player_id <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span><span class="token operator">*</span> <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> group_id <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span> <span class="token punctuation">,</span>player_id <span class="token keyword">asc</span><span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> b<span class="token punctuation">.</span>group_id<span class="token punctuation">,</span> a<span class="token punctuation">.</span>player_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">as</span> score  <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> match_id<span class="token punctuation">,</span>first_player <span class="token keyword">as</span> player_id<span class="token punctuation">,</span>first_score <span class="token keyword">as</span> Score <span class="token keyword">from</span> Matches
<span class="token keyword">union</span>
<span class="token keyword">select</span> match_id<span class="token punctuation">,</span>second_player<span class="token punctuation">,</span>second_score <span class="token keyword">from</span> Matches <span class="token punctuation">)</span> a
<span class="token keyword">left</span> <span class="token keyword">join</span> Players  b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>player_id <span class="token operator">=</span> b<span class="token punctuation">.</span>player_id
<span class="token keyword">group</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>group_id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>player_id<span class="token punctuation">)</span>a  <span class="token punctuation">)</span>a
<span class="token keyword">where</span> rnk <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="24__6077"></a>24. 周内每天的销售情况</h3> 
<p><img src="https://images2.imgbox.com/1a/13/KBFs0g2p_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/18/a4/IB4EF6fm_o.png" alt="在这里插入图片描述"><br> 你是企业主，想要获得分类商品和周内每天的销售报告。<br> 编写解决方案，报告 周内每天 每个商品类别下订购了多少单位。<br> 返回结果表单 按商品类别排序 。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Orders'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Orders
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Orders <span class="token punctuation">(</span>
 order_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>customer_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span>order_date   <span class="token keyword">date</span>
<span class="token punctuation">,</span>item_id      <span class="token keyword">varchar</span>
<span class="token punctuation">,</span>quantity     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Orders
<span class="token keyword">values</span>
  <span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2020-06-01'</span><span class="token punctuation">,</span>  <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">10</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2020-06-08'</span><span class="token punctuation">,</span>  <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">10</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2020-06-02'</span><span class="token punctuation">,</span>  <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">5</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'2020-06-03'</span><span class="token punctuation">,</span>  <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">5</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span>    <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'2020-06-04'</span><span class="token punctuation">,</span>  <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">6</span>    <span class="token punctuation">,</span><span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'2020-06-05'</span><span class="token punctuation">,</span>  <span class="token number">5</span>  <span class="token punctuation">,</span><span class="token number">5</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">7</span>    <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'2020-06-05'</span><span class="token punctuation">,</span>  <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">10</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">8</span>    <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'2020-06-14'</span><span class="token punctuation">,</span>  <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token number">5</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">9</span>    <span class="token punctuation">,</span><span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'2020-06-21'</span><span class="token punctuation">,</span>  <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">5</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Items'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Items
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Items <span class="token punctuation">(</span>
 item_id          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>item_name        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span>item_category    <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Items
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'LC Alg. Book'</span>   <span class="token punctuation">,</span><span class="token string">'Book'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'LC DB. Book'</span>    <span class="token punctuation">,</span><span class="token string">'Book'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token string">'LC SmarthPhone'</span> <span class="token punctuation">,</span><span class="token string">'Phone'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token string">'LC Phone 2020'</span>  <span class="token punctuation">,</span><span class="token string">'Phone'</span>     <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token string">'LC SmartGlass'</span>  <span class="token punctuation">,</span><span class="token string">'Glasses'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>   <span class="token punctuation">,</span><span class="token string">'LC T-Shirt XL'</span>  <span class="token punctuation">,</span><span class="token string">'T-Shirt'</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> category<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>Monday<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Monday<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>Tuesday<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Tuesday<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>Wednesday<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Wednesday
     <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>Thursday<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Thursday
     <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>Friday<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Friday
    <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>Saturday<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Saturday
    <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>Sunday<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Sunday
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>item_category <span class="token keyword">as</span> Category<span class="token punctuation">,</span>datename<span class="token punctuation">(</span>weekday<span class="token punctuation">,</span>order_date<span class="token punctuation">)</span> <span class="token keyword">as</span> Weekday<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span><span class="token keyword">as</span> quantity
<span class="token keyword">from</span> Items a
<span class="token keyword">left</span> <span class="token keyword">join</span> Orders b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>item_id <span class="token operator">=</span> b<span class="token punctuation">.</span>item_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>item_category<span class="token punctuation">,</span>datename<span class="token punctuation">(</span>weekday<span class="token punctuation">,</span>order_date<span class="token punctuation">)</span> <span class="token punctuation">)</span>a
<span class="token keyword">pivot</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> <span class="token keyword">for</span> Weekday <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>Monday<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>Tuesday<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>Wednesday<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>Thursday<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>Friday<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>Saturday<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>Sunday<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>p
<span class="token keyword">order</span> <span class="token keyword">by</span> Category
</code></pre> 
<h3><a id="25__6141"></a>25. 平均工资：部门与公司比较</h3> 
<p>相关企业：亚马逊/奥多比 Adobe<br> <img src="https://images2.imgbox.com/cd/14/zmn8KhcV_o.png" alt="在这里插入图片描述"><br> 找出各个部门员工的平均薪资与公司平均薪资之间的比较结果（更高 / 更低 / 相同）。<br> 以 任意顺序 返回结果表。<br> 结果格式如下所示。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Salary'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Salary
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Salary<span class="token punctuation">(</span>
id           <span class="token keyword">int</span>
<span class="token punctuation">,</span>employee_id  <span class="token keyword">int</span>
 <span class="token punctuation">,</span>amount       <span class="token keyword">int</span>
 <span class="token punctuation">,</span>pay_date     <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Salary
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">9000</span>  <span class="token punctuation">,</span><span class="token string">'2017/03/31'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">6000</span>  <span class="token punctuation">,</span><span class="token string">'2017/03/31'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">10000</span> <span class="token punctuation">,</span><span class="token string">'2017/03/31'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>  <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">,</span><span class="token number">7000</span>  <span class="token punctuation">,</span><span class="token string">'2017/02/28'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>  <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">6000</span>  <span class="token punctuation">,</span><span class="token string">'2017/02/28'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>  <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">,</span><span class="token number">8000</span>  <span class="token punctuation">,</span><span class="token string">'2017/02/28'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Employee'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Employee
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Employee <span class="token punctuation">(</span>
  employee_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> department_id  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Employee
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token number">2</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>

<span class="token keyword">select</span> pay_month<span class="token punctuation">,</span>department_id
     <span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> AVG_DPT_Salary <span class="token operator">=</span> AVG_CPY_Salary <span class="token keyword">then</span> <span class="token string">'same'</span>
            <span class="token keyword">when</span> AVG_DPT_Salary <span class="token operator">&gt;</span> AVG_CPY_Salary <span class="token keyword">then</span> <span class="token string">'higher'</span>
<span class="token keyword">else</span> <span class="token string">'lower'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> comparison
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span>  <span class="token keyword">distinct</span> <span class="token function">format</span><span class="token punctuation">(</span>pay_date<span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pay_month<span class="token punctuation">,</span>B<span class="token punctuation">.</span>department_id
<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>amount      <span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token function">format</span><span class="token punctuation">(</span>pay_date<span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>B<span class="token punctuation">.</span>department_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> AVG_DPT_Salary
<span class="token punctuation">,</span><span class="token function">avg</span><span class="token punctuation">(</span>amount      <span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token function">format</span><span class="token punctuation">(</span>pay_date<span class="token punctuation">,</span><span class="token string">'yyyy-MM'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token keyword">AS</span> AVG_CPY_Salary

<span class="token keyword">from</span> salary a
<span class="token keyword">left</span> <span class="token keyword">join</span> employee b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>employee_id <span class="token operator">=</span> b<span class="token punctuation">.</span>employee_id  <span class="token punctuation">)</span> a

</code></pre> 
<h3><a id="26___6198"></a>26. 游戏玩法分析 ⑤</h3> 
<p>相关企业：字节跳动/shopee/亚马逊/快手<br> <img src="https://images2.imgbox.com/10/46/F7NvU0OS_o.png" alt="在这里插入图片描述"><br> 玩家的 安装日期 定义为该玩家的第一个登录日。<br> 我们将日期 x 的 第一天留存率 定义为：假定安装日期为 X 的玩家的数量为 N ，其中在 X 之后的一天重新登录的玩家数量为 M，M/N 就是第一天留存率，四舍五入到小数点后两位。<br> 编写解决方案，报告所有安装日期、当天安装游戏的玩家数量和玩家的 第一天留存率。<br> 以 任意顺序 返回结果表。</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Activity'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Activity
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Activity<span class="token punctuation">(</span>
 player_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>device_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>event_date    <span class="token keyword">date</span>
<span class="token punctuation">,</span>games_played  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Activity
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'2016-03-01'</span><span class="token punctuation">,</span> <span class="token number">5</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'2016-03-02'</span><span class="token punctuation">,</span> <span class="token number">6</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'2017-06-25'</span><span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2016-03-01'</span><span class="token punctuation">,</span> <span class="token number">0</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">4</span>  <span class="token punctuation">,</span><span class="token string">'2016-07-03'</span><span class="token punctuation">,</span> <span class="token number">5</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> player_id<span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>event_date<span class="token punctuation">)</span> <span class="token keyword">as</span> install_dt
<span class="token keyword">from</span> Activity
<span class="token keyword">group</span> <span class="token keyword">by</span> player_id <span class="token punctuation">)</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>install_dt <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>player_id<span class="token punctuation">)</span> <span class="token keyword">as</span> installs
     <span class="token punctuation">,</span>cast<span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> b<span class="token punctuation">.</span>event_date <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>player_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Day1_retention
<span class="token keyword">from</span> t a
<span class="token keyword">left</span> <span class="token keyword">join</span> activity b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>player_id <span class="token operator">=</span> b<span class="token punctuation">.</span>player_id <span class="token operator">and</span> dateadd<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>a<span class="token punctuation">.</span>install_dt <span class="token punctuation">)</span><span class="token operator">=</span> b<span class="token punctuation">.</span>event_date
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>install_dt
</code></pre> 
<h3><a id="27__6239"></a>27. 报告系统状态的连续日期</h3> 
<p><img src="https://images2.imgbox.com/4d/f3/JluospZk_o.png" alt="在这里插入图片描述"><br> 系统 每天 运行一个任务。每个任务都独立于先前的任务。任务的状态可以是失败或是成功。<br> 编写解决方案找出 2019-01-01 到 2019-12-31 期间任务连续同状态 period_state 的起止日期（start_date 和 end_date）。即如果任务失败了，就是失败状态的起止日期，如果任务成功了，就是成功状态的起止日期。<br> 最后结果按照起始日期 start_date 排序</p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Failed'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Failed
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Failed<span class="token punctuation">(</span>
    fail_date <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Failed
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'2018-12-28'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2018-12-29'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2019-01-04'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2019-01-05'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Succeeded'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Succeeded
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Succeeded<span class="token punctuation">(</span>
   success_date  <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Succeeded
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'2018-12-30'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2018-12-31'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2019-01-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2019-01-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2019-01-03'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'2019-01-06'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> period_state <span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>eventdate<span class="token punctuation">)</span> <span class="token keyword">as</span> start_date
     <span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>eventdate<span class="token punctuation">)</span> <span class="token keyword">as</span> end_date <span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span>
     <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> eventdate<span class="token punctuation">)</span>
    <span class="token operator">-</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> period_state  <span class="token keyword">order</span> <span class="token keyword">by</span> eventdate<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk2
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> success_date <span class="token keyword">as</span> eventdate<span class="token punctuation">,</span><span class="token string">'succeeded'</span> <span class="token keyword">as</span> period_state  <span class="token keyword">from</span> Succeeded
<span class="token keyword">union</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token string">'failed'</span>  <span class="token keyword">from</span> Failed <span class="token punctuation">)</span> a
<span class="token keyword">where</span> <span class="token keyword">left</span><span class="token punctuation">(</span><span class="token punctuation">[</span>eventdate<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2019</span><span class="token punctuation">)</span> a
<span class="token keyword">group</span> <span class="token keyword">by</span> rnk2<span class="token punctuation">,</span>period_state
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">min</span><span class="token punctuation">(</span>eventdate<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="28__6291"></a>28. 每次访问的交易次数</h3> 
<p><img src="https://images2.imgbox.com/53/8d/RD7KVaNa_o.png" alt="在这里插入图片描述"><br> 银行想要得到银行客户在一次访问时的交易次数和相应的在一次访问时该交易次数的客户数量的图表<br> 编写解决方案找出多少客户访问了银行但没有进行任何交易，多少客户访问了银行进行了一次交易等等<br> 结果包含两列：<br> transactions_count： 客户在一次访问中的交易次数<br> visits_count： 在 transactions_count 交易次数下相应的一次访问时的客户数量<br> transactions_count 的值从 0 到所有用户一次访问中的 max(transactions_count)<br> 结果按 transactions_count 排序<br> <img src="https://images2.imgbox.com/95/66/uh05QwkP_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Visits'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Visits
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Visits<span class="token punctuation">(</span>
  user_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span> visit_date     <span class="token keyword">date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>  Visits
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'2020-01-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token string">'2020-01-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">12</span>     <span class="token punctuation">,</span><span class="token string">'2020-01-01'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">19</span>     <span class="token punctuation">,</span><span class="token string">'2020-01-03'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'2020-01-02'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>      <span class="token punctuation">,</span><span class="token string">'2020-01-03'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>      <span class="token punctuation">,</span><span class="token string">'2020-01-04'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>      <span class="token punctuation">,</span><span class="token string">'2020-01-11'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>      <span class="token punctuation">,</span><span class="token string">'2020-01-25'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>      <span class="token punctuation">,</span><span class="token string">'2020-01-28'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Transactions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span> <span class="token punctuation">(</span>
 user_id           <span class="token keyword">int</span>
<span class="token punctuation">,</span> transaction_date  <span class="token keyword">date</span>
<span class="token punctuation">,</span> amount            <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">Transactions</span>
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2020-01-02'</span><span class="token punctuation">,</span><span class="token number">120</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token string">'2020-01-03'</span><span class="token punctuation">,</span><span class="token number">22</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>   <span class="token punctuation">,</span><span class="token string">'2020-01-11'</span><span class="token punctuation">,</span><span class="token number">232</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token string">'2020-01-04'</span><span class="token punctuation">,</span><span class="token number">7</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>   <span class="token punctuation">,</span><span class="token string">'2020-01-25'</span><span class="token punctuation">,</span><span class="token number">33</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>   <span class="token punctuation">,</span><span class="token string">'2020-01-25'</span><span class="token punctuation">,</span><span class="token number">66</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>   <span class="token punctuation">,</span><span class="token string">'2020-01-28'</span><span class="token punctuation">,</span><span class="token number">1</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>   <span class="token punctuation">,</span><span class="token string">'2020-01-25'</span><span class="token punctuation">,</span><span class="token number">99</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> T <span class="token keyword">AS</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> transactions_count <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> visits_count
<span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>B<span class="token punctuation">.</span>transactions_count<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> transactions_count
    <span class="token keyword">from</span> visits  a
    <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> user_id <span class="token punctuation">,</span>transaction_date<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> transactions_count
                <span class="token keyword">from</span> <span class="token keyword">transactions</span>
                <span class="token keyword">group</span> <span class="token keyword">by</span> user_id <span class="token punctuation">,</span>transaction_date<span class="token punctuation">)</span> b
    <span class="token keyword">on</span> a<span class="token punctuation">.</span>user_id <span class="token operator">=</span> b<span class="token punctuation">.</span>user_id <span class="token operator">and</span> a<span class="token punctuation">.</span>visit_date <span class="token operator">=</span> b<span class="token punctuation">.</span>transaction_date<span class="token punctuation">)</span> a
    <span class="token keyword">group</span> <span class="token keyword">by</span> transactions_count  <span class="token punctuation">)</span>
<span class="token keyword">select</span> number <span class="token keyword">as</span> transactions_count<span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>b<span class="token punctuation">.</span>visits_count <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> visits_count
<span class="token keyword">from</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>spt_values a
<span class="token keyword">left</span> <span class="token keyword">join</span> T b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>number <span class="token operator">=</span> b<span class="token punctuation">.</span>transactions_count
<span class="token keyword">where</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'p'</span> <span class="token operator">and</span> number <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>transactions_count<span class="token punctuation">)</span>
    <span class="token keyword">from</span> t <span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>number

</code></pre> 
<h3><a id="29__6366"></a>29. 获取最近第二次的活动</h3> 
<p><img src="https://images2.imgbox.com/72/3a/YbMC9Vzw_o.png" alt="在这里插入图片描述"><br> 编写解决方案展示每一位用户 最近第二次 的活动<br> 如果用户仅有一次活动，返回该活动<br> 一个用户不能同时进行超过一项活动，以 任意 顺序返回结果<br> 下面是返回结果格式的例子。<br> <img src="https://images2.imgbox.com/58/32/fS0iUD50_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'UserActivity'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> UserActivity
go
<span class="token keyword">create</span> <span class="token keyword">table</span> UserActivity<span class="token punctuation">(</span>
  username      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> activity       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> startDate     <span class="token keyword">Date</span>
<span class="token punctuation">,</span> endDate       <span class="token keyword">Date</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> UserActivity
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'Alice'</span>   <span class="token punctuation">,</span> <span class="token string">'Travel'</span>     <span class="token punctuation">,</span><span class="token string">'2020-02-12'</span><span class="token punctuation">,</span><span class="token string">'2020-02-20'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Alice'</span>   <span class="token punctuation">,</span> <span class="token string">'Dancing'</span>    <span class="token punctuation">,</span><span class="token string">'2020-02-21'</span><span class="token punctuation">,</span><span class="token string">'2020-02-23'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Alice'</span>   <span class="token punctuation">,</span> <span class="token string">'Travel'</span>     <span class="token punctuation">,</span><span class="token string">'2020-02-24'</span><span class="token punctuation">,</span><span class="token string">'2020-02-28'</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'Bob'</span>     <span class="token punctuation">,</span> <span class="token string">'Travel'</span>     <span class="token punctuation">,</span><span class="token string">'2020-02-11'</span><span class="token punctuation">,</span><span class="token string">'2020-02-18'</span><span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> username<span class="token punctuation">,</span>activity <span class="token punctuation">,</span> startDate<span class="token punctuation">,</span>endDate
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
     <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> username <span class="token keyword">order</span> <span class="token keyword">by</span> enddate <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
     <span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> username  <span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
     <span class="token keyword">from</span> UserActivity <span class="token punctuation">)</span> a
<span class="token keyword">where</span> rnk  <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">or</span> cnt <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="30__6403"></a>30. 按年度列出销售总额</h3> 
<p><img src="https://images2.imgbox.com/85/09/B889dx3E_o.png" alt="在这里插入图片描述"><br> 编写解决方案，找出每个产品每年的总销售额，并包含 product_id , product_name , report_year 以及 total_amount 。<br> 返回结果并按 product_id 和 report_year 排序。<br> 返回结果格式如下例所示。<br> <img src="https://images2.imgbox.com/e7/72/UsHARjT2_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Product'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Product
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Product<span class="token punctuation">(</span>
 product_id     <span class="token keyword">int</span>
<span class="token punctuation">,</span>product_name   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Product
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span>    <span class="token punctuation">,</span><span class="token string">'LC Phone'</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token string">'LC T-Shirt'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>    <span class="token punctuation">,</span><span class="token string">'LC Keychain'</span><span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id <span class="token punctuation">(</span><span class="token string">'Sales'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Sales
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Sales<span class="token punctuation">(</span>
  product_id          <span class="token keyword">int</span>
<span class="token punctuation">,</span> period_start        <span class="token keyword">date</span>
<span class="token punctuation">,</span> period_end          <span class="token keyword">date</span>
<span class="token punctuation">,</span> average_daily_sales <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Sales
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span>  <span class="token punctuation">,</span><span class="token string">'2019-01-25'</span><span class="token punctuation">,</span> <span class="token string">'2019-02-28'</span><span class="token punctuation">,</span> <span class="token number">100</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>  <span class="token punctuation">,</span><span class="token string">'2018-12-01'</span><span class="token punctuation">,</span> <span class="token string">'2020-01-01'</span><span class="token punctuation">,</span> <span class="token number">10</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>  <span class="token punctuation">,</span><span class="token string">'2019-12-01'</span><span class="token punctuation">,</span> <span class="token string">'2020-01-31'</span><span class="token punctuation">,</span> <span class="token number">1</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> product_id<span class="token punctuation">,</span>product_name <span class="token punctuation">,</span>report_year<span class="token punctuation">,</span><span class="token punctuation">(</span>datediff<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span>period_start<span class="token punctuation">,</span>period_end<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">*</span> average_daily_sales <span class="token keyword">as</span> total_amount
<span class="token keyword">from</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> a<span class="token punctuation">.</span>Product_id
              <span class="token punctuation">,</span> a<span class="token punctuation">.</span>Product_name
              <span class="token punctuation">,</span> b<span class="token punctuation">.</span>report_year
              <span class="token punctuation">,</span> <span class="token keyword">case</span>
                    <span class="token keyword">when</span> datepart<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>period_start<span class="token punctuation">)</span> <span class="token operator">=</span> b<span class="token punctuation">.</span>report_year <span class="token keyword">then</span> c<span class="token punctuation">.</span>period_start
                    <span class="token keyword">else</span> cast<span class="token punctuation">(</span>b<span class="token punctuation">.</span>report_year <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-01-01'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> Period_start
              <span class="token punctuation">,</span> <span class="token keyword">case</span>
                    <span class="token keyword">when</span> datepart<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>period_end<span class="token punctuation">)</span> <span class="token operator">=</span> b<span class="token punctuation">.</span>report_year <span class="token keyword">then</span> c<span class="token punctuation">.</span>period_end
                    <span class="token keyword">else</span> cast<span class="token punctuation">(</span>b<span class="token punctuation">.</span>report_year <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-12-31'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> period_end
              <span class="token punctuation">,</span>c<span class="token punctuation">.</span>average_daily_sales
         <span class="token keyword">from</span> Product a
                  <span class="token keyword">left</span> <span class="token keyword">join</span> Sales c
                            <span class="token keyword">on</span> a<span class="token punctuation">.</span>product_id <span class="token operator">=</span> c<span class="token punctuation">.</span>product_id
                  <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
             <span class="token keyword">select</span> number <span class="token keyword">as</span> report_year
             <span class="token keyword">from</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>spt_values
             <span class="token keyword">where</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'p'</span>
               <span class="token operator">and</span> number <span class="token operator">between</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>datepart<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span> period_start<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> sales<span class="token punctuation">)</span>
                 <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>datepart<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span> period_end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> sales<span class="token punctuation">)</span><span class="token punctuation">)</span> b
                            <span class="token keyword">on</span> b<span class="token punctuation">.</span>report_year <span class="token operator">between</span> datepart<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>period_start<span class="token punctuation">)</span> <span class="token operator">and</span> datepart<span class="token punctuation">(</span><span class="token keyword">year</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>period_end<span class="token punctuation">)</span>
     <span class="token punctuation">)</span> a
<span class="token keyword">order</span> <span class="token keyword">by</span> product_id<span class="token punctuation">,</span>report_year
</code></pre> 
<h3><a id="31__6469"></a>31. 查找成绩处于中游的学生</h3> 
<p><img src="https://images2.imgbox.com/2a/7c/Q2J6PjeV_o.png" alt="在这里插入图片描述"><br> 成绩处于中游的学生是指至少参加了一次测验, 且得分既不是最高分也不是最低分的学生。<br> 编写解决方案，找出在 所有 测验中都处于中游的学生 (student_id, student_name)。不要返回从来没有参加过测验的学生。<br> 返回结果表按照 student_id 排序。<br> 返回结果格式如下。<br> <img src="https://images2.imgbox.com/f1/28/kpI0Srzq_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Student'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Student
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Student<span class="token punctuation">(</span>
 student_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span>student_name      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Student
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span>     <span class="token punctuation">,</span><span class="token string">'Daniel'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span>     <span class="token punctuation">,</span><span class="token string">'Jade'</span>      <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span>     <span class="token punctuation">,</span><span class="token string">'Stella'</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span>     <span class="token punctuation">,</span><span class="token string">'Jonathan'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span>     <span class="token punctuation">,</span><span class="token string">'Will'</span>      <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Exam'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Exam
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Exam<span class="token punctuation">(</span>
    exam_id      <span class="token keyword">int</span>
<span class="token punctuation">,</span> student_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> score         <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>   Exam
<span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">10</span>   <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">70</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span>   <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token number">80</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">10</span>   <span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">90</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">20</span>   <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">80</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">30</span>   <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">70</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">30</span>   <span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token number">80</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">30</span>   <span class="token punctuation">,</span> <span class="token number">4</span>  <span class="token punctuation">,</span> <span class="token number">90</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">40</span>   <span class="token punctuation">,</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">60</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">40</span>   <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token number">70</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">40</span>   <span class="token punctuation">,</span> <span class="token number">4</span>  <span class="token punctuation">,</span> <span class="token number">80</span>   <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>student_id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>student_name
<span class="token keyword">from</span> student a
<span class="token keyword">where</span> a<span class="token punctuation">.</span>student_id <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token keyword">distinct</span>  student_id
    <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span>
            <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> exam_id  <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">asc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> ascrnk
            <span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> exam_id <span class="token keyword">order</span> <span class="token keyword">by</span> score <span class="token keyword">desc</span> <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk

            <span class="token keyword">from</span> Exam <span class="token punctuation">)</span> b
<span class="token keyword">where</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>rnk <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">or</span> b<span class="token punctuation">.</span>ascrnk <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token operator">and</span> student_id  <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> student_id <span class="token keyword">from</span> exam<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> student_id

</code></pre> 
<h3><a id="32__6532"></a>32. 寻找没有被执行的任务对</h3> 
<p><img src="https://images2.imgbox.com/62/56/s9uuFiCW_o.png" alt="在这里插入图片描述"><br> 编写解决方案报告没有被执行的（主任务，子任务）对，即没有被执行的（task_id, subtask_id）。<br> 以 任何顺序 返回即可。<br> <img src="https://images2.imgbox.com/b8/67/sjtvBN4C_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Tasks'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Tasks
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Tasks<span class="token punctuation">(</span>
 task_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span> subtasks_count  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Tasks
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>    <span class="token punctuation">,</span> <span class="token number">3</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>    <span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>    <span class="token punctuation">,</span> <span class="token number">4</span>  <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Executed'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Executed
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Executed <span class="token punctuation">(</span>
 task_id        <span class="token keyword">int</span>
<span class="token punctuation">,</span>subtask_id     <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>   Executed
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span> <span class="token number">2</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span> <span class="token number">3</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span> <span class="token number">4</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> a<span class="token punctuation">.</span>task_id<span class="token punctuation">,</span>c<span class="token punctuation">.</span>number <span class="token keyword">as</span> subtask_id
<span class="token keyword">from</span> tasks a
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> number <span class="token keyword">from</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>spt_values <span class="token keyword">where</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'p'</span>
    <span class="token operator">and</span> number <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span> c
<span class="token keyword">on</span> c<span class="token punctuation">.</span>number <span class="token operator">between</span> <span class="token number">1</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>subtasks_count
<span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> executed b
    <span class="token keyword">where</span> a<span class="token punctuation">.</span>task_id <span class="token operator">=</span> b<span class="token punctuation">.</span>task_id <span class="token operator">and</span>
          c<span class="token punctuation">.</span>number <span class="token operator">=</span> b<span class="token punctuation">.</span>subtask_id
    <span class="token punctuation">)</span>
</code></pre> 
<h3><a id="33___6581"></a>33. 页面推荐 ②</h3> 
<p><img src="https://images2.imgbox.com/75/35/8a88hiSy_o.png" alt="在这里插入图片描述"><br> 您正在为一个社交媒体网站实施一个页面推荐系统。如果页面被user_id的 至少一个朋友喜欢 ，而 不被user_id喜欢 ，你的系统将 推荐 一个页面到user_id。<br> 编写一个解决方案来查找针对每个用户的所有可能的 页面建议 。每个建议应该在结果表中显示为一行，包含以下列:<br> user_id: 系统向其提出建议的用户的ID。<br> page_id: 推荐为 user_id 的页面ID。.<br> friends_likes: user_id 对应 page_id 的好友数。<br> 以 任意顺序 返回结果表。<br> 返回结果格式示例如下。<br> <img src="https://images2.imgbox.com/46/9b/OomlT5Fr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/71/be/VV28fPYe_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql">在这里插入代码片
</code></pre> 
<h3><a id="34__6599"></a>34. 在连续天数上进行了最多交易次数的顾客</h3> 
<p><img src="https://images2.imgbox.com/2a/43/DqSI4ZHO_o.png" alt="在这里插入图片描述"><br> 编写一个解决方案，找到连续天数上进行了最多交易的所有 customer_id 。<br> 返回所有具有最大连续交易次数的 customer_id 。结果表按 customer_id 的 升序 排序。<br> 结果的格式如下所示。<br> <img src="https://images2.imgbox.com/d3/c7/8pkjCJwX_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Transactions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span><span class="token punctuation">(</span>
  transaction_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> customer_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> transaction_date  <span class="token keyword">date</span>
<span class="token punctuation">,</span> amount            <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">Transactions</span>
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>     <span class="token punctuation">,</span><span class="token number">101</span>  <span class="token punctuation">,</span><span class="token string">'2023-05-01'</span><span class="token punctuation">,</span>    <span class="token number">100</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>     <span class="token punctuation">,</span><span class="token number">101</span>  <span class="token punctuation">,</span><span class="token string">'2023-05-02'</span><span class="token punctuation">,</span>    <span class="token number">150</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>     <span class="token punctuation">,</span><span class="token number">101</span>  <span class="token punctuation">,</span><span class="token string">'2023-05-03'</span><span class="token punctuation">,</span>    <span class="token number">200</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>     <span class="token punctuation">,</span><span class="token number">102</span>  <span class="token punctuation">,</span><span class="token string">'2023-05-01'</span><span class="token punctuation">,</span>    <span class="token number">50</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>     <span class="token punctuation">,</span><span class="token number">102</span>  <span class="token punctuation">,</span><span class="token string">'2023-05-03'</span><span class="token punctuation">,</span>    <span class="token number">100</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>     <span class="token punctuation">,</span><span class="token number">102</span>  <span class="token punctuation">,</span><span class="token string">'2023-05-04'</span><span class="token punctuation">,</span>    <span class="token number">200</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>     <span class="token punctuation">,</span><span class="token number">105</span>  <span class="token punctuation">,</span><span class="token string">'2023-05-01'</span><span class="token punctuation">,</span>    <span class="token number">100</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>     <span class="token punctuation">,</span><span class="token number">105</span>  <span class="token punctuation">,</span><span class="token string">'2023-05-02'</span><span class="token punctuation">,</span>    <span class="token number">150</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>     <span class="token punctuation">,</span><span class="token number">105</span>  <span class="token punctuation">,</span><span class="token string">'2023-05-03'</span><span class="token punctuation">,</span>    <span class="token number">200</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span>  T <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> customer_id <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> CNT
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token punctuation">,</span>datepart<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span>transaction_date<span class="token punctuation">)</span> <span class="token operator">-</span> rnk  <span class="token keyword">as</span> diff
        <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> customer_id <span class="token punctuation">,</span>transaction_date<span class="token punctuation">,</span>dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> customer_id <span class="token keyword">order</span> <span class="token keyword">by</span> transaction_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
                <span class="token keyword">from</span> <span class="token keyword">Transactions</span> <span class="token punctuation">)</span> a <span class="token punctuation">)</span> a
<span class="token keyword">group</span> <span class="token keyword">by</span> customer_id <span class="token punctuation">,</span>diff
<span class="token punctuation">)</span>
<span class="token keyword">select</span> customer_id
<span class="token keyword">from</span> T
<span class="token keyword">where</span> cnt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span> <span class="token keyword">from</span> T <span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> customer_id
</code></pre> 
<h3><a id="35__6644"></a>35. 连续递增交易</h3> 
<p><img src="https://images2.imgbox.com/ff/8b/4khQ0oJD_o.png" alt="在这里插入图片描述"><br> 编写一个 SQL 查询，找出至少连续三天 amount 递增的客户。并包括 customer_id 、连续交易期的起始日期和结束日期。一个客户可以有多个连续的交易。<br> 返回结果并按照 customer_id 升序 排列。<br> 查询结果的格式如下所示。<br> <img src="https://images2.imgbox.com/ae/c6/F4yB6Rrt_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Transactions'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span>
go
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">Transactions</span><span class="token punctuation">(</span>
  transaction_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span> customer_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> transaction_date  <span class="token keyword">date</span>
<span class="token punctuation">,</span> amount            <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">Transactions</span>
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">101</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-01'</span>  <span class="token punctuation">,</span><span class="token number">100</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">101</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-02'</span>  <span class="token punctuation">,</span><span class="token number">150</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">101</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-03'</span>  <span class="token punctuation">,</span><span class="token number">200</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">4</span>   <span class="token punctuation">,</span><span class="token number">102</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-01'</span>  <span class="token punctuation">,</span><span class="token number">50</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">5</span>   <span class="token punctuation">,</span><span class="token number">102</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-03'</span>  <span class="token punctuation">,</span><span class="token number">100</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">6</span>   <span class="token punctuation">,</span><span class="token number">102</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-04'</span>  <span class="token punctuation">,</span><span class="token number">200</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">7</span>   <span class="token punctuation">,</span><span class="token number">105</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-01'</span>  <span class="token punctuation">,</span><span class="token number">100</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">8</span>   <span class="token punctuation">,</span><span class="token number">105</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-02'</span>  <span class="token punctuation">,</span><span class="token number">150</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">9</span>   <span class="token punctuation">,</span><span class="token number">105</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-03'</span>  <span class="token punctuation">,</span><span class="token number">200</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">10</span>  <span class="token punctuation">,</span><span class="token number">105</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-04'</span>  <span class="token punctuation">,</span><span class="token number">300</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">11</span>  <span class="token punctuation">,</span><span class="token number">105</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-12'</span>  <span class="token punctuation">,</span><span class="token number">250</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">12</span>  <span class="token punctuation">,</span><span class="token number">105</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-13'</span>  <span class="token punctuation">,</span><span class="token number">260</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">13</span>  <span class="token punctuation">,</span><span class="token number">105</span>   <span class="token punctuation">,</span><span class="token string">'2023-05-14'</span>  <span class="token punctuation">,</span><span class="token number">270</span> <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">with</span> t <span class="token keyword">as</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> customer_id<span class="token punctuation">,</span>diff <span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token punctuation">,</span>datepart<span class="token punctuation">(</span><span class="token keyword">day</span><span class="token punctuation">,</span>transaction_date <span class="token punctuation">)</span> <span class="token operator">-</span> rnk <span class="token keyword">as</span> diff
      <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span>
             <span class="token punctuation">,</span>dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>customer_id <span class="token keyword">order</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>transaction_date <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
            <span class="token keyword">from</span> <span class="token keyword">Transactions</span> a <span class="token punctuation">)</span>a <span class="token punctuation">)</span> a
<span class="token punctuation">)</span>

<span class="token keyword">select</span> customer_id <span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>transaction_date<span class="token punctuation">)</span> <span class="token keyword">as</span> consecutive_start <span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>transaction_date<span class="token punctuation">)</span> <span class="token keyword">as</span> consecutive_end
<span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span> a<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token punctuation">,</span>b<span class="token punctuation">.</span>amount <span class="token operator">-</span> isnull<span class="token punctuation">(</span>a<span class="token punctuation">.</span>amount<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> diffamount
        <span class="token keyword">from</span> T a
        <span class="token keyword">left</span> <span class="token keyword">join</span> T b
        <span class="token keyword">on</span> a<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> b<span class="token punctuation">.</span>customer_id <span class="token operator">and</span> a<span class="token punctuation">.</span>transaction_id <span class="token operator">=</span> b<span class="token punctuation">.</span>transaction_id <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token operator">and</span> a<span class="token punctuation">.</span>cnt <span class="token operator">=</span> b<span class="token punctuation">.</span>cnt <span class="token punctuation">)</span> a
<span class="token keyword">where</span> cnt <span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">and</span> <span class="token punctuation">(</span>diffamount <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">or</span> diffamount <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> customer_id<span class="token punctuation">,</span>cnt
<span class="token keyword">order</span> <span class="token keyword">by</span> customer_id
<span class="token comment">--方法2</span>
<span class="token keyword">with</span> tmp <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> t1<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">case</span> <span class="token keyword">when</span> t2<span class="token punctuation">.</span>customer_id <span class="token operator">is</span> <span class="token boolean">NULL</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span> group_start
<span class="token keyword">from</span> <span class="token keyword">transactions</span> t1
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token keyword">transactions</span> t2 <span class="token keyword">on</span> t1<span class="token punctuation">.</span>customer_id<span class="token operator">=</span>t2<span class="token punctuation">.</span>customer_id
<span class="token operator">and</span> t1<span class="token punctuation">.</span>amount <span class="token operator">&gt;</span> t2<span class="token punctuation">.</span>amount
<span class="token operator">and</span> DATEDIFF<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span>t2<span class="token punctuation">.</span>transaction_date<span class="token punctuation">,</span>t1<span class="token punctuation">.</span>transaction_date<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span> tmp2 <span class="token keyword">as</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>group_start<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> customer_id<span class="token punctuation">,</span>transaction_date<span class="token punctuation">)</span> grp
<span class="token keyword">from</span> tmp<span class="token punctuation">)</span>
<span class="token keyword">select</span> customer_id<span class="token punctuation">,</span>
<span class="token function">min</span><span class="token punctuation">(</span>transaction_date<span class="token punctuation">)</span> consecutive_start<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span>transaction_date<span class="token punctuation">)</span> consecutive_end
<span class="token keyword">from</span> tmp2
<span class="token keyword">group</span> <span class="token keyword">by</span> grp<span class="token punctuation">,</span>customer_id
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">3</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> customer_id
</code></pre> 
<h3><a id="36__6715"></a>36. 最多连胜的次数</h3> 
<p><img src="https://images2.imgbox.com/c9/a9/TdyU3RYq_o.png" alt="在这里插入图片描述"><br> 选手的 连胜数 是指连续获胜的次数，且没有被平局或输球中断。<br> 编写解决方案来计算每个参赛选手最多的连胜数。<br> 结果可以以 任何顺序 返回。<br> 结果格式如下例所示：<br> <img src="https://images2.imgbox.com/38/3f/4srmFOMc_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Matches'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Matches
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Matches<span class="token punctuation">(</span>
 player_id    <span class="token keyword">int</span>
<span class="token punctuation">,</span>match_day  <span class="token keyword">date</span>
<span class="token punctuation">,</span> result     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Matches
<span class="token keyword">values</span>
 <span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2022-01-17'</span><span class="token punctuation">,</span> <span class="token string">'Win'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2022-01-18'</span><span class="token punctuation">,</span> <span class="token string">'Win'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2022-01-25'</span><span class="token punctuation">,</span> <span class="token string">'Win'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2022-01-31'</span><span class="token punctuation">,</span> <span class="token string">'Draw'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token string">'2022-02-08'</span><span class="token punctuation">,</span> <span class="token string">'Win'</span>  <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'2022-02-06'</span><span class="token punctuation">,</span> <span class="token string">'Lose'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token punctuation">,</span><span class="token string">'2022-02-08'</span><span class="token punctuation">,</span> <span class="token string">'Lose'</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token punctuation">,</span><span class="token string">'2022-03-30'</span><span class="token punctuation">,</span> <span class="token string">'Win'</span>  <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>player_id <span class="token punctuation">,</span>isnull<span class="token punctuation">(</span>b<span class="token punctuation">.</span>longest_streak<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  longest_streak
<span class="token keyword">from</span> Matches a
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> player_id<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span> <span class="token keyword">as</span> longest_streak 
           <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> player_id<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> cnt  
                <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token punctuation">,</span>rnk<span class="token operator">-</span>rnk2 <span class="token keyword">as</span> diff  
                       <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> player_id <span class="token keyword">order</span> <span class="token keyword">by</span> match_day<span class="token punctuation">)</span> <span class="token keyword">as</span> rnk
                                <span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> player_id<span class="token punctuation">,</span>result <span class="token keyword">order</span> <span class="token keyword">by</span> match_day <span class="token punctuation">)</span> <span class="token keyword">as</span> rnk2
                                <span class="token keyword">from</span> Matches a <span class="token punctuation">)</span> a
                        <span class="token keyword">where</span> result <span class="token operator">=</span> <span class="token string">'win'</span> <span class="token punctuation">)</span>a
                <span class="token keyword">group</span> <span class="token keyword">by</span> player_id <span class="token punctuation">,</span>diff<span class="token punctuation">)</span>a
<span class="token keyword">group</span> <span class="token keyword">by</span> player_id <span class="token punctuation">)</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>player_id <span class="token operator">=</span> b<span class="token punctuation">.</span>player_id
</code></pre> 
<h3><a id="37___6759"></a>37. 每辆车的乘客人数 ②</h3> 
<p><img src="https://images2.imgbox.com/02/76/EPUAz4sP_o.png" alt="在这里插入图片描述"><br> 公交车和乘客到达 LeetCode 站。如果一辆公交车在 tbus 时间点到达车站，乘客在 tpassenger 到达车站，其中 tpassenger &lt;= tbus，而该乘客没有赶上任何公交车，则该乘客将搭乘该公交车。此外，每辆公交车都有一个容量。如果在公交车到站的那一刻，等待的乘客超过了它的载客量 capacity，只有 capacity 个乘客才会搭乘该公交车。<br> 编写解决方案，报告使用每条总线的用户数量。<br> 返回按 bus_id 升序排序 的结果表。<br> 结果格式如下所示。<br> <img src="https://images2.imgbox.com/db/84/0rNkPLj6_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql">
<span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Buses'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Buses
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Buses<span class="token punctuation">(</span>
  bus_id       <span class="token keyword">int</span>
<span class="token punctuation">,</span> arrival_time  <span class="token keyword">int</span>
<span class="token punctuation">,</span> capacity      <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span>  Buses
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">1</span>   <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>   <span class="token punctuation">,</span><span class="token number">4</span>    <span class="token punctuation">,</span><span class="token number">10</span>   <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>   <span class="token punctuation">,</span><span class="token number">7</span>    <span class="token punctuation">,</span><span class="token number">2</span>    <span class="token punctuation">)</span>
go
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Passengers'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Passengers
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Passengers<span class="token punctuation">(</span>
  passenger_id  <span class="token keyword">int</span>
<span class="token punctuation">,</span> arrival_time  <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Passengers
<span class="token keyword">values</span>
<span class="token punctuation">(</span> <span class="token number">11</span>  <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">12</span>  <span class="token punctuation">,</span><span class="token number">1</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">13</span>  <span class="token punctuation">,</span><span class="token number">5</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">14</span>  <span class="token punctuation">,</span><span class="token number">6</span>    <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">15</span>  <span class="token punctuation">,</span><span class="token number">7</span>    <span class="token punctuation">)</span>
go
<span class="token comment">--查询</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> Passengers <span class="token keyword">add</span> flag <span class="token keyword">int</span>
go
<span class="token keyword">alter</span> <span class="token keyword">table</span> Passengers <span class="token keyword">add</span> bus_id <span class="token keyword">int</span>
go

<span class="token keyword">update</span> Passengers <span class="token keyword">set</span> flag <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">update</span> Passengers <span class="token keyword">set</span> bus_id <span class="token operator">=</span> <span class="token boolean">null</span>
<span class="token comment">--select * from Passengers</span>
<span class="token keyword">declare</span> <span class="token variable">@bus_id</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token variable">@arrival_time</span> <span class="token keyword">int</span> <span class="token punctuation">,</span><span class="token variable">@capacity</span>  <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token variable">@i</span> <span class="token keyword">int</span>
<span class="token keyword">declare</span> C <span class="token keyword">cursor</span> <span class="token keyword">for</span>
<span class="token keyword">select</span>  bus_id<span class="token punctuation">,</span> arrival_time<span class="token punctuation">,</span>capacity <span class="token keyword">from</span> Buses <span class="token keyword">order</span> <span class="token keyword">by</span> arrival_time
<span class="token keyword">open</span> C
<span class="token keyword">fetch</span> <span class="token keyword">next</span> <span class="token keyword">from</span> C <span class="token keyword">into</span> <span class="token variable">@bus_id</span><span class="token punctuation">,</span><span class="token variable">@arrival_time</span><span class="token punctuation">,</span><span class="token variable">@capacity</span>
<span class="token keyword">while</span> @<span class="token variable">@FETCH_STATUS</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">begin</span>
 <span class="token keyword">select</span> <span class="token variable">@bus_id</span><span class="token punctuation">,</span><span class="token variable">@arrival_time</span><span class="token punctuation">,</span><span class="token variable">@capacity</span>
	<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span>
	<span class="token punctuation">(</span><span class="token keyword">select</span> passenger_id<span class="token punctuation">,</span>arrival_time<span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> arrival_time<span class="token punctuation">)</span>Rnk
	<span class="token keyword">from</span> Passengers
	<span class="token keyword">where</span> arrival_time <span class="token operator">&lt;=</span> <span class="token variable">@arrival_time</span> <span class="token operator">and</span> flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>a
	<span class="token keyword">where</span> Rnk <span class="token operator">&lt;=</span> <span class="token variable">@capacity</span>

	<span class="token keyword">update</span> a
	<span class="token keyword">set</span> bus_id <span class="token operator">=</span> <span class="token variable">@bus_id</span><span class="token punctuation">,</span>flag <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">from</span> Passengers a
	<span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> passenger_id<span class="token punctuation">,</span>arrival_time<span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> arrival_time<span class="token punctuation">)</span>Rnk
	                            <span class="token keyword">from</span> Passengers
	                            <span class="token keyword">where</span> arrival_time <span class="token operator">&lt;=</span> <span class="token variable">@arrival_time</span> <span class="token operator">and</span> flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>a
	            <span class="token keyword">where</span> Rnk<span class="token operator">&lt;=</span><span class="token variable">@capacity</span><span class="token punctuation">)</span>b
	<span class="token keyword">on</span> a<span class="token punctuation">.</span>passenger_id <span class="token operator">=</span> b<span class="token punctuation">.</span>passenger_id

<span class="token keyword">fetch</span> <span class="token keyword">next</span> <span class="token keyword">from</span> C <span class="token keyword">into</span> <span class="token variable">@bus_id</span><span class="token punctuation">,</span><span class="token variable">@arrival_time</span><span class="token punctuation">,</span><span class="token variable">@capacity</span>
<span class="token keyword">end</span>
<span class="token keyword">close</span> C
<span class="token keyword">deallocate</span> C

<span class="token keyword">select</span> a<span class="token punctuation">.</span>bus_id<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>passenger_id<span class="token punctuation">)</span> <span class="token keyword">as</span> passengers_cnt <span class="token keyword">from</span> Buses a
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> Passengers<span class="token punctuation">)</span>b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>bus_id <span class="token operator">=</span> b<span class="token punctuation">.</span>bus_id
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>bus_id
</code></pre> 
<h3><a id="38__6842"></a>38. 建立方程</h3> 
<p><img src="https://images2.imgbox.com/a4/09/J8SMikwf_o.png" alt="在这里插入图片描述"><br> 你有一个非常强大的程序，可以解决世界上任何单变量的方程。传递给程序的方程必须格式化如下:</p> 
<ul><li>左边 (LHS) 应该包含所有的术语。</li><li>右边 (RHS) 应该是零。</li><li>LHS 的每一项应遵循 “X^” 的格式，其中:<br> 是 “+” 或者 “-”。<br> 是 factor 的 绝对值。<br> 是 power 的值。</li><li>如果幂是 1, 不要加上 “^”.<br> 例如, 如果 power = 1 并且 factor = 3, 将有 “+3X”。</li><li>如果幂是 0, 不要加上 “X” 和 “^”.<br> 例如, 如果 power = 0 并且 factor = -3, 将有 “-3”。</li><li>LHS 中的幂应该按 降序排序。<br> 编写一个解决方案来构建方程。</li></ul> 
<p>结果格式如下所示。<br> <img src="https://images2.imgbox.com/63/51/Q7tiv4xD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="39__6862"></a>39. 动态取消表的旋转</h3> 
<p><img src="https://images2.imgbox.com/fe/ee/CPzKGOT2_o.png" alt="在这里插入图片描述"><br> 重要提示: 这个问题针对的是那些对 SQL 有丰富经验的人。如果你是初学者，我们建议你现在跳过它。<br> 实现 UnpivotProducts 过程来重新组织 Products 表，使每一行都有一个产品的 id、销售该商品的商店名称以及该商品在该商店中的价格。如果某个商品在某个商店中不可用，则不要在结果表中包含该 product_id 和 store 组合的行。结果应该有三列:product_id、store 和 price。<br> 过程应该在重新组织表之后返回它。<br> 以 任意顺序 返回结果表。<br> 查询结果格式如下所示。<br> <img src="https://images2.imgbox.com/9f/48/0nWHohNQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--建表</span>
<span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span><span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">drop</span> <span class="token keyword">table</span> Products
go
<span class="token keyword">create</span> <span class="token keyword">table</span> Products<span class="token punctuation">(</span>
product_id   <span class="token keyword">int</span>
<span class="token punctuation">,</span>LC_Store <span class="token keyword">int</span>
<span class="token punctuation">,</span>Nozama <span class="token keyword">int</span>
<span class="token punctuation">,</span>Shop <span class="token keyword">int</span>
<span class="token punctuation">,</span>Souq   <span class="token keyword">int</span>
<span class="token punctuation">)</span>
go
<span class="token keyword">insert</span> <span class="token keyword">into</span> Products
<span class="token keyword">values</span>
 <span class="token punctuation">(</span> <span class="token number">1</span>  <span class="token punctuation">,</span> <span class="token number">100</span>   <span class="token punctuation">,</span><span class="token boolean">null</span> <span class="token punctuation">,</span><span class="token number">110</span>  <span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">2</span>  <span class="token punctuation">,</span> <span class="token boolean">null</span>  <span class="token punctuation">,</span><span class="token number">200</span>  <span class="token punctuation">,</span><span class="token boolean">null</span> <span class="token punctuation">,</span> <span class="token number">190</span> <span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span> <span class="token number">3</span>  <span class="token punctuation">,</span> <span class="token boolean">null</span>  <span class="token punctuation">,</span><span class="token boolean">null</span> <span class="token punctuation">,</span><span class="token number">1000</span> <span class="token punctuation">,</span> <span class="token number">1900</span><span class="token punctuation">)</span>
go

<span class="token comment">--查询</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> UnpivotProducts <span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">declare</span> <span class="token variable">@SQL</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span>MAX<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">@store_name</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token variable">@store_name</span>  <span class="token operator">=</span> STUFF<span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token string">','</span> <span class="token operator">+</span>column_name
                    <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span>
                <span class="token keyword">where</span> table_name <span class="token operator">=</span> <span class="token string">'Products'</span>
                <span class="token operator">and</span> column_name <span class="token operator">&lt;&gt;</span><span class="token string">'Product_id'</span>
                <span class="token keyword">FOR</span> XML PATH<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>

<span class="token keyword">set</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'
select product_id,store ,price
from Products
unpivot ( price for  store in ('</span><span class="token operator">+</span><span class="token variable">@store_name</span><span class="token operator">+</span><span class="token string">'))p'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span>
<span class="token keyword">exec</span> <span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span>
<span class="token keyword">END</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0bb803f8138c382b89aaa5d25a07759f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android 透明度颜色值对照表</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/46c0e972f1b84813cc986b2f69e7b42b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C#】读取ini配置文件的内容</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 编程随想.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151182"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>